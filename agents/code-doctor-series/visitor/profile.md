# Patient Profile: Visitor Pattern

## 基本情報
- **Name**: 速水 慧介（はやみ けいすけ）
- **Age**: 30歳
- **Role**: バックエンドエンジニア（エンジニア歴5年）
- **Employer**: 地元のペットクリニックチェーン「ぱうずハート動物病院」（3店舗）のシステム担当
- **Personality**: 自信家、合理主義、結果重視。「動いてるなら正しい」が信条
- **First Person**: 俺

## 背景

新卒2年目から一人で予約・診察管理システムを構築。犬・猫・鳥の3種に対応する診察レポート生成、予防接種スケジュール計算、食事指導レポート出力の機能を実装し、院長から厚い信頼を得ている。

しかし最近、院長から「爬虫類と小動物も診られるようにしたい。近所の専門病院が閉まったから」という要望が。コードを見返すと各機能に `ref($animal)` による分岐が散在しており、新種追加には全関数の修正が必要だと判明。さらに後輩エンジニアが配属されたが「このコード……読めないです」の一言が追い打ちに。

「動いてるのに何が悪い」と思いつつ、拡張できない現実に苛立ちを感じている。

## 主訴

「ちゃんと3年間動いてきたシステムなんですよ。犬も猫も鳥も完璧に処理できてる。なのに爬虫類を足そうとしたら、なんか……あちこち壊れそうで。後輩にも『読めない』って言われて、正直カチンときたけど、確かに俺自身もどこを直せばいいかわからなくなってきた」

---

# Medical Chart

## 症状 (Symptoms)

### 技術的症状
- 各操作関数（`generate_report()`, `calc_vaccine_schedule()`, `generate_diet_plan()`）の中に `ref($animal)` による if/elsif/else 分岐が散在
- 犬・猫・鳥の3種では正常動作するが、新種（爬虫類）追加時に全操作関数の修正が必要
- 操作関数と動物種が密結合し、Open-Closed原則に違反
- 同じ型チェックパターンが3つの関数にコピペ的に存在

### 医療メタファー
「**多発性分岐硬化症**」

コードの分岐構造が硬直化し、新しい要素（動物種）を受け入れる柔軟性を完全に失った状態。免疫系（既存の型チェック）が新しい細胞（新しい動物クラス）を異物として拒絶するかのように、追加のたびに全身（全操作関数）に炎症（修正）が波及する。自覚症状は軽い（「動いてるから」）が、負荷（拡張要求）をかけると急性発症する。

## 診断 (Diagnosis)

**病名**: 多発性分岐硬化症（Polymorphic Branch Sclerosis）  
**原因**: 型判定ロジックの散在による構造と操作の癒着  
**合併症**: コピペ転移（同一分岐パターンの複数箇所への伝播）

## 処方 (Prescription)

**治療法**: Visitor Pattern 適用手術  
**手術概要**: 
1. 各動物クラスに `accept($visitor)` メソッドを移植（受容体の設置）
2. 操作ロジックを Visitor クラスとして独立させる（転移巣の切除・集約）
3. 新動物種の追加は 1クラス追加のみ、新操作は 1 Visitor 追加のみとなる構造を実現（自己修復型アーキテクチャ）

**予後**: 
- 爬虫類追加: 1クラス + 既存Visitor各1メソッド追加のみ（全操作関数の修正不要）
- 新操作追加: 1Visitorクラス追加のみ（既存動物クラスの修正不要）

## 来院 / 往診

**往診**。後輩の「読めません」発言がきっかけで、上司（院長）に相談。院長が「知り合いにコードを診てくれる人がいる」と紹介。患者のオフィス（クリニックのバックヤード）にドクターとナナコが訪れる形式。
