# Input Design: Visitor

## Step-Back 思考

この記事で読者に持ち帰ってもらいたいこと:
- **データ構造に触れずに新しい操作を追加できる設計**の重要性
- `ref($obj) eq 'ClassName'` や `if/elsif` 型チェック地獄からの脱却
- ダブルディスパッチの仕組みと、なぜそれが必要かの直感的理解

---

## Step 1: テーマ3案

### 案A（王道）: ファイルシステムの統計ツール

- **テーマ名**: ファイルシステムの容量レポーター
- **一行説明**: ファイル・ディレクトリ・シンボリックリンクなど異なるノード種別に対して、容量集計・権限チェック・一覧表示などの操作を追加する
- **パターンとの接点**: ファイルシステムのツリー構造はCompositeの典型だが、その上に「新しい操作をどう追加するか」がVisitorの出番
- **読者像**: LinuxやmacOSでファイル操作ツールを作ったことがある開発者

### 案B（革新）: ペットクリニックの診察記録

- **テーマ名**: 動物病院の診察システム
- **一行説明**: 犬・猫・鳥・爬虫類など異種の動物に対して、診察・予防接種・食事指導などの操作を統一的に適用する
- **パターンとの接点**: 動物の種類ごとに処理が異なるが、新しい診察メニューを追加するたびに全動物クラスを修正したくない → Visitorで操作を外出し
- **読者像**: オブジェクト指向初〜中級者で、身近な例えから入りたい人

### 案C（逆転）: コンパイラのAST最適化

- **テーマ名**: 自作スクリプト言語のAST解析器
- **一行説明**: 式ノード（数値リテラル、二項演算、関数呼び出し等）に対して、型チェック・最適化・コード生成などのパスを追加していく
- **パターンとの接点**: Visitorパターンの原典とも言えるコンパイラ設計。GoFの教科書的題材を「自作スクリプト言語」という親しみやすいスケールで
- **読者像**: 言語処理系に興味がある中〜上級者、コンピュータサイエンスが好きな人

---

## Step 2: 患者3案

### 案A（王道/共感型）: 1年目の社内ツール担当

- **属性**: 24歳、社内SE、エンジニア歴1年
- **性格キーワード**: 真面目、慎重、完璧主義
- **背景**: 先輩が退職し、社内ツールの保守を一人で引き継いだ。新機能追加のたびに既存コードに手を入れて壊すのが怖い
- **主訴**: 「新しい機能を足すたびに、あちこち修正が必要で、もう何を触っていいかわかりません……」
- **コメディポテンシャル**: 完璧主義ゆえ先生のぶっきらぼうな一言に過剰にビクつく。「問題はここだ」に「すみません！」と即座に謝る

### 案B（革新/意外型）: 8年目のデータ分析エンジニア

- **属性**: 31歳、データ分析エンジニア、エンジニア歴8年
- **性格キーワード**: 自信家、合理主義、スピード重視
- **背景**: 分析パイプラインを高速で書くのが得意だが、「動けばいい」精神で型チェックをif文で量産。後輩に引き継ごうとしたら「これ読めません」と言われた
- **主訴**: 「俺のコード、ちゃんと動くのに後輩が『怖くて触れない』とか言うんですよ」
- **コメディポテンシャル**: 自信家なので最初は「別に壊れてないし」とドクターに反論。しかしナナコに「動くことと読めることは別の症状ですよ」と諭されてじわじわ沈黙

### 案C（逆転/ギャップ型）: 5年目のUI/UXデザイナー兼コーダー

- **属性**: 28歳、UI/UXデザイナー、コーディング歴5年
- **性格キーワード**: センス抜群、感覚派、言語化が苦手
- **背景**: デザインツールのプラグインを自作したが、新しい出力フォーマットを追加するたびに巨大なswitch文が育つ。見た目は綺麗だがコードは泥団子
- **主訴**: 「デザインは綺麗にまとまるのに、コードだけはなんでこうグチャグチャになるんでしょう……」
- **コメディポテンシャル**: デザイン的感性でコードの「美しさ」を語り、ドクターが「構造」と一言返すズレが面白い

---

## Step 3: 症状3案

### 案A（王道/典型症状）: 型チェックif/elsif地獄

- **技術的症状**: `ref($obj)` や `isa` で型を判定する if/elsif 連鎖が各操作関数に散在。新しいノード型を追加すると全操作関数を修正が必要
- **医療メタファー**: 「**多発性分岐硬化症**」— 分岐が硬直化し、新しい細胞（型）を受け入れられなくなる自己免疫疾患
- **重症度**: 重症
- **Before/Afterの見込み**: Before: 5つの操作関数に各6分岐 → After: 各ノードがaccept()を持ち、Visitorが操作を担う。新操作は新Visitorクラスを追加するだけ
- **読者の「あっ」ポイント**: 「あ、俺もref()で型チェックしてる……」

### 案B（革新/複合症状）: Open-Closed原則違反 + 型チェック + 操作の散在

- **技術的症状**: 型ごとのif分岐に加え、同じ操作ロジックが複数モジュールにコピペ散在。修正時にどこを直せばいいかわからない
- **医療メタファー**: 「**転移性コピペ肉腫**」— 変異した細胞（ロジック）が全身（コードベース）に転移している
- **重症度**: 重症
- **Before/Afterの見込み**: Before: 3モジュールに同じif/elsif分岐散在 → After: Visitor側に操作ロジックを集約、各モジュールはaccept()を呼ぶだけ
- **読者の「あっ」ポイント**: 「同じswitch文が3箇所にある……直すとき全部修正しないと……」

### 案C（逆転/潜伏症状）: 動いてるけど拡張できない

- **技術的症状**: 現状の3種類のノードに対しては完璧に動作。しかし4種目のノードを追加しようとすると、修正箇所が10ファイルに波及することが判明
- **医療メタファー**: 「**無症候性設計不全**」— 自覚症状はないが、負荷（拡張要求）がかかると急性発症する潜在疾患
- **重症度**: 中症（見た目は軽症だが拡張時に重症化）
- **Before/Afterの見込み**: Before: 3ノードでは問題なし → 4ノード目追加で10ファイル修正 → After: 新ノードは1クラス追加、新操作は1Visitor追加
- **読者の「あっ」ポイント**: 「動いてるから大丈夫と思ってた……でも次の機能追加で詰む」

---

## Step 4: 多角的評価

### テーマ評価

| 評価軸 | 案A（王道: ファイルシステム） | 案B（革新: 動物病院） | 案C（逆転: AST解析） |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 4 | 3 |
| ② メタファー適合度 | 3 | 5 | 3 |
| ③ コメディ発展性 | 2 | 5 | 2 |
| ④ 教育価値 | 4 | 4 | 5 |
| ⑤ 差別化 | 2 | 5 | 3 |
| **合計** | **15** | **23** | **16** |
| **推奨理由** | 堅実だがドキュメント変換と類似 | 医療メタファーと二重に噛み合う | 教科書的だが敷居が高い |

### 患者評価

| 評価軸 | 案A（王道: 新人SE） | 案B（革新: ベテラン分析） | 案C（逆転: デザイナー） |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 5 | 3 |
| ② メタファー適合度 | 3 | 4 | 3 |
| ③ コメディ発展性 | 4 | 5 | 4 |
| ④ 教育価値 | 3 | 4 | 3 |
| ⑤ 差別化 | 3 | 4 | 4 |
| **合計** | **17** | **22** | **17** |
| **推奨理由** | 安定だがシリーズで新人は多い | 自信家ゆえの気づきが物語になる | ギャップは面白いが感情移入が難しい |

### 症状評価

| 評価軸 | 案A（王道: 型チェック地獄） | 案B（革新: 転移コピペ） | 案C（逆転: 潜伏型） |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 5 | 4 | 4 |
| ② メタファー適合度 | 5 | 4 | 4 |
| ③ コメディ発展性 | 4 | 3 | 4 |
| ④ 教育価値 | 5 | 4 | 4 |
| ⑤ 差別化 | 3 | 4 | 4 |
| **合計** | **22** | **19** | **20** |
| **推奨理由** | Visitorの核心を最も直接的に示す | 複合型で現実のカオスを反映 | 潜伏型は知見ベースの知見と噛み合うが展開が難しい |

---

## Step 5: 相乗効果の検討

### 最高スコア組合せ: テーマB（動物病院） × 患者B（ベテラン分析） × 症状A（型チェック地獄）

- **テーマ × 患者**: ✅ データ分析エンジニアが社内の動物管理データの分析ツールを作った……は少し遠い。
  → 再検討: テーマB（動物病院）の場合、患者は獣医向けシステム開発者のほうが自然。しかし「ベテラン分析エンジニア」を活かすなら**テーマを患者に合わせて調整**するのが得策。

### 代替検討: テーマB（動物病院）× 患者A（新人SE）× 症状A（型チェック地獄）

- **テーマ × 患者**: ✅ 動物病院の受付システムを引き継いだ新人SE。先輩が退職し、動物の種類ごとのif文地獄と格闘中
- **テーマ × 症状**: ✅ 犬・猫・鳥の処理はref()で分岐して完璧に動くが、爬虫類サポート追加で崩壊
- **患者 × 症状**: ✅ 引き継ぎで怖くて触れない → 型チェック地獄が原因と判明

→ この組合せの方が**三位一体の整合性が高い**。動物病院テーマは医療メタファーと二重に噛み合い（動物の診察 × コードの診察）、コメディ発展性も抜群。

ただし患者Aは「新人枠」でシリーズ内の差別化がやや弱い。思い切って**患者Bの性格要素**を取り込み、「引き継ぎ後に自信を持ちつつ実はref地獄」というハイブリッドにする。

### 最終選定: テーマB × 患者B（テーマ適合調整）× 症状A

患者Bの「自信家だが盲点がある」性格を活かし、テーマを動物病院に合わせて調整する:
- **調整後の患者像**: 5年目のバックエンドエンジニア。ペットクリニックチェーンの予約・診察管理システムの主要開発者。「動いてるし俺の設計は正しい」と思っているが、新しい動物種のサポート追加ができず、後輩から「触れません」と言われた
- 自信家 → ドクターへの反論 → ナナコの通訳で気づき → 変化、というアークが明確

---

## 選定結果

### 採用案

| 要素 | 採用案 | スコア |
|------|--------|--------|
| テーマ | 動物病院の診察システム（革新） | 23/25 |
| 患者 | 5年目バックエンド、自信家（革新、テーマ適合調整） | 22/25 |
| 症状 | 多発性分岐硬化症 — ref()型チェック地獄（王道） | 22/25 |

- **総合スコア**: 67/75

### 選定理由

テーマの「動物病院」が医療メタファーと二重に噛み合う点が最大の強み。動物の診察とコードの診察が並行する構造は、コードドクターシリーズの世界観と完璧にマッチする。患者は自信家タイプを採用し、「俺のコードは正しい」→「実は設計不全」→「気づきと改心」という明確なアークを描く。症状は王道の型チェック地獄を選択し、Visitorパターンの本質を最も直接的に伝える。

### 3要素の整合性
- **テーマ × 患者**: ✅ ペットクリニックチェーンのシステムを5年間保守しているバックエンドエンジニア。自分の設計に自信があり「犬猫鳥は完璧に動く」が新種追加で破綻
- **テーマ × 症状**: ✅ 動物種ごとのref()分岐が各操作関数に散在。犬猫鳥の3種なら問題ないが、爬虫類・小動物の追加要望で設計の限界が露呈
- **患者 × 症状**: ✅ 自信家ゆえに「動いてるから問題ない」と型チェック地獄を放置。後輩の「触れません」発言でようやく違和感を覚える

## テーマ詳細

- **テーマ名**: ペットクリニックの診察管理システム
- **一行説明**: 犬・猫・鳥など動物種別に、診察・予防接種スケジュール・食事指導レポートなどの操作を統一的に適用するシステム
- **パターンとの接点**: 動物種を追加するたびに全操作関数のif/elsif分岐を修正する必要があり、Visitorパターンで操作を外出しすることで構造と操作を分離
- **読者像**: オブジェクト指向で設計に悩む中級エンジニア
- **差別化ポイント**: 既存のVisitor連載（ドキュメント変換ツール）とは題材が完全に異なり、医療メタファーとの二重の噛み合いは本記事だけの独自性

## 患者詳細

- **属性**: 30歳、バックエンドエンジニア、エンジニア歴5年
- **一人称**: 俺
- **性格キーワード**: 自信家、合理主義、結果重視
- **背景**: 地元のペットクリニックチェーン（3店舗）の予約・診察管理システムを新卒2年目から一人で構築。犬・猫・鳥の処理は完璧に動いており、院長からの信頼も厚い。しかし最近「爬虫類と小動物もサポートしたい」という要望が来て、コードを見返したら修正箇所が多すぎて途方に暮れた。さらに後輩が配属されたが「このコード…読めません」と言われたのが引き金
- **主訴**: 「ちゃんと動いてるのに、なんで拡張できないんだ。俺の設計のどこが悪いってんだ」
- **コメディポテンシャル**: 自信家ゆえに最初は「いや、別に壊れてないし」とドクターに反論。ナナコに「動くことと健康なことは違うんですよ」と動物病院の例えで返されて黙る。動物の診察と自分のコードの診察が並行していることに気づく瞬間がメタ的に面白い

## 症状詳細

- **技術的症状**: 各操作関数（診察レポート生成、予防接種スケジュール計算、食事指導生成）の中で `ref($animal)` を使って動物種を判定する if/elsif/else が散在。犬猫鳥の3種では動いているが、新種追加で全操作関数を修正する必要があり、Open-Closed原則に違反
- **医療メタファー**: 「**多発性分岐硬化症**」— コードの分岐が硬直化し、新しい要素を受け入れる柔軟性を失った状態。免疫系が自分自身を攻撃するように、新しいコードが既存コードを破壊するリスクを孕む
- **重症度**: 重症
- **Before/Afterの見込み**:
  - Before: 3つの操作関数に各3分岐（犬猫鳥） → 爬虫類追加で全3関数を修正
  - After: 各動物がaccept($visitor)を持ち、操作はVisitorクラスとして独立。新動物は1クラス追加、新操作は1Visitor追加
- **読者の「あっ」ポイント**: 「あ、俺もref()とかisaで型チェックしてから処理分けてる……それダメなのか」

## 評価サマリー

| 要素 | 案A | 案B | 案C | 採用 |
|------|-----|-----|-----|------|
| テーマ | 15 | **23** | 16 | B |
| 患者 | 17 | **22** | 17 | B（調整） |
| 症状 | **22** | 19 | 20 | A |
| 総合 | 54 | **67** | 53 | B×B×A |

## 不採用案（参考）

### テーマ不採用
- **案A（ファイルシステム）**: 堅実だが既存のドキュメント変換と構造的に類似
- **案C（AST解析）**: 教育価値は高いが敷居が高く、コメディ発展性が低い

### 患者不採用
- **案A（新人SE）**: 安定パターンだがシリーズ内で新人キャラが多く差別化が弱い
- **案C（デザイナー）**: ギャップは面白いが技術的深掘りとの整合性が難しい

### 症状不採用
- **案B（転移コピペ）**: 複合的で現実的だが、Visitorの核心をぼかすリスク
- **案C（潜伏型）**: 展開としては面白いが、Before/Afterのコントラストが弱い
