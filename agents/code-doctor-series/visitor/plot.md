# Plot Outline: Visitor Pattern

> **舞台**: 往診（ペットクリニック「ぱうずハート動物病院」のバックヤード/事務室）
> **患者**: 速水慧介（30歳、バックエンドエンジニア、一人称: 俺）
> **病名**: 多発性分岐硬化症（Polymorphic Branch Sclerosis）

---

## Scene I: 往診 — 白衣じゃないドクター

### ト書き
ペットクリニックのバックヤード。診察室の裏にある事務スペースで、速水がデスクに向かって画面を睨んでいる。画面にはref()が何行も並ぶPerlコード。院長から「知り合いにコードを診てくれる人がいるから」と聞かされたのは昨日のこと。

バックヤードのドアがノックされ、開くと二人組が入ってくる。一人は黒ずくめの寡黙な男。もう一人は柔和な笑顔の女性。速水は一瞬、動物病院の方の業者だと勘違いする。

### 展開ポイント
- **意外性**: 速水は「動物の医療機器の営業」だと思い、「先生なら診察室ですよ」と案内しようとする。ナナコが「いえ、診るのはコードのほうです」と訂正して始まる
- ドクターは事務室に入るなり、速水のモニタには目もくれず、壁に貼ってある「動物種別対応表」（犬・猫・鳥の3列）をじっと見つめる
- 速水は自信たっぷりに「3年無事故のシステムです」と胸を張る
- ドクターが対応表を指差して一言：「…3列か」

### 主要セリフ
- 速水: 「あ、先生の方ですか？ 診察室はこっちの——」
- ナナコ: 「大丈夫ですよ、ここはコード診療所です……あ、いえ、往診ですね。コードを診させていただきに参りました」
- 速水: 「はあ……まあ、一応見てもらいますけど。正直、ちゃんと動いてるんですよ」
- ドクター:（壁の対応表を見つめて）「……3列か」

---

## Scene II: 触診 — 「動いてる」は「健康」じゃない

### ト書き
ドクターがモニタの前に座り、コードをスクロールし始める。速水のコード画面を一目見た瞬間、ドクターの眉が僅かに動く。3つの操作関数それぞれにref()による分岐が並んでいる。ドクターはスクロールを何度か繰り返し、3つの関数を行き来する。

### 展開ポイント
- ドクターが3つの操作関数を並べて表示し、指で「ここ、ここ、ここ」と同じパターンを指す
- 速水は「ちゃんと型チェックしてますけど？」と反論
- ナナコの通訳がペットクリニックの例えで刺さる:「動物の種類ごとに診察のやり方を変えるのは当然ですよね。でも、もし新しい動物が来るたびに、診察マニュアル全ページを書き換えなきゃいけなかったら？」
- 速水の表情が変わる瞬間 —— まさに今、爬虫類追加でその状況になっていることに気づく
- ドクターがref()の行を指して診断名を告げる

### 主要セリフ
- ドクター:（3つの関数を指して）「……同じ傷が、3箇所」
- ナナコ: 「同じ型チェックの分岐が3つの関数に散らばっているんです。いわば、全身に同じ炎症が出ている状態ですね」
- 速水: 「いや、動物ごとに処理が違うんだから、分岐は当然だろ」
- ナナコ: 「動物の種類ごとに診察のやり方を変えるのは当然ですよね。でも、新しい動物が来るたびに全部の診察マニュアルを書き換えるお医者さん、大変じゃないですか？」
- 速水:（沈黙。まさに今その状況だと気づく）
- ドクター: 「多発性分岐硬化症」
- ナナコ: 「分岐が硬くなって、新しい種類を受け入れられなくなっているんです。治療法はありますよ」

---

## Scene III: 外科手術 — Visitorパターンの移植

### ト書き
ドクターが速水の横に座り、キーボードに手を伸ばす。速水にとっては「俺のコードに触るのか」という緊張の瞬間。ドクターは黙々とリファクタリングを始め、ナナコが横から速水に解説する。

### 展開ポイント（手術の3ステップ）

#### Step 1: 受容体の設置（accept メソッド）
- ドクターが各動物クラスに `accept($visitor)` メソッドを追加する
- ナナコの通訳:「それぞれの動物が『自分のことは自分で名乗る』ようにするんです。お医者さんに『自分は犬です』と伝える受付カードみたいなもの」
- 速水の反応:「受付カード……？ ダブルディスパッチってやつか？」

#### Step 2: 操作の独立（Visitor クラス）
- ドクターが `generate_report()` の中身を `ReportVisitor` クラスとして抽出する
- ref()分岐がまるごと消え、各動物種ごとのメソッド（`visit_dog`, `visit_cat`, `visit_bird`）に分離される
- 速水の反応:「あ、if文が……消えた」
- ナナコ:「診察マニュアルを動物ごとのページに分けたんです。新しい動物が来たら、新しいページを足すだけ」

#### Step 3: 拡張テスト（爬虫類の追加）
- ドクターが `Reptile` クラスと各Visitorに `visit_reptile` メソッドを追加する
- **たった数行の追加で爬虫類に対応完了**。既存の犬猫鳥の処理は一切触らない
- 速水の声が上ずる:「え、これだけ？ 俺が3日悩んだのが……」
- ドクター:（小さく頷く）

### 勘違いコメディシーン
手術中、ドクターが速水の肩に手を伸ばす。速水は「俺の頑張りを認めてくれるのか……？」と身構えるが、実はドクターの背後にあるコーヒーメーカーに手を伸ばしていただけ。ナナコが黙ってカップを差し出し、ドクターは満足そうに一口飲む。速水だけが「……え？」と取り残される。

### 主要セリフ
- ドクター:（各動物クラスにacceptを書きながら）「……受容体」
- ナナコ: 「各動物に『自分を紹介する窓口』を作るんです。受付カードみたいなものですよ」
- 速水: 「受付カード？ 要するにダブルディスパッチ……」
- ドクター:（ref()分岐を削除して）「……切除完了」
- 速水: 「あ、if文が消えた……」
- ナナコ: 「診察マニュアルを1冊の大きな本から、動物ごとのカードに分けたんですよ。新しい動物が来たら、カードを1枚足すだけです」
- ドクター:（Reptileクラスを数行で追加して）「……完了」
- 速水: 「え、これだけ？ 俺が3日悩んだのが——」
-（ドクターが速水の肩の方に手を伸ばす）
- 速水:（身構えて）「あ、いや、その、ありがとうございま——」
-（ドクター、速水の肩越しにコーヒーメーカーのボタンを押す）
- ナナコ:（カップを差し出して）「先生、お砂糖は？」
- ドクター: 「ブラック」
- 速水: 「……え？」

---

## Scene IV: 術後経過 — 4列目のある対応表

### ト書き
リファクタリングが完了し、テストが全て通る。速水はモニタを見つめ、動物種ごとにきれいに分離されたコードを確認している。壁の「動物種別対応表」が3列のままであることにふと気づく。

### 展開ポイント
- 速水が「4列目を足すのも、こんなに簡単なのか」と呟く
- ドクターが帰り支度を始める。鞄を手に取り、ドアに向かう
- 速水が「ありがとうございました」と頭を下げるが、ドクターは振り返らず一言
- ナナコが最後に速水の対応表を指さして「4列目、楽しみにしてますね」と微笑む
- ドアが閉まった後、速水が対応表の隣にペンで「爬虫類」の列を書き足す

### 主要セリフ
- 速水: 「……なるほど。これなら後輩にも読めるな」
- ドクター:（帰り支度をしながら）「……コミットメント」
- ナナコ: 「先生は治療費の代わりに、テストをきちんと書くことをお願いしているんです。これからも動物が増えたら、テストを書いて確認してくださいね」
- 速水: 「テストか……ああ、俺、テスト書いてなかったな」
- ドクター:（ドアの前で振り返らず）「感謝は、このコードに」
- ナナコ: 「4列目、楽しみにしてますね」
- 速水:（一人になった事務室で、対応表に「爬虫類」と書き足しながら）「……悔しいけど、すげえ医者だった」

---

## 舞台整合性チェック

### 往診チェック
- [x] ドクターと助手が「来て」「帰る」側 → ✅ ドクターが帰り支度をし、ドアを出る
- [x] 患者は自分の場所に居る側 → ✅ 速水はバックヤード事務室のデスクが自席
- [x] クリニック固有の小物は未使用 → ✅ O'Reilly本の壁やトリプルディスプレイは登場しない
- [x] 患者の所有物（デスク・モニタ・壁の対応表）は自然に存在 → ✅ 速水の職場環境
- [x] 退場シーンの主語が正しい → ✅ ドクターがドアを出る、速水が残る
- [x] 退場後のシーンが設定と矛盾しない → ✅ 速水が一人で対応表に書き足す

---

## タイトル案

```
コードドクター【Visitor】多発性分岐硬化症〜全身に散らばったref()を切除せよ〜
```
