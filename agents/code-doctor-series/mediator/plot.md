# Plot Outline: Mediator — レストランのオーダー管理

## 設定

- **舞台**: 往診（患者のオフィス）
- **時間帯**: 平日の午後。オフィスにはモニターが3台並び、付箋だらけのホワイトボードに「Delivery対応TODO」と赤字で書いてある
- **状況**: 新セクション「デリバリー」の追加で既存4モジュール全てが修正必要になり、バグが止まらない状態

---

## I. 往診 — 「どちら様ですか？」

### シーン概要
患者（仲村）がオフィスで頭を抱えている。画面にはPerlコードと大量のエラーログ。チャットツールには同僚から「デリバリー対応いつ終わる？」のメッセージが来ている。ドアをノックする音。

### 展開
- 仲村がドアを開けると、無表情の男（ドクター）と、にこやかな女性（ナナコ）が立っている
- 仲村「どちら様ですか？　営業でしたら今ちょっと…」
- ナナコの定番セリフ「大丈夫ですよ、ここはコード診療所です……あ、いえ、往診ですね」
- ドクターは挨拶もせず、仲村のモニターを一瞥して部屋に入る
- 仲村（内心）：なにこの人、不審者？ でもナナコさんがいるから大丈夫なのか…？

### 感情の起伏
焦燥 → 困惑 → かすかな期待

---

## II. 触診 — 「全身感染だ」

### シーン概要
ドクターがモニターに映る `Waiter.pm`, `Kitchen.pm`, `Bar.pm`, `Cashier.pm` のコードを見る。仲村がおしゃべりに背景を説明する。

### 展開
- 仲村が饒舌にシステムの経緯を語る。「俺、元々ホールスタッフだったんですよ。だからリアルなフローがわかってて…」
- ドクターはキーボードに触れず、コードをスクロールするだけ。沈黙が長い
- 仲村「あの…先生？聞いてます？」
- ドクター（モニターを指差して）：「全身感染だ」
- 仲村「え？」
- ナナコ（にっこり）：「各モジュールが全て直接繋がっていて、1つを動かすと全部に影響が出る状態ですね。お料理で言うと、一つの食材を変えたら全メニューのレシピを書き直さなきゃいけない状態です」
- 仲村「あー！それそれ！デリバリーを追加しようとしたら4ファイル全部触らなきゃいけなくて…」
- ドクターがコードの依存関係を図示。use文を指でなぞりながら「20本」とだけ呟く
- ナナコ「5つのモジュールが互いに全部参照し合っているので、接続が5×4=20本になっているんです。これが全身感染… N×N依存症候群ですね」

### 技術ポイント（Beforeコード提示）
`$waiter->notify_kitchen($kitchen)` / `$kitchen->notify_bar($bar)` のような直接参照がずらりと並ぶコードを見せる。

---

## III. 外科手術 — 「仲介者を置け」

### シーン概要
ドクターがリファクタリングを開始。仲村は横で見ながら、ナナコの解説を聞く。

### 展開

#### 前半：診断の深掘り
- ドクターが `process_order` メソッドの引数を指差す：`sub process_order($self, $waiter, $kitchen, $bar, $cashier)`
- ドクター：「癒着」
- ナナコ：「このメソッド、5つのモジュール全部を引数で受け取っていますよね。臓器同士が癒着している状態です。1つの臓器を取り出すには、全部を一緒に動かすしかない」
- 仲村：「いや、でも全部必要なんですよ。ウェイターがキッチンに伝えて、バーにもドリンク注文伝えて…」

#### 中盤：パターンの核心 — 「あなたがやっていること、そのものですよ」
- ナナコ：「仲村さん、普段のお仕事で、キッチンとホールの間で揉め事があったらどうされます？」
- 仲村：「え？　俺がまとめるに決まってるじゃないですか。両方の話を聞いて、必要な情報だけ伝えて…」
- ナナコ（微笑んで）：「それですよ。**あなたが普段やっていること、そのものです**」
- 仲村：「…えっ？」
- ナナコ：「キッチンがホールに直接怒鳴るよりも、間にマネージャーが入ったほうがスムーズですよね？　コードも同じです。全員が全員に直接話しかけるのではなく、間に1つ仲介者を置くんです」
- 仲村の目が大きく見開かれる。「あー！！　俺がやってること！オーダーマネージャーみたいなやつを…コードにも置けばいいのか！」
- ドクター（小さく頷く）：「そうだ」（←ドクターにしては長いセリフ）

#### 後半：手術の実施
- ドクターが `OrderMediator` クラスを新規作成。黙々とキーボードを叩く
- 各モジュールの `use` 文から他モジュールへの直接参照を削除し、Mediator への参照のみに変更
- `$waiter->notify_kitchen(...)` → `$self->mediator->notify('kitchen', $order)` に書き換え
- 仲村「おお…依存線が消えていく…！」
- ナナコ「20本あった接続が5本になりましたね。各モジュールは Mediator だけを知っていればいい。新しいセクションを追加しても、Mediator に登録するだけで済みます」

### 勘違いコメディシーン（ここに配置）
- 手術中、仲村が気を利かせてコーヒーを3人分淹れてくる
- ナナコ「ありがとうございます」と受け取り、ドクターの分をデスクに置く
- ドクターはコードに集中しているが、コーヒーの匂いに気づき、ふと手を止めてカップを見る
- ドクターがナナコの方をちらりと見て、ほんの少しだけ口角が上がる（←ナナコがわざわざ自分の好みを覚えて淹れてくれたと思っている）
- 仲村（内心）：あれ、今この人ちょっと笑った…？ ナナコさんに対してだけ表情が変わるような…
- ナナコ（仲村に向かって、何事もなかったように）：「さて、テストも書き換えましょうか」
- ドクターは再びコードに没頭。仲村は二人の関係が気になるが聞けない

---

## IV. 術後経過 — 「5本だ」

### シーン概要
リファクタリング完了後、テストを実行し、Deliveryモジュールを追加してみせる。

### 展開
- ドクターがテストを実行。全テスト通過
- 仲村「お、通った！」
- ドクターが新規ファイル `Delivery.pm` を作成し始める
- 仲村「え、デリバリーも！？」
- ドクターは `Delivery.pm` 内で `OrderMediator` だけを参照。他のモジュールには一切触れない
- Mediator に `delivery` を登録する1行を追加するだけ
- テスト実行。通過
- 仲村「…嘘だろ。Waiter も Kitchen も Bar も Cashier も、何も触ってない…」
- ドクター（立ち上がりながら）：「5本だ」
- ナナコ：「20本あった依存が5本に。そして新セクションの追加は Mediator への登録1行だけ。これが仲介者パターンの効果です」

### 退院指導
- 仲村「先生…ありがとうございます。俺、自分がいつもやってることをコードに持ち込めばよかったんですね」
- ドクター（鞄を手に取りながら）：「感謝は、このコードに」
- ナナコ「今後セクションが増えても、Mediator を育てていけば大丈夫です。仲村さんがチームをまとめるように、ね」
- ドクターとナナコがドアに向かう（往診なので去る側はドクター）
- 仲村はドアが閉まるのを見送り、モニターに映るスッキリしたコードを眺める
- 仲村（独白）：「…俺、コードのMediator にもなれるかもな」

---

## 舞台設定の整合性チェック

### 往診チェック

- [x] ドクターと助手が「来て」「帰る」側（帰り支度・ドアを出る主語はドクター）
- [x] 患者は自分の場所に居る側（デスク・付箋・モニタ等そのまま使用可）
- [x] クリニック固有の小物（O'Reilly本の壁等）は使用していない
- [x] 退場シーンの主語がドクター側になっている
- [x] 退場後のシーンが設定と矛盾しない（患者がオフィスに残る）
