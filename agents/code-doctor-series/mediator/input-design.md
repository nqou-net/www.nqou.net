# Input Design: Mediator

## 技術制約

- **言語**: Perl v5.36以降（signatures・postfix dereferenceサポート必須）
- **公開日時**: 2026-02-28T07:07:05+09:00

## 差別化ポイント

既存の Mediator 連載シリーズ「航空管制シミュレーター」とは**題材・切り口を完全に変える**。
Mediator の本質＝「**複数のオブジェクト間の相互依存を、中央の仲介者に集約することで疎結合を実現する**」。
直接通信のスパゲッティ（N×N接続）を、ハブ＆スポーク（N接続）に変換する設計上の転換点を伝える。

---

## Step-Back思考

> **この記事で読者に持ち帰ってもらいたいこと**:
> 「複数コンポーネントが互いに直接呼び合ってカオスになっているコードを見たとき、
> 仲介者を1つ置くだけで通信経路が劇的に整理される」という設計判断のタイミングと効果。

---

## Step 1: テーマ3案

### 案A（王道）: チャットルーム・システム

- **テーマ名**: マルチユーザーチャットルーム
- **一行説明**: 複数のユーザーがメッセージを送受信するチャットシステムで、ユーザー同士が直接通信するスパゲッティを仲介者で整理する
- **パターンとの接点**: ユーザーA→B, A→C, B→C…と直接参照し合うN×N依存を、ChatRoomMediator が一元管理することで各ユーザーは仲介者だけを知ればよくなる
- **読者像**: Webアプリでリアルタイム通信を実装したことがある中級者

### 案B（革新）: スマートホーム・デバイス連携

- **テーマ名**: IoTスマートホーム制御パネル
- **一行説明**: 照明・エアコン・センサー・スピーカーなど複数デバイスが連動するスマートホームで、デバイス間の直接制御を排してコントローラーに集約する
- **パターンとの接点**: 「人感センサーが検知→照明ON→エアコン起動→スピーカー通知」のような連鎖を、各デバイスが互いを知らずにMediatorだけを介して実現する
- **読者像**: IoTや組込みに興味があるが、依存関係の肥大化に悩んだ経験がある開発者

### 案C（逆転）: レストランのオーダー管理

- **テーマ名**: レストランのキッチン・ホール連携オーダーシステム
- **一行説明**: ウェイター・キッチン・バー・会計など、飲食店の各セクションが直接やり取りしていた注文フローを、オーダーマネージャー（仲介者）で統括する
- **パターンとの接点**: 注文の流れ（客→ウェイター→キッチン/バー→配膳→会計）がセクション間の直接呼び出しで絡まる。仲介者がオーケストレーターとなり、各セクションは「何をすべきか」だけに集中できる
- **読者像**: 業務システムやワークフローエンジンの設計に関わるエンジニア。「プログラミングとは無関係に見えるが、まさにMediator」という気づき

---

## Step 2: 患者3案

### 案A（王道）: 共感型 — 頑張りすぎる若手

- **属性**: 25歳、Webバックエンドエンジニア、経験3年目
- **性格キーワード**: 真面目、猪突猛進、褒められたい
- **背景**: チーム内でマイクロサービス間の連携APIを書いている。コンポーネントが増えるたびに直接呼び出しを追加していった
- **主訴**: 「新しいサービスを追加するたびに、既存のサービス全部を修正しなきゃいけなくて、もう限界です…」
- **コメディポテンシャル**: 真面目すぎて「全部繋いだほうが確実」と信じ切っている。ドクターの「やりすぎだ」の一言に衝撃を受ける。ナナコのフォローを全力で信じて「はい！はい！」と食いつく

### 案B（革新）: 意外型 — 几帳面すぎるベテラン

- **属性**: 38歳、インフラ兼バックエンドエンジニア、経験15年
- **性格キーワード**: 几帳面、完璧主義、俺流
- **背景**: 自分が管理する社内ツールのコードを15年間保守し続けている。全モジュールが相互参照で密結合だが「全部把握しているから問題ない」と豪語。しかし後輩に引き継ぎできなくて困っている
- **主訴**: 「俺のコードは動いてるのに、なぜか誰も触りたがらないんだよな…」
- **コメディポテンシャル**: 自分のコードに絶対的自信があるのに「引き継ぎ先がいない」という矛盾に気づいていない。ドクターの沈黙がプレッシャーになり、初めて自分のコードを客観視する瞬間が生まれる

### 案C（逆転）: ギャップ型 — コミュ力おばけのPM兼エンジニア

- **属性**: 32歳、PM兼フルスタック、経験7年
- **性格キーワード**: 社交的、おしゃべり、直感型
- **背景**: 人間関係の調整は得意だが、コードでも「直接話を通す」感覚で各モジュールを直接繋いでしまう。リアルではまさにMediator的存在なのに、コードではその逆をやっている
- **主訴**: 「人間同士ならうまく回せるのに、コードになると全部がこんがらがるんですよね…」
- **コメディポテンシャル**: 人間関係では「仲介者」として完璧な能力を持っているのに、コードでは真逆をやっている皮肉。ナナコが「あなたがやっていることそのものですよ」と指摘した時の「えっ？」が最高に面白い

---

## Step 3: 症状3案

### 案A（王道）: 典型症状 — 全員が全員を知っている依存地獄

- **技術的症状**: 5つ以上のコンポーネントが互いにuse/requireで直接参照。コンポーネント追加のたびに既存全ファイルの修正が必要（N×N依存）。メソッド引数にオブジェクト参照がぞろぞろ連なる
- **医療メタファー**: 「全身感染症（セプシス）」— 一箇所の変更が全身に波及する。臓器（コンポーネント）が全て直接結合しており、一つの炎症が全臓器に転移する
- **重症度**: 重症
- **Before/Afterの見込み**: Before: 5コンポーネント×4接続=20依存 → After: 5コンポーネント×1仲介者=5依存。依存の方向が一方向に整理される
- **読者の「あっ」ポイント**: 「追加するたびに全ファイル修正…あ、うちのプロジェクトそのものだ」

### 案B（革新）: 複合症状 — イベント連鎖の暴走

- **技術的症状**: コンポーネント間でコールバックチェーンが形成され、A→B→C→Aの循環参照が発生。デバッグ時にどこが起点かわからない。エラー処理が各コンポーネントに分散し、一貫性がない
- **医療メタファー**: 「自己免疫疾患」— 体の防御システム（コールバック）が暴走し、自分自身を攻撃（循環呼び出し）している。正常な反応と異常な反応の区別がつかない
- **重症度**: 中症〜重症
- **Before/Afterの見込み**: Before: 循環コールバック地獄で無限ループのリスク → After: Mediatorが通知の順序とフローを制御、循環を検出・防止
- **読者の「あっ」ポイント**: 「コールバック地獄でデバッグできない…ああ、循環依存してたのか」

### 案C（逆転）: 潜伏症状 — 動いているけど壊れている

- **技術的症状**: 表面上は正常に動いているが、コンポーネント間の暗黙の依存（呼び出し順序、初期化順序）がハードコードされている。新しいコンポーネントを追加すると「既存の何か」が壊れるが、原因特定に時間がかかる
- **医療メタファー**: 「不整脈（アリスミア）」— 心臓（システム）は動いているが拍動のリズム（実行順序）が不規則。安静時（通常運用）は問題ないが、負荷をかけると突然停止する
- **重症度**: 中症（潜在的に重症）
- **Before/Afterの見込み**: Before: 暗黙の順序依存がハードコードされ、拡張不可能 → After: Mediatorが実行順序を明示的に管理し、新コンポーネントの追加が安全に
- **読者の「あっ」ポイント**: 「テスト通ってるのに本番で不具合…あれ、初期化順序に依存してた？」

---

## Step 4: 多角的評価

### テーマ評価

| 評価軸 | 案A（王道）チャットルーム | 案B（革新）スマートホーム | 案C（逆転）レストラン |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 3 | 5 |
| ② メタファー適合度 | 3 | 4 | 5 |
| ③ コメディ発展性 | 3 | 3 | 5 |
| ④ 教育価値 | 4 | 4 | 4 |
| ⑤ 差別化 | 2 | 4 | 5 |
| **合計** | **16** | **18** | **24** |
| **推奨理由** | 鉄板だが既視感 | IoT文脈は面白いが共感性△ | 日常メタファーが強力で差別化◎ |

### 患者評価

| 評価軸 | 案A（王道）若手 | 案B（革新）ベテラン | 案C（逆転）PM兼エンジニア |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 3 | 4 |
| ② メタファー適合度 | 3 | 4 | 5 |
| ③ コメディ発展性 | 3 | 4 | 5 |
| ④ 教育価値 | 4 | 4 | 4 |
| ⑤ 差別化 | 3 | 4 | 5 |
| **合計** | **17** | **19** | **23** |
| **推奨理由** | 安定だが既出キャラに近い | 深みあるが共感性△ | 「人間Mediator」の皮肉が◎ |

### 症状評価

| 評価軸 | 案A（王道）全身感染 | 案B（革新）自己免疫 | 案C（逆転）不整脈 |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 5 | 4 | 4 |
| ② メタファー適合度 | 5 | 4 | 4 |
| ③ コメディ発展性 | 3 | 3 | 4 |
| ④ 教育価値 | 5 | 4 | 3 |
| ⑤ 差別化 | 3 | 4 | 4 |
| **合計** | **21** | **19** | **19** |
| **推奨理由** | 全身感染=N×Nの直感的メタファー | 循環依存は面白いが複雑 | 潜伏症状は中級者向け |

---

## Step 5: 相乗効果の検討と最適組合せ

### 最高スコア組合せ: テーマC × 患者C × 症状A

| 整合性チェック | 結果 |
|--------------|------|
| テーマ × 患者 | ✅ PM兼エンジニアが社内の飲食店管理システムを作るシナリオは自然 |
| テーマ × 症状 | ✅ レストランの各セクションが全て相互参照で密結合、追加セクション（例: デリバリー）のたびに全修正が必要 |
| 患者 × 症状 | ✅ 人間関係では仲介者なのにコードでは全直接結合。「自分がやっていることをコードに持ち込めばいい」という気づきが物語の核 |

### 選定結果

| 要素 | 採用案 | スコア |
|------|--------|--------|
| テーマ | 案C「レストランのキッチン・ホール連携オーダーシステム」（逆転） | 24/25 |
| 患者 | 案C「コミュ力おばけのPM兼エンジニア（32歳、経験7年）」（逆転） | 23/25 |
| 症状 | 案A「全身感染症 — N×N依存の全員が全員を知っている依存地獄」（王道） | 21/25 |
| **総合スコア** | | **68/75** |

### 選定理由

テーマの「レストランのセクション連携」は、Mediator パターンの本質（ハブ＆スポーク型の通信集約）を日常のアナロジーで直感的に伝えられる。
患者が「人間関係ではまさにMediator」なのにコードでは真逆をやっているという**皮肉なギャップ**が、コメディとしても教育としても機能する。
症状は王道のN×N依存を採用し、読者が確実に技術的内容を理解できるバランスを取った。
「あなたが普段やっていること、そのものですよ」という気づきの瞬間が物語のクライマックスとなる。

---

## 不採用案（参考）

### テーマ不採用
- **案A（王道）チャットルーム**: 16/25。Mediatorの典型例すぎて既視感が強い
- **案B（革新）スマートホーム**: 18/25。IoT文脈は差別化できるが読者共感度が低め

### 患者不採用
- **案A（王道）若手**: 17/25。「真面目すぎる若手」は過去記事と差別化が弱い
- **案B（革新）ベテラン**: 19/25。深みはあるが「自信家ベテラン」は既出キャラに近い

### 症状不採用
- **案B（革新）自己免疫疾患**: 19/25。循環参照は面白いが記事の焦点がぼやける
- **案C（逆転）不整脈**: 19/25。潜伏型は中級者向けで初学者にはわかりにくい
