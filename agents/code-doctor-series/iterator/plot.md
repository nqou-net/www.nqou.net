# Plot Architecture: Iterator (ページネーションAPIの透過的統合)

## 背景設定
- **患者**: 猪突猛進のバックエンド・タケル (26)
- **テーマ**: 100件ずつしか返さないSaaS APIから数万件のデータを同期するバッチ処理
- **症状**: 慢性ページネーション管理不全 と 急性メモリ横領症（全件配列pushによるOOM）
- **舞台**: コード診療所（来院）

---

## 思考プロセス（意外性のある展開の選定）

### I. 導入 (Admission)
- **ありきたりな展開**: 患者が「メモリが足りない！」とPCを抱えて泣きついてくる。
- **除外理由**: 面白いが典型的すぎる。
- **意外性のあるルート**: 患者が「メモリ増設の処方箋」を要求しに来る。「俺のコードは完璧なんですが、サーバーの胃袋（メモリ）が小さすぎるんです！64GBのインスタンスに変える診断書を書いてください！」と、根本原因をインフラに転嫁している状態からスタート。

### II. 検査 (Examination)
- **ありきたりな展開**: ドクターがコードを見て「全件配列に入れているからだ」と指摘する。
- **除外理由**: 解決が早すぎてドラマがない。
- **意外性のあるルート**: 実際にバッチをローカルで動かし、メモリ使用量のグラフ（アクティビティモニタ）を見せる。グラフが垂直に駆け上がってPCのアクティブファンが爆音を立て始め、「ほら、君のコードが呼吸困難に陥っている音だ」と物理的な恐怖を煽る。

### III. 処置 (Surgery)
- **ありきたりな展開**: `Iterator` クラスを作って、ちょっとずつ返すようにしました、と説明する。
- **除外理由**: 教科書的で視覚的カタルシスに欠ける。APIのページネーションという特徴が活きていない。
- **意外性のあるルート**: Perl v5.36の機能（signatures 等）を使い、**クロージャを用いた状態カプセル化（貧者のオブジェクト）**による関数型アプローチのIteratorを提示。「クラスすら不要だ。この小さなカプセル（クロージャ）の中に、APIの `next_token` を閉じ込めておく」と宣言し、数百行あったループと変数管理のコードが `while (my $item = $iter->())` の1行に圧縮される魔法を見せる。

### IV. 予後 (Prognosis)
- **ありきたりな展開**: 「メモリが減りました！ありがとうございます！」と感謝して帰る。
- **除外理由**: 記憶に残らない。
- **意外性のあるルート（勘違いコメディ）**: 
  - ドクターが「一口ずつ噛んで飲み込め（イテレートしろ）」と忠告する。
  - 患者はそれを**自分自身の食事のアドバイス**だと勘違いし、「わかりました！これからはエナジードリンクを一気飲みせず、ちびちび舐めるようにします！」と的外れな決意をしてドアを押して出ていく。
  - 助手は無言で、ドクターの机の上にあった飲みかけのエナジードリンクを片付ける。

---

## プロット詳細 (Plot Outline)

### Scene 1: The Emergency (導入)
タケルが診療所の重厚な鉄の扉を**引いて**入ってくる（外開き）。片手には熱を持ったノートPC。
**タケル**: 「ドクター！インフラチームに出す『インスタンスのメモリ64GB増設要求』の診断書を書いてください！俺のコードは完璧なのに、サーバーの胃袋が小さすぎて毎日OOM Killerに殺されてるんです！」
**ドクター**: （エスプレッソをすすりながら）「……過食だ（Overeating）」
**助手（ナナコ）**: 「ドクターは『サーバーの胃袋が小さいのではなく、あなたがSaaSから送られてくる大量のデータを一度に丸呑みしようとしている』と仰っています」

### Scene 2: The Examination (検査)
ドクターがタケルのPCをひったくり、バッチ処理を実行する。
タケルのコード: `my @all_data; while (my $res = $api->get(...)) { push @all_data, $res->items->@*; ... }`
画面上のメモリ使用量グラフが、ロケットのように垂直上昇していく。PCの冷却ファンが悲鳴を上げ始める。
**ドクター**: 「……急性異所性過食症（Acute Ectopic Hyperphagia）」
**助手（ナナコ）**: 「本来なら少しずつ消化すべき『100件ずつのAPIレスポンス』を、巨大な配列という胃袋に全量押し込んでいるため、破裂（クラッシュ）寸前だという診断ですね」
**ドクター**: 「……状態（State）の漏出」
**助手（ナナコ）**: 「その上、ページネーションのトークン管理がループの外に漏れ出し、データ取得と処理ロジックがひどく癒着しています。これでは患部の切除も困難だと嘆いておられます」
**タケル**: 「だ、だってAPIが100件ずつしか返さないのが悪いんですよ！ちまちま処理してたら日が暮れるじゃないですか！」

### Scene 3: The Surgery (処置)
**ドクター**: 「……咀嚼（Mastication）の欠如」
**助手（ナナコ）**: 「無限に続くコース料理を一口でかき込む客はいないでしょう、ということです。ドクターが今から『Iterator（反復子）』パターンによる治療を行います」
ドクターの指がHHKBの上を舞う。
**ドクター**: 「……カプセル化（Encapsulation）。Perl v5.36のクロージャ（Closure）」
ドクターは、API呼び出しと `next_token` の管理を、一つのサブルーチン（イテレータファクトリ）の中に完全に閉じ込める。
**助手（ナナコ）**: 「今回は古典的なクラスベースではなく、強力なクロージャを使って『貧者のオブジェクト』を作ります。厄介なAPIページネーションの状態管理は、すべてこの小さなカプセルの中に隔離するという美しい手法ですね」
処置後のコードが実行される。ファンの爆音は止み、メモリグラフは地を這うように安定した一直線を描く。何万件のデータが流れ込んでも、メモリ消費は一定のまま。
**タケル**: 「うわっ！？何万件処理してるのに、メモリがピクリとも動かない…！しかも、あのグチャグチャだったwhile文が、たった1行の綺麗なループに…！」

### Scene 4: The Misunderstanding & Prognosis (予後と勘違い)
**ドクター**: 「……一口サイズ（Bite-size）」
**助手（ナナコ）**: 「どんなに巨大なデータストリームでも、状態を内包したIteratorを通して『一口サイズ』にすることで、安全に消化し続けることができる。暴飲暴食はやめるようにとのご忠告です」
**タケル**: （目を輝かせて）「はい！ドクターの言う通りです！俺、反省しました！」
タケルは感動した面持ちで、持参していた2リットルのメガ盛りエナジードリンクを見つめる。
**タケル**: 「これからは、エナドリを一気飲みするのはやめます！Iteratorパターンに則って、ストローで10ミリリットルずつ、状態を管理しながらチビチビ舐め続けます！」
**助手（ナナコ）**: （……胃の話じゃなくて、メモリの話なんですけど）
**タケル**: 「診断書は不要になりました！ありがとうございます！」
タケルは颯爽と踵を返し、鉄の扉を**押して**廊下へと去っていく。
静寂が戻った診療所。ナナコは小さくため息をつきつつ、ドクターの机の隅に置かれていた「空のメガジョッキ・コーヒー」を無言で回収する。
**ドクター**: 「……矛盾（Contradiction）」
