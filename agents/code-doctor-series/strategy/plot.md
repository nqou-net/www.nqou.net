# Plot Outline: Strategy — 潜伏性自己免疫疾患〜競馬予想エンジンの臓器分離術〜

## 舞台設定

- **形式**: 往診（患者の自宅、書斎兼作業部屋）
- **時間帯**: 土曜の午後
- **環境**: 統計書とプログラミング入門書が混在する本棚。壁にはオッズ変動のグラフが貼ってある。デスクにはデュアルモニタ（片方にスプレッドシート、片方にターミナル）

---

## I. 往診 (Admission)

### シーンの方向性

ありきたり除外: 「突然やってくるドクター → 患者驚き → 不審者扱い」はシリーズ定番なので踏襲するが、**患者の反応**で差別化。神崎は統計アナリスト出身なので、驚きつつも**データで状況を把握しようとする**。「あなたは誰ですか？」ではなく「あなたの来訪確率は僕の計算にないんですが」的な理系的困惑。

### シーン展開

1. 神崎がデスクで予想アルゴリズムのバグと格闘中。6つ目のロジック追加後、馬場分析の的中率が70%→23%に暴落。
2. インターホンが鳴る。ドアを開けると、黒い鞄を持った無表情の男と、横に柔和な笑顔の女性。
3. ナナコ「大丈夫ですよ、ここはコード診療所です……あ、いえ、往診ですね」
4. 神崎は困惑するが、ナナコの説明を聞いて半信半疑で通す。
5. ドクターが書斎に入るなり、壁のオッズ変動グラフを一瞥。そして **何も言わずにデスク前に座る**。
6. 神崎「あの……僕のコードのバグを直してくれるんですか？」
7. ドクター「コードを見せろ」

### ポイント
- 神崎の書斎の描写で「統計の世界の住人がプログラミングに踏み出した」感を出す
- ドクターがグラフに一瞬興味を示す（ように見える）が、実はモニタのターミナルを見ていただけ

---

## II. 触診 (Examination)

### シーンの方向性

ありきたり除外: 「ひどいコードだ！」と怒るのではなく、**ドクターが最初は「……悪くない」と評価する**意外性。ディスパッチテーブルを使っている時点で、完全な初心者のコードではない。しかし深く触診すると——。

### シーン展開

1. ドクターが `HorsePredictor.pm` を開く。ディスパッチテーブルを見て一瞬止まる。
2. ドクター「……悪くない」
3. 神崎がホッとする。ナナコも少し意外そうな顔。
4. ドクターがスクロールを続ける。匿名サブルーチンの中身を見ていく。表情が変わる。
5. ドクター「……いや。これは **免疫疾患** だ」
6. 神崎「免疫……？ テストは通ってるんですが」
7. ドクターが `$weight_cache` を指差す。ドクター「ここだ。 **共有汚染**」
8. ナナコの通訳: 「一つの冷蔵庫をみんなで使っているような状態です。誰かが牛乳を入れ替えると、お隣のおかずの味まで変わってしまう——そんな感じですね」
9. 神崎「でも、ディスパッチテーブルで整理したはずなんです。キーで分けてるし……」
10. ドクター「表面だけだ。 **中身は繋がっている**」
11. ナナコ「ディスパッチテーブルは住所録みたいなものです。誰がどこに住んでいるかは整理されていますけど、壁がない——全員が一つの大部屋で暮らしているんですよ」
12. 神崎、ここで統計脳が発動。「つまり……各変量の **独立性が確保されていない** ってことですか？」
13. ナナコが一瞬驚く。「……はい、まさにそういうことです」
14. ドクターが微かに頷く（ように見える）。

### ポイント
- 最初に「悪くない」と言うことで、ディスパッチテーブルの価値を認めつつ、本質的な問題を浮き彫りにする
- 神崎が **統計の言葉で** 問題の本質を言い当てる（独立性）→ 域知識の転用
- ドクターの「表面だけだ」は短いが、ディスパッチテーブルの限界を端的に表現

---

## III. 外科手術 (Surgery)

### シーンの方向性

ありきたり除外: 「ドクターが全部書き直す → 患者は見てるだけ」ではなく、**ドクターが骨格だけ書き、患者が統計の知識でアルゴリズム部分を自ら移植する**展開。統計アナリストとしての能力が「設計の理解」に転化する瞬間。

### シーン展開

1. ドクターが無言でコーディングを始める。まず `PredictionStrategy` ロール（interface）を定義。
2. ドクター「予想する。それだけだ」（ロールに `predict` メソッドだけを定義）
3. ナナコ「それぞれのアルゴリズムが、同じ約束事——`predict` メソッド——を持てばいいんです。中身は自由ですよ」
4. 神崎「あ……これ、統計で言う **推定量のインターフェース** と同じですね。推定方法は違っても、推定値を返すところは共通……」
5. ドクターが最初の具象クラス `TrackConditionStrategy` を書く。`$weight_cache` を自前で持つ。
6. ドクター「隔離完了」
7. ナナコ「各アルゴリズムが自分専用の冷蔵庫を持つようになりました。もう隣の人のおかずの味は変わりませんよ」
8. **ここで患者の手が動く**: 神崎が「これなら僕にもできます」と、2つ目のアルゴリズム `PastDataStrategy` を自分で書き始める。
9. ドクターが一瞬手を止めて、神崎のコードを見る。
10. ドクター「……使える」（短い評価）
11. 最後に `PredictionEngine`（Context）を作成。strategies を注入可能にする。
12. テスト実行。全アルゴリズムが独立して正しい結果を返す。馬場分析の的中率が70%に復帰。

### コード提示ポイント
- Before: `HorsePredictor.pm`（ディスパッチテーブル + クロージャ共有変数）
- After: `PredictionStrategy` ロール + `TrackConditionStrategy` 等の具象クラス + `PredictionEngine` コンテキスト
- Perl v5.36 の `signatures` を活用した簡潔な引数定義

---

## IV. 術後経過 (Prognosis)

### シーンの方向性

ありきたり除外: 「ありがとうございました → さようなら」の単純な締めではなく、**神崎が新しいアルゴリズムを即座にプラグインして見せる**ことで、Strategy パターンの真価（拡張の容易さ）を体感するシーン。

### シーン展開

1. 神崎が興奮して「今追加しようとしていた6つ目、パドック映像スコアのロジック——今すぐ試していいですか？」
2. ドクター「やってみろ」
3. 神崎が `PaddockScoreStrategy.pm` を新規作成。既存のファイルには一切触れない。
4. `PredictionEngine` に登録。テスト実行——全ロジック正常。
5. 神崎「一つも壊れない……！ 本当に独立してる……」
6. **勘違いシーン**: ドクターが帰り支度を始める。神崎のデスクにあったペンを手に取り、そっと胸ポケットに差し込む——実は自分のペンを回収しているだけ（診察中に無意識に置いていた）。
7. 神崎（語り）:「先生が僕のペンを……いや、自分のペンか。でも、あの無造作な動作に妙な温かみを感じたのは気のせいだろうか」
8. ナナコ「それ、先生のペンです。すみません、よく置き忘れるんです」（淡々と）
9. ドクターが玄関に向かう。振り返らずに一言。
10. ドクター「感謝は、このコードに」
11. 神崎が見送った後、デスクに戻ると、ターミナルに的中率のサマリが表示されている——そして、test coverage 100% の文字。
12. 神崎（語り）:「独立変数の重要性は、統計で嫌というほど学んだはずだった。なのに、自分のコードでは見落としていた。……結局、僕が一番基本的なことを忘れていたんだ」

### 勘違いチェックリスト
- [x] ドクターの行動は論理的か？ → 自分のペン回収という完全に合理的な行動
- [x] 患者の誤解は感情的か？ → 「温かみ」を感じるが、すぐに自己訂正
- [x] 助手の反応は適切か？ → 事実を淡々と伝えるだけ（否定も肯定もしない）

---

## 舞台設定整合性チェック

### 往診の場合

- [x] ドクターと助手が「来て」「帰る」側 → ドクターが帰り支度・玄関へ向かう
- [x] 患者は自分の場所に居る側 → 神崎の書斎のデスク・モニタ・本棚を使用
- [x] クリニック固有の小物は不使用 → O'Reilly本の壁やHHKBの描写なし
- [x] 退場シーンの主語 → ドクターが玄関を出る
- [x] 退場後のシーン → 神崎がデスクに戻る（自宅なので自然）
