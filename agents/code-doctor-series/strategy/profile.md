# Patient Profile: Strategy

## 基本情報

- **Name**: 神崎 遼一（かんざき りょういち）
- **Age**: 34歳
- **Role**: 元統計アナリスト → IT企業バックエンド担当（エンジニア歴2年）
- **First Person**: 「僕」
- **Personality**: 分析好き、理論派、穏やかだが数字の話になると早口になる。「まず仮説を立てて……」が口癖。

## 背景

大手シンクタンクで10年間、統計分析の専門家として活躍。Excel VBA とR でデータを回す毎日だった。2年前に「もっと手を動かしたい」と一念発起してIT企業に転職。Perl を独学で習得し、趣味の競馬予想を自動化するスクリプトを書き始めた。

統計モデルの理論は完璧。回帰分析もベイズ推定もお手のもの。しかし「ソフトウェアとして設計する」経験がゼロ。数式をそのままコードに書き下す癖があり、5種類の予想アルゴリズム（過去走データ重視、馬場状態重視、オッズ変動追跡、血統指数、騎手相性）がすべて1つの `.pl` ファイルに詰め込まれている。

「ハッシュのディスパッチテーブルで整理したからスッキリしてるはず」と自信を持っていたが、先月6つ目のアルゴリズム（パドック映像スコア）を追加した途端、既存の5つのロジックが不正な結果を返すようになった。

## 主訴

「新しい予想ロジックを追加したら、それまで的中率70%だった馬場分析が突然でたらめな数字を返すようになったんです。コードは整理してあるはずなのに……」

## コメディポテンシャル

- 説明のたびにホワイトボードに数式を書こうとする → ドクターが一言「コードを見せろ」
- 的中率のグラフを見せようとする → ドクターが興味を示さない → ナナコだけが「すごいですね！」と反応
- 統計用語とプログラミング用語を混同する：「このサブルーチンの分散が大きくて」「標本数が足りないんじゃなくて、テストケースの話です」
- 予想が当たった馬の名前を嬉しそうに報告するが、誰も聞いていない

---

# Medical Chart

## 症状 (Symptoms)

### Technical
- 5種類の予想アルゴリズムが1つのモジュール `HorsePredictor.pm` 内にフラットに存在
- hash ディスパッチテーブル `%strategies` で各アルゴリズムを匿名サブルーチンとして管理
- 匿名サブルーチンがクロージャとして外側の変数（`$weight_cache`, `@recent_results`）を共有参照
- 新アルゴリズム追加時にメインモジュール自体を修正する必要がある（OCP 違反）
- 6つ目のアルゴリズム追加時、共有変数の書き換えにより既存ロジックの計算結果が汚染された

### Medical Metaphor
「**潜伏性自己免疫疾患**」——患者（コードベース）は一見健康体。定期検診（テスト）でも異常は見つからない。しかし体内では臓器（アルゴリズム）同士が血管（共有変数）で不正に繋がっており、新しい臓器を移植（アルゴリズム追加）するたびに、免疫系（既存ロジック）が自分の体を攻撃する。

## 病名 (Diagnosis)

**潜伏性自己免疫疾患（クロージャ共有変数型）** —— 別名: Strategy 欠乏症

## 処方 (Prescription)

**Strategy パターンによる臓器分離手術**
1. 共有変数の血管（クロージャ参照）を切断
2. 各アルゴリズムを独立した臓器（Moo クラス + ロール）として移植
3. コンテキスト（`PredictionEngine`）を中枢神経として再構築
4. 各臓器の独立した血液検査（単体テスト）を実施

## タイトル案

**コードドクター【Strategy】潜伏性自己免疫疾患〜競馬予想エンジンの臓器分離術〜**
