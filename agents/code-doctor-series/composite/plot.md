# Plot Outline: Composite — 骨格溶解型フラット化症候群〜レシピツリーの再建術〜

## 舞台設定: 往診

タケルの自宅兼作業スペース（ワンルームのキッチン付き）。作業デスクの隣にガスコンロとまな板が並ぶカオスな空間。壁にはレシピメモの付箋が大量に貼られ、その横にモニターが1台。

---

## Scene 1: 往診 — 「料理人の911」

**状況**: 夜。タケルのワンルーム。デスクの上にラップトップ、その横に使い込んだ包丁立て。レシピ管理アプリの画面には赤いエラーメッセージ。タケルはバンダナを外して汗を拭き、テーブルに突っ伏している。

**展開**:
- インターホンが鳴る。バンダナを直して慌てて玄関を開けると、無表情の男とにこやかな女性が立っている。
- タケル：「どちら様ですか……ウーバーの配達の方？」（ドクターが手に持つ黒い鞄を出前の保温バッグと勝手に勘違い）
- ナナコ：「大丈夫ですよ、ここはコード診療所です……あ、いえ、往診ですね」と定番の自己紹介。
- ドクターはタケルの言葉を無視し、すでにモニターの前に座って画面を凝視している。
- タケル：（この人、勝手に人の家に上がり込んで……でも、あの目は料理長がフレッシュハーブの品質を見極める時と同じだ）

**ポイント**: ドクターの「不審者感」と、タケルが料理の世界に例えて理解しようとするクセを初手で提示。

---

## Scene 2: 触診 — 「フラットな臓器」

**展開**: ドクターがタケルのコードをスクロールしていく。画面には `@recipes` 配列、`$parent_id` による親子関係の手動管理、`ref()` チェックによる分岐。

**Interaction**:
- ドクター：（スクロールを止め、`@recipes` の配列定義を指差す）「……骨がない。」
- タケル：「骨？ いや、データは全部ここに入ってますよ！フラットにすれば管理しやすいかなって——」
- ドクター：（続けて `for my $r (@recipes) { if ($r->{parent_id} == ...) }` のループを指差す）「毎回……組み立て直してる。」
- ナナコ：「えっと、つまりですね。料理で言うと、毎回仕込みの材料を全部バラバラに冷蔵庫に放り込んで、作るたびに『あの玉ねぎはビーフシチューの? カレーの?』って仕分けし直している状態ですね」
- タケル：（顔が青ざめる）「……まさか俺、料理で言ったら下ごしらえを全否定してた？」
- ドクター：「診断。骨格溶解型フラット化症候群。」
- ナナコ：「本来はレシピの中にサブレシピが入って、それぞれが自分の材料を知っている——という構造が自然なんです。タケルさんの料理の段取りと同じですよ」

**ポイント**: 料理人のタケルだからこそ「フラット化の異常さ」が比喩でなく実体験として刺さる。ナナコの説明が料理の文脈と完全に一致する。

---

## Scene 3: 外科手術 — 「レシピツリーの再建」

**展開**: ドクターがリファクタリングを開始。タケルのモニターの前に座り、キーボードを叩き始める。

### 3-1: Before (解体映像)
- ドクターがBeforeコードを画面に表示。フラット配列・parent_idループ・ref()チェックの全景。
- タケル：「よく見ると……材料の集計だけで40行以上あるんだよな」
- ドクター：「冗長。」

### 3-2: 手術開始 (Compositeパターンの移植)
- ドクターが `RecipeComponent` ベースクラス（共通インターフェース）を作成。
- 次に `Ingredient`（Leaf: 単一材料）を実装。`calculate()` は自身の量を返すだけ。
- タケル：「え、これだけ？ 玉ねぎ1個みたいに、自分が何グラムか知ってるだけ？」
- ドクター：「それでいい。」

### 3-3: Compositeノードの構築
- `Recipe`（Composite: サブレシピも材料も持てるコンテナ）を実装。`calculate()` は子要素の合計を再帰的に集計。
- ナナコ：「"ビーフシチュー"というレシピが、"ルー作り"サブレシピと"牛肉"材料を同じように持てるんです。タケルさんが料理の段取りでやっていることと、構造的にはまったく同じですよ」
- タケル：（目を見開く）「待ってくれ。これって、俺が厨房で『この仕込みはビーフシチューに使う、こっちの仕込みはカレーに使う』って頭の中で管理してるのと同じ……！」
- ドクター：（無言で頷く）

### 3-4: After (術後確認)
- Afterコードの全景を表示。`$menu->calculate()` 一行で全材料の合計が出る。
- タケル：「40行が……1行？」
- ドクター：「再帰。」

**ポイント**: 料理人の段取り＝Compositeパターンという「気づき」の瞬間を劇的に演出。タケルが自分の料理経験から逆算して理解する流れ。

---

## Scene 4: 術後経過 — 「新しいレシピ」

**展開**: 手術完了後。タケルが新しいコードでサブレシピを追加してみる。

- タケル：「試しに『デミグラスソース作り』をサブレシピとして追加してみますね……`$stew->add($demiglace)`……で、`$stew->calculate()`……材料が正しく集計されてる！ しかもコード1行も変更してない！」
- ナナコ：「料理の世界では当たり前のことですよね。新しい仕込みを追加しても、他の工程は変わらないはずです」
- タケル：「当たり前……そうだよな。厨房じゃ当たり前だったんだ、ずっと」

**勘違いシーン**: 
- タケルが感謝のつもりで冷蔵庫からプリンを出して「先生、和菓子屋の要らないですか？ これ自家製の——」と差し出す。
- ドクターがプリンを受け取り、一口食べて微かに目を見開く。そしてタケルの顔をじっと見る。
- タケル：（この沈黙……まさか俺の料理の腕を認めてくれたのか？ 転職しても料理人としての誇りは——）
- ナナコ：（落ち着いた声で）「先生は甘いものが好きなだけですよ」
- ドクターは何も言わず、もう一口食べている。

**Closing**:
- ドクターが帰り支度を始める。玄関で振り返り、
- ドクター：「感謝は、このコードに。」
- タケル：「先生……俺、厨房で10年やってきたことをコードで再現できるって、今日初めてわかりました。テスト書きますよ。誓って」
- ドクターは小さく頷き、鞄を持ち上げてドアを出る。
- ナナコ：「タケルさん、料理の腕前をコードに活かせるエンジニアって、きっとすごく強いですよ。いつでもご連絡くださいね」
- タケルは閉まったドアをしばらく見つめた後、モニターに向き直って `$menu->display_tree()` を実行する。画面に表示されたレシピのツリー構造は、タケルが厨房で頭の中に描いていた段取り表と、まったく同じ形をしていた。

---

## 舞台設定チェックリスト（往診）

- [x] ドクターと助手が「来て」「帰る」側 → ✅ ドクターが帰り支度をし、ドアを出る
- [x] 患者は自分の場所に居る側 → ✅ タケルの自宅ワンルーム
- [x] クリニック固有の小物なし → ✅ O'Reillyの壁等は使用していない
- [x] 患者の所有物は自然に存在 → ✅ モニター、付箋、包丁立て、冷蔵庫
- [x] 退場は「ドクター側」→ ✅ ドクターが鞄を持ち上げドアを出る

## 勘違いシーンチェックリスト

- [x] ドクターの行動は論理的か → ✅ 甘いものが好きなだけ（自然な行動）
- [x] 患者の誤解は感情的か → ✅ 「料理人としての誇りを認めてくれた」と錯覚
- [x] 助手の反応は適切か → ✅ 否定も肯定もせず事実を述べるだけ
