# Input Design: Composite

## Step-Back: この記事で読者に何を持ち帰ってもらいたいか

**「ツリー構造を扱うとき、葉と枝を同一のインターフェースで操作できるようにする設計」** — Compositeパターンの本質は「部分と全体の同一視」。読者が自分のコードにある「ツリー構造を `if` 分岐で無理に処理している」場面を認識し、再帰的な統一操作へのリファクタリングを学ぶこと。

> **差別化ポイント**: 統合記事（Interpreter×Visitor×Composite: 正規表現リファインリー）ではCompositeは脇役。本記事ではComposite単体の本質に焦点を当てる。

---

## テーマ3案

### 案A（王道）: 組織の権限管理システム

- **テーマ名**: 企業の部署・チーム・個人の権限階層管理
- **一行説明**: 部署→チーム→個人という階層構造で、権限チェックや所属人数の集計を行うシステム
- **パターンとの接点**: 組織階層はツリー構造の典型例。「部署の権限 = 配下全員の権限の集約」を再帰的に処理する必要がある
- **読者像**: 社内システム開発者、業務アプリケーションエンジニア

### 案B（革新）: レシピの材料計算機

- **テーマ名**: レシピのネスト構成（下ごしらえ・ソース・完成品）の材料集計
- **一行説明**: レシピが別のサブレシピを含む構造（例：「カレー」=「ルー作り」+「ご飯炊き」+「盛り付け」）で、総材料をツリーから再帰的に集計
- **パターンとの接点**: サブレシピ（Composite）と単一材料（Leaf）を同一インターフェースで扱い、何人前でも材料を自動計算
- **読者像**: 個人開発好きなエンジニア、料理好きプログラマ

### 案C（逆転）: ファイルサイズ可視化ツール

- **テーマ名**: ディスク使用量をディレクトリツリーから再帰集計するCLIツール
- **一行説明**: `du` コマンドのような、ディレクトリ・ファイルのサイズ集計ツール。ファイル（Leaf）とディレクトリ（Composite）を同一に扱う
- **パターンとの接点**: ファイルシステムはCompositeの最も直感的な例。しかし「全員知っているはずなのに正しく設計しない」逆説が面白い
- **読者像**: インフラ寄りエンジニア、CLIツール開発者

---

## 患者3案

### 案A（王道・共感型）: 若手Webエンジニア（2年目）

- **属性**: 25歳、Webアプリエンジニア、エンジニア歴2年
- **性格キーワード**: 素直、真面目、ちょっと自信過剰
- **背景**: ECサイトの商品カテゴリ管理を任された。フラットな配列で全カテゴリを管理し、親子関係はIDで手動辿り
- **主訴**: 「カテゴリの階層が深くなるたびにコードが壊れるんです。3階層までは動いてたのに、4階層目を追加したら集計がおかしくなって……」
- **コメディポテンシャル**: 「フラットが一番シンプルですよ！」と主張するが、コードはif文の地獄。ドクターに「フラット……？」と一言で切られる

### 案B（革新・意外型）: ベテランDBAエンジニア（15年目）

- **属性**: 40歳、DBA兼バックエンドエンジニア、エンジニア歴15年
- **性格キーワード**: 職人肌、頑固、RDB至上主義
- **背景**: RDBの隣接リストで組織図を管理。SQLの再帰CTEは使いこなすが、アプリケーション層のオブジェクト設計には無頓着。「DBが正なんだからアプリは単純にSELECTすりゃいい」
- **主訴**: 「SQLでやれば一発なのに、フロントチームが『もっと使いやすいAPIくれ』って言うんです。何が不満なんですかね」
- **コメディポテンシャル**: SQL芸を自慢するが、アプリ側のコードは型なし連想配列の塊。「正規化は完璧です！」と言いながらアプリコードは非正規化の極み

### 案C（逆転・ギャップ型）: 元料理人転職エンジニア（1年目）

- **属性**: 32歳、元料理人→プログラミングスクール経由で転職、エンジニア歴1年
- **性格キーワード**: 情熱的、段取り力は天才的、抽象化が苦手
- **背景**: 料理のレシピ管理アプリを個人開発。料理の段取り（下ごしらえ→調理→盛り付け）は完璧に組み立てられるが、それをコードの構造として表現できない
- **主訴**: 「料理なら何品でも同時に段取り組めるのに、コードだとレシピが増えるたびにスパゲッティになるんです……」
- **コメディポテンシャル**: 料理の比喩を多用するが全部正しい。ドクターが無表情で頷き、助手が「今の例え、技術的にも正確です」と驚く。料理の段取り＝ツリー構造という気づきの瞬間

---

## 症状3案

### 案A（王道・典型症状）: 深さ別ハードコード地獄

- **技術的症状**: ツリー構造の各階層に対して `if ($depth == 1) {...} elsif ($depth == 2) {...}` と深さ別に処理を分岐。階層追加のたびにif文が増殖
- **医療メタファー**: 「階層硬直性関節炎」— 各関節（階層）が独立に固まってしまい、連動して動かない
- **重症度**: 中症
- **Before/Afterの見込み**: Before: 深さ4までの個別処理×集計・表示・検索で12分岐 → After: 再帰的な `calculate()` メソッド1つに統一
- **読者の「あっ」ポイント**: 「あ、自分もネストしたJSONの処理で同じことやってた……」

### 案B（革新・複合症状）: 型チェック依存症候群

- **技術的症状**: `ref($node) eq 'HASH'` でCompositeかLeafか判定し、判定結果に応じて異なるロジックを呼び出す。`blessed` チェックも混在し、ポリモーフィズムが崩壊
- **医療メタファー**: 「自己免疫型識別障害」— 自分が何者か（Leaf/Composite）を外部から毎回診断され、自律的に振る舞えない
- **重症度**: 重症
- **Before/Afterの見込み**: Before: 型チェック+分岐が全操作に散在 → After: 共通インターフェースによるポリモーフィック呼び出し
- **読者の「あっ」ポイント**: 「`instanceof` チェックをやめろと言われる理由ってこういうことか」

### 案C（逆転・潜伏症状）: 擬似再帰フラット化症

- **技術的症状**: ツリー構造を一度フラットな配列に展開してから処理。再帰を避けるために `$parent_id` でリレーションを持ち、毎回ループでツリーを再構築する
- **医療メタファー**: 「骨格溶解症候群」— 本来の骨格（ツリー構造）が溶けてフラットになり、毎回外部から骨を組み立て直している
- **重症度**: 中症〜重症（階層変更時に爆発）
- **Before/Afterの見込み**: Before: フラット配列+parent_idループ+手動再構築 → After: ツリー構造をオブジェクトとして保持し、再帰的に操作
- **読者の「あっ」ポイント**: 「RDBの隣接リストをそのままアプリ層に持ってきてる……自分もやってた」

---

## 多角的評価

### テーマ評価

| 評価軸 | 案A（王道: 権限管理） | 案B（革新: レシピ） | 案C（逆転: ファイルサイズ） |
|--------|:---:|:---:|:---:|
| ① 読者共感度 | 4 | 3 | 5 |
| ② メタファー適合度 | 3 | 4 | 4 |
| ③ コメディ発展性 | 2 | 4 | 3 |
| ④ 教育価値 | 4 | 4 | 4 |
| ⑤ 差別化 | 2 | 4 | 3 |
| **合計** | **15** | **19** | **19** |

### 患者評価

| 評価軸 | 案A（王道: 若手Web） | 案B（革新: ベテランDBA） | 案C（逆転: 元料理人） |
|--------|:---:|:---:|:---:|
| ① 読者共感度 | 4 | 3 | 4 |
| ② メタファー適合度 | 3 | 3 | 5 |
| ③ コメディ発展性 | 3 | 4 | 5 |
| ④ 教育価値 | 4 | 4 | 4 |
| ⑤ 差別化 | 2 | 4 | 5 |
| **合計** | **16** | **18** | **23** |

### 症状評価

| 評価軸 | 案A（王道: 深さ別分岐） | 案B（革新: 型チェック） | 案C（逆転: フラット化） |
|--------|:---:|:---:|:---:|
| ① 読者共感度 | 4 | 3 | 5 |
| ② メタファー適合度 | 4 | 5 | 5 |
| ③ コメディ発展性 | 3 | 3 | 4 |
| ④ 教育価値 | 4 | 5 | 4 |
| ⑤ 差別化 | 3 | 4 | 4 |
| **合計** | **18** | **20** | **22** |

---

## 相乗効果の検討

### 最高スコア組合せ: テーマB（レシピ）× 患者C（元料理人）× 症状C（フラット化）

- **テーマ × 患者**: ✅ 元料理人がレシピ管理アプリを作るのは極めて自然。「料理の段取りは完璧だが、コード構造に落とせない」という設定がピッタリ
- **テーマ × 症状**: ✅ レシピのネスト構造（サブレシピ）をフラットな配列にして管理しようとし、材料集計がバグるシナリオはリアル
- **患者 × 症状**: ✅ 料理の世界では「段取り＝ツリー構造」を無意識にやっているのに、コードではフラット化してしまう皮肉が効く

**整合性判定**: 🟢 3要素の相乗効果が極めて高い

### 次点組合せ: テーマC（ファイルサイズ）× 患者B（ベテランDBA）× 症状C（フラット化）

- **テーマ × 患者**: ⚠️ DBAがファイルサイズツールを作る動機がやや弱い
- **テーマ × 症状**: ✅ ディレクトリ構造をフラット化するのは自然
- **患者 × 症状**: ✅ RDB脳でフラット化するのは説得力あり

**整合性判定**: 🟡 テーマと患者の接点がやや弱い

---

## 選定結果

### 採用案
- **テーマ**: 案B「レシピの材料計算機」（革新・19点）
- **患者**: 案C「元料理人転職エンジニア」（逆転・23点）
- **症状**: 案C「擬似再帰フラット化症」（逆転・22点）
- **総合スコア**: 64/75

### 選定理由
テーマの親しみやすさ（レシピ）と患者の独自性（元料理人）が絶妙に噛み合い、「料理の段取りは天才なのにコードでは同じことができない」という皮肉がCompositeパターンの本質（ツリー構造の統一操作）を浮き彫りにする。症状の「フラット化」は読者にとって身近な失敗パターンであり、「あ、自分もやってた」の再現性が高い。

### 3要素の整合性
- テーマ × 患者: ✅ 元料理人がレシピ管理アプリを個人開発するのは極めて自然
- テーマ × 症状: ✅ レシピのネスト構造（下ごしらえ→ソース→完成品）をフラット配列にして壊れるのはリアル
- 患者 × 症状: ✅ 料理では無意識にツリー構造を組み立てているのに、コードではフラット化してしまう皮肉

## 不採用案（参考）

### テーマ
- 案A「権限管理」（15点）: 教育的だが差別化が弱くコメディ発展性に欠ける
- 案C「ファイルサイズ」（19点）: 同スコアだが患者との相乗効果でBに劣る

### 患者
- 案A「若手Webエンジニア」（16点）: 既存シリーズ（Singleton, Builderなど）で若手主人公が多く差別化困難
- 案B「ベテランDBA」（18点）: 面白いが採用テーマ（レシピ）との接点が弱い

### 症状
- 案A「深さ別分岐」（18点）: わかりやすいが教科書的すぎて記憶に残らない
- 案B「型チェック依存」（20点）: 教育価値は高いがComposite特有感がやや弱い
