# Plot Architecture: Command Pattern

## I. 導入 (Admission)
- **状況**: 深夜、焦燥しきった血走った目の男（インフラエンジニア）が、ノートPCを抱えて「コード診療所」の重厚な鉄の扉を力強く**引いて**入ってくる。
- **感情**: 疲弊と絶望。「本番環境を壊しかけた……」という恐怖。
- **Action**: 薄暗い診察室。O'Reillyの壁の奥で、ドクターはトリプルディスプレイの青白い光に照らされながら無言でキーボードを叩いている。一瞥もくれないが、助手のナナコが穏やかにカルテを差し出す。

## II. 検査 (Examination)
- **展開**: 患者のノートPCを開き、自作のデプロイ用Perlスクリプトを表示する。画面を埋め尽くす `system()` コマンド呼び出しと、肥大化したエラーハンドリングの `if` 文の嵐。
- **Interaction**:
  - ドクター: ソースコードを一瞥し、低く呟く。「……不可逆細胞、無秩序増殖。」
  - ナナコ: （患者に微笑んで）「システムの状態を直接書き換える処理が垂れ流しになっており、元の状態に戻すための自己修復機能が欠落しているとおっしゃっています」
  - 患者: 「インフラなんだから、コマンド叩いたら状態が変わるのは当たり前だろ！ 途中でコケたら、気合いで手作業で戻すしかないんだよ！ オブジェクト指向なんていう回りくどい黒魔術を使う暇は俺にはねえ！」

## III. 処置 (Surgery)
- **展開**: ドクターがキーボードを引き寄せる。リファクタリング（手術）の開始。
- **Highlight**:
  1. **Bad Codeの提示**: 巨大なサブルーチンの中で `system("systemctl restart nginx")` などを直接実行し、失敗時の巻き戻し手順が場当たり的に書かれている手続き型のコード。
  2. **設計の転換**: 「処理（命令）そのものをオブジェクトの『カプセル』に閉じ込める」というCommandパターンの真髄を提示。
  3. **Good Codeへの変化**:
     - `execute()` と `undo()` を持つ `Command` ロールのベースクラスを作成。
     - 具体的な処理（Webサーバー再起動、DBマイグレーション等）をサブクラス化。
     - 命令のリスト（スタック）を保持する `Invoker` を作り、次々に詰めてから順々に `execute()`。
     - エラー発生時、スタックから逆順に `undo()` を呼び出し、安全かつ自動で元の状態へ戻すメカニズム。
- **カタルシス**: 
  - 患者：「『操作』をモノ（オブジェクト）にして配列に入れておけば……後から取り出して逆再生できるのか……！？ 俺は今まで、何時間かけて手作業でロールバックしてたんだ……っ！」

## IV. 予後 (Prognosis)
- **展開**: モック環境での安全なロールバックテストを確認。完全に元の状態へ戻ったログを見て、患者が安堵の息を漏らす。
- **Comedy（勘違いシーン）**:
  - ドクターが突然立ち上がり、患者の肩のあたりに向かってスッと腕を伸ばす。
  - 患者：「（ドクター……。そうか、『もう一人でインフラの全責任を抱え込むな』と、俺の肩を……温かいヤツだ……）」と感動して目を潤ませる。
  - 実際：ドクターは患者の背後にあるルーターの抜けかけたLANケーブルを挿し直し「……リンク・アップ」と呟く。
  - ナナコ：（無言でアクセスランプの点灯を確認し、お茶を片付ける）
- **Closing**: 患者はノートPCを鞄にしまい、充実した足取りで外開きの扉を**押して**退室する。「黒魔術、悪くねえな。さっそく明日のデプロイツールを書き直してやるぜ！」
