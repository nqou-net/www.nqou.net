# Patient Profile: Proxy

## 患者情報

- **Name**: 矢嶋 隼人（やじま はやと）
- **Age**: 29歳
- **Role**: 中堅SIer バックエンド開発者（エンジニア歴6年）
- **Personality**: 即断即決、せっかち、スピード至上主義。口癖は「遅いコードは悪」。YAGNI原理主義で「必要になるまで作らない」を盾に中間層の設計を拒否する。ベンチマーク結果をSlackに貼るのが趣味。
- **First Person**: 「俺」

## 背景

社内ダッシュボードシステムのバックエンドを一人で担当。当初10人程度の利用者だったダッシュボードが、経営層の目に留まり全社展開（200人超）が決定。

「ORMなんてオーバーヘッド。SQL直書きが最速」が信条で、あらゆるDB呼び出しをDBI経由の生SQLで直接実行。1クエリ単位のベンチマークでは確かに高速だが、同じデータを複数のAPI関数から独立にフェッチするため、ページ1回表示で同一クエリが5〜8回発行される状況。

さらに外部の為替レートAPI（社内レポート用）もエンドポイントごとに直接HTTP GETしており、レートリミットに引っかかり始めている。

## 主訴

「俺のコード、1クエリ単位では社内最速なはずなのに、ページ全体が遅いんだ。DBサーバのスペックが足りないんじゃないか？ インフラに増強申請出したら却下されて、なぜかコードを見直せって言われた。意味わかんねえよ。」

## コメディポテンシャル

- ベンチマーク結果を自慢するが、同じクエリが何回走ってるか聞かれると「は？」となる
- ドクターの「遅い。」の一言にブチ切れそうになる（「俺のSQL見てから言えよ！」）
- マイクロ秒単位のチューニングにこだわる一方で、同一クエリの重複実行という巨大な無駄に無自覚
- ナナコの比喩を「的外れ」と一蹴しようとするが、後から「…あっ」となる

---

# Medical Chart: Proxy

## 症状（Symptoms）

### Technical
- `$dbh->do("SELECT ...")` / `$ua->get(...)` がコード全体に散乱（30箇所以上）
- 同一データを複数関数から独立にフェッチ（1ページ表示で同一クエリ5〜8回発行）
- 外部APIの呼び出しが関数内にハードコード、レートリミット未考慮
- エラーハンドリングが呼び出し元ごとに重複（retry/timeout が10箇所にコピペ）
- テスト時に実DBと実APIに接続が必要（モック不可能）

### Medical
**代謝バイパス欠損症（Metabolic Bypass Deficiency Syndrome）**

栄養（データ）を消化器官（中間層）を経由せず直接血管（ビジネスロジック）に注入している状態。消化器官が退化（不在）しているため：
- 同じ栄養素を何度も取り込む（重複クエリ）
- 毒素の濾過ができない（エラーハンドリング散乱）
- 食べたものの記録がない（キャッシュ不在）
- 解毒テストができない（テスト不能）

## 病名（Diagnosis）

**代謝バイパス欠損症** — 中間層（Proxy）の欠損により、データアクセスの制御・最適化が機能していない

## 処方（Prescription）

**Proxy Pattern による代謝系の再構築**

1. **DatabaseProxy**: DB接続を代理し、クエリキャッシュ・ロギングを一元管理
2. **ApiProxy**: 外部API呼び出しを代理し、レートリミット管理・リトライ・キャッシュを集約
3. **テスト用MockProxy**: 本物のDB/APIと同じインターフェースで、テスト時に差し替え可能

治療効果:
- 重複クエリの自動排除（キャッシュヒット）
- エラーハンドリングの一元化
- レートリミット対応の自動化
- テスト時のモック差し替えが容易に
