# Plot Outline: Proxy — 代謝バイパス欠損症

## 舞台設定: 往診

矢嶋のオフィス（中堅SIerのフロア）に往診。理由: DBサーバの負荷状況を現場で見る必要がある。

---

## Scene 1: 往診（導入）

### 状況
金曜日の夕方。矢嶋は自席で `EXPLAIN ANALYZE` の結果を睨んでいる。モニタには彼の自信作——社内ダッシュボードのベンチマーク結果がSlackに貼られたままだ。「1クエリ0.3ms」のスクリーンショットに「いいね」が3つ。

突然、フロアの入口に見知らぬ二人が立っている。白衣の男と、ビジネスカジュアルの女性。

矢嶋「……どちら様ですか？」

ナナコが定番の自己紹介。ドクターは無言で矢嶋のモニタを見ている。

矢嶋（内心: なんだこの不審者。つーか勝手に人のモニタ見んなよ）

ドクターが一言。「遅い。」

矢嶋、ブチ切れかける。「はあ！？ 0.3msのクエリのどこが遅いんすか！？」

ドクターは矢嶋のモニタではなく、隣のサーバ監視画面を指差している。CPU使用率が張り付いたグラフ。

### 感情
矢嶋: 怒り → 困惑。自分のクエリは完璧だという自負が揺らぐ最初の瞬間。

---

## Scene 2: 触診（検査）

### 展開
ドクターが矢嶋のコードリポジトリを開く。grep で `$dbh->` を検索。ヒット数: 47件。

ドクター: 「47回。」（指でモニタを弾く）

矢嶋: 「そりゃDB使ってんだから当然だろ」

ドクターが無言で、1つのHTTPリクエストで発行されるSQLクエリ数をカウントするワンライナーを打ち込む。結果: **同一の `SELECT * FROM exchange_rates` が1リクエストで6回実行**。

矢嶋: 「……は？」

ナナコ: 「矢嶋さん、たとえるなら——毎食ごとにスーパーまで買い物に行っているような状態ですね。冷蔵庫（キャッシュ）がないので、朝・昼・晩、同じ牛乳を3回買いに行っている。1回の買い物は速いですけど、移動時間の合計が問題なんです。」

矢嶋: 「いや、それは……個別の関数で独立してデータを取得してるだけで……」

ドクター: 「独立。問題はここだ。」

矢嶋、反論しようとするが、`grep` の結果を見て言葉を失う。`get_exchange_rate()` が5つの異なるモジュールに**コピペ**されている。

### 診断名の宣告
ドクター: 「代謝バイパス欠損。」

ナナコ: 「栄養——つまりデータを、消化器官を通さず直接血管に流し込んでいる状態です。消化器官がないので、同じ栄養を何度も取り込んでしまいます。毒素……エラーの濾過もできません。」

---

## Scene 3: 外科手術（処置）

### 展開

ドクターが黙ってエディタに向かう。矢嶋は「勝手に触んな」と言いたいが、先ほどの47回が頭をよぎって言えない。

**Phase 1: Subjectインターフェースの定義**
ドクターが最初に書くのは、DBアクセスの「窓口」を定義するモジュール。矢嶋は「それ、俺が直接DBH使ってた処理と同じじゃん」と内心つぶやく。

**Phase 2: RealSubject（本物のDB処理）**
既存の生SQLを整理して1つのモジュールにまとめる。矢嶋「……結局やってることは同じだろ？」

**Phase 3: Proxy（代理層）の挿入 — ここが山場**

ドクターがキャッシュ付きProxyを書く。矢嶋が画面を凝視する。

矢嶋: 「待って。これ……同じキーで2回呼んだら、2回目はDBに行かないってことか？」

ナナコ: 「そうですよ。冷蔵庫の完成です。一度買った牛乳は、次は冷蔵庫から取るだけです。」

矢嶋: 「…………」（自分のコードで同一クエリが6回走っていたことを思い出している）

**Phase 4: 外部API用Proxy**

続いてドクターが外部API用のProxyを書く。レートリミット管理、リトライ、キャッシュを一箇所に集約。

矢嶋: 「あ、テスト……これ、このProxy差し替えたらDBなしでテスト回せるのか？」

ドクター: 「……。」（小さく頷く）

ナナコ: 「テスト用のModelProxy——偽物の消化器官を差し込むということですね。本物の食べ物を使わなくても、消化の流れが正しいか確認できます。」

矢嶋、初めてドクターの技術力を認める表情になる。

---

## Scene 4: 勘違いシーン（コメディ）

### タイミング: 手術中の休憩

ドクターがコーディング中、ふとキーボードから手を離し、矢嶋のデスクに置かれた缶コーヒーを見る。缶コーヒーは2本ある。

ドクターは1本を取り……自分で開けて飲む。

矢嶋: 「（えっ、俺の缶コーヒー……まあいいけど）」

ナナコがすかさず自販機に走り、代わりの缶コーヒーを矢嶋のデスクに置く。

ドクター、それを見て満足げに頷く。（ナナコが自分のために買ってきてくれたと思っている）

矢嶋: 「（……なんだこの空間）」

ナナコ: （矢嶋に小声で）「すみません、いつものことなんです。」

---

## Scene 5: 術後経過（予後）

### 展開

Before/Afterの対比。ドクターが改修したダッシュボードを起動する。

矢嶋がサーバ監視画面を見る。CPU使用率のグラフが——壁に張り付いていた線が、崖のように落ちている。

矢嶋: 「……嘘だろ。」

ナナコ: 「DBへの問い合わせ回数、ページ表示1回あたり6回から1回に減っています。キャッシュヒット率は83%ですね。」

矢嶋: 「速い……いや、これ、1クエリの速度は変わってないよな？」

ドクター: 「変えてない。」

矢嶋: 「なのに全体が……」

ドクター: 「無駄を省いた。それだけだ。」

ナナコ: 「マラソンランナーが速くなったんじゃなくて、同じコースを6周走っていたのを1周にしたようなものですね。」

矢嶋、自分のベンチマーク至上主義を振り返る。1クエリの速さにこだわっていたが、本当の速さは「不要な処理をしないこと」だった。

### 退場

ドクターが静かに鞄を持ち上げる。矢嶋は立ち上がって頭を下げる。

矢嶋: 「……ありがとうございました。」

ドクター: 「感謝は、このコードに。」

矢嶋: 「あ、テスト書きます。つーか書かないとダメですよね、この構造なら。」

ナナコ: 「ぜひ。テスト用のMockProxyを使えば、外部サービスが落ちていてもテストは回りますから。」

ドクターと助手がフロアを出ていく。矢嶋、自席に戻り、テストコードを書き始める。

矢嶋（独白）: 「速さは正義だ。でも、速さの意味を俺は勘違いしていた。マイクロ秒を削ること じゃなく、無駄を消すこと。代理（Proxy）ってのは……俺のコードに足りなかった消化器官だったんだ。」

---

## 舞台設定チェック（往診）

- [x] ドクターと助手が「来て」「帰る」側
- [x] 患者は自分の場所に居る側（自席・デスク・モニタ使用可）
- [x] クリニック固有の小物なし
- [x] 退場はドクター側（鞄を持ち上げる→フロアを出ていく）
- [x] 患者の缶コーヒーなど、オフィスの小物を使用

## 勘違いシーンチェック

- [x] ドクターの行動は論理的か → 缶コーヒーを勝手に飲む（ドクターの無頓着さ）
- [x] 患者の困惑は自然か → 勝手に缶コーヒーを取られた戸惑い
- [x] 助手の反応は適切か → 代わりを買いに行く世話焼き。ドクターは自分のためだと誤解。スルーして対処
