# Input Design: Flyweight

## 基本情報

- **デザインパターン**: Flyweight
- **Slug**: `flyweight`
- **技術的制約**: Perl v5.36以降、signatures・postfix dereferenceサポート必須
- **公開日時**: 2026-02-19T07:07:05+09:00
- **既存シリーズ差別化**: ASCIIアート・フォントレンダラー（統合版、Flyweight×Prototype×Abstract Factory）が存在。フォント/文字描画以外の切り口を採用する。

---

## Step 1: テーマ3案

### 案A（王道）: ゲームのマップタイル描画

- **テーマ名**: 2Dゲームのマップタイルシステム
- **一行説明**: RPGのようなタイルベースマップで、同種の地形タイル（草原・森・水など）が大量に配置される場面
- **パターンとの接点**: 100×100のマップで10,000個のタイルオブジェクトを生成するとメモリが爆発。タイルの画像・属性（通行可否等）はIntrinsic State、座標はExtrinsic Stateとして分離できる
- **読者像**: ゲーム開発に興味がある初〜中級エンジニア

### 案B（革新）: ログ解析レポートのフォーマッタ

- **テーマ名**: 大量ログエントリのスタイル付き出力
- **一行説明**: 数十万行のアクセスログをHTML/テキストレポートにフォーマットする際、同一タイプのログに同じフォーマットスタイルを適用する
- **パターンとの接点**: ログレベル別のフォーマッタ（色、プレフィックス、テンプレート）はIntrinsic State。タイムスタンプ・メッセージ内容はExtrinsic State。フォーマッタを共有しないと数十万個のオブジェクトが生成される
- **読者像**: 運用・インフラ寄りのエンジニア、ログ分析を日常的に行う開発者

### 案C（逆転）: 居酒屋の注文管理システム

- **テーマ名**: 居酒屋チェーンの注文伝票システム
- **一行説明**: メニュー品目（名前、価格、カロリー、画像パス）を注文テーブルごとに複製して管理していたシステム
- **パターンとの接点**: 「生ビール」は全テーブルで同一のマスターデータ。テーブル番号・数量・注文時刻だけがExtrinsic State。50テーブル×各20品の注文で1,000個の同一メニューオブジェクトが重複生成される。一見正しく動いているが、メモリが肥大化し、メニュー価格変更時に全伝票を走査しなければならない
- **読者像**: Webアプリ・業務システム開発者。飲食バイト経験者には特に刺さる

---

## Step 2: 患者3案

### 案A（王道・共感型）: 入社2年目のWebエンジニア

- **属性**: 24歳、Webアプリケーション開発者、エンジニア歴1.5年
- **性格キーワード**: 真面目、素直、心配性
- **背景**: 初の大規模案件でPerlシステムを担当。先輩のコードを参考にしながらオブジェクト指向で書いているが、設計パターンの知識は薄い
- **主訴**: 「テストは全部通るんですけど、本番でメモリ使用量が右肩上がりで……再起動しないと落ちるんです」
- **コメディポテンシャル**: 「オブジェクト指向をちゃんと使ってます！」と胸を張るが、実は全部コピペオブジェクト。「再利用」の意味を根本的に勘違い

### 案B（革新・意外型）: 7年目のフルスタックエンジニア

- **属性**: 31歳、テックリード、エンジニア歴7年
- **性格キーワード**: 几帳面、完璧主義、理屈っぽい
- **背景**: 「イミュータブルで副作用のないコードを書くべき」を信条にしており、あらゆるオブジェクトをnewで生成し、参照を共有しない方針を貫いている
- **主訴**: 「設計としては完璧なはずなのに、なぜかCPUとメモリが異常なんです。バグはないのに……」
- **コメディポテンシャル**: 「共有は悪」という信念が強すぎて、同一の定数データまで毎回コピーしている。「それはイミュータブルの精神に反します！」と共有化を拒否する場面。自分が正しいと信じているから余計にこじれる

### 案C（逆転・ギャップ型）: 飲食店経営者兼プログラマー

- **属性**: 38歳、居酒屋チェーン3店舗オーナー兼社内システム担当、独学プログラマー歴5年
- **性格キーワード**: 豪快、コスト意識が鋭い、ITには大雑把
- **背景**: 「外注に頼むと高いから」と自作した注文管理システム。店舗の経営では原価率やロスに厳しいのに、コードではメモリを湯水のように使っている
- **主訴**: 「金曜の夜になると注文システムが重くなって、レジが固まるんだよ。週末商売なのに勘弁してくれよ……」
- **コメディポテンシャル**: コスト管理の鬼なのにメモリコストには無頓着。「原価率は28%に抑えてるんだ」と自慢するが、メモリ使用率は280%。ドクターが「原価率と同じだ。共有できるものは共有する」と言うと、突然理解が早い

---

## Step 3: 症状3案

### 案A（王道・典型症状）: 同一データの大量重複オブジェクト

- **技術的症状**: 同一のマスターデータ（メニュー名、価格、属性等）を持つオブジェクトが利用箇所ごとにnewされ、数百〜数千個の同一内容オブジェクトがメモリ上に存在する
- **医療メタファー**: **クローン増殖症候群** — 同一のDNAを持つ細胞が際限なく分裂し、体内リソースを圧迫する
- **重症度**: 中症（機能は正常に動作するが、負荷時にメモリ不足で障害発生）
- **Before/Afterの見込み**: Before: 1,000個の同一オブジェクト → After: マスター10個 + 参照1,000個。メモリ使用量90%以上削減
- **読者の「あっ」ポイント**: 「自分も似たような構造を作ったことがある……」。特にDB取得結果をそのままオブジェクトに変換している場合

### 案B（革新・複合症状）: 重複オブジェクト + 更新不整合 + GC負荷

- **技術的症状**: 重複オブジェクトが大量生成され、さらにマスターデータ変更時に全オブジェクトを走査して更新する処理が必要。加えて短命オブジェクトが大量生成・破棄されGCの負荷も増大
- **医療メタファー**: **多臓器不全型メモリ肥大症** — 一つの臓器（メモリ）の肥大が循環器（GC）と神経系（一貫性管理）にも波及
- **重症度**: 重症（メモリリーク、データ不整合、パフォーマンス劣化の三重苦）
- **Before/Afterの見込み**: Before: メモリ肥大・データ不整合・GCストーム → After: 共有プールで一元管理、変更は1箇所で完結、GC対象激減
- **読者の「あっ」ポイント**: 「え、マスターデータ変更したらループで全部書き換えてるの、まずかったの？」

### 案C（逆転・潜伏症状）: 正常に見えるが拡張時に爆発する時限爆弾

- **技術的症状**: 少量データでは問題なく動作するが、データ種別やトランザクション量が増えるとオブジェクト数が2乗的に増加する設計。テスト環境では発覚せず、本番投入後に初めて症状が出る
- **医療メタファー**: **潜伏型メモリ動脈硬化** — 普段は無症状だが、負荷がかかった瞬間に血管（メモリ）が詰まる。健康診断（テスト）では発見できない
- **重症度**: 軽症（現時点では）→ 本番投入後は重症に急変
- **Before/Afterの見込み**: Before: テスト環境では問題なし、本番で突然クラッシュ → After: Flyweightプールにより線形スケーリング
- **読者の「あっ」ポイント**: 「テスト通ってるから大丈夫」と思っていたのに本番で死ぬ、あの恐怖

---

## Step 4: 多角的評価

### Step-Back思考

**この記事で読者に持ち帰ってもらいたいこと**:
1. 「同じデータの共有」はイミュータブルなデータなら安全で、メモリ効率に直結すること
2. Intrinsic State（共通・不変）とExtrinsic State（個別・可変）の分離基準
3. Flyweightファクトリ/プールの実装パターン
4. 「コピー＝安全」という思い込みを解くこと

### テーマ評価

| 評価軸 | 案A（王道）ゲームマップ | 案B（革新）ログ解析 | 案C（逆転）居酒屋注文 |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 3 | 3 | 5 |
| ② メタファー適合度 | 3 | 3 | 5 |
| ③ コメディ発展性 | 2 | 2 | 5 |
| ④ 教育価値 | 4 | 4 | 4 |
| ⑤ 差別化 | 2 | 3 | 5 |
| **合計** | **14** | **15** | **24** |
| **推奨理由** | 定番だが既視感 | 地味でコメディ弱 | 身近×コメディ抜群 |

### 患者評価

| 評価軸 | 案A（王道）新人Web | 案B（革新）完璧主義TL | 案C（逆転）居酒屋オーナー |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 4 | 3 |
| ② メタファー適合度 | 3 | 4 | 5 |
| ③ コメディ発展性 | 3 | 4 | 5 |
| ④ 教育価値 | 3 | 5 | 4 |
| ⑤ 差別化 | 2 | 4 | 5 |
| **合計** | **15** | **21** | **22** |
| **推奨理由** | 安定だが既視感 | 技術的深みあり | キャラ立ち抜群 |

### 症状評価

| 評価軸 | 案A（王道）クローン増殖 | 案B（革新）多臓器不全 | 案C（逆転）潜伏動脈硬化 |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 3 | 4 |
| ② メタファー適合度 | 5 | 4 | 4 |
| ③ コメディ発展性 | 4 | 3 | 3 |
| ④ 教育価値 | 4 | 5 | 3 |
| ⑤ 差別化 | 3 | 4 | 4 |
| **合計** | **20** | **19** | **18** |
| **推奨理由** | メタファー完璧 | 症状重すぎ | 教育価値やや弱 |

---

## Step 5: 相乗効果の検討

### 組合せ候補: テーマC（居酒屋注文）× 患者C（居酒屋オーナー）× 症状A（クローン増殖）

- **テーマ × 患者**: ✅ 自作システムを持つ居酒屋オーナーが自店のシステムを持ち込む。完璧に自然
- **テーマ × 症状**: ✅ 各テーブルの注文ごとにメニューオブジェクトをクローン生成。直感的でリアル
- **患者 × 症状**: ✅ 原価率にはシビアなのにメモリのコスト意識がない。「ムダを排除する」経営哲学を持つ人がコードでムダを量産しているギャップ。「なぜ同じビールの情報をテーブルごとに作り直す？」「だって、それぞれの注文は別物だろ？」という勘違いが自然
- **コメディ相乗効果**: ✅ 経営用語（原価率、在庫管理、仕入れ一元化）がそのままFlyweight概念にマッピングされる。ドクターが「仕入れと同じだ」と一言、ナナコが「メニューの"仕入れ先"を一つにまとめるようなものですよ」と通訳する流れが自然に生まれる
- **差別化**: ✅ コードドクターシリーズで飲食系は初。非IT業界の人が患者というのも新鮮

### 総合スコア: 24 + 22 + 20 = **66/75**

---

## 選定結果

### 採用案

| 要素 | 採用案 | スコア |
|------|--------|--------|
| テーマ | 居酒屋チェーンの注文管理システム（逆転） | 24/25 |
| 患者 | 飲食店経営者兼プログラマー（逆転） | 22/25 |
| 症状 | クローン増殖症候群（王道） | 20/25 |

- **総合スコア**: 66/75

### 選定理由

テーマと患者の「逆転」アプローチで圧倒的なコメディ発展性と差別化を実現しつつ、症状は「王道」のクローン増殖を選択して技術的な教育価値を確保。居酒屋経営の「原価管理」とFlyweightの「共有によるコスト削減」が美しくマッピングされ、非エンジニアでも理解できるメタファーが自然に生まれる。

### 3要素の整合性

- テーマ × 患者: ✅ 自店システムを自作した居酒屋オーナーがシステム不具合で来院
- テーマ × 症状: ✅ メニューオブジェクトの重複生成は居酒屋注文で自然なシナリオ
- 患者 × 症状: ✅ コスト意識の鬼がメモリコストに無頓着というギャップが笑い

## テーマ詳細

- **テーマ名**: 居酒屋チェーンの注文伝票システム
- **一行説明**: メニュー品目（名前、価格、カロリー、画像パス）を注文テーブルごとに複製して管理していたシステム
- **パターンとの接点**: 「生ビール」は全テーブルで同一のマスターデータ。テーブル番号・数量・注文時刻だけがExtrinsic State。50テーブル×各20品の注文で1,000個の同一メニューオブジェクトが重複生成される
- **読者像**: Webアプリ・業務システム開発者

## 患者詳細

- **属性**: 38歳、居酒屋チェーン3店舗オーナー兼社内システム担当、独学プログラマー歴5年
- **性格キーワード**: 豪快、コスト意識が鋭い、ITには大雑把
- **背景**: 「外注に頼むと高いから」と自作した注文管理システム
- **主訴**: 「金曜の夜になると注文システムが重くなって、レジが固まるんだよ。週末商売なのに勘弁してくれよ……」
- **コメディポテンシャル**: コスト管理の鬼なのにメモリコストには無頓着。「原価率は28%に抑えてるんだ」と自慢するが、メモリ使用率は280%

## 症状詳細

- **技術的症状**: 同一のマスターデータ（メニュー名、価格、属性等）を持つオブジェクトが利用箇所ごとにnewされ、数百〜数千個の同一内容オブジェクトがメモリ上に存在する
- **医療メタファー**: **クローン増殖症候群** — 同一のDNAを持つ細胞が際限なく分裂し、体内リソースを圧迫する
- **重症度**: 中症（機能は正常に動作するが、負荷時にメモリ不足で障害発生）
- **Before/Afterの見込み**: Before: 1,000個の同一オブジェクト → After: マスター10個 + 参照1,000個。メモリ使用量90%以上削減
- **読者の「あっ」ポイント**: 「自分も似たような構造を作ったことがある……」

## 評価サマリー

- テーマ: 案C（逆転）24点 — 居酒屋の身近さとコメディ力が圧倒的
- 患者: 案C（逆転）22点 — 経営者のコスト意識×IT音痴のギャップが強い
- 症状: 案A（王道）20点 — クローン増殖のメタファーがFlyweightに完璧にフィット
- 総合: 66/75、3要素の相乗効果も最高レベル

## 不採用案（参考）

### テーマ不採用
- 案A（王道）ゲームマップタイル: 14点 — 定番すぎて差別化困難、既存統合版とも近い
- 案B（革新）ログ解析: 15点 — 地味でコメディ発展性が弱い

### 患者不採用
- 案A（王道）新人Webエンジニア: 15点 — 安定だが他記事と被りやすい
- 案B（革新）完璧主義TL: 21点 — 技術的深みはあるがコメディ力で案Cに劣る

### 症状不採用
- 案B（革新）多臓器不全型: 19点 — 複合症状は教育価値高いが記事が複雑化しすぎる
- 案C（逆転）潜伏型動脈硬化: 18点 — 潜伏期間の表現が難しくコメディと両立しにくい
