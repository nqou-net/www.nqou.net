# Plot Outline: Memento パターン

## 舞台設定: 来院

深川陽菜がネット検索で「コード診療所」を見つけ、自分のノートPCを持って来院する。

---

## I. 来院：消えた最高の一杯

### シーン概要

深川陽菜が、焙煎プロファイル管理ツールの入ったノートPCを抱えて、雑居ビル2階の「コード診療所」を訪れる。

### 展開

- 陽菜は恐る恐る重い鉄の扉を**引いて**入る。O'Reilly本の壁に圧倒される。
- 奥のトリプルディスプレイの前にいる男（ドクター）は一瞥もくれない。
- ナナコが穏やかに迎え入れる。「大丈夫ですよ、ここはコード診療所です」
- 陽菜はノートPCを開き、焙煎プロファイルのYAMLファイル群が表示されたディレクトリを見せる。

### 主訴の吐露

- 「3日前に焙煎した豆が、今までで一番おいしかったんです。でも、その後3回パラメータを変えて上書きしちゃって……あの時の設定がどれだったか、もう分からないんです」
- ディレクトリには `roast_profile.yaml`、`roast_profile_backup.yaml`、`roast_profile_v2.yaml`、`roast_profile_old.yaml`、`roast_profile_final.yaml`、`roast_profile_best_maybe.yaml` が並ぶ。

### 感情

焦りと喪失感。「最高の一杯」の記憶が失われたことへの切実な悲しみ。

---

## II. 触診：多重記憶喪失症候群

### シーン概要

ドクターがコード（患部）を無言で精査し、診断を下す。

### 展開

- ドクターが画面を覗き込み、ディレクトリの `ls -la` 結果を無言で眺める。
- ドクター: 「……6つ。全部、同じだ」
- ナナコ: 「先生がおっしゃっているのは、これらのファイルが全部同じ時点のコピーではないか、ということです。いつの時点を保存したか、ラベルが貼られていないんですね」
- 陽菜: 「え……でも backup って名前に……」
- ドクターがPerlスクリプトを開く。焙煎プロファイルを管理するコードの患部を発見。

### 患部コード（Before）

```perl
# 患部: RoastManager.pm
package RoastManager;
use v5.36;

sub new($class) {
    bless {
        profile => {
            temp_start  => 180,
            temp_peak   => 220,
            duration    => 720,
            fan_speed   => 65,
            bean_type   => 'Ethiopia Yirgacheffe',
        },
    }, $class;
}

sub update_profile($self, %params) {
    # 直接上書き——前の値は永遠に消える
    $self->{profile}{$_} = $params{$_} for keys %params;
}

sub save_backup($self) {
    # cpコマンドでバックアップ（笑）
    system("cp roast_profile.yaml roast_profile_backup.yaml");
}
```

### 診断

- ドクター: 「多重記憶喪失」
- ナナコ: 「コーヒーで例えると……毎回テイスティングノートに上書きで書いているようなものです。前のメモが全部消えていて、どの豆がどの味だったか分からなくなっている状態ですね」
- 陽菜: 「あっ——それ、まさにそれです！！」（コーヒーの比喩で即座に理解）

---

## III. 処方箋：記憶のカプセル化

### シーン概要

ドクターが Memento パターンを適用。3つの役割（Originator / Memento / Caretaker）を実装する。

### 展開

1. **Memento（記憶カプセル）の作成**
   - ドクターが新しいファイルを作り始める。
   - ナナコ: 「先生が作っているのは『記憶カプセル』です。焙煎プロファイルの状態を丸ごと、密封した瓶に詰めるイメージですね」
   - 陽菜: 「豆を保存する密閉キャニスターみたいなものですか！」
   - ナナコ: 「……まさにそうです」（予想外に的確な比喩に感心）

2. **Originator（記憶の持ち主）の改修**
   - 既存の `RoastManager` に `save_to_memento` / `restore_from_memento` を追加。
   - 陽菜: 「あ、`save_backup` が消えた……cpじゃなくなった……」
   - ドクター: 「カプセル化」（短く一言）

3. **Caretaker（記憶の番人）の作成**
   - 履歴スタックで Memento を管理する `RoastHistory` クラス。
   - ナナコ: 「これは『記憶の番人』です。カプセルを棚に順番に並べて管理する役目ですね。何番目のカプセルでも取り出せます」
   - 陽菜: 「あの日の味に戻れる……？」

### カタルシスポイント

- ドクターがテストを実行。3つの焙煎プロファイルを順に設定→保存→変更を繰り返し、`undo` で1つずつ巻き戻す。
- 「roast_profile_backup.yaml も roast_profile_final.yaml もいらない。全部ここにある」とナナコが履歴スタックのダンプを見せる。
- 陽菜: 「あの日の……あの日の設定が、ちゃんとある……！」

---

## IV. 術後経過：あの日の一杯

### シーン概要

治療後の確認とコメディシーン、そして退院。

### 展開

- テスト結果を確認。5つのスナップショットが正確に保存・復元されていることを実証。
- 陽菜が感謝を伝えようとする。

### 勘違いコメディシーン

- 陽菜がお礼として、持参した自家焙煎のコーヒー豆の小袋を差し出す。
- ドクターが受け取ろうとした——と思ったら、陽菜の後ろの棚に手を伸ばし、O'Reilly本の「Programming Perl」を引き抜いた。
- 一瞬の沈黙。
- 陽菜:（えっ……私の豆より本の方が大事なの……？ いや、でもドクターだし……コードへの愛が……）
- ドクターは本をパラパラとめくり、特定のページを陽菜に見せた。`Storable` モジュールのページだ。
- ドクター: 「深いコピー。これで」
- ナナコ: 「先生は、深川さんのプロファイルを本当の意味で完全にコピーするには、ネストされたデータ構造も含めて deep copy が必要だとおっしゃっています。`Storable::dclone` を使うといいですよ」
- 陽菜はコーヒー豆の小袋をそっと受付カウンターに置いた。ドクターは気づいていない。ナナコが小さく「ありがとうございます」と受け取った。

### 退院

- 陽菜: 「これで、あの日の味を取り戻せます。……先生、ありがとうございました」
- ドクター: 「感謝は、このコードに」
- 陽菜は重い鉄の扉を**押して**開け、廊下に出た。ビルの外に出ると、近くのカフェからコーヒーの香りがした。
- 「……今日焙煎して、あの設定で淹れよう。今度はちゃんと、記憶を保存しながら」

---

## 舞台設定チェック（来院）

- [x] ドクターと助手は診療所に居る側
- [x] 患者が「来て」「帰る」側（帰り支度・ドアを出る主語は患者）
- [x] 患者のデスク・自席は存在しない（持ち込んだノートPCのみ）
- [x] クリニック設定の小物（O'Reilly本の壁、トリプルディスプレイ）が使用されている
- [x] 入る時: **引いて**開ける（外開き / pull open）
- [x] 出る時: **押して**開ける（外開き / push open）
- [x] 退場シーンの主語が患者
- [x] コメディシーンでドクターの行動が論理的（本を参照しただけ）
- [x] 患者の誤解が感情的（コーヒー豆を無視された→コードへの愛？）
- [x] 助手が否定も肯定もせず見守る
