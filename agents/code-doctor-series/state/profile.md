# Profile: State Pattern

## Patient Profile

- **Name**: 麺田 剛志（めんだ つよし）— 元ラーメン屋店主の転職プログラマー (38)
- **Role**: Webエンジニア（転職3年目）。前職はラーメン屋「剛志軒」を10年経営
- **Engineer History**: 3年（独学→職業訓練校→中小SaaS企業）
- **Personality**: 体育会系、直感型。仕事は気合と根性、コードは「動けば正義」。人当たりは良く面倒見もいいが、設計の話になると「まぁ動いてるし」で押し通す。ラーメン用語がつい口をつく
- **First Person**: 「俺」
- **Background**: ラーメン屋時代の原材料管理に悩み、「だったら自分でシステム作ればいい」とプログラミングを始めた。転職先では社内ツール開発を担当。調理工程をコードで自動化する個人プロジェクト「麺マスター」を週末に開発中。調理の段取り感覚でコードを書くため、「仕込み→茹で→盛り付け→提供」の工程管理を忠実にコード化したが、状態管理がフラグだらけになり崩壊した
- **Chief Complaint**: 「コードは動いてるんだよ！でもバイト……じゃなくて後輩が触ると必ずバグるんだ。先週も『茹で中なのに盛り付け開始しちゃった』みたいなバグが出てさ」
- **Speech Pattern**: ラーメン用語を無意識にプログラミングに混ぜる。「コードの麺が伸びてる」「このロジック、スープが濁ってる」「変数が煮詰まってきた」

## Medical Chart

### 症状（Symptoms）

| 技術的症状 | 医療メタファー |
|-----------|--------------|
| `$is_ready`, `$is_boiling`, `$is_topping`, `$has_error`, `$is_served` の5つのbooleanフラグで調理状態を管理 | **多発性フラグ症候群** — 体内に5本の独立した信号線が走り、それぞれが勝手にON/OFFを切り替えている |
| 理論上32通りの組み合わせのうち有効なのは6通りだが、26通りの無効な組み合わせに対するガードがない | **免疫不全** — 26もの侵入経路（無効状態）が無防備に開いている |
| `$is_boiling && $is_topping` のような矛盾する状態が発生し、「茹で中なのに盛り付け」が起きる | **自己免疫疾患** — 本来協調すべきフラグ同士が矛盾し、システム自身を攻撃している |
| 新しい工程（例: トッピング種別の分岐）を追加するたびに全フラグの整合性確認が必要 | **転移リスク** — 新しい臓器（機能）を追加するたびに、既存の病巣から転移する危険がある |
| フラグの組み合わせをチェックする `if` 文が関数内に散在し、同じチェックが複数箇所に重複 | **慢性炎症** — 体中に散らばった炎症巣が同時に悪化し、どこが根本原因か特定できない |

### 病名（Diagnosis）

**「フラグ免疫不全症候群」（Flag Immunodeficiency Syndrome: FIS）**

複数のbooleanフラグが互いの整合性を保証できず、無効な状態の組み合わせという「感染」に対して無防備な状態。正常に見える（テストが通る）ときも、特定の操作順で発症する不顕性感染を伴う。

### 処方（Prescription）

**State パターンによる「臓器移植手術」**

散在するフラグ群（病巣）を摘出し、各状態を独立した状態オブジェクト（健康な臓器）に置換する。各状態オブジェクトが「自分に許可された操作」と「次に遷移できる状態」だけを知っているため、無効な組み合わせは構造的に発生しなくなる。

### 治療の見立て

| Before（患部） | After（移植後） |
|---------------|---------------|
| フラグ5本で状態を表現（32通りの組み合わせ） | 状態クラス6個のみ（有効な状態だけが存在） |
| 不正な遷移を実行時まで検出できない | 各状態が許可する遷移を宣言、違反は即例外 |
| 新工程追加時に全フラグの整合性を手動確認 | 新状態クラスを追加するだけ、既存コードへの影響なし |
| 同じフラグチェックが複数箇所に散在 | 状態固有の振る舞いが状態クラスに集約 |

## 来院/往診の判定

**往診**。理由: 個人プロジェクト「麺マスター」は自宅で開発中。患者が「変なバグが出る」と同僚に相談→同僚がコードドクターの存在を耳打ち→半信半疑で連絡→ドクターとナナコが患者の自宅に往診する流れ。

## コメディ要素の種

1. **ラーメン用語ボケ**: ドクターが技術用語を言うたびにラーメン用語に変換して返す。「分離」→「チャーシュー分けるってこと？」、「委譲」→「大将に任せるってことか！」
2. **調理実演**: 説明に詰まると実際に台所でラーメンを作り始めて「ほら、この工程がさ……」と実演。ドクターが黙って食べる
3. **勘違いコメディ**: ナナコがお茶を出すシーンで、ドクターが「美味い」と一言。患者がナナコの方を見ると、ナナコはコードを読みながら完全スルー。ドクターが少し肩を落とす
4. **弟子入り志願**: 手術（リファクタリング）の腕前に感動し、「弟子にしてくれ！」と頭を下げる。ラーメン屋と同じ弟子入りの文化が出る
