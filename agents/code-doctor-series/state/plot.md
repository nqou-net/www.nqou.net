# Plot: State Pattern — フラグ免疫不全症候群

## 舞台設定

- **場所**: 往診（患者・麺田の自宅マンション。リビングがPC作業スペース兼キッチン）
- **時間帯**: 土曜日の昼下がり
- **状況**: 同僚から「コードドクターっていう怪しいやつがすごいらしい」と聞いた麺田が、半信半疑で依頼

---

## I. 導入 — 往診

### Scene 1: 出迎え

**ト書き**: 麺田がインターホン越しに「どちら様ですか」と応答。ドアを開けると、黒い鞄を持った無表情の男（ドクター）と、礼儀正しい女性（ナナコ）が立っている。

**展開**:
- ナナコが定番の自己紹介「大丈夫ですよ、ここはコード診療所です……あ、いえ、往診ですね」
- 麺田の反応: 「往診？ 出前みたいなもんか？」（自分の文脈に変換）
- リビングに通す。PCデスクの横にラーメン関連の本、壁にはラーメン屋時代の写真
- ドクターが無言で部屋を見回す。台所に業務用寸胴鍋があるのを一瞥

### Scene 2: 主訴の聴取

**ト書き**: 麺田がノートPCを開いて「麺マスター」を見せながら症状を説明。

**展開**:
- 麺田: 「俺が作った調理管理システムなんだけどさ。ラーメン一杯作る工程を全部コードで管理してるんだ。仕込み、茹で、盛り付け、提供……完璧にモデル化したはず」
- 麺田: 「でもよ、後輩に使わせたら『茹で中なのに盛り付け開始しちゃいました』ってバグが出てさ」
- 麺田: 「ラーメンで言えば、麺がまだ硬いのにどんぶりに入れちゃうようなもんだ。ありえないだろ？」
- ドクターが画面を覗き込み、スクロールせずに黙って眉をひそめる
- ナナコ: 「先生、まず患部を拝見しましょうか」

---

## II. 検査 — 触診・画像診断

### Scene 3: 触診（コードの一見）

**ト書き**: ドクターがコードをスクロールする。フラグ変数の宣言部分で手が止まる。

**展開**:
- ドクターが `$is_ready`, `$is_boiling`, `$is_topping`, `$has_error`, `$is_served` のフラグ群を見て、一言: 「……5本」
- ナナコ（患者に向けて）: 「5本のフラグで状態を管理されているんですね。これは……体内に5本の信号線が独立して走っているような状態です」
- 麺田: 「5本？ ラーメンの基本要素は5つだろ？ 麺、スープ、チャーシュー、ネギ、メンマ……完璧じゃねぇか」
- ナナコ: 「……技術的には完璧とは少し違うかもしれません」

### Scene 4: 画像診断（アンチパターンの特定）

**ト書き**: ドクターが処理関数を開き、if文が連なる箇所を指差す。

**展開**:
- ドクター: 「32通り」（と呟く）
- ナナコ: 「フラグが5本でそれぞれON/OFFですから、組み合わせは2の5乗で32通りになります。でも有効な調理状態は6つだけですよね？」
- 麺田: 「26通りのハズレ？ こりゃ闇鍋みたいなもんだな……」
- ドクター:「免疫不全」
- ナナコ: 「先生が言いたいのは、このコードには26もの『無効な状態』への入口が無防備に開いているということです。免疫系が機能していない患者さんのように、どんな感染（バグ）にも抵抗できない状態ですね」

### Scene 5: 診断結果

**ト書き**: ドクターが立ち上がり、腕を組む。

**展開**:
- ドクター: 「フラグ免疫不全症候群」
- 麺田: 「俺のコードが免疫不全だって？ 筋トレと気合が足りねぇってことか？」
- ナナコ: 「気合の問題ではないんです。フラグで状態を管理する設計そのものが、矛盾した状態を許してしまう構造なんです」
- ナナコ: 「調理で例えると……注文票に『仕込み中』『茹で中』『盛り付け中』のチェックボックスが並んでいて、全部に同時にチェックを入れられてしまう……そんな注文票で調理を管理しているようなものです」
- 麺田: 「なるほど……確かにそんな注文票で厨房回したら事故るわ」

---

## III. 処置 — 外科手術

### Scene 6: 処方箋の提示

**ト書き**: ドクターが静かにキーボードに手を伸ばす。

**展開**:
- ドクター: 「State パターン」
- ナナコ: 「チェックボックスの注文票をやめて、『仕込みカード』『茹でカード』『盛り付けカード』……と、工程ごとに1枚のカードを作るんです。カードには『この工程でできること』と『次にどのカードに進めるか』だけが書いてあります」
- 麺田: 「カード制……まるで調理場の工程カンバンだな！」
- ナナコ: 「まさにそのイメージです。カンバンが1枚しか掲示できないので、矛盾した工程が同時に走ることは物理的にありえません」

### Scene 7: 手術開始（Before → After）

**ト書き**: ドクターが黙々とコードを書き換え始める。麺田が横で見守る。

**展開（Before コード提示）**:
- 現在の `process_order` 関数を提示: フラグ5本と巨大な条件分岐
- 麺田: 「うわ……改めて見ると、これ秘伝のタレの配合表みたいだな。俺以外読めねぇ」

**展開（変換のハイライト）**:
- ドクターがまず状態の基底クラス（ロール）を定義
- 次に各状態クラス（WaitingOrder, Preparing, Boiling, Topping, Serving, Completed）を作成
- ナナコ: 「先生が今、各工程を独立したカードに分けています。それぞれのカードが『自分にできる操作』と『次の工程』を知っているんです」
- 麺田が途中で「おい、フラグ全部消えてるぞ！？」と慌てる
- ナナコ: 「そうなんです。フラグはもう不要です。『今どの工程カードを持っているか』だけで状態が決まりますから」

**展開（After コード提示）**:
- 完成した State パターンのコードを提示
- 麺田: (PC画面を見つめて)「……すげぇ。6つの工程が全部分かれてる。しかも『茹で中から盛り付け』にしか進めねぇようになってる」

### Scene 8: ラーメン実演（意外な展開）

**ト書き**: 麺田が突然立ち上がって台所に向かう。

**展開**:
- 麺田: 「ちょっと待ってくれ。今の話、実際にラーメン作りながら確認したい」
- 麺田が実際にラーメンを作り始めながら「ほら、今が Preparing 状態だろ。ここから Boiling に遷移して……」とコードと調理を照合
- ドクターが黙って出来上がったラーメンを受け取り、一口すする
- ドクター: 「……美味い」（コードではなくラーメンの感想）
- 麺田: 「だろ！？ 麺は硬めが——って、コードの話だよな？」

---

## IV. 予後 — 術後経過

### Scene 9: 術後確認

**ト書き**: 全員がラーメンを前にしている（ナナコの分も作った）。ドクターがテストの実行結果を見せる。

**展開**:
- ドクター: 「全テスト通過」
- ナナコ: 「すべてのテストが通りましたね。特に、以前失敗していた『無効な状態遷移のテスト』——茹で中から直接提供に飛ぶケース——がきちんとエラーになっています」
- 麺田: 「マジかよ……あのバグ、ずっと原因わかんなかったんだ」
- ナナコ: 「新しい工程を追加したい場合も、新しい状態クラスを1つ作るだけです。既存のコードを変更する必要はありません」
- 麺田: 「トッピングのバリエーション増やしても大丈夫ってことか……」

### Scene 10: 勘違いコメディ

**ト書き**: ナナコがお茶を淹れて、ドクターに先に渡す。

**展開**:
- ナナコ（ドクターに）: 「先生、お茶をどうぞ」（ラーメンの後だから自然な流れ）
- ドクター: (受け取って頷く。一瞬、指が触れる)
- ドクターが満足げな表情で茶を飲む。小さく「……いい」と呟く
- 麺田の観察: 「ドクターの顔が一瞬だけ柔らかくなったように見えた。……お茶がそんなに美味いのか？ いや、ナナコさんの手が——いやいや」
- ナナコは既に麺田のノートPCに戻って追加のリファクタリングポイントを確認している（完全スルー）
- ドクターが一瞬肩を落とし、すぐに姿勢を戻す

### Scene 11: 退院指導

**ト書き**: ドクターとナナコが帰り支度を始める。

**展開**:
- ナナコ: 「今後、状態が増えても1クラス追加するだけです。他の状態に影響はありませんので、安心して拡張してくださいね」
- 麺田: 「先生！ 弟子にしてくれ！」（頭を下げる）
- ドクター: (少し驚いた顔をして) 「……感謝は、このコードに」
- ナナコ: 「先生、弟子は取っていないんです。でも、いつでもご相談くださいね」
- 麺田: 「そうか……じゃあせめて、店に来い！ ラーメン、いくらでも奢るぜ！」
- ドクターの背中が一瞬だけ止まる（少し嬉しそうに見えた、と麺田は思った）
- 麺田（独白）: 「あの背中……大将って感じだな。……って、俺が元大将だけど」

---

## 勘違いシーンのチェック

- [x] ドクターの行動は論理的か: ✅ お茶を飲んで「いい」と感想を言っただけ
- [x] 患者の誤解は感情的か: ✅ 指が触れた瞬間に深読みしようとして自分でツッコミ
- [x] 助手の反応は適切か: ✅ 完全スルーでコード確認に戻っている

---

## 舞台設定の整合性チェック（往診）

- [x] 「帰り支度」の主語がドクターとナナコ（去る側）: ✅ Scene 11
- [x] 患者の所有物（デスク・台所・寸胴鍋）が自宅に存在: ✅ 患者の自宅
- [x] 退場シーンの主語がドクター: ✅ ドクターの背中が止まる
- [x] クリニック固有の小物を使っていない: ✅ O'Reilly本の壁等なし
- [x] ラーメン実演は患者の自宅台所: ✅ 自然な流れ
