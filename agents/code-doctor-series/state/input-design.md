# Input Design: State

## Step-Back思考

> **読者に何を持ち帰ってもらいたいか**: 状態に応じて振る舞いが変わるオブジェクトを、巨大な条件分岐ではなく「状態オブジェクト」に委譲する設計を理解し、自分のコードに適用できるようになること。

> **既存シリーズとの差別化**: 「自動販売機シミュレーター」シリーズ（Perl/Moo）が既出。テーマ・切り口で明確に差別化する。

> **技術的制約**: Perl v5.36以降（signatures、postfix dereference サポート必須）

---

## Step 1: テーマ3案

### 案A（王道）: チャットボットの会話状態管理

- **テーマ名**: チャットボットの会話フロー制御
- **一行説明**: ユーザーとの対話で「挨拶→質問受付→回答中→終了」と遷移するチャットボットの内部状態管理
- **パターンとの接点**: 会話状態ごとに受け付けるコマンドや応答が異なり、if/elsif の山が爆発する典型ケース
- **読者像**: Webサービスやツール開発で簡易ボットを作ったことがある中級者

### 案B（革新）: ラーメン屋の調理オペレーション

- **テーマ名**: ラーメン一杯の調理工程管理
- **一行説明**: 注文受付→仕込み→茹で→盛り付け→提供の各工程で、許可される操作と遷移が厳密に決まっている調理オペレーション
- **パターンとの接点**: 工程ごとに「できること/できないこと」が変わり、工程戻しの禁止や並行処理の制約がある。状態遷移のルール違反を型で防ぐのにStateパターンが効く
- **読者像**: 日常的な題材で馴染みやすく、状態遷移の概念を直感的にイメージしたい初〜中級者

### 案C（逆転）: エアロック（宇宙船の気密室）制御

- **テーマ名**: 宇宙船エアロックの安全制御システム
- **一行説明**: 内扉と外扉が同時に開くと致命的事故になるエアロックで、状態ごとに許可される操作を厳密に制御する
- **パターンとの接点**: 「減圧中に外扉を開けたら死ぬ」という致命的バグを、状態オブジェクトによる操作制限で構造的に防止する。単なるフラグ管理では見落としが発生する
- **読者像**: 安全性が重要なシステムに興味があるエンジニア。「状態管理ミスが命に関わる」というインパクトで記憶に残る

---

## Step 2: 患者3案

### 案A（王道・共感型）: 新卒インフラ志望なのにボット担当になった若手

- **属性**: 24歳、男性、SIer勤務2年目、エンジニア歴1.5年
- **性格キーワード**: 真面目、自己否定的、説明書を全部読むタイプ
- **一人称**: 僕
- **背景**: インフラ志望で入社したのに社内チャットボット開発を任された。「とりあえず動くもの」を作ったら、状態管理が破綻して誰も触れないコードになった
- **主訴**: 「ボットが変な返事をするんです……ユーザーの会話の途中で急に『ご注文は？』って言い出したり」
- **コメディポテンシャル**: 真面目すぎて「ボットの気持ちを考えて」コードを書こうとする。ドクターの無口さを「怒っている」と勘違いして延々謝る

### 案B（革新・意外型）: ラーメン屋の店主がプログラマーになった転職組

- **属性**: 38歳、男性、元ラーメン屋店主→Webエンジニア転職3年目、エンジニア歴3年
- **性格キーワード**: 体育会系、直感型、口癖は「気合で何とかなる」
- **一人称**: 俺
- **背景**: ラーメン屋を10年経営後にプログラマーに転職。料理の段取りの感覚でコードを書くが、条件分岐が「秘伝のタレ」のように複雑化して本人しか読めない
- **主訴**: 「コードは動いてるんだよ！でもバイト……じゃなくて後輩が触ると必ずバグるんだ」
- **コメディポテンシャル**: すべてをラーメン用語で例える（「コードの麺が伸びてる」「このif文はスープが濁ってる」）。ドクターが一言「分離」と言うと「チャーシュー？」と返す

### 案C（逆転・ギャップ型）: 宇宙好きの高専出身組込みエンジニア

- **属性**: 27歳、女性、組込み系メーカー勤務5年目、エンジニア歴5年
- **性格キーワード**: 理論派、宇宙オタク、プライド高め
- **一人称**: 私
- **背景**: ハードウェア制御は得意だが、ソフトウェア設計はフラグ変数のゴリ押し。「ハードでは信号のHigh/Lowで状態管理するのが当然」という発想がコードにも持ち込まれ、booleanフラグが20個並ぶ
- **主訴**: 「バグじゃないんです。仕様の抜けがあっただけで……でもその抜けが毎週見つかるんです」
- **コメディポテンシャル**: 宇宙の話になると急に饒舌になり脱線する。ドクターが「状態」と言うと「量子状態？」と食いつく。ナナコとは宇宙話で意気投合

---

## Step 3: 症状3案

### 案A（王道・典型症状）: 巨大 if/elsif チェーン

- **技術的症状**: 状態を文字列フラグで管理し、メインの処理関数に `if ($state eq 'idle') { ... } elsif ($state eq 'processing') { ... }` が15分岐以上。新状態の追加には既存分岐すべてへの影響確認が必要
- **医療メタファー**: 「多臓器不全」— 一つの巨大な臓器（関数）がすべての機能を担い、どこかを変えると全体が連鎖的に壊れる
- **重症度**: 重症
- **Before/Afterの見込み**: Before: 1関数300行の条件分岐地獄 → After: 状態ごとに独立したクラス、メイン関数は委譲のみ
- **読者の「あっ」ポイント**: 「自分のコードにも `$status` って変数あるな……」

### 案B（革新・複合症状）: フラグの組み合わせ爆発

- **技術的症状**: `$is_ready`, `$is_processing`, `$is_paused`, `$has_error`, `$is_locked` のようなbooleanフラグ5個以上の組み合わせで状態を表現。理論上32通りの組み合わせのうち有効なのは6通りだが、無効な組み合わせへのガードが漏れてサイレントバグが起きる
- **医療メタファー**: 「自己免疫疾患」— 本来協調すべきフラグ（免疫細胞）が矛盾した状態になり、システム自身を攻撃する
- **重症度**: 中症〜重症
- **Before/Afterの見込み**: Before: フラグ5本で状態を管理、不正な組み合わせが潜伏 → After: 有効な状態のみが型として存在し、不正な組み合わせはコンパイル時に排除
- **読者の「あっ」ポイント**: 「フラグ2つ以上でIF書いたことある……そのバグ見たことある……」

### 案C（逆転・潜伏症状）: 状態遷移の暗黙ルール

- **技術的症状**: 状態遷移のルール（例: idle→processing は可、processing→idle は不可）がコード上に明示されていない。コメントに「注意: この順番で呼ぶこと」と書いてあるだけで、呼び出し順の間違いが実行時にしか分からない
- **医療メタファー**: 「不顕性感染」— 症状が出ない感染症。普段は問題なく動くが、特定の操作順やタイミングで突然発症する
- **重症度**: 軽症〜中症（見た目は健康だが爆弾を抱えている）
- **Before/Afterの見込み**: Before: 状態遷移ルールがコメントと口伝のみ → After: 各状態オブジェクトが許可する遷移を宣言し、違反を例外で即座に通知
- **読者の「あっ」ポイント**: 「『この順番で呼んでください』ってコメント、自分も書いたことある……」

---

## Step 4: 多角的評価

### テーマ評価

| 評価軸 | 案A（王道）チャットボット | 案B（革新）ラーメン調理 | 案C（逆転）エアロック |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 5 | 3 |
| ② メタファー適合度 | 3 | 4 | 5 |
| ③ コメディ発展性 | 3 | 5 | 3 |
| ④ 教育価値 | 4 | 4 | 5 |
| ⑤ 差別化 | 3 | 5 | 4 |
| **合計** | **17** | **23** | **20** |
| **推奨理由** | 安定だが既視感 | 身近で笑いも取れる | インパクト大 |

### 患者評価

| 評価軸 | 案A（王道）新卒若手 | 案B（革新）元ラーメン屋 | 案C（逆転）宇宙好き組込み |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 4 | 3 |
| ② メタファー適合度 | 3 | 5 | 4 |
| ③ コメディ発展性 | 3 | 5 | 4 |
| ④ 教育価値 | 4 | 3 | 4 |
| ⑤ 差別化 | 3 | 5 | 4 |
| **合計** | **17** | **22** | **19** |
| **推奨理由** | 安心感 | キャラが立つ | 知的で個性的 |

### 症状評価

| 評価軸 | 案A（王道）if/elsif | 案B（革新）フラグ爆発 | 案C（逆転）暗黙ルール |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 5 | 4 | 4 |
| ② メタファー適合度 | 4 | 5 | 4 |
| ③ コメディ発展性 | 3 | 4 | 3 |
| ④ 教育価値 | 5 | 4 | 4 |
| ⑤ 差別化 | 3 | 4 | 4 |
| **合計** | **20** | **21** | **19** |
| **推奨理由** | 王道で確実 | 深みがある | 現実的 |

---

## Step 5: 相乗効果の検討と選定

### 最高スコア組合せ: テーマB × 患者B × 症状B

- **テーマB × 患者B**: ✅ 元ラーメン屋店主がラーメン調理管理システムを作る——**完璧な組み合わせ**。自分の経験領域をコード化しようとしたが設計で詰まったシナリオは非常にリアル
- **テーマB × 症状B**: ✅ 調理工程の「準備OK」「火入れ中」「盛り付け可」のフラグが乱立し、「茹で中なのに盛り付け開始」という不正状態が発生——具体的でリアル
- **患者B × 症状B**: ✅ 「気合で何とかなる」タイプが「動いてるからOK」でフラグを追加し続けた結果、組み合わせ爆発——説得力あり

### 代替組合せ: テーマB × 患者B × 症状A

- テーマB × 症状A: ✅ 調理状態の巨大if/elsifも自然だが、症状Bの方がフラグ×ラーメンの掛け合いが面白い

---

## 選定結果

### 採用案

| 要素 | 採用案 | スコア |
|------|--------|--------|
| テーマ | ラーメン一杯の調理工程管理（革新） | 23/25 |
| 患者 | 元ラーメン屋店主の転職プログラマー（革新） | 22/25 |
| 症状 | フラグの組み合わせ爆発・自己免疫疾患（革新） | 21/25 |

**総合スコア**: 66/75

### 選定理由

テーマ・患者・キャラクターが完全に噛み合う稀有なケース。元ラーメン屋店主が自分の業務ドメインでコードを書き、調理の段取り感覚でフラグを追加し続けた結果、状態の組み合わせが爆発するシナリオは、**リアリティ・コメディ・教育価値**の三拍子が揃う。

既存の State パターンシリーズ（自動販売機）とはテーマ・切り口が完全に異なり、差別化も十分。

ラーメン用語によるボケと、ドクターの無口な専門用語とのギャップがコメディを自然に生み出す構造になっている。

### 3要素の整合性

- テーマ × 患者: ✅ 元店主が自作の調理管理ツールを持ち込む——動機が自然
- テーマ × 症状: ✅ 調理工程のフラグ管理が複雑化——ドメインとアンチパターンが直結
- 患者 × 症状: ✅ 「気合」でフラグを増やし続ける性格と症状の因果が明確

---

## テーマ詳細

- **テーマ名**: ラーメン一杯の調理工程管理
- **一行説明**: 注文受付→仕込み→茹で→盛り付け→提供の各工程で、許可される操作と遷移が厳密に決まっている調理オペレーション
- **パターンとの接点**: 工程ごとに「できること/できないこと」が変わり、工程戻しの禁止や並行処理の制約がある。状態遷移のルール違反を型で防ぐのにStateパターンが効く
- **読者像**: 日常的な題材で馴染みやすく、状態遷移の概念を直感的にイメージしたい初〜中級者

## 患者詳細

- **属性**: 38歳、男性、元ラーメン屋店主→Webエンジニア転職3年目、エンジニア歴3年
- **性格キーワード**: 体育会系、直感型、口癖は「気合で何とかなる」
- **一人称**: 俺
- **背景**: ラーメン屋を10年経営後にプログラマーに転職。料理の段取りの感覚でコードを書くが、条件分岐が「秘伝のタレ」のように複雑化して本人しか読めない
- **主訴**: 「コードは動いてるんだよ！でもバイト……じゃなくて後輩が触ると必ずバグるんだ」
- **コメディポテンシャル**: すべてをラーメン用語で例える（「コードの麺が伸びてる」「このif文はスープが濁ってる」）。ドクターが一言「分離」と言うと「チャーシュー？」と返す

## 症状詳細

- **技術的症状**: `$is_ready`, `$is_boiling`, `$is_topping`, `$has_error`, `$is_served` のようなbooleanフラグ5個以上の組み合わせで状態を表現。理論上32通りの組み合わせのうち有効なのは6通りだが、無効な組み合わせへのガードが漏れてサイレントバグが起きる
- **医療メタファー**: 「自己免疫疾患」— 本来協調すべきフラグ（免疫細胞）が矛盾した状態になり、システム自身を攻撃する
- **重症度**: 中症〜重症
- **Before/Afterの見込み**: Before: フラグ5本で状態を管理、不正な組み合わせが潜伏 → After: 有効な状態のみが型として存在し、不正な組み合わせは構造的に排除
- **読者の「あっ」ポイント**: 「フラグ2つ以上でIF書いたことある……そのバグ見たことある……」

---

## 不採用案（参考）

### テーマ不採用

| 案 | テーマ名 | スコア | 不採用理由 |
|----|---------|--------|-----------|
| A | チャットボット会話状態管理 | 17/25 | 既視感が強く差別化が弱い |
| C | 宇宙船エアロック制御 | 20/25 | インパクト大だが読者共感が低く、コメディ展開が難しい |

### 患者不採用

| 案 | 概要 | スコア | 不採用理由 |
|----|------|--------|-----------|
| A | 新卒インフラ志望の若手 | 17/25 | 王道だがキャラの個性が弱い |
| C | 宇宙好き高専出身組込みエンジニア | 19/25 | 個性的だがテーマBとの相性が薄い |

### 症状不採用

| 案 | 概要 | スコア | 不採用理由 |
|----|------|--------|-----------|
| A | 巨大if/elsifチェーン | 20/25 | 王道で確実だが教科書的すぎる |
| C | 状態遷移の暗黙ルール | 19/25 | 現実的だがビジュアル的なインパクトが弱い |
