# Input Design: Template Method

## 基本情報

- **デザインパターン**: Template Method
- **Slug**: `template-method`
- **技術的制約**: Perl v5.36以降、signatures・postfix dereferenceサポート必須
- **公開日時**: 2026-02-22T07:07:05+09:00
- **既存シリーズ差別化**: 「Webスクレイパー」連載（全10回）と「ファイルバックアップツール」（Template Method+Strategy複合）が存在。スクレイピングやバックアップとは完全に異なる切り口を採用する。

---

## Step-Back思考

> **この記事で読者に何を持ち帰ってもらいたいか？**
> 「処理の流れ（骨格）を親クラスで固定し、各ステップの詳細だけをサブクラスに任せる」という設計思想。
> 読者が自分のコードにある「ほぼ同じ処理フローなのに、微妙な違いのせいでコピペしている」場面を認識し、
> 「変わらない部分」と「変わる部分」を分離するリファクタリングを学ぶこと。
> Template Methodの核心は、**「アルゴリズムの骨格は共通なのに、サブクラスで差し替えられる」**——Strategyとの違い（フロー全体 vs 一部のアルゴリズム）も自然に伝えたい。

---

## Step 1: テーマ3案

### 案A（王道）: データインポート処理

- **テーマ名**: 複数フォーマットのデータインポーター
- **一行説明**: CSV・TSV・JSON など異なる形式のファイルを読み込み、バリデーション→変換→保存する一連の処理
- **パターンとの接点**: 「ファイルを開く→パース→バリデーション→正規化→保存」というフローは同一だが、パース方法だけがフォーマットごとに異なる。フォーマット追加のたびにif分岐が増殖する典型例
- **読者像**: バッチ処理やETLを書く業務系エンジニア。日常的に「似た処理を何度もコピペ」している層

### 案B（革新）: 飲み物の抽出レシピ

- **テーマ名**: コーヒー/紅茶/抹茶の淹れ方シミュレーター
- **一行説明**: 湯を沸かす→素材を入れる→蒸らす→注ぐ、という基本手順は同じだが、素材・温度・蒸し時間が変わる
- **パターンとの接点**: GoF原典の「コーヒーと紅茶」の例を拡張。「お湯を沸かす」「カップに注ぐ」は共通、「素材を入れる」「トッピングを加える」が差し替えポイント。フックメソッド（砂糖を入れるか？）が自然に導入できる
- **読者像**: GoFを読んだことがある中〜上級者。「あの有名な例を実際にPerlでどう書く？」に興味がある層

### 案C（逆転）: 社内申請ワークフロー

- **テーマ名**: 経費申請・有給申請・備品購入申請のワークフローエンジン
- **一行説明**: 申請→上長承認→経理/人事承認→完了通知、という流れは同じだが、申請種別ごとに検証ルールと承認ルートが異なる
- **パターンとの接点**: 一見「ビジネスロジックの問題」に見えるが、実はTemplate Methodの教科書的ユースケース。ワークフローの骨格（申請→検証→承認→通知）を固定し、各申請種別で検証・承認ルールだけを差し替える。「ワークフロー」という言葉自体が「テンプレ」の本質を体現している
- **読者像**: 社内ツール開発者、業務システムエンジニア。「同じようなフローを何本もコピペしているが、ビジネスロジックの差異で統一できない」と感じている層

---

## Step 2: 患者3案

### 案A（王道）: 「コピペ流星群」の新人バッチ職人

- **属性**: 24歳、SIer 2年目、バックエンドエンジニア
- **性格キーワード**: 真面目、几帳面、自己流のルール好き
- **背景**: 先輩が退職して引き継いだバッチ処理を保守している。CSV・TSV・固定長ファイルそれぞれに専用スクリプトがあるが、中身の9割が同じ。変更が入ると3つ全部に同じ修正を入れる日々
- **主訴**: 「同じ修正を3回やるの、もう辛いです……1ヶ所直すと別のが壊れるし」
- **コメディポテンシャル**: 「修正漏れで事故」→「だからコピペ時にチェックリストを作った」→チェックリスト自体が3バージョンに増殖するメタ的ギャグ

### 案B（革新）: 「俺流テンプレ」の自信家リードエンジニア

- **属性**: 35歳、Web系企業のテックリード、エンジニア歴12年
- **性格キーワード**: 自信家、効率主義、「動いてるなら触るな」派
- **背景**: 自分が設計した「汎用処理フレームワーク」を自慢しているが、実態は巨大なif-else連鎖で各処理を分岐する1ファイル2000行のモノリス。「一つのファイルで全部管理できて便利」と本気で思っている
- **主訴**: 「俺のフレームワーク、新人がメンテできないらしいんだけど、新人の理解力が低いだけだと思うんだが……」
- **コメディポテンシャル**: 「汎用フレームワーク」の正体がif分岐の塊。ドクターに「これは……フレームワークじゃなくて、分岐増殖症候群ですね」と言われて「いや、これがフレームワークなんですが？」とキョトン

### 案C（逆転）: 「手順書の女王」の元事務職PM

- **属性**: 40歳、元事務職から転身したプロジェクトマネージャー、コーディング歴3年
- **性格キーワード**: 手順書マニア、整理整頓好き、完璧主義
- **背景**: Excelの手順書を何十本も管理していた経験から「手順をコードにしたら楽になる」と思いプログラミングを始めた。各処理をきっちりサブルーチンに分けているが、「フローの共通化」という発想がなく、ほぼ同一の処理フローが微妙に違う名前で10本並んでいる
- **主訴**: 「ちゃんとサブルーチンに分けてるのに、なぜかコードが増え続けるんです……」
- **コメディポテンシャル**: 手順書の経験がある分「共通手順」の概念は直感的に分かる→ドクターが「あなた、すでにTemplate Methodの発想を持っているんですよ」と言うと「え、これってパターン名があるんですか？」→逆に手順書でTemplate Methodを図解して理解が早い、という意外な展開

---

## Step 3: 症状3案

### 案A（王道）: コピペ連鎖増殖症候群

- **技術的症状**: 処理フローが90%同一のサブルーチンが5〜10個並ぶ。修正が入ると全サブルーチンに手動で同じ変更を適用。修正漏れでバグ発生→「コピペ元」と「コピペ先」の間にサイレント分岐が生まれ、どれが正規版か不明に
- **医療メタファー**: 「クローン増殖症」——コピーがコピーを呼び、コピー元が失われた細胞分裂の暴走。本来一つの「原型」（テンプレート）があればよいのに、独立した個体が無秩序に増殖
- **重症度**: 中症（現時点では動いているが、変更のたびに修正漏れリスク）
- **Before/Afterの見込み**: Before: 同一フローの5つのサブルーチン → After: 1つの基底クラス + 5つの差分サブクラス。修正は基底クラスの1ヶ所のみ
- **読者の「あっ」ポイント**: 「フォーマットが違うだけで処理フローは同じ」——自分のコードを見直したときに「あ、これ全部同じ流れだ……」と気づく瞬間

### 案B（革新）: 巨大if-else肥大化症候群

- **技術的症状**: 1つのサブルーチンが全処理タイプをif-elseで分岐。新しい処理タイプの追加でif-elseが際限なく肥大化し、既存の分岐にも副作用が発生。テストが書けない（条件の組み合わせ爆発）
- **医療メタファー**: 「多臓器癒着症」——本来は独立すべき処理が1つの巨大な臓器に癒着。一ヶ所を切除（修正）すると別の臓器（分岐）が出血する
- **重症度**: 重症（新規処理タイプの追加が困難。バグの特定に時間がかかる）
- **Before/Afterの見込み**: Before: 500行のif-else分岐 → After: 基底クラス＋個別サブクラスで各50行。テストも各サブクラスで独立して書ける
- **読者の「あっ」ポイント**: 「このif、もう誰も全容を把握してない……」——条件分岐を追うだけで午前中が終わるコードレビューの記憶

### 案C（逆転）: フック欠損による柔軟性麻痺

- **技術的症状**: 処理フロー自体は一応共通化されているが、カスタマイズポイント（フックメソッド）がないため、例外的なケースの対応がハードコーディングされている。特定のフォーマットだけ「特別処理」が直書きされ、OCP（開放閉鎖原則）に違反
- **医療メタファー**: 「関節硬直症」——骨格（フレームワーク）は存在するが、関節（フック）がないため可動域がゼロ。無理に動かそうとすると骨折（バグ）する
- **重症度**: 軽症〜中症（今は動いているが、新しい要件への対応が場当たり的）
- **Before/Afterの見込み**: Before: 共通処理の中にif文で特殊ケースが散在 → After: フックメソッドを追加し、サブクラスでオーバーライド
- **読者の「あっ」ポイント**: 「共通化したはずなのに、なぜか特殊処理が増え続ける」——中途半端な共通化の罠

---

## Step 4: 多角的評価

### Step-Back: この記事で読者に何を持ち帰ってもらいたいか（再確認）

> 「ほぼ同じ処理フローのコピペ地獄」から脱却する方法。
> 変わらない骨格を親に、変わるステップだけを子に委ねる——
> これが Template Method の処方であることを、笑いながら実感させたい。

### テーマ評価

| 評価軸 | 案A（王道）データインポート | 案B（革新）飲み物レシピ | 案C（逆転）社内申請 |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 5 | 3 | 4 |
| ② メタファー適合度 | 4 | 3 | 4 |
| ③ コメディ発展性 | 3 | 3 | 4 |
| ④ 教育価値 | 4 | 4 | 5 |
| ⑤ 差別化 | 3 | 2 | 5 |
| **合計** | **19** | **15** | **22** |
| **評価** | 実務的で堅実 | GoF原典と被りやすい | 業務フロー×TM が新鮮 |

### 患者評価

| 評価軸 | 案A（王道）新人バッチ職人 | 案B（革新）自信家リード | 案C（逆転）手順書の女王 |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 4 | 3 |
| ② メタファー適合度 | 4 | 4 | 5 |
| ③ コメディ発展性 | 3 | 5 | 5 |
| ④ 教育価値 | 4 | 4 | 4 |
| ⑤ 差別化 | 3 | 4 | 5 |
| **合計** | **18** | **21** | **22** |
| **評価** | 安定感あるが既視感 | ギャグが効くベテラン | 逆転の発見が面白い |

### 症状評価

| 評価軸 | 案A（王道）コピペ増殖 | 案B（革新）if-else肥大化 | 案C（逆転）フック欠損 |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 5 | 4 | 3 |
| ② メタファー適合度 | 5 | 4 | 4 |
| ③ コメディ発展性 | 4 | 4 | 3 |
| ④ 教育価値 | 4 | 5 | 4 |
| ⑤ 差別化 | 3 | 4 | 5 |
| **合計** | **21** | **21** | **19** |
| **評価** | TM の王道症状 | 重症で見応えあり | 上級者向け |

### 相乗効果の検討

#### 最高スコア組合せ: テーマC（社内申請）× 患者C（手順書の女王）× 症状A/B（コピペ増殖 or if-else肥大化）

- **テーマC × 患者C**: ✅ 元事務職PMが社内申請ワークフローを扱うのは極めて自然。手順書の経験がある分、ワークフロー自体には精通しているが「コードでの共通化」の発想がないというギャップが活きる
- **テーマC × 症状A**: ✅ 申請種別ごとに「ほぼ同じフロー」がコピペされているのは非常にリアル
- **テーマC × 症状B**: ⚠️ if-else肥大化は「1つの巨大サブルーチンで全申請を処理」のシナリオ。患者Cの性格（几帳面に分けたがる）とは合わない
- **患者C × 症状A**: ✅ 「ちゃんと分けてるのに増える」はコピペ増殖症状と完全一致

→ **テーマC × 患者C × 症状A** が最も整合性が高い。

#### 次点組合せ: テーマC（社内申請）× 患者B（自信家リード）× 症状B（if-else肥大化）

- **テーマC × 患者B**: ✅ リードエンジニアが社内ワークフローエンジンを「俺が設計した」と自慢するシナリオも面白い
- **患者B × 症状B**: ✅ 「俺のフレームワーク」が実はif-else塊、というギャグは鉄板
- → コメディ発展性が高い組合せだが、テーマC×患者Cの「逆転の発見」の方が記憶に残る

---

## Step 5: 選定結果

### 採用案

| 要素 | 採用案 | スコア |
|------|--------|--------|
| テーマ | 社内申請ワークフロー（逆転） | 22/25 |
| 患者 | 「手順書の女王」の元事務職PM（逆転） | 22/25 |
| 症状 | コピペ連鎖増殖症候群（王道） | 21/25 |
| **総合スコア** | | **65/75** |

### 選定理由

テーマ・患者ともに「逆転」アプローチを採用。社内申請ワークフローという「一見パターンと無関係」な題材と、元事務職の手順書マニアという「非典型的エンジニア」の組合せが、Template Method の本質である「手順の共通化」と深いレベルで接続する。症状は「王道」のコピペ増殖を採用し、読者の共感度と教育価値のバランスを確保した。

### 3要素の整合性

- **テーマ × 患者**: ✅ 元事務職PMが社内申請ワークフローをコード化——背景が自然で、キャラクターの専門知識（手順書管理）がテーマと直結
- **テーマ × 症状**: ✅ 経費・有給・備品の各申請で「ほぼ同じフロー」がコピペされ、申請種別が増えるたびにコードも増殖——非常にリアルなシナリオ
- **患者 × 症状**: ✅ 「ちゃんとサブルーチンに分けている」几帳面さが裏目に出て、同一フローの微妙なバリエーションが増殖——患者の性格と症状が完璧に噛み合う

### 物語のフック

ドクターが「あなた、すでにTemplate Methodの発想を持っているんですよ」と言う瞬間——
手順書のプロが「手順の共通化」というまさにその概念を、コードの世界に翻訳するだけでよかったという「発見」の瞬間が、記事のクライマックスになる。

---

## 不採用案（参考）

### テーマ不採用案

| 案 | テーマ | スコア | 不採用理由 |
|----|--------|--------|--------|
| A（王道） | データインポート処理 | 19/25 | 既存「Webスクレイパー」連載と切り口が近い |
| B（革新） | 飲み物の抽出レシピ | 15/25 | GoF原典の有名例と被り、差別化困難 |

### 患者不採用案

| 案 | 患者 | スコア | 不採用理由 |
|----|--------|--------|--------|
| A（王道） | 新人バッチ職人 | 18/25 | 典型的な新人キャラで既視感あり |
| B（革新） | 自信家リードエンジニア | 21/25 | コメディ発展性は高いが、テーマCとの組合せでは患者Cの方が整合性が高い |

### 症状不採用案

| 案 | 症状 | スコア | 不採用理由 |
|----|--------|--------|--------|
| B（革新） | if-else肥大化症候群 | 21/25 | 患者C（几帳面に分ける性格）と性格的に不一致 |
| C（逆転） | フック欠損による柔軟性麻痺 | 19/25 | 上級者向けで読者層が狭い。Phase 3のコード実装でBefore/Afterの差が見えにくい |
