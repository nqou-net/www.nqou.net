# Plot Outline: Template Method — クローン増殖症候群〜手順書の女王と共通カルテの処方〜

## 舞台設定

- **形式**: 来院（コード診療所）
- **時間帯**: 平日の昼休み
- **背景**: 瀬川は有給を取ってクリニックを訪れる。A4クリアファイル入りの手順書一式を持参。スーツの上にカーディガンを羽織った几帳面な佇まい。

---

## I. 来院 (Admission)

### ありきたりな展開の除外

❌ 「不安げに恐る恐る入ってくる → 怪しい診療所に戸惑う」  
❌ 「コードが動かなくて泣きそう → ドクターに救いを求める」

→ 瀬川は「何かがおかしい」とは感じているが、自分のやり方自体が間違っているとは思っていない。**相談ではなく「確認」**に来ている——「私のやり方は合ってますよね？」というスタンス。

### シーン展開

1. 瀬川が雑居ビルの廊下を歩く。「コード診療所」のプレートを見つけて一瞬戸惑うが、クリアファイルを抱え直して鉄の扉を**引いて**開ける。
2. 入った瞬間、O'Reilly本の壁とマザーボードの山が目に入る。瀬川（語り）:「整理整頓という概念が存在しない空間だった。私の手順書棚とは対極の世界」
3. 奥のカウンターからナナコが迎える。「大丈夫ですよ、ここはコード診療所です」
4. 瀬川「はい、あの……予約は入れてなかったんですけど、社内システムのことでちょっと**確認**したくて」
5. 診察室に通される。トリプルディスプレイに背を向けた男が、椅子を回す。何も言わない。
6. 瀬川、A4クリアファイル50枚綴りをテーブルに置く。「これが仕様書です。まず全体像から説明しますね」
7. ドクター、クリアファイルには一切触れず、目の前のHHKBに手を伸ばす。「コードは」
8. 瀬川「あっ、はい。USBメモリに……」

### ポイント
- 瀬川は「相談」ではなく「確認」に来ている → 自分のやり方に自信がある
- 手順書50枚を完全スルーされることで、ドクターの「コード以外に興味がない」性格を際立たせる
- O'Reilly本の壁と手順書のクリアファイルの対比が面白い

---

## II. 触診 (Examination)

### ありきたりな展開の除外

❌ 「ひどいコードだ → 患者がショックを受ける」  
❌ 「コピペを指摘 → 恥ずかしがる」

→ ドクターは最初、個々のモジュールの品質を**褒める**。命名規則、コメント、サブルーチン分割——すべてが丁寧。問題は個々のパーツではなく「俯瞰で見た時のクローン状態」にある。**顕微鏡では健康体、CT で見ると腫瘍が映る**という検査の展開。

### シーン展開

1. ドクターが `ExpenseRequest.pm` を開く。スクロールしながら黙読。
2. ドクター「……丁寧だ」
3. 瀬川、ホッとして少し微笑む。「やっぱり、サブルーチンに分けてるのが良かったんですかね。先輩に教わった通りに——」
4. ドクターが次に `LeaveRequest.pm` を開く。また黙読。さらに `EquipmentRequest.pm`。
5. ドクターの目が細くなる。3つのファイルをトリプルディスプレイに並べて表示する。
6. ドクター「……**クローン**だ」
7. 瀬川「え？」
8. ナナコが3つのファイルを指して「瀬川さん、この3つのモジュール、処理の流れを比べてみてください。`validate_input`、`check_budget`、`route_approval`、`send_notification`、`archive_record`——**同じ順番**ですよね？」
9. 瀬川「はい、だって申請処理ってそういう流れですから……あっ」
10. ナナコ「そうなんです。**流れは同じ**で、違うのはバリデーションの中身と承認ルートだけ。でも、その『同じ流れ』が10本のモジュールにそれぞれコピーされています」
11. ドクターが diff コマンドを打つ。2つのモジュール間の差分が表示される——**差異はわずか15行**。残り200行は完全一致。
12. ドクター「200行。**無駄に同じ**」
13. 瀬川「でも、申請の種類が違うから、ファイルを分けないと——」
14. ドクター「ファイルは分ける。**流れは分けない**」
15. 瀬川「流れは……分けない？」
16. ナナコ「瀬川さん、手順書をたくさん作ってこられたんですよね。たとえば経費申請と出張申請の手順書、**共通する手順はどうしてましたか？**」
17. 瀬川「……共通する部分は、マスター手順書から参照する形にしてました。各手順書には『基本フローはマスターを参照』って書いて、**差分だけ個別に書いてました**」
18. 沈黙。
19. 瀬川「あ……。**コードで同じことをしていない**」
20. ドクター「病名。**クローン増殖症候群**」
21. ナナコ「同じ遺伝子——つまり同じ処理フロー——を持つクローンが10体。でもマスターの原型がないので、1ヶ所治すと10ヶ所直さないといけないんです」

### ポイント
- 最初に「丁寧だ」と褒めることで、個々のコード品質は問題ないことを認める
- トリプルディスプレイに並べて「見えて」しまう展開が視覚的
- **手順書のマスター参照方式**を瀬川自身が知っていた、という伏線→「コードで同じことをしていない」の自己発見
- ドクターの「ファイルは分ける。流れは分けない」が名言ポイント

---

## III. 外科手術 (Surgery)

### ありきたりな展開の除外

❌ 「ドクターがひたすらコーディング → 患者は見てるだけ」  
❌ 「一気にリファクタリング → 魔法のように全部治る」

→ ドクターが**骨格（テンプレート）**だけ書き、**差分の実装は瀬川に書かせる**。理由: 手順書マスターの発想をすでに持っている瀬川には、「マスター手順書 ＝ 基底クラス」の比喩が通じるため。ドクターが全部やるよりも、**患者が自分の手で書く**ことで Template Method の本質——「骨格を固定し、差分だけ変える」——を体感させる。

### シーン展開

1. ドクターが無言でエディタに向かう。`AbstractRequest.pm` という新ファイルを作成。
2. ドクター「これが**骨格**だ」
3. `process()` メソッドを書く——`validate_input()`, `check_budget()`, `route_approval()`, `send_notification()`, `archive_record()` を順に呼ぶだけのメソッド。各ステップは空のメソッド。
4. ナナコ「マスター手順書ができました。**流れだけが書いてあって、中身はまだ空**です」
5. 瀬川「これ、私の手順書と同じ構造です……！ マスターに流れを書いて、各申請の手順書では中身だけ書く——」
6. ドクター「次。**あなたが書け**」
7. 瀬川「えっ、私が？」
8. ドクター「経費申請の `validate_input`。あなたの方が知っている」
9. ナナコ「先生の言う通りです。バリデーションのルールは瀬川さんが一番詳しいですよね。この骨格を使って、`ExpenseRequest` を書いてみてください。**変わる部分だけ**で大丈夫ですよ」
10. 瀬川が恐る恐るキーボードに向かう。`ExpenseRequest.pm` を `AbstractRequest` のサブクラスとして書き始める。`validate_input()` を実装——金額チェックと経費カテゴリ検証。
11. ドクターが斜めからモニタを見る。
12. ドクター「**フック**。砂糖を入れるか聞け」
13. 瀬川「フック……？ 砂糖？」
14. ナナコ「ここはちょっとだけ補足しますね。申請の中には『上長コメントが必須の場合』と『任意の場合』がありますよね？ そういう **『あってもなくてもいい手順』** をフックメソッドと呼ぶんです。基本は何もしないけど、必要な申請だけ上書きする——コーヒーに砂糖を入れるかどうかみたいなものです」
15. 瀬川「あ、慶弔見舞金は上長コメントが必須で、経費精算は任意だから……ここにフックを入れれば——」
16. 瀬川がフックメソッド `requires_manager_comment()` を基底クラスに追加（デフォルトは `0` を返す）。`CondolenceRequest` でだけ `1` を返すようにオーバーライド。
17. ドクター「……**いい**」（モニタから目を離さずに呟く）
18. テスト実行。5種類の申請が全て正しく処理される。

### コード提示ポイント
- Before: `ExpenseRequest.pm`, `LeaveRequest.pm` の冒頭40行の差分→85%同一のコピペ
- After: `AbstractRequest.pm`（テンプレートメソッド `process()` ＋ 抽象メソッド ＋ フック）→ `ExpenseRequest.pm`（差分の15行のみ）
- Perl v5.36 `use v5.36;` + signatures + Moo による簡潔な継承

---

## IV. 術後経過 (Prognosis)

### ありきたりな展開の除外

❌ 「ありがとうございました → 退院 → おしまい」  
❌ 「数値で改善幅を見せて感動」

→ 瀬川がその場で**新しい申請種別**（慶弔見舞金）を追加し、**1ファイルだけで完結する**ことを体験する。さらに、ドクターが帰った後、瀬川が手順書を広げて「マスター手順書」と「Template Method」の対応関係を自分で**付箋で書き出す**エンディング。

### シーン展開

1. 瀬川「先生、あの……先月バグを出した慶弔見舞金申請、今の構造で追加してみていいですか？」
2. ドクター「やれ」
3. 瀬川が `CondolenceRequest.pm` を新規作成。`AbstractRequest` を継承し、`validate_input()` と `route_approval()` だけを実装。フックメソッド `requires_manager_comment()` で `1` を返す。
4. テスト実行——問題なし。**既存の申請モジュールには一切触れていない**。
5. 瀬川「1ファイル……たった1ファイル追加しただけ。しかもバリデーションと承認ルートだけ。前回は3日かかったのに……」
6. ナナコ「マスター手順書と同じです。新しい申請を追加するとき、基本フローのマスターは触りませんよね。差分だけ書けばいい」

7. **勘違いシーン**: ドクターが席を立つとき、テーブル上の瀬川のクリアファイルを手に取る。一瞬パラパラとめくる。そしてクリアファイルを**きっちり揃えて**テーブルに戻す。
8. 瀬川（語り）:「無造作にコードだけを見ていた人が、私の手順書を手に取った。しかも角を揃えて戻してくれた。認めてもらえた、と思った——きっと気のせいだけど」
9. ナナコ「先生、手順書が気になりましたか？」
10. ドクター「紙が反っていた」（物理的にクリアファイルの紙が反っていたのを直しただけ）
11. ナナコ「……ですよね」（瀬川に小さく苦笑して）「先生は整理整頓だけは得意なんです」

12. ドクター「感謝は、このコードに」
13. 瀬川が鞄を持ちクリアファイルをしまう。鉄の扉を**押して**開ける。
14. 廊下に出て、ふと立ち止まる。クリアファイルの表紙を見る——「社内申請システム マスター手順書」。
15. 瀬川（語り）:「私はもう、その答えを持っていたのかもしれない。15年間ずっと手順書で実践していたことを、コードに翻訳するだけでよかったんだ。マスター手順書 ＝ AbstractRequest。各申請の差分手順書 ＝ サブクラス。テンプレートメソッド——テンプレートという名前が、今ならしっくり来る。帰ったら、まず10本のクローンを統合しよう。そして、手順書のマスター参照方式の素晴らしさを、もう一度コードで証明してやるんだ」

---

## 勘違いシーンチェック

- [x] ドクターの行動は論理的か？ → クリアファイルの紙の反りを直すという、整頓好き（整頓だけは得意）な行動
- [x] 患者の誤解は感情的か？ → 「認めてもらえた」と受け取る（手順書を読んでくれた＝仕事を認めた）
- [x] 助手の反応は適切か？ → ドクターの真意（紙の反り）を淡々と明かすが、否定も肯定もしない

---

## 舞台設定整合性チェック（来院）

- [x] ドクターと助手は診療所に居る側 → ドクターは診察室のトリプルディスプレイ前、ナナコはカウンターで迎える
- [x] 患者が「来て」「帰る」側 → 瀬川が廊下を歩いて来院し、帰り際に鞄をしまい扉を押して退出
- [x] クリニック固有の小物 → O'Reilly本の壁、マザーボードの山、HHKB、トリプルディスプレイを使用
- [x] 扉の開閉 → 入室時「引いて」開ける、退室時「押して」開ける（外開き）
- [x] 患者のデスクは存在しない → USBメモリで持参（ドクターのマシンで作業）
- [x] 退場後のシーン → 廊下に出て立ち止まる（クリニック設定として自然）
