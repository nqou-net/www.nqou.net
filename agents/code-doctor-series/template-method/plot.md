# Plot Outline: Template Method — 臓器クローン症候群と標準手術プロトコル

## I. 導入 (Admission) — 往診：コピペの末路

**状況**: 金曜日の夕方、瀬戸は社内ツールのデータエクスポート機能にバグ報告を受けている。CSVエクスポートだけヘッダー行が重複する不具合。原因は先週のJSON側の修正をCSV側に反映し忘れたこと。上司から「また同じミス？」と言われ、額に脂汗が浮かぶ。

**ドクター登場**: 瀬戸が `export_csv()`, `export_json()`, `export_xml()` の3つのサブルーチンを並べて差分を目視確認しているとき、背後に気配。ドクターが無言でモニターを覗き込み、3つのサブルーチンを順にスクロールしている。

**ナナコの自己紹介**: 「大丈夫ですよ、ここはコード診療所です……あ、いえ、往診ですね」

**患者の心理**: 困惑と不信感。「同じ処理が3つあるのは仕様が違うからであって、設計が悪いわけじゃない……はず」という自己弁護。

## II. 検査 (Examination) — 触診：三つ子の臓器

**展開**: ドクターが3つのサブルーチンを並べて見比べる。指で行をなぞり、共通部分（データ取得、バリデーション、ログ出力）と差異部分（フォーマット変換）を黙って色分けしていく。

**ドクターの診断**:
- 「クローン臓器……3つ。同期不全」（眉をひそめながら）
- 三つの関数の共通行をハイライトし、差異部分だけが違うことを示す

**ナナコの通訳**:
- 「瀬戸さん、ドクターは『同じ臓器のコピーが3つ体内にある状態だ』とおっしゃっています。1つを治療しても、残り2つにも同じ手術が必要になる……それが今のバグの原因ですね」

**患者の反応**: 
- 「で、でも手順が微妙に違うんです！ CSVはカンマ区切りで、JSONは構造体で……」
- 自分でも言い訳が苦しいことに気づき始める

**Beforeコードの提示**: 3つのサブルーチンを並べ、共通部分がコピペされている様子を視覚的に示す。

## III. 処置 (Surgery) — 処方：標準手術プロトコル策定 (Template Method)

**展開**: ドクターが手袋を装着し、リファクタリングを開始する。

### Step 1: 骨格（プロトコル）の抽出
ドクターが共通の処理手順を `DataExporter` 基底クラスの `export()` メソッドに集約する。
- 「骨格を1つに。差異だけ委譲」
- ナナコ：「手術の手順書を1つ作って、臓器ごとに違う部分だけ別の先生に任せる…というイメージですね」

### Step 2: サブクラスへの委譲
CSV, JSON, XML それぞれのエクスポーターを作成。差異（フォーマット変換）だけをオーバーライドする。
- ドクター：「切除完了……クローンは不要になった」
- 共通処理が1箇所に統一され、形式ごとの差異だけが独立していることを示す

### Step 3: フック（任意の拡張点）
ドクターがフックメソッドを1つ追加する。XMLだけヘッダーに宣言が必要なケースに対応。
- ドクター：「フック……安全弁」
- ナナコ：「全員に必須ではないけれど、特定の患者さんだけが使える『オプション処置』のようなものですよ」

**カタルシス**: 600行のコピペが、基底クラス＋3つの小さなサブクラスに凝縮される。瀬戸が「消えた……あの600行が……」と呆然とする。

## IV. 予後 (Prognosis) — 術後経過：手順書の安心感

**テスト実行**: テストが全てグリーンに。しかもCSV・JSON・XMLで共通テストが1セット＋形式固有テストのみという構成に。

**改善の実感**: 瀬戸が「もし新しい形式（例えばYAML）が必要になったら？」と聞く。ナナコ：「サブクラスを1つ追加するだけですよ。骨格には触れません」

**勘違いシーン**:
- ドクターが帰り際、瀬戸のデスクに置いてあった缶コーヒー（瀬戸が飲みかけだったもの）を手に取り、ゴミ箱がないか周囲を見回す。見つからず、そのまま缶を瀬戸に差し出す。
- 瀬戸：「（先生……僕に差し入れ？ あんな無愛想な人なのに、こういう不器用な優しさがあるんだ……）」
- ナナコ：（瀬戸の表情を見て、何か言おうとしたが、小さく首を振ってそのまま荷物をまとめた）
- ドクター：（怪訝な顔で瀬戸を見るが、何も言わず背を向ける）

**別れ**:
- ドクター：「感謝は、このコードに」
- 瀬戸：「手順書を大切にします！ もうコピペはしません！」
- ナナコ：「お大事に、瀬戸さん。『同じことを二度書きたくなったら、それは骨格を探すサイン』ですよ」
