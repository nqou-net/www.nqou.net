# Plot Outline

## Scene 1: The Admission (違法建築の現場)
- **Place**: 自社ECサイト開発ルーム。深夜。
- **Status**: 患者（「効率重視」エンジニア）は、追加要望のメモに埋もれている。「検索条件に『在庫あり』かつ『セール対象外』かつ『カテゴリIDが...』...ああ、また結合文字を間違えた！」
- **Action**: ドクターと助手が現れる。ドクターは入室するなり、部屋の空気（コードの臭い）を嗅いで顔をしかめる。
- **Dialogue**:
  - 患者: 「誰だ！？ 忙しいんだ、邪魔しないでくれ！ このクエリを書き終えないと……」
  - ドクター: （無言でモニターの前に立ち、防塵マスクを取り出してつける）
  - 助手: 「失礼します。コードから『倒壊』の危険信号が出ていましたので。」

## Scene 2: The Diagnosis (構造あばき)
- **Examination**: ドクターが `build_search_sql` サブルーチンをスクロールする。マウスホイールを回す指が高速になり、最後はバンと机を叩いて止める。
- **Metaphor**:
  - ドクター: 「……柱がない。瓦礫の山だ。」
  - 助手: 「本来あるべき土台（Base Structure）がなく、現場の思いつきで部屋（条件句）を無計画に増築しています。このままでは、次の改修で全体が倒壊（システムダウン）します。」
  - ドクター: 「複雑性結合ヘルニア。……切除する。」
- **Patient's Reaction**: 「でも、これが一番速いんです！ 文字列を足すだけですから！ クラスなんて作ってる暇はない！」

## Scene 3: The Surgery (プレハブ工法の導入)
- **Direction**: `SearchQueryBuilder` クラスの導入。Perl v5.36の機能（class featureではなく、package + signatures）を活用。
- **Step 1**: 土台（Base Query）の定義。`new` で初期SQLを持つ。
- **Step 2**: 部材（Conditions）の規格化。`with_category`, `with_price_range`, `with_stock` などのメソッドを作成。各メソッドは自分自身（`$self`）を返す。
- **Step 3**: 組み上げ（Build）。`build` メソッドでプレースホルダー付きSQLとバインドパラメータを生成。
- **Highlight**:
  - Before: `if ($args{category}) { $sql .= " AND category_id = ?"; push @bind, ... }` の無限連鎖。
  - After: `$builder->with_category($id)->with_stock(1)->build`
  - 視覚的変化: 縦に伸びきった500行のプロシージャが、メソッドチェーンによる宣言的な記述に圧縮される。
  - ドクター: （美しいメソッドチェーンを見て、満足げに頷き、指でなぞる）

## Scene 4: The Prognosis (引き渡し)
- **Comedy (The Misunderstanding)**:
  - 手術完了後、ドクターが患者に自分の「ペン（高級万年筆）」を渡す。
  - 患者: 「こ、これを俺に？ 『設計者としての誇りを持て』ということですね……！」（涙ぐむ）
  - 助手: （実はドクターがそこに置き忘れたことに気づいているが、あえて止めない）「……ええ、そのペンで美しい設計図を描いてください。」
- **Closing**: 患者はBuilderパターンを使って、次の「ソート順変更」要件を瞬時に実装。「これが……アーキテクチャの力か」。ドクターたちは既に去っている。
