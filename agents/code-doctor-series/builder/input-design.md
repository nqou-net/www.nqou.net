# Input Design: Builder

> **差別化ポイント**: 既存のBuilder連載（SQLクエリビルダー・全8回）とは題材を完全に変える。
> コードドクターの核心＝「**複雑なオブジェクトの段階的構築を、構築手順から分離する**」を前面に。
> Builderの本質は「同じ構築プロセスで異なる表現を作れること」——Factory系とは問題の性質が異なる点を明確にする。

---

## テーマ3案

### 案A（王道）: メール通知メッセージの組み立て

- **一行説明**: 宛先・件名・本文・添付ファイル・CC/BCCなど多数のパラメータを持つ通知メールを段階的に構築する
- **パターンとの接点**: メールの構成要素が多様で組み合わせが膨大。必須項目と任意項目が混在し、テレスコーピングコンストラクタかハッシュ引数の無秩序な肥大化が発生
- **読者像**: バックエンドエンジニア、社内ツール開発者。メール送信はPerlの王道（MIME系モジュール文化）

### 案B（革新）: インフラ構成マニフェストの生成

- **一行説明**: サーバー・ネットワーク・ストレージ・監視設定などのインフラ構成定義を段階的に組み立てるツール
- **パターンとの接点**: 構成要素間に依存関係（ストレージ確保→マウントポイント設定→監視設定）があり、生成順序が重要。手順を間違えると無効な構成が生まれる
- **読者像**: DevOps/SREエンジニア、構成管理ツールの利用者

### 案C（逆転）: テスト用フィクスチャー（テストデータ）の構築

- **一行説明**: 単体テスト用の複雑なテストデータ（ユーザー＋注文＋商品＋配送先）をテストケースごとに組み立てる
- **パターンとの接点**: テストごとに「ほぼ同じだけど一部だけ違う」データが必要。手書きでハッシュリファレンスを量産→メンテ不能。Builderで「デフォルト値＋必要な差分だけ指定」の段階的構築
- **読者像**: テスト文化に関心のある中級エンジニア。「テストが辛い」は万人の悩み

---

## 患者3案

### 案A（共感型）: 25歳、バックエンドエンジニア、2年目

- **属性**: Webアプリ開発、エンジニア歴2年
- **性格キーワード**: 素直、頑張り屋、「動けばOK」思考
- **背景**: メール送信機能を担当。最初は単純だったが、要件追加のたびにサブルーチンの引数が増殖。「あと一つ引数を足すだけ」を繰り返した結果、引数が12個に
- **主訴**: 「引数の順番を間違えると、上司にBCCで送るはずのメールが全社一斉送信になって…もう、怖くて触れません」
- **コメディポテンシャル**: 引数の順番暗記を「呪文」として唱えるシーン。「to, cc, bcc, subject, body, attach, reply_to, priority, charset, template, footer, signature！」と毎回呟く

### 案B（意外型）: 42歳、テックリード、15年目

- **属性**: Perlベテラン、OSSコントリビュータ歴あり、テックリード
- **性格キーワード**: 博識、理論派、「知っているのに実践できない」
- **背景**: Builderパターンを知識としては知っている。部下のコードレビューで「これはBuilder使うべきだ」と指摘した直後、自分のテストコードが同じ問題を抱えていることに気づく
- **主訴**: 「知識としては完璧に理解してるんです。ただ、自分のテストコードだけは…なぜか特別だと思ってて…」
- **コメディポテンシャル**: レビューで後輩に偉そうに指摘した自分のコメントを、ドクターに突きつけられるシーン。「先生、それは僕のGitLabのコメントです…」。知識と実践の落差という知的ギャグ

### 案C（ギャップ型）: 30歳、元パティシエ転身エンジニア、コード歴3年

- **属性**: 調理師専門学校卒→ケーキ店勤務→プログラミングスクール→Web開発、コード歴3年
- **性格キーワード**: レシピ感覚でコードを書く、手順に忠実、「分量（パラメータ）の管理」が得意だが構造化は苦手
- **背景**: テストデータ作成を「レシピ」のように捉えている。材料（パラメータ）を並べてハッシュリファレンスを手書きで量産。テストケースが50個を超え、1箇所のフィールド変更で50ファイル修正
- **主訴**: 「レシピなら分量を変えるだけなのに、コードだと同じようにいかなくて…全部手作業で直すしか…」
- **コメディポテンシャル**: 「仕込み（テストデータ準備）が本番（テスト実行）の10倍時間がかかる」。料理の比喩がナナコの翻訳と絶妙にかぶる→ナナコが「あ、私の出番が…」と戸惑うメタ的ギャグ

---

## 症状3案

### 案A（典型症状）: テレスコーピング引数中毒

- **技術的症状**: サブルーチンの引数が12個以上に膨張。引数の順序に依存し、省略不可能な`undef`が連続。新しいオプションを追加するたびに既存の呼び出し元すべてを修正
- **医療メタファー**: 「急性多臓器肥大症」— 1つの臓器（関数）に機能を詰め込みすぎ、引数という栄養管が12本も刺さっている。管の順番を間違えると別の臓器に薬が流れ込む
- **重症度**: 中症
- **Before/Afterの見込み**: 12引数の位置依存サブルーチン → Builderで`->to('xxx')->subject('yyy')->build()`のメソッドチェイン
- **読者の「あっ」ポイント**: 「引数に`undef, undef, undef`って書いたことある…」

### 案B（複合症状）: テストデータ壊死性筋膜炎

- **技術的症状**: テストフィクスチャーのハッシュリファレンスがコピペで50箇所に散在。スキーマ変更のたびに全テストファイルを手修正。修正漏れでテストが偽グリーン（通るけど実際は壊れている）
- **医療メタファー**: 「壊死性筋膜炎（コピペ壊疽）」— 同じ組織（データ構造）のコピーが全身に転移し、1箇所の感染（スキーマ変更）で全身壊死が連鎖。しかも壊死部が健康に見える（偽グリーン）のが最も危険
- **重症度**: 重症
- **Before/Afterの見込み**: 50箇所のハードコードデータ → `TestDataBuilder->new->with_user(...)->with_order(...)->build()`で差分のみ指定
- **読者の「あっ」ポイント**: 「テストデータのコピペ、まさに今やってる…しかも偽グリーン怖すぎる」

### 案C（潜伏症状）: 引数ハッシュ不定形腫瘍

- **技術的症状**: 「ハッシュ引数にすれば順序問題は解決」と思い`%args`を導入。しかしキー名のタイポが無検出で通過、必須キーの検証なし、デフォルト値の散在。コードは動くが、意図しない組み合わせが本番で黙って不正データを生成
- **医療メタファー**: 「不定形腫瘍（ミュータブル・マス）」— 一見健康体（ハッシュ引数で柔軟）に見えるが、内部に形の定まらない腫瘍（未検証のキー群）が潜伏。成長するまで自覚症状なし
- **重症度**: 重症（自覚なきまま本番データ汚染）
- **Before/Afterの見込み**: 無検証ハッシュ引数 → Builderで構築ステップを型付け、`build()`時にバリデーション強制
- **読者の「あっ」ポイント**: 「ハッシュ引数にすれば解決と思ってた…タイポが通るのか…」

---

## 多角的評価

### Step-Back思考

**この記事で読者に持ち帰ってもらいたいもの**:

1. Builderは「**複雑なオブジェクトを段階的に、安全に構築する**」パターン
2. テレスコーピングコンストラクタやハッシュ引数の「なんとなく動く」状態の危険性
3. 「知識として知っている」と「実践で使える」の間にある溝（＝記事のコメディ軸としても活用）
4. 既存Builder連載（SQLクエリビルダー）とは切り口が完全に異なる題材であること

### テーマ評価

| 評価軸 | 案A（メール通知） | 案B（インフラ構成） | 案C（テストデータ） |
|--------|:---:|:---:|:---:|
| ① 読者共感度 | 4 | 3 | 5 |
| ② メタファー適合度 | 4 | 3 | 4 |
| ③ コメディ発展性 | 3 | 2 | 5 |
| ④ 教育価値 | 4 | 4 | 5 |
| ⑤ 差別化 | 3 | 4 | 5 |
| **合計** | **18** | **16** | **24** |
| **推奨理由** | 王道の安定感 | 実務的だが読者層が狭い | 全員が共感する「テスト辛い」問題 |

### 患者評価

| 評価軸 | 案A（25歳・新人） | 案B（42歳・テックリード） | 案C（30歳・元パティシエ） |
|--------|:---:|:---:|:---:|
| ① 読者共感度 | 4 | 5 | 3 |
| ② メタファー適合度 | 3 | 4 | 4 |
| ③ コメディ発展性 | 3 | 5 | 5 |
| ④ 教育価値 | 3 | 5 | 3 |
| ⑤ 差別化 | 3 | 5 | 4 |
| **合計** | **16** | **24** | **19** |
| **推奨理由** | 安心の共感キャラ | 「知ってるのにできない」の知的ギャグ | ギャップの面白さ |

### 症状評価

| 評価軸 | 案A（多臓器肥大症） | 案B（コピペ壊疽） | 案C（不定形腫瘍） |
|--------|:---:|:---:|:---:|
| ① 読者共感度 | 5 | 4 | 4 |
| ② メタファー適合度 | 5 | 4 | 4 |
| ③ コメディ発展性 | 4 | 3 | 3 |
| ④ 教育価値 | 5 | 4 | 4 |
| ⑤ 差別化 | 3 | 4 | 5 |
| **合計** | **22** | **19** | **20** |
| **推奨理由** | 「12本の管」で視覚的にわかりやすい | コピペの恐怖 | 潜伏型ならではの怖さ |

---

## 相乗効果の検討

### 最高スコア組合せ: テーマC × 患者B × 症状A（総合スコア: 70/75）

| 組合せ | 整合性 | 理由 |
|--------|:---:|------|
| テーマC × 患者B | ⚠️ | テックリードがテストデータで困っている設定は可能だが、テストを軽視するテックリードは少し不自然。ただし「後輩のコードは完璧にレビューするが自分のテストコードは…」という一貫したキャラなら成立 |
| テーマC × 症状A | ❌ | テストデータ構築と「引数12個の関数」は直接結びつきにくい。テストデータならコピペ壊疽（症状B）の方が自然 |
| 患者B × 症状A | ✅ | 知識はあるのに自分の関数は引数12個→知行不一致で自然 |

> [!WARNING]
> 最高スコアの単純合算では整合性に問題あり。テーマとの噛み合わせを再検討する。

### 推奨組合せ: テーマC × 患者B × 症状B（総合スコア: 67/75）

| 組合せ | 整合性 | 理由 |
|--------|:---:|------|
| テーマC × 患者B | ✅ | テックリードが後輩には「テストを書け」と言いつつ、自分のテストコードはコピペだらけ。知行不一致の核心がテストデータという「聖域」にある |
| テーマC × 症状B | ✅ | テストフィクスチャーのコピペ→スキーマ変更で全身壊死→Builderで差分だけ指定。文句なしの整合性 |
| 患者B × 症状B | ✅ | 15年のベテランが「自分のテストコードは特別」と思い込み、コピペ壊疽に気づかない。知識の盲点＝自分自身のコード |

**ストーリーライン**:
42歳のテックリードが、後輩のPull Requestレビューで「テストデータはBuilderパターンを使え」とコメントした直後、社内で大規模なスキーマ変更が発生。自分が書いた50箇所のテストフィクスチャーがすべて手動修正が必要になり、しかも修正漏れで偽グリーンのテストが本番障害を見逃す。「知っているのにやっていない」という知的恥辱を抱えてコード診療所を訪れる——Builderパターンの「なぜ必要か」を「知識 vs 実践」の物語として描く。

### 代替組合せ: テーマA × 患者A × 症状A（総合スコア: 56/75）

テーマ・患者・症状すべて王道。安定感はあるが記憶に残りにくい。テーマCの方がBuilder連載（SQLクエリビルダー）との差別化が明確。

---

## 選定結果

### 採用案

| 要素 | 採用案 | スコア |
|------|--------|--------|
| テーマ | テストフィクスチャーの構築（逆転） | 24/25 |
| 患者 | 42歳・テックリード「知ってるのにできない」（意外型） | 24/25 |
| 症状 | テストデータ壊死性筋膜炎・コピペ壊疽（複合症状） | 19/25 |

### 選定理由

テーマの共感度（全員が「テストデータ辛い」と思う）と患者の知的コメディ（「知っているのにやっていない」ギャグ）が相乗効果を発揮。症状のスコアは最高ではないが、テーマ・患者との整合性が完璧であり、**3要素の総合バランスを優先**した。「コピペ壊疽」という視覚的メタファーはコードドクターの医療世界観に自然に溶け込む。

既存Builder連載（SQLクエリビルダー）やFactory系記事（データ連携、レポート生成）とはテーマ・切り口・患者像のすべてで差別化されている。

### 3要素の整合性

- テーマ × 患者: ✅ テックリードが後輩に「Builder使え」と指摘→自分のテストが同じ問題。知行不一致
- テーマ × 症状: ✅ テストフィクスチャーのコピペ50箇所→スキーマ変更で全滅→偽グリーン。リアル
- 患者 × 症状: ✅ 15年ベテランの盲点＝「自分のコードだけは例外」。コピペ壊疽の発見が遅れる

## テーマ詳細

- **テーマ名**: テスト用フィクスチャー（テストデータ）の構築
- **一行説明**: 単体テスト用の複雑なテストデータ（ユーザー＋注文＋商品＋配送先）をテストケースごとに組み立てる
- **パターンとの接点**: テストごとに「ほぼ同じだけど一部だけ違う」データが必要。手書きでハッシュリファレンスを量産→メンテ不能。Builderで「デフォルト値＋必要な差分だけ指定」の段階的構築
- **読者像**: テスト文化に関心のある中級エンジニア。「テストが辛い」は万人の悩み
- **SQLクエリビルダーとの差別化**: SQLの構文構築 vs テストデータの構造構築。同じBuilderでも問題領域が根本的に異なる

## 患者詳細

- **属性**: 42歳、テックリード、エンジニア歴15年
- **性格キーワード**: 博識、理論派、「知っているのに実践できない」
- **一人称**: 「僕」（知的で穏やかな口調だが、プライドは高い）
- **背景**: Perlベテラン。OSSコントリビュータ歴もあり、チーム内では「パターンに詳しい人」として信頼されている。後輩のコードレビューで「これはBuilder使うべきだ」と指摘した翌週、大規模スキーマ変更で自分のテストコードが壊滅。50箇所のハッシュリファレンスを手修正する中で「あれ、これ僕が指摘した問題と同じでは…」と気づく
- **主訴**: 「知識としては完璧に理解してるんです。ただ、自分のテストコードだけは…特別だと思ってたんです…」
- **コメディポテンシャル**: ドクターが黙ってGitLabのコメント画面を開く→患者自身の「Builder使え」コメントが映し出される→「先生、それは僕のコメントです…」の最大級の知的恥辱シーン。ナナコが「ご自分のコードのレビューもされてみてはいかがですか？」と丁寧に追い打ち

## 症状詳細

- **技術的症状**: テストフィクスチャーのハッシュリファレンスがコピペで50箇所に散在。スキーマ変更のたびに全テストファイルを手修正。修正漏れでテストが偽グリーン（通るけど実際は壊れている）
- **医療メタファー**: 「壊死性筋膜炎（コピペ壊疽）」— 同じ組織（データ構造）のコピーが全身に転移し、1箇所の感染（スキーマ変更）で全身壊死が連鎖。しかも壊死部が健康に見える（偽グリーン）のが最も危険
- **重症度**: 重症
- **Before/Afterの見込み**: 50箇所のハードコードデータ → `TestDataBuilder->new->with_user(...)->with_order(...)->build()`で差分のみ指定
- **読者の「あっ」ポイント**: 「テストデータのコピペ、まさに今やってる…しかも偽グリーン怖すぎる」

---

## 評価サマリー

### スコア一覧

| 要素 | 案A | 案B | 案C | 採用 |
|------|:---:|:---:|:---:|:----:|
| テーマ | 18 | 16 | **24** | 案C |
| 患者 | 16 | **24** | 19 | 案B |
| 症状 | **22** | 19 | 20 | 案B（整合性優先） |

### 特記事項

- 症状は案A（22点）が最高スコアだが、テーマC（テストデータ）との整合性で案B（コピペ壊疽）を採用
- テーマC × 患者B × 症状Bの組合せで、3要素すべてが「テストコード」を軸に整合
- 「知っているのにやっていない」という知的コメディは、過去の患者像（新人の共感型、CTO の合理型、デザイナーのギャップ型）と完全に差別化

---

## 不採用案（参考）

| 要素 | 不採用案 | スコア | 不採用理由 |
|------|---------|:------:|-----------| 
| テーマ | 案A（メール通知） | 18/25 | 王道だが既存Builder連載（SQL）との差別化が弱い |
| テーマ | 案B（インフラ構成） | 16/25 | DevOps寄りで読者層が狭い。AB Factory記事のテーマBと類似 |
| 患者 | 案A（25歳・新人） | 16/25 | 過去記事の患者と年齢・立場が類似しすぎる |
| 患者 | 案C（30歳・元パティシエ） | 19/25 | 面白いが、AB Factory記事の元デザイナーとキャラ軸が類似（異業種転入） |
| 症状 | 案A（多臓器肥大症） | 22/25 | スコア最高だがテーマC（テストデータ）との整合性が低い |
| 症状 | 案C（不定形腫瘍） | 20/25 | 潜伏型として魅力的だがAB Factory記事の潜伏性クロスマッチ不全と近い |
