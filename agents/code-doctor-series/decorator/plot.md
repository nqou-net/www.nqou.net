# Plot Outline: Decorator Pattern — 包帯過剰巻着症候群

> **設定**: 往診（患者のオフィス）
> **患者一人称**: 私

---

## I. 導入 — 往診

### 状況
金曜の夕方。ヨリコが自席で頭を抱えている。モニタには200行超の `process_ringi()` 関数。来週月曜から監査ログ機能を追加しなければならないが、既存のif-elseの海にどこから手をつければいいのかわからない。隣の席の若手エンジニアが「あの……コード診療所って知ってます？」と小声で言う。

### ドクター登場
ヨリコが半信半疑で連絡先に電話すると、30分後、フロアの入口に黒い鞄を持った長身の男と、穏やかな笑顔の女性が現れる。

ナナコ:「大丈夫ですよ、ここはコード診療所です……あ、いえ、往診ですね」

ヨリコは「どちら様ですか？」と訊くより先に、男が自分のデスクの横まで無言で歩いてきて、モニタの画面を覗き込んでいることに気づく。

### 心理状態
ヨリコは戸惑い半分、安堵半分。プログラミングの「お医者さん」なんて聞いたことがないが、この200行の関数を前にして途方に暮れている今、藁にもすがりたい気分。ただし、自分のコードが「動いている」ことだけは自信がある。「ちゃんと動いてるんですけど」と前置きせずにはいられない。

### キーモーメント
ヨリコのデスクの横に貼ってある紙——手書きの稟議回覧ルート図。付箋がびっしり貼られ、「10万以上→係長＋課長」「50万以上→部長も」「100万以上→役員決裁」と書かれている。ドクターの視線がそこで止まる。

ドクター:（図を指で辿りながら）「……これが、本体か」
ヨリコ:「あ、それは前の部署のときの……紙の稟議書の回し方のメモで」
ドクター:「……コードは？」
ヨリコ:「こ、これです」（モニタを指す）

ドクターが壁の紙とモニタのコードを交互に見る。何かに気づいたように、わずかに目を細める。

---

## II. 検査 — 触診

### 展開
ドクターがヨリコの椅子を借りて（ヨリコは立ち上がる）、コードをスクロールし始める。200行の関数を20秒ほどで読み切り、顔をしかめる。

### ドクターの診断
ドクター:（モニタを指で弾いて）「……巻きすぎだ」
ヨリコ:「え？」
ナナコ:（ヨリコに向かって優しく）「傷口の上に包帯を何重にも巻いてしまっている状態です。最初はちゃんと傷を保護できていたんですが、新しい傷ができるたびに上から包帯を足して……もうどこが元の傷口なのかわからなくなっているんです」

### 判子変数の発見
ドクターがスクロールし、`$needs_buchou_hanko`, `$needs_yakuin_hanko`, `$hanko_count`, `$ringi_status` という変数名を発見。

ドクター:「……判子（hanko）」
ナナコ:（少し目を丸くして）「変数名が……判子ですね」
ヨリコ:（頬を赤らめて）「だ、だってそう考えないと分からないじゃないですか。部長の判子が要るか要らないか、って考えた方が直感的で……」

### フラグ変数の解剖
ドクターが `$needs_buchou_hanko`, `$needs_log`, `$needs_mail`, `$needs_audit` と4つのフラグ変数を列挙し、指を折って数える。

ドクター:「4つ。……組み合わせ16通り」
ナナコ:「フラグが4つあると、組み合わせは2の4乗——16パターンになります。今はif文で全部書き分けていますが、新しいフラグが1つ増えるたびに……」
ヨリコ:「倍……に、なる……？」
ナナコ:「はい。来月の監査ログ機能を入れると、5つのフラグで32パターンです」

ヨリコの胃がきゅっと縮む。

---

## III. 処置 — 包帯解体・再巻着術

### 展開（意外な転回）

**ありきたりな展開を除外**:
- ❌ 「サブクラスを作りましょう」→ 患者はif-else型の症状なので不自然
- ❌ 「まずインターフェースから」→ 説明が抽象的すぎて患者の背景に合わない
- ❌ ドクターがホワイトボードで図解 → Bridgeの紙切りと差別化できない

**選択した意外な展開**:
ドクターがヨリコの壁に貼ってある「紙の稟議回覧ルート図」の付箋を1枚ずつ剥がし始める。

ヨリコ:「ちょ、ちょっと！それ私のメモ……！」
ドクター:（無言で付箋を並べ替えている）

ナナコ:「大丈夫ですよ。先生は今、付箋を**役割ごと**に分類しているんです」

ドクターが付箋を5つの山に分ける:
- 「基本承認フロー」（コア）
- 「ログ記録」
- 「メール通知」
- 「監査証跡」
- 「役員承認」

ドクター:「この図のほうが、正しい」
ナナコ:「紙の稟議書では、承認ステップを付箋で追加したり外したりできましたよね？ プログラムでも同じことをしましょう——**包帯を1枚ずつ、必要なだけ巻く**んです」

ヨリコ:「……あ。付箋を貼るように？」
ナナコ:「はい。これを **Decorator（デコレーター）パターン** と呼びます。基本の処理をラッピングして、上から機能を重ねていくんです。付箋を貼る順番で、承認フローが変わる——紙の世界でやっていたことと、考え方はまったく同じです」

### Before Code（患部）の提示
ドクターが画面に映し出す200行超の `process_ringi()` 関数。if-elsif-elsif...、フラグ変数の組み合わせチェック、同じような処理の繰り返し。

### After Code（処方）の実装
ドクターが黙々と打鍵を始める。ヨリコのデスクに置いた自分のキーボード（HHKB）の乾いた打鍵音が静かなオフィスに響く。

ナナコが随時解説:
1. まず `RingiProcessor` ロール（共通インターフェース）を定義——`process()` メソッドのみ
2. `BasicApproval` クラス（コア処理）——稟議の基本承認フローだけを行う裸の傷口
3. `RingiDecorator` ベースクラス——内部に `$inner` を持ち、`process()` を委譲する「包帯の型紙」
4. `WithLogging` Decorator——ログ記録を追加する包帯
5. `WithMailNotification` Decorator——メール通知を追加する包帯
6. `WithAuditTrail` Decorator——監査証跡を追加する包帯
7. `WithExecutiveApproval` Decorator——役員承認を追加する包帯

### カタルシスポイント
200行のif-else関数が消え、各クラスが20行以下に。ヨリコが画面を覗き込む。

ナナコ:「組み立て方を見てみましょう。金額が100万以上の稟議なら——」
（コードを指す）
```
BasicApproval → WithLogging → WithMailNotification → WithAuditTrail → WithExecutiveApproval
```
ナナコ:「逆に、10万未満の軽い稟議なら——」
```
BasicApproval → WithLogging
```
ナナコ:「付箋の数を変えるだけです。if文は1行もありません」

ヨリコ:「……来月の監査ログ機能は？」
ナナコ:「もう入っていますよ。`WithAuditTrail` という付箋——いえ、Decoratorを1つ作っただけです」
ヨリコ:「……200行のif文に手を入れなくていい？」
ナナコ:「はい。既存のコードは1行も触っていません」

ヨリコの目がみるみる輝く。紙の世界でやっていたことが、コードでもできる。付箋を剥がしたり貼ったりするだけで、承認フローが変わる。

---

## IV. 予後 — 退院指導

### 術後確認
ヨリコが自分の手で新しいDecorator `WithEmergencyFlag`（緊急フラグ付与）を追加してみる。20行のクラスを1つ書いて、組み立て行に1つ追加するだけ。テストが通る。

ヨリコ:「以前なら、if文に3箇所追加して、フラグ変数を1個増やして、全32パターンのテストを直して……」
ナナコ:「今は？」
ヨリコ:「……クラス1つ。テスト1つ。終わり」

### 勘違いシーン
帰り支度をするドクターが、鞄の中から黒い小さな箱を取り出す。ヨリコの目には、それが上等な印鑑ケースに見える。

ヨリコ:（心の中で）「先生も……判子を使うんだ。この人もどこかで紙の世界を大事にしているのかもしれない……なんだか、親近感がわく」

ナナコ:（ドクターにウェットティッシュを渡しながら、小声で）「先生、USBアダプタのケース、印鑑ケースに見えますよ」
ドクター:（首を傾げて、ケースを見つめる）「……？」

### ドクターの最後の一言
ドクターが鞄を閉じ、出口に向かう。振り返らずに一言。

ドクター:「……判子。変数名」
ナナコ:「あの……`$needs_buchou_hanko` は……さすがにリネームしていただけると」
ヨリコ:（苦笑）「……はい。`$needs_manager_approval` にします」

### クロージング
ドクターとナナコがオフィスのドアを抜けて去っていく。ヨリコは自席に戻り、壁を見る。付箋が5つの山に分類されたままだ。

ヨリコ:（心の中で）「包帯を巻き直す。付箋を貼り直す。……やっていることは同じだったんだ。紙でもコードでも」

モニタには、6つの小さなクラスファイルが並んでいる。200行の巨大なif文はもう、どこにもない。

---

## メタ情報

### 舞台設定チェック
- [x] 往診設定: ドクターとナナコが来て帰る側、ヨリコは自席にいる側
- [x] 帰り支度の主語: ドクター（往診側）
- [x] ドアの開閉: 患者のオフィス環境に依存（特に外開き制約なし）
- [x] クリニック固有小物: 存在しない（ドクターの鞄・HHKBは持参）✓
- [x] 患者のデスク/自席: 存在する（往診なので自然）✓
- [x] 退場の描写: ドクターとナナコがオフィスを去る ✓

### 勘違いシーン配置
- **配置**: IV. 予後（帰り支度中）
- **トリガー**: ドクターがUSBアダプタのケース（黒い小箱）を鞄から取り出す
- **誤解**: ヨリコが「上等な印鑑ケース」と見間違え、「先生も判子派」と親近感を覚える（テーマ「判子」と連動）
- **助手の反応**: 小声で指摘するが、ドクターは何のことかわからない ✓

### 意外性の設計
- **核心（ありきたり除外）**: ❌「ホワイトボードでUML図解」「サブクラスに分けましょう」ではなく、✅ ヨリコが壁に貼っていた紙の稟議回覧ルート図の**付箋を物理的に分類する**ことで、Decoratorの概念を患者の既存知識（紙の付箋管理）から自然に導く
- **読者の予想裏切り**: 「非エンジニアの患者だから技術理解に苦しむはず」→ 実は紙の付箋管理の経験がDecoratorの「着脱可能なラッパー」の理解に直結していた
- **勘違いシーンの連動**: BridgeのExcel→ピボットテーブルと差別化し、「判子/印鑑」というテーマ固有の勘違いネタにすることで、技術シナリオと自然に絡む
