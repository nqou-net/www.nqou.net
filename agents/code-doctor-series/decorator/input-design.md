# Input Design: Decorator

## Step-Back思考

> **この記事で読者に持ち帰ってもらいたいこと**:
> 機能追加のたびにサブクラスを増やす（あるいは元のクラスを直接書き換える）のではなく、小さな「ラッパー」で振る舞いを重ね掛けする。Decoratorパターンは既存コードを壊さずに機能を追加するための「非破壊的な包帯」である。
> 既存のDecorator関連記事（秘密のメッセンジャー: Observer×Decorator×Command複合、テキスト処理パイプライン: CoR+Decorator）とは異なり、**Decorator単体の本質**——動的な責務追加と組み合わせの柔軟性——に焦点を当て、医療メタファーで描く。

---

## テーマ3案

### 案A（王道）: ログ出力システム

- **テーマ名**: 多機能ログフォーマッター
- **一行説明**: ベースのログ出力に、タイムスタンプ付与・フォーマット整形・ファイル出力・暗号化などの機能を動的に追加する
- **パターンとの接点**: ログ出力という単一の振る舞いに対し、必要な機能を組み合わせで重ね掛けする典型例。サブクラス爆発ではなく、Decoratorで機能を選択的に積み重ねる
- **読者像**: 自前のロガーを書いた経験があるバックエンド開発者

### 案B（革新）: カフェのドリンクカスタマイズ

- **テーマ名**: カフェのドリンクオーダーシステム
- **一行説明**: ベースドリンク（エスプレッソ・紅茶）にシロップ・ミルク・ホイップ・サイズアップなどのトッピングを自由に重ね掛けするオーダーシステム
- **パターンとの接点**: ベースの飲み物にトッピングを「巻く」行為がDecoratorそのもの。価格計算と説明文の生成が各層で追加される
- **読者像**: HeadFirstデザインパターンを読んだことがある人。身近な例で理解が深まるタイプ

### 案C（逆転）: 社内承認ワークフロー

- **テーマ名**: 社内稟議書の承認フロー動的構築
- **一行説明**: 基本の稟議書処理に、金額チェック・部門長承認・役員承認・監査ログ・メール通知などの処理を条件に応じて動的に追加するワークフロー
- **パターンとの接点**: 一見Chain of Responsibilityに見えるが、**同じインターフェースで責務を積み重ねる**点がDecorator。承認ステップはフィルタ（通過/拒否）ではなく、**処理の前後に付加情報を追加する**動作。稟議書の金額や部門に応じてDecoratorを動的に組み替える
- **読者像**: 業務システムを扱うエンジニア。「承認フローの条件分岐が地獄」を経験した人

---

## テーマ評価

| 評価軸 | 案A（王道） | 案B（革新） | 案C（逆転） |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 3 | 5 |
| ② メタファー適合度 | 3 | 4 | 4 |
| ③ コメディ発展性 | 2 | 4 | 5 |
| ④ 教育価値 | 4 | 3 | 5 |
| ⑤ 差別化 | 2 | 2 | 5 |
| **合計** | **15** | **16** | **24** |
| **推奨理由** | 定番すぎて差別化困難 | Head Firstと被り新鮮味がない | 業務の泥沼とDecoratorの本質が直結、CoRとの違いも教育できる |

---

## 患者3案

### 案A（王道）: まじめな若手バックエンドエンジニア

- **属性**: 25歳男性、Web系企業2年目、サーバーサイド担当
- **性格キーワード**: 素直、石橋を叩いて渡る、先輩の言うことは絶対
- **背景**: 先輩に「機能追加はサブクラス作れ」と教わり、忠実に実行。気づけば承認関連クラスが20個超
- **主訴**: 「仕様変更のたびにクラスが3つ増えるんです……もう名前が思いつきません」
- **コメディポテンシャル**: クラス名が `ApprovalWithLogAndMailAndAudit` のように長くなり、ドクターがファイル一覧を見て無言で閉じる

### 案B（革新）: 完璧主義のテックリード

- **属性**: 36歳男性、メガベンチャーのテックリード10年目
- **性格キーワード**: 美学がある、設計は俺の領域、コードレビューが厳しい
- **背景**: 自分の設計した承認フローシステムが「堅牢」だと自負。しかし実際は条件分岐の要塞化で部下の誰も触れない
- **主訴**: 「設計は完璧です。ただ、不思議なことにメンバーの生産性が上がらなくて」
- **コメディポテンシャル**: 自分のコードを「芸術」と呼ぶ。ドクターが「……可読性ゼロ」と呟き、凍りつく

### 案C（逆転）: 総務のおばちゃんSE

- **属性**: 45歳女性、元総務部で紙の稟議書を20年処理→DX推進でプログラマに転身1年目
- **性格キーワード**: おおらか、紙の世界の達人、「動けばヨシ！」
- **背景**: 紙の稟議書の回覧ルートを完璧に熟知。デジタル化の際に「紙の世界の常識」をそのままコードに翻訳。各ルートをif-elseで完全ハードコード
- **主訴**: 「紙ならルート変更は付箋1枚で済むんですけど、プログラムだと大改修になっちゃって……」
- **コメディポテンシャル**: 変数名が `$hanko_count`（判子の数）、`$ringi_status`（稟議ステータス）。紙の稟議用語でプログラムを説明する。「このif文は、係長の判子を押すところです」。ドクターが「……判子？」と眉をひそめる

---

## 患者評価

| 評価軸 | 案A（王道） | 案B（革新） | 案C（逆転） |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 4 | 3 | 5 |
| ② メタファー適合度 | 3 | 3 | 5 |
| ③ コメディ発展性 | 3 | 4 | 5 |
| ④ 教育価値 | 3 | 4 | 4 |
| ⑤ 差別化 | 2 | 3 | 5 |
| **合計** | **15** | **17** | **24** |
| **推奨理由** | 没個性 | 面白いが既出感 | 紙の世界→デジタルの翻訳ギャップが新鮮で共感を呼ぶ |

---

## 症状3案

### 案A（王道）: サブクラス爆発症候群

- **技術的症状**: 承認ステップの各組み合わせごとにサブクラスを生成。`ApprovalWithLog`, `ApprovalWithMail`, `ApprovalWithLogAndMail`, `ApprovalWithLogAndMailAndAudit`... 2^N個のクラスが発生
- **医療メタファー**: 「細胞分裂暴走——1つの処置（承認）のために増殖し続ける変異細胞（サブクラス）が健全な組織（コードベース）を圧迫している」
- **重症度**: 重症
- **Before/Afterの見込み**: 15+のサブクラス → ベース1 + Decorator5 = 6クラス。組み合わせは自由
- **読者の「あっ」ポイント**: 「うちのAbstract〇〇クラス群、まさにこれだ……」

### 案B（革新）: if-else包帯ぐるぐる巻き

- **技術的症状**: 1つの巨大関数 `process_approval()` 内に、稟議の金額・部門・役職に応じた条件分岐が200行以上のif-elsif-elseネストで存在。フラグ変数（`$needs_log`, `$needs_mail`, `$needs_audit`）の組み合わせ爆発
- **医療メタファー**: 「包帯過剰巻着症候群——傷口（コア処理）の上に、包帯（条件分岐）を何重にも巻きすぎて、もはやどこが傷口かわからない。包帯を剥がすと出血（バグ）する」
- **重症度**: 重症
- **Before/Afterの見込み**: 200行超のif-else → Decorator適用で各20行程度のラッパークラスに分離。フラグ変数全廃
- **読者の「あっ」ポイント**: 「フラグ変数の組み合わせでif書いてた……それDecoratorで解決できたのか」

### 案C（逆転）: 元メソッド肥大症（God Method）

- **技術的症状**: `process_ringi()` が500行の巨大メソッド。承認ログ記録、メール通知、監査証跡、金額チェック、部門チェックが全て1メソッドに直書き。変更しようとすると必ず別の機能が壊れる
- **医療メタファー**: 「肥大化臓器症——1つの臓器（メソッド）がすべての機能を担い、本来独立すべき器官（責務）が癒着。部分摘出が不可能な状態」
- **重症度**: 重症
- **Before/Afterの見込み**: 500行のGod Method → コア処理30行 + Decorator各20行×5 = 130行。責務が明確に分離
- **読者の「あっ」ポイント**: 「全部1メソッドに書いちゃってた……分離の仕方がわからなかったけど、Decoratorならラップするだけか」

---

## 症状評価

| 評価軸 | 案A（王道） | 案B（革新） | 案C（逆転） |
|--------|:-----------:|:-----------:|:-----------:|
| ① 読者共感度 | 3 | 4 | 5 |
| ② メタファー適合度 | 4 | 5 | 4 |
| ③ コメディ発展性 | 3 | 5 | 4 |
| ④ 教育価値 | 4 | 4 | 5 |
| ⑤ 差別化 | 3 | 5 | 4 |
| **合計** | **17** | **23** | **22** |
| **推奨理由** | 正統だが秘密のメッセンジャーと既視感 | Decoratorの「巻く」メタファーと包帯が完璧に一致 | God Methodは痛いが、Bridge記事のif-else地獄と差別化が微妙 |

---

## 相乗効果の検討

### 最高スコアの組合せ: テーマC × 患者C × 症状B

- **テーマC（承認ワークフロー） × 患者C（総務のおばちゃんSE）**: ✅ 紙の稟議書を20年処理してきた人が、デジタル稟議の承認フローを構築するのは極めて自然。紙の世界のロジック（判子リレー）をそのままコードに翻訳した、という設定に強い説得力
- **テーマC × 症状B（if-else包帯ぐるぐる巻き）**: ✅ 紙の回覧ルートの条件分岐（金額10万以上なら部長判子必要、50万以上なら役員も……）をそのままif-elseで書いた、というのはリアリティ満点。「紙なら付箋でルート変更できたのに」の主訴とも直結
- **患者C × 症状B**: ✅ 紙の稟議の達人が、紙の世界の「条件→アクション」をそのままif-elseに翻訳。フラグ変数名が `$needs_buchou_hanko`（部長判子が必要か）のような世界観

### 整合性: ★★★★★（完璧）

3要素が「紙の稟議→デジタル稟議→if-else地獄→Decoratorで包帯を適切に巻き直す」という一本のストーリーラインに収束。医療メタファー「包帯過剰巻着症候群」はDecoratorパターンの「ラッピング」と完璧に対応し、かつコメディとしても「包帯ぐるぐる巻き」のビジュアルが面白い。

---

## 選定結果

| 要素 | 採用案 | スコア |
|------|--------|--------|
| テーマ | 社内稟議書の承認フロー動的構築（逆転） | 24/25 |
| 患者 | 総務のおばちゃんSE（逆転） | 24/25 |
| 症状 | if-else包帯ぐるぐる巻き（革新） | 23/25 |

### 選定理由

紙の稟議書の達人が社内SEに転身し、デジタル承認フローを「紙の世界の常識」でif-elseの力技で実装した——というストーリーラインは、**業務システム開発者の強烈な共感**を呼ぶ。Decoratorパターンの本質（既存処理に非破壊的に機能を追加する）を、「包帯の巻き直し」として描くことで、技術的な理解と物語的な面白さを両立できる。

「紙なら付箋1枚でルート変更」→「コードだと大改修」という主訴は、Decoratorの価値（動的な責務追加と組み合わせの柔軟性）を端的に表現しており、読者にパターン適用の動機を直感的に伝えられる。

### 3要素の整合性
- テーマ × 患者: ✅ 総務部で紙の稟議を20年処理した人がDX推進でデジタル化に取り組むのは極めて自然
- テーマ × 症状: ✅ 稟議ルートの条件分岐をif-elseで全列挙するのは紙のワークフローの忠実な翻訳
- 患者 × 症状: ✅ `$needs_buchou_hanko` のような変数名にExcelならぬ判子文化が滲む

---

## テーマ詳細

- **テーマ名**: 社内稟議書の承認フロー動的構築
- **一行説明**: 稟議書の金額・部門・起案者役職に応じて、複数の承認ステップ（部門長承認・役員承認・監査ログ・メール通知）を動的に組み合わせる
- **パターンとの接点**: 基本の「稟議処理」に対して、条件に応じた承認ステップを「ラッピング」するDecoratorパターンの直接的な適用。CoRとの違い（フィルタリングではなく責務の追加）も教育できる
- **読者像**: 業務システム開発者。承認フローの条件分岐地獄を経験した中堅エンジニア

## 患者詳細

- **属性**: 45歳女性、元総務部で紙の稟議書を20年処理→DX推進でプログラマに転身1年目
- **性格キーワード**: おおらか、紙の世界の達人、「動けばヨシ！」
- **背景**: 紙の稟議書の回覧ルートを完璧に熟知。「係長→課長→部長」の判子リレーが体に染み付いている。DX推進の号令でプログラマ研修を受け、Perlで承認フローシステムを構築。紙の世界の常識（条件→判子→次の人）をそのままif-elseに翻訳
- **主訴**: 「紙ならルート変更は付箋1枚で済むんですけど、プログラムだと大改修になっちゃって……」
- **コメディポテンシャル**: 変数名が `$hanko_count`, `$ringi_status`, `$needs_buchou_hanko`。紙の稟議用語でプログラムを説明。ドクターが「……判子？」と眉をひそめる
- **一人称**: 「私」

## 症状詳細

- **技術的症状**: `process_ringi()` 関数内に、稟議の金額・部門・役職に応じた条件分岐が200行以上のif-elsif-elseネストで存在。フラグ変数（`$needs_log`, `$needs_mail`, `$needs_audit`, `$needs_buchou_hanko`）の組み合わせが爆発
- **医療メタファー**: 「包帯過剰巻着症候群——傷口（コア処理）の上に包帯（条件分岐）を何重にも巻きすぎて、もはやどこが傷口かわからない。包帯を剥がすと出血（バグ）する」
- **重症度**: 重症
- **Before/Afterの見込み**: 200行超のif-else → Decorator適用で各20行程度のラッパークラスに分離。フラグ変数全廃。新しい承認ステップの追加はDecorator1クラスの追加のみで完結
- **読者の「あっ」ポイント**: 「フラグ変数の組み合わせでif書いてた……それDecoratorで解決できたのか」

## 不採用案（参考）

### テーマ
- 案A「ログ出力システム」（15点）: Decoratorの典型例として定番すぎて差別化困難
- 案B「カフェのドリンクカスタマイズ」（16点）: Head Firstで有名な例と被り、新鮮味がない

### 患者
- 案A「まじめな若手バックエンドエンジニア」（15点）: 没個性的
- 案B「完璧主義のテックリード」（17点）: 面白いがBridge記事の自称アーキテクトと既出感

### 症状
- 案A「サブクラス爆発症候群」（17点）: 正統派だが秘密のメッセンジャー記事と既視感
- 案C「God Method」（22点）: 痛いがBridge記事のif-else地獄と差別化が微妙
