# パターンDNA解析構造案: Compositeパターン

> 作成日: 2026-02-04
> ワークフロー: planning-v3

## 1. 問診票（症状リスト）

| # | 症状名 | 説明 | 重症度 |
|---|--------|------|--------|
| 1 | ツリー構造表現困難症 | フォルダとファイルを一元管理できず、階層構造の処理が複雑化している | 重症 |
| 2 | 再帰処理散乱症 | 階層を探索する再帰ロジックが各所に散らばり、保守性が低下 | 中症 |
| 3 | 部分-全体表現不統一症 | ファイル（葉）とフォルダ（枝）を別々に扱う条件分岐が多発 | 中症 |

## 2. 処方候補（使用パターン）

| 順序 | パターン名 | 適応症状 |
|------|-----------|---------|
| 1 | Composite | 全て（再帰的な構造を同一視して扱う） |

## 3. 治療設定

- **出力形式**: 統合版（1記事完結）
- **公開予定日**: 2026-02-18T00:10:14+09:00
- **挿絵**: なし
- **テーマ**: ファイルシステム（ディレクトリ構造の操作）

## 4. 患者プロファイル

- **名前**: カスミ
- **役割**: Webサービス企業のサーバーサイドエンジニア
- **背景**: 自社サービスのファイル管理機能を開発中。フォルダの中にフォルダが入る無限階層の実装で、ファイルとフォルダの区別にif文を連発し、コードがスパゲッティ化してパニックに陥っている。真面目だが思い込みが激しいタイプ。

## 5. 記事構成案（治療計画）

### タイトル案
【Composite】階層構造の「特別扱い」をやめろ！再帰の森を抜ける同一視の手術

### Phase 1: 緊急搬送（導入）
- **シーン**: 深夜のコード診療所。カスミが蒼白な顔で駆け込んでくる。
- **主訴**: 「フォルダの中身を表示するだけで、コードがif文だらけなんです…！深さがわからなくて…！」
- **現状のコード**: ファイルとフォルダを別々のクラス（あるいはハッシュのキー）として扱い、`ref`で型判定をして分岐するperlコード。再帰呼び出しが複雑に絡み合っている。

### Phase 2: 精密検査（診断）
- **ドクターの診断**: 「『部分-全体表現不統一症』だ。枝と葉を区別しすぎている」
- **助手の解説**: ファイル（葉）もフォルダ（枝）も、利用者から見れば同じ「エントリ」です。なのに、使う側が中身を気にしすぎています。
- **病名**: 再帰的複雑性症候群（Compositeパターン欠乏症）

### Phase 3: 外科手術（実装）
- **Step 1: 共通インターフェースの定義**
    - `Component`（FileSystemEntry）クラスの作成。`print_list`などの共通メソッドを定義。
- **Step 2: 葉の実装**
    - `Leaf`（File）クラスの実装。単純に自分の名前を表示するだけ。
- **Step 3: 枝の実装**
    - `Composite`（Folder）クラスの実装。`add`メソッドで子要素を持ち、`print_list`で子要素の同メソッドを再帰的に呼ぶ。
- **Step 4: クライアントコードの修正**
    - `if ($is_folder) { ... }` の分岐を削除し、単に `$entry->print_list()` を呼ぶ形へ。

### Phase 4: 術後経過（退院）
- **Before/After**:
    - 条件分岐が消滅。
    - 新しい種類のエントリ（例：ショートカット、リンク）を追加しても、クライアントコードの修正が不要になった（Open/Closed原則）。
- **注意点**: 共通化しすぎると、葉（File）にとって無意味なメソッド（`add`など）まで持つことになる（リスコフの置換原則への配慮が必要）。今回は安全性より透明性を重視した、と解説。

### エピローグ
- カスミ、スッキリした顔で帰る。「これで深い森も怖くありません！」
- 助手、ドクターにホットミルクを出す。「先生、たまには甘いものも…」
- ドクター、無言で飲む。「…熱い」（照れ隠しではなく事実）
- 助手「（照れてる…！）」

## 6. メトリクス目標
- **条件分岐数**: 50%削減（クライアント側）
- **メソッド長**: 平均行数 30%削減
