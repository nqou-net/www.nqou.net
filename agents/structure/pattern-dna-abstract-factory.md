# パターンDNA解析: Abstract Factory × ゲーム開発

> 生成日: 2026-02-02
> ワークフロー: `/code-doctor-series`
> 形式: **統合版**

---

## 概要

「動けばいいコード」から卒業したいゲームプログラマー向けに、**難易度別の敵・武器・アイテムセットの一貫性** をAbstract Factoryパターンで確保する構造案。

**ターゲット**: 中級ゲームプログラマー

---

## Step 1: 症状カタログ

### 問診票

| # | 症状名 | 説明 | 重症度 |
|---|--------|------|--------|
| 1 | **具体クラス直接生成症** | `EasyEnemy->new()` がコード全体に散在し、難易度切り替え時に100箇所以上の修正が必要 | 重症 |
| 2 | **製品ファミリー不整合症** | Easy敵にHard武器が装備されるなど、異なる難易度の組み合わせでバグ発生 | 重症 |
| 3 | **生成ロジック分散症** | 敵・武器・アイテムの生成が別々のファイルで行われ、整合性が保証されない | 中症 |

### 症状の深掘り

| 症状 | 具体的なコード臭 | 放置した場合のリスク |
|------|------------------|---------------------|
| 具体クラス直接生成症 | 「`HardEnemy->new()` が ゲームループ内に30箇所」 | 難易度追加時の工数爆発 |
| 製品ファミリー不整合症 | 「EasyモードなのにHardボス出現」 | ユーザー体験の破壊、バグ報告の嵐 |
| 生成ロジック分散症 | 「敵はEnemyFactory、武器はWeaponFactory、でも連携なし」 | 難易度変更時に複数ファイル同時修正必須 |

---

## Step 2: DNA解析マップ

### 処方候補

| 順序 | パターン名 | 適応症状 |
|------|-----------|----------|
| 1 | **Abstract Factory** | 製品ファミリー（敵・武器・アイテム）を一括生成し、組み合わせの整合性を保証 |
| 2 | (Strategy) | 難易度による振る舞い変更（※必要に応じて追加） |

### パターン詳細解析

#### Abstract Factory パターン

```markdown
**一言でいうと**: 関連するオブジェクト群を一括で生成し、組み合わせの整合性を保証するパターン

- **適応症状**: 具体クラス直接生成症、製品ファミリー不整合症、生成ロジック分散症
- **禁忌**:
  - 製品が1種類しかない（Factory Methodで十分）
  - 製品間に関連がない
  - 製品ファミリーが今後増えない固定仕様
- **副作用**:
  - 新しい製品種追加時に全Factoryへの改修が必要
  - クラス数の増加（ファミリー数 × 製品種類数）

**ゲーム開発での適用例**:
- 難易度別セット（Easy/Normal/Hard敵・武器・アイテム）
- プラットフォーム別UI（PC/Console/Mobile用ボタン・ウィンドウ）
- テーマ別装飾（ファンタジー/SF/ホラー用キャラ・背景・BGM）
```

### 遺伝子型診断

| 遺伝子型 | 構成症状 | 複合処方 | 本シリーズでの対応 |
|----------|----------|----------|-------------------|
| **Type-AF** | 直接生成 + ファミリー不整合 | Abstract Factory単体 | メイン治療 |
| **Type-AFS** | 上記 + 振る舞い切替 | Abstract Factory + Strategy | オプション追加治療 |

---

## Step 3: 競合・差別化分析

### 既存シリーズとの比較

| 既存シリーズ | Abstract Factory使用 | テーマ | 本シリーズとの差別化 |
|-------------|---------------------|--------|---------------------|
| 注文フロー国別キット | ◎（単独） | ECサイト決済/配送 | ビジネス系、ゲーム特化ではない |
| ウイスキーテイスティングカード | ○（3パターン複合） | 飲料 | 複合パターン、AF単体深掘りなし |

**差別化ポイント**:
- **ゲーム開発特化**の製品ファミリー（敵・武器・アイテム）
- **医療メタファー**（コードドクター視点）で診断・処方
- **難易度システム**という身近な題材

---

## Step 4: 処方箋設計

### 採用案: 「難易度別セット生成システム」

**治療方針**: ローグライクゲームの**難易度別生成**を題材に、Abstract Factoryパターンを段階導入

**テーマ・題材**: ローグライクの難易度システム（Easy/Normal/Hard）

**USP**: 「難易度を切り替えるのに1行だけ」を実現

| 章 | 症状/診断 | 処方/投薬 | Before/After |
|----|----------|----------|--------------|
| 1 | 緊急搬送: 難易度切り替えで100箇所修正 | 症状確認 | - |
| 2 | 重症: 具体クラス直接生成症 | AbstractFactoryロール導入 | 修正箇所: 100→1 |
| 3 | 重症: 製品ファミリー不整合症 | EasyFactory/HardFactory実装 | バグ: 発生→不可能 |
| 4 | 中症: 生成ロジック分散症 | GameEngineへのDI | ファイル数: 複数→1で管理 |
| 5 | 経過観察: Nightmare追加 | 新難易度追加の容易さ | 追加工数: 50行→10行 |
| 6 | 退院: 健康なゲームシステム | 総括・パターン名公開 | 全体メトリクス |

**推奨タグ**: `code-doctor`, `design-patterns`, `abstract-factory-pattern`

**meta description**: 難易度切り替えで100箇所修正地獄を脱出！PerlとAbstract Factoryパターンでゲームの製品ファミリーを健康にするコードドクター奮闘記

---

## メトリクス設計

### Before/After比較項目

| 指標 | 測定方法 | Before目安 | After目安 |
|------|----------|-----------|----------|
| **修正箇所** | 難易度切り替え時 | 100箇所 | 1箇所(-99%) |
| **組み合わせバグ** | ファミリー不整合 | 発生可能 | 構造上不可能 |
| **行数** | `wc -l` | 300行 | 200行(-33%) |
| **クラス数** | ファイル数 | 1（God Class） | 10+（Factory群+Product群） |
| **新難易度追加工数** | 行数 | 50行以上 | 10行1ファイル |

---

## 患者プロファイル

- **スキルレベル**: 中級
- **背景**: ローグライクゲーム開発者
- **症状経緯**: 最初はEasyモードだけだったが、ユーザーからの要望でNormal/Hardを追加。その結果、難易度切り替えのたびに修正箇所が膨大になった
- **来院動機**: 新難易度（Nightmare）追加を前に、このままでは破綻すると気づいた

---

## コード設計

### 製品ファミリー

| 製品種 | Easy | Normal | Hard |
|--------|------|--------|------|
| Enemy | Slime (HP:30) | Goblin (HP:80) | Dragon (HP:200) |
| Weapon | WoodenSword (ATK:10) | IronSword (ATK:30) | FlameKatana (ATK:80) |
| Item | Herb (回復:20) | Potion (回復:50) | Elixir (全回復) |

### クラス設計

```
DifficultyFactory（ロール）
├── create_enemy()
├── create_weapon()
└── create_item()

EasyFactory, NormalFactory, HardFactory（具象Factory）

Enemy, Weapon, Item（ロール）
EasyEnemy, NormalEnemy, HardEnemy...（具象Product）

GameEngine（クライアント）
└── has factory => DifficultyFactory
```

---

## 治療の流れ（ストーリー）

### 第1章: 緊急搬送

- 「先生、患者さんです！」
- 症状: 難易度切り替え時に100箇所以上の修正が必要
- ドクター: 「重症。だが、まだ間に合う」

### 第2章: 手術開始 - 具体クラス直接生成症の治療

- Before: `my $enemy = HardEnemy->new()` が30箇所
- 処方: DifficultyFactoryロールを導入
- After: `my $enemy = $factory->create_enemy()` で生成を一括化

### 第3章: 製品ファミリーの一貫性確保

- Before: EasyFactory から HardWeapon が生成される可能性
- 処方: 具象Factory（EasyFactory, NormalFactory, HardFactory）で整合性保証
- After: 型レベルで不整合が発生不可能

### 第4章: DIでクライアントを健康に

- Before: GameEngine内で難易度分岐（if/else地獄）
- 処方: Factoryを依存注入
- After: `GameEngine->new(factory => EasyFactory->new())`

### 第5章: 新難易度追加（Nightmare）

- 課題: 新しい難易度を追加したい
- 処方: NightmareFactoryを1ファイル追加するだけ
- 結果: 既存コードへの修正ゼロ（OCP確認）

### 第6章: 退院

- ドクター: 「Abstract Factory。製品ファミリーの一貫性を保証するパターン」
- 成績表: Before/After比較
- 次回予告: 「先生、また患者さんが…」

---

## ステータス登録

```markdown
| [pattern-dna-abstract-factory.md](agents/structure/pattern-dna-abstract-factory.md) | コードドクター〜難易度システム緊急手術（Abstract Factory） | 統合版 | 2026-02-12 | - | [記事](/2026/02/12/001507/) |
```

---

## 次のステップ

1. ✅ 構造案承認
2. [ ] Before/After コード実装
3. [ ] テスト作成・検証
4. [ ] 原稿作成
5. [ ] PLANNING_STATUS.md 更新
