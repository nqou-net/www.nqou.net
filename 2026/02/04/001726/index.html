<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ウイスキーのテイスティングノートを題材に、Bridge・Adapter・Proxyの3つの構造パターンを実装。「全部間に入るパターンでしょ？」から卒業しよう。"><title>Perlで作るウイスキーテイスティング・ノート〜3つの「間に入る」パターンで設計を手で覚える</title><link rel=canonical href=https://www.nqou.net/2026/02/04/001726/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="Perlで作るウイスキーテイスティング・ノート〜3つの「間に入る」パターンで設計を手で覚える"><meta property='og:description' content="ウイスキーのテイスティングノートを題材に、Bridge・Adapter・Proxyの3つの構造パターンを実装。「全部間に入るパターンでしょ？」から卒業しよう。"><meta property='og:url' content='https://www.nqou.net/2026/02/04/001726/'><meta property='og:site_name' content='設計パターンを疑え'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='perl'><meta property='article:tag' content='moo'><meta property='article:tag' content='design-patterns'><meta property='article:tag' content='bridge'><meta property='article:tag' content='adapter'><meta property='article:tag' content='proxy'><meta property='article:tag' content='whisky'><meta property='article:tag' content='hands-on'><meta property='article:published_time' content='2026-02-04T00:17:26+09:00'><meta property='article:modified_time' content='2026-02-04T00:17:26+09:00'><meta property='og:image' content='https://www.nqou.net/public_images/2026/bridge-adapter-proxy-series-image.jpg'><meta name=twitter:title content="Perlで作るウイスキーテイスティング・ノート〜3つの「間に入る」パターンで設計を手で覚える"><meta name=twitter:description content="ウイスキーのテイスティングノートを題材に、Bridge・Adapter・Proxyの3つの構造パターンを実装。「全部間に入るパターンでしょ？」から卒業しよう。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://www.nqou.net/public_images/2026/bridge-adapter-proxy-series-image.jpg'><link rel="shortcut icon" href=/favicon.png><style>@import 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap';:root{--base-font-family:Arial, "Noto Sans JP", sans-serif}</style><link rel=stylesheet href=/css/linkcard.css><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3923446804785015" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js defer></script><script defer>document.addEventListener("DOMContentLoaded",function(){try{typeof mermaid!="undefined"&&document.querySelector(".mermaid")&&mermaid.initialize({startOnLoad:!0,securityLevel:"strict"})}catch(e){console.warn("Mermaid failed to initialize:",e)}})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-E50H9ESN7E"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E50H9ESN7E")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=メニューを開く・閉じる>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/public_images/blog-nqounet-square.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>設計パターンを疑え</a></h1><h2 class=site-description>名前の嘘を暴き、意図で設計を語る</h2></div></header><ol class=menu-social><li><a href=https://github.com/nqounet target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/nqounet target=_blank title=X rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/advent-calendar-2025/><svg class="icon icon-tabler icon-tabler-calendar" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="5" width="16" height="16" rx="2"/><line x1="16" y1="3" x2="16" y2="7"/><line x1="8" y1="3" x2="8" y2="7"/><line x1="4" y1="11" x2="20" y2="11"/><path d="M8 15h.01"/><path d="M12 15h.01"/><path d="M16 15h.01"/><path d="M8 19h.01"/><path d="M12 19h.01"/><path d="M16 19h.01"/></svg>
<span>Perl Advent Calendar 2025 - AI Edition</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/warehouse/><svg class="icon icon-tabler icon-tabler-warehouse" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10l9-6 9 6"/><rect x="5" y="10" width="14" height="10" rx="2"/><rect x="10" y="14" width="4" height="6" rx="1"/><path d="M7 20v-4h2v4"/><path d="M15 20v-4h2v4"/></svg>
<span>Warehouse</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>ダークモード</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目次</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#はじめに>はじめに</a><ol><li><a href=#この記事で作るもの>この記事で作るもの</a></li><li><a href=#習得する3パターン>習得する3パターン</a></li><li><a href=#対象読者>対象読者</a></li><li><a href=#技術スタック>技術スタック</a></li></ol></li><li><a href=#第1章-まずはcsvから読み込もう>第1章: まずはCSVから読み込もう</a><ol><li><a href=#今回の目標>今回の目標</a></li><li><a href=#最初の実装>最初の実装</a></li><li><a href=#今回のポイント>今回のポイント</a></li></ol></li><li><a href=#第2章-jsonも読みたいでも形式が違う>第2章: JSONも読みたい！でも形式が違う</a><ol><li><a href=#今回の目標-1>今回の目標</a></li><li><a href=#問題インターフェースの不一致>問題：インターフェースの不一致</a></li><li><a href=#ifelse地獄の始まり>if/else地獄の始まり</a></li><li><a href=#問題点>問題点</a></li></ol></li><li><a href=#第3章-adapterでデータソースを統一>第3章: Adapterでデータソースを統一</a><ol><li><a href=#今回の目標-2>今回の目標</a></li><li><a href=#adapterパターンとは>Adapterパターンとは？</a></li><li><a href=#設計>設計</a></li><li><a href=#使い方>使い方</a></li><li><a href=#今回のポイント-1>今回のポイント</a></li></ol></li><li><a href=#第4章-出力形式を増やしたい>第4章: 出力形式を増やしたい</a><ol><li><a href=#今回の目標-3>今回の目標</a></li><li><a href=#問題組み合わせ爆発>問題：組み合わせ爆発</a></li><li><a href=#ifelseで実装してみると>if/elseで実装してみると&mldr;</a></li></ol></li><li><a href=#第5章-bridgeで出力とスタイルを分離>第5章: Bridgeで出力とスタイルを分離</a><ol><li><a href=#今回の目標-4>今回の目標</a></li><li><a href=#bridgeパターンとは>Bridgeパターンとは？</a></li><li><a href=#設計-1>設計</a></li><li><a href=#使い方-1>使い方</a></li><li><a href=#今回のポイント-2>今回のポイント</a></li></ol></li><li><a href=#第6章-画像の読み込みが重い>第6章: 画像の読み込みが重い！</a><ol><li><a href=#今回の目標-5>今回の目標</a></li><li><a href=#問題全件ロードが重い>問題：全件ロードが重い</a></li><li><a href=#実行結果>実行結果</a></li><li><a href=#問題点-1>問題点</a></li></ol></li><li><a href=#第7章-proxyで遅延キャッシュ制御>第7章: Proxyで遅延・キャッシュ・制御</a><ol><li><a href=#今回の目標-6>今回の目標</a></li><li><a href=#proxyパターンとは>Proxyパターンとは？</a></li><li><a href=#proxyの3つの役割>Proxyの3つの役割</a></li><li><a href=#1-imageproxy遅延ロード>1. ImageProxy（遅延ロード）</a></li><li><a href=#2-ratingproxyキャッシュ>2. RatingProxy（キャッシュ）</a></li><li><a href=#3-accessproxyアクセス制御>3. AccessProxy（アクセス制御）</a></li><li><a href=#今回のポイント-3>今回のポイント</a></li></ol></li><li><a href=#第8章-3つのパターンを統合する>第8章: 3つのパターンを統合する</a><ol><li><a href=#今回の目標-7>今回の目標</a></li><li><a href=#全体像>全体像</a></li><li><a href=#統合版コード>統合版コード</a></li><li><a href=#データフローの可視化>データフローの可視化</a></li></ol></li><li><a href=#第9章-振り返り3つの間に入るパターン>第9章: 振り返り〜3つの「間に入る」パターン</a><ol><li><a href=#3パターンの本質的な違い>3パターンの本質的な違い</a></li><li><a href=#使い分けの判断基準>使い分けの判断基準</a></li><li><a href=#今回作ったクラス構成>今回作ったクラス構成</a></li><li><a href=#発展的な学習>発展的な学習</a></li><li><a href=#まとめ>まとめ</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/2026/02/04/001726/><img src=/public_images/2026/bridge-adapter-proxy-series-image.jpg loading=lazy alt="Featured image of post Perlで作るウイスキーテイスティング・ノート〜3つの「間に入る」パターンで設計を手で覚える"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2026/02/04/001726/>Perlで作るウイスキーテイスティング・ノート〜3つの「間に入る」パターンで設計を手で覚える</a></h2><h3 class=article-subtitle>ウイスキーのテイスティングノートを題材に、Bridge・Adapter・Proxyの3つの構造パターンを実装。「全部間に入るパターンでしょ？」から卒業しよう。</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2月 04, 2026</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>読了時間: 15分</time></div></footer></div></header><section class=article-content><p><img src=/public_images/2026/001726/header.png loading=lazy alt=ウイスキーテイスティングノートと3つのパターン></p><h2 id=はじめに>はじめに</h2><p>「Bridge、Adapter、Proxy&mldr;&mldr;全部『間に入る』パターンでしょ？」</p><p>デザインパターンを勉強していると、この3つの違いがイマイチわからないという声をよく聞きます。確かに、どれも「何かと何かの間に入って何かする」という点では似ています。しかし、<strong>なぜ間に入るのか</strong>という目的が全く異なるのです。</p><p>本記事では、<strong>ウイスキーのテイスティングノート</strong>を題材に、この3パターンを実際に手を動かしながら学びます。</p><h3 id=この記事で作るもの>この記事で作るもの</h3><p>ウイスキーの試飲記録を管理するCLIツールを段階的に構築します。</p><ul><li><strong>CSV/JSON</strong>から銘柄情報を読み込み</li><li><strong>Text/HTML/Markdown</strong>形式で出力</li><li><strong>Simple/Detailed/Pro</strong>スタイルで表示</li><li><strong>遅延ロード・キャッシュ・アクセス制御</strong>機能付き</li></ul><h3 id=習得する3パターン>習得する3パターン</h3><div class=table-wrapper><table><thead><tr><th>パターン</th><th>何のために「間に入る」か</th><th>キーワード</th></tr></thead><tbody><tr><td><strong>Adapter</strong></td><td>異なるインターフェースを統一するため</td><td>変換、ラッパー、互換性</td></tr><tr><td><strong>Bridge</strong></td><td>2つの独立した変動軸を分離するため</td><td>抽象×実装、n×m → n+m</td></tr><tr><td><strong>Proxy</strong></td><td>本物へのアクセスを制御するため</td><td>代理、遅延、キャッシュ</td></tr></tbody></table></div><h3 id=対象読者>対象読者</h3><ul><li>デザインパターンシリーズを一通り読了したが、まだ自力で使いこなせない方</li><li>Bridge/Adapter/Proxyの違いがピンとこない方</li><li>「if/elseに戻ってしまう」を卒業したい方</li></ul><h3 id=技術スタック>技術スタック</h3><ul><li>Perl v5.36以降（signatures、postfix dereference対応）</li><li>Moo（軽量OOPフレームワーク）</li><li>JSON::PP（標準モジュール）</li></ul><hr><h2 id=第1章-まずはcsvから読み込もう>第1章: まずはCSVから読み込もう</h2><h3 id=今回の目標>今回の目標</h3><ul><li>CSVファイルからウイスキー情報を読み込む</li><li>テキストで表示する基本的な処理を実装</li></ul><h3 id=最初の実装>最初の実装</h3><p>まずはシンプルに、CSVデータを読み込んで表示してみましょう。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=ch>#!/usr/bin/env perl</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CSVデータをHEREDOCで定義</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$csv_data</span> <span class=o>=</span> <span class=s>&lt;&lt;&#39;</span><span class=dl>CSV</span><span class=s>&#39;;
</span></span></span><span class=line><span class=cl><span class=s>id,name,region,age,abv,nose,palate,finish,rating
</span></span></span><span class=line><span class=cl><span class=s>1,山崎12年,日本,12,43,蜂蜜とバニラ,フルーティで滑らか,長くスパイシー,92
</span></span></span><span class=line><span class=cl><span class=s>2,ラフロイグ10年,アイラ,10,40,強烈なピート,スモーキーで塩辛い,力強くドライ,88
</span></span></span><span class=line><span class=cl><span class=s>3,グレンフィディック12年,スペイサイド,12,40,洋梨とリンゴ,クリーミーで甘い,フレッシュな余韻,85
</span></span></span><span class=line><span class=cl><span class=dl>CSV</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CSVをパースして表示</span>
</span></span><span class=line><span class=cl><span class=n>say</span> <span class=s>&#34;=== ウイスキーテイスティング・ノート ===\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>@lines</span> <span class=o>=</span> <span class=nb>split</span> <span class=sr>/\n/</span><span class=p>,</span> <span class=nv>$csv_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$header</span> <span class=o>=</span> <span class=nb>shift</span> <span class=nv>@lines</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>my</span> <span class=nv>$line</span> <span class=p>(</span><span class=nv>@lines</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>next</span> <span class=k>unless</span> <span class=nv>$line</span> <span class=o>=~</span><span class=sr> /\S/</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>@fields</span> <span class=o>=</span> <span class=nb>split</span> <span class=sr>/,/</span><span class=p>,</span> <span class=nv>$line</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=p>(</span><span class=nv>$id</span><span class=p>,</span> <span class=nv>$name</span><span class=p>,</span> <span class=nv>$region</span><span class=p>,</span> <span class=nv>$age</span><span class=p>,</span> <span class=nv>$abv</span><span class=p>,</span> <span class=nv>$nose</span><span class=p>,</span> <span class=nv>$palate</span><span class=p>,</span> <span class=nv>$finish</span><span class=p>,</span> <span class=nv>$rating</span><span class=p>)</span> <span class=o>=</span> <span class=nv>@fields</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;【$name】&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;  産地: $region / 熟成: ${age}年 / 度数: ${abv}%&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;  香り: $nose&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;  味わい: $palate&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;  余韻: $finish&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;  評価: $rating/100&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>say</span> <span class=s>&#34;=== 読み込み完了 ===&#34;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>実行結果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>=== ウイスキーテイスティング・ノート ===
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>【山崎12年】
</span></span><span class=line><span class=cl>  産地: 日本 / 熟成: 12年 / 度数: 43%
</span></span><span class=line><span class=cl>  香り: 蜂蜜とバニラ
</span></span><span class=line><span class=cl>  味わい: フルーティで滑らか
</span></span><span class=line><span class=cl>  余韻: 長くスパイシー
</span></span><span class=line><span class=cl>  評価: 92/100
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>動きました！CSVを読み込んで、きれいにフォーマットして表示できています。</p><h3 id=今回のポイント>今回のポイント</h3><ul><li>CSVの基本的なパースはsplitで十分</li><li>HEREDOCでサンプルデータを埋め込むと開発しやすい</li></ul><hr><h2 id=第2章-jsonも読みたいでも形式が違う>第2章: JSONも読みたい！でも形式が違う</h2><h3 id=今回の目標-1>今回の目標</h3><ul><li>JSONファイルにも対応したい</li><li>しかし、JSONの構造がCSVと全く異なる問題に直面</li></ul><h3 id=問題インターフェースの不一致>問題：インターフェースの不一致</h3><p>友人が「このウイスキーデータベースのJSONも使えない？」と言ってきました。喜んで受け取ったJSON、しかし&mldr;&mldr;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;whiskies&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;whisky_id&#34;</span><span class=p>:</span> <span class=s2>&#34;W002&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;whisky_name&#34;</span><span class=p>:</span> <span class=s2>&#34;ラフロイグ10年&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;origin&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=nt>&#34;country&#34;</span><span class=p>:</span> <span class=s2>&#34;スコットランド&#34;</span><span class=p>,</span> <span class=nt>&#34;region&#34;</span><span class=p>:</span> <span class=s2>&#34;アイラ&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;specs&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=nt>&#34;age_years&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=nt>&#34;alcohol_percentage&#34;</span><span class=p>:</span> <span class=mi>40</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;tasting_notes&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;aroma&#34;</span><span class=p>:</span> <span class=s2>&#34;強烈なピート&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;taste&#34;</span><span class=p>:</span> <span class=s2>&#34;スモーキーで塩辛い&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;after&#34;</span><span class=p>:</span> <span class=s2>&#34;力強くドライ&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mi>88</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>CSVとは構造が全く違います！</p><ul><li><code>id</code> → <code>whisky_id</code></li><li><code>name</code> → <code>whisky_name</code></li><li><code>region</code> → <code>origin.region</code>（ネスト構造！）</li><li><code>rating</code> → <code>score</code></li></ul><h3 id=ifelse地獄の始まり>if/else地獄の始まり</h3><p>「とりあえずフォーマット判定で分岐すればいいか」と思って書いたコードがこちら：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>sub</span> <span class=nf>read_whisky_data</span><span class=p>($format, $data) {</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>@whiskies</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$format</span> <span class=ow>eq</span> <span class=s>&#39;csv&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>my</span> <span class=nv>@lines</span> <span class=o>=</span> <span class=nb>split</span> <span class=sr>/\n/</span><span class=p>,</span> <span class=nv>$data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nb>shift</span> <span class=nv>@lines</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=k>my</span> <span class=nv>$line</span> <span class=p>(</span><span class=nv>@lines</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>my</span> <span class=nv>@f</span> <span class=o>=</span> <span class=nb>split</span> <span class=sr>/,/</span><span class=p>,</span> <span class=nv>$line</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nb>push</span> <span class=nv>@whiskies</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>id</span>     <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span>   <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>region</span> <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=c1># ... 以下略</span>
</span></span><span class=line><span class=cl>            <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>elsif</span> <span class=p>(</span><span class=nv>$format</span> <span class=ow>eq</span> <span class=s>&#39;json&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>my</span> <span class=nv>$obj</span> <span class=o>=</span> <span class=n>decode_json</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=k>my</span> <span class=nv>$w</span> <span class=p>(</span><span class=nv>$obj</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>whiskies</span><span class=p>}</span><span class=o>-&gt;</span><span class=nv>@</span><span class=err>*</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1># JSONの構造がCSVと全く違う！変換が必要</span>
</span></span><span class=line><span class=cl>            <span class=nb>push</span> <span class=nv>@whiskies</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>id</span>     <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>whisky_id</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span>   <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>whisky_name</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=n>region</span> <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>origin</span><span class=p>}{</span><span class=n>region</span><span class=p>},</span>  <span class=c1># ネスト構造</span>
</span></span><span class=line><span class=cl>                <span class=c1># ... 以下略</span>
</span></span><span class=line><span class=cl>            <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># TODO: XMLも追加したい... elsif ($format eq &#39;xml&#39;) { ... }</span>
</span></span><span class=line><span class=cl>    <span class=c1># TODO: 外部APIも追加したい... elsif ($format eq &#39;api&#39;) { ... }</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>die</span> <span class=s>&#34;未対応のフォーマット: $format&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>@whiskies</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=問題点>問題点</h3><div class=table-wrapper><table><thead><tr><th>問題</th><th>説明</th></tr></thead><tbody><tr><td>if/elseの肥大化</td><td>新フォーマット追加のたびに分岐が増える</td></tr><tr><td>変換ロジックの散乱</td><td>各フォーマットの変換処理が1つの関数に集中</td></tr><tr><td>テストが困難</td><td>特定のフォーマットだけテストしにくい</td></tr><tr><td>拡張性が低い</td><td>新しい開発者が追加しにくい</td></tr></tbody></table></div><p>「XML対応」「外部API対応」と要望が出るたびに、この関数がどんどん膨れ上がっていきます。</p><hr><h2 id=第3章-adapterでデータソースを統一>第3章: Adapterでデータソースを統一</h2><h3 id=今回の目標-2>今回の目標</h3><ul><li>Adapterパターンで異なるデータソースを統一インターフェースで扱う</li><li>if/else地獄から脱出する</li></ul><h3 id=adapterパターンとは>Adapterパターンとは？</h3><p><strong>Adapterパターン</strong>は、異なるインターフェースを持つ既存のクラスを、期待されるインターフェースに変換するパターンです。</p><blockquote><p>「何のために間に入る？」→ <strong>異なるインターフェースを統一するため</strong></p></blockquote><p><img src=/public_images/2026/001726/adapter_mechanism.png loading=lazy alt=Adapterパターンのメカニズム></p><h3 id=設計>設計</h3><p>まず、データソースの統一インターフェースをRoleとして定義します。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>package</span> <span class=nn>WhiskySourceRole</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo::Role</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 統一インターフェース: すべてのAdapterが実装するメソッド</span>
</span></span><span class=line><span class=cl><span class=n>requires</span> <span class=s>&#39;get_whisky&#39;</span><span class=p>;</span>     <span class=c1># id を指定して1つ取得</span>
</span></span><span class=line><span class=cl><span class=n>requires</span> <span class=s>&#39;get_all&#39;</span><span class=p>;</span>        <span class=c1># 全件取得</span>
</span></span><span class=line><span class=cl><span class=n>requires</span> <span class=s>&#39;source_name&#39;</span><span class=p>;</span>    <span class=c1># データソース名</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>次に、このRoleを実装するAdapterを作ります。</p><p><strong>CsvAdapter.pm</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>package</span> <span class=nn>CsvAdapter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>with</span> <span class=s>&#39;WhiskySourceRole&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>csv_data</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=s>&#39;_cache&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;lazy&#39;</span><span class=p>,</span> <span class=n>builder</span> <span class=o>=&gt;</span> <span class=s>&#39;_build_cache&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>_build_cache</span><span class=p>($self) {</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>@whiskies</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>@lines</span> <span class=o>=</span> <span class=nb>split</span> <span class=sr>/\n/</span><span class=p>,</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>csv_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>shift</span> <span class=nv>@lines</span><span class=p>;</span> <span class=c1># ヘッダー除去</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>my</span> <span class=nv>$line</span> <span class=p>(</span><span class=nv>@lines</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>next</span> <span class=k>unless</span> <span class=nv>$line</span> <span class=o>=~</span><span class=sr> /\S/</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>my</span> <span class=nv>@f</span> <span class=o>=</span> <span class=nb>split</span> <span class=sr>/,/</span><span class=p>,</span> <span class=nv>$line</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nb>push</span> <span class=nv>@whiskies</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>id</span>     <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span>   <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>region</span> <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>age</span>    <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>abv</span>    <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>nose</span>   <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>palate</span> <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>finish</span> <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>rating</span> <span class=o>=&gt;</span> <span class=nv>$f</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=nb>map</span> <span class=p>{</span> <span class=nv>$_</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>id</span><span class=p>}</span> <span class=o>=&gt;</span> <span class=nv>$_</span> <span class=p>}</span> <span class=nv>@whiskies</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>get_whisky</span><span class=p>($self, $id) {</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=nn>_cache</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>get_all</span><span class=p>($self) {</span> <span class=nb>values</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=nn>_cache</span><span class=o>-&gt;</span><span class=nv>%</span><span class=err>*</span> <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=nv>sub</span> <span class=n>source_name</span><span class=p>(</span><span class=nv>$self</span><span class=p>)</span> <span class=p>{</span> <span class=s>&#39;CSV&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>JsonAdapter.pm</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonAdapter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>utf8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JSON::PP</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Encode</span> <span class=sx>qw(decode)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>with</span> <span class=s>&#39;WhiskySourceRole&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>json_data</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=s>&#39;_cache&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;lazy&#39;</span><span class=p>,</span> <span class=n>builder</span> <span class=o>=&gt;</span> <span class=s>&#39;_build_cache&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>_build_cache</span><span class=p>($self) {</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$json_text</span> <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>json_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$json_text</span> <span class=o>=</span> <span class=n>decode</span><span class=p>(</span><span class=s>&#39;UTF-8&#39;</span><span class=p>,</span> <span class=nv>$json_text</span><span class=p>)</span> <span class=k>unless</span> <span class=nn>utf8::</span><span class=n>is_utf8</span><span class=p>(</span><span class=nv>$json_text</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$obj</span> <span class=o>=</span> <span class=nn>JSON::PP</span><span class=o>-&gt;</span><span class=k>new</span><span class=o>-&gt;</span><span class=n>utf8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>decode</span><span class=p>(</span><span class=nv>$json_text</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>@whiskies</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>my</span> <span class=nv>$w</span> <span class=p>(</span><span class=nv>$obj</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>whiskies</span><span class=p>}</span><span class=o>-&gt;</span><span class=nv>@</span><span class=err>*</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1># JSONの独自構造 → 統一構造へ変換</span>
</span></span><span class=line><span class=cl>        <span class=nb>push</span> <span class=nv>@whiskies</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>id</span>     <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>whisky_id</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span>   <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>whisky_name</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>region</span> <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>origin</span><span class=p>}{</span><span class=n>region</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>age</span>    <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>specs</span><span class=p>}{</span><span class=n>age_years</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>abv</span>    <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>specs</span><span class=p>}{</span><span class=n>alcohol_percentage</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>nose</span>   <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>tasting_notes</span><span class=p>}{</span><span class=n>aroma</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>palate</span> <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>tasting_notes</span><span class=p>}{</span><span class=n>taste</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>finish</span> <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>tasting_notes</span><span class=p>}{</span><span class=n>after</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>rating</span> <span class=o>=&gt;</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>score</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=nb>map</span> <span class=p>{</span> <span class=nv>$_</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>id</span><span class=p>}</span> <span class=o>=&gt;</span> <span class=nv>$_</span> <span class=p>}</span> <span class=nv>@whiskies</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>get_whisky</span><span class=p>($self, $id) {</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=nn>_cache</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>get_all</span><span class=p>($self) {</span> <span class=nb>values</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=nn>_cache</span><span class=o>-&gt;</span><span class=nv>%</span><span class=err>*</span> <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=nv>sub</span> <span class=n>source_name</span><span class=p>(</span><span class=nv>$self</span><span class=p>)</span> <span class=p>{</span> <span class=s>&#39;JSON&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=使い方>使い方</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># どちらも同じインターフェースで使える！</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$csv_adapter</span> <span class=o>=</span> <span class=nn>CsvAdapter</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>csv_data</span> <span class=o>=&gt;</span> <span class=nv>$csv_data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$json_adapter</span> <span class=o>=</span> <span class=nn>JsonAdapter</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>json_data</span> <span class=o>=&gt;</span> <span class=nv>$json_data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 統一されたメソッドでアクセス</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>@all_whiskies</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>push</span> <span class=nv>@all_whiskies</span><span class=p>,</span> <span class=nv>$csv_adapter</span><span class=o>-&gt;</span><span class=n>get_all</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>push</span> <span class=nv>@all_whiskies</span><span class=p>,</span> <span class=nv>$json_adapter</span><span class=o>-&gt;</span><span class=n>get_all</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=今回のポイント-1>今回のポイント</h3><ul><li><strong>Adapter</strong>は異なるインターフェースを統一する</li><li>各データソースの変換ロジックがAdapterクラスに分離される</li><li>新しいデータソースの追加は新しいAdapterを作るだけ</li></ul><pre class=mermaid>
	classDiagram
    class WhiskySourceRole {
        &lt;&lt;Role&gt;&gt;
        +get_whisky(id)
        +get_all()
        +source_name()
    }
    class CsvAdapter {
        +csv_data
        +get_whisky(id)
        +get_all()
        +source_name()
    }
    class JsonAdapter {
        +json_data
        +get_whisky(id)
        +get_all()
        +source_name()
    }
    WhiskySourceRole &lt;|.. CsvAdapter
    WhiskySourceRole &lt;|.. JsonAdapter
</pre><hr><h2 id=第4章-出力形式を増やしたい>第4章: 出力形式を増やしたい</h2><h3 id=今回の目標-3>今回の目標</h3><ul><li>Text/HTML/Markdownの3つの出力形式に対応</li><li>さらにSimple/Detailed/Proの3スタイルに対応</li><li>組み合わせ爆発の問題に直面</li></ul><h3 id=問題組み合わせ爆発>問題：組み合わせ爆発</h3><p>「テキストだけじゃなくてHTMLでも出力したい」
「Markdownでブログに貼りたい」
「シンプル表示と詳細表示を切り替えたい」
「プロ向けの評価チャート付き表示も欲しい」</p><p>要望をまとめると：</p><div class=table-wrapper><table><thead><tr><th>出力形式</th><th>スタイル</th></tr></thead><tbody><tr><td>Text</td><td>Simple, Detailed, Pro</td></tr><tr><td>HTML</td><td>Simple, Detailed, Pro</td></tr><tr><td>Markdown</td><td>Simple, Detailed, Pro</td></tr></tbody></table></div><p>3×3 = <strong>9パターン</strong>の組み合わせが必要です。</p><h3 id=ifelseで実装してみると>if/elseで実装してみると&mldr;</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>sub</span> <span class=nf>render_note</span><span class=p>($whisky, $format, $style) {</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$format</span> <span class=ow>eq</span> <span class=s>&#39;text&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$style</span> <span class=ow>eq</span> <span class=s>&#39;simple&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>elsif</span> <span class=p>(</span><span class=nv>$style</span> <span class=ow>eq</span> <span class=s>&#39;detailed&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>elsif</span> <span class=p>(</span><span class=nv>$style</span> <span class=ow>eq</span> <span class=s>&#39;pro&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>elsif</span> <span class=p>(</span><span class=nv>$format</span> <span class=ow>eq</span> <span class=s>&#39;html&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$style</span> <span class=ow>eq</span> <span class=s>&#39;simple&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>elsif</span> <span class=p>(</span><span class=nv>$style</span> <span class=ow>eq</span> <span class=s>&#39;detailed&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>elsif</span> <span class=p>(</span><span class=nv>$style</span> <span class=ow>eq</span> <span class=s>&#39;pro&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>elsif</span> <span class=p>(</span><span class=nv>$format</span> <span class=ow>eq</span> <span class=s>&#39;markdown&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$style</span> <span class=ow>eq</span> <span class=s>&#39;simple&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>elsif</span> <span class=p>(</span><span class=nv>$style</span> <span class=ow>eq</span> <span class=s>&#39;detailed&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>elsif</span> <span class=p>(</span><span class=nv>$style</span> <span class=ow>eq</span> <span class=s>&#39;pro&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>9つの分岐！そして新しいフォーマットを追加すると3つ、新しいスタイルを追加しても3つの実装が必要になります。</p><div class=table-wrapper><table><thead><tr><th>追加</th><th>必要な実装数</th></tr></thead><tbody><tr><td>新フォーマット（PDF）</td><td>3つ（Simple/Detailed/Pro）</td></tr><tr><td>新スタイル（Expert）</td><td>3つ（Text/HTML/MD）</td></tr><tr><td>両方追加</td><td>4つ</td></tr></tbody></table></div><p>これが<strong>組み合わせ爆発</strong>です。n×m の組み合わせを n+m で実現する方法が必要です。</p><hr><h2 id=第5章-bridgeで出力とスタイルを分離>第5章: Bridgeで出力とスタイルを分離</h2><h3 id=今回の目標-4>今回の目標</h3><ul><li>Bridgeパターンで出力形式とスタイルを分離</li><li>3×3=9パターンを3+3=6クラスで実現</li></ul><h3 id=bridgeパターンとは>Bridgeパターンとは？</h3><p><strong>Bridgeパターン</strong>は、抽象部分と実装部分を分離し、それぞれを独立して変更できるようにするパターンです。</p><blockquote><p>「何のために間に入る？」→ <strong>2つの独立した変動軸を分離するため</strong></p></blockquote><p><img src=/public_images/2026/001726/bridge_structure.png loading=lazy alt=Bridgeパターンの構造></p><h3 id=設計-1>設計</h3><p>2つの軸を分離します：</p><ol><li><strong>抽象側（Abstraction）</strong>: 出力形式（Text/HTML/Markdown）</li><li><strong>実装側（Implementor）</strong>: スタイル（Simple/Detailed/Pro）</li></ol><p>まず実装側（スタイル）のRoleを定義：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>package</span> <span class=nn>FormatterRole</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo::Role</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>requires</span> <span class=s>&#39;format_name&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>requires</span> <span class=s>&#39;format_title&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>requires</span> <span class=s>&#39;format_basic&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>requires</span> <span class=s>&#39;format_notes&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>requires</span> <span class=s>&#39;format_rating&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>スタイルごとの実装：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># SimpleFormatter.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>SimpleFormatter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>with</span> <span class=s>&#39;FormatterRole&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>format_name</span><span class=p>($self) {</span> <span class=s>&#39;Simple&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>format_title</span><span class=p>($self, $whisky) {</span> <span class=nv>$whisky</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>name</span><span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>format_basic</span><span class=p>($self, $whisky) {</span> <span class=s>&#34;$whisky-&gt;{region} $whisky-&gt;{rating}点&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>format_notes</span><span class=p>($self, $whisky) {</span> <span class=s>&#39;&#39;</span> <span class=p>}</span>  <span class=c1># シンプルでは省略</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>format_rating</span><span class=p>($self, $whisky) {</span> <span class=s>&#39;&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># ProFormatter.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>ProFormatter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>utf8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>with</span> <span class=s>&#39;FormatterRole&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>format_name</span><span class=p>($self) {</span> <span class=s>&#39;Pro&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>format_title</span><span class=p>($self, $whisky) {</span> <span class=nv>$whisky</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>name</span><span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>format_basic</span><span class=p>($self, $whisky) {</span>
</span></span><span class=line><span class=cl>    <span class=nb>join</span><span class=p>(</span><span class=s>&#39; / &#39;</span><span class=p>,</span> <span class=s>&#34;産地: $whisky-&gt;{region}&#34;</span><span class=p>,</span> <span class=s>&#34;熟成: $whisky-&gt;{age}年&#34;</span><span class=p>,</span> <span class=s>&#34;度数: $whisky-&gt;{abv}%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>format_notes</span><span class=p>($self, $whisky) {</span>
</span></span><span class=line><span class=cl>    <span class=nb>join</span><span class=p>(</span><span class=s>&#34;\n&#34;</span><span class=p>,</span> <span class=s>&#34;【香り】$whisky-&gt;{nose}&#34;</span><span class=p>,</span> <span class=s>&#34;【味わい】$whisky-&gt;{palate}&#34;</span><span class=p>,</span> <span class=s>&#34;【余韻】$whisky-&gt;{finish}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>format_rating</span><span class=p>($self, $whisky) {</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$rating</span> <span class=o>=</span> <span class=nv>$whisky</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>rating</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$stars</span> <span class=o>=</span> <span class=s>&#39;★&#39;</span> <span class=n>x</span> <span class=nb>int</span><span class=p>(</span><span class=nv>$rating</span> <span class=sr>/ 20) . &#39;☆&#39; x (5 - int($rating /</span> <span class=mi>20</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;$stars $rating/100&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>次に抽象側（出力形式）を定義：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># NoteAbstraction.pm（基底クラス）</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>NoteAbstraction</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>formatter</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>_get_title</span><span class=p>($self, $whisky) {</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=nn>formatter</span><span class=o>-&gt;</span><span class=n>format_title</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>_get_basic</span><span class=p>($self, $whisky) {</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=nn>formatter</span><span class=o>-&gt;</span><span class=n>format_basic</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>_get_notes</span><span class=p>($self, $whisky) {</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=nn>formatter</span><span class=o>-&gt;</span><span class=n>format_notes</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>_get_rating</span><span class=p>($self, $whisky) {</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=nn>formatter</span><span class=o>-&gt;</span><span class=n>format_rating</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># TextNote.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>TextNote</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>extends</span> <span class=s>&#39;NoteAbstraction&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>render</span><span class=p>($self, $whisky) {</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$title</span>  <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_get_title</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$basic</span>  <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_get_basic</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$notes</span>  <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_get_notes</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$rating</span> <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_get_rating</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$output</span> <span class=o>=</span> <span class=s>&#34;【$title】\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$output</span> <span class=o>.=</span> <span class=s>&#34;  $basic\n&#34;</span> <span class=k>if</span> <span class=nv>$basic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$output</span> <span class=o>.=</span> <span class=s>&#34;  $notes\n&#34;</span> <span class=k>if</span> <span class=nv>$notes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$output</span> <span class=o>.=</span> <span class=s>&#34;  $rating\n&#34;</span> <span class=k>if</span> <span class=nv>$rating</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$output</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># HtmlNote.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>HtmlNote</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>extends</span> <span class=s>&#39;NoteAbstraction&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>render</span><span class=p>($self, $whisky) {</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$title</span>  <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_get_title</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$basic</span>  <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_get_basic</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$notes</span>  <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_get_notes</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$rating</span> <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_get_rating</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$output</span> <span class=o>=</span> <span class=s>&#34;&lt;article&gt;\n  &lt;h2&gt;$title&lt;/h2&gt;\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$output</span> <span class=o>.=</span> <span class=s>&#34;  &lt;p class=\&#34;basic\&#34;&gt;$basic&lt;/p&gt;\n&#34;</span> <span class=k>if</span> <span class=nv>$basic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$output</span> <span class=o>.=</span> <span class=s>&#34;  &lt;div class=\&#34;notes\&#34;&gt;$notes&lt;/div&gt;\n&#34;</span> <span class=k>if</span> <span class=nv>$notes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$output</span> <span class=o>.=</span> <span class=s>&#34;  &lt;p class=\&#34;rating\&#34;&gt;$rating&lt;/p&gt;\n&#34;</span> <span class=k>if</span> <span class=nv>$rating</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$output</span> <span class=o>.=</span> <span class=s>&#34;&lt;/article&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$output</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=使い方-1>使い方</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># 出力形式×スタイルの組み合わせを自由に</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$text_simple</span> <span class=o>=</span> <span class=nn>TextNote</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>formatter</span> <span class=o>=&gt;</span> <span class=nn>SimpleFormatter</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$html_pro</span> <span class=o>=</span> <span class=nn>HtmlNote</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>formatter</span> <span class=o>=&gt;</span> <span class=nn>ProFormatter</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$md_detailed</span> <span class=o>=</span> <span class=nn>MarkdownNote</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>formatter</span> <span class=o>=&gt;</span> <span class=nn>DetailedFormatter</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>say</span> <span class=nv>$text_simple</span><span class=o>-&gt;</span><span class=n>render</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>say</span> <span class=nv>$html_pro</span><span class=o>-&gt;</span><span class=n>render</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>say</span> <span class=nv>$md_detailed</span><span class=o>-&gt;</span><span class=n>render</span><span class=p>(</span><span class=nv>$whisky</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=今回のポイント-2>今回のポイント</h3><ul><li><strong>Bridge</strong>は2つの独立した変動軸を分離する</li><li>n×m = 9パターンを n+m = 6クラスで実現</li><li>新しい出力形式やスタイルの追加が各1クラスで済む</li></ul><pre class=mermaid>
	classDiagram
    class NoteAbstraction {
        +formatter
        +render(whisky)
    }
    class TextNote {
        +render(whisky)
    }
    class HtmlNote {
        +render(whisky)
    }
    class MarkdownNote {
        +render(whisky)
    }
    class FormatterRole {
        &lt;&lt;Role&gt;&gt;
        +format_title()
        +format_basic()
        +format_notes()
        +format_rating()
    }
    class SimpleFormatter
    class DetailedFormatter
    class ProFormatter
    
    NoteAbstraction &lt;|-- TextNote
    NoteAbstraction &lt;|-- HtmlNote
    NoteAbstraction &lt;|-- MarkdownNote
    NoteAbstraction o-- FormatterRole
    FormatterRole &lt;|.. SimpleFormatter
    FormatterRole &lt;|.. DetailedFormatter
    FormatterRole &lt;|.. ProFormatter
</pre><hr><h2 id=第6章-画像の読み込みが重い>第6章: 画像の読み込みが重い！</h2><h3 id=今回の目標-5>今回の目標</h3><ul><li>ウイスキー画像の一括読み込みでパフォーマンス問題を体験</li><li>遅延ロードの必要性を理解</li></ul><h3 id=問題全件ロードが重い>問題：全件ロードが重い</h3><p>ウイスキー画像ギャラリーを追加しようとしました。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>package</span> <span class=nn>SlowGallery</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>images</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>default</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span> <span class=o>[]</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>load_all</span><span class=p>($self, @image_ids) {</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;画像を全件ロードします...&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>my</span> <span class=nv>$id</span> <span class=p>(</span><span class=nv>@image_ids</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>my</span> <span class=nv>$img</span> <span class=o>=</span> <span class=nn>WhiskyImage</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>id</span> <span class=o>=&gt;</span> <span class=nv>$id</span><span class=p>,</span> <span class=n>filename</span> <span class=o>=&gt;</span> <span class=s>&#34;whisky_$id.jpg&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1># 画像は生成時に即座にロードされる（重い！）</span>
</span></span><span class=line><span class=cl>        <span class=nb>push</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=nn>images</span><span class=o>-&gt;</span><span class=nv>@</span><span class=err>*</span><span class=p>,</span> <span class=nv>$img</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># WhiskyImage は生成時にデータをロード</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>WhiskyImage</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>filename</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>data</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;lazy&#39;</span><span class=p>,</span> <span class=n>builder</span> <span class=o>=&gt;</span> <span class=s>&#39;_load_image&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>_load_image</span><span class=p>($self) {</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;  [!] 画像をロード中: $self-&gt;{filename} (1秒かかる重い処理...)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>sleep</span> <span class=mi>1</span><span class=p>;</span>  <span class=c1># 重い処理をシミュレート</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;IMAGE_DATA_FOR_$self-&gt;{id}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>BUILD</span><span class=p>($self, $args) {</span>
</span></span><span class=line><span class=cl>    <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>  <span class=c1># 生成時に即座にロード（問題！）</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=実行結果>実行結果</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>=== ギャラリー初期化開始 ===
</span></span><span class=line><span class=cl>画像を全件ロードします...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  [!] 画像をロード中: whisky_1.jpg (1秒かかる重い処理...)
</span></span><span class=line><span class=cl>  [!] 画像をロード中: whisky_2.jpg (1秒かかる重い処理...)
</span></span><span class=line><span class=cl>  [!] 画像をロード中: whisky_3.jpg (1秒かかる重い処理...)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>=== ギャラリー初期化完了（3秒経過）===
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ユーザーが見たいのは1件目だけなのに、全件ロードしてしまった！
</span></span></code></pre></td></tr></table></div></div><h3 id=問題点-1>問題点</h3><div class=table-wrapper><table><thead><tr><th>問題</th><th>説明</th></tr></thead><tbody><tr><td>初期化が遅い</td><td>N件の画像があればN秒かかる</td></tr><tr><td>無駄なロード</td><td>ユーザーが見ない画像もロード</td></tr><tr><td>スケールしない</td><td>データが増えるほど遅くなる</td></tr></tbody></table></div><p>解決策は「必要な時だけロードする」＝<strong>遅延ロード</strong>です。</p><hr><h2 id=第7章-proxyで遅延キャッシュ制御>第7章: Proxyで遅延・キャッシュ・制御</h2><h3 id=今回の目標-6>今回の目標</h3><ul><li>Proxyパターンで遅延ロード、キャッシュ、アクセス制御を実装</li><li>3種類のProxyを体験</li></ul><h3 id=proxyパターンとは>Proxyパターンとは？</h3><p><strong>Proxyパターン</strong>は、別のオブジェクトへのアクセスを制御する代理オブジェクトを提供するパターンです。</p><blockquote><p>「何のために間に入る？」→ <strong>本物へのアクセスを制御するため</strong></p></blockquote><p><img src=/public_images/2026/001726/proxy_butler.png loading=lazy alt=Proxyパターン（執事）のイメージ></p><h3 id=proxyの3つの役割>Proxyの3つの役割</h3><div class=table-wrapper><table><thead><tr><th>種類</th><th>役割</th><th>例</th></tr></thead><tbody><tr><td>Virtual Proxy</td><td>遅延初期化</td><td>重い画像を必要な時だけロード</td></tr><tr><td>Cache Proxy</td><td>キャッシュ</td><td>外部API結果をTTL付きでキャッシュ</td></tr><tr><td>Protection Proxy</td><td>アクセス制御</td><td>権限のあるユーザーのみアクセス許可</td></tr></tbody></table></div><h3 id=1-imageproxy遅延ロード>1. ImageProxy（遅延ロード）</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>package</span> <span class=nn>ImageProxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>filename</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>real_image</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;lazy&#39;</span><span class=p>,</span> <span class=n>builder</span> <span class=o>=&gt;</span> <span class=s>&#39;_load_real_image&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=s>&#39;_loaded&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;rw&#39;</span><span class=p>,</span> <span class=n>default</span> <span class=o>=&gt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>_load_real_image</span><span class=p>($self) {</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;  [Proxy] 画像を遅延ロード中: $self-&gt;{filename}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>sleep</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_loaded</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;IMAGE_DATA_FOR_$self-&gt;{id}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># サムネイル表示（軽い処理）- 本物はロードしない</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>show_thumbnail</span><span class=p>($self) {</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;  [Proxy] サムネイル表示: $self-&gt;{filename} (本物は未ロード)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;THUMBNAIL_$self-&gt;{id}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 実際のデータが必要な時だけロード</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>get_data</span><span class=p>($self) {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>real_image</span><span class=p>;</span>  <span class=c1># lazyにより初回アクセス時のみロード</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>is_loaded</span><span class=p>($self) {</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_loaded</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>使い方：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>my</span> <span class=nv>$img_proxy</span> <span class=o>=</span> <span class=nn>ImageProxy</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>id</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span> <span class=n>filename</span> <span class=o>=&gt;</span> <span class=s>&#39;yamazaki12.jpg&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>say</span> <span class=s>&#34;画像Proxy作成（まだロードされていない）&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$img_proxy</span><span class=o>-&gt;</span><span class=n>show_thumbnail</span><span class=p>;</span>  <span class=c1># 本物はロードしない（軽い）</span>
</span></span><span class=line><span class=cl><span class=c1># → [Proxy] サムネイル表示: yamazaki12.jpg (本物は未ロード)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$img_proxy</span><span class=o>-&gt;</span><span class=n>get_data</span><span class=p>;</span>  <span class=c1># この時点で初めてロード</span>
</span></span><span class=line><span class=cl><span class=c1># → [Proxy] 画像を遅延ロード中: yamazaki12.jpg</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2-ratingproxyキャッシュ>2. RatingProxy（キャッシュ）</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>package</span> <span class=nn>RatingProxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>whisky_id</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=s>&#39;_cache&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;rw&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=s>&#39;_cache_time&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;rw&#39;</span><span class=p>,</span> <span class=n>default</span> <span class=o>=&gt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>cache_ttl</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>default</span> <span class=o>=&gt;</span> <span class=mi>60</span><span class=p>);</span>  <span class=c1># 60秒キャッシュ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>_fetch_rating</span><span class=p>($self) {</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=s>&#34;  [Proxy] 外部APIから評価を取得中...&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>sleep</span> <span class=mi>1</span><span class=p>;</span>  <span class=c1># 重い処理をシミュレート</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=n>score</span> <span class=o>=&gt;</span> <span class=mi>92</span><span class=p>,</span> <span class=n>reviews</span> <span class=o>=&gt;</span> <span class=mi>150</span><span class=p>,</span> <span class=n>avg_price</span> <span class=o>=&gt;</span> <span class=mi>8000</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>get_rating</span><span class=p>($self) {</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$now</span> <span class=o>=</span> <span class=nb>time</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># キャッシュが有効か確認</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_cache</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nv>$now</span> <span class=o>-</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_cache_time</span><span class=p>)</span> <span class=o>&lt;</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>cache_ttl</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>say</span> <span class=s>&#34;  [Proxy] キャッシュから評価を返却&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_cache</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># キャッシュがないか期限切れ → 外部から取得</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$rating</span> <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_fetch_rating</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_cache</span><span class=p>(</span><span class=nv>$rating</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_cache_time</span><span class=p>(</span><span class=nv>$now</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$rating</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>invalidate_cache</span><span class=p>($self) {</span>
</span></span><span class=line><span class=cl>    <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_cache</span><span class=p>(</span><span class=nb>undef</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_cache_time</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=3-accessproxyアクセス制御>3. AccessProxy（アクセス制御）</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>package</span> <span class=nn>AccessProxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>private_note</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>owner_id</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>permission_level</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>default</span> <span class=o>=&gt;</span> <span class=s>&#39;private&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>can_access</span><span class=p>($self, $user_id, $is_friend = 0) {</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$level</span> <span class=o>=</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>permission_level</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span> <span class=k>if</span> <span class=nv>$level</span> <span class=ow>eq</span> <span class=s>&#39;public&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nv>$user_id</span> <span class=ow>eq</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>owner_id</span> <span class=o>||</span> <span class=nv>$is_friend</span><span class=p>)</span> <span class=k>if</span> <span class=nv>$level</span> <span class=ow>eq</span> <span class=s>&#39;friends&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nv>$user_id</span> <span class=ow>eq</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>owner_id</span><span class=p>);</span>  <span class=c1># private</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>get_note</span><span class=p>($self, $user_id, $is_friend = 0) {</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$self</span><span class=o>-&gt;</span><span class=n>can_access</span><span class=p>(</span><span class=nv>$user_id</span><span class=p>,</span> <span class=nv>$is_friend</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>say</span> <span class=s>&#34;  [Proxy] アクセス許可: user=$user_id&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>private_note</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>say</span> <span class=s>&#34;  [Proxy] アクセス拒否: user=$user_id&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span> <span class=n>error</span> <span class=o>=&gt;</span> <span class=s>&#39;Access denied&#39;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=今回のポイント-3>今回のポイント</h3><ul><li><strong>Proxy</strong>は本物へのアクセスを制御する</li><li>遅延ロード・キャッシュ・認証の3つの役割がある</li><li>クライアントはProxyと本物を区別しなくてよい</li></ul><hr><h2 id=第8章-3つのパターンを統合する>第8章: 3つのパターンを統合する</h2><h3 id=今回の目標-7>今回の目標</h3><ul><li>Adapter → Bridge → Proxy の連携でアプリケーション全体を構築</li><li>3パターンがどう協調するかを体験</li></ul><h3 id=全体像>全体像</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────┐    ┌─────────────┐    ┌─────────────┐
</span></span><span class=line><span class=cl>│   Adapter   │ → │   Bridge    │ → │    Proxy    │
</span></span><span class=line><span class=cl>│(データ取得) │    │(出力生成)   │    │(制御・最適化)│
</span></span><span class=line><span class=cl>└─────────────┘    └─────────────┘    └─────────────┘
</span></span><span class=line><span class=cl>      ↓                 ↓                  ↓
</span></span><span class=line><span class=cl> CSV/JSON/API     Text/HTML/MD ×      遅延ロード
</span></span><span class=line><span class=cl> を統一IF化       Simple/Detail/Pro   キャッシュ/認証
</span></span></code></pre></td></tr></table></div></div><h3 id=統合版コード>統合版コード</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=ch>#!/usr/bin/env perl</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.36</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Adapterパターン: データソース統一</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>CsvAdapter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonAdapter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bridgeパターン: 出力形式×スタイル</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>TextNote</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>HtmlNote</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>SimpleFormatter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>ProFormatter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Proxyパターン: 遅延・キャッシュ・制御</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>ImageProxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>RatingProxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 1: Adapter でデータソースを統一</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$csv_adapter</span> <span class=o>=</span> <span class=nn>CsvAdapter</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>csv_data</span> <span class=o>=&gt;</span> <span class=nv>$csv_data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$json_adapter</span> <span class=o>=</span> <span class=nn>JsonAdapter</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>json_data</span> <span class=o>=&gt;</span> <span class=nv>$json_data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>@all_whiskies</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>push</span> <span class=nv>@all_whiskies</span><span class=p>,</span> <span class=nv>$csv_adapter</span><span class=o>-&gt;</span><span class=n>get_all</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>push</span> <span class=nv>@all_whiskies</span><span class=p>,</span> <span class=nv>$json_adapter</span><span class=o>-&gt;</span><span class=n>get_all</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>say</span> <span class=s>&#34;合計: &#34;</span> <span class=o>.</span> <span class=nb>scalar</span><span class=p>(</span><span class=nv>@all_whiskies</span><span class=p>)</span> <span class=o>.</span> <span class=s>&#34; 件のウイスキー&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 2: Bridge で出力形式×スタイルを組み合わせ</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$text_simple</span> <span class=o>=</span> <span class=nn>TextNote</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>formatter</span> <span class=o>=&gt;</span> <span class=nn>SimpleFormatter</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$html_pro</span> <span class=o>=</span> <span class=nn>HtmlNote</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>formatter</span> <span class=o>=&gt;</span> <span class=nn>ProFormatter</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>my</span> <span class=nv>$w</span> <span class=p>(</span><span class=nv>@all_whiskies</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>say</span> <span class=nv>$text_simple</span><span class=o>-&gt;</span><span class=n>render</span><span class=p>(</span><span class=nv>$w</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 3: Proxy で遅延・キャッシュ</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$img_proxy</span> <span class=o>=</span> <span class=nn>ImageProxy</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>id</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span> <span class=n>filename</span> <span class=o>=&gt;</span> <span class=s>&#39;yamazaki12.jpg&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$img_proxy</span><span class=o>-&gt;</span><span class=n>show_thumbnail</span><span class=p>;</span>  <span class=c1># 軽い処理</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$rating_proxy</span> <span class=o>=</span> <span class=nn>RatingProxy</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>whisky_id</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$rating</span> <span class=o>=</span> <span class=nv>$rating_proxy</span><span class=o>-&gt;</span><span class=n>get_rating</span><span class=p>;</span>  <span class=c1># 初回は外部から</span>
</span></span><span class=line><span class=cl><span class=nv>$rating</span> <span class=o>=</span> <span class=nv>$rating_proxy</span><span class=o>-&gt;</span><span class=n>get_rating</span><span class=p>;</span>     <span class=c1># 2回目はキャッシュから</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=データフローの可視化>データフローの可視化</h3><pre class=mermaid>
	flowchart LR
    subgraph Adapter[&#34;Adapter Layer&#34;]
        CSV[(CSV)] --&gt; CsvAdapter
        JSON[(JSON)] --&gt; JsonAdapter
        CsvAdapter --&gt; UnifiedIF[Unified Interface]
        JsonAdapter --&gt; UnifiedIF
    end
    
    subgraph Bridge[&#34;Bridge Layer&#34;]
        UnifiedIF --&gt; Note[NoteAbstraction]
        Note --&gt; Text[TextNote]
        Note --&gt; HTML[HtmlNote]
        Note --&gt; MD[MarkdownNote]
        Formatter[FormatterRole] --&gt; Simple[SimpleFormatter]
        Formatter --&gt; Detailed[DetailedFormatter]
        Formatter --&gt; Pro[ProFormatter]
        Note -.-&gt; Formatter
    end
    
    subgraph Proxy[&#34;Proxy Layer&#34;]
        ImgProxy[ImageProxy] --&gt; |遅延| RealImage[Real Image]
        RatingProxy --&gt; |キャッシュ| ExternalAPI[External API]
        AccessProxy --&gt; |認証| PrivateNote[Private Note]
    end
    
    Text --&gt; ImgProxy
    HTML --&gt; RatingProxy
</pre><hr><h2 id=第9章-振り返り3つの間に入るパターン>第9章: 振り返り〜3つの「間に入る」パターン</h2><h3 id=3パターンの本質的な違い>3パターンの本質的な違い</h3><div class=table-wrapper><table><thead><tr><th>パターン</th><th>何のために「間に入る」か</th><th>問題を解決する対象</th></tr></thead><tbody><tr><td><strong>Adapter</strong></td><td>異なるインターフェースを統一する</td><td>インターフェースの不一致</td></tr><tr><td><strong>Bridge</strong></td><td>2つの変動軸を分離する</td><td>組み合わせ爆発</td></tr><tr><td><strong>Proxy</strong></td><td>本物へのアクセスを制御する</td><td>パフォーマンス・セキュリティ</td></tr></tbody></table></div><h3 id=使い分けの判断基準>使い分けの判断基準</h3><pre class=mermaid>
	flowchart TD
    Q1{既存のインターフェースが&lt;br&gt;異なる？}
    Q2{2つの独立した&lt;br&gt;変動軸がある？}
    Q3{アクセス制御・遅延・&lt;br&gt;キャッシュが必要？}
    
    Q1 --&gt;|Yes| Adapter[Adapter Pattern]
    Q1 --&gt;|No| Q2
    Q2 --&gt;|Yes| Bridge[Bridge Pattern]
    Q2 --&gt;|No| Q3
    Q3 --&gt;|Yes| Proxy[Proxy Pattern]
    Q3 --&gt;|No| Other[他のパターンを検討]
</pre><h3 id=今回作ったクラス構成>今回作ったクラス構成</h3><div class=table-wrapper><table><thead><tr><th>レイヤー</th><th>クラス</th><th>役割</th></tr></thead><tbody><tr><td>Adapter</td><td><code>WhiskySourceRole</code></td><td>統一インターフェース</td></tr><tr><td>Adapter</td><td><code>CsvAdapter</code>,<code>JsonAdapter</code></td><td>データ変換</td></tr><tr><td>Bridge</td><td><code>NoteAbstraction</code></td><td>抽象側基底</td></tr><tr><td>Bridge</td><td><code>TextNote</code>,<code>HtmlNote</code>,<code>MarkdownNote</code></td><td>出力形式</td></tr><tr><td>Bridge</td><td><code>FormatterRole</code></td><td>実装側インターフェース</td></tr><tr><td>Bridge</td><td><code>SimpleFormatter</code>,<code>DetailedFormatter</code>,<code>ProFormatter</code></td><td>スタイル</td></tr><tr><td>Proxy</td><td><code>ImageProxy</code></td><td>遅延ロード</td></tr><tr><td>Proxy</td><td><code>RatingProxy</code></td><td>キャッシュ</td></tr><tr><td>Proxy</td><td><code>AccessProxy</code></td><td>アクセス制御</td></tr></tbody></table></div><h3 id=発展的な学習>発展的な学習</h3><p>本シリーズで学んだパターンの応用：</p><ol><li><strong>Adapter + Factory</strong>: 複数のAdapterを動的に選択</li><li><strong>Bridge + Decorator</strong>: 出力に追加の装飾を適用</li><li><strong>Proxy + Chain of Responsibility</strong>: 複数のProxyを連鎖</li></ol><h3 id=まとめ>まとめ</h3><p>「全部『間に入る』パターンでしょ？」という疑問から出発し、それぞれが<strong>なぜ</strong>間に入るのかを体験しました。</p><ul><li><strong>Adapter</strong>: 異なるものを同じに見せる</li><li><strong>Bridge</strong>: 2つの軸を独立させる</li><li><strong>Proxy</strong>: 本物へのアクセスをコントロールする</li></ul><p>この違いが「手で」わかるようになったら、もう「if/elseに戻ってしまう」ことはありません。</p><p>ウイスキーのテイスティングノートを楽しみながら、デザインパターンも楽しんでください。🥃</p></section><footer class=article-footer><section class=article-tags><a href=/tags/perl/>Perl</a>
<a href=/tags/moo/>Moo</a>
<a href=/tags/design-patterns/>Design-Patterns</a>
<a href=/tags/bridge/>Bridge</a>
<a href=/tags/adapter/>Adapter</a>
<a href=/tags/proxy/>Proxy</a>
<a href=/tags/whisky/>Whisky</a>
<a href=/tags/hands-on/>Hands-On</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>関連するコンテンツ</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/2026/02/07/000257/><div class=article-image><img src=/public_images/2026/flyweight-prototype-abstract-factory-series-image.jpg loading=lazy data-key data-hash=/public_images/2026/flyweight-prototype-abstract-factory-series-image.jpg></div><div class=article-details><h2 class=article-title>Perlで作るウイスキーテイスティングカード生成器（Abstract Factory × Flyweight × Prototype）</h2></div></a></article><article class=has-image><a href=/warehouse/singleton-flyweight-proxy-combination/><div class=article-image><img src=/favicon.png loading=lazy data-key data-hash=/favicon.png></div><div class=article-details><h2 class=article-title>Singleton × Flyweight × Proxy パターン組み合わせ調査ドキュメント</h2></div></a></article><article class=has-image><a href=/2026/02/08/000550/><div class=article-image><img src=/public_images/2026/interpreter-visitor-composite-series-image.jpg loading=lazy data-key data-hash=/public_images/2026/interpreter-visitor-composite-series-image.jpg></div><div class=article-details><h2 class=article-title>Perlで作る正規表現リファインリー（Interpreter × Visitor × Composite）</h2></div></a></article><article class=has-image><a href=/2026/02/06/000740/><div class=article-image><img src=/public_images/2026/whisky-profile-generator-image.jpg loading=lazy data-key data-hash=/public_images/2026/whisky-profile-generator-image.jpg></div><div class=article-details><h2 class=article-title>PerlとMooでウイスキーのテイスティングノート自動生成システムを作ってみよう</h2></div></a></article><article class=has-image><a href=/2026/02/02/004531/><div class=article-image><img src=/public_images/2026/singleton-flyweight-proxy-series-image.jpg loading=lazy data-key data-hash=/public_images/2026/singleton-flyweight-proxy-series-image.jpg></div><div class=article-details><h2 class=article-title>Perlで作るASCIIアート・フォントレンダラー（Singleton × Flyweight × Proxy）</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//nqounet.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2000 -
2026 設計パターンを疑え</section><section class=powerby><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> で構築されています。<br>テーマ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> は <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> によって設計されています。</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>