---
description: 記事のコード例が正しく動作するかを検証するワークフロー
---

# 記事コード検証ワークフロー

> 入力: 記事ファイルパス（例: `content/post/2026/02/01/093248.md`）
> 出力: 検証結果レポート（例: `agents/tests/2026/02/01/093248.md`）

---

## Step 1: 事前準備

### 1.1 環境確認

// turbo
1. Perl バージョン確認: `perl -v`
2. **v5.36 未満の場合**: ユーザーにバージョンを通知し、確認を取る

### 1.2 記事の読み込み

1. 入力された記事パスを読み込む
2. 記事内のコードブロック（```perl ... ```）を全て抽出
3. コードブロックごとに以下を記録:
   - 章番号・タイトル（直近の見出しから取得）
   - コードの内容
   - 実行可能かどうか（スタンドアロンか断片か）

---

## Step 2: 検証ディレクトリの準備

1. 記事パスからYYYY/MM/DD/HHmmSSを抽出
   - 例: `content/post/2026/02/01/093248.md` → `2026/02/01/093248`
2. 検証ディレクトリを作成: `agents/tests/YYYY/MM/DD/`
   - 例: `agents/tests/2026/02/01/`

---

## Step 3: コードの抽出と実行

各コードブロックについて:

### 3.1 実行可能なコードの判定

以下の特徴を持つコードを「実行可能」と判定:
- `#!/usr/bin/env perl` または `use v5.36;` で始まる
- `package main` ブロックを含む
- 完結したスクリプトとして動作する

### 3.2 コードファイルの作成

// turbo
1. 一時ファイルに保存: `/tmp/verify_code_<章番号>.pl`
2. 実行権限を付与（必要な場合）

### 3.3 コードの実行

// turbo
1. `perl /tmp/verify_code_<章番号>.pl` を実行
2. 結果を記録:
   - 終了コード
   - 標準出力
   - 標準エラー出力
   - 実行時間（可能であれば）

### 3.4 検証結果の判定

- **✅ PASS**: 終了コード0、警告なし
- **⚠️ WARN**: 終了コード0だが警告あり
- **❌ FAIL**: 終了コード非0、またはエラー発生

---

## Step 4: 検証レポートの作成

1. レポートファイルを作成: `agents/tests/YYYY/MM/DD/HHmmSS.md`

### レポートフォーマット

```markdown
# コード検証レポート

- 記事: [タイトル](記事へのリンク)
- 検証日時: YYYY-MM-DD HH:MM:SS
- 検証環境: Perl vX.XX

## サマリー

| 結果 | 件数 |
|------|------|
| ✅ PASS | X |
| ⚠️ WARN | X |
| ❌ FAIL | X |
| ⏭️ SKIP | X |

---

## 第N章: 章タイトル

### コードブロック 1

**ステータス**: ✅ PASS / ⚠️ WARN / ❌ FAIL / ⏭️ SKIP

<details>
<summary>コード</summary>

\`\`\`perl
# 抽出されたコード
\`\`\`

</details>

<details>
<summary>実行結果</summary>

\`\`\`
# 出力結果
\`\`\`

</details>

**備考**: （警告やエラーの詳細、スキップ理由など）

---

（以下、各コードブロックについて繰り返し）
```

---

## Step 5: 完了処理

1. 一時ファイルを削除
2. 検証結果サマリーをユーザーに報告

### 報告内容

- 検証した記事のパス
- 検証結果レポートのパス
- パス/警告/失敗/スキップの件数
- 重大な問題があれば詳細

---

## 補足: スキップされるコード

以下のコードは実行せず、SKIP として記録:

1. 断片的なコード（完結していない例示）
2. 実行結果の例示ブロック（```text や ``` のみ）
3. Mermaid図などの非Perlコード
4. 明示的にエラーを起こす意図のコード（コメントで示されている場合）

---

## 補足: 依存関係

記事内のコードが依存するモジュールがある場合:

1. `Moo` などCPANモジュールの確認: `perl -MMoo -e1`
2. 未インストールの場合はユーザーに通知

---

## エラー時の対応

- Perl環境がない場合: エラーを報告して終了
- コードがクラッシュした場合: FAILとして記録し、次のコードへ進む
- タイムアウト（30秒以上）: 強制終了してFAILとして記録
