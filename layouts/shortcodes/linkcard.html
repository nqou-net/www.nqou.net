<link rel="stylesheet" href="/css/linkcard.css">
{{- $url := .Get "url" | default (.Get 0) -}}
{{- if not $url -}}
  {{- errorf "linkcard shortcode requires a 'url' parameter" -}}
{{- end -}}

{{/* Validate URL protocol for security */}}
{{- if not (or (hasPrefix $url "http://") (hasPrefix $url "https://")) -}}
  {{- errorf "linkcard shortcode only supports http:// and https:// URLs, got: %s" $url -}}
{{- end -}}

{{- $title := "" -}}
{{- $description := "" -}}
{{- $image := "" -}}
{{- $siteName := "" -}}
{{- $favicon := "" -}}

{{- $parsedURL := urls.Parse $url -}}
{{- $domain := $parsedURL.Host -}}
{{- $faviconURL := printf "%s://%s/favicon.ico" $parsedURL.Scheme $domain -}}

{{- with try (resources.GetRemote $url) -}}
  {{- with .Err -}}
    {{- warnf "linkcard: failed to fetch %s: %s" $url . -}}
  {{- else with .Value -}}
    {{- $content := .Content -}}

    {{/* Extract og:title - handles both quote types in content values */}}
    {{- $ogTitleMatch := findRE `<meta[^>]*property=["']og:title["'][^>]*content="([^"]*)"[^>]*>` $content 1 -}}
    {{- if not $ogTitleMatch -}}
      {{- $ogTitleMatch = findRE `<meta[^>]*property=["']og:title["'][^>]*content='([^']*)'[^>]*>` $content 1 -}}
    {{- end -}}
    {{- if not $ogTitleMatch -}}
      {{- $ogTitleMatch = findRE `<meta[^>]*content="([^"]*)"[^>]*property=["']og:title["'][^>]*>` $content 1 -}}
    {{- end -}}
    {{- if not $ogTitleMatch -}}
      {{- $ogTitleMatch = findRE `<meta[^>]*content='([^']*)'[^>]*property=["']og:title["'][^>]*>` $content 1 -}}
    {{- end -}}
    {{- range $ogTitleMatch -}}
      {{- $title = replaceRE `.*content=["']([^"']*)["'].*` "$1" . -}}
    {{- end -}}

    {{/* Fallback to <title> tag if og:title not found */}}
    {{- if not $title -}}
      {{- $titleMatch := findRE `<title[^>]*>([^<]+)</title>` $content 1 -}}
      {{- range $titleMatch -}}
        {{- $title = replaceRE `<title[^>]*>([^<]+)</title>` "$1" . -}}
      {{- end -}}
    {{- end -}}

    {{/* Extract og:description - handles both quote types in content values */}}
    {{- $ogDescMatch := findRE `<meta[^>]*property=["']og:description["'][^>]*content="([^"]*)"[^>]*>` $content 1 -}}
    {{- if not $ogDescMatch -}}
      {{- $ogDescMatch = findRE `<meta[^>]*property=["']og:description["'][^>]*content='([^']*)'[^>]*>` $content 1 -}}
    {{- end -}}
    {{- if not $ogDescMatch -}}
      {{- $ogDescMatch = findRE `<meta[^>]*content="([^"]*)"[^>]*property=["']og:description["'][^>]*>` $content 1 -}}
    {{- end -}}
    {{- if not $ogDescMatch -}}
      {{- $ogDescMatch = findRE `<meta[^>]*content='([^']*)'[^>]*property=["']og:description["'][^>]*>` $content 1 -}}
    {{- end -}}
    {{- range $ogDescMatch -}}
      {{- $description = replaceRE `.*content=["']([^"']*)["'].*` "$1" . -}}
    {{- end -}}

    {{/* Fallback to meta description if og:description not found - handles both quote types */}}
    {{- if not $description -}}
      {{- $descMatch := findRE `<meta[^>]*name=["']description["'][^>]*content="([^"]*)"[^>]*>` $content 1 -}}
      {{- if not $descMatch -}}
        {{- $descMatch = findRE `<meta[^>]*name=["']description["'][^>]*content='([^']*)'[^>]*>` $content 1 -}}
      {{- end -}}
      {{- if not $descMatch -}}
        {{- $descMatch = findRE `<meta[^>]*content="([^"]*)"[^>]*name=["']description["'][^>]*>` $content 1 -}}
      {{- end -}}
      {{- if not $descMatch -}}
        {{- $descMatch = findRE `<meta[^>]*content='([^']*)'[^>]*name=["']description["'][^>]*>` $content 1 -}}
      {{- end -}}
      {{- range $descMatch -}}
        {{- $description = replaceRE `.*content=["']([^"']*)["'].*` "$1" . -}}
      {{- end -}}
    {{- end -}}

    {{/* Extract og:image - handles both quote types in content values */}}
    {{- $ogImageMatch := findRE `<meta[^>]*property=["']og:image["'][^>]*content="([^"]*)"[^>]*>` $content 1 -}}
    {{- if not $ogImageMatch -}}
      {{- $ogImageMatch = findRE `<meta[^>]*property=["']og:image["'][^>]*content='([^']*)'[^>]*>` $content 1 -}}
    {{- end -}}
    {{- if not $ogImageMatch -}}
      {{- $ogImageMatch = findRE `<meta[^>]*content="([^"]*)"[^>]*property=["']og:image["'][^>]*>` $content 1 -}}
    {{- end -}}
    {{- if not $ogImageMatch -}}
      {{- $ogImageMatch = findRE `<meta[^>]*content='([^']*)'[^>]*property=["']og:image["'][^>]*>` $content 1 -}}
    {{- end -}}
    {{- range $ogImageMatch -}}
      {{- $image = replaceRE `.*content=["']([^"']*)["'].*` "$1" . -}}
    {{- end -}}

    {{/* Extract og:site_name - handles both quote types in content values */}}
    {{- $ogSiteMatch := findRE `<meta[^>]*property=["']og:site_name["'][^>]*content="([^"]*)"[^>]*>` $content 1 -}}
    {{- if not $ogSiteMatch -}}
      {{- $ogSiteMatch = findRE `<meta[^>]*property=["']og:site_name["'][^>]*content='([^']*)'[^>]*>` $content 1 -}}
    {{- end -}}
    {{- if not $ogSiteMatch -}}
      {{- $ogSiteMatch = findRE `<meta[^>]*content="([^"]*)"[^>]*property=["']og:site_name["'][^>]*>` $content 1 -}}
    {{- end -}}
    {{- if not $ogSiteMatch -}}
      {{- $ogSiteMatch = findRE `<meta[^>]*content='([^']*)'[^>]*property=["']og:site_name["'][^>]*>` $content 1 -}}
    {{- end -}}
    {{- range $ogSiteMatch -}}
      {{- $siteName = replaceRE `.*content=["']([^"']*)["'].*` "$1" . -}}
    {{- end -}}

  {{- end -}}
{{- end -}}

{{- if not $title -}}
  {{- $title = $url -}}
{{- end -}}

{{- if not $siteName -}}
  {{- $siteName = $domain -}}
{{- end -}}

<div class="linkcard">
  <a class="linkcard-a" href="{{ $url }}" target="_blank" rel="noopener noreferrer">
    {{- if and $image (or (hasPrefix $image "http://") (hasPrefix $image "https://")) }}
    <div class="linkcard-image">
      <img src="{{ $image }}" alt="{{ $title | plainify }}" loading="lazy" />
    </div>
    {{- end }}
    <div class="linkcard-content">
      <div class="linkcard-title">{{ $title | plainify }}</div>
      {{- if $description }}
      <div class="linkcard-description">{{ $description | plainify | truncate 120 }}</div>
      {{- end }}
      <div class="linkcard-meta">
        <img class="linkcard-favicon" src="{{ $faviconURL }}" alt="" onerror="this.style.display='none'" />
        <span class="linkcard-domain">{{ $siteName | plainify }}</span>
      </div>
    </div>
  </a>
</div>
