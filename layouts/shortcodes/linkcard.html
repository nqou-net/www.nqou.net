{{- $url := .Get "url" | default (.Get 0) -}}
{{- if not $url -}}
  {{- errorf "linkcard shortcode requires a 'url' parameter" -}}
{{- end -}}

{{- $title := "" -}}
{{- $description := "" -}}
{{- $image := "" -}}
{{- $siteName := "" -}}
{{- $favicon := "" -}}

{{- /* Reject internal links outright */ -}}
{{- if hasPrefix $url "/" -}}
  {{- errorf "linkcard: internal links are not allowed: %s" $url -}}
{{- end -}}

{{- /* Validate URL protocol for security */ -}}
{{- if not (or (hasPrefix $url "http://") (hasPrefix $url "https://")) -}}
  {{- errorf "linkcard shortcode only supports http://, https:// URLs, got: %s" $url -}}
{{- end -}}

{{- /* opt-out param for dangerous fetches */ -}}
{{- $nofetch := .Get "nofetch" | default "true" -}}

{{- $parsedURL := urls.Parse $url -}}
{{- $domain := $parsedURL.Host -}}
{{- $favicon = printf "%s://%s/favicon.ico" $parsedURL.Scheme $domain -}}

{{- /* same-origin / self-reference detection */ -}}
{{- $parsedSite := urls.Parse site.BaseURL -}}
{{- $sameHost := eq $parsedURL.Host $parsedSite.Host -}}
{{- $isSelf := false -}}
{{- if or (eq $url .Page.Permalink) (eq $parsedURL.Path .Page.RelPermalink) -}}
  {{- $isSelf = true -}}
{{- end -}}

{{- /* If requested to nofetch, or if target is same-origin or self, skip remote fetch to avoid recursion */ -}}
{{- if or (eq $nofetch "true") $sameHost $isSelf -}}
  {{- /* Provide a safe fallback without performing resources.GetRemote */ -}}
  {{- if $sameHost -}}
    {{- $siteName = site.Title -}}
  {{- else -}}
    {{- $siteName = $domain -}}
  {{- end -}}
  {{- $title = $url -}}
{{- else -}}
  {{- with try (resources.GetRemote $url) -}}
    {{- with .Err -}}
      {{- warnf "linkcard: failed to fetch %s: %s" $url . -}}
    {{- else with .Value -}}
      {{- $content := .Content -}}

      {{/* Extract og:title */}}
      {{- $ogTitleMatch := findRE `(?i)<meta[^>]*(?:property|name)=["']og:title["'][^>]*content=["']([^"']+)["'][^>]*>` $content 1 -}}
      {{- range $ogTitleMatch -}}
        {{- $title = replaceRE `.*content=["']([^"']*)["'].*` "$1" . -}}
      {{- end -}}

      {{/* Fallback to <title> tag if og:title not found */}}
      {{- if not $title -}}
        {{- $titleMatch := findRE `<title[^>]*>([^<]+)</title>` $content 1 -}}
        {{- range $titleMatch -}}
          {{- $title = replaceRE `<title[^>]*>([^<]+)</title>` "$1" . -}}
        {{- end -}}
      {{- end -}}

      {{/* Extract og:description */}}
      {{- $ogDescMatch := findRE `(?i)<meta[^>]*(?:property|name)=["']og:description["'][^>]*content=["']([^"']+)["'][^>]*>` $content 1 -}}
      {{- range $ogDescMatch -}}
        {{- $description = replaceRE `.*content=["']([^"']*)["'].*` "$1" . -}}
      {{- end -}}

      {{/* Fallback to meta description if og:description not found */}}
      {{- if not $description -}}
        {{- $descMatch := findRE `(?i)<meta[^>]*name=["']description["'][^>]*content=["']([^"']+)["'][^>]*>` $content 1 -}}
        {{- range $descMatch -}}
          {{- $description = replaceRE `.*content=["']([^"']*)["'].*` "$1" . -}}
        {{- end -}}
      {{- end -}}

      {{/* Extract og:image */}}
      {{- $ogImageMatch := findRE `(?i)<meta[^>]*(?:property|name)=["']og:image["'][^>]*content=["']([^"']+)["'][^>]*>` $content 1 -}}
      {{- range $ogImageMatch -}}
        {{- $image = replaceRE `.*content=["']([^"']*)["'].*` "$1" . -}}
      {{- end -}}

      {{/* Extract og:site_name */}}
      {{- $ogSiteMatch := findRE `(?i)<meta[^>]*(?:property|name)=["']og:site_name["'][^>]*content=["']([^"']+)["'][^>]*>` $content 1 -}}
      {{- range $ogSiteMatch -}}
        {{- $siteName = replaceRE `.*content=["']([^"']*)["'].*` "$1" . -}}
      {{- end -}}

    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if not $title -}}
  {{- $title = $url -}}
{{- end -}}

{{- if not $siteName -}}
  {{- $siteName = $domain -}}
{{- end -}}

<div class="linkcard">
  <a class="linkcard-a" href="{{ $url }}" target="_blank" rel="noopener noreferrer nofollow" title="{{ $title | plainify }}" aria-label="{{ $title | plainify }}">
    {{- if and $image (or (hasPrefix $image "http://") (hasPrefix $image "https://") (hasPrefix $image "/")) }}
    <div class="linkcard-image">
      {{- if hasPrefix $image "/" -}}
      <img src="{{ $image | relURL }}" alt="{{ $title | plainify }}" loading="lazy" />
      {{- else -}}
      <img src="{{ $image }}" alt="{{ $title | plainify }}" loading="lazy" />
      {{- end -}}
    </div>
    {{- end }}
    <div class="linkcard-content">
      <div class="linkcard-title">{{ $title | plainify }}</div>
      {{- if $description }}
      <div class="linkcard-description">{{ $description | plainify | truncate 120 }}</div>
      {{- end }}
      <div class="linkcard-meta">
        {{- if $favicon -}}
        <img class="linkcard-favicon" src="{{ $favicon }}" alt="" onerror="this.style.display='none'" />
        {{- end -}}
        <span class="linkcard-domain">{{ $siteName | plainify }}</span>
      </div>
    </div>
  </a>
</div>
