<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Perlã®Mojoliciousã§WebSocketã‚’å®Ÿè£…ã™ã‚‹å®Œå…¨ã‚¬ã‚¤ãƒ‰ã€‚ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’3ã‚¹ãƒ†ãƒƒãƒ—ã§æ§‹ç¯‰ã€‚åˆå¿ƒè€…ã§ã‚‚æ•°è¡Œã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã‚‹å®Ÿè·µãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€‚"><title>Perl WebSocketå…¥é–€ï¼šMojoliciousã§ä½œã‚‹3ã¤ã®å®Ÿè·µã‚¢ãƒ—ãƒª</title><link rel=canonical href=https://www.nqou.net/2025/12/14/183305/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="Perl WebSocketå…¥é–€ï¼šMojoliciousã§ä½œã‚‹3ã¤ã®å®Ÿè·µã‚¢ãƒ—ãƒª"><meta property='og:description' content="Perlã®Mojoliciousã§WebSocketã‚’å®Ÿè£…ã™ã‚‹å®Œå…¨ã‚¬ã‚¤ãƒ‰ã€‚ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’3ã‚¹ãƒ†ãƒƒãƒ—ã§æ§‹ç¯‰ã€‚åˆå¿ƒè€…ã§ã‚‚æ•°è¡Œã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã‚‹å®Ÿè·µãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€‚"><meta property='og:url' content='https://www.nqou.net/2025/12/14/183305/'><meta property='og:site_name' content='è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç–‘ãˆ'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='perl'><meta property='article:tag' content='mojolicious'><meta property='article:tag' content='websocket'><meta property='article:tag' content='real-time'><meta property='article:tag' content='web-development'><meta property='article:tag' content='tutorial'><meta property='article:published_time' content='2025-12-14T18:33:05+09:00'><meta property='article:modified_time' content='2025-12-14T18:33:05+09:00'><meta property='og:image' content='https://www.nqou.net/public_images/2025/1765704785-image.jpg'><meta name=twitter:title content="Perl WebSocketå…¥é–€ï¼šMojoliciousã§ä½œã‚‹3ã¤ã®å®Ÿè·µã‚¢ãƒ—ãƒª"><meta name=twitter:description content="Perlã®Mojoliciousã§WebSocketã‚’å®Ÿè£…ã™ã‚‹å®Œå…¨ã‚¬ã‚¤ãƒ‰ã€‚ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’3ã‚¹ãƒ†ãƒƒãƒ—ã§æ§‹ç¯‰ã€‚åˆå¿ƒè€…ã§ã‚‚æ•°è¡Œã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã‚‹å®Ÿè·µãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€‚"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://www.nqou.net/public_images/2025/1765704785-image.jpg'><link rel="shortcut icon" href=/favicon.png><style>@import 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap';:root{--base-font-family:Arial, "Noto Sans JP", sans-serif}</style><link rel=stylesheet href=/css/linkcard.css><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3923446804785015" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js defer></script><script defer>document.addEventListener("DOMContentLoaded",function(){try{typeof mermaid!="undefined"&&document.querySelector(".mermaid")&&mermaid.initialize({startOnLoad:!0,securityLevel:"strict"})}catch(e){console.warn("Mermaid failed to initialize:",e)}})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-E50H9ESN7E"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E50H9ESN7E")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ããƒ»é–‰ã˜ã‚‹>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/public_images/nqounet201703.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¥ƒ</span></figure><div class=site-meta><h1 class=site-name><a href=/>è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç–‘ãˆ</a></h1><h2 class=site-description>åå‰ã®å˜˜ã‚’æš´ãã€æ„å›³ã§è¨­è¨ˆã‚’èªã‚‹</h2></div></header><ol class=menu-social><li><a href=https://github.com/nqounet target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/nqounet target=_blank title=X rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/advent-calendar-2025/><svg class="icon icon-tabler icon-tabler-calendar" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="5" width="16" height="16" rx="2"/><line x1="16" y1="3" x2="16" y2="7"/><line x1="8" y1="3" x2="8" y2="7"/><line x1="4" y1="11" x2="20" y2="11"/><path d="M8 15h.01"/><path d="M12 15h.01"/><path d="M16 15h.01"/><path d="M8 19h.01"/><path d="M12 19h.01"/><path d="M16 19h.01"/></svg>
<span>Perl Advent Calendar 2025 - AI Edition</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/warehouse/><svg class="icon icon-tabler icon-tabler-warehouse" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10l9-6 9 6"/><rect x="5" y="10" width="14" height="10" rx="2"/><rect x="10" y="14" width="4" height="6" rx="1"/><path d="M7 20v-4h2v4"/><path d="M15 20v-4h2v4"/></svg>
<span>Warehouse</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®æ¬¡</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#websocketã¨ã¯ãªãœå¿…è¦ãªã®ã‹>WebSocketã¨ã¯ï¼Ÿãªãœå¿…è¦ãªã®ã‹</a></li><li><a href=#ãªãœmojoliciousãªã®ã‹>ãªãœMojoliciousãªã®ã‹</a></li><li><a href=#æº–å‚™mojoliciousã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«>æº–å‚™ï¼šMojoliciousã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</a></li><li><a href=#ã‚¹ãƒ†ãƒƒãƒ—1ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹>ã‚¹ãƒ†ãƒƒãƒ—1ï¼šã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹</a><ol><li><a href=#æ—¥æœ¬èªå¯¾å¿œã¨ãƒ­ã‚®ãƒ³ã‚°æ©Ÿèƒ½ã®è¿½åŠ >æ—¥æœ¬èªå¯¾å¿œã¨ãƒ­ã‚®ãƒ³ã‚°æ©Ÿèƒ½ã®è¿½åŠ </a></li></ol></li><li><a href=#ã‚¹ãƒ†ãƒƒãƒ—2è¤‡æ•°äººãƒãƒ£ãƒƒãƒˆã‚’ä½œã‚‹>ã‚¹ãƒ†ãƒƒãƒ—2ï¼šè¤‡æ•°äººãƒãƒ£ãƒƒãƒˆã‚’ä½œã‚‹</a><ol><li><a href=#jsonå½¢å¼ã§ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿é€ä¿¡>JSONå½¢å¼ã§ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿é€ä¿¡</a></li></ol></li><li><a href=#ã‚¹ãƒ†ãƒƒãƒ—3ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œã‚‹>ã‚¹ãƒ†ãƒƒãƒ—3ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œã‚‹</a><ol><li><a href=#websocketã¨httpãƒãƒ¼ãƒªãƒ³ã‚°ã®æ¯”è¼ƒ>WebSocketã¨HTTPãƒãƒ¼ãƒªãƒ³ã‚°ã®æ¯”è¼ƒ</a></li></ol></li><li><a href=#websocketã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹>WebSocketã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</a><ol><li><a href=#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</a></li><li><a href=#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</a></li><li><a href=#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨å†æ¥ç¶š>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨å†æ¥ç¶š</a></li></ol></li><li><a href=#ã¾ã¨ã‚>ã¾ã¨ã‚</a></li><li><a href=#æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</a></li><li><a href=#å‚è€ƒãƒªãƒ³ã‚¯>å‚è€ƒãƒªãƒ³ã‚¯</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/2025/12/14/183305/><img src=/public_images/2025/1765704785-image.jpg loading=lazy alt="Featured image of post Perl WebSocketå…¥é–€ï¼šMojoliciousã§ä½œã‚‹3ã¤ã®å®Ÿè·µã‚¢ãƒ—ãƒª"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2025/12/14/183305/>Perl WebSocketå…¥é–€ï¼šMojoliciousã§ä½œã‚‹3ã¤ã®å®Ÿè·µã‚¢ãƒ—ãƒª</a></h2><h3 class=article-subtitle>Perlã®Mojoliciousã§WebSocketã‚’å®Ÿè£…ã™ã‚‹å®Œå…¨ã‚¬ã‚¤ãƒ‰ã€‚ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’3ã‚¹ãƒ†ãƒƒãƒ—ã§æ§‹ç¯‰ã€‚åˆå¿ƒè€…ã§ã‚‚æ•°è¡Œã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã‚‹å®Ÿè·µãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€‚</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>12æœˆ 14, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>èª­äº†æ™‚é–“: 19åˆ†</time></div></footer></div></header><section class=article-content><p><a class=link href=https://x.com/nqounet target=_blank rel=noopener>@nqounet</a>ã§ã™ã€‚</p><p><strong>WebSocket</strong>ã£ã¦èã„ãŸã“ã¨ã¯ã‚ã‚‹ã‘ã©ã€å®Ÿéš›ã«è§¦ã£ãŸã“ã¨ãŒãªã„æ–¹ã‚‚å¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿã“ã®è¨˜äº‹ã§ã¯ã€<strong>Perl</strong>ã®Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€Œ<strong>Mojolicious</strong>ã€ã‚’ä½¿ã£ã¦ã€<strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡</strong>ã®åŸºç¤ã‚’<strong>3ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—</strong>ã§å­¦ã‚“ã§ã„ãã¾ã™ã€‚</p><p>åˆå¿ƒè€…ã®æ–¹ã§ã‚‚ã€ã‚ãšã‹<strong>10è¡Œã®ã‚³ãƒ¼ãƒ‰</strong>ã‹ã‚‰WebSocketã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚ã“ã®è¨˜äº‹ã‚’èª­ã¿çµ‚ãˆã‚‹é ƒã«ã¯ã€ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚„ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒä½œã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚</p><h2 id=websocketã¨ã¯ãªãœå¿…è¦ãªã®ã‹>WebSocketã¨ã¯ï¼Ÿãªãœå¿…è¦ãªã®ã‹</h2><p>WebSocketã¯ã€Webãƒ–ãƒ©ã‚¦ã‚¶ã¨Webã‚µãƒ¼ãƒãƒ¼ã®é–“ã§<strong>åŒæ–¹å‘é€šä¿¡</strong>ã‚’å®Ÿç¾ã™ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚å¾“æ¥ã®HTTPã§ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‰ãªã„é™ã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p><p>ã—ã‹ã—ã€WebSocketã‚’ä½¿ãˆã°ï¼š</p><ul><li>ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã§ãã‚‹</li><li>1ã¤ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã§ç¶™ç¶šçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚„ã‚Šå–ã‚Šã§ãã‚‹</li><li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè£…ã—ã‚„ã™ã„</li></ul><p>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã€æ ªä¾¡ãƒœãƒ¼ãƒ‰ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ ã€IoTãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãªã©ã€WebSocketã®æ´»èºã®å ´ã¯åºƒãŒã£ã¦ã„ã¾ã™ã€‚</p><h2 id=ãªãœmojoliciousãªã®ã‹>ãªãœMojoliciousãªã®ã‹</h2><p><strong>Mojolicious</strong>ã¯ã€<strong>WebSocket</strong>ã‚’ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã«æ‰±ãˆã‚‹<strong>Perl</strong>ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ä»–ã®è¨€èªã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨æ¯”è¼ƒã—ã¦ã‚‚ã€å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ãã€ã™ãã«å®Ÿè·µã§ãã‚‹ã®ãŒç‰¹å¾´ã§ã™ã€‚</p><p><strong>Mojoliciousã‚’é¸ã¶ç†ç”±ï¼š</strong></p><ul><li><strong>è¨­å®šä¸è¦</strong>: è¿½åŠ ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚„ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãªã—ã§WebSocketãŒä½¿ãˆã‚‹</li><li><strong>ã‚·ãƒ³ãƒ—ãƒ«ãªAPI</strong>: ã‚ãšã‹æ•°è¡Œã§WebSocketã‚µãƒ¼ãƒãƒ¼ãŒæ›¸ã‘ã‚‹</li><li><strong>UTF-8è‡ªå‹•å¯¾å¿œ</strong>: æ—¥æœ¬èªãªã©ã®å¤šè¨€èªãƒ†ã‚­ã‚¹ãƒˆã‚‚è‡ªå‹•çš„ã«æ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹</li><li><strong>éåŒæœŸI/O</strong>: Mojo::IOLoopã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªä¸¦è¡Œå‡¦ç†</li><li><strong>è±Šå¯Œãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</strong>: å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿã—ã¦ãŠã‚Šã€åˆå¿ƒè€…ã«ã‚‚å„ªã—ã„</li></ul><p>ãã‚Œã§ã¯ã€å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ããªãŒã‚‰å­¦ã‚“ã§ã„ãã¾ã—ã‚‡ã†ï¼</p><h2 id=æº–å‚™mojoliciousã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«>æº–å‚™ï¼šMojoliciousã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h2><p>ã¾ã Mojoliciousã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãªã„å ´åˆã¯ã€cpanmã‚’ä½¿ã£ã¦ç°¡å˜ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cpanm Mojolicious
</span></span></code></pre></td></tr></table></div></div><p>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mojo version
</span></span></code></pre></td></tr></table></div></div><p>ã“ã‚Œã§æº–å‚™å®Œäº†ã§ã™ï¼</p><h2 id=ã‚¹ãƒ†ãƒƒãƒ—1ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹>ã‚¹ãƒ†ãƒƒãƒ—1ï¼šã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹</h2><p>ã¾ãšã¯ã€WebSocketã®åŸºæœ¬ã§ã‚ã‚‹ã€Œã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã€ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ã‚‰ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãã®ã¾ã¾è¿”ã™ã‚·ãƒ³ãƒ—ãƒ«ãªã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚</p><p>æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªWebSocketã‚µãƒ¼ãƒãƒ¼ã¯ã€ã‚ãšã‹10è¡Œç¨‹åº¦ã§æ›¸ã‘ã¾ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=ch>#!/usr/bin/env perl</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Mojolicious::Lite</span> <span class=o>-</span><span class=n>signatures</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># WebSocketãƒ«ãƒ¼ãƒˆã‚’å®šç¾©</span>
</span></span><span class=line><span class=cl><span class=n>websocket</span> <span class=s>&#39;/echo&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c) {</span>
</span></span><span class=line><span class=cl>  <span class=c1># ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ãã®å‡¦ç†</span>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>on</span><span class=p>(</span><span class=n>message</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c, $msg) {</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nb>send</span><span class=p>(</span><span class=s>&#34;Echo: $msg&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nn>app</span><span class=o>-&gt;</span><span class=n>start</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ <code>echo_server.pl</code> ã¨ã—ã¦ä¿å­˜ã—ã€å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>perl echo_server.pl daemon
</span></span></code></pre></td></tr></table></div></div><p>ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãŸã‚‰ã€æ¬¡ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãƒ†ã‚¹ãƒˆã§ãã¾ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;ja&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>WebSocket Echo Test<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>WebSocket Echo Test<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;input&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;sendMessage()&#34;</span><span class=p>&gt;</span>é€ä¿¡<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;output&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ws</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebSocket</span><span class=p>(</span><span class=s1>&#39;ws://localhost:3000/echo&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>ws</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>output</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;output&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>output</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>+=</span> <span class=s1>&#39;&lt;p&gt;å—ä¿¡: &#39;</span> <span class=o>+</span> <span class=nx>event</span><span class=p>.</span><span class=nx>data</span> <span class=o>+</span> <span class=s1>&#39;&lt;/p&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nx>sendMessage</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>input</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;input&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>ws</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>input</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>input</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã€ŒEcho: ã€ä»˜ãã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã£ã¦ãã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚</p><h3 id=æ—¥æœ¬èªå¯¾å¿œã¨ãƒ­ã‚®ãƒ³ã‚°æ©Ÿèƒ½ã®è¿½åŠ >æ—¥æœ¬èªå¯¾å¿œã¨ãƒ­ã‚®ãƒ³ã‚°æ©Ÿèƒ½ã®è¿½åŠ </h3><p>WebSocketã§æ—¥æœ¬èªã‚’æ‰±ã†å ´åˆã€æ–‡å­—ã‚³ãƒ¼ãƒ‰ã®æ‰±ã„ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚Mojoliciousã¯<strong>è‡ªå‹•çš„ã«UTF-8ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’è¡Œã†</strong>ãŸã‚ã€ç‰¹åˆ¥ãªè¨­å®šã¯ä¸è¦ã§ã™ãŒã€Perlã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§æ—¥æœ¬èªã‚’ä½¿ã†å ´åˆã¯ <code>use utf8;</code> ã‚’å¿˜ã‚Œãšã«ã€‚</p><p>ã¾ãŸã€å®Ÿç”¨çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€æ¥ç¶šãƒ»åˆ‡æ–­ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ­ã‚°ã‚’å–ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ä»¥ä¸‹ã¯ã€ãƒ­ã‚®ãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸæ”¹è‰¯ç‰ˆã§ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=ch>#!/usr/bin/env perl</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>utf8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Mojolicious::Lite</span> <span class=o>-</span><span class=n>signatures</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># WebSocketãƒ«ãƒ¼ãƒˆã‚’å®šç¾©</span>
</span></span><span class=line><span class=cl><span class=n>websocket</span> <span class=s>&#39;/echo&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c) {</span>
</span></span><span class=line><span class=cl>  <span class=c1># æ¥ç¶šæ™‚ã®ãƒ­ã‚°</span>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=nn>app</span><span class=o>-&gt;</span><span class=nb>log</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#39;WebSocketæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸ&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†</span>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>on</span><span class=p>(</span><span class=n>message</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c, $msg) {</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nn>app</span><span class=o>-&gt;</span><span class=nb>log</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;å—ä¿¡: $msg&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nb>send</span><span class=p>(</span><span class=s>&#34;ã‚¨ã‚³ãƒ¼: $msg&#34;</span><span class=p>);</span>  <span class=c1># æ—¥æœ¬èªã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># åˆ‡æ–­æ™‚ã®å‡¦ç†</span>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>on</span><span class=p>(</span><span class=n>finish</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c, $code, $reason) {</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nn>app</span><span class=o>-&gt;</span><span class=nb>log</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;WebSocketåˆ‡æ–­: code=$code&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nn>app</span><span class=o>-&gt;</span><span class=n>start</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>ãƒã‚¤ãƒ³ãƒˆè§£èª¬ï¼š</strong></p><ul><li><code>use utf8;</code>: Perlã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®æ—¥æœ¬èªæ–‡å­—åˆ—ã‚’æ­£ã—ãæ‰±ã†ãŸã‚ã«å¿…é ˆ</li><li><code>$c->on(message => ...)</code>: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯</li><li><code>$c->send(...)</code>: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆMojoliciousãŒè‡ªå‹•çš„ã«UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰</li><li><code>$c->on(finish => ...)</code>: WebSocketåˆ‡æ–­æ™‚ã®å‡¦ç†</li><li><code>$c->app->log->info(...)</code>: ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã¸ã®è¨˜éŒ²</li></ul><p>Mojoliciousã®ç´ æ™´ã‚‰ã—ã„ç‚¹ã¯ã€<strong>é€å—ä¿¡ã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè‡ªå‹•çš„ã«UTF-8ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹</strong>ã“ã¨ã§ã™ã€‚é–‹ç™ºè€…ãŒæ˜ç¤ºçš„ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p><h2 id=ã‚¹ãƒ†ãƒƒãƒ—2è¤‡æ•°äººãƒãƒ£ãƒƒãƒˆã‚’ä½œã‚‹>ã‚¹ãƒ†ãƒƒãƒ—2ï¼šè¤‡æ•°äººãƒãƒ£ãƒƒãƒˆã‚’ä½œã‚‹</h2><p>ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã§WebSocketã®åŸºæœ¬ã‚’ç†è§£ã§ããŸã‚‰ã€æ¬¡ã¯è¤‡æ•°ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåŒæ™‚ã«æ¥ç¶šã™ã‚‹<strong>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</strong>ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p><p>ã¾ãšã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒƒãƒˆã‚’å®Ÿè£…ã—ã¾ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=ch>#!/usr/bin/env perl</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>utf8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Mojolicious::Lite</span> <span class=o>-</span><span class=n>signatures</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ¥ç¶šä¸­ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä¿æŒã™ã‚‹ãƒãƒƒã‚·ãƒ¥</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$clients</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ï¼ˆHTMLãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>get</span> <span class=s>&#39;/&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c) {</span>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>render</span><span class=p>(</span><span class=n>template</span> <span class=o>=&gt;</span> <span class=s>&#39;chat&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># WebSocketã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</span>
</span></span><span class=line><span class=cl><span class=n>websocket</span> <span class=s>&#39;/chat&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c) {</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$id</span> <span class=o>=</span> <span class=nb>sprintf</span> <span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>tx</span><span class=p>;</span>  <span class=c1># æ¥ç¶šã”ã¨ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ID</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># æ–°ã—ã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç™»éŒ²</span>
</span></span><span class=line><span class=cl>  <span class=nv>$clients</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>}</span> <span class=o>=</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>tx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=nn>app</span><span class=o>-&gt;</span><span class=nb>log</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶š: $id (total: &#34;</span> <span class=o>.</span> <span class=nb>scalar</span><span class=p>(</span><span class=nb>keys</span> <span class=nv>%$clients</span><span class=p>)</span> <span class=o>.</span> <span class=s>&#34;)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># å…¨å“¡ã«å‚åŠ é€šçŸ¥ã‚’é€ä¿¡</span>
</span></span><span class=line><span class=cl>  <span class=n>broadcast</span><span class=p>(</span><span class=s>&#34;æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚åŠ ã—ã¾ã—ãŸ (total: &#34;</span> <span class=o>.</span> <span class=nb>scalar</span><span class=p>(</span><span class=nb>keys</span> <span class=nv>%$clients</span><span class=p>)</span> <span class=o>.</span> <span class=s>&#34;)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†</span>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>on</span><span class=p>(</span><span class=n>message</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c, $msg) {</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nn>app</span><span class=o>-&gt;</span><span class=nb>log</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;[$id] $msg&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>broadcast</span><span class=p>(</span><span class=s>&#34;[$id] $msg&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># åˆ‡æ–­æ™‚ã®å‡¦ç†</span>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>on</span><span class=p>(</span><span class=n>finish</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c, $code, $reason) {</span>
</span></span><span class=line><span class=cl>    <span class=nb>delete</span> <span class=nv>$clients</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nn>app</span><span class=o>-&gt;</span><span class=nb>log</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ‡æ–­: $id (total: &#34;</span> <span class=o>.</span> <span class=nb>scalar</span><span class=p>(</span><span class=nb>keys</span> <span class=nv>%$clients</span><span class=p>)</span> <span class=o>.</span> <span class=s>&#34;)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>broadcast</span><span class=p>(</span><span class=s>&#34;ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€€å‡ºã—ã¾ã—ãŸ (total: &#34;</span> <span class=o>.</span> <span class=nb>scalar</span><span class=p>(</span><span class=nb>keys</span> <span class=nv>%$clients</span><span class=p>)</span> <span class=o>.</span> <span class=s>&#34;)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>broadcast</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$msg</span> <span class=o>=</span> <span class=nb>shift</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=k>my</span> <span class=nv>$tx</span> <span class=p>(</span><span class=nb>values</span> <span class=nv>%$clients</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$tx</span><span class=o>-&gt;</span><span class=nb>send</span><span class=p>(</span><span class=nv>$msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nn>app</span><span class=o>-&gt;</span><span class=n>start</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=bp>__DATA__</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>@@</span> <span class=nv>chat</span><span class=o>.</span><span class=n>html</span><span class=o>.</span><span class=n>ep</span>
</span></span><span class=line><span class=cl><span class=o>&lt;!</span><span class=n>DOCTYPE</span> <span class=n>html</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>html</span> <span class=n>lang</span><span class=o>=</span><span class=s>&#34;ja&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;head&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>meta</span> <span class=n>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;title&gt;</span><span class=n>WebSocket</span> <span class=n>ãƒãƒ£ãƒƒãƒˆ</span><span class=sr>&lt;/title&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;style&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c1>#messages { </span>
</span></span><span class=line><span class=cl>      <span class=n>height:</span> <span class=mi>400</span><span class=n>px</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>      <span class=n>overflow</span><span class=o>-</span><span class=n>y:</span> <span class=n>scroll</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>      <span class=n>border:</span> <span class=mi>1</span><span class=n>px</span> <span class=n>solid</span> <span class=c1>#ccc; </span>
</span></span><span class=line><span class=cl>      <span class=n>padding:</span> <span class=mi>10</span><span class=n>px</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>      <span class=n>margin</span><span class=o>-</span><span class=n>bottom:</span> <span class=mi>10</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>#input { width: 80%; padding: 5px; }</span>
</span></span><span class=line><span class=cl>    <span class=n>button</span> <span class=p>{</span> <span class=n>padding:</span> <span class=mi>5</span><span class=n>px</span> <span class=mi>15</span><span class=n>px</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;/style&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;/head&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;body&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;h1&gt;</span><span class=n>WebSocket</span> <span class=n>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </span><span class=sr>&lt;/h1&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>div</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;messages&#34;</span><span class=o>&gt;</span><span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>input</span> <span class=n>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;input&#34;</span> <span class=n>placeholder</span><span class=o>=</span><span class=s>&#34;ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>button</span> <span class=n>onclick</span><span class=o>=</span><span class=s>&#34;sendMessage()&#34;</span><span class=o>&gt;</span><span class=n>é€ä¿¡</span><span class=sr>&lt;/button&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;script&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>const</span> <span class=n>ws</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WebSocket</span><span class=p>(</span><span class=s>&#39;ws://&#39;</span> <span class=o>+</span> <span class=n>location</span><span class=o>.</span><span class=n>host</span> <span class=o>+</span> <span class=s>&#39;/chat&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>const</span> <span class=n>messages</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;messages&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>const</span> <span class=n>input</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;input&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ws</span><span class=o>.</span><span class=n>onopen</span> <span class=o>=</span> <span class=n>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>addMessage</span><span class=p>(</span><span class=s>&#39;--- æ¥ç¶šã—ã¾ã—ãŸ ---&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ws</span><span class=o>.</span><span class=n>onmessage</span> <span class=o>=</span> <span class=n>function</span><span class=p>(</span><span class=n>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>addMessage</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ws</span><span class=o>.</span><span class=n>onclose</span> <span class=o>=</span> <span class=n>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>addMessage</span><span class=p>(</span><span class=s>&#39;--- åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ ---&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>addMessage</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>messages</span><span class=o>.</span><span class=n>innerHTML</span> <span class=o>+=</span> <span class=s>&#39;&lt;p&gt;&#39;</span> <span class=o>+</span> <span class=n>escapeHtml</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#39;&lt;/p&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>messages</span><span class=o>.</span><span class=n>scrollTop</span> <span class=o>=</span> <span class=n>messages</span><span class=o>.</span><span class=n>scrollHeight</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>sendMessage</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>input</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>trim</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ws</span><span class=o>.</span><span class=nb>send</span><span class=p>(</span><span class=n>input</span><span class=o>.</span><span class=n>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>input</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>escapeHtml</span><span class=p>(</span><span class=n>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>div</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>createElement</span><span class=p>(</span><span class=s>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>div</span><span class=o>.</span><span class=n>textContent</span> <span class=o>=</span> <span class=n>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>div</span><span class=o>.</span><span class=n>innerHTML</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>input</span><span class=o>.</span><span class=n>addEventListener</span><span class=p>(</span><span class=s>&#39;keypress&#39;</span><span class=p>,</span> <span class=n>function</span><span class=p>(</span><span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>key</span> <span class=o>===</span> <span class=s>&#39;Enter&#39;</span><span class=p>)</span> <span class=n>sendMessage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;/script&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;/html&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>ãƒã‚¤ãƒ³ãƒˆè§£èª¬ï¼š</strong></p><ul><li><code>my $clients = {}</code>: æ¥ç¶šä¸­ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ãƒãƒƒã‚·ãƒ¥ã§ç®¡ç†</li><li><code>$c->tx</code>: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆæ¥ç¶šã”ã¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰</li><li><code>broadcast()</code>: å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹é–¢æ•°</li><li><code>__DATA__</code> ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åŸ‹ã‚è¾¼ã¿ï¼ˆåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ãªãã¦OKï¼‰</li><li><code>escapeHtml()</code>: XSSå¯¾ç­–ã®ãŸã‚ã®HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—</li></ul><p>ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ <code>chat_server.pl</code> ã¨ã—ã¦ä¿å­˜ã—ã€å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>perl chat_server.pl daemon
</span></span></code></pre></td></tr></table></div></div><p>ãƒ–ãƒ©ã‚¦ã‚¶ã§ <code>http://localhost:3000/</code> ã‚’é–‹ãã¨ã€ãƒãƒ£ãƒƒãƒˆç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚è¤‡æ•°ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆã¾ãŸã¯ã‚¿ãƒ–ï¼‰ã§é–‹ã„ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚„ã‚Šå–ã‚Šã—ã¦ã¿ã¦ãã ã•ã„ï¼</p><h3 id=jsonå½¢å¼ã§ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿é€ä¿¡>JSONå½¢å¼ã§ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿é€ä¿¡</h3><p>å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã§ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãªã©ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚‚ä¸€ç·’ã«é€ã‚ŠãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚JSONå½¢å¼ã‚’ä½¿ã†ã¨ã€æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ç°¡å˜ã«ã‚„ã‚Šå–ã‚Šã§ãã€å°†æ¥çš„ãªæ‹¡å¼µï¼ˆçµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€æ—¢èª­è¡¨ç¤ºã€ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ãªã©ï¼‰ã‚‚å®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚</p><p>ä»¥ä¸‹ã¯ã€JSONå½¢å¼ã§é€šä¿¡ã™ã‚‹ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ä¾‹ã§ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=ch>#!/usr/bin/env perl</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>utf8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Mojolicious::Lite</span> <span class=o>-</span><span class=n>signatures</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Mojo::JSON</span> <span class=sx>qw(decode_json encode_json)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Mojo::Util</span> <span class=sx>qw(decode encode)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$clients</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>get</span> <span class=s>&#39;/&#39;</span> <span class=o>=&gt;</span> <span class=n>sub</span><span class=p>(</span><span class=nv>$c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>render</span><span class=p>(</span><span class=n>template</span> <span class=o>=&gt;</span> <span class=s>&#39;chat_json&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>websocket</span> <span class=s>&#39;/chat&#39;</span> <span class=o>=&gt;</span> <span class=n>sub</span><span class=p>(</span><span class=nv>$c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$id</span> <span class=o>=</span> <span class=nb>sprintf</span> <span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>tx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$username</span> <span class=o>=</span> <span class=s>&#34;User-&#34;</span> <span class=o>.</span> <span class=nb>substr</span><span class=p>(</span><span class=nv>$id</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span> <span class=c1># ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$clients</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>}</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>tx</span>       <span class=o>=&gt;</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>tx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=&gt;</span> <span class=nv>$username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># å‚åŠ é€šçŸ¥ã‚’JSONå½¢å¼ã§é€ä¿¡</span>
</span></span><span class=line><span class=cl>  <span class=n>broadcast</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span>      <span class=o>=&gt;</span> <span class=s>&#39;system&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span>   <span class=o>=&gt;</span> <span class=s>&#34;$username ãŒå‚åŠ ã—ã¾ã—ãŸ&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span> <span class=o>=&gt;</span> <span class=nb>time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>users</span>     <span class=o>=&gt;</span> <span class=nb>scalar</span><span class=p>(</span><span class=nb>keys</span> <span class=nv>%$clients</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>on</span><span class=p>(</span><span class=n>message</span> <span class=o>=&gt;</span> <span class=n>sub</span><span class=p>(</span><span class=nv>$c</span><span class=p>,</span> <span class=nv>$msg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$data</span> <span class=o>=</span> <span class=nb>eval</span> <span class=p>{</span><span class=n>decode_json</span><span class=p>(</span><span class=n>encode</span><span class=p>(</span><span class=s>&#39;UTF-8&#39;</span><span class=p>,</span> <span class=nv>$msg</span><span class=p>))};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=vg>$@</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1># JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼</span>
</span></span><span class=line><span class=cl>      <span class=nv>$c</span><span class=o>-&gt;</span><span class=nb>send</span><span class=p>(</span><span class=n>encode_json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=n>type</span>    <span class=o>=&gt;</span> <span class=s>&#39;error&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span> <span class=o>=&gt;</span> <span class=s>&#39;Invalid JSON format&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>}));</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$data</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>type</span><span class=p>}</span> <span class=ow>eq</span> <span class=s>&#39;setname&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>my</span> <span class=nv>$old_name</span> <span class=o>=</span> <span class=nv>$clients</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>}{</span><span class=n>username</span><span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nv>$clients</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>}{</span><span class=n>username</span><span class=p>}</span> <span class=o>=</span> <span class=nv>$data</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>username</span><span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=n>broadcast</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=n>type</span>      <span class=o>=&gt;</span> <span class=s>&#39;system&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span>   <span class=o>=&gt;</span> <span class=s>&#34;$old_name ãŒ $data-&gt;{username} ã«åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>timestamp</span> <span class=o>=&gt;</span> <span class=nb>time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>users</span>     <span class=o>=&gt;</span> <span class=nb>scalar</span><span class=p>(</span><span class=nb>keys</span> <span class=nv>%$clients</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
</span></span><span class=line><span class=cl>    <span class=k>elsif</span> <span class=p>(</span><span class=nv>$data</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>type</span><span class=p>}</span> <span class=ow>eq</span> <span class=s>&#39;message&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>broadcast</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=n>type</span>      <span class=o>=&gt;</span> <span class=s>&#39;message&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span>  <span class=o>=&gt;</span> <span class=nv>$clients</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>}{</span><span class=n>username</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span>   <span class=o>=&gt;</span> <span class=nv>$data</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>message</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>timestamp</span> <span class=o>=&gt;</span> <span class=nb>time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>on</span><span class=p>(</span><span class=n>finish</span> <span class=o>=&gt;</span> <span class=n>sub</span><span class=p>(</span><span class=nv>$c</span><span class=p>,</span> <span class=nv>$code</span><span class=p>,</span> <span class=nv>$reason</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$username</span> <span class=o>=</span> <span class=nv>$clients</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>}{</span><span class=n>username</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nb>delete</span> <span class=nv>$clients</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>broadcast</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=n>type</span>      <span class=o>=&gt;</span> <span class=s>&#39;system&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>message</span>   <span class=o>=&gt;</span> <span class=s>&#34;$username ãŒé€€å‡ºã—ã¾ã—ãŸ&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>timestamp</span> <span class=o>=&gt;</span> <span class=nb>time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>users</span>     <span class=o>=&gt;</span> <span class=nb>scalar</span><span class=p>(</span><span class=nb>keys</span> <span class=nv>%$clients</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>broadcast</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$data</span> <span class=o>=</span> <span class=nb>shift</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$json</span> <span class=o>=</span> <span class=n>encode_json</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=k>my</span> <span class=nv>$client</span> <span class=p>(</span><span class=nb>values</span> <span class=nv>%$clients</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$client</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>tx</span><span class=p>}</span><span class=o>-&gt;</span><span class=nb>send</span><span class=p>(</span><span class=n>decode</span><span class=p>(</span><span class=s>&#39;UTF-8&#39;</span><span class=p>,</span> <span class=nv>$json</span><span class=p>));</span> <span class=c1># ä¸€æ—¦å†…éƒ¨ã‚³ãƒ¼ãƒ‰ã«æˆ»ã™</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nn>app</span><span class=o>-&gt;</span><span class=n>start</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=bp>__DATA__</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>@@</span> <span class=nv>chat_json</span><span class=o>.</span><span class=n>html</span><span class=o>.</span><span class=n>ep</span>
</span></span><span class=line><span class=cl><span class=o>&lt;!</span><span class=n>DOCTYPE</span> <span class=n>html</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>html</span> <span class=n>lang</span><span class=o>=</span><span class=s>&#34;ja&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;head&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>meta</span> <span class=n>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;title&gt;</span><span class=n>WebSocket</span> <span class=n>ãƒãƒ£ãƒƒãƒˆ</span> <span class=p>(</span><span class=n>JSONç‰ˆ</span><span class=p>)</span><span class=sr>&lt;/title&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;style&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=p>{</span> <span class=n>font</span><span class=o>-</span><span class=n>family:</span> <span class=n>Arial</span><span class=p>,</span> <span class=n>sans</span><span class=o>-</span><span class=n>serif</span><span class=p>;</span> <span class=n>max</span><span class=o>-</span><span class=n>width:</span> <span class=mi>800</span><span class=n>px</span><span class=p>;</span> <span class=n>margin:</span> <span class=mi>20</span><span class=n>px</span> <span class=n>auto</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>#messages { </span>
</span></span><span class=line><span class=cl>      <span class=n>height:</span> <span class=mi>400</span><span class=n>px</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>      <span class=n>overflow</span><span class=o>-</span><span class=n>y:</span> <span class=n>scroll</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>      <span class=n>border:</span> <span class=mi>1</span><span class=n>px</span> <span class=n>solid</span> <span class=c1>#ccc; </span>
</span></span><span class=line><span class=cl>      <span class=n>padding:</span> <span class=mi>10</span><span class=n>px</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>      <span class=n>margin</span><span class=o>-</span><span class=n>bottom:</span> <span class=mi>10</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>background:</span> <span class=c1>#f9f9f9;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>message</span> <span class=p>{</span> <span class=n>margin:</span> <span class=mi>5</span><span class=n>px</span> <span class=mi>0</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=nb>system</span> <span class=p>{</span> <span class=n>color:</span> <span class=c1>#666; font-style: italic; }</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>username</span> <span class=p>{</span> <span class=n>font</span><span class=o>-</span><span class=n>weight:</span> <span class=n>bold</span><span class=p>;</span> <span class=n>color:</span> <span class=c1>#0066cc; }</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>timestamp</span> <span class=p>{</span> <span class=n>font</span><span class=o>-</span><span class=n>size:</span> <span class=mf>0.8</span><span class=n>em</span><span class=p>;</span> <span class=n>color:</span> <span class=c1>#999; }</span>
</span></span><span class=line><span class=cl>    <span class=c1>#input { width: 70%; padding: 8px; }</span>
</span></span><span class=line><span class=cl>    <span class=n>button</span> <span class=p>{</span> <span class=n>padding:</span> <span class=mi>8</span><span class=n>px</span> <span class=mi>15</span><span class=n>px</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>#username-input { width: 150px; padding: 5px; }</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;/style&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;/head&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;body&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;h1&gt;</span><span class=n>WebSocket</span> <span class=n>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </span> <span class=p>(</span><span class=n>JSONç‰ˆ</span><span class=p>)</span><span class=sr>&lt;/h1&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;div&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</span> 
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>input</span> <span class=n>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;username-input&#34;</span> <span class=n>placeholder</span><span class=o>=</span><span class=s>&#34;åå‰ã‚’å…¥åŠ›&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>button</span> <span class=n>onclick</span><span class=o>=</span><span class=s>&#34;setUsername()&#34;</span><span class=o>&gt;</span><span class=n>å¤‰æ›´</span><span class=sr>&lt;/button&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>div</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;messages&#34;</span><span class=o>&gt;</span><span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>input</span> <span class=n>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;input&#34;</span> <span class=n>placeholder</span><span class=o>=</span><span class=s>&#34;ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>button</span> <span class=n>onclick</span><span class=o>=</span><span class=s>&#34;sendMessage()&#34;</span><span class=o>&gt;</span><span class=n>é€ä¿¡</span><span class=sr>&lt;/button&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;script&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>const</span> <span class=n>ws</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WebSocket</span><span class=p>(</span><span class=s>&#39;ws://&#39;</span> <span class=o>+</span> <span class=n>location</span><span class=o>.</span><span class=n>host</span> <span class=o>+</span> <span class=s>&#39;/chat&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>const</span> <span class=n>messages</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;messages&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>const</span> <span class=n>input</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;input&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ws</span><span class=o>.</span><span class=n>onopen</span> <span class=o>=</span> <span class=n>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>addSystemMessage</span><span class=p>(</span><span class=s>&#39;æ¥ç¶šã—ã¾ã—ãŸ&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ws</span><span class=o>.</span><span class=n>onmessage</span> <span class=o>=</span> <span class=n>function</span><span class=p>(</span><span class=n>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>data</span> <span class=o>=</span> <span class=n>JSON</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>type</span> <span class=o>===</span> <span class=s>&#39;system&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>addSystemMessage</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>message</span> <span class=o>+</span> <span class=s>&#39; (å‚åŠ è€…: &#39;</span> <span class=o>+</span> <span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>users</span> <span class=o>||</span> <span class=s>&#39;?&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#39;äºº)&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>type</span> <span class=o>===</span> <span class=s>&#39;message&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>addChatMessage</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>username</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>message</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>timestamp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>type</span> <span class=o>===</span> <span class=s>&#39;error&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>addSystemMessage</span><span class=p>(</span><span class=s>&#39;ã‚¨ãƒ©ãƒ¼: &#39;</span> <span class=o>+</span> <span class=n>data</span><span class=o>.</span><span class=n>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ws</span><span class=o>.</span><span class=n>onclose</span> <span class=o>=</span> <span class=n>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>addSystemMessage</span><span class=p>(</span><span class=s>&#39;åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>addChatMessage</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>msg</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=nb>time</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Date</span><span class=p>(</span><span class=n>timestamp</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>)</span><span class=o>.</span><span class=n>toLocaleTimeString</span><span class=p>(</span><span class=s>&#39;ja-JP&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>messages</span><span class=o>.</span><span class=n>innerHTML</span> <span class=o>+=</span> 
</span></span><span class=line><span class=cl>        <span class=s>&#39;&lt;div class=&#34;message&#34;&gt;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;&lt;span class=&#34;timestamp&#34;&gt;[&#39;</span> <span class=o>+</span> <span class=nb>time</span> <span class=o>+</span> <span class=s>&#39;]&lt;/span&gt; &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;&lt;span class=&#34;username&#34;&gt;&#39;</span> <span class=o>+</span> <span class=n>escapeHtml</span><span class=p>(</span><span class=n>username</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#39;:&lt;/span&gt; &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>escapeHtml</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;&lt;/div&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>messages</span><span class=o>.</span><span class=n>scrollTop</span> <span class=o>=</span> <span class=n>messages</span><span class=o>.</span><span class=n>scrollHeight</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>addSystemMessage</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>messages</span><span class=o>.</span><span class=n>innerHTML</span> <span class=o>+=</span> <span class=s>&#39;&lt;div class=&#34;message system&#34;&gt;--- &#39;</span> <span class=o>+</span> <span class=n>escapeHtml</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#39; ---&lt;/div&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>messages</span><span class=o>.</span><span class=n>scrollTop</span> <span class=o>=</span> <span class=n>messages</span><span class=o>.</span><span class=n>scrollHeight</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>sendMessage</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>input</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>trim</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ws</span><span class=o>.</span><span class=nb>send</span><span class=p>(</span><span class=n>JSON</span><span class=o>.</span><span class=n>stringify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=n>type:</span> <span class=s>&#39;message&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>message:</span> <span class=n>input</span><span class=o>.</span><span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=p>}));</span>
</span></span><span class=line><span class=cl>        <span class=n>input</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>setUsername</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>username</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;username-input&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>trim</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>username</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ws</span><span class=o>.</span><span class=nb>send</span><span class=p>(</span><span class=n>JSON</span><span class=o>.</span><span class=n>stringify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=n>type:</span> <span class=s>&#39;setname&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>username:</span> <span class=n>username</span>
</span></span><span class=line><span class=cl>        <span class=p>}));</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>escapeHtml</span><span class=p>(</span><span class=n>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>div</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>createElement</span><span class=p>(</span><span class=s>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>div</span><span class=o>.</span><span class=n>textContent</span> <span class=o>=</span> <span class=n>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>div</span><span class=o>.</span><span class=n>innerHTML</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>input</span><span class=o>.</span><span class=n>addEventListener</span><span class=p>(</span><span class=s>&#39;keypress&#39;</span><span class=p>,</span> <span class=n>function</span><span class=p>(</span><span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>key</span> <span class=o>===</span> <span class=s>&#39;Enter&#39;</span><span class=p>)</span> <span class=n>sendMessage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;/script&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;/html&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>ãƒã‚¤ãƒ³ãƒˆè§£èª¬ï¼š</strong></p><ul><li><code>use Mojo::JSON qw(decode_json encode_json)</code>: JSONå‡¦ç†ã®ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£</li><li><code>decode_json()</code>: JSONæ–‡å­—åˆ—ã‚’Perlã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¤‰æ›</li><li><code>encode_json()</code>: Perlã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›</li><li>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã« <code>type</code> ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒãŸã›ã¦ã€ç¨®é¡ã‚’åŒºåˆ¥ï¼ˆsystem/message/setname/errorï¼‰</li><li>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡æ™‚åˆ»ã‚’è¨˜éŒ²</li><li>ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã€ã‚ˆã‚Šãƒªã‚¢ãƒ«ãªãƒãƒ£ãƒƒãƒˆä½“é¨“ã‚’å®Ÿç¾</li><li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼šä¸æ­£ãªJSONå½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é©åˆ‡ã«å‡¦ç†</li><li>encode_jsonã‚„sendãŒè‡ªå‹•çš„ã«UTF-8ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã€encode_jsonã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’sendã™ã‚‹å ´åˆã€ä¸€æ—¦<code>decode('UTF-8', $json)</code>ã§å†…éƒ¨ã‚³ãƒ¼ãƒ‰ã«æˆ»ã™å¿…è¦ãŒã‚ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦</li></ul><h2 id=ã‚¹ãƒ†ãƒƒãƒ—3ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œã‚‹>ã‚¹ãƒ†ãƒƒãƒ—3ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œã‚‹</h2><p>æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆCPUä½¿ç”¨ç‡ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãªã©ï¼‰ã‚’<strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¯è¦–åŒ–ã™ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</strong>ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚WebSocketã®çœŸéª¨é ‚ã§ã‚ã‚‹ã€Œã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒƒã‚·ãƒ¥ã€ã‚’æ´»ç”¨ã—ã¾ã™ã€‚</p><p>ä»¥ä¸‹ã®å®Ÿè£…ã§ã¯ã€<code>Mojo::IOLoop->recurring</code>ã‚’ä½¿ã£ã¦1ç§’ã”ã¨ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã—ã€æ¥ç¶šä¸­ã®å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥é…ä¿¡ã—ã¾ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=ch>#!/usr/bin/env perl</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>utf8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Mojolicious::Lite</span> <span class=o>-</span><span class=n>signatures</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Mojo::JSON</span> <span class=sx>qw(encode_json)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$clients</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>get</span> <span class=s>&#39;/&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c) {</span>
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>render</span><span class=p>(</span><span class=n>template</span> <span class=o>=&gt;</span> <span class=s>&#39;dashboard&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>websocket</span> <span class=s>&#39;/metrics&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c) {</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$id</span> <span class=o>=</span> <span class=nb>sprintf</span> <span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>tx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nv>$clients</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>}</span> <span class=o>=</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>tx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=nn>app</span><span class=o>-&gt;</span><span class=nb>log</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ¥ç¶š: $id&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>on</span><span class=p>(</span><span class=n>finish</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c, $code, $reason) {</span>
</span></span><span class=line><span class=cl>    <span class=nb>delete</span> <span class=nv>$clients</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$id</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nn>app</span><span class=o>-&gt;</span><span class=nb>log</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆ‡æ–­: $id&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å®šæœŸçš„ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã—ã¦é€ä¿¡ï¼ˆ1ç§’ã”ã¨ï¼‰</span>
</span></span><span class=line><span class=cl><span class=nn>Mojo::IOLoop</span><span class=o>-&gt;</span><span class=n>recurring</span><span class=p>(</span><span class=mi>1</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>unless</span> <span class=nb>keys</span> <span class=nv>%$clients</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$metrics</span> <span class=o>=</span> <span class=n>collect_metrics</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$json</span> <span class=o>=</span> <span class=n>encode_json</span><span class=p>(</span><span class=nv>$metrics</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=k>my</span> <span class=nv>$tx</span> <span class=p>(</span><span class=nb>values</span> <span class=nv>%$clients</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$tx</span><span class=o>-&gt;</span><span class=nb>send</span><span class=p>(</span><span class=nv>$json</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã™ã‚‹é–¢æ•°</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>collect_metrics</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1># Load Averageå–å¾—ï¼ˆLinux/macOS/Unixç³»ã§å‹•ä½œï¼‰</span>
</span></span><span class=line><span class=cl>  <span class=c1># Linux: &#34;load average: 0.00, 0.01, 0.05&#34;</span>
</span></span><span class=line><span class=cl>  <span class=c1># macOS: &#34;load averages: 0.00 0.01 0.05&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$uptime</span> <span class=o>=</span> <span class=sb>`uptime`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=p>(</span><span class=nv>$load1</span><span class=p>,</span> <span class=nv>$load5</span><span class=p>,</span> <span class=nv>$load15</span><span class=p>)</span> <span class=o>=</span> <span class=nv>$uptime</span> <span class=o>=~</span><span class=sr> /load averages?: ([\d.]+)[,\s]+([\d.]+)[,\s]+([\d.]+)/</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># ãƒ¡ãƒ¢ãƒªæƒ…å ±ï¼ˆLinuxç’°å¢ƒã®ã¿å¯¾å¿œï¼‰</span>
</span></span><span class=line><span class=cl>  <span class=c1># æ³¨: macOSã‚„Windowsã§ã¯ /proc/meminfo ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€0ã‚’è¿”ã—ã¾ã™</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$mem_total</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$mem_free</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$mem_available</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>-</span><span class=n>e</span> <span class=s>&#39;/proc/meminfo&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>open</span> <span class=k>my</span> <span class=nv>$fh</span><span class=p>,</span> <span class=s>&#39;&lt;&#39;</span><span class=p>,</span> <span class=s>&#39;/proc/meminfo&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=k>my</span> <span class=nv>$line</span> <span class=o>=</span> <span class=sr>&lt;$fh&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nv>$mem_total</span> <span class=o>=</span> <span class=nv>$1</span> <span class=k>if</span> <span class=nv>$line</span> <span class=o>=~</span><span class=sr> /^MemTotal:\s+(\d+)/</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nv>$mem_free</span> <span class=o>=</span> <span class=nv>$1</span> <span class=k>if</span> <span class=nv>$line</span> <span class=o>=~</span><span class=sr> /^MemFree:\s+(\d+)/</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nv>$mem_available</span> <span class=o>=</span> <span class=nv>$1</span> <span class=k>if</span> <span class=nv>$line</span> <span class=o>=~</span><span class=sr> /^MemAvailable:\s+(\d+)/</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nb>close</span> <span class=nv>$fh</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$mem_used</span> <span class=o>=</span> <span class=nv>$mem_total</span> <span class=o>-</span> <span class=nv>$mem_available</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$mem_percent</span> <span class=o>=</span> <span class=nv>$mem_total</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>?</span> <span class=p>(</span><span class=nv>$mem_used</span> <span class=o>/</span> <span class=nv>$mem_total</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># æ¥ç¶šæ•°ãªã©ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$connections</span> <span class=o>=</span> <span class=nb>scalar</span><span class=p>(</span><span class=nb>keys</span> <span class=nv>%$clients</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span> <span class=o>=&gt;</span> <span class=nb>time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>load</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>load1</span> <span class=o>=&gt;</span> <span class=nv>$load1</span> <span class=o>||</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>load5</span> <span class=o>=&gt;</span> <span class=nv>$load5</span> <span class=o>||</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>load15</span> <span class=o>=&gt;</span> <span class=nv>$load15</span> <span class=o>||</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>memory</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>total</span> <span class=o>=&gt;</span> <span class=nb>int</span><span class=p>(</span><span class=nv>$mem_total</span> <span class=o>/</span> <span class=mi>1024</span><span class=p>),</span>      <span class=c1># MBå˜ä½</span>
</span></span><span class=line><span class=cl>      <span class=n>used</span> <span class=o>=&gt;</span> <span class=nb>int</span><span class=p>(</span><span class=nv>$mem_used</span> <span class=o>/</span> <span class=mi>1024</span><span class=p>),</span>        <span class=c1># MBå˜ä½</span>
</span></span><span class=line><span class=cl>      <span class=n>percent</span> <span class=o>=&gt;</span> <span class=nb>sprintf</span><span class=p>(</span><span class=s>&#34;%.1f&#34;</span><span class=p>,</span> <span class=nv>$mem_percent</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>connections</span> <span class=o>=&gt;</span> <span class=nv>$connections</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>random</span> <span class=o>=&gt;</span> <span class=nb>int</span><span class=p>(</span><span class=nb>rand</span><span class=p>(</span><span class=mi>100</span><span class=p>)),</span>  <span class=c1># ãƒ‡ãƒ¢ç”¨ã®ãƒ©ãƒ³ãƒ€ãƒ å€¤</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nn>app</span><span class=o>-&gt;</span><span class=n>start</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=bp>__DATA__</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>@@</span> <span class=nv>dashboard</span><span class=o>.</span><span class=n>html</span><span class=o>.</span><span class=n>ep</span>
</span></span><span class=line><span class=cl><span class=o>&lt;!</span><span class=n>DOCTYPE</span> <span class=n>html</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>html</span> <span class=n>lang</span><span class=o>=</span><span class=s>&#34;ja&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;head&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>meta</span> <span class=n>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;title&gt;</span><span class=n>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span><span class=sr>&lt;/title&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;style&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>      <span class=n>font</span><span class=o>-</span><span class=n>family:</span> <span class=n>Arial</span><span class=p>,</span> <span class=n>sans</span><span class=o>-</span><span class=n>serif</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>      <span class=n>max</span><span class=o>-</span><span class=n>width:</span> <span class=mi>1200</span><span class=n>px</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>      <span class=n>margin:</span> <span class=mi>20</span><span class=n>px</span> <span class=n>auto</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>background:</span> <span class=c1>#f0f0f0;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>h1</span> <span class=p>{</span> <span class=n>text</span><span class=o>-</span><span class=n>align:</span> <span class=n>center</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>metrics</span><span class=o>-</span><span class=n>grid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>display:</span> <span class=n>grid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>grid</span><span class=o>-</span><span class=n>template</span><span class=o>-</span><span class=n>columns:</span> <span class=n>repeat</span><span class=p>(</span><span class=n>auto</span><span class=o>-</span><span class=n>fit</span><span class=p>,</span> <span class=n>minmax</span><span class=p>(</span><span class=mi>250</span><span class=n>px</span><span class=p>,</span> <span class=mi>1</span><span class=n>fr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=n>gap:</span> <span class=mi>20</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>margin:</span> <span class=mi>20</span><span class=n>px</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>metric</span><span class=o>-</span><span class=n>card</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>background:</span> <span class=n>white</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>padding:</span> <span class=mi>20</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>border</span><span class=o>-</span><span class=n>radius:</span> <span class=mi>8</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>box</span><span class=o>-</span><span class=n>shadow:</span> <span class=mi>0</span> <span class=mi>2</span><span class=n>px</span> <span class=mi>4</span><span class=n>px</span> <span class=n>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mf>0.1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>metric</span><span class=o>-</span><span class=n>card</span> <span class=n>h3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>margin:</span> <span class=mi>0</span> <span class=mi>0</span> <span class=mi>10</span><span class=n>px</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>color:</span> <span class=c1>#333;</span>
</span></span><span class=line><span class=cl>      <span class=n>font</span><span class=o>-</span><span class=n>size:</span> <span class=mi>1</span><span class=n>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>metric</span><span class=o>-</span><span class=n>value</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>font</span><span class=o>-</span><span class=n>size:</span> <span class=mf>2.5</span><span class=n>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>font</span><span class=o>-</span><span class=n>weight:</span> <span class=n>bold</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>color:</span> <span class=c1>#0066cc;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>metric</span><span class=o>-</span><span class=n>unit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>font</span><span class=o>-</span><span class=n>size:</span> <span class=mf>0.5</span><span class=n>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>color:</span> <span class=c1>#666;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>chart</span><span class=o>-</span><span class=n>container</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>background:</span> <span class=n>white</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>padding:</span> <span class=mi>20</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>border</span><span class=o>-</span><span class=n>radius:</span> <span class=mi>8</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>box</span><span class=o>-</span><span class=n>shadow:</span> <span class=mi>0</span> <span class=mi>2</span><span class=n>px</span> <span class=mi>4</span><span class=n>px</span> <span class=n>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mf>0.1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>margin:</span> <span class=mi>20</span><span class=n>px</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>#load-chart {</span>
</span></span><span class=line><span class=cl>      <span class=n>width:</span> <span class=mi>100</span><span class=nv>%</span><span class=err>;</span>
</span></span><span class=line><span class=cl>      <span class=nv>height:</span> <span class=mi>200</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>border:</span> <span class=mi>1</span><span class=n>px</span> <span class=n>solid</span> <span class=c1>#ddd;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>text</span><span class=o>-</span><span class=n>align:</span> <span class=n>center</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>padding:</span> <span class=mi>10</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>background:</span> <span class=c1>#d4edda;</span>
</span></span><span class=line><span class=cl>      <span class=n>color:</span> <span class=c1>#155724;</span>
</span></span><span class=line><span class=cl>      <span class=n>border</span><span class=o>-</span><span class=n>radius:</span> <span class=mi>4</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>margin</span><span class=o>-</span><span class=n>bottom:</span> <span class=mi>20</span><span class=n>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>status</span><span class=o>.</span><span class=n>disconnected</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>background:</span> <span class=c1>#f8d7da;</span>
</span></span><span class=line><span class=cl>      <span class=n>color:</span> <span class=c1>#721c24;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;/style&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;/head&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;body&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;h1&gt;</span><span class=err>ğŸ“Š</span> <span class=n>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span><span class=sr>&lt;/h1&gt;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>div</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;status&#34;</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;status&#34;</span><span class=o>&gt;</span><span class=n>æ¥ç¶šä¸­</span><span class=o>...</span><span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>div</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metrics-grid&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>div</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metric-card&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=sr>&lt;h3&gt;</span><span class=n>CPU</span> <span class=n>Load</span> <span class=p>(</span><span class=mi>1</span><span class=n>min</span><span class=p>)</span><span class=sr>&lt;/h3&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=n>div</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metric-value&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>span</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;load1&#34;</span><span class=o>&gt;-</span><span class=sr>&lt;/span&gt;</span>
</span></span><span class=line><span class=cl>      <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>    <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>div</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metric-card&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=sr>&lt;h3&gt;</span><span class=n>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡</span><span class=sr>&lt;/h3&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=n>div</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metric-value&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>span</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;mem-percent&#34;</span><span class=o>&gt;-</span><span class=sr>&lt;/span&gt;</span><span class=o>&lt;</span><span class=n>span</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metric-unit&#34;</span><span class=o>&gt;</span><span class=nv>%</span><span class=err>&lt;/</span><span class=nv>span</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>    <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>div</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metric-card&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=sr>&lt;h3&gt;</span><span class=n>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</span><span class=sr>&lt;/h3&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=n>div</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metric-value&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>span</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;mem-used&#34;</span><span class=o>&gt;-</span><span class=sr>&lt;/span&gt;</span><span class=o>&lt;</span><span class=n>span</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metric-unit&#34;</span><span class=o>&gt;</span><span class=n>MB</span><span class=sr>&lt;/span&gt;</span>
</span></span><span class=line><span class=cl>      <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>    <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>div</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metric-card&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=sr>&lt;h3&gt;</span><span class=n>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥ç¶šæ•°</span><span class=sr>&lt;/h3&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=n>div</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;metric-value&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>span</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;connections&#34;</span><span class=o>&gt;-</span><span class=sr>&lt;/span&gt;</span>
</span></span><span class=line><span class=cl>      <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>    <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>div</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;chart-container&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=sr>&lt;h3&gt;</span><span class=n>è² è·æ¨ç§»ã‚°ãƒ©ãƒ•</span><span class=sr>&lt;/h3&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>canvas</span> <span class=n>id</span><span class=o>=</span><span class=s>&#34;load-chart&#34;</span><span class=o>&gt;</span><span class=sr>&lt;/canvas&gt;</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;/div&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;script&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>const</span> <span class=n>ws</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WebSocket</span><span class=p>(</span><span class=s>&#39;ws://&#39;</span> <span class=o>+</span> <span class=n>location</span><span class=o>.</span><span class=n>host</span> <span class=o>+</span> <span class=s>&#39;/metrics&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>const</span> <span class=n>status</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;status&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=sr>//</span> <span class=n>ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ç”¨ã®é…åˆ—</span><span class=err>ï¼ˆ</span><span class=n>æœ€å¤§60ãƒã‚¤ãƒ³ãƒˆ</span> <span class=o>=</span> <span class=mi>1</span><span class=n>åˆ†é–“</span><span class=err>ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>const</span> <span class=n>chartData</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>labels:</span> <span class=o>[]</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>load1:</span> <span class=o>[]</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>load5:</span> <span class=o>[]</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>load15:</span> <span class=o>[]</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>const</span> <span class=n>maxDataPoints</span> <span class=o>=</span> <span class=mi>60</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ws</span><span class=o>.</span><span class=n>onopen</span> <span class=o>=</span> <span class=n>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>status</span><span class=o>.</span><span class=n>textContent</span> <span class=o>=</span> <span class=s>&#39;âœ… æ¥ç¶šä¸­ - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>status</span><span class=o>.</span><span class=n>className</span> <span class=o>=</span> <span class=s>&#39;status&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ws</span><span class=o>.</span><span class=n>onmessage</span> <span class=o>=</span> <span class=n>function</span><span class=p>(</span><span class=n>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>metrics</span> <span class=o>=</span> <span class=n>JSON</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>updateMetrics</span><span class=p>(</span><span class=n>metrics</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>updateChart</span><span class=p>(</span><span class=n>metrics</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ws</span><span class=o>.</span><span class=n>onclose</span> <span class=o>=</span> <span class=n>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>status</span><span class=o>.</span><span class=n>textContent</span> <span class=o>=</span> <span class=s>&#39;âŒ åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>status</span><span class=o>.</span><span class=n>className</span> <span class=o>=</span> <span class=s>&#39;status disconnected&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>updateMetrics</span><span class=p>(</span><span class=n>metrics</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;load1&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>textContent</span> <span class=o>=</span> <span class=n>Number</span><span class=p>(</span><span class=n>metrics</span><span class=o>.</span><span class=n>load</span><span class=o>.</span><span class=n>load1</span><span class=p>)</span><span class=o>.</span><span class=n>toFixed</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;mem-percent&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>textContent</span> <span class=o>=</span> <span class=n>metrics</span><span class=o>.</span><span class=n>memory</span><span class=o>.</span><span class=n>percent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;mem-used&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>textContent</span> <span class=o>=</span> <span class=n>metrics</span><span class=o>.</span><span class=n>memory</span><span class=o>.</span><span class=n>used</span><span class=o>.</span><span class=n>toLocaleString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;connections&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>textContent</span> <span class=o>=</span> <span class=n>metrics</span><span class=o>.</span><span class=n>connections</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>updateChart</span><span class=p>(</span><span class=n>metrics</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=nb>time</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Date</span><span class=p>(</span><span class=n>metrics</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>)</span><span class=o>.</span><span class=n>toLocaleTimeString</span><span class=p>(</span><span class=s>&#39;ja-JP&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=sr>//</span> <span class=n>ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ </span>
</span></span><span class=line><span class=cl>      <span class=n>chartData</span><span class=o>.</span><span class=n>labels</span><span class=o>.</span><span class=nb>push</span><span class=p>(</span><span class=nb>time</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>chartData</span><span class=o>.</span><span class=n>load1</span><span class=o>.</span><span class=nb>push</span><span class=p>(</span><span class=n>metrics</span><span class=o>.</span><span class=n>load</span><span class=o>.</span><span class=n>load1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>chartData</span><span class=o>.</span><span class=n>load5</span><span class=o>.</span><span class=nb>push</span><span class=p>(</span><span class=n>metrics</span><span class=o>.</span><span class=n>load</span><span class=o>.</span><span class=n>load5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>chartData</span><span class=o>.</span><span class=n>load15</span><span class=o>.</span><span class=nb>push</span><span class=p>(</span><span class=n>metrics</span><span class=o>.</span><span class=n>load</span><span class=o>.</span><span class=n>load15</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=sr>//</span> <span class=n>å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</span><span class=err>ï¼ˆ</span><span class=n>æœ€å¤§60ãƒã‚¤ãƒ³ãƒˆä¿æŒ</span><span class=err>ï¼‰</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>chartData</span><span class=o>.</span><span class=n>labels</span><span class=o>.</span><span class=nb>length</span> <span class=o>&gt;</span> <span class=n>maxDataPoints</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>chartData</span><span class=o>.</span><span class=n>labels</span><span class=o>.</span><span class=nb>shift</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>chartData</span><span class=o>.</span><span class=n>load1</span><span class=o>.</span><span class=nb>shift</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>chartData</span><span class=o>.</span><span class=n>load5</span><span class=o>.</span><span class=nb>shift</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>chartData</span><span class=o>.</span><span class=n>load15</span><span class=o>.</span><span class=nb>shift</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=n>drawChart</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=n>drawChart</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>canvas</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s>&#39;load-chart&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>ctx</span> <span class=o>=</span> <span class=n>canvas</span><span class=o>.</span><span class=n>getContext</span><span class=p>(</span><span class=s>&#39;2d&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>width</span> <span class=o>=</span> <span class=n>canvas</span><span class=o>.</span><span class=n>width</span> <span class=o>=</span> <span class=n>canvas</span><span class=o>.</span><span class=n>offsetWidth</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>height</span> <span class=o>=</span> <span class=n>canvas</span><span class=o>.</span><span class=n>height</span> <span class=o>=</span> <span class=mi>200</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=sr>//</span> <span class=n>ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>clearRect</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=sr>//</span> <span class=n>ã‚°ãƒ©ãƒ•ã®æç”»é ˜åŸŸ</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>padding</span> <span class=o>=</span> <span class=mi>40</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>chartWidth</span> <span class=o>=</span> <span class=n>width</span> <span class=o>-</span> <span class=n>padding</span> <span class=o>*</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>chartHeight</span> <span class=o>=</span> <span class=n>height</span> <span class=o>-</span> <span class=n>padding</span> <span class=o>*</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=sr>//</span> <span class=n>æœ€å¤§å€¤ã‚’è¨ˆç®—</span><span class=err>ï¼ˆ</span><span class=n>ã‚°ãƒ©ãƒ•ã®ã‚¹ã‚±ãƒ¼ãƒ«ç”¨</span><span class=err>ï¼‰</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>maxLoad</span> <span class=o>=</span> <span class=n>Math</span><span class=o>.</span><span class=n>max</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span><span class=n>chartData</span><span class=o>.</span><span class=n>load1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span><span class=n>chartData</span><span class=o>.</span><span class=n>load5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span><span class=n>chartData</span><span class=o>.</span><span class=n>load15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mi>1</span>  <span class=sr>//</span> <span class=n>æœ€å°å€¤1ã‚’ä¿è¨¼</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>const</span> <span class=n>yScale</span> <span class=o>=</span> <span class=n>chartHeight</span> <span class=sr>/ (maxLoad * 1.2);  /</span><span class=o>/</span> <span class=mi>20</span><span class=nv>%ãƒãƒ¼ã‚¸ãƒ³</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=sr>//</span> <span class=n>èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>strokeStyle</span> <span class=o>=</span> <span class=s>&#39;#e0e0e0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>lineWidth</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=n>let</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>5</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>const</span> <span class=n>y</span> <span class=o>=</span> <span class=n>padding</span> <span class=o>+</span> <span class=p>(</span><span class=n>chartHeight</span> <span class=o>/</span> <span class=mi>5</span><span class=p>)</span> <span class=o>*</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=n>beginPath</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=n>moveTo</span><span class=p>(</span><span class=n>padding</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=n>lineTo</span><span class=p>(</span><span class=n>width</span> <span class=o>-</span> <span class=n>padding</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=n>stroke</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=sr>//</span> <span class=n>ãƒ©ã‚¤ãƒ³ã‚’æç”»ã™ã‚‹é–¢æ•°</span>
</span></span><span class=line><span class=cl>      <span class=n>function</span> <span class=n>drawLine</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>color</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=nb>length</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=n>strokeStyle</span> <span class=o>=</span> <span class=n>color</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=n>lineWidth</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=n>beginPath</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>const</span> <span class=n>xStep</span> <span class=o>=</span> <span class=n>chartWidth</span> <span class=o>/</span> <span class=p>(</span><span class=n>maxDataPoints</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=n>forEach</span><span class=p>((</span><span class=n>value</span><span class=p>,</span> <span class=nb>index</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>const</span> <span class=n>x</span> <span class=o>=</span> <span class=n>padding</span> <span class=o>+</span> <span class=p>(</span><span class=n>xStep</span> <span class=o>*</span> <span class=nb>index</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>const</span> <span class=n>y</span> <span class=o>=</span> <span class=n>padding</span> <span class=o>+</span> <span class=n>chartHeight</span> <span class=o>-</span> <span class=p>(</span><span class=n>value</span> <span class=o>*</span> <span class=n>yScale</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nb>index</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=n>moveTo</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=n>lineTo</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=n>stroke</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=sr>//</span> <span class=n>å„è² è·ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ­ãƒƒãƒˆ</span>
</span></span><span class=line><span class=cl>      <span class=n>drawLine</span><span class=p>(</span><span class=n>chartData</span><span class=o>.</span><span class=n>load1</span><span class=p>,</span> <span class=s>&#39;#ff6b6b&#39;</span><span class=p>);</span>   <span class=sr>//</span> <span class=mi>1</span><span class=n>åˆ†å¹³å‡</span><span class=err>ï¼ˆ</span><span class=n>èµ¤</span><span class=err>ï¼‰</span>
</span></span><span class=line><span class=cl>      <span class=n>drawLine</span><span class=p>(</span><span class=n>chartData</span><span class=o>.</span><span class=n>load5</span><span class=p>,</span> <span class=s>&#39;#4ecdc4&#39;</span><span class=p>);</span>   <span class=sr>//</span> <span class=mi>5</span><span class=n>åˆ†å¹³å‡</span><span class=err>ï¼ˆ</span><span class=n>é’ç·‘</span><span class=err>ï¼‰</span>
</span></span><span class=line><span class=cl>      <span class=n>drawLine</span><span class=p>(</span><span class=n>chartData</span><span class=o>.</span><span class=n>load15</span><span class=p>,</span> <span class=s>&#39;#45b7d1&#39;</span><span class=p>);</span>  <span class=sr>//</span> <span class=mi>15</span><span class=n>åˆ†å¹³å‡</span><span class=err>ï¼ˆ</span><span class=n>é’</span><span class=err>ï¼‰</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=sr>//</span> <span class=n>å‡¡ä¾‹</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>font</span> <span class=o>=</span> <span class=s>&#39;12px Arial&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>fillStyle</span> <span class=o>=</span> <span class=s>&#39;#ff6b6b&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>fillText</span><span class=p>(</span><span class=s>&#39;1min&#39;</span><span class=p>,</span> <span class=n>width</span> <span class=o>-</span> <span class=n>padding</span> <span class=o>-</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>fillStyle</span> <span class=o>=</span> <span class=s>&#39;#4ecdc4&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>fillText</span><span class=p>(</span><span class=s>&#39;5min&#39;</span><span class=p>,</span> <span class=n>width</span> <span class=o>-</span> <span class=n>padding</span> <span class=o>-</span> <span class=mi>60</span><span class=p>,</span> <span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>fillStyle</span> <span class=o>=</span> <span class=s>&#39;#45b7d1&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>fillText</span><span class=p>(</span><span class=s>&#39;15min&#39;</span><span class=p>,</span> <span class=n>width</span> <span class=o>-</span> <span class=n>padding</span> <span class=o>-</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=sr>//</span> <span class=n>Yè»¸ãƒ©ãƒ™ãƒ«</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>fillStyle</span> <span class=o>=</span> <span class=s>&#39;#666&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>ctx</span><span class=o>.</span><span class=n>textAlign</span> <span class=o>=</span> <span class=s>&#39;right&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=n>let</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>5</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>const</span> <span class=n>value</span> <span class=o>=</span> <span class=p>(</span><span class=n>maxLoad</span> <span class=o>*</span> <span class=mf>1.2</span> <span class=o>/</span> <span class=mi>5</span> <span class=o>*</span> <span class=p>(</span><span class=mi>5</span> <span class=o>-</span> <span class=n>i</span><span class=p>))</span><span class=o>.</span><span class=n>toFixed</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>const</span> <span class=n>y</span> <span class=o>=</span> <span class=n>padding</span> <span class=o>+</span> <span class=p>(</span><span class=n>chartHeight</span> <span class=o>/</span> <span class=mi>5</span><span class=p>)</span> <span class=o>*</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=n>fillText</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>padding</span> <span class=o>-</span> <span class=mi>10</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;/script&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl><span class=sr>&lt;/html&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>ãƒã‚¤ãƒ³ãƒˆè§£èª¬ï¼š</strong></p><ul><li><code>Mojo::IOLoop->recurring(1 => sub {...})</code>: 1ç§’ã”ã¨ã«å®šæœŸå®Ÿè¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒãƒ¼</li><li><code>collect_metrics()</code>: ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’åé›†ã™ã‚‹é–¢æ•°ï¼ˆ<code>/proc/meminfo</code>ã‚„<code>uptime</code>ã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨ï¼‰</li><li>Canvas APIã‚’ä½¿ã£ãŸç°¡æ˜“ã‚°ãƒ©ãƒ•æç”»</li><li>ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å®šæœŸçš„ã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å—ä¿¡ã—ã¦è¡¨ç¤º</li><li>ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã¯æœ€å¤§60ãƒã‚¤ãƒ³ãƒˆï¼ˆ1åˆ†é–“åˆ†ï¼‰ã‚’ä¿æŒã—ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«å‰Šé™¤</li></ul><p>ã“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>perl dashboard_server.pl daemon
</span></span></code></pre></td></tr></table></div></div><p>ãƒ–ãƒ©ã‚¦ã‚¶ã§ <code>http://localhost:3000/</code> ã‚’é–‹ãã¨ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒæ›´æ–°ã•ã‚Œã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚è¤‡æ•°ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ã‚‚ã€ãã‚Œãã‚ŒãŒç‹¬ç«‹ã—ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å—ä¿¡ã—ã¾ã™ã€‚</p><h3 id=websocketã¨httpãƒãƒ¼ãƒªãƒ³ã‚°ã®æ¯”è¼ƒ>WebSocketã¨HTTPãƒãƒ¼ãƒªãƒ³ã‚°ã®æ¯”è¼ƒ</h3><p>å¾“æ¥ã®HTTPãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆå®šæœŸçš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹æ–¹å¼ï¼‰ã¨æ¯”è¼ƒã—ã¦ã€WebSocketã«ã¯ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ï¼š</p><ul><li><strong>ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·</strong>: æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãŒã™ãã«å±Šã</li><li><strong>ä½ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰</strong>: æ¯å›HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é€ã‚‹å¿…è¦ãŒãªãã€é€šä¿¡é‡ãŒå¤§å¹…ã«å‰Šæ¸›ã•ã‚Œã‚‹</li><li><strong>ã‚µãƒ¼ãƒãƒ¼ãƒªã‚½ãƒ¼ã‚¹å‰Šæ¸›</strong>: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ãŒä¸è¦ãªãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼è² è·ãŒä½ã„</li><li><strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§</strong>: ã‚µãƒ¼ãƒãƒ¼å´ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å³åº§ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥ã§ãã‚‹</li></ul><h2 id=websocketã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹>WebSocketã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</h2><p>å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§WebSocketã‚’ä½¿ã†éš›ã®ãƒã‚¤ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚</p><h3 id=ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</h3><p>WebSocketã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ã€é€šå¸¸ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä»¥ä¸Šã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚</p><p><strong>XSSï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼‰å¯¾ç­–</strong></p><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãã®ã¾ã¾HTMLã«è¡¨ç¤ºã™ã‚‹å ´åˆã€å¿…ãšã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’è¡Œã„ã¾ã—ã‚‡ã†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>escapeHtml</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>div</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>div</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>div</span><span class=p>.</span><span class=nx>innerHTML</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>WSSï¼ˆWebSocket Secureï¼‰ã®ä½¿ç”¨</strong></p><p>æœ¬ç•ªç’°å¢ƒã§ã¯ã€å¿…ãšæš—å·åŒ–ã•ã‚ŒãŸ <code>wss://</code> ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã—ã‚‡ã†ã€‚HTTPSã¨åŒæ§˜ã«ã€é€šä¿¡å†…å®¹ã®ç›—è´ã‚„æ”¹ã–ã‚“ã‚’é˜²ãã¾ã™ã€‚Mojoliciousã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç°¡å˜ã«TLSå¯¾å¿œã§ãã¾ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># è¨¼æ˜æ›¸ã‚’ç”¨æ„ã—ã¦èµ·å‹•</span>
</span></span><span class=line><span class=cl>perl myapp.pl daemon -l <span class=s1>&#39;https://*:3000?cert=/path/to/cert.pem&amp;key=/path/to/key.pem&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>å…¥åŠ›æ¤œè¨¼ã¨ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³</strong></p><p>å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¿…ãšæ¤œè¨¼ã—ã€æƒ³å®šå¤–ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‹’å¦ã—ã¾ã—ã‚‡ã†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=nv>$c</span><span class=o>-&gt;</span><span class=n>on</span><span class=p>(</span><span class=n>message</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c, $msg) {</span>
</span></span><span class=line><span class=cl>  <span class=c1># é•·ã™ãã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ‹’å¦</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>length</span><span class=p>(</span><span class=nv>$msg</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nb>send</span><span class=p>({</span><span class=n>json</span> <span class=o>=&gt;</span> <span class=p>{</span><span class=n>error</span> <span class=o>=&gt;</span> <span class=s>&#39;Message too long&#39;</span><span class=p>}});</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># JSONã¨ã—ã¦å¦¥å½“ã‹ãƒã‚§ãƒƒã‚¯</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$data</span> <span class=o>=</span> <span class=nb>eval</span> <span class=p>{</span> <span class=n>decode_json</span><span class=p>(</span><span class=nv>$msg</span><span class=p>)</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=vg>$@</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nb>send</span><span class=p>({</span><span class=n>json</span> <span class=o>=&gt;</span> <span class=p>{</span><span class=n>error</span> <span class=o>=&gt;</span> <span class=s>&#39;Invalid JSON&#39;</span><span class=p>}});</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># å‡¦ç†ã‚’ç¶šã‘ã‚‹...</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</h3><p>WebSocketã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ¬ç•ªç’°å¢ƒã§é‹ç”¨ã™ã‚‹éš›ã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã«æ³¨æ„ã‚’æ‰•ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p><p><strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®ç®¡ç†</strong></p><p>å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹å ´åˆã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ãªããƒã‚¤ãƒŠãƒªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ<code>$c->send({binary => $data})</code>ï¼‰ã®ä½¿ç”¨ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚ç”»åƒã‚„ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã«é©ã—ã¦ã„ã¾ã™ã€‚</p><p><strong>æ¥ç¶šæ•°ã®åˆ¶é™</strong></p><p>ã‚µãƒ¼ãƒãƒ¼ãƒªã‚½ãƒ¼ã‚¹ã‚’å®ˆã‚‹ãŸã‚ã€æœ€å¤§æ¥ç¶šæ•°ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ã‚‚é‡è¦ã§ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>my</span> <span class=nv>$max_clients</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>websocket</span> <span class=s>&#39;/chat&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c) {</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>scalar</span><span class=p>(</span><span class=nb>keys</span> <span class=nv>%$clients</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=nv>$max_clients</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nb>send</span><span class=p>(</span><span class=s>&#39;Server is full&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>finish</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1># é€šå¸¸ã®å‡¦ç†...</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆï¼ˆPing/Pongï¼‰</strong></p><p>é•·æ™‚é–“æ¥ç¶šã‚’ç¶­æŒã™ã‚‹å ´åˆã€å®šæœŸçš„ãªPingã§æ¥ç¶šã®ç”Ÿå­˜ç¢ºèªã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç„¡åŠ¹ãªæ¥ç¶šã‚’æ—©æœŸã«æ¤œå‡ºã—ã€ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾ã§ãã¾ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=n>websocket</span> <span class=s>&#39;/chat&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>($c) {</span>
</span></span><span class=line><span class=cl>  <span class=c1># 30ç§’ã”ã¨ã«Pingã‚’é€ä¿¡ï¼ˆæ¥ç¶šã®ç”Ÿå­˜ç¢ºèªï¼‰</span>
</span></span><span class=line><span class=cl>  <span class=k>my</span> <span class=nv>$ping_timer</span> <span class=o>=</span> <span class=nn>Mojo::IOLoop</span><span class=o>-&gt;</span><span class=n>recurring</span><span class=p>(</span><span class=mi>30</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>-&gt;</span><span class=nb>send</span><span class=p>({</span><span class=n>ping</span> <span class=o>=&gt;</span> <span class=s>&#39;&#39;</span><span class=p>});</span>  <span class=c1># Pingãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é€ä¿¡</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nv>$c</span><span class=o>-&gt;</span><span class=n>on</span><span class=p>(</span><span class=n>finish</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nn>Mojo::IOLoop</span><span class=o>-&gt;</span><span class=n>remove</span><span class=p>(</span><span class=nv>$ping_timer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨å†æ¥ç¶š>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨å†æ¥ç¶š</h3><p>WebSocketæ¥ç¶šã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ã€ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã©æ§˜ã€…ãªç†ç”±ã§åˆ‡æ–­ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è‡ªå‹•å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å¤§å¹…ã«å‘ä¸Šã§ãã¾ã™ã€‚</p><p>ä»¥ä¸‹ã¯ã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã‚’ä½¿ã£ãŸå†æ¥ç¶šã®å®Ÿè£…ä¾‹ã§ã™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>let</span> <span class=nx>ws</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>reconnectInterval</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>;</span>  <span class=c1>// åˆæœŸå€¤1ç§’
</span></span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>maxReconnectInterval</span> <span class=o>=</span> <span class=mi>30000</span><span class=p>;</span>  <span class=c1>// æœ€å¤§30ç§’
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>connect</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ws</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebSocket</span><span class=p>(</span><span class=s1>&#39;ws://localhost:3000/chat&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>ws</span><span class=p>.</span><span class=nx>onopen</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;æ¥ç¶šã—ã¾ã—ãŸ&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>reconnectInterval</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>;</span>  <span class=c1>// ãƒªã‚»ãƒƒãƒˆ
</span></span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>ws</span><span class=p>.</span><span class=nx>onclose</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šã—ã¾ã™...&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>setTimeout</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>reconnectInterval</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=nx>reconnectInterval</span> <span class=o>*</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>maxReconnectInterval</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=nx>reconnectInterval</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>ws</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;WebSocketã‚¨ãƒ©ãƒ¼:&#39;</span><span class=p>,</span> <span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>connect</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=ã¾ã¨ã‚>ã¾ã¨ã‚</h2><p>ã“ã®è¨˜äº‹ã§ã¯ã€<strong>Perl</strong>ã®<strong>Mojolicious</strong>ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã£ã¦ã€<strong>WebSocket</strong>ã®åŸºç¤ã‚’3ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å­¦ã³ã¾ã—ãŸï¼š</p><ol><li><strong>ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼</strong>: WebSocketã®åŸºæœ¬çš„ãªé€å—ä¿¡ã®ä»•çµ„ã¿ã‚’ç†è§£</li><li><strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ</strong>: è¤‡æ•°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã€JSONå½¢å¼ã§ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ åŒ–</li><li><strong>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</strong>: ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯è¦–åŒ–</li></ol><p><strong>Mojoliciousã®å¼·ã¿ï¼š</strong></p><ul><li>è¿½åŠ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸è¦ã§WebSocketãŒä½¿ãˆã‚‹</li><li>UTF-8ã®è‡ªå‹•å‡¦ç†ã§æ—¥æœ¬èªã‚‚å®‰å¿ƒ</li><li>ã‚·ãƒ³ãƒ—ãƒ«ãªAPIã§å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„</li><li>éåŒæœŸI/Oã«ã‚ˆã‚‹é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</li></ul><p><strong>WebSocketãŒæ´»ãã‚‹å ´é¢ï¼š</strong></p><ul><li>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</li><li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ </li><li>æ ªä¾¡ãƒ»ã‚¹ãƒãƒ¼ãƒ„ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰</li><li>IoTãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°</li><li>ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ï¼ˆå…±åŒç·¨é›†ãªã©ï¼‰</li></ul><p><strong>WebSocket</strong>ã¯ä¸€è¦‹é›£ã—ãã†ã«æ€ãˆã¾ã™ãŒã€<strong>Mojolicious</strong>ã‚’ä½¿ãˆã°ã‚ãšã‹æ•°è¡Œã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã¾ã™ã€‚ã¾ãšã¯ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã—ã¦ã¿ã¦ã€<strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡</strong>ã®é¢ç™½ã•ã‚’ä½“é¨“ã—ã¦ã¿ã¦ãã ã•ã„ï¼</p><h2 id=æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h2><p>WebSocketã®åŸºç¤ã‚’å­¦ã‚“ã ã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå¿œç”¨ã«ã‚‚ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š</p><ul><li><strong>èªè¨¼æ©Ÿèƒ½ã®è¿½åŠ </strong>: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</li><li><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº</strong>: ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®æ°¸ç¶šåŒ–</li><li><strong>è² è·åˆ†æ•£</strong>: è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼ã§ã®WebSocketé‹ç”¨</li><li><strong>ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ</strong>: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚¢ãƒ—ãƒªã¨ã®é€£æº</li></ul><h2 id=å‚è€ƒãƒªãƒ³ã‚¯>å‚è€ƒãƒªãƒ³ã‚¯</h2><p><strong>Mojolicious</strong>ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ã€ã“ã¡ã‚‰ã®è¨˜äº‹ã‚‚å‚è€ƒã«ã—ã¦ãã ã•ã„ï¼š</p><div class=linkcard><a class=linkcard-a href=https://www.nqou.net/2025/12/04/000000/ target=_blank rel="noopener noreferrer nofollow" title=https://www.nqou.net/2025/12/04/000000/ aria-label=https://www.nqou.net/2025/12/04/000000/><div class=linkcard-content><div class=linkcard-title>https://www.nqou.net/2025/12/04/000000/</div><div class=linkcard-meta><img class=linkcard-favicon src=https://www.nqou.net/favicon.ico alt onerror='this.style.display="none"'><span class=linkcard-domain>è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç–‘ãˆ</span></div></div></a></div><p>å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼š</p><div class=linkcard><a class=linkcard-a href=https://docs.mojolicious.org/ target=_blank rel="noopener noreferrer nofollow" title=https://docs.mojolicious.org/ aria-label=https://docs.mojolicious.org/><div class=linkcard-content><div class=linkcard-title>https://docs.mojolicious.org/</div><div class=linkcard-meta><img class=linkcard-favicon src=https://docs.mojolicious.org/favicon.ico alt onerror='this.style.display="none"'><span class=linkcard-domain>docs.mojolicious.org</span></div></div></a></div><p>WebSocketãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®è©³ç´°ï¼ˆRFC 6455ï¼‰ï¼š</p><div class=linkcard><a class=linkcard-a href=https://datatracker.ietf.org/doc/html/rfc6455 target=_blank rel="noopener noreferrer nofollow" title=https://datatracker.ietf.org/doc/html/rfc6455 aria-label=https://datatracker.ietf.org/doc/html/rfc6455><div class=linkcard-content><div class=linkcard-title>https://datatracker.ietf.org/doc/html/rfc6455</div><div class=linkcard-meta><img class=linkcard-favicon src=https://datatracker.ietf.org/favicon.ico alt onerror='this.style.display="none"'><span class=linkcard-domain>datatracker.ietf.org</span></div></div></a></div><p>Happy WebSocket coding! ğŸš€</p></section><footer class=article-footer><section class=article-tags><a href=/tags/perl/>Perl</a>
<a href=/tags/mojolicious/>Mojolicious</a>
<a href=/tags/websocket/>Websocket</a>
<a href=/tags/real-time/>Real-Time</a>
<a href=/tags/web-development/>Web-Development</a>
<a href=/tags/tutorial/>Tutorial</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>é–¢é€£ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/warehouse/mojolicious/><div class=article-image><img src=/favicon.png loading=lazy data-key data-hash=/favicon.png></div><div class=article-details><h2 class=article-title>Mojolicious ã‚¹ãƒ‘ã‚¤ã‚¯èª¿æŸ»</h2></div></a></article><article class=has-image><a href=/2026/01/16/004330/><div class=article-image><img src=/public_images/2026/observer-pattern-series-image.jpg loading=lazy data-key data-hash=/public_images/2026/observer-pattern-series-image.jpg></div><div class=article-details><h2 class=article-title>ã€ç›®æ¬¡ã€‘Perlã§ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œã‚ã†ï¼ˆå…¨10å›ï¼‰</h2></div></a></article><article class=has-image><a href=/2026/01/13/233330/><div class=article-image><img src=/public_images/2026/memento-pattern-series-image.jpg loading=lazy data-key data-hash=/public_images/2026/memento-pattern-series-image.jpg></div><div class=article-details><h2 class=article-title>ç¬¬9å›-å®Œæˆï¼ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½ä»˜ãRPG - Mooã‚’ä½¿ã£ã¦ã‚²ãƒ¼ãƒ ã®ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½ã‚’ä½œã£ã¦ã¿ã‚ˆã†</h2></div></a></article><article class=has-image><a href=/2026/01/12/230702/><div class=article-image><img src=/public_images/2026/factory-method-series-image.jpg loading=lazy data-key data-hash=/public_images/2026/factory-method-series-image.jpg></div><div class=article-details><h2 class=article-title>ã€ç›®æ¬¡ã€‘Perlã¨Mooã§ãƒ¬ãƒãƒ¼ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½œã£ã¦ã¿ã‚ˆã†ï¼ˆå…¨10å›ï¼‰</h2></div></a></article><article class=has-image><a href=/2026/01/12/230256/><div class=article-image><img src=/public_images/2026/factory-method-series-image.jpg loading=lazy data-key data-hash=/public_images/2026/factory-method-series-image.jpg></div><div class=article-details><h2 class=article-title>ç¬¬9å›-å®Œæˆï¼ãƒ¬ãƒãƒ¼ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ - Perlã¨Mooã§ãƒ¬ãƒãƒ¼ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½œã£ã¦ã¿ã‚ˆã†</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//nqounet.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2000 -
2026 è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç–‘ãˆ</section><section class=powerby><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> ã§æ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>ãƒ†ãƒ¼ãƒ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> ã¯ <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> ã«ã‚ˆã£ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>