<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="JSON-RPC 2.0のエラーレスポンスにおけるID必須仕様について、仕様の意図、実装の注意点、他のRPCプロトコルとの比較を通じて詳しく解説します。JSON::RPC::Specの8年ぶりの修正から学んだこと。"><title>JSON-RPC 2.0エラーオブジェクトにおけるID必須仕様 - 8年越しの誤解と正しい理解</title><link rel=canonical href=https://www.nqou.net/2025/12/12/005457/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="JSON-RPC 2.0エラーオブジェクトにおけるID必須仕様 - 8年越しの誤解と正しい理解"><meta property='og:description' content="JSON-RPC 2.0のエラーレスポンスにおけるID必須仕様について、仕様の意図、実装の注意点、他のRPCプロトコルとの比較を通じて詳しく解説します。JSON::RPC::Specの8年ぶりの修正から学んだこと。"><meta property='og:url' content='https://www.nqou.net/2025/12/12/005457/'><meta property='og:site_name' content='nqou.net'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='json-rpc'><meta property='article:tag' content='rpc'><meta property='article:tag' content='api-design'><meta property='article:tag' content='perl'><meta property='article:tag' content='protocol'><meta property='article:tag' content='error-handling'><meta property='article:published_time' content='2025-12-12T00:54:57+09:00'><meta property='article:modified_time' content='2025-12-12T00:54:57+09:00'><meta property='og:image' content='https://www.nqou.net/public_images/2025/1765468497-image.jpg'><meta name=twitter:title content="JSON-RPC 2.0エラーオブジェクトにおけるID必須仕様 - 8年越しの誤解と正しい理解"><meta name=twitter:description content="JSON-RPC 2.0のエラーレスポンスにおけるID必須仕様について、仕様の意図、実装の注意点、他のRPCプロトコルとの比較を通じて詳しく解説します。JSON::RPC::Specの8年ぶりの修正から学んだこと。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://www.nqou.net/public_images/2025/1765468497-image.jpg'><link rel="shortcut icon" href=/favicon.png><style>@import 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap';:root{--base-font-family:Arial, "Noto Sans JP", sans-serif}</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3923446804785015" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js defer></script><script defer>document.addEventListener("DOMContentLoaded",function(){try{typeof mermaid!="undefined"&&document.querySelector(".mermaid")&&mermaid.initialize({startOnLoad:!0,securityLevel:"strict"})}catch(e){console.warn("Mermaid failed to initialize:",e)}})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-E50H9ESN7E"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E50H9ESN7E")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=メニューを開く・閉じる>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/public_images/nqounet201703.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🥃</span></figure><div class=site-meta><h1 class=site-name><a href=/>nqou.net</a></h1><h2 class=site-description>Whisky, Perl, Kansai.pm</h2></div></header><ol class=menu-social><li><a href=https://github.com/nqounet target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/nqounet target=_blank title=X rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/advent-calendar-2025/><svg class="icon icon-tabler icon-tabler-calendar" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="5" width="16" height="16" rx="2"/><line x1="16" y1="3" x2="16" y2="7"/><line x1="8" y1="3" x2="8" y2="7"/><line x1="4" y1="11" x2="20" y2="11"/><path d="M8 15h.01"/><path d="M12 15h.01"/><path d="M16 15h.01"/><path d="M8 19h.01"/><path d="M12 19h.01"/><path d="M16 19h.01"/></svg>
<span>Perl Advent Calendar 2025 - AI Edition</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>ダークモード</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目次</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#はじめに---8年越しの誤解>はじめに - 8年越しの誤解</a></li><li><a href=#json-rpc-20の基本構造>JSON-RPC 2.0の基本構造</a><ol><li><a href=#リクエストオブジェクト>リクエストオブジェクト</a></li><li><a href=#レスポンスオブジェクト>レスポンスオブジェクト</a></li></ol></li><li><a href=#エラーレスポンスにおけるid必須仕様>エラーレスポンスにおけるID必須仕様</a><ol><li><a href=#仕様の正確な記述>仕様の正確な記述</a></li><li><a href=#私の誤解と正しい理解>私の誤解と正しい理解</a></li><li><a href=#nullになるケース>nullになるケース</a></li><li><a href=#idを保持するケース>IDを保持するケース</a></li></ol></li><li><a href=#なぜidを可能な限り保持するのか>なぜIDを可能な限り保持するのか</a><ol><li><a href=#非同期通信とリクエストの多重化>非同期通信とリクエストの多重化</a></li><li><a href=#トレーサビリティとデバッグ>トレーサビリティとデバッグ</a></li><li><a href=#バッチリクエストでの識別>バッチリクエストでの識別</a></li></ol></li><li><a href=#jsonrpcspecの修正内容>JSON::RPC::Specの修正内容</a><ol><li><a href=#修正前のコード概念>修正前のコード（概念）</a></li><li><a href=#修正後のコード概念>修正後のコード（概念）</a></li></ol></li><li><a href=#他のrpcプロトコルとの比較>他のRPCプロトコルとの比較</a><ol><li><a href=#rest-api>REST API</a></li><li><a href=#xml-rpc>XML-RPC</a></li><li><a href=#grpc>gRPC</a></li><li><a href=#比較表>比較表</a></li><li><a href=#json-rpc-20の位置づけ>JSON-RPC 2.0の位置づけ</a></li></ol></li><li><a href=#実装時の注意点とベストプラクティス>実装時の注意点とベストプラクティス</a><ol><li><a href=#サーバー側の実装>サーバー側の実装</a></li><li><a href=#クライアント側の実装>クライアント側の実装</a></li><li><a href=#テストのポイント>テストのポイント</a></li></ol></li><li><a href=#まとめ>まとめ</a><ol><li><a href=#idを可能な限り保持する設計の意義>IDを可能な限り保持する設計の意義</a></li><li><a href=#8年の誤解から学んだこと>8年の誤解から学んだこと</a></li><li><a href=#これからjson-rpcを使う方へ>これからJSON-RPCを使う方へ</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/2025/12/12/005457/><img src=/public_images/2025/1765468497-image.jpg loading=lazy alt="Featured image of post JSON-RPC 2.0エラーオブジェクトにおけるID必須仕様 - 8年越しの誤解と正しい理解"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2025/12/12/005457/>JSON-RPC 2.0エラーオブジェクトにおけるID必須仕様 - 8年越しの誤解と正しい理解</a></h2><h3 class=article-subtitle>JSON-RPC 2.0のエラーレスポンスにおけるID必須仕様について、仕様の意図、実装の注意点、他のRPCプロトコルとの比較を通じて詳しく解説します。JSON::RPC::Specの8年ぶりの修正から学んだこと。</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>12月 12, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>読了時間: 12分</time></div></footer></div></header><section class=article-content><h2 id=はじめに---8年越しの誤解>はじめに - 8年越しの誤解</h2><p>恥ずかしながら、私は8年もの間、JSON-RPC 2.0の仕様を誤解していました。</p><p>具体的には、「エラーレスポンスの場合は、リクエストIDが正しく取得できた場合でも、IDをnullにして返す必要がある」と解釈していたのです。この誤解のまま、自作のPerlモジュール <code>JSON::RPC::Spec</code> を実装し、CPANに公開していました。</p><link rel=stylesheet href=/css/linkcard.css><div class=linkcard><a class=linkcard-a href=https://metacpan.org/pod/JSON::RPC::Spec target=_blank rel="noopener noreferrer"><div class=linkcard-image><img src=https://metacpan.org/static/images/dots.png alt=JSON::RPC::Spec loading=lazy></div><div class=linkcard-content><div class=linkcard-title>JSON::RPC::Spec</div><div class=linkcard-description>Yet another JSON-RPC 2.0 Implementation</div><div class=linkcard-meta><img class=linkcard-favicon src=https://metacpan.org/favicon.ico alt onerror='this.style.display="none"'>
<span class=linkcard-domain>MetaCPAN</span></div></div></a></div><p>最近、別の用途でJSON-RPC 2.0の仕様を見直す機会があり、ようやく自分の勘違いに気づきました。正しくは「IDは可能な限り保持する」というスタンスの仕様だったのです。</p><p>この記事では、JSON-RPC 2.0におけるエラー時のID必須仕様について、仕様の意図、実装の注意点、他のRPCプロトコルとの比較などを詳しく解説します。</p><h2 id=json-rpc-20の基本構造>JSON-RPC 2.0の基本構造</h2><p>まず、JSON-RPC 2.0の基本的な構造を確認しておきましょう。</p><h3 id=リクエストオブジェクト>リクエストオブジェクト</h3><p>JSON-RPC 2.0のリクエストは、以下の構造を持ちます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;subtract&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>42</span><span class=p>,</span> <span class=mi>23</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>jsonrpc</code>: プロトコルバージョン（必須、&ldquo;2.0"固定）</li><li><code>method</code>: 呼び出すメソッド名（必須）</li><li><code>params</code>: パラメータ（省略可）</li><li><code>id</code>: リクエスト識別子（通知以外では必須）</li></ul><h3 id=レスポンスオブジェクト>レスポンスオブジェクト</h3><p>成功時のレスポンスは以下のようになります。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;result&#34;</span><span class=p>:</span> <span class=mi>19</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>エラー時のレスポンスはこうなります。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=mi>-32601</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Method not found&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>重要なのは、<strong>エラーレスポンスにもidフィールドが必須</strong>という点です。</p><h2 id=エラーレスポンスにおけるid必須仕様>エラーレスポンスにおけるID必須仕様</h2><h3 id=仕様の正確な記述>仕様の正確な記述</h3><p>JSON-RPC 2.0の公式仕様書には、エラーレスポンスのIDについて、以下のように明記されています。</p><blockquote><p>&ldquo;id: It MUST be the same as the value of the id member in the Request Object. If there was an error in detecting the id in the Request object (e.g. Parse error/Invalid Request), it MUST be Null.&rdquo;</p></blockquote><p>日本語に訳すと：</p><p><strong>「id: リクエストオブジェクトのidメンバーの値と同じでなければならない（MUST）。リクエストオブジェクトのidを検出する際にエラーが発生した場合（例：パースエラーや無効なリクエスト）、idはNullでなければならない（MUST）。」</strong></p><h3 id=私の誤解と正しい理解>私の誤解と正しい理解</h3><p>私が誤解していたのは、この「MUST be Null」の適用範囲でした。</p><p><strong>誤解していた解釈：</strong></p><ul><li>エラーが発生した場合は、常にidをnullにする</li></ul><p><strong>正しい解釈：</strong></p><ul><li>リクエストからidを正しく取得できた場合は、そのidをそのまま返す</li><li>リクエストのパースに失敗するなど、idを取得できなかった場合のみ、nullを返す</li></ul><p>つまり、<strong>IDは可能な限り保持する</strong>というのが仕様の意図なのです。</p><h3 id=nullになるケース>nullになるケース</h3><p>IDがnullになるのは、以下のような限定的なケースのみです。</p><p><strong>1. Parse Error（-32700）</strong></p><p>JSONのパースに失敗した場合、リクエスト全体が読み取れないため、idも取得できません。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=mi>-32700</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Parse error&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>2. Invalid Request（-32600）</strong></p><p>JSON自体は正しくても、JSON-RPCのリクエスト形式として不正な場合です。例えば、<code>method</code>フィールドが欠けている場合など。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// 不正なリクエスト例
</span></span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=c1>// methodが欠けている！
</span></span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>この場合も、idを安全に取得できないと判断されれば、nullが返されます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=mi>-32600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Invalid Request&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>3. その他、idが取得不能な場合</strong></p><p>リクエストにidフィールドが存在しない、または型が不正な場合なども該当します。</p><h3 id=idを保持するケース>IDを保持するケース</h3><p>一方、以下のようなエラーの場合は、リクエストのIDをそのまま返します。</p><p><strong>Method not found（-32601）</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// リクエスト
</span></span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;nonexistent&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>42</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// レスポンス
</span></span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=mi>-32601</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Method not found&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>42</span>  <span class=c1>// リクエストのIDを保持
</span></span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Invalid params（-32602）</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// リクエスト
</span></span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;subtract&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;not&#34;</span><span class=p>,</span> <span class=s2>&#34;numbers&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;abc&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// レスポンス
</span></span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=mi>-32602</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Invalid params&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;abc&#34;</span>  <span class=c1>// リクエストのIDを保持
</span></span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Internal error（-32603）やアプリケーションエラー</strong></p><p>これらも同様に、リクエストのIDを保持します。</p><h2 id=なぜidを可能な限り保持するのか>なぜIDを可能な限り保持するのか</h2><p>この「IDを可能な限り保持する」という設計には、深い意図があります。</p><h3 id=非同期通信とリクエストの多重化>非同期通信とリクエストの多重化</h3><p>JSON-RPC 2.0は、WebSocketやHTTP/2のような非同期通信プロトコル上での利用を想定しています。</p><p>クライアントが複数のリクエストを並列に送信した場合、レスポンスの順序は保証されません。IDがあることで、どのレスポンスがどのリクエストに対応するのかを確実に識別できます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// クライアント側の疑似コード
</span></span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>promise1</span> <span class=o>=</span> <span class=nx>rpc</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=s2>&#34;method1&#34;</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>promise2</span> <span class=o>=</span> <span class=nx>rpc</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=s2>&#34;method2&#34;</span><span class=p>,</span> <span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>promise3</span> <span class=o>=</span> <span class=nx>rpc</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=s2>&#34;method3&#34;</span><span class=p>,</span> <span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// レスポンスは順不同で返ってくる可能性がある
</span></span></span><span class=line><span class=cl><span class=c1>// IDがあることで正しく対応付けられる
</span></span></span></code></pre></td></tr></table></div></div><p>もしエラーレスポンスのIDが常にnullだったら、どのリクエストが失敗したのか判別できなくなってしまいます。</p><h3 id=トレーサビリティとデバッグ>トレーサビリティとデバッグ</h3><p>ログやモニタリングシステムでリクエスト-レスポンスのペアを追跡する際、IDは重要な役割を果たします。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[INFO] Request received: id=12345, method=getUserInfo
</span></span><span class=line><span class=cl>[ERROR] Method not found: id=12345
</span></span></code></pre></td></tr></table></div></div><p>IDが保持されていれば、ログを時系列で並べなくても、対応するリクエストとレスポンスを簡単に見つけられます。</p><h3 id=バッチリクエストでの識別>バッチリクエストでの識別</h3><p>JSON-RPC 2.0はバッチリクエスト（複数のリクエストを配列で一度に送信）をサポートしています。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span> <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;sum&#34;</span><span class=p>,</span> <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>4</span><span class=p>],</span> <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span> <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;subtract&#34;</span><span class=p>,</span> <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>42</span><span class=p>,</span><span class=mi>23</span><span class=p>],</span> <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span> <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;get_data&#34;</span><span class=p>,</span> <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;3&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>レスポンスもバッチで返ってきますが、IDがあることで、どのレスポンスがどのリクエストに対応するかが明確になります。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span> <span class=nt>&#34;result&#34;</span><span class=p>:</span> <span class=mi>7</span><span class=p>,</span> <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span> <span class=nt>&#34;result&#34;</span><span class=p>:</span> <span class=mi>19</span><span class=p>,</span> <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span> <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=mi>-32601</span><span class=p>,</span> <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Method not found&#34;</span><span class=p>},</span> <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;3&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=jsonrpcspecの修正内容>JSON::RPC::Specの修正内容</h2><p>私が作成した <code>JSON::RPC::Spec</code> では、エラー時に常にIDをnullにする実装になっていました。</p><h3 id=修正前のコード概念>修正前のコード（概念）</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># 誤った実装（概念）</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>create_error_response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=p>(</span><span class=nv>$error_code</span><span class=p>,</span> <span class=nv>$error_message</span><span class=p>)</span> <span class=o>=</span> <span class=nv>@_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=&gt;</span> <span class=nv>$error_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span> <span class=o>=&gt;</span> <span class=nv>$error_message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>id</span> <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>,</span>  <span class=c1># 常にnull（誤り）</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=修正後のコード概念>修正後のコード（概念）</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># 正しい実装（概念）</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>create_error_response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=p>(</span><span class=nv>$error_code</span><span class=p>,</span> <span class=nv>$error_message</span><span class=p>,</span> <span class=nv>$request_id</span><span class=p>)</span> <span class=o>=</span> <span class=nv>@_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=&gt;</span> <span class=nv>$error_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span> <span class=o>=&gt;</span> <span class=nv>$error_message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>id</span> <span class=o>=&gt;</span> <span class=nv>$request_id</span><span class=p>,</span>  <span class=c1># リクエストのIDを保持</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Parse ErrorやInvalid Requestの場合のみnullを渡す</span>
</span></span></code></pre></td></tr></table></div></div><p>修正版では、リクエストから取得したIDをそのままレスポンスに含めるようにしました。</p><p>当時、バッチリクエストに対応している実装が少ないと聞いていたため、バッチ対応を意識して実装したつもりでしたが、肝心の仕様を誤解していたのは皮肉なことです。</p><p>実装時に「なぜわざわざIDを消すんだろう？」と疑問に思っていたことを覚えています。今になって思えば、その直感は正しかったのです。</p><h2 id=他のrpcプロトコルとの比較>他のRPCプロトコルとの比較</h2><p>JSON-RPC 2.0のID必須仕様の特徴を理解するために、他のRPCプロトコルと比較してみましょう。</p><h3 id=rest-api>REST API</h3><p>RESTful APIは、HTTPのリクエスト-レスポンスモデルに依存しています。</p><p><strong>特徴：</strong></p><ul><li>同期的な通信が基本</li><li>TCPコネクション自体がリクエストとレスポンスの対応を保証</li><li>アプリケーションレベルでのID管理は不要</li></ul><p><strong>エラーハンドリング：</strong></p><ul><li>HTTPステータスコード（200, 404, 500など）に依存</li><li>エラー詳細はレスポンスボディで自由形式（標準化なし）</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>404</span> <span class=ne>Not Found</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;User not found&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=xml-rpc>XML-RPC</h3><p>JSON-RPCの前身とも言えるプロトコルです。</p><p><strong>特徴：</strong></p><ul><li>同期通信が前提</li><li>HTTPリクエスト-レスポンスの1対1対応のみ</li><li>ID管理の仕組みなし</li></ul><p><strong>エラーハンドリング：</strong></p><ul><li><code>faultCode</code>と<code>faultString</code>のみ</li><li>コードの標準化なし（実装依存）</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;methodResponse&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;fault&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;value&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;struct&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;member&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;name&gt;</span>faultCode<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;value&gt;&lt;int&gt;</span>4<span class=nt>&lt;/int&gt;&lt;/value&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/member&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;member&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;name&gt;</span>faultString<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;value&gt;&lt;string&gt;</span>Too many parameters.<span class=nt>&lt;/string&gt;&lt;/value&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/member&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/struct&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/value&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/fault&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/methodResponse&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=grpc>gRPC</h3><p>Googleが開発した高性能RPCフレームワークです。</p><p><strong>特徴：</strong></p><ul><li>HTTP/2ベースで双方向ストリーミング対応</li><li>ストリームIDをHTTP/2のフレームレベルで管理</li><li>アプリケーション層での明示的なID不要</li></ul><p><strong>エラーハンドリング：</strong></p><ul><li>16種類の標準ステータスコード（OK, CANCELLED, INVALID_ARGUMENT等）</li><li>詳細なメタデータとスタックトレース対応</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=c1>// gRPCのエラーは構造化されている
</span></span></span><span class=line><span class=cl><span class=k>rpc</span> <span class=n>GetUser</span><span class=p>(</span><span class=n>UserRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>UserResponse</span><span class=p>)</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl>  <span class=k>option</span> <span class=p>(</span><span class=n>google.api.http</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=n>get</span><span class=o>:</span> <span class=s>&#34;/v1/users/{user_id}&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl>  <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c1>// エラー時
</span></span></span><span class=line><span class=cl><span class=n>Status</span><span class=o>:</span> <span class=n>INVALID_ARGUMENT</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=n>Message</span><span class=o>:</span> <span class=s>&#34;Invalid user ID format&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=n>Details</span><span class=o>:</span> <span class=p>[</span><span class=n>additional</span> <span class=n>structured</span> <span class=n>data</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=比較表>比較表</h3><div class=table-wrapper><table><thead><tr><th>プロトコル</th><th>ID管理</th><th>多重化</th><th>バッチ処理</th><th>エラー標準化</th></tr></thead><tbody><tr><td>JSON-RPC 2.0</td><td>アプリケーション層で必須</td><td>✓</td><td>✓</td><td>✓（標準コード）</td></tr><tr><td>REST API</td><td>不要（HTTP依存）</td><td>×</td><td>△（実装依存）</td><td>△（HTTPステータス）</td></tr><tr><td>XML-RPC</td><td>なし</td><td>×</td><td>×</td><td>△（実装依存）</td></tr><tr><td>gRPC</td><td>HTTP/2層で管理</td><td>✓</td><td>△（ストリーム）</td><td>✓（16種類）</td></tr></tbody></table></div><h3 id=json-rpc-20の位置づけ>JSON-RPC 2.0の位置づけ</h3><p>JSON-RPC 2.0は、以下の点で独自の強みを持っています。</p><p><strong>1. シンプルさと柔軟性の両立</strong></p><ul><li>gRPCのようなProtocol Buffers不要</li><li>RESTよりも明確なメソッド呼び出し</li><li>様々なトランスポート層で利用可能（HTTP、WebSocket、TCP等）</li></ul><p><strong>2. 非同期通信への適性</strong></p><ul><li>WebSocketとの相性が良い</li><li>IDによる明確なリクエスト-レスポンス対応</li></ul><p><strong>3. 通知（Notification）のサポート</strong></p><ul><li>IDを省略することで、レスポンス不要な一方向通信も可能</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// 通知の例（IDなし）
</span></span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;notify_update&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;completed&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=実装時の注意点とベストプラクティス>実装時の注意点とベストプラクティス</h2><p>JSON-RPC 2.0を実装する際の注意点をまとめます。</p><h3 id=サーバー側の実装>サーバー側の実装</h3><p><strong>1. リクエストのIDを可能な限り保存する</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Node.jsでの実装例
</span></span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>handleRequest</span><span class=p>(</span><span class=nx>requestText</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>requestId</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>request</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>requestText</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// パース成功時点でIDを取得
</span></span></span><span class=line><span class=cl>    <span class=nx>requestId</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>id</span> <span class=o>!==</span> <span class=kc>undefined</span> <span class=o>?</span> <span class=nx>request</span><span class=p>.</span><span class=nx>id</span> <span class=o>:</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Parse Error
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>createErrorResponse</span><span class=p>(</span><span class=o>-</span><span class=mi>32700</span><span class=p>,</span> <span class=s2>&#34;Parse error&#34;</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// バリデーション
</span></span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>request</span><span class=p>.</span><span class=nx>jsonrpc</span> <span class=o>||</span> <span class=nx>request</span><span class=p>.</span><span class=nx>jsonrpc</span> <span class=o>!==</span> <span class=s2>&#34;2.0&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// IDが取得できていればそれを使う
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>createErrorResponse</span><span class=p>(</span><span class=o>-</span><span class=mi>32600</span><span class=p>,</span> <span class=s2>&#34;Invalid Request&#34;</span><span class=p>,</span> <span class=nx>requestId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 以降の処理でもrequestIdを保持し続ける
</span></span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>2. エラーコードの標準を守る</strong></p><p>JSON-RPC 2.0で定義されている標準エラーコード：</p><ul><li><code>-32700</code>: Parse error（JSONパース失敗）</li><li><code>-32600</code>: Invalid Request（不正なJSON-RPCリクエスト）</li><li><code>-32601</code>: Method not found（メソッドが存在しない）</li><li><code>-32602</code>: Invalid params（パラメータが不正）</li><li><code>-32603</code>: Internal error（サーバー内部エラー）</li><li><code>-32000</code>〜<code>-32099</code>: サーバー定義エラー（独自エラー用）</li></ul><p><strong>3. バッチリクエストへの適切な対応</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>handleBatchRequest</span><span class=p>(</span><span class=nx>requests</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>responses</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>request</span> <span class=k>of</span> <span class=nx>requests</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通知（IDなし）の場合はレスポンス不要
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>processNotification</span><span class=p>(</span><span class=nx>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 通常のリクエストはレスポンスを生成
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=nx>processRequest</span><span class=p>(</span><span class=nx>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>responses</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>response</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// レスポンスが0個の場合（全て通知）は何も返さない
</span></span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>responses</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=nx>responses</span> <span class=o>:</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=クライアント側の実装>クライアント側の実装</h3><p><strong>1. ユニークなIDの生成</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// シンプルなカウンター
</span></span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>requestId</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>generateId</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>++</span><span class=nx>requestId</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// またはUUID
</span></span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>v4</span> <span class=nx>as</span> <span class=nx>uuidv4</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;uuid&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>generateId</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>uuidv4</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>2. 非同期リクエストの管理</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>JsonRpcClient</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>url</span> <span class=o>=</span> <span class=nx>url</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pendingRequests</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>call</span><span class=p>(</span><span class=nx>method</span><span class=p>,</span> <span class=nx>params</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>id</span> <span class=o>=</span> <span class=nx>generateId</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>pendingRequests</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=p>{</span> <span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>request</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>jsonrpc</span><span class=o>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>method</span><span class=o>:</span> <span class=nx>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>params</span><span class=o>:</span> <span class=nx>params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=nx>id</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>request</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>handleResponse</span><span class=p>(</span><span class=nx>responseText</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>responseText</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>pending</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>pendingRequests</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>pending</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=sb>`Unexpected response with id: </span><span class=si>${</span><span class=nx>response</span><span class=p>.</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pendingRequests</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pending</span><span class=p>.</span><span class=nx>reject</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>error</span><span class=p>.</span><span class=nx>message</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pending</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>3. エラーIDがnullの場合の扱い</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>handleResponse</span><span class=p>(</span><span class=nx>responseText</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>responseText</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// IDがnullの場合は、特定のリクエストと対応付けできない
</span></span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=nx>response</span><span class=p>.</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Parse ErrorやInvalid Requestなど
</span></span></span><span class=line><span class=cl>    <span class=c1>// 全体的なエラーとして扱う
</span></span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;JSON-RPC protocol error:&#34;</span><span class=p>,</span> <span class=nx>response</span><span class=p>.</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 必要に応じて全てのpendingリクエストを拒否するなど
</span></span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 通常のID付きレスポンス処理
</span></span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=テストのポイント>テストのポイント</h3><p><strong>1. ID保持のテスト</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// テストケース例
</span></span></span><span class=line><span class=cl><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;should preserve request ID in error response&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>client</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=s1>&#39;nonexistent_method&#39;</span><span class=p>,</span> <span class=p>[],</span> <span class=p>{</span> <span class=nx>id</span><span class=o>:</span> <span class=mi>42</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>error</span><span class=p>).</span><span class=nx>toBeDefined</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>error</span><span class=p>.</span><span class=nx>code</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=o>-</span><span class=mi>32601</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=mi>42</span><span class=p>);</span>  <span class=c1>// IDが保持されていること
</span></span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>2. Parse Error時のnullテスト</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;should return null ID on parse error&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>invalidJson</span> <span class=o>=</span> <span class=s1>&#39;{invalid json}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>sendRawRequest</span><span class=p>(</span><span class=nx>invalidJson</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>error</span><span class=p>).</span><span class=nx>toBeDefined</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>error</span><span class=p>.</span><span class=nx>code</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=o>-</span><span class=mi>32700</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>toBeNull</span><span class=p>();</span>  <span class=c1>// IDがnullであること
</span></span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=まとめ>まとめ</h2><h3 id=idを可能な限り保持する設計の意義>IDを可能な限り保持する設計の意義</h3><p>JSON-RPC 2.0の「エラーレスポンスでもIDを可能な限り保持する」という仕様は、以下の利点をもたらします。</p><ol><li><strong>非同期通信での確実な対応付け</strong> - 複数の並列リクエストでも、どのレスポンスがどのリクエストに対応するか明確</li><li><strong>トレーサビリティの向上</strong> - ログやモニタリングでリクエスト-レスポンスペアを追跡しやすい</li><li><strong>バッチ処理の明確化</strong> - 複数リクエストの処理結果を正確に識別できる</li><li><strong>デバッグの容易さ</strong> - エラー発生時でも、どのリクエストが失敗したのかすぐわかる</li></ol><p>この設計思想は、非常に好感が持てるものです。</p><h3 id=8年の誤解から学んだこと>8年の誤解から学んだこと</h3><p>私は8年もの間、この仕様を誤解したまま実装を公開していました。幸い、<code>JSON::RPC::Spec</code>のバッチ処理機能を実際に使うことはありませんでしたが、もし本番環境で使われていたら、デバッグやトレースに大きな支障をきたしていたかもしれません。</p><p>今回の経験から学んだことは：</p><ul><li><strong>仕様書は丁寧に読む</strong> - MUSTとSHOULDの違い、条件節の適用範囲を正確に理解する</li><li><strong>違和感は大切に</strong> - 実装時に感じた「なぜ？」という疑問は、立ち止まって考える価値がある</li><li><strong>定期的な見直し</strong> - たとえ公開済みのコードでも、機会があれば仕様を再確認する</li></ul><h3 id=これからjson-rpcを使う方へ>これからJSON-RPCを使う方へ</h3><p>JSON-RPC 2.0は、シンプルでありながら非同期通信やバッチ処理を想定した堅牢な仕様です。特にWebSocketを使ったリアルタイム通信や、マイクロサービス間のRPCには適しています。</p><p>実装する際は、今回解説した「IDを可能な限り保持する」という基本原則を理解した上で、以下の公式仕様を参照してください。</p><link rel=stylesheet href=/css/linkcard.css><div class=linkcard><a class=linkcard-a href=https://www.jsonrpc.org/specification target=_blank rel="noopener noreferrer"><div class=linkcard-content><div class=linkcard-title>https://www.jsonrpc.org/specification</div><div class=linkcard-meta><img class=linkcard-favicon src=https://www.jsonrpc.org/favicon.ico alt onerror='this.style.display="none"'>
<span class=linkcard-domain>www.jsonrpc.org</span></div></div></a></div><p>そして、私と同じような誤解をしないよう、特にエラーハンドリング部分は注意深く実装してください。</p><hr><p><strong>追記</strong>: <code>JSON::RPC::Spec</code>の修正版は、CPANで公開されています。8年ぶりの更新となりましたが、より仕様に忠実な実装になりました。Perlを使っている方は、ぜひ活用してください。</p><link rel=stylesheet href=/css/linkcard.css><div class=linkcard><a class=linkcard-a href=https://metacpan.org/pod/JSON::RPC::Spec target=_blank rel="noopener noreferrer"><div class=linkcard-image><img src=https://metacpan.org/static/images/dots.png alt=JSON::RPC::Spec loading=lazy></div><div class=linkcard-content><div class=linkcard-title>JSON::RPC::Spec</div><div class=linkcard-description>Yet another JSON-RPC 2.0 Implementation</div><div class=linkcard-meta><img class=linkcard-favicon src=https://metacpan.org/favicon.ico alt onerror='this.style.display="none"'>
<span class=linkcard-domain>MetaCPAN</span></div></div></a></div></section><footer class=article-footer><section class=article-tags><a href=/tags/json-rpc/>Json-Rpc</a>
<a href=/tags/rpc/>Rpc</a>
<a href=/tags/api-design/>Api-Design</a>
<a href=/tags/perl/>Perl</a>
<a href=/tags/protocol/>Protocol</a>
<a href=/tags/error-handling/>Error-Handling</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>関連するコンテンツ</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/2025/12/21/234500/><div class=article-image><img src=/public_images/2025/perl-tdd-series-image.jpg loading=lazy data-key data-hash=/public_images/2025/perl-tdd-series-image.jpg></div><div class=article-details><h2 class=article-title>JSON-RPC 2.0仕様から学ぶ値オブジェクト設計【Perl実装】仕様書の読み方とTDD</h2></div></a></article><article class=has-image><a href=/2025/12/25/000000/><div class=article-image><img src=/public_images/2025/1766588400-image.jpg loading=lazy data-key data-hash=/public_images/2025/1766588400-image.jpg></div><div class=article-details><h2 class=article-title>Perl Advent Calendar 2025 完走！- 振り返りとこれから</h2></div></a></article><article class=has-image><a href=/2025/12/24/000000/><div class=article-image><img src=/public_images/2025/20251224000000-image.jpg loading=lazy data-key data-hash=/public_images/2025/20251224000000-image.jpg></div><div class=article-details><h2 class=article-title>Perlの歴史とコミュニティ - YAPC, Kansai.pm, そしてこれから</h2></div></a></article><article class=has-image><a href=/2025/12/23/234500/><div class=article-image><img src=/public_images/2025/perl-tdd-series-image.jpg loading=lazy data-key data-hash=/public_images/2025/perl-tdd-series-image.jpg></div><div class=article-details><h2 class=article-title>PerlのTest2でTDD実践 - 値オブジェクトのテスト戦略とRed-Green-Refactor完全ガイド</h2></div></a></article><article class=has-image><a href=/2025/12/23/000000/><div class=article-image><img src=/public_images/2025/20251223000000-image.jpg loading=lazy data-key data-hash=/public_images/2025/20251223000000-image.jpg></div><div class=article-details><h2 class=article-title>Perlでの設定ファイル管理 - Config::* モジュール</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//nqounet.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2000 -
2025 nqou.net</section><section class=powerby><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> で構築されています。<br>テーマ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> は <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> によって設計されています。</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>