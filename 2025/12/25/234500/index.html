<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="PerlでJSON-RPC 2.0のRequest/Responseを複合値オブジェクトとして実装。Type::TinyのMaybe型とInstanceOf、from_hashファクトリーメソッドによる実践的なTDD開発手法を解説。"><title>JSON-RPC Request/Response実装 - 複合値オブジェクト設計【Perl×TDD】</title><link rel=canonical href=https://www.nqou.net/2025/12/25/234500/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="JSON-RPC Request/Response実装 - 複合値オブジェクト設計【Perl×TDD】"><meta property='og:description' content="PerlでJSON-RPC 2.0のRequest/Responseを複合値オブジェクトとして実装。Type::TinyのMaybe型とInstanceOf、from_hashファクトリーメソッドによる実践的なTDD開発手法を解説。"><meta property='og:url' content='https://www.nqou.net/2025/12/25/234500/'><meta property='og:site_name' content='設計パターンを疑え'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='json-rpc'><meta property='article:tag' content='perl'><meta property='article:tag' content='tdd'><meta property='article:tag' content='type-tiny'><meta property='article:tag' content='value-object'><meta property='article:tag' content='moo'><meta property='article:published_time' content='2025-12-25T23:45:00+09:00'><meta property='article:modified_time' content='2025-12-25T23:45:00+09:00'><meta property='og:image' content='https://www.nqou.net/public_images/2025/perl-tdd-series-image.jpg'><meta name=twitter:title content="JSON-RPC Request/Response実装 - 複合値オブジェクト設計【Perl×TDD】"><meta name=twitter:description content="PerlでJSON-RPC 2.0のRequest/Responseを複合値オブジェクトとして実装。Type::TinyのMaybe型とInstanceOf、from_hashファクトリーメソッドによる実践的なTDD開発手法を解説。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://www.nqou.net/public_images/2025/perl-tdd-series-image.jpg'><link rel="shortcut icon" href=/favicon.png><style>@import 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap';:root{--base-font-family:Arial, "Noto Sans JP", sans-serif}</style><link rel=stylesheet href=/css/linkcard.css><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3923446804785015" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js defer></script><script defer>document.addEventListener("DOMContentLoaded",function(){try{typeof mermaid!="undefined"&&document.querySelector(".mermaid")&&mermaid.initialize({startOnLoad:!0,securityLevel:"strict"})}catch(e){console.warn("Mermaid failed to initialize:",e)}})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-E50H9ESN7E"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E50H9ESN7E")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=メニューを開く・閉じる>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/public_images/blog-nqounet-square.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>設計パターンを疑え</a></h1><h2 class=site-description>名前の嘘を暴き、意図で設計を語る</h2></div></header><ol class=menu-social><li><a href=https://github.com/nqounet target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/nqounet target=_blank title=X rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/advent-calendar-2025/><svg class="icon icon-tabler icon-tabler-calendar" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="5" width="16" height="16" rx="2"/><line x1="16" y1="3" x2="16" y2="7"/><line x1="8" y1="3" x2="8" y2="7"/><line x1="4" y1="11" x2="20" y2="11"/><path d="M8 15h.01"/><path d="M12 15h.01"/><path d="M16 15h.01"/><path d="M8 19h.01"/><path d="M12 19h.01"/><path d="M16 19h.01"/></svg>
<span>Perl Advent Calendar 2025 - AI Edition</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/warehouse/><svg class="icon icon-tabler icon-tabler-warehouse" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#bababa" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10l9-6 9 6"/><rect x="5" y="10" width="14" height="10" rx="2"/><rect x="10" y="14" width="4" height="6" rx="1"/><path d="M7 20v-4h2v4"/><path d="M15 20v-4h2v4"/></svg>
<span>Warehouse</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>ダークモード</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目次</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#この記事で学べること>この記事で学べること</a></li><li><a href=#複合値オブジェクトとは---json-rpcを題材に理解する>複合値オブジェクトとは - JSON-RPCを題材に理解する</a><ol><li><a href=#単純な値オブジェクトと複合値オブジェクトの違い>単純な値オブジェクトと複合値オブジェクトの違い</a></li><li><a href=#値オブジェクトのネスト構造>値オブジェクトのネスト構造</a></li></ol></li><li><a href=#typetinyによる型制約の実践---perlに型安全性をもたらす>Type::Tinyによる型制約の実践 - Perlに型安全性をもたらす</a><ol><li><a href=#typetinyの基本型>Type::Tinyの基本型</a></li><li><a href=#typetinyのインストール>Type::Tinyのインストール</a></li><li><a href=#maybe型でオプショナルフィールドを表現する---json-rpc仕様の実装>Maybe型でオプショナルフィールドを表現する - JSON-RPC仕様の実装</a></li></ol></li><li><a href=#jsonrpcrequest値オブジェクトのtdd実装>JsonRpc::Request値オブジェクトのTDD実装</a><ol><li><a href=#json-rpc-20-request仕様の確認>JSON-RPC 2.0 Request仕様の確認</a></li><li><a href=#red---失敗するテストを書く>Red - 失敗するテストを書く</a></li><li><a href=#green---最小実装で通す>Green - 最小実装で通す</a></li><li><a href=#refactor---しなくても良い>Refactor - しなくても良い</a></li><li><a href=#red---from_hash-のテスト追加>Red - from_hash のテスト追加</a></li><li><a href=#green---from_hash-を実装する>Green - from_hash を実装する</a></li><li><a href=#使ってみよう>使ってみよう！</a></li><li><a href=#ここで重要な仕様が追加されます>ここで重要な仕様が追加されます</a></li><li><a href=#red---リクエストに-id-が含まれない場合は-notification>Red - リクエストに id が含まれない場合は Notification</a></li><li><a href=#green---テストを満たす最小限の実装>Green - テストを満たす最小限の実装</a></li><li><a href=#refactor---重複を取り除く>Refactor - 重複を取り除く</a></li></ol></li><li><a href=#jsonrpcresponse値オブジェクトのtdd実装>JsonRpc::Response値オブジェクトのTDD実装</a><ol><li><a href=#json-rpc-20-response仕様の確認>JSON-RPC 2.0 Response仕様の確認</a></li><li><a href=#red---responseのテストを書く>Red - Responseのテストを書く</a></li><li><a href=#green---response実装>Green - Response実装</a></li></ol></li><li><a href=#複合値オブジェクトのファクトリーパターン---生成方法の比較>複合値オブジェクトのファクトリーパターン - 生成方法の比較</a><ol><li><a href=#コンストラクタによる直接生成>コンストラクタによる直接生成</a></li><li><a href=#ファクトリーメソッドパターン>ファクトリーメソッドパターン</a></li><li><a href=#ビルダーパターン応用>ビルダーパターン（応用）</a></li></ol></li><li><a href=#複合値オブジェクトのメリット再確認---json-rpc実装から学ぶ>複合値オブジェクトのメリット再確認 - JSON-RPC実装から学ぶ</a><ol><li><a href=#型安全性>型安全性</a></li><li><a href=#自己文書化>自己文書化</a></li><li><a href=#リファクタリングの安全性>リファクタリングの安全性</a></li><li><a href=#テストの容易さ>テストの容易さ</a></li></ol></li><li><a href=#まとめと次回予告>まとめと次回予告</a><ol><li><a href=#この記事で学んだこと---json-rpc実装で習得した技術>この記事で学んだこと - JSON-RPC実装で習得した技術</a></li><li><a href=#複合値オブジェクトの実装指針---ベストプラクティス>複合値オブジェクトの実装指針 - ベストプラクティス</a></li><li><a href=#次回予告---エラー処理と境界値テストシリーズ完結編>次回予告 - エラー処理と境界値テスト（シリーズ完結編）</a></li></ol></li><li><a href=#参考リンク>参考リンク</a></li><li><a href=#シリーズ記事一覧>シリーズ記事一覧</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/2025/12/25/234500/><img src=/public_images/2025/perl-tdd-series-image.jpg loading=lazy alt="Featured image of post JSON-RPC Request/Response実装 - 複合値オブジェクト設計【Perl×TDD】"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2025/12/25/234500/>JSON-RPC Request/Response実装 - 複合値オブジェクト設計【Perl×TDD】</a></h2><h3 class=article-subtitle>PerlでJSON-RPC 2.0のRequest/Responseを複合値オブジェクトとして実装。Type::TinyのMaybe型とInstanceOf、from_hashファクトリーメソッドによる実践的なTDD開発手法を解説。</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>12月 25, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>読了時間: 23分</time></div></footer></div></header><section class=article-content><p>この記事は「<strong>Perlで値オブジェクトを使ってテスト駆動開発してみよう</strong>」シリーズの**第4回（全5回）**です。前回は、<a class=link href=/2025/12/23/234500/>Test2によるTDD実践とMethodName値オブジェクト</a>の実装を通じて、Red-Green-Refactorサイクルを体験しました。今回は、<strong>複数の値オブジェクトを組み合わせた複合的な値オブジェクト</strong>として、JSON-RPC 2.0のRequestとResponseを完全実装します。</p><h2 id=この記事で学べること>この記事で学べること</h2><ul><li><strong>複合値オブジェクトの設計</strong>: 単純な値オブジェクトを組み合わせた設計パターン</li><li><strong>Type::Tinyの実践活用</strong>: Maybe、ArrayRef、HashRef、InstanceOfなどの型制約</li><li><strong>TDDで進める複雑な実装</strong>: 必須/オプションフィールドのテスト戦略</li><li><strong>ファクトリーメソッドパターン</strong>: from_hashによるJSON→オブジェクト変換の実装</li><li><strong>JSON-RPC 2.0仕様の実装</strong>: Request/Responseオブジェクトの完全実装</li></ul><h2 id=複合値オブジェクトとは---json-rpcを題材に理解する>複合値オブジェクトとは - JSON-RPCを題材に理解する</h2><h3 id=単純な値オブジェクトと複合値オブジェクトの違い>単純な値オブジェクトと複合値オブジェクトの違い</h3><p>これまで実装してきたのは<strong>単純な値オブジェクト</strong>です。これらは、単一のプリミティブ型（文字列や数値）をラップしたものです。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># 単純な値オブジェクト - 文字列をラップ</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::MethodName</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>value</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span> <span class=o>...</span> <span class=p>},</span>  <span class=c1># 文字列のバリデーション</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>一方、<strong>複合値オブジェクト</strong>（Composite Value Object）は、複数のフィールドを持ち、それぞれが独自の値オブジェクトや型制約を持ちます。JSON-RPC 2.0のRequest/Responseオブジェクトは、この複合値オブジェクトの典型例です。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># 複合的な値オブジェクト - 複数フィールドと値オブジェクトを組み合わせ</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::Request</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>InstanceOf</span><span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>method</span>  <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>InstanceOf</span><span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>ArrayRef</span><span class=o>|</span><span class=n>HashRef</span><span class=p>]);</span>  <span class=c1># オプション</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>id</span>      <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>Str</span><span class=o>|</span><span class=n>Int</span><span class=p>]);</span>           <span class=c1># オプション</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=値オブジェクトのネスト構造>値オブジェクトのネスト構造</h3><p>JSON-RPC Requestオブジェクトは以下のような階層構造を持ちます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>JsonRpc::Request
</span></span><span class=line><span class=cl>├── jsonrpc: JsonRpc::Version (値オブジェクト)
</span></span><span class=line><span class=cl>├── method:  JsonRpc::MethodName (値オブジェクト)
</span></span><span class=line><span class=cl>├── params:  ArrayRef | HashRef | undef (オプション)
</span></span><span class=line><span class=cl>└── id:      Str | Int | undef (オプション)
</span></span></code></pre></td></tr></table></div></div><p>このように、<strong>値オブジェクトが他の値オブジェクトを含む</strong>構造を、複合値オブジェクトと呼びます。JSON-RPCの実装において、この構造は以下のメリットをもたらします。</p><ul><li><strong>責任の分離</strong>: 各値オブジェクトが独自のバリデーションを担当</li><li><strong>再利用性</strong>: JsonRpc::VersionやMethodNameは他のコンテキストでも使える</li><li><strong>型安全性</strong>: Type::Tinyによる厳密な型チェック</li><li><strong>保守性</strong>: 変更箇所が局所化され、影響範囲が限定される</li></ul><h2 id=typetinyによる型制約の実践---perlに型安全性をもたらす>Type::Tinyによる型制約の実践 - Perlに型安全性をもたらす</h2><p>Type::Tinyは、Perlに強力な型システムを導入するモジュールであり、JSON-RPCのRequestやResponseのような複合値オブジェクトの実装には不可欠なツールです。TDDにおいて、Type::Tinyの型制約は「実行可能な仕様書」として機能します。</p><h3 id=typetinyの基本型>Type::Tinyの基本型</h3><p>Type::Tiny とは言っていますが、実際に使うのはバンドルされている Types::Standard がメインになるでしょう。Type::Tiny をインストールすれば使用できるようになります。</p><p>Types::Standard はよく使用される型が定義されています。<code>isa</code>にその型を指定することでPerlでも型の制約をつけることができます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>use</span> <span class=nn>Types::Standard</span> <span class=sx>qw(
</span></span></span><span class=line><span class=cl><span class=sx>    Str Int Num Bool
</span></span></span><span class=line><span class=cl><span class=sx>    ArrayRef HashRef Maybe
</span></span></span><span class=line><span class=cl><span class=sx>    InstanceOf Enum Any
</span></span></span><span class=line><span class=cl><span class=sx>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 基本型</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>name</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Str</span><span class=p>);</span>           <span class=c1># 文字列</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>age</span>  <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Int</span><span class=p>);</span>           <span class=c1># 整数</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>rate</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Num</span><span class=p>);</span>           <span class=c1># 数値（小数含む）</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>flag</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Bool</span><span class=p>);</span>          <span class=c1># 真偽値</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 参照型</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>items</span>  <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>ArrayRef</span><span class=p>);</span>        <span class=c1># 配列リファレンス</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>config</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>HashRef</span><span class=p>);</span>         <span class=c1># ハッシュリファレンス</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 型パラメータ付き</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>numbers</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>ArrayRef</span><span class=p>[</span><span class=n>Int</span><span class=p>]);</span>  <span class=c1># 整数の配列</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>mapping</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>HashRef</span><span class=p>[</span><span class=n>Str</span><span class=p>]);</span>   <span class=c1># 文字列のハッシュ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># オブジェクト型</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>version</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>InstanceOf</span><span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># オプショナル（Maybe）</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>optional_name</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span> <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>Str</span><span class=p>]);</span>  <span class=c1># Str または undef</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=typetinyのインストール>Type::Tinyのインストール</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># CPANからインストール</span>
</span></span><span class=line><span class=cl>cpanm Type::Tiny
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># または cpan コマンド</span>
</span></span><span class=line><span class=cl>cpan Type::Tiny
</span></span></code></pre></td></tr></table></div></div><h3 id=maybe型でオプショナルフィールドを表現する---json-rpc仕様の実装>Maybe型でオプショナルフィールドを表現する - JSON-RPC仕様の実装</h3><p>JSON-RPC 2.0仕様では、<code>params</code>と<code>id</code>はオプショナルフィールドです。PerlでこれをType::Tinyの<code>Maybe</code>型で厳密に表現します。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>use</span> <span class=nn>Types::Standard</span> <span class=sx>qw(Maybe Str Int ArrayRef HashRef)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Maybe[型] は「型 または undef」を意味する</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>params</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>ArrayRef</span> <span class=o>|</span> <span class=n>HashRef</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>Str</span> <span class=o>|</span> <span class=n>Int</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用例</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$req1</span> <span class=o>=</span> <span class=nn>Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span>   <span class=c1># ArrayRef - OK</span>
</span></span><span class=line><span class=cl>    <span class=n>id</span>      <span class=o>=&gt;</span> <span class=s>&#34;req-123&#34;</span><span class=p>,</span>   <span class=c1># Str - OK</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$req2</span> <span class=o>=</span> <span class=nn>Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span>  <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>,</span>       <span class=c1># Maybe[...] なので undef OK</span>
</span></span><span class=line><span class=cl>    <span class=n>id</span>      <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>,</span>       <span class=c1># Maybe[...] なので undef OK</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$req3</span> <span class=o>=</span> <span class=nn>Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># params と id は省略可能（自動的に undef）</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=jsonrpcrequest値オブジェクトのtdd実装>JsonRpc::Request値オブジェクトのTDD実装</h2><p>それでは、TDDでJSON-RPC 2.0のRequest値オブジェクトを実装していきましょう。前回学んだRed-Green-Refactorサイクルを適用し、複合値オブジェクトならではのテスト戦略を実践します。</p><h3 id=json-rpc-20-request仕様の確認>JSON-RPC 2.0 Request仕様の確認</h3><p>まず、<a class=link href=https://www.jsonrpc.org/specification target=_blank rel=noopener>JSON-RPC 2.0仕様書</a>を確認します。Request objectは以下のフィールドを持ちます。</p><div class=table-wrapper><table><thead><tr><th>フィールド</th><th>型</th><th>必須/オプション</th><th>説明</th></tr></thead><tbody><tr><td>jsonrpc</td><td>String</td><td>必須</td><td>&ldquo;2.0&rdquo; 固定</td></tr><tr><td>method</td><td>String</td><td>必須</td><td>呼び出すメソッド名</td></tr><tr><td>params</td><td>Array or Object</td><td>オプション</td><td>メソッドのパラメータ</td></tr><tr><td>id</td><td>String, Number, Null</td><td>オプション</td><td>リクエストID（通知の場合は省略）</td></tr></tbody></table></div><div class=linkcard><a class=linkcard-a href=https://www.jsonrpc.org/specification target=_blank rel="noopener noreferrer nofollow" title=https://www.jsonrpc.org/specification aria-label=https://www.jsonrpc.org/specification><div class=linkcard-content><div class=linkcard-title>https://www.jsonrpc.org/specification</div><div class=linkcard-meta><img class=linkcard-favicon src=https://www.jsonrpc.org/favicon.ico alt onerror='this.style.display="none"'><span class=linkcard-domain>www.jsonrpc.org</span></div></div></a></div><h3 id=red---失敗するテストを書く>Red - 失敗するテストを書く</h3><p>では、Requestのテストを書きます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># t/request.t</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Test2::V0</span> <span class=o>-</span><span class=n>target</span> <span class=o>=&gt;</span> <span class=s>&#39;JsonRpc::Request&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::MethodName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor with required fields only&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;getUser&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=nv>$req</span><span class=p>,</span> <span class=s>&#39;Request created with required fields&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>jsonrpc</span><span class=p>,</span> <span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>method</span><span class=p>,</span>  <span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span> <span class=nb>undef</span><span class=p>,</span> <span class=s>&#39;params is undef by default&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>,</span>     <span class=nb>undef</span><span class=p>,</span> <span class=s>&#39;id is undef by default&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor with all fields&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;createUser&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>{</span> <span class=n>name</span> <span class=o>=&gt;</span> <span class=s>&#39;Alice&#39;</span><span class=p>,</span> <span class=n>age</span> <span class=o>=&gt;</span> <span class=mi>30</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>id</span>      <span class=o>=&gt;</span> <span class=s>&#39;req-001&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=nv>$req</span><span class=p>,</span> <span class=s>&#39;Request created with all fields&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span> <span class=p>{</span> <span class=n>name</span> <span class=o>=&gt;</span> <span class=s>&#39;Alice&#39;</span><span class=p>,</span> <span class=n>age</span> <span class=o>=&gt;</span> <span class=mi>30</span> <span class=p>},</span> <span class=s>&#39;params is hash&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>,</span> <span class=s>&#39;req-001&#39;</span><span class=p>,</span> <span class=s>&#39;id is string&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor rejects invalid jsonrpc&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#34;not a Version object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;test&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=sx>qr/type constraint|isa/</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;rejects non-Version jsonrpc&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor rejects invalid method&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=s>&#34;not a MethodName object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=sx>qr/type constraint|isa/</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;rejects non-MethodName method&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;params accepts array or hash or undef&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$version</span> <span class=o>=</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$method</span>  <span class=o>=</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;test&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># ArrayRef</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;params accepts ArrayRef&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># HashRef</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>{</span> <span class=n>key</span> <span class=o>=&gt;</span> <span class=s>&#39;value&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;params accepts HashRef&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># undef</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span>  <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;params accepts undef&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># String は拒否</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span><span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span>  <span class=o>=&gt;</span> <span class=s>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=sx>qr/type constraint/</span><span class=n>i</span><span class=p>,</span> <span class=s>&#39;params rejects string&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;id accepts string, int, or undef&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$version</span> <span class=o>=</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$method</span>  <span class=o>=</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;test&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=s>&#39;str-id&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;id accepts string&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=mi>123</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;id accepts integer&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;id accepts undef&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span><span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=o>[]</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=sx>qr/type constraint/</span><span class=n>i</span><span class=p>,</span> <span class=s>&#39;id rejects array reference&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>done_testing</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>テストを実行すると、当然失敗します（Red）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ prove -lv t/request.t
</span></span><span class=line><span class=cl>Can<span class=err>&#39;</span>t locate JsonRpc/Request.pm in @INC
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><h3 id=green---最小実装で通す>Green - 最小実装で通す</h3><p>次に、テストを通すための実装を書きます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># lib/JsonRpc/Request.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::Request</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Types::Standard</span> <span class=sx>qw(InstanceOf Maybe ArrayRef HashRef Str Int)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>namespace::clean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span><span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span><span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>params</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>ArrayRef</span> <span class=o>|</span> <span class=n>HashRef</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>Str</span> <span class=o>|</span> <span class=n>Int</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>__END__
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=head1 NAME
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>JsonRpc::Request - JSON-RPC 2.0 Request object
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=head1 SYNOPSIS
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>    use JsonRpc::Request;
</span></span></span><span class=line><span class=cl><span class=cp>    use JsonRpc::Version;
</span></span></span><span class=line><span class=cl><span class=cp>    use JsonRpc::MethodName;
</span></span></span><span class=line><span class=cl><span class=cp>    
</span></span></span><span class=line><span class=cl><span class=cp>    my $req = JsonRpc::Request-&gt;new(
</span></span></span><span class=line><span class=cl><span class=cp>        jsonrpc =&gt; JsonRpc::Version-&gt;new(value =&gt; &#39;2.0&#39;),
</span></span></span><span class=line><span class=cl><span class=cp>        method  =&gt; JsonRpc::MethodName-&gt;new(value =&gt; &#39;getUser&#39;),
</span></span></span><span class=line><span class=cl><span class=cp>        params  =&gt; { user_id =&gt; 42 },
</span></span></span><span class=line><span class=cl><span class=cp>        id      =&gt; &#39;req-123&#39;,
</span></span></span><span class=line><span class=cl><span class=cp>    );
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=head1 DESCRIPTION
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>Represents a JSON-RPC 2.0 Request object with validation.
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=cut
</span></span></span></code></pre></td></tr></table></div></div><p>テストを再実行すると、すべて成功するでしょう（Green）！</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>prove</span> <span class=o>-</span><span class=n>lv</span> <span class=n>t</span><span class=o>/</span><span class=n>request</span><span class=o>.</span><span class=n>t</span>
</span></span><span class=line><span class=cl><span class=n>ok</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>constructor</span> <span class=n>with</span> <span class=n>required</span> <span class=n>fields</span> <span class=n>only</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>Request</span> <span class=n>created</span> <span class=n>with</span> <span class=n>required</span> <span class=n>fields</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=mi>2</span> <span class=o>-</span> <span class=n>JsonRpc</span><span class=p>::</span><span class=n>Version</span><span class=o>=</span><span class=n>HASH</span><span class=o>-&gt;</span><span class=n>isa</span><span class=p>(</span><span class=s1>&#39;JsonRpc::Version&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=mi>3</span> <span class=o>-</span> <span class=n>JsonRpc</span><span class=p>::</span><span class=n>MethodName</span><span class=o>=</span><span class=n>HASH</span><span class=o>-&gt;</span><span class=n>isa</span><span class=p>(</span><span class=s1>&#39;JsonRpc::MethodName&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=mi>4</span> <span class=o>-</span> <span class=n>params</span> <span class=n>is</span> <span class=n>undef</span> <span class=n>by</span> <span class=n>default</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=mi>5</span> <span class=o>-</span> <span class=n>id</span> <span class=n>is</span> <span class=n>undef</span> <span class=n>by</span> <span class=n>default</span>
</span></span><span class=line><span class=cl>    <span class=mf>1.</span><span class=o>.</span><span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>All</span> <span class=n>tests</span> <span class=n>successful</span><span class=o>.</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=refactor---しなくても良い>Refactor - しなくても良い</h3><p>Red Green Refactorのサイクルですが、リファクタリング不要であればスキップしても問題ありません。</p><p>今回はスキップして、次の仕様を書きます。</p><h3 id=red---from_hash-のテスト追加>Red - from_hash のテスト追加</h3><p>実際のJSON-RPCアプリケーションでは、JSONをデコードした結果（ハッシュリファレンス）から直接Requestオブジェクトを生成することになります。ハッシュリファレンスからオブジェクトを生成する <code>from_hash</code> メソッドを追加することにします。どのような動作になるかを検討しながら書いていきます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># t/request.t に追加</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;from_hash factory method&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>subtest</span> <span class=s>&#39;creates request from hash&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=n>from_hash</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>method</span>  <span class=o>=&gt;</span> <span class=s>&#39;getUser&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>{</span> <span class=n>user_id</span> <span class=o>=&gt;</span> <span class=mi>42</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>id</span>      <span class=o>=&gt;</span> <span class=s>&#39;req-001&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>isa_ok</span> <span class=nv>$req</span><span class=p>,[</span><span class=s>&#39;JsonRpc::Request&#39;</span><span class=p>],</span> <span class=s>&#39;is a JsonRpc::Request&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=nn>jsonrpc</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>,</span> <span class=s>&#39;2.0&#39;</span><span class=p>,</span> <span class=s>&#39;jsonrpc is correct&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=nn>method</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>,</span> <span class=s>&#39;getUser&#39;</span><span class=p>,</span> <span class=s>&#39;method is correct&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span> <span class=p>{</span> <span class=n>user_id</span> <span class=o>=&gt;</span> <span class=mi>42</span> <span class=p>},</span> <span class=s>&#39;params is correct&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>,</span> <span class=s>&#39;req-001&#39;</span><span class=p>,</span> <span class=s>&#39;id is correct&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>subtest</span> <span class=s>&#39;from_hash rejects missing required fields&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>like</span><span class=p>(</span><span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=n>from_hash</span><span class=p>({</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=s>&#39;test&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=sx>qr/missing.*jsonrpc/</span><span class=n>i</span><span class=p>,</span> <span class=s>&#39;missing jsonrpc rejected&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>like</span><span class=p>(</span><span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=n>from_hash</span><span class=p>({</span> <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=sx>qr/missing.*method/</span><span class=n>i</span><span class=p>,</span> <span class=s>&#39;missing method rejected&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>subtest</span> <span class=s>&#39;from_hash rejects non-hash&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>like</span><span class=p>(</span><span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=n>from_hash</span><span class=p>(</span><span class=s>&#34;not a hash&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=sx>qr/hash reference/</span><span class=n>i</span><span class=p>,</span> <span class=s>&#39;string rejected&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>like</span><span class=p>(</span><span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=n>from_hash</span><span class=p>(</span><span class=o>[]</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=sx>qr/hash reference/</span><span class=n>i</span><span class=p>,</span> <span class=s>&#39;array rejected&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=green---from_hash-を実装する>Green - from_hash を実装する</h3><p>では、Greenにするために<code>from_hash</code>メソッドを追加します。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># lib/JsonRpc/Request.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::Request</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Types::Standard</span> <span class=sx>qw(InstanceOf Maybe ArrayRef HashRef Str Int)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::MethodName</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>namespace::clean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span><span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span><span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>params</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>ArrayRef</span> <span class=o>|</span> <span class=n>HashRef</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>Str</span> <span class=o>|</span> <span class=n>Int</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ファクトリーメソッド: HashRef から Request を生成</span>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>from_hash</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=p>(</span><span class=nv>$class</span><span class=p>,</span> <span class=nv>$hash</span><span class=p>)</span> <span class=o>=</span> <span class=nv>@_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>die</span> <span class=s>&#34;from_hash requires a hash reference&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>unless</span> <span class=nb>ref</span> <span class=nv>$hash</span> <span class=ow>eq</span> <span class=s>&#39;HASH&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 必須フィールドの存在チェック</span>
</span></span><span class=line><span class=cl>    <span class=nb>die</span> <span class=s>&#34;missing required field: jsonrpc&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>unless</span> <span class=nb>exists</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>jsonrpc</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nb>die</span> <span class=s>&#34;missing required field: method&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>unless</span> <span class=nb>exists</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>method</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$class</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>jsonrpc</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>method</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nb>exists</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>params</span><span class=p>}</span> <span class=p>?</span> <span class=p>(</span><span class=n>params</span> <span class=o>=&gt;</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>params</span><span class=p>})</span> <span class=p>:</span> <span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nb>exists</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>id</span><span class=p>}</span>     <span class=p>?</span> <span class=p>(</span><span class=n>id</span>     <span class=o>=&gt;</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>id</span><span class=p>})</span>     <span class=p>:</span> <span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>__END__
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=head1 METHODS
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=head2 from_hash
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>Creates a Request object from a hash reference (typically from decoded JSON).
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>    my $req = JsonRpc::Request-&gt;from_hash({
</span></span></span><span class=line><span class=cl><span class=cp>        jsonrpc =&gt; &#39;2.0&#39;,
</span></span></span><span class=line><span class=cl><span class=cp>        method  =&gt; &#39;getUser&#39;,
</span></span></span><span class=line><span class=cl><span class=cp>        params  =&gt; { user_id =&gt; 42 },
</span></span></span><span class=line><span class=cl><span class=cp>        id      =&gt; &#39;req-123&#39;,
</span></span></span><span class=line><span class=cl><span class=cp>    });
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=cut
</span></span></span></code></pre></td></tr></table></div></div><p>テストを実行して、Greenになるのを確認しましょう。</p><h3 id=使ってみよう>使ってみよう！</h3><p>これで、JSON文字列からJsonRpc::Requestオブジェクトを生成できるようになりました！</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>use</span> <span class=nn>JSON::MaybeXS</span> <span class=sx>qw(decode_json encode_json)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># JSON文字列 → Request オブジェクト</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$json</span> <span class=o>=</span> <span class=s>&#39;{&#34;jsonrpc&#34;:&#34;2.0&#34;,&#34;method&#34;:&#34;getUser&#34;,&#34;id&#34;:1}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$hash</span> <span class=o>=</span> <span class=n>decode_json</span><span class=p>(</span><span class=nv>$json</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$req</span>  <span class=o>=</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=n>from_hash</span><span class=p>(</span><span class=nv>$hash</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ここで重要な仕様が追加されます>ここで重要な仕様が追加されます</h3><p>さて、ここで仕様が追加されます！（という体でお願いします）</p><p>JSON-RPC 2.0には、 <code>Notification</code> という仕様があります。</p><blockquote><p>A Notification is a Request object without an &ldquo;id&rdquo; member. A Request object that is a Notification signifies the Client&rsquo;s lack of interest in the corresponding Response object, and as such no Response object needs to be returned to the client. The Server MUST NOT reply to a Notification, including those that are within a batch request.</p></blockquote><p>リクエストに <code>id</code> が存在しない場合は、 <code>Notification</code> という扱いになります。<strong>MUST NOT</strong>が使用されている重要な仕様です。</p><p><code>Notification</code> に対しては、サーバーは返信してはいけません。それがバッチに含まれるリクエストであってもです。</p><p>ですが、心配ありません。新しい仕様を追加するには、テストを追加すれば良いのです。</p><h3 id=red---リクエストに-id-が含まれない場合は-notification>Red - リクエストに id が含まれない場合は Notification</h3><p>さて、テストを書くために、どのような仕様にするかを検討します。</p><p>重要な仕様でもあるので、値オブジェクトを厳密に適用する方向で考えます。ここでは <code>JsonRpc::Notification</code> を定義することにします。</p><blockquote><p>💡 <strong>仕様の判断</strong>
<code>JsonRpc::Request</code> に <code>is_notification</code> のようなフラグを追加する方法もあります（そして、おそらくそちらの方が書き直す量は少ない）。実際のプロダクトではそのような判断になる場合もあると思います。
最初から仕様が決まっていた場合はともかく、仕様変更の場合、既存コードへの影響も判断材料になります。（ほとんどの場合、想定しているよりも大きく影響するのが怖いところです）</p></blockquote><p>ところで、この場合 <code>JsonRpc::Request</code> は <code>id</code> を必須項目に変更する必要もあります。何故ならば、 <code>id</code> が存在しない <code>JsonRpc::Request</code> は <code>JsonRpc::Notification</code> になるので、結果的に <code>JsonRpc::Request</code> は <code>id</code> が必ず存在するという仕様に変わりました。</p><pre class=mermaid>
	graph LR;
  リクエスト--&gt;idを持っているか;
  idを持っているか-- Yes --&gt;JsonRpc::Request;
  idを持っているか-- No --&gt;JsonRpc::Notification;
</pre><p>ちょっとした仕様追加のはずだったのに、かなり大ごとになりそうな予感です。</p><p>ですが、落ち着いてテストコードを変更していきましょう。</p><ul><li><code>id</code> が必須項目になるので、 <code>id</code> を省略していた正しく生成しているテストには、必須項目として <code>id</code> を追加する</li><li>新たなテストとして、 <code>id</code> を指定しないで new すると、エラー（required）を返すテストを追加する</li></ul><p>ちなみに、 <code>id</code> は null を許容しているので、<strong>指定しない</strong>のと<strong>undefを渡す</strong>のとは明確に区別する必要があります。今回の仕様変更で <code>JsonRpc::Request</code> は <code>id</code> を指定しない場合はエラーになりますが、<code>id</code>としてundefを渡すと正常に作成されます。</p><p>ここまでは、 <code>JsonRpc::Request</code> として話をしてきましたが、<code>JsonRpc::Request</code>のファクトリーメソッドで <code>JsonRpc::Notification</code> も作成されるのはわかりにくそうです。なので、ファクトリークラスを作成してしまいましょう。<code>JsonRpc::Request->from_hash()</code>を<code>JsonRpc::RequestFactory->from_hash</code> として再実装します。</p><p><code>JsonRpc::Notification</code> についても、新たにテストコードを作成します。クラスの構成としては <code>id</code> を持たない <code>JsonRpc::Request</code> という感じを想定します。</p><p>これで大筋が決まりました。これらの仕様をテストコードに落とし込んでいきます。</p><p>まずは、新たに追加されるファクトリークラスのテストコードを作成します。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># t/request_factory.t</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Test2::V0</span> <span class=o>-</span><span class=n>target</span> <span class=o>=&gt;</span> <span class=s>&#39;JsonRpc::RequestFactory&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor with required fields only&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>subtest</span> <span class=s>&#39;from_hash creates JsonRpc::Request&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::RequestFactory</span><span class=o>-&gt;</span><span class=n>from_hash</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=s>&#39;createUser&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>{</span><span class=n>name</span> <span class=o>=&gt;</span> <span class=s>&#39;Bob&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=n>id</span>      <span class=o>=&gt;</span> <span class=mi>123</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>isa_ok</span> <span class=nv>$req</span><span class=p>,</span>          <span class=p>[</span><span class=s>&#39;JsonRpc::Request&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>isa_ok</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>jsonrpc</span><span class=p>,</span> <span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>isa_ok</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>method</span><span class=p>,</span>  <span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span> <span class=p>{</span><span class=n>name</span> <span class=o>=&gt;</span> <span class=s>&#39;Bob&#39;</span><span class=p>},</span> <span class=s>&#39;params is hash&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>,</span> <span class=mi>123</span><span class=p>,</span> <span class=s>&#39;id is integer&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>subtest</span> <span class=s>&#39;from_hash creates JsonRpc::Notification&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::RequestFactory</span><span class=o>-&gt;</span><span class=n>from_hash</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=s>&#39;notifyEvent&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>[</span><span class=s>&#39;event1&#39;</span><span class=p>,</span> <span class=s>&#39;event2&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>isa_ok</span> <span class=nv>$req</span><span class=p>,</span>          <span class=p>[</span><span class=s>&#39;JsonRpc::Notification&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>isa_ok</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>jsonrpc</span><span class=p>,</span> <span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>isa_ok</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>method</span><span class=p>,</span>  <span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span> <span class=p>[</span><span class=s>&#39;event1&#39;</span><span class=p>,</span> <span class=s>&#39;event2&#39;</span><span class=p>],</span> <span class=s>&#39;params is array&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>done_testing</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>JsonRpc::Notification</code> のためのテストを書いていきます。<code>JsonRpc::Request</code> のテストと被るところが多いですが、気にせず書いていきます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># t/notification.t</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Test2::V0</span> <span class=o>-</span><span class=n>target</span> <span class=o>=&gt;</span> <span class=s>&#39;JsonRpc::Notification&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::MethodName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor with required fields only&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Notification</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;notify&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$req</span><span class=p>,</span>          <span class=p>[</span><span class=s>&#39;JsonRpc::Notification&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>jsonrpc</span><span class=p>,</span> <span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>method</span><span class=p>,</span>  <span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=nn>method</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>,</span> <span class=s>&#39;notify&#39;</span><span class=p>,</span> <span class=s>&#39;method value is notify&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span>        <span class=nb>undef</span><span class=p>,</span>    <span class=s>&#39;params is undef by default&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor with all fields&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Notification</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;notifyEvent&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>[{</span><span class=n>event</span> <span class=o>=&gt;</span> <span class=s>&#39;event1&#39;</span><span class=p>},</span> <span class=p>{</span><span class=n>event</span> <span class=o>=&gt;</span> <span class=s>&#39;event2&#39;</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$req</span><span class=p>,</span> <span class=p>[</span><span class=s>&#39;JsonRpc::Notification&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=nn>method</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>,</span> <span class=s>&#39;notifyEvent&#39;</span><span class=p>,</span>                              <span class=s>&#39;method value is notifyEvent&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span>        <span class=p>[{</span><span class=n>event</span> <span class=o>=&gt;</span> <span class=s>&#39;event1&#39;</span><span class=p>},</span> <span class=p>{</span><span class=n>event</span> <span class=o>=&gt;</span> <span class=s>&#39;event2&#39;</span><span class=p>}],</span> <span class=s>&#39;params is array&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor rejects invalid jsonrpc&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Notification</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#34;not a Version object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;test&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=sx>qr/type constraint|isa/</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;rejects non-Version jsonrpc&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor rejects invalid method&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Notification</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=s>&#34;not a MethodName object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=sx>qr/type constraint|isa/</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;rejects non-MethodName method&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;params accepts array or hash or undef&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$version</span> <span class=o>=</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$method</span>  <span class=o>=</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;testMethod&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$req_array</span> <span class=o>=</span> <span class=nn>JsonRpc::Notification</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>[</span><span class=s>&#39;item1&#39;</span><span class=p>,</span> <span class=s>&#39;item2&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req_array</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span> <span class=p>[</span><span class=s>&#39;item1&#39;</span><span class=p>,</span> <span class=s>&#39;item2&#39;</span><span class=p>],</span> <span class=s>&#39;params is array&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$req_hash</span> <span class=o>=</span> <span class=nn>JsonRpc::Notification</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>{</span><span class=n>key1</span> <span class=o>=&gt;</span> <span class=s>&#39;value1&#39;</span><span class=p>,</span> <span class=n>key2</span> <span class=o>=&gt;</span> <span class=s>&#39;value2&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req_hash</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span> <span class=p>{</span><span class=n>key1</span> <span class=o>=&gt;</span> <span class=s>&#39;value1&#39;</span><span class=p>,</span> <span class=n>key2</span> <span class=o>=&gt;</span> <span class=s>&#39;value2&#39;</span><span class=p>},</span> <span class=s>&#39;params is hash&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$req_undef</span> <span class=o>=</span> <span class=nn>JsonRpc::Notification</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span>  <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req_undef</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span> <span class=nb>undef</span><span class=p>,</span> <span class=s>&#39;params is undef&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># String は拒否</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Notification</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span>  <span class=o>=&gt;</span> <span class=s>&#34;not an array or hash&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=sx>qr/type constraint|isa/</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;rejects string params&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>done_testing</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>JsonRpc::Request</code> は仕様が変更になるのでテストは細かく変更になります。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># t/request.t</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Test2::V0</span> <span class=o>-</span><span class=n>target</span> <span class=o>=&gt;</span> <span class=s>&#39;JsonRpc::Request&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::MethodName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor with required fields only&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;ping&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>id</span>      <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$req</span><span class=p>,</span>          <span class=p>[</span><span class=s>&#39;JsonRpc::Request&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>jsonrpc</span><span class=p>,</span> <span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>method</span><span class=p>,</span>  <span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=nn>method</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>,</span> <span class=s>&#39;ping&#39;</span><span class=p>,</span> <span class=s>&#39;method value is ping&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span>        <span class=nb>undef</span><span class=p>,</span>  <span class=s>&#39;params is undef by default&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>,</span>            <span class=nb>undef</span><span class=p>,</span>  <span class=s>&#39;id is undef&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor with all fields&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;createUser&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>{</span><span class=n>name</span> <span class=o>=&gt;</span> <span class=s>&#39;Alice&#39;</span><span class=p>,</span> <span class=n>age</span> <span class=o>=&gt;</span> <span class=mi>30</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>id</span>      <span class=o>=&gt;</span> <span class=s>&#39;req-001&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$req</span><span class=p>,</span> <span class=p>[</span><span class=s>&#39;JsonRpc::Request&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=nn>method</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>,</span> <span class=s>&#39;createUser&#39;</span><span class=p>,</span> <span class=s>&#39;method value is createUser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>params</span><span class=p>,</span> <span class=p>{</span><span class=n>name</span> <span class=o>=&gt;</span> <span class=s>&#39;Alice&#39;</span><span class=p>,</span> <span class=n>age</span> <span class=o>=&gt;</span> <span class=mi>30</span><span class=p>},</span> <span class=s>&#39;params is hash&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$req</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>,</span> <span class=s>&#39;req-001&#39;</span><span class=p>,</span> <span class=s>&#39;id is string&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor rejects invalid jsonrpc&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#34;not a Version object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;test&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>id</span>      <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=sx>qr/type constraint|isa/</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;rejects non-Version jsonrpc&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor rejects invalid method&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=s>&#34;not a MethodName object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>id</span>      <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=sx>qr/type constraint|isa/</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;rejects non-MethodName method&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor rejects missing id&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=s>&#34;not a MethodName object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=sx>qr/required/</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;rejects missing id&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;params accepts array or hash or undef&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$version</span> <span class=o>=</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$method</span>  <span class=o>=</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;test&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ArrayRef</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>id</span>      <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;params accepts ArrayRef&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># HashRef</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>{</span><span class=n>key</span> <span class=o>=&gt;</span> <span class=s>&#39;value&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=n>id</span>      <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;params accepts HashRef&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># undef</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span>  <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>id</span>      <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;params accepts undef&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># String は拒否</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span>  <span class=o>=&gt;</span> <span class=s>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>id</span>      <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=sx>qr/type constraint/</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;params rejects string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;id accepts string, int, or undef&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$version</span> <span class=o>=</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$method</span>  <span class=o>=</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;test&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=s>&#39;str-id&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;id accepts string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=mi>123</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;id accepts integer&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;id accepts undef&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=o>[]</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=sx>qr/type constraint/</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#39;id rejects array reference&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>done_testing</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=green---テストを満たす最小限の実装>Green - テストを満たす最小限の実装</h3><p>まずは <code>JsonRpc::Request</code> を変更しましょう。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># lib/JsonRpc/Request.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::Request</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Types::Standard</span> <span class=sx>qw(InstanceOf Maybe ArrayRef HashRef Str Int)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::MethodName</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>namespace::clean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span> <span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span> <span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>params</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span> <span class=p>[</span><span class=n>ArrayRef</span> <span class=o>|</span> <span class=n>HashRef</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>Maybe</span> <span class=p>[</span><span class=n>Str</span> <span class=o>|</span> <span class=n>Int</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>                   <span class=c1># 必須にする</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>次は、<code>JsonRpc::Notification</code>です。<code>JsonRpc::Request</code> の <code>id</code> なしですね。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># lib/JsonRpc/Notification.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::Notification</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Types::Standard</span> <span class=sx>qw(InstanceOf Maybe ArrayRef HashRef)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::MethodName</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>namespace::clean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span> <span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span> <span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>params</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span> <span class=p>[</span><span class=n>ArrayRef</span> <span class=o>|</span> <span class=n>HashRef</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>最後に <code>JsonRpc::RequestFactory</code> を作ります。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># lib/JsonRpc/RequestFactory.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::RequestFactory</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Request</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Notification</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::MethodName</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>namespace::clean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>from_hash</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=p>(</span><span class=nv>$class</span><span class=p>,</span> <span class=nv>$hashref</span><span class=p>)</span> <span class=o>=</span> <span class=nv>@_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$jsonrpc</span> <span class=o>=</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=nv>$hashref</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>jsonrpc</span><span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$method</span>  <span class=o>=</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=nv>$hashref</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>method</span><span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$params</span>  <span class=o>=</span> <span class=nv>$hashref</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>params</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>exists</span> <span class=nv>$hashref</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>id</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Request</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$jsonrpc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span>  <span class=o>=&gt;</span> <span class=nv>$params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>id</span>      <span class=o>=&gt;</span> <span class=nv>$hashref</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>id</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1># Notification</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nn>JsonRpc::Notification</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$jsonrpc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span>  <span class=o>=&gt;</span> <span class=nv>$params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>すべてGreenになりました。</p><h3 id=refactor---重複を取り除く>Refactor - 重複を取り除く</h3><p><code>JsonRpc::Request</code> と <code>JsonRpc::Notification</code> は <code>id</code> の有無以外は、ほぼ同じです。ここをリファクタリングしましょう。</p><p><code>JsonRpc::RequestBase</code> を作成し、このクラスを継承させることにします。</p><p>よくある設計の助言として、まずは「合成（composition）を優先する」と言われることがあります。今回のように、リファクタリングとして重複部分を切り出すような場合は、継承を使わない方が良い場合が多いと思います。一部機能が重複しているだけであれば尚更です。</p><p>今回、継承を選択したのは、RequestとNotificationが、どちらもmethodに対してparamsを渡す処理を行うためです（今回はその部分は実装しないのですが）。Requestはレスポンスを返しますが、Notificationはレスポンスを返さない（返してはいけない）という部分だけが異なります。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># lib/JsonRpc/RequestBase.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::RequestBase</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Types::Standard</span> <span class=sx>qw(InstanceOf Maybe ArrayRef HashRef)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::MethodName</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>namespace::clean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span> <span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span> <span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>params</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span> <span class=p>[</span><span class=n>ArrayRef</span> <span class=o>|</span> <span class=n>HashRef</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>JsonRpc::Notification</code> は <code>JsonRpc::RequestBase</code> を継承させると、何も残りません。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># lib/JsonRpc/Notification.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::Notification</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>extends</span> <span class=s>&#39;JsonRpc::RequestBase&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>namespace::clean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>JsonRpc::Request</code> にも <code>JsonRpc::RequestBase</code> を継承させます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># lib/JsonRpc/Request.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::Request</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>extends</span> <span class=s>&#39;JsonRpc::RequestBase&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Types::Standard</span> <span class=sx>qw(Maybe Str Int)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>namespace::clean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>Maybe</span> <span class=p>[</span><span class=n>Str</span> <span class=o>|</span> <span class=n>Int</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>Greenのままであればリファクタリングはうまくいっています。今回は継承（extends）を使うことで重複を削除できました。</p><p>テストコードはたくさん増えましたが、実装の方は、最終的な増減はそれほどでもありませんでした。ですが、<code>JsonRpc::Notification</code> という重要な仕様を持つクラスを実装できたので十分な成果と言えます。</p><h2 id=jsonrpcresponse値オブジェクトのtdd実装>JsonRpc::Response値オブジェクトのTDD実装</h2><p>次に、JSON-RPC 2.0のResponse値オブジェクトを実装します。第2回で検討したとおり「成功時のResponse」と「エラー時のResponse」を別のオブジェクトとして定義します。今回は成功時のResponseのみを実装します（エラーResponseは次回の記事で扱います）。</p><h3 id=json-rpc-20-response仕様の確認>JSON-RPC 2.0 Response仕様の確認</h3><p>JSON-RPC 2.0仕様における成功時のResponse objectは以下のフィールドを持ちます。</p><div class=table-wrapper><table><thead><tr><th>フィールド</th><th>型</th><th>必須/オプション</th><th>説明</th></tr></thead><tbody><tr><td>jsonrpc</td><td>String</td><td>必須</td><td>&ldquo;2.0&rdquo; 固定</td></tr><tr><td>result</td><td>Any</td><td>必須</td><td>メソッドの実行結果（任意の型）</td></tr><tr><td>id</td><td>String, Number, Null</td><td>必須</td><td>リクエストと対応するID</td></tr></tbody></table></div><h3 id=red---responseのテストを書く>Red - Responseのテストを書く</h3><p>ここでは一度に紹介しますが、例えばsubtest単位で Red -> Green -> Refactor のサイクルを回しながら実装してみてください。テストファイルは <code>done_testing;</code> で終わるようにすれば問題ありません。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># t/response.t</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Test2::V0</span> <span class=o>-</span><span class=n>target</span> <span class=o>=&gt;</span> <span class=s>&#39;JsonRpc::Response&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Version</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;constructor with all required fields&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$res</span> <span class=o>=</span> <span class=nn>JsonRpc::Response</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span>  <span class=o>=&gt;</span> <span class=p>{</span> <span class=n>name</span> <span class=o>=&gt;</span> <span class=s>&#39;Alice&#39;</span><span class=p>,</span> <span class=n>age</span> <span class=o>=&gt;</span> <span class=mi>30</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>id</span>      <span class=o>=&gt;</span> <span class=s>&#39;req-001&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=nv>$res</span><span class=p>,</span> <span class=s>&#39;Response created&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$res</span><span class=o>-&gt;</span><span class=n>jsonrpc</span><span class=p>,</span> <span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>],</span> <span class=s>&#39;version&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$res</span><span class=o>-&gt;</span><span class=n>result</span><span class=p>,</span> <span class=p>{</span> <span class=n>name</span> <span class=o>=&gt;</span> <span class=s>&#39;Alice&#39;</span><span class=p>,</span> <span class=n>age</span> <span class=o>=&gt;</span> <span class=mi>30</span> <span class=p>},</span> <span class=s>&#39;result is hash&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$res</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>,</span> <span class=s>&#39;req-001&#39;</span><span class=p>,</span> <span class=s>&#39;id is string&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ここでは省略していますが id は `Maybe[Str|Int]` なので、数値やundefのテストも必要です。</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;result accepts any type&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$version</span> <span class=o>=</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 文字列</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Response</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>result</span> <span class=o>=&gt;</span> <span class=s>&#39;success&#39;</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;result accepts string&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 数値</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Response</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>result</span> <span class=o>=&gt;</span> <span class=mi>42</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;result accepts number&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 配列</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Response</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>result</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;result accepts array&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># ハッシュ</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Response</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>result</span> <span class=o>=&gt;</span> <span class=p>{</span> <span class=n>ok</span> <span class=o>=&gt;</span> <span class=mi>1</span> <span class=p>},</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;result accepts hash&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># null/undef</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>(</span><span class=n>lives</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Response</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$version</span><span class=p>,</span> <span class=n>result</span> <span class=o>=&gt;</span> <span class=nb>undef</span><span class=p>,</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=s>&#39;result accepts undef&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;id is required&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>like</span><span class=p>(</span><span class=n>dies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nn>JsonRpc::Response</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span>  <span class=o>=&gt;</span> <span class=s>&#39;ok&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=sx>qr/required|missing/</span><span class=n>i</span><span class=p>,</span> <span class=s>&#39;id is required&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>subtest</span> <span class=s>&#39;from_hash factory method&#39;</span> <span class=o>=&gt;</span> <span class=k>sub</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$res</span> <span class=o>=</span> <span class=nn>JsonRpc::Response</span><span class=o>-&gt;</span><span class=n>from_hash</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span>  <span class=o>=&gt;</span> <span class=p>{</span> <span class=n>status</span> <span class=o>=&gt;</span> <span class=s>&#39;ok&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>id</span>      <span class=o>=&gt;</span> <span class=s>&#39;test-id&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>isa_ok</span> <span class=nv>$res</span><span class=p>,[</span><span class=s>&#39;JsonRpc::Response&#39;</span><span class=p>],</span> <span class=s>&#39;Response created from hash&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$res</span><span class=o>-&gt;</span><span class=n>result</span><span class=p>,</span> <span class=p>{</span> <span class=n>status</span> <span class=o>=&gt;</span> <span class=s>&#39;ok&#39;</span> <span class=p>},</span> <span class=s>&#39;result is correct&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span> <span class=nv>$res</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>,</span> <span class=s>&#39;test-id&#39;</span><span class=p>,</span> <span class=s>&#39;id is correct&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>done_testing</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=green---response実装>Green - Response実装</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># lib/JsonRpc/Response.pm</span>
</span></span><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::Response</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Types::Standard</span> <span class=sx>qw(InstanceOf Any Str Int)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::Version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>namespace::clean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span><span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>result</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>Any</span><span class=p>,</span>  <span class=c1># 任意の型を許容</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>Str</span> <span class=o>|</span> <span class=n>Int</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>from_hash</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=p>(</span><span class=nv>$class</span><span class=p>,</span> <span class=nv>$hash</span><span class=p>)</span> <span class=o>=</span> <span class=nv>@_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>die</span> <span class=s>&#34;from_hash requires a hash reference&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>unless</span> <span class=nb>ref</span> <span class=nv>$hash</span> <span class=ow>eq</span> <span class=s>&#39;HASH&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>die</span> <span class=s>&#34;missing required field: jsonrpc&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>unless</span> <span class=nb>exists</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>jsonrpc</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nb>die</span> <span class=s>&#34;missing required field: result&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>unless</span> <span class=nb>exists</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>result</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nb>die</span> <span class=s>&#34;missing required field: id&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>unless</span> <span class=nb>exists</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>id</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$class</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>jsonrpc</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span>  <span class=o>=&gt;</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>result</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>id</span>      <span class=o>=&gt;</span> <span class=nv>$hash</span><span class=o>-&gt;</span><span class=p>{</span><span class=n>id</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>__END__
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=head1 NAME
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>JsonRpc::Response - JSON-RPC 2.0 successful Response object
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=head1 SYNOPSIS
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>    use JsonRpc::Response;
</span></span></span><span class=line><span class=cl><span class=cp>    
</span></span></span><span class=line><span class=cl><span class=cp>    my $res = JsonRpc::Response-&gt;new(
</span></span></span><span class=line><span class=cl><span class=cp>        jsonrpc =&gt; JsonRpc::Version-&gt;new(value =&gt; &#39;2.0&#39;),
</span></span></span><span class=line><span class=cl><span class=cp>        result  =&gt; { user =&gt; { id =&gt; 42, name =&gt; &#39;Alice&#39; } },
</span></span></span><span class=line><span class=cl><span class=cp>        id      =&gt; &#39;req-123&#39;,
</span></span></span><span class=line><span class=cl><span class=cp>    );
</span></span></span><span class=line><span class=cl><span class=cp>    
</span></span></span><span class=line><span class=cl><span class=cp>    # From hash
</span></span></span><span class=line><span class=cl><span class=cp>    my $res2 = JsonRpc::Response-&gt;from_hash({
</span></span></span><span class=line><span class=cl><span class=cp>        jsonrpc =&gt; &#39;2.0&#39;,
</span></span></span><span class=line><span class=cl><span class=cp>        result  =&gt; [1, 2, 3],
</span></span></span><span class=line><span class=cl><span class=cp>        id      =&gt; 999,
</span></span></span><span class=line><span class=cl><span class=cp>    });
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=head1 DESCRIPTION
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>Represents a JSON-RPC 2.0 successful Response object.
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>The C&lt;result&gt; field can be any value (string, number, array, hash, null).
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>=cut
</span></span></span></code></pre></td></tr></table></div></div><p>テスト実行で成功（Green）を確認！</p><h2 id=複合値オブジェクトのファクトリーパターン---生成方法の比較>複合値オブジェクトのファクトリーパターン - 生成方法の比較</h2><p>JSON-RPCのような複合値オブジェクトの生成には、いくつかのデザインパターンが適用できます。それぞれの特徴とユースケースを見ていきましょう。</p><h3 id=コンストラクタによる直接生成>コンストラクタによる直接生成</h3><p>最も基本的な方法は、<code>new</code>による直接生成です。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;getUser&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span>  <span class=o>=&gt;</span> <span class=p>{</span> <span class=n>user_id</span> <span class=o>=&gt;</span> <span class=mi>42</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>id</span>      <span class=o>=&gt;</span> <span class=s>&#39;req-001&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>この方法は明示的ですが、冗長になりがちです。</p><h3 id=ファクトリーメソッドパターン>ファクトリーメソッドパターン</h3><p><code>from_hash</code>のようなファクトリーメソッドを提供することで生成を簡潔にできます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># JSON文字列 → Hash → Request</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>JSON::MaybeXS</span> <span class=sx>qw(decode_json)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$json_str</span> <span class=o>=</span> <span class=s>&#39;{&#34;jsonrpc&#34;:&#34;2.0&#34;,&#34;method&#34;:&#34;getUser&#34;,&#34;id&#34;:1}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$hash</span> <span class=o>=</span> <span class=n>decode_json</span><span class=p>(</span><span class=nv>$json_str</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=n>from_hash</span><span class=p>(</span><span class=nv>$hash</span><span class=p>);</span>  <span class=c1># 簡潔！</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ビルダーパターン応用>ビルダーパターン（応用）</h3><p>より複雑な生成ロジックが必要な場合はビルダーパターンも検討できます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>package</span> <span class=nn>JsonRpc::RequestBuilder</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>v5</span><span class=mf>.38</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>Moo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>_jsonrpc</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;rw&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>_method</span>  <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;rw&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>_params</span>  <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;rw&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>_id</span>      <span class=o>=&gt;</span> <span class=p>(</span><span class=n>is</span> <span class=o>=&gt;</span> <span class=s>&#39;rw&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>jsonrpc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=p>(</span><span class=nv>$self</span><span class=p>,</span> <span class=nv>$value</span><span class=p>)</span> <span class=o>=</span> <span class=nv>@_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_jsonrpc</span><span class=p>(</span><span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=nv>$value</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$self</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>method</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=p>(</span><span class=nv>$self</span><span class=p>,</span> <span class=nv>$value</span><span class=p>)</span> <span class=o>=</span> <span class=nv>@_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_method</span><span class=p>(</span><span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=nv>$value</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$self</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>params</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=p>(</span><span class=nv>$self</span><span class=p>,</span> <span class=nv>$value</span><span class=p>)</span> <span class=o>=</span> <span class=nv>@_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_params</span><span class=p>(</span><span class=nv>$value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$self</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>id</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=p>(</span><span class=nv>$self</span><span class=p>,</span> <span class=nv>$value</span><span class=p>)</span> <span class=o>=</span> <span class=nv>@_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_id</span><span class=p>(</span><span class=nv>$value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$self</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>build</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$self</span> <span class=o>=</span> <span class=nb>shift</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_jsonrpc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>defined</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_params</span> <span class=p>?</span> <span class=p>(</span><span class=n>params</span> <span class=o>=&gt;</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_params</span><span class=p>)</span> <span class=p>:</span> <span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nb>defined</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_id</span>     <span class=p>?</span> <span class=p>(</span><span class=n>id</span>     <span class=o>=&gt;</span> <span class=nv>$self</span><span class=o>-&gt;</span><span class=n>_id</span><span class=p>)</span>     <span class=p>:</span> <span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>使用例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=k>use</span> <span class=nn>JsonRpc::RequestBuilder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::RequestBuilder</span><span class=o>-&gt;</span><span class=k>new</span>
</span></span><span class=line><span class=cl>    <span class=o>-&gt;</span><span class=n>jsonrpc</span><span class=p>(</span><span class=s>&#39;2.0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>-&gt;</span><span class=n>method</span><span class=p>(</span><span class=s>&#39;getUser&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>-&gt;</span><span class=n>params</span><span class=p>({</span> <span class=n>user_id</span> <span class=o>=&gt;</span> <span class=mi>42</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=o>-&gt;</span><span class=n>id</span><span class=p>(</span><span class=s>&#39;req-001&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>-&gt;</span><span class=n>build</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>流れるようなインターフェース（Fluent Interface）で読みやすくなります。</p><h2 id=複合値オブジェクトのメリット再確認---json-rpc実装から学ぶ>複合値オブジェクトのメリット再確認 - JSON-RPC実装から学ぶ</h2><p>ここまでのJSON-RPC Request/Response実装を通じて、複合値オブジェクトがもたらす具体的なメリットが明確になりました。</p><h3 id=型安全性>型安全性</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># これはコンパイル時（ロード時）にエラー</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=s>&#34;2.0&#34;</span><span class=p>,</span>  <span class=c1># NG: Version オブジェクトが必要</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span>  <span class=o>=&gt;</span> <span class=s>&#34;test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1># Value &#34;2.0&#34; did not pass type constraint &#34;InstanceOf[&#39;JsonRpc::Version&#39;]&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>不正なデータは、システムに入り込む前に確実に拒否される。</p><h3 id=自己文書化>自己文書化</h3><p>MooとType::Tinyとの組み合わせで、データ構造が明確に見えてきます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=n>has</span> <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span><span class=p>[</span><span class=s>&#39;JsonRpc::Version&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>method</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>       <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span>      <span class=o>=&gt;</span> <span class=n>InstanceOf</span><span class=p>[</span><span class=s>&#39;JsonRpc::MethodName&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>params</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>ArrayRef</span> <span class=o>|</span> <span class=n>HashRef</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>has</span> <span class=n>id</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>is</span>  <span class=o>=&gt;</span> <span class=s>&#39;ro&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isa</span> <span class=o>=&gt;</span> <span class=n>Maybe</span><span class=p>[</span><span class=n>Str</span> <span class=o>|</span> <span class=n>Int</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>また、テストコードを見れば、どのような仕様で動作するのかがわかります。</p><h3 id=リファクタリングの安全性>リファクタリングの安全性</h3><p>機能を追加するときは、まずはテストを追加します。（Red）</p><p>Red を Green にするときは、実装はコピペでも構いません。とにかくGreenにすることだけを考えて実装します。（Green）</p><p>Greenの間はテストコードによって仕様を満たしていることになるので、<strong>仕様を変えずにリファクタリング</strong>ができます。（Refactor）</p><h3 id=テストの容易さ>テストの容易さ</h3><p>テスト駆動開発では、機能を追加するときは、まずはテストを追加します。</p><p>機能を実装する時には、すでにテストが書かれていることになります。</p><p>結果的に、テストコードが書きやすい状態を（否応なく）維持できることになります。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=c1># モックオブジェクトも簡単</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$mock_version</span> <span class=o>=</span> <span class=nn>JsonRpc::Version</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;2.0&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$mock_method</span>  <span class=o>=</span> <span class=nn>JsonRpc::MethodName</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span><span class=n>value</span> <span class=o>=&gt;</span> <span class=s>&#39;test&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$req</span> <span class=o>=</span> <span class=nn>JsonRpc::Request</span><span class=o>-&gt;</span><span class=k>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>jsonrpc</span> <span class=o>=&gt;</span> <span class=nv>$mock_version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span>  <span class=o>=&gt;</span> <span class=nv>$mock_method</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=まとめと次回予告>まとめと次回予告</h2><h3 id=この記事で学んだこと---json-rpc実装で習得した技術>この記事で学んだこと - JSON-RPC実装で習得した技術</h3><p>今回は、JSON-RPC 2.0のRequest/Responseという<strong>複合値オブジェクト</strong>の実装を通じて、以下の技術を習得しました。</p><p><strong>複合値オブジェクトの設計:</strong></p><ul><li>単純な値オブジェクトを組み合わせた階層構造</li><li>必須フィールドとオプショナルフィールドの扱い</li><li>値オブジェクトのネスト構造の設計</li></ul><p><strong>Type::Tinyの実践活用:</strong></p><ul><li><code>Maybe</code>型によるオプショナルフィールドの表現</li><li><code>ArrayRef | HashRef</code>による選択的な型制約</li><li><code>InstanceOf</code>による値オブジェクト同士の組み合わせ</li><li><code>Any</code>型による柔軟な結果の受け入れ</li></ul><p><strong>ファクトリーメソッドパターン:</strong></p><ul><li><code>from_hash</code>による簡潔なオブジェクト生成</li><li>JSONデコード結果からの直接変換</li></ul><p><strong>TDDでの実装プロセス:</strong></p><ul><li>複合的な値オブジェクトのテスト戦略</li><li>必須/オプションフィールドのテストパターン</li><li>Red-Green-Refactorサイクルの実践</li></ul><h3 id=複合値オブジェクトの実装指針---ベストプラクティス>複合値オブジェクトの実装指針 - ベストプラクティス</h3><p>JSON-RPCのような複合値オブジェクトを実装する際は、以下のベストプラクティスを意識すると良い。</p><ol><li><strong>小さな値オブジェクトから始める</strong>: Version, MethodNameのような単純な値オブジェクトを先に実装（ボトムアップアプローチ）</li><li><strong>型制約を明確にする</strong>: Type::TinyのMaybe/InstanceOfで厳密に型を定義し、実行可能な仕様書とする</li><li><strong>ファクトリーメソッドを提供する</strong>: from_hashでJSON→オブジェクト変換の利便性を向上</li><li><strong>テストファーストで進める</strong>: TDDのRed-Green-Refactorサイクルで段階的に実装</li></ol><h3 id=次回予告---エラー処理と境界値テストシリーズ完結編>次回予告 - エラー処理と境界値テスト（シリーズ完結編）</h3><p>次回は「<strong>エラー処理と境界値テスト - 堅牢な値オブジェクトを作る</strong>」として、**シリーズの完結編（第5回）**をお届けします。</p><p><strong>次回の学習内容:</strong></p><ul><li><strong>JSON-RPC Error Responseの実装</strong>: エラーオブジェクトの値オブジェクト化</li><li><strong>エラーコードと例外の設計</strong>: Perlにおける例外処理とType::Tinyの統合</li><li><strong>境界値分析の実践</strong>: JSONサイズ制限、数値範囲、文字列長などの境界値テスト</li><li><strong>プロパティベーステストの導入</strong>: Test::QuickCheckによるランダムテスト</li><li><strong>実践的なエラーハンドリング戦略</strong>: JSON-RPC仕様に準拠したエラー処理</li></ul><p>今回実装したRequestとResponseに、JSON-RPC Error Response値オブジェクトとエラー処理を加えることで、<strong>完全なJSON-RPC 2.0実装</strong>が完成します。さらに、境界値テストやproperty-based testingにより、より堅牢で本番環境に耐えうる値オブジェクトの実装技法を学びます。</p><blockquote><p><strong>次回記事</strong><br>→ エラー処理と境界値テスト - 堅牢な値オブジェクトを作る（公開予定）</p></blockquote><h2 id=参考リンク>参考リンク</h2><p><div class=linkcard><a class=linkcard-a href=https://typetiny.toby.ink target=_blank rel="noopener noreferrer nofollow" title=https://typetiny.toby.ink aria-label=https://typetiny.toby.ink><div class=linkcard-content><div class=linkcard-title>https://typetiny.toby.ink</div><div class=linkcard-meta><img class=linkcard-favicon src=https://typetiny.toby.ink/favicon.ico alt onerror='this.style.display="none"'><span class=linkcard-domain>typetiny.toby.ink</span></div></div></a></div><div class=linkcard><a class=linkcard-a href=https://metacpan.org/pod/Type::Tiny target=_blank rel="noopener noreferrer nofollow" title=https://metacpan.org/pod/Type::Tiny aria-label=https://metacpan.org/pod/Type::Tiny><div class=linkcard-content><div class=linkcard-title>https://metacpan.org/pod/Type::Tiny</div><div class=linkcard-meta><img class=linkcard-favicon src=https://metacpan.org/favicon.ico alt onerror='this.style.display="none"'><span class=linkcard-domain>metacpan.org</span></div></div></a></div><div class=linkcard><a class=linkcard-a href=https://metacpan.org/pod/Types::Standard target=_blank rel="noopener noreferrer nofollow" title=https://metacpan.org/pod/Types::Standard aria-label=https://metacpan.org/pod/Types::Standard><div class=linkcard-content><div class=linkcard-title>https://metacpan.org/pod/Types::Standard</div><div class=linkcard-meta><img class=linkcard-favicon src=https://metacpan.org/favicon.ico alt onerror='this.style.display="none"'><span class=linkcard-domain>metacpan.org</span></div></div></a></div><div class=linkcard><a class=linkcard-a href=https://metacpan.org/pod/Moo target=_blank rel="noopener noreferrer nofollow" title=https://metacpan.org/pod/Moo aria-label=https://metacpan.org/pod/Moo><div class=linkcard-content><div class=linkcard-title>https://metacpan.org/pod/Moo</div><div class=linkcard-meta><img class=linkcard-favicon src=https://metacpan.org/favicon.ico alt onerror='this.style.display="none"'><span class=linkcard-domain>metacpan.org</span></div></div></a></div><div class=linkcard><a class=linkcard-a href=https://www.jsonrpc.org/specification target=_blank rel="noopener noreferrer nofollow" title=https://www.jsonrpc.org/specification aria-label=https://www.jsonrpc.org/specification><div class=linkcard-content><div class=linkcard-title>https://www.jsonrpc.org/specification</div><div class=linkcard-meta><img class=linkcard-favicon src=https://www.jsonrpc.org/favicon.ico alt onerror='this.style.display="none"'><span class=linkcard-domain>www.jsonrpc.org</span></div></div></a></div></p><h2 id=シリーズ記事一覧>シリーズ記事一覧</h2><p>本記事は「<strong>Perlで値オブジェクトを使ってテスト駆動開発してみよう</strong>」シリーズの第4回です。</p><ol><li><a class=link href=/2025/12/19/234500/>値オブジェクトって何だろう？ - DDDの基本概念とPerlでの実装入門</a></li><li><a class=link href=/2025/12/21/234500/>JSON-RPC 2.0で学ぶ値オブジェクト設計 - 仕様から設計へ</a></li><li><a class=link href=/2025/12/23/234500/>PerlのTest2でTDD実践 - 値オブジェクトのテスト戦略</a></li><li><strong>JSON-RPC Request/Response値オブジェクトの実装 - 複合的な値オブジェクト</strong>（この記事）</li><li><a class=link href=/2025/12/27/234500/>エラー処理と境界値テスト - 堅牢な値オブジェクトを作る</a></li></ol><p>各記事は独立して読めますが、順番に読むことでPerlにおけるTDDと値オブジェクト設計の全体像が理解できます。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/json-rpc/>Json-Rpc</a>
<a href=/tags/perl/>Perl</a>
<a href=/tags/tdd/>Tdd</a>
<a href=/tags/type-tiny/>Type-Tiny</a>
<a href=/tags/value-object/>Value-Object</a>
<a href=/tags/moo/>Moo</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>関連するコンテンツ</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/2025/12/27/234517/><div class=article-image><img src=/public_images/2025/perl-tdd-series-image.jpg loading=lazy data-key data-hash=/public_images/2025/perl-tdd-series-image.jpg></div><div class=article-details><h2 class=article-title>【目次】Perlで値オブジェクトを使ってテスト駆動開発してみよう（全5回）</h2></div></a></article><article class=has-image><a href=/2025/12/27/234500/><div class=article-image><img src=/public_images/2025/perl-tdd-series-image.jpg loading=lazy data-key=error-handling-boundary-testing-robust-value-objects data-hash=/public_images/2025/perl-tdd-series-image.jpg></div><div class=article-details><h2 class=article-title>値オブジェクトのエラー処理と境界値テスト — Perl×TDD（シリーズ完結）</h2></div></a></article><article class=has-image><a href=/2025/12/21/234500/><div class=article-image><img src=/public_images/2025/perl-tdd-series-image.jpg loading=lazy data-key data-hash=/public_images/2025/perl-tdd-series-image.jpg></div><div class=article-details><h2 class=article-title>JSON-RPC 2.0仕様から学ぶ値オブジェクト設計【Perl実装】仕様書の読み方とTDD</h2></div></a></article><article class=has-image><a href=/2025/12/23/234500/><div class=article-image><img src=/public_images/2025/perl-tdd-series-image.jpg loading=lazy data-key data-hash=/public_images/2025/perl-tdd-series-image.jpg></div><div class=article-details><h2 class=article-title>PerlのTest2でTDD実践 - 値オブジェクトのテスト戦略とRed-Green-Refactor完全ガイド</h2></div></a></article><article class=has-image><a href=/2025/12/19/234500/><div class=article-image><img src=/public_images/2025/perl-tdd-series-image.jpg loading=lazy data-key data-hash=/public_images/2025/perl-tdd-series-image.jpg></div><div class=article-details><h2 class=article-title>【Perl×DDD】値オブジェクト(Value Object)入門 - Mooで実装する不変オブジェクト</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//nqounet.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2000 -
2026 設計パターンを疑え</section><section class=powerby><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> で構築されています。<br>テーマ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> は <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> によって設計されています。</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>