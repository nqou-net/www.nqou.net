name: agents-config-approval

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

# 明示的な権限を設定してコメント投稿が可能なようにします（最小限）
permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  check-approvals:
    name: Check agent files approvals
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check approvals for .github/agents changes
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const core = require('@actions/core');

            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull_request in context; skipping.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = pr.number;

            // ファイル一覧をページングしながら取得
            let files = [];
            let page = 1;
            while (true) {
              const res = await github.rest.pulls.listFiles({
                owner,
                repo,
                pull_number: prNumber,
                per_page: 100,
                page
              });
              files = files.concat(res.data || []);
              if (!res.data || res.data.length < 100) break;
              page++;
            }
            const filenames = files.map(f => f.filename);

            const targetAgentConfig = '.github/agents/agent-config.yml';
            const hasAgentConfig = filenames.includes(targetAgentConfig);
            const hasAgentsDir = filenames.some(fn => fn.startsWith('.github/agents/'));

            if (!hasAgentConfig && !hasAgentsDir) {
              core.info('No .github/agents changes detected. Passing.');
              return;
            }

            // PR のレビューを取得（ページング）
            let reviews = [];
            page = 1;
            while (true) {
              const res = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number: prNumber,
                per_page: 100,
                page
              });
              reviews = reviews.concat(res.data || []);
              if (!res.data || res.data.length < 100) break;
              page++;
            }

            // APPROVED のユニークな承認者数をカウント（Bot を除外）
            const approvedSet = new Set();
            for (const r of reviews) {
              if (r && r.state && r.state.toUpperCase() === 'APPROVED' && r.user && r.user.login) {
                if (r.user.type && r.user.type.toLowerCase() === 'bot') continue;
                approvedSet.add(r.user.login);
              }
            }
            const approvedCount = approvedSet.size;

            // 必要承認数を決定
            const required = hasAgentConfig ? 2 : 1;

            if (approvedCount >= required) {
              core.info(`Approvals OK (${approvedCount} / ${required})`);
              return;
            }

            const need = required - approvedCount;
            let body;
            if (hasAgentConfig) {
              body = `このプルリクエストは \`${targetAgentConfig}\` を変更しています。セキュリティ上の理由により、このファイルの変更には最低 *${required} 名* の承認（APPROVED）が必要です。\n\n現状、APPROVED が *${approvedCount} 名* しかありません。あと *${need} 名* の承認が必要です。\n\n対応方法の例:\n- 必要なレビュアーにレビューを依頼して承認を得てください。\n- 必要であればレビュアーを割り当てるか、PR本文でレビュワーを指名してください。\n\nこのワークフローは承認が揃うまで失敗します。`;
            } else {
              // 内部にバックチックを含めるためエスケープしてテンプレートリテラルを壊さないようにする
              body = `このプルリクエストは \`.github/agents/\` 配下のファイルを変更しています。最低 *${required} 名* の承認（APPROVED）が必要です。\n\n現状、APPROVED が *${approvedCount} 名* しかありません。あと *${need} 名* の承認が必要です。\n\n対応方法の例:\n- レビュアーにレビューを依頼して承認を得てください。\n\nこのワークフローは承認が揃うまで失敗します。`;
            }

            // コメント投稿を試みる（permissions により失敗する可能性あり）
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body
              });
            } catch (err) {
              core.warning('コメント投稿に失敗しました（権限の問題の可能性があります）: ' + (err && err.message ? err.message : String(err)));
            }

            core.setFailed(body);
