# AGENTS.md — リポジトリ用エージェント向けガイダンス

このファイルは `README.md` の補助文書である。リポジトリ `www.nqou.net`（Hugoベースのウェブサイト）に関して、エージェントが効果的に作業するための具体的かつ実行可能な指示をまとめたものである。

---

**コミュニケーション**

- 原則として日本語で応答を返す。ただし重要な用語については除く。

---

**プロジェクト概要**

- **目的**: Hugoで構築された個人の技術ブログを管理するためのリポジトリである。コンテンツは `content/` に置き、ビルド成果物は `docs/` に配置する運用である。
- **主要技術**: Hugo（静的サイト生成器）、Markdown、及び必要に応じて `tools/` に格納された小規模な補助スクリプト（Perlなど）を用いる。
- **重要なディレクトリ**:
  - `content/` — ソースコンテンツを配置する。投稿は `content/post/` に配置する。
  - `layouts/`, `partials/`, `shortcodes/` — テーマとレイアウトのコードを格納する。
  - `static/` — サイトルートにコピーされる静的アセットを格納する。
  - `resources/` — Hugo のリソースパイプラインの出力を配置する。
  - `docs/` — 生成済みサイトの出力を配置する。通常は読み取り専用として扱う。

---

**エージェント向けの簡潔な事実（クイックスタート）**

- コンテンツは `content/post/` に追加すること。
- **重要制約**: エージェントは環境セットアップやシステムレベルのインストールコマンドを自動で実行してはならない。`docs/` は生成出力であるため直接編集してはならない。

---


## セットアップ（人間が実行するコマンド）

- ローカルプレビューは `hugo server -D` で行うこと。
- 本番ビルドは `hugo --minify` で行うこと。
- VS Code に `Serve Drafts`（`hugo server -D`）と `Build`（`hugo --minify`）のタスクが定義されていることを確認すること。
- 必要に応じて Hugo を人間がインストールすること（プラットフォーム固有の方法を用いる）。
- **警告** — エージェントはセットアップやシステムインストール操作を実行してはならない。これらは人間が手動で行う前提である。
- ローカルプレビュー（ドラフトを含めて表示）を開始するための例（人間が実行する）:

```zsh
brew install hugo   # macOS で Homebrew を使用する場合の例
hugo server -D -F
```

- 本番向けビルドを行う場合のコマンド（人間が実行する）:

```zsh
hugo --minify
```

- ヘルパースクリプト（例: `build.pl`）を使用する場合は、スクリプトの内容と引数を事前に精査すること。

---


## エージェントの作業フロー

以下の手順に従うこと。各項目は実行可能かつ検証可能な操作として定義してある。

- **コンテンツ作成**:
  - 新しい投稿は `content/post/` の直下に配置すること。
  - フロントマターは YAML（`---`）で記述すること。TOML（`+++`）は使用しないこと。
  - 投稿は下書き状態の間は `draft: true` にしておくこと（公開準備が整ったときに `draft: false` に変更する）。
  - タグは英語の小文字で統一すること。複合語はハイフンでつなげる（例: `object-oriented`）。
  - ファイル名はスラッグのみ（`slug.md`）を推奨する。例: `how-to-hugo.md`。ファイル名は公開時の URL スラッグと一致させてください。
  - 見出しは ATX スタイルを採用すること。H1 はページタイトル（フロントマター由来）とし、トップレベルのセクションは `##` とすること。
  - シンプルな外部参照リンク（前後に空白以外がない場合）にはサイトの `linkcard` ショートコードを使用すること: `{{< linkcard "https://example.com" >}}`。
  - よく使うフロントマターキーは `title`, `draft`, `tags`, `description` とする。`date` や `iso8601` は含めないこと。

- **プレビューと編集**:
  - `hugo server -D` を起動して `http://localhost:1313` でレンダリングを確認すること。
  - レイアウトやショートコードの挙動（画像やショートコードの表示）を検証すること。

- **ビルドと検証**:
  - `hugo --minify` を実行し、生成物を検査すること（`public/` または `docs/` を確認する）。
  - `build.pl` を使用する場合は、事前にスクリプトの内容と引数を精査してから実行すること。

---


## テスト手順

- 本リポジトリには自動化されたユニットテストは含まれていない。検証手順は以下の通りである:
  - `hugo --minify` を実行し、生成された HTML を目視で検査すること。
  - リンクチェッカー（例: `linkinator` や `broken-link-checker`）を用い、サイト内のリンク整合性を検査すること。

- CI による検証は `.github/workflows` を参照し、同等のコマンドをローカルで実行して確認すること。

---


## コードスタイル & コンテンツ規約

- Markdown は CommonMark と互換性を保つこと。フェンスコードブロックと適切な言語タグを使用すること。
- フロントマターは YAML（`---`）で統一すること。既存のフロントマターを無断で上書きしてはならない。
- 画像には意味のある `alt` テキストを付与すること。必要に応じて短いキャプションを付けること。
- 画像処理が必要な場合は Hugo の `resources` パイプラインを利用すること。
- 既存のショートコード（`layouts/shortcodes/`）を優先して使用すること。正当な理由がない限り生の HTML を直接埋め込まないこと。

---


## ビルドとデプロイ

- ビルドコマンドは `hugo --minify` である。
- 生成物の出力先を確認し、CI の設定に合わせて検証すること（多くのワークフローでは `docs/` を公開用として使用する）。
- `docs/` は通常読み取り専用とし、エージェントは直接編集してはならない。編集は必ずソース（`content/`, `layouts/`, `static/` など）に対して行い、その後ビルドして反映させること。

---


## プルリクエストとコントリビューション規約

- ブランチ命名規則を遵守すること（例: `feature/write-hugo-article`, `fix/images-optimization`）。
- PR タイトルのフォーマットは `[post] 短い説明` または `[site] 短い説明` に統一すること。
- PR 提出前に以下を必ず実行して確認すること:
  - `hugo server -D` を起動して表示を目視確認すること。
  - `hugo --minify` を実行してビルドが成功することを確認すること。
  - 下書きは `draft: true` のままにすること。公開時にのみ `draft: false` に変更すること。

---


## セキュリティとシークレット管理

- リポジトリ内にシークレットを格納してはならない。CI やデプロイ用のシークレットは GitHub Secrets や外部のシークレットマネージャーを利用すること。
- フロントマターやコンテンツに資格情報を埋め込んではならない。

---


## トラブルシューティング（よくある問題と対応手順）

- `hugo server` が失敗する場合の確認事項:
  - 必要な Hugo のバージョンが適合しているかを `config/_default/config.toml` 等で確認すること。
  - ショートコードやパーシャルが原因でエラーが発生していないかを確認すること（パラメータ不足が原因となる場合が多い）。

- 画像が表示されない場合の確認事項:
  - `assets/` や `static/images/` に該当ファイルが存在するかを確認すること。
  - フロントマターの `featuredImage` パスが正しいかを確認すること。

- コンテンツが表示されない場合の確認事項:
  - `draft` が `false` になっているか、または `hugo server -D` を使用してドラフトを含めて表示しているかを確認すること。

---

## カスタムエージェントを使ったワークフロー：最高にクールなブログ記事を作る手順

目的：リポジトリ内にあるカスタムエージェント群を協調させて、アイデア出し → 下書き生成 → 編集 → 校正 → 公開準備までを効率的に行うワークフローを定義する。エージェントは補助ツールであり、最終判断と実行（ファイルのコミットや外部コマンド実行など）は人間が行う。

前提ルール（必読）
- `content/` に新しい投稿を追加する。投稿は `content/post/` の直下にファイルを作成すること。
- フロントマターは YAML（`---`）で記述する。`date` や `iso8601` は含めない。
- 下書き中は必ず `draft: true` にする。
- タグは英語小文字、複合語はハイフン（例: `object-oriented`）。
- エージェントはシステムレベルのインストールやローカル環境でのコマンド実行を自動で行ってはならない（人間が実行）。
- 生成済みサイト（`docs/`）は直接編集しない。

ワークフロー概要（エージェント役割）
1. creative-brainstorming（アイデア生成）
   - 目的：記事のテーマ候補、ターゲット読者、主な見出し構成を複数案生成する。
   - 出力：短い要約、ターゲット読者、想定タグ、推奨見出し（H2/H3 の目次）。
   - 制約：技術用語や命名は既存スタイルに揃えること。

2. investigative-research（調査・情報収集）
   - 目的：creative-brainstorming の選択案に基づき、最新情報や引用可能ソースを集める（要出典）。
   - 出力：参考リンク一覧、重要ポイントの箇条書き、簡単な引用メモ。
   - 注意：外部リンクは linkcard ショートコードで使用可能な形式で出力する例を付す。

3. darft（下書き生成）
   - 目的：フロントマター付きの Markdown 下書きを生成する。
   - 出力フォーマット例（必須遵守）:
     ~~~markdown
     ---
     title: "記事タイトル"
     draft: true
     tags:
     - "example-tag"
     description: "記事の短い説明（2行程度）"
     ---
          
     ## セクション例
     コンテンツ...
     ~~~
   - 見出しは ATX スタイルを採用し、トップレベルのセクションは `##` とする。
   - 独立した外部参照リンクはショートコードの linkcard（ `{{< linkcard "https://example.com" >}}` ）を用いる。

4. layout-and-content-harmonization（スタイルと構成の整形）
   - 目的：サイト固有のスタイル、読みやすさ、見出し階層、タグ整合性をチェック・修正。
   - 主なチェック項目：
     - フロントマターキーの存在（title, draft, tags, description）
     - タグのフォーマット（英語小文字、ハイフン）
     - 長すぎる段落の分割、箇条書きの整形
     - 画像やショートコードの想定出力が正しいか確認
   - 出力：修正差分案（パッチ形式で提示）。実際のファイル変更は人間が行う。

5. search-engine-optimization（メタ情報と公開準備、SEO）
   - 目的：description の最適化、推奨キーワード、OG（Open Graph）向け簡易説明の提案。
   - 出力：description の候補、SNS向け短文（140字以内）、推奨公開タグ。

6. proofreader（校正）
   - 目的：日本語の文法チェック、簡易事実確認、リンク切れの疑い検出（外部ツール実行は不可）。
   - 出力：修正提案リスト（文法、語彙、参照整合性）。

7. reviewer（公開前の最終チェック）
   - 目的：公開前の最終チェックリストを提示。
   - 出力例：
     - チェックポイント：画像表示、ショートコード、モバイル表示、metaタグ確認

具体的な実行シーケンス（推奨）
1. creative-brainstorming エージェントに「最高にクールな技術記事の案を3つ」と指示。出力から1案を選定。
2. investigative-research エージェントに選定案を与え、引用可能なソースと主要ポイントを収集。
3. darft エージェントにフロントマター情報（title, tags, description）と investigative-research の要点を渡して Markdown 下書きを生成。
4. layout-and-content-harmonization エージェントに下書きを渡し、スタイル調整とタグ正規化を行ってもらう。差分を取得。
5. proofreader エージェントで文法と事実関係の最終チェックを行い、修正リストを反映。
6. search-engine-optimization エージェントに公開に向けた description と SNS 文を生成してもらう。
7. reviewer エージェントが手順とチェックリストを出力。人間が `hugo server -D` で確認。
8. 人間が最終確認後、`draft: false` に変更し、ファイルをコミットして PR を作成する（PRテンプレートに「agent-assisted draft」と明記）。

エージェントへの具体的なプロンプトテンプレート（draft への例）
- 「次のフロントマターで、Hugo 用 Markdown 下書きを作ってください。タイトル: <TITLE>、tags: <comma-separated-tags>、description: <SHORT_DESC>。Research メモ: <RESEARCH_POINTS>。出力は YAML フロントマターと本文のみで、コードブロックは ~~~ を使ってください。」

安全上の注意
- エージェントは以下の操作を行ってはならない：
  - リモートリポジトリへの直接 push、PR のマージ、または CI をトリガーする行為（これらは人間が行う）。
  - 環境セットアップやシステムパッケージのインストール。
  - `docs/` の直接編集。
- エージェントは変更案を必ず「差分（パッチ）または新しいファイルの完全な本文」として提示し、人間がレビュー・適用するワークフローを守ること。

テンプレート：記事作成チェックリスト（reviewer が出力する想定）
- [ ] フロントマター: title, draft, tags, description がある
- [ ] draft: true で下書き状態
- [ ] 見出し階層が正しい（H1は自動、トップは##）
- [ ] 外部リンクは必要な箇所で linkcard を使用
- [ ] 画像は `static/` または resources 経由で参照
- [ ] ローカル preview で表示確認済み（人間が実行）
- [ ] SEO description と SNS 文が用意されている

最後に（実務的な運用メモ）
- 1つの記事作成につき creative-brainstorming → investigative-research → darft → layout-and-content-harmonization → proofreader → search-engine-optimization → reviewer の流れを1セットとする。
- 生成された草案は必ず人間がレビューし、スタイルや事実確認を通してからコミットする。
- PR の説明には「agent-assisted: <agent-names>」を必ず残して透明性を確保する。


---


このファイルはエージェントがリポジトリ内で行動するための明確な手順とチェックリストを提供するものである。変更を加える場合はこの方針に従い、手順を逸脱しないこと。

---

## 専門家エージェントへの構成（アウトライン）作成依頼 — 手順とテンプレート

目的: 各専門家エージェントに対して、記事や技術文書の「構成（アウトライン）」を生成させるための標準化された手順とテンプレートを定義します。これにより、複数のエージェントから受け取ったアウトラインを比較・統合しやすくし、人間による編集・下書き生成へスムーズに接続できるようにします。

適用範囲:
- `content/post/` に置く技術記事のアウトライン作成（草案レベル）。
- エージェント: `perl-monger`, `sql-otaku` をはじめ、`.github/agents/*.agent.md` に定義された専門家エージェント全般。

基本ポリシー:
- 出力は日本語。ただしコード例や技術用語は原語（英語）を含めて可。簡潔かつ実用的に。
- アウトラインは H2/H3 相当の見出し階層で返すこと（H1 はフロントマターの title が担当）。
- 各セクションに 1-2 行の説明を付けること。必要なら「想定コード言語」「想定画像（パス）」「推定文字数」を示す。
- エージェントは最小限の前提情報に基づいてまず 3 案のアウトラインを提案し、人間が 1 案を選ぶフローを推奨する。

標準ワークフロー（エージェント呼び出しシーケンス）:
1. 要件提示（人間）: タイトル候補 / 目的 / 想定読者 / 必要な技術トピック（省略可）を提示する。
2. アウトライン生成（専門家エージェント）: まず短めの要約＋3案のアウトライン（各案は H2/H3、各見出しに説明付）を返す。
3. 絞込み（人間）: 最適案を選択し、追加情報（深掘りしたい点、必要なコード量など）を返す。
4. 詳細化（同じ/別のエージェント）: 選択案を基に各セクションの短い段落案（100–300字目安）および必要なコードスニペットや図の指示を出力させる。
5. 下書き生成（draft エージェント等）: フロントマター付きの Markdown 下書きを生成する。

プロンプトテンプレート（短縮版 — 人間がエージェントに投げるときの雛形）:

- 初期アウトライン要求（3案）

```
次の情報に基づいて、技術記事のアウトライン案を3つ（案A/B/C）作ってください。
- タイトル候補: <TITLE>
- 目的: <WHAT_TO_TEACH>
- 想定読者: <AUDIENCE>
- 必要な技術要素（任意）: <TECH_TOPICS>

出力形式:
- 各案に対して: 要約(1行)、H2/H3 見出しの階層、各見出しに1-2行の説明、想定コード言語（ある場合）、推奨タグ（3つ程度）、推定文字数レンジ。
```

- 選定後の詳細化要求（1案を深掘り）

```
案Aを選びました。以下の点を踏まえて各セクションを詳細化してください。
- 各セクションごとに200–400字の本文（日本語）
- 必要なコード例は実行可能な最小単位で示す（言語: <LANG>）
- 参考リンクがあれば linkcard 用の URL を添える
- 推奨画像（static/ または resources 参照）の場所や説明を簡潔に示す
```

（注）エージェントが出力するときは、差分（patch）ではなく本文をそのまま示し、人間が差分適用を行います。

期待される出力サンプル（アウトライン案のスケルトン）:

- 案A: 要約...
  - ## 背景 — 1-2行の説明
    - ### 問題の定義 — 1行
  - ## 解決アプローチ — 1-2行
    - ### 実装例（言語: Perl） — ここに短い説明とコードの要否
  - 推奨タグ: perl, example-tag, howto
  - 推定文字数: 1,200–1,800

エージェント別の注記（代表例）:
- perl-monger
  - 強み: Perl の文法的な最適解、ワンライナー、ベストプラクティスを出すのが得意。
  - 要求時の注意: 必要なら Perl のバージョンや CPAN モジュール情報を明示するように促す（例: "Perl v5.30+ を想定"）。
  - 推奨プロンプト: コード例は実行可能な最小例（perl -E で動くワンライナー等）を含めるよう指示する。

- sql-otaku
  - 強み: SQL 設計、クエリ最適化、実行計画の観点での分解が得意。
  - 要求時の注意: どの DB（Postgres, MySQL, SQLite 等）を想定するか明示する。
  - 推奨プロンプト: サンプルスキーマとデータ量の目安を与え、クエリ例と期待結果のサンプルを出力させる。

- json-rpc-otaku / websocket-otaku / docker-otaku 等
  - 各エージェントの強み（通信プロトコル、デプロイ、運用）を活かしたアウトラインを要求する際は、環境（言語、バージョン、外部サービス）を明記すること。

検証と品質ゲート（人間が実行）:
- アウトライン受領後は、以下をチェックする。
  - H2/H3 の見出しが適切に分割されているか
  - 各セクションの説明が具体的か（曖昧な語句は再要求）
  - コード例の言語・バージョン・外部依存が明記されているか
  - 推奨タグがリポジトリのタグ規約に合致しているか（英語小文字、ハイフン）

実運用メモ:
- エージェントに複数回リクエストして出力のバリエーションを集め、最良案を手作業で統合するのが実務的。
- アウトライン生成は非破壊（`content/` に直接書き込ませない）。エージェントはアウトライン本文を返し、人間が `content/post/<slug>.md` を作成する。

---

**テンプレート利用例（短い提示メッセージ）**

「perl-monger に対して: タイトル: 『PerlでのシンプルなCSVパーサ実装』、目的: 小さなデータを素早く扱う方法を示す、想定読者: Perl 初心者〜中級者、技術要素: Text::CSV, one-liners。まずアウトライン案を3つ、各見出しに説明を付けてください。」

「sql-otaku に対して: タイトル: 『Postgresでのパフォーマンス改善入門』、目的: 実行計画を読み解く基礎を教える、想定読者: DB 管理者とアプリ開発者、技術要素: EXPLAIN ANALYZE, indexes。まずアウトライン案を3つ出してください。」

---

追記完了: 以上のガイドラインを用いて、エージェントごとに構成（アウトライン）を生成するワークフローが統一されます。変更や追補が必要な場合は `.github/agents/*.agent.md` と照らして、エージェント特性を反映してください。
