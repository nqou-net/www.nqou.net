---
title: "大きなファイルの履歴を削除！git filter-branch と BFG Repo-Cleaner"
draft: true
tags:
- "git"
- "git-filter-branch"
- "repository-maintenance"
- "security"
- "troubleshooting"
description: "誤ってコミットした大容量ファイルや機密情報を履歴から完全削除する方法。filter-branchの基本から、より高速なBFG Repo-Cleanerの使い方、チーム全体での履歴書き換え後の対応まで、リポジトリクリーンアップの実践を解説します。"
---

## なぜ履歴から削除が必要か

Gitは全ての履歴を保持するため、一度コミットしたファイルは削除してもリポジトリに残り続けます。これが問題になる場面があります。

### リポジトリサイズの肥大化

```bash
# リポジトリサイズを確認
git count-objects -vH

# 出力例
count: 2000
size: 500.00 MiB
in-pack: 5000
packs: 1
size-pack: 2.00 GiB  # 大容量ファイルが履歴に残っている
```

間違えて大きな動画ファイルやビルド成果物をコミットすると、削除してもサイズが減りません。

### 機密情報の誤コミット

最も深刻な問題：

- APIキー、パスワード
- 秘密鍵（SSH, GPG）
- データベース接続文字列
- トークンやクレデンシャル

**通常の削除では履歴に残るため、完全に削除する必要があります。**

## git filter-branch の基本

`git filter-branch`は、履歴全体を書き換える強力なコマンドです。

**警告**: 履歴を書き換えるため、慎重に使用してください。作業前に必ずバックアップを取りましょう。

### --tree-filter でファイル削除

全コミットから特定のファイルを削除します。

```bash
# バックアップ作成
git clone --mirror repo.git repo-backup.git

# 特定ファイルを履歴から削除
git filter-branch --tree-filter 'rm -f large-file.mp4' HEAD
```

`--tree-filter`は各コミットをチェックアウトして実行するため、時間がかかります。

### --index-filter で高速化

インデックスを直接操作するため、より高速です。

```bash
# インデックスフィルターで削除（推奨）
git filter-branch --index-filter \
  'git rm --cached --ignore-unmatch large-file.mp4' HEAD
```

`--ignore-unmatch`は、ファイルが存在しないコミットでもエラーにしません。

### --all で全ブランチを対象

```bash
# 全ブランチから削除
git filter-branch --index-filter \
  'git rm --cached --ignore-unmatch secrets.txt' \
  --all
```

全ブランチ、全タグから完全に削除されます。

## BFG Repo-Cleaner でより簡単に

BFGは`filter-branch`より遥かに高速で使いやすいツールです。

{{< linkcard "https://rtyley.github.io/bfg-repo-cleaner/" >}}

### インストールと基本的な使い方

```bash
# インストール（Java必須）
brew install bfg  # macOS
# または
wget https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar

# ミラークローン作成（必須）
git clone --mirror https://github.com/user/repo.git

# BFG実行
java -jar bfg.jar --delete-files "large-file.mp4" repo.git
```

### 大容量ファイルの一括削除

```bash
# 100MB以上のファイルをすべて削除
java -jar bfg.jar --strip-blobs-bigger-than 100M repo.git

# または、最大サイズのNファイルを削除
java -jar bfg.jar --strip-biggest-blobs 20 repo.git
```

これでリポジトリサイズを大幅に削減できます。

### パスワード等の機密情報削除

テキストファイルから特定の文字列を置換・削除します。

```bash
# パスワードを置換
echo "password123" > passwords.txt
java -jar bfg.jar --replace-text passwords.txt repo.git

# または正規表現で
echo "regex:api_key.*==>" > replace.txt
java -jar bfg.jar --replace-text replace.txt repo.git
```

デフォルトで`***REMOVED***`に置換されます。

### ディレクトリごと削除

```bash
# nodeディレクトリを履歴から削除
java -jar bfg.jar --delete-folders node_modules repo.git

# 複数指定
java -jar bfg.jar --delete-folders "{node_modules,vendor,dist}" repo.git
```

ビルド成果物を誤ってコミットした場合に有効です。

## 履歴書き換え後の仕上げ

BFGや`filter-branch`実行後は、クリーンアップが必要です。

### git reflog expire と gc

```bash
# 作業ディレクトリに移動
cd repo.git

# reflogを期限切れにする
git reflog expire --expire=now --all

# 到達不能なオブジェクトを削除
git gc --prune=now --aggressive

# サイズを確認
git count-objects -vH
```

これで不要なオブジェクトが完全に削除されます。

### force push の必要性

履歴を書き換えたため、通常のpushは拒否されます。

```bash
# リモートに強制プッシュ
cd repo  # ミラーではなく通常のクローンで
git push origin --force --all
git push origin --force --tags
```

**警告**: これは全ての履歴を上書きします。チームメンバーに事前通知が必須です。

## 履歴書き換え後のチーム対応

### チームメンバーへの周知

履歴書き換え後、全メンバーが対応する必要があります。

**通知内容**:
```
重要: リポジトリの履歴を書き換えました

理由: [大容量ファイル削除 / 機密情報削除 等]
実施日時: 2023-12-07 15:00

以下の手順で対応をお願いします：

1. 現在の作業をコミット
2. ローカルリポジトリを削除
3. 新しくクローン
4. 作業中のブランチがあれば、cherry-pickで復元
```

### 各メンバーの対応手順

#### パターン1: 作業中の変更がない場合

```bash
# 最もシンプル：削除して再クローン
cd ..
rm -rf repo
git clone https://github.com/user/repo.git
```

#### パターン2: 作業中の変更がある場合

```bash
# 1. 現在の作業を退避
git stash

# 2. リモートから最新を取得
git fetch origin

# 3. ローカルブランチをリセット
git reset --hard origin/main

# 4. 作業を復元
git stash pop
```

#### パターン3: 複数ブランチで作業中

```bash
# 各ブランチの差分をパッチ化
git format-patch origin/main

# リポジトリを再クローン
cd ..
rm -rf repo
git clone https://github.com/user/repo.git
cd repo

# パッチを適用
git am ../old-repo/*.patch
```

## 代替案：git-filter-repo

`git-filter-repo`は、`filter-branch`の後継として推奨されるツールです。

{{< linkcard "https://github.com/newren/git-filter-repo" >}}

### インストール

```bash
# pipでインストール
pip install git-filter-repo

# またはbrewで
brew install git-filter-repo
```

### 使用例

```bash
# ファイルを削除
git filter-repo --path large-file.mp4 --invert-paths

# ディレクトリを削除
git filter-repo --path build/ --invert-paths

# メールアドレスを置換
git filter-repo --email-callback 'return email.replace(b"old@example.com", b"new@example.com")'
```

`filter-branch`より高速で、より多機能です。

## GitHub の大容量ファイル警告への対処

GitHubは50MB以上のファイルで警告、100MB以上でpushを拒否します。

### 警告が出た場合

```bash
remote: warning: Large files detected
remote: warning: File large-file.bin is 75.00 MB

# 対処
git rm large-file.bin
git commit --amend

# または、履歴から削除
java -jar bfg.jar --delete-files large-file.bin .git
git reflog expire --expire=now --all
git gc --prune=now --aggressive
git push --force
```

### 今後の予防策

`.gitignore`に追加：

```
# ビルド成果物
dist/
build/
*.zip
*.tar.gz

# 大容量ファイル
*.mp4
*.avi
*.iso
*.dmg

# 機密情報
.env.local
secrets.yml
*.key
*.pem
```

## まとめ

リポジトリクリーンアップのベストプラクティス：

- **小規模削除**: `git filter-branch --index-filter`
- **大規模削除**: BFG Repo-Cleaner（高速）
- **最新推奨**: git-filter-repo（多機能）
- **仕上げ**: `git gc --prune=now --aggressive`
- **共有**: force pushとチームへの周知

履歴書き換えは最後の手段です。事前に`.gitignore`を適切に設定し、コミット前にレビューする習慣をつけましょう。万が一の時は、このガイドを参考に確実に対処してください！
