---
title: "サブモジュールとの付き合い方：git submodule の実践的運用"
draft: true
tags:
- "git"
- "git-submodule"
- "repository-management"
- "workflow"
- "best-practices"
description: "複数リポジトリを組み合わせたプロジェクトで必須のサブモジュール管理を解説。初期化、更新、削除の基本から、サブモジュール内での作業、バージョン固定の理由、トラブル時の対処まで、実務で使えるsubmodule運用術を紹介します。"
---

## サブモジュールとは何か

`git submodule`は、別のGitリポジトリを自分のリポジトリ内に組み込む仕組みです。ライブラリやツールを外部リポジトリとして管理しながら、プロジェクトに統合できます。

### モノレポとの違い

| アプローチ | サブモジュール | モノレポ |
|----------|-------------|---------|
| リポジトリ数 | 複数（独立管理） | 1つ（全て含む） |
| バージョン管理 | 個別に可能 | 全体で統一 |
| ビルド速度 | 必要な部分のみ | 全体をビルド |
| 権限管理 | リポジトリごと | ディレクトリ単位 |

### サブモジュールが適している場面

- **共有ライブラリ**: 複数プロジェクトで同じコードを使う
- **ベンダー依存**: 特定バージョンのサードパーティを固定
- **大規模プロジェクト**: 部分的にクローンして効率化
- **権限分離**: サブモジュールごとにアクセス制御

## サブモジュールの基本操作

### git submodule add で追加

```bash
# サブモジュールを追加
git submodule add https://github.com/user/library.git libs/library

# 出力
Cloning into 'libs/library'...
remote: Enumerating objects: 100, done.
remote: Total 100 (delta 0), reused 0 (delta 0)
Receiving objects: 100% (100/100), done.
```

これで以下が作成されます：

1. `libs/library/`ディレクトリ（サブモジュールの実体）
2. `.gitmodules`ファイル（サブモジュールの設定）

```.gitmodules
[submodule "libs/library"]
    path = libs/library
    url = https://github.com/user/library.git
```

### git submodule init と update

他の人がクローンした後、サブモジュールを初期化します。

```bash
# リポジトリをクローン
git clone https://github.com/user/project.git
cd project

# サブモジュールディレクトリは空の状態

# 初期化
git submodule init

# 内容を取得
git submodule update

# または1行で
git submodule update --init
```

### --recursive オプションの重要性

サブモジュールがさらにサブモジュールを持つ場合（ネストした構造）：

```bash
# 再帰的にすべて取得
git submodule update --init --recursive

# またはクローン時に
git clone --recurse-submodules https://github.com/user/project.git
```

`--recursive`がないと、ネストしたサブモジュールは取得されません。

## サブモジュールの更新

### 親リポジトリから見た更新

親リポジトリは、サブモジュールの特定コミットを参照しています。

```bash
# サブモジュールの最新を取得
cd libs/library
git pull origin main

# 親リポジトリに戻る
cd ../..

# 変更をコミット（サブモジュールの参照を更新）
git add libs/library
git commit -m "chore: update library submodule to latest"
```

### git submodule update --remote

リモートの最新にサブモジュールを更新します。

```bash
# サブモジュールをリモートの最新に更新
git submodule update --remote libs/library

# 全サブモジュールを更新
git submodule update --remote

# 更新をコミット
git add .
git commit -m "chore: update all submodules"
```

### サブモジュール内での作業とコミット

サブモジュール内で直接作業することもできます。

```bash
# サブモジュールに移動
cd libs/library

# ブランチを作成
git checkout -b fix/bug

# 変更
vim src/main.c
git add src/main.c
git commit -m "fix: critical bug"

# サブモジュールのリモートにpush
git push origin fix/bug

# 親リポジトリに戻る
cd ../..

# 親リポジトリで参照を更新
git add libs/library
git commit -m "chore: update library with bug fix"
```

## よくあるトラブルと解決法

### detached HEAD 状態の理解

サブモジュールは通常、detached HEAD状態（特定のコミットを直接指す）です。

```bash
cd libs/library
git status
# HEAD detached at abc1234

# これは正常な状態
```

作業する場合はブランチをチェックアウト：

```bash
git checkout main
# または
git checkout -b feature/new-feature
```

### サブモジュールの削除方法

サブモジュールの削除は少し複雑です。

```bash
# 1. サブモジュールの登録を解除
git submodule deinit libs/library

# 2. ディレクトリを削除
git rm libs/library

# 3. .git/modulesも削除（完全に削除する場合）
rm -rf .git/modules/libs/library

# 4. コミット
git commit -m "chore: remove library submodule"
```

### .gitmodules の手動編集

URLが変わった場合など、手動で編集が必要な場合があります。

```bash
# .gitmodulesを編集
vim .gitmodules

# 変更例：URLを更新
[submodule "libs/library"]
    path = libs/library
    url = https://github.com/newuser/library.git

# 変更を反映
git submodule sync
git submodule update --init
```

## foreach でまとめて操作

複数のサブモジュールに対して同じコマンドを実行できます。

### 基本的な使い方

```bash
# 全サブモジュールのステータス確認
git submodule foreach 'git status'

# 全サブモジュールをmainブランチに
git submodule foreach 'git checkout main'

# 全サブモジュールをpull
git submodule foreach 'git pull origin main'
```

### 複雑なコマンドの実行

```bash
# 未コミットの変更があるサブモジュールを検出
git submodule foreach '
  if [ -n "$(git status --porcelain)" ]; then
    echo "変更あり: $name"
  fi
'

# 全サブモジュールでテスト実行
git submodule foreach 'npm test'
```

## 実践的なワークフロー

### 新規プロジェクトでの設定

```bash
# プロジェクト作成
mkdir myproject
cd myproject
git init

# サブモジュール追加
git submodule add https://github.com/org/shared-lib.git lib/shared
git submodule add https://github.com/org/common-utils.git lib/utils

# コミット
git add .
git commit -m "chore: add submodules"
```

### 既存プロジェクトのクローンと初期化

```bash
# プロジェクトをクローン
git clone https://github.com/org/myproject.git
cd myproject

# サブモジュールを一括初期化
git submodule update --init --recursive

# 全サブモジュールをmainブランチに
git submodule foreach 'git checkout main'
```

### CI/CDでの取り扱い

```yaml
# GitHub Actions の例
- name: Checkout repository
  uses: actions/checkout@v4
  with:
    submodules: recursive

# または
- name: Update submodules
  run: |
    git submodule update --init --recursive
```

## サブモジュール vs サブツリー

別の方法として`git subtree`もあります。

| 特徴 | submodule | subtree |
|------|-----------|---------|
| 履歴の独立性 | 完全に独立 | 親に統合される |
| クローンの簡単さ | 追加コマンド必要 | 自動的に含まれる |
| 更新の複雑さ | やや複雑 | シンプル |
| 外部貢献 | 簡単 | やや複雑 |

### いつサブツリーを選ぶか

- **初心者が多いチーム**: クローンが簡単なsubtree
- **外部ライブラリを固定**: submodule
- **頻繁に更新**: submodule（バージョン管理しやすい）

## ベストプラクティス

### サブモジュールのバージョン固定

本番環境では、サブモジュールを特定バージョンに固定：

```bash
cd libs/library
git checkout v1.2.0  # タグやコミットハッシュ
cd ../..
git add libs/library
git commit -m "chore: lock library to v1.2.0"
```

### 定期的な更新チェック

```bash
# 週次で最新版をチェック
git submodule foreach 'git fetch origin'
git submodule foreach 'git log --oneline HEAD..origin/main'
```

### ドキュメント化

`README.md`にサブモジュールの説明を追加：

```markdown
## サブモジュール

このプロジェクトは以下のサブモジュールを使用しています：

- `lib/shared`: 共有ライブラリ（v1.2.0固定）
- `lib/utils`: 共通ユーティリティ（最新）

### セットアップ

git submodule update --init --recursive
```

## まとめ

サブモジュール運用のポイント：

- **追加**: `git submodule add <url> <path>`
- **初期化**: `git submodule update --init --recursive`
- **更新**: `git submodule update --remote`
- **一括操作**: `git submodule foreach <command>`

サブモジュールは慣れるまで複雑に感じますが、適切に使えば大規模プロジェクトの管理が格段に楽になります。まずは小さなプロジェクトで試して、徐々に複雑な構成に挑戦していきましょう！
