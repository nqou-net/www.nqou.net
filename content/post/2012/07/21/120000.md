---
date: 2012-07-21T12:00:00+09:00
draft: false
iso8601: 2012-07-21T12:00:00+09:00
tags:
  - undef
title: Mojoliciousのファイルアップロードではまった

---

[@nqounet](https://twitter.com/nqounet)です。

Mojoliciousのファイルアップロードではまった。

また自分がやらかしそうなので記録。

3時間くらいウンウン唸っていたけど、ちゃんと冷静に考えたら、データベースにリファレンスそのものを書き込もうとしていただけだった。

Mojoliciousを使ってファイルのアップロード機能を作成していた時、

```text
No references other than a SCALAR reference can use a update column
```

というエラーメッセージが出るようになってしまった。

[schema](http://e-words.jp/w/E382B9E382ADE383BCE3839E.html)から情報を読み込んでフォームを作成したり、そのフォームの情報を確認して、問題なければ書き込む、という一連の処理を作成していた。

Mojoliciousでは、ファイルのアップロードをした時に、paramから値を取得するとオブジェクト（Mojo::Upload）が取れるようになっている。 最初に作成したときは、

```text
my $upload = $self->param('upload');
if (ref $upload eq 'Mojo::Upload') {
  if ($upload->filename) {
    $upload->move_to(file('path', 'to', $upload->filename));
  }
  $upload = $upload->filename;
}
```

という感じで作っていたのだけど、例外処理をいくつか作っているうちに、$uploadを操作しないままオブジェクトを書き込むことになっていた。

まあ、変数を兼用したのがそもそも良くないような気がするので、ファイルのアップロードをしたい時は、変数を別に作るというか、フォームを作成するときに名前を変更して作っておくほうが良いかもしれない。
