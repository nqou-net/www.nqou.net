---
title: "削除したファイルを復活させたい！git restore と git checkout の使い分け"
draft: true
tags:
- "git"
- "git-restore"
- "git-checkout"
- "file-recovery"
- "troubleshooting"
description: "誤って削除・変更したファイルの復元方法を徹底解説。Git 2.23で導入されたrestoreコマンドと従来のcheckoutの違い、特定バージョンへの復元、削除済みファイルの発見方法まで、ファイル復旧の全技術を網羅します。"
---

## ファイル復元の新旧コマンド比較

「このファイル、間違えて削除しちゃった！」「さっきの変更、やっぱり戻したい…」。こんな時に頼りになるのがGitの復元機能です。

### git restore の登場背景

Git 2.23（2019年8月リリース）で、`git restore`と`git switch`が導入されました。それまで`git checkout`が担っていた複数の役割を分離し、より直感的に使えるようにしたのが目的です。

### checkout との役割分担

| コマンド | 主な用途 |
|---------|---------|
| `git restore` | ファイルの復元 |
| `git switch` | ブランチの切り替え |
| `git checkout` | 両方（レガシー） |

**推奨**: 新しいプロジェクトでは`restore`と`switch`を使いましょう。ただし、古いGitバージョンでは`checkout`が必要です。

## 作業ディレクトリのファイルを復元

### git restore <file> の基本

最もシンプルな使い方は、変更したファイルを最後のコミット状態に戻すことです。

```bash
# ファイルの変更を取り消す
git restore README.md

# 複数ファイルを一度に復元
git restore src/app.js src/utils.js

# カレントディレクトリ以下すべて
git restore .
```

**注意**: この操作は取り消せません。ワーキングツリーの変更が完全に失われます。

### 特定コミットから復元（--source）

過去のコミットからファイルを復元できます。

```bash
# 3つ前のコミットから復元
git restore --source=HEAD~3 config.yml

# 特定のコミットハッシュから復元
git restore --source=abc1234 src/database.js

# タグを指定
git restore --source=v1.2.0 package.json
```

### checkout との比較

同じことを`checkout`でやると：

```bash
# 新しい方法
git restore README.md

# 古い方法
git checkout -- README.md  # --が必要
```

`--`はブランチ名とファイル名を区別するためのもので、restoreでは不要です。

## ステージングエリアの操作

### git restore --staged で unstage

`git add`でステージングしたファイルを取り消します。

```bash
# ファイルをステージング
git add feature.js

# ステージングを取り消す（ファイル内容は保持）
git restore --staged feature.js

# すべてのステージングを取り消し
git restore --staged .
```

これは`git reset HEAD <file>`と同じ効果ですが、より明示的です。

### ワーキングツリーとステージング両方を操作

```bash
# ステージングとワーキングツリー両方から変更を削除
git restore --staged --worktree file.txt

# 短縮形
git restore -SW file.txt
```

## 削除されたファイルを探して復元

ファイルがいつ削除されたか分からない場合の手順です。

### git log -- <path> で履歴を辿る

```bash
# 削除されたファイルの履歴を探す
git log --all --full-history -- path/to/deleted-file.txt

# より詳しく（diff付き）
git log --all --full-history --diff-filter=D -- path/to/deleted-file.txt
```

`--diff-filter=D`は削除(Deleted)されたコミットのみを表示します。

### git rev-list で削除コミットを特定

```bash
# ファイルを削除したコミットを見つける
git rev-list -n 1 HEAD -- path/to/deleted-file.txt

# そのコミットの1つ前から復元
git restore --source=<commit>^ -- path/to/deleted-file.txt
```

### 実践例

```bash
# 1. ファイルがいつ削除されたか調査
git log --all --full-history --oneline -- src/legacy.js
# 出力: abc1234 Remove legacy code

# 2. 削除される直前の状態を確認
git show abc1234^:src/legacy.js

# 3. ファイルを復元
git restore --source=abc1234^ -- src/legacy.js

# 4. 復元したファイルをステージング
git add src/legacy.js
```

## ディレクトリ単位での復元

```bash
# ディレクトリごと復元
git restore src/components/

# 特定のコミットからディレクトリ復元
git restore --source=v1.0.0 -- config/
```

再帰的にディレクトリ内のすべてのファイルが復元されます。

## よくある復元シナリオ

### シナリオ1: マージ前の状態に戻したい

```bash
# 現在のブランチを特定のコミットの状態に戻す
git restore --source=abc1234 .

# または、そのコミットにリセット
git reset --hard abc1234
```

### シナリオ2: 数日前のバージョンに戻したい

```bash
# 2日前の状態を確認
git log --since="2 days ago" --until="1 day ago" --oneline

# そのコミットから復元
git restore --source=def5678 specific-file.js
```

### シナリオ3: 間違えて削除したファイルを即座に復元

```bash
# ファイルを削除してしまった直後
rm important.txt

# まだコミットしていなければ簡単に復元
git restore important.txt
```

## リモートから削除されたファイルを復元

ローカルには無いが、リモートにあるファイルを取得する場合：

```bash
# リモートの最新状態を取得
git fetch origin

# リモートブランチから復元
git restore --source=origin/main -- path/to/file.txt
```

## トラブルシューティング

### 復元したいファイルが見つからない

```bash
# 全ブランチから探す
git log --all --full-history -- "**/*filename*"

# ファイル名の一部で検索
git log --all --full-history --name-only | grep "pattern"
```

### 復元後にコンフリクトが発生

```bash
# ファイルを復元したがコンフリクト
git restore --source=abc1234 -- file.txt

# コンフリクトマーカーを確認して手動で解決
vim file.txt

# 解決後にステージング
git add file.txt
```

## 新旧コマンド対応表

| 操作 | 新しい方法 | 古い方法 |
|------|-----------|---------|
| ファイル復元 | `git restore file.txt` | `git checkout -- file.txt` |
| ステージング取り消し | `git restore --staged file.txt` | `git reset HEAD file.txt` |
| 特定コミットから復元 | `git restore --source=abc1234 file.txt` | `git checkout abc1234 -- file.txt` |

## まとめ

ファイル復元のベストプラクティス：

- **Git 2.23以降**: `git restore`を使用（より明確）
- **古いGit**: `git checkout --`を使用
- **削除ファイル探索**: `git log --all --full-history -- <path>`
- **ステージング取り消し**: `git restore --staged`

誤ってファイルを変更・削除しても、Gitがあれば大抵の場合は復元可能です。ただし、**コミットしていない変更は復元できない**ため、こまめなコミットが重要です。まずは安全な環境で練習して、操作に慣れておきましょう。
