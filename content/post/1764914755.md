---
title: "GitHub Copilot エージェントパネル入門 - 第4回: エージェント設定ファイルの詳細"
description: "エージェント設定ファイルの高度な機能を解説。パラメータ、環境変数、依存関係、バージョニングなど実践的な設定方法を学ぶ"
date: 2025-12-05T15:00:00+09:00
draft: true
tags:
  - GitHub
  - Copilot
  - Agent Panel
  - 設定ファイル
  - YAML
image: /favicon.png
---

## はじめに

[@nqounet](https://x.com/nqounet)です。

第4回では、エージェント設定ファイルの高度な機能を詳しく解説します。パラメータ化、環境変数、依存関係管理など、実践的な設定方法を学びましょう。

前回のおさらい：プロンプトエンジニアリングの基礎として、Few-Shot Learning、Chain of Thought、出力制御を学びました。

## エージェント設定ファイルの全体構造

完全な設定ファイルの例：

```markdown
---
# 基本情報
name: advanced-code-reviewer
description: 高度なコードレビューエージェント
version: 2.1.0
author: nqounet <nqounet@example.com>

# メタデータ
tags:
  - code-review
  - quality
  - security
category: development

# パラメータ定義
parameters:
  - name: strictness
    type: string
    default: "medium"
    required: false
    description: チェックの厳格さ
    options:
      - "low"
      - "medium"
      - "high"
      - "paranoid"
  
  - name: language
    type: string
    required: true
    description: 対象言語
    options:
      - "javascript"
      - "typescript"
      - "python"
      - "java"
  
  - name: maxIssues
    type: integer
    default: 20
    min: 1
    max: 100
    description: 報告する問題の最大数

  - name: includeStyle
    type: boolean
    default: true
    description: コードスタイルもチェックする

# 依存関係
dependencies:
  agents:
    - name: eslint-checker
      version: "^1.0.0"
    - name: security-scanner
      version: ">=2.0.0"
  
  tools:
    - name: ast-parser
      version: "1.5.0"

# 環境変数
env:
  - name: OPENAI_API_KEY
    required: true
    description: OpenAI API キー
  - name: CUSTOM_RULES_PATH
    required: false
    default: "./.agent-rules"

# 実行設定
execution:
  timeout: 60000  # ミリ秒
  maxConcurrency: 3
  retryOnError: true
  maxRetries: 2

# トリガー条件
triggers:
  filePatterns:
    - "**/*.js"
    - "**/*.ts"
  excludePatterns:
    - "node_modules/**"
    - "dist/**"
  events:
    - "on-save"
    - "on-demand"

---

# エージェントの本体（Markdown部分）
（以下、プロンプト定義）
```

## パラメータの詳細設定

### パラメータの型とバリデーション

```yaml
parameters:
  # 文字列型（選択肢あり）
  - name: mode
    type: string
    required: true
    options:
      - "quick"
      - "standard"
      - "thorough"
    description: レビューモード
    
  # 文字列型（自由入力）
  - name: customRule
    type: string
    required: false
    pattern: "^[a-zA-Z0-9-_]+$"  # 正規表現
    description: カスタムルール名
    
  # 整数型
  - name: maxDepth
    type: integer
    default: 5
    min: 1
    max: 10
    description: 解析の深さ
    
  # 浮動小数点型
  - name: threshold
    type: float
    default: 0.8
    min: 0.0
    max: 1.0
    description: 検出閾値
    
  # ブール型
  - name: verbose
    type: boolean
    default: false
    description: 詳細ログ出力
    
  # 配列型
  - name: targets
    type: array
    items:
      type: string
    default: ["src", "lib"]
    description: チェック対象ディレクトリ
    
  # オブジェクト型
  - name: config
    type: object
    properties:
      enableCache:
        type: boolean
        default: true
      cacheSize:
        type: integer
        default: 100
    description: キャッシュ設定
```

### パラメータのグルーピング

```yaml
parameters:
  # 基本設定グループ
  - group: basic
    parameters:
      - name: language
        type: string
        required: true
      - name: framework
        type: string
        required: false
  
  # 詳細設定グループ
  - group: advanced
    parameters:
      - name: customRules
        type: array
        items:
          type: string
      - name: pluginConfig
        type: object
```

### 条件付きパラメータ

```yaml
parameters:
  - name: enableSecurity
    type: boolean
    default: false
    
  # enableSecurity が true の場合のみ有効
  - name: securityLevel
    type: string
    dependsOn:
      parameter: enableSecurity
      value: true
    options:
      - "basic"
      - "advanced"
      - "paranoid"
```

## 環境変数とシークレット管理

### 環境変数の定義

```yaml
env:
  # 必須の環境変数
  - name: API_KEY
    required: true
    description: 外部APIのキー
    type: secret  # シークレットとしてマスク
    
  # オプションの環境変数
  - name: API_ENDPOINT
    required: false
    default: "https://api.example.com"
    description: APIエンドポイント
    
  # 検証パターン付き
  - name: PROJECT_ID
    required: true
    pattern: "^[a-z0-9-]{3,20}$"
    description: プロジェクトID
```

### 環境変数の使用

```markdown
# エージェント本体で環境変数を使用

## API連携設定

以下の環境変数を使用します：
- API_KEY: `${API_KEY}`（マスク表示）
- API_ENDPOINT: `${API_ENDPOINT}`

## 実行時の注意

環境変数が設定されていない場合、以下のエラーメッセージを表示：

\`\`\`
Error: Required environment variable 'API_KEY' is not set.
Please set it in your GitHub secrets or .env file.
\`\`\`
```

### シークレットの安全な管理

```markdown
# セキュリティのベストプラクティス

## ❌ やってはいけないこと
\`\`\`yaml
env:
  - name: API_KEY
    default: "sk-1234567890abcdef"  # ハードコードは絶対NG！
\`\`\`

## ✅ 正しい方法

### 方法1: GitHub Secretsを使用
1. リポジトリ設定 → Secrets → New repository secret
2. Name: `API_KEY`
3. Value: 実際のAPIキー

### 方法2: ローカル環境変数
\`\`\`bash
export API_KEY="your-secret-key"
\`\`\`

### 方法3: .env ファイル（gitignoreに追加）
\`\`\`env
# .env（このファイルは.gitignoreに追加）
API_KEY=your-secret-key
API_ENDPOINT=https://api.example.com
\`\`\`
```

## 依存関係の管理

### エージェント間の依存

```yaml
dependencies:
  agents:
    # 特定バージョン
    - name: syntax-checker
      version: "1.5.0"
      required: true
    
    # バージョン範囲（セマンティックバージョニング）
    - name: style-formatter
      version: "^2.0.0"  # 2.0.0 <= version < 3.0.0
      required: true
    
    # 最小バージョン
    - name: security-scanner
      version: ">=1.2.0"
      required: false
    
    # マイナーバージョン固定
    - name: test-generator
      version: "~3.1.0"  # 3.1.0 <= version < 3.2.0
      required: false
```

### ツール依存関係

```yaml
dependencies:
  tools:
    # 外部ツール
    - name: eslint
      version: "^8.0.0"
      installCommand: "npm install -g eslint"
      checkCommand: "eslint --version"
    
    - name: prettier
      version: "^3.0.0"
      installCommand: "npm install -g prettier"
    
    # システムツール
    - name: git
      version: ">=2.30.0"
      checkCommand: "git --version"
  
  # プログラミング言語のバージョン
  runtimes:
    - name: node
      version: ">=16.0.0"
    - name: python
      version: "^3.9"
```

### 依存関係の検証

```markdown
## 依存関係チェック

エージェント起動時に以下をチェックします：

\`\`\`
[INFO] Checking dependencies...
[OK]   syntax-checker v1.5.0 (required: 1.5.0)
[OK]   style-formatter v2.1.3 (required: ^2.0.0)
[WARN] security-scanner not found (optional)
[OK]   eslint v8.54.0 (required: ^8.0.0)
[ERROR] node v14.17.0 (required: >=16.0.0)

[ERROR] Dependency check failed. Please update Node.js to v16 or later.
\`\`\`
```

## バージョニングと互換性

### セマンティックバージョニング

```yaml
version: 2.1.0
# メジャー.マイナー.パッチ
# 2: メジャーバージョン（破壊的変更）
# 1: マイナーバージョン（後方互換性のある機能追加）
# 0: パッチバージョン（バグ修正）

# バージョン履歴
versionHistory:
  - version: 2.1.0
    date: 2025-01-15
    changes:
      - "新機能: TypeScript 5.x サポート"
      - "改善: パフォーマンス向上"
  
  - version: 2.0.0
    date: 2024-12-01
    changes:
      - "破壊的変更: パラメータ構造の変更"
      - "新機能: セキュリティスキャン統合"
    breaking: true
    migration: |
      ## v1.x から v2.x への移行
      
      ### パラメータ名の変更
      - `check_style` → `includeStyle`
      - `max_errors` → `maxIssues`
  
  - version: 1.5.2
    date: 2024-11-15
    changes:
      - "修正: 日本語コメントの誤検出"
```

### 互換性マトリックス

```yaml
compatibility:
  # VS Code バージョン
  vscode:
    min: "1.85.0"
    max: "1.95.0"
    recommended: "1.90.0"
  
  # GitHub Copilot バージョン
  copilot:
    min: "1.120.0"
  
  # OS
  os:
    - windows
    - linux
    - macos
  
  # 他のエージェントとの互換性
  agents:
    - name: "security-scanner"
      compatible: ["^2.0.0", "^3.0.0"]
      incompatible: ["1.x"]
```

## 実行設定の詳細

### タイムアウトとリトライ

```yaml
execution:
  # タイムアウト（ミリ秒）
  timeout: 60000  # 60秒
  
  # 同時実行数
  maxConcurrency: 5
  
  # リトライ設定
  retryOnError: true
  maxRetries: 3
  retryDelay: 1000  # 1秒
  retryBackoff: "exponential"  # or "linear"
  
  # キャッシュ
  cache:
    enabled: true
    ttl: 3600  # 1時間（秒）
    strategy: "content-hash"  # or "file-timestamp"
  
  # メモリ制限
  maxMemoryMB: 512
```

### トリガーとフィルタ

```yaml
triggers:
  # ファイルパターン（glob）
  filePatterns:
    - "src/**/*.ts"
    - "src/**/*.tsx"
    - "lib/**/*.js"
  
  # 除外パターン
  excludePatterns:
    - "node_modules/**"
    - "dist/**"
    - "**/*.test.ts"
    - "**/*.spec.ts"
  
  # ファイルサイズ制限
  maxFileSizeKB: 500
  
  # 実行イベント
  events:
    - "on-save"        # ファイル保存時
    - "on-demand"      # 手動実行
    - "on-commit"      # コミット前
    - "on-pr-review"   # PR作成時
  
  # 実行条件
  conditions:
    - type: "file-changed"
      paths: ["src/**"]
    - type: "branch-match"
      pattern: "^(main|develop|feature/.*)$"
```

## カスタムフィールドの活用

### メタデータの拡張

```yaml
# カスタムメタデータ
metadata:
  # ライセンス情報
  license: MIT
  
  # サポート情報
  support:
    email: support@example.com
    documentation: https://docs.example.com/agent
    issues: https://github.com/org/repo/issues
  
  # パフォーマンス情報
  performance:
    averageExecutionTime: "2.5s"
    maxFileSize: "500KB"
    recommendedConcurrency: 3
  
  # 使用統計（プライバシー配慮）
  analytics:
    enabled: false
    anonymousOnly: true
```

### カスタム検証ルール

```yaml
validation:
  # カスタムルールセット
  ruleSets:
    - name: "company-standards"
      path: "./.company-rules.json"
      required: false
    
    - name: "project-specific"
      path: "./project-rules.yml"
      required: true
  
  # 検証レベル
  level: "strict"  # or "normal", "lenient"
  
  # カスタムバリデータ
  customValidators:
    - name: "license-header-check"
      script: "./validators/license-check.js"
    - name: "naming-convention"
      script: "./validators/naming.js"
```

## 設定ファイルのテンプレート

### 基本テンプレート

```yaml
---
name: my-agent
description: エージェントの説明
version: 1.0.0

parameters:
  - name: mode
    type: string
    default: "standard"
    options: ["quick", "standard", "thorough"]

execution:
  timeout: 30000

triggers:
  filePatterns:
    - "**/*.js"
  events:
    - "on-demand"
---

# エージェントの役割と指示
（ここにプロンプトを記述）
```

### 高度なテンプレート

```yaml
---
name: production-ready-agent
description: プロダクション対応エージェント
version: 2.0.0
author: Your Team <team@example.com>

tags: [quality, security, production]

parameters:
  - name: environment
    type: string
    required: true
    options: ["development", "staging", "production"]
    description: 実行環境
  
  - name: strictness
    type: string
    default: "high"
    dependsOn:
      parameter: environment
      value: "production"

dependencies:
  agents:
    - name: security-scanner
      version: "^2.0.0"
  tools:
    - name: eslint
      version: "^8.0.0"

env:
  - name: API_KEY
    required: true
    type: secret

execution:
  timeout: 60000
  retryOnError: true
  maxRetries: 2

triggers:
  filePatterns:
    - "src/**/*.{js,ts}"
  excludePatterns:
    - "**/*.test.*"
  events:
    - "on-demand"
    - "on-pr-review"

metadata:
  license: MIT
  documentation: https://docs.example.com
---

# エージェント本体
（プロンプト定義）
```

## 動作確認チェックリスト

- [ ] パラメータの型とバリデーションを設定した
- [ ] 環境変数を安全に管理する方法を理解した
- [ ] 依存関係を適切に定義した
- [ ] バージョニングのルールを理解した
- [ ] トリガーとフィルタを設定した
- [ ] カスタムフィールドを活用した
- [ ] 設定ファイルのテンプレートを作成した

## トラブルシューティング

### 設定ファイルのバリデーションエラー

```bash
# エージェントパネルのログで確認
View → Output → GitHub Copilot Agent Panel

# よくあるエラー
[ERROR] Invalid parameter type: expected 'string', got 'number'
→ パラメータの型定義を確認

[ERROR] Unknown field: 'customField'
→ フィールド名のスペルミスまたは非対応フィールド

[ERROR] Dependency version conflict
→ 依存エージェントのバージョンを確認
```

## 次回予告

第5回では、複数エージェントの協調動作を学びます：

- エージェント間のデータ受け渡し
- パイプライン構築
- 並列実行と直列実行
- エラーハンドリング

## まとめ

この記事では、エージェント設定ファイルの高度な機能を学びました：

1. **パラメータの詳細設定**
   - 型とバリデーション
   - グルーピングと条件付きパラメータ

2. **環境変数とシークレット管理**
   - 安全な管理方法
   - GitHub Secretsの活用

3. **依存関係管理**
   - エージェント間の依存
   - ツールとランタイムの要件

4. **バージョニングと互換性**
   - セマンティックバージョニング
   - 互換性マトリックス

次回は、これらの知識を活かして複数のエージェントを協調動作させる方法を学びます！

## 参考リンク

- [Semantic Versioning](https://semver.org/)
- [YAML Specification](https://yaml.org/spec/)
- [GitHub Secrets Documentation](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
