---
title: "GitHub Copilot エージェントパネル入門 - 第6回: ツール統合とAPI連携"
description: "エージェントと外部ツールやAPIを連携させる方法を解説。REST API、Webhook、CLIツール統合の実践的な手法を学ぶ"
date: 2025-12-07T15:00:00+09:00
draft: true
tags:
  - GitHub
  - Copilot
  - Agent Panel
  - API
  - 統合
image: /favicon.png
---

## はじめに

[@nqounet](https://x.com/nqounet)です。

第6回では、エージェントと外部ツールやAPIを連携させる方法を学びます。これにより、エージェントの機能を大幅に拡張できます。

## 外部ツールの統合

### CLIツールの実行

```markdown
---
name: cli-tool-integrator
version: 1.0.0
---

# CLI ツール統合エージェント

## ツールの実行

以下のCLIツールを実行できます：

### ESLint実行
\`\`\`bash
eslint --format json ${files} > eslint-report.json
\`\`\`

### Prettier実行
\`\`\`bash
prettier --check ${files} --write
\`\`\`

### Git操作
\`\`\`bash
git diff --name-only ${branch}
git log --oneline -n 10
\`\`\`

## 実行結果の解析

ツールの出力をJSONとして解析し、構造化されたレポートを生成します。
```

### 設定ファイルでのツール定義

```yaml
---
name: tool-runner
version: 1.0.0

tools:
  - name: eslint
    command: "npx eslint"
    args:
      - "--format"
      - "json"
      - "${input.files}"
    outputFormat: "json"
    
  - name: prettier
    command: "npx prettier"
    args:
      - "--check"
      - "${input.files}"
    outputFormat: "text"
    
  - name: git-diff
    command: "git"
    args:
      - "diff"
      - "--name-only"
      - "${parameters.branch}"
    outputFormat: "lines"
---
```

## REST API連携

### API呼び出しの基本

```markdown
---
name: api-caller
version: 1.0.0

apis:
  - name: github-api
    baseURL: "https://api.github.com"
    authentication:
      type: "bearer"
      token: "${env.GITHUB_TOKEN}"
    
  - name: openai-api
    baseURL: "https://api.openai.com/v1"
    authentication:
      type: "bearer"
      token: "${env.OPENAI_API_KEY}"
---

# API連携エージェント

## GitHub API の使用

### プルリクエスト情報取得
\`\`\`http
GET /repos/${owner}/${repo}/pulls/${number}
Authorization: Bearer ${GITHUB_TOKEN}
\`\`\`

### コメント投稿
\`\`\`http
POST /repos/${owner}/${repo}/issues/${number}/comments
Authorization: Bearer ${GITHUB_TOKEN}
Content-Type: application/json

{
  "body": "自動レビュー結果:\\n${review_result}"
}
\`\`\`

## OpenAI API の使用

### コード分析リクエスト
\`\`\`http
POST /chat/completions
Authorization: Bearer ${OPENAI_API_KEY}
Content-Type: application/json

{
  "model": "gpt-4",
  "messages": [
    {"role": "system", "content": "You are a code reviewer."},
    {"role": "user", "content": "${code}"}
  ]
}
\`\`\`
```

### レスポンス処理

```markdown
## APIレスポンスの処理

### 成功時
\`\`\`json
{
  "status": 200,
  "data": {
    "id": 12345,
    "title": "Fix bug in user authentication",
    "state": "open"
  }
}
\`\`\`

処理：
1. ステータスコードを確認（200-299が成功）
2. データを抽出
3. 次のステップに渡す

### エラー時
\`\`\`json
{
  "status": 404,
  "error": {
    "message": "Not Found",
    "documentation_url": "https://docs.github.com/..."
  }
}
\`\`\`

処理：
1. エラーをログに記録
2. ユーザーに通知
3. フォールバック処理を実行
```

## Webhook設定

### Webhookの受信

```yaml
---
name: webhook-listener
version: 1.0.0

webhooks:
  - name: github-push
    events:
      - "push"
      - "pull_request"
    url: "/webhooks/github"
    secret: "${env.WEBHOOK_SECRET}"
    
  - name: ci-complete
    events:
      - "workflow_run"
    url: "/webhooks/ci"
---
```

### イベント処理

```markdown
## Webhookイベント処理

### プッシュイベント
\`\`\`json
{
  "event": "push",
  "ref": "refs/heads/main",
  "commits": [
    {
      "id": "abc123",
      "message": "Fix authentication",
      "added": ["src/auth.ts"],
      "modified": ["src/user.ts"]
    }
  ]
}
\`\`\`

処理フロー：
1. 変更ファイルを抽出
2. 該当ファイルのみレビュー
3. 結果をコミットステータスとして投稿

### PRイベント
\`\`\`json
{
  "event": "pull_request",
  "action": "opened",
  "pull_request": {
    "number": 42,
    "title": "Add new feature",
    "user": {"login": "developer"},
    "changed_files": 5
  }
}
\`\`\`

処理フロー：
1. PRの詳細を取得
2. 変更ファイルを分析
3. レビューコメントを投稿
```

## サードパーティサービス連携

### Slack通知

```yaml
---
name: slack-notifier
version: 1.0.0

integrations:
  slack:
    webhookURL: "${env.SLACK_WEBHOOK_URL}"
    channel: "#dev-notifications"
    username: "Copilot Agent"
    icon: ":robot_face:"
---
```

```markdown
## Slack通知の送信

### 通知形式
\`\`\`json
{
  "channel": "#dev-notifications",
  "username": "Copilot Agent",
  "icon_emoji": ":robot_face:",
  "attachments": [
    {
      "color": "good",
      "title": "Code Review Complete",
      "text": "15 files reviewed, 3 issues found",
      "fields": [
        {"title": "Critical", "value": "0", "short": true},
        {"title": "Warnings", "value": "3", "short": true}
      ]
    }
  ]
}
\`\`\`
```

### メール通知

```yaml
integrations:
  email:
    smtp:
      host: "smtp.gmail.com"
      port: 587
      secure: true
      auth:
        user: "${env.EMAIL_USER}"
        pass: "${env.EMAIL_PASS}"
    from: "copilot-agent@example.com"
    templates:
      - name: "review-complete"
        subject: "Code Review Complete for PR #${pr.number}"
        body: "review-complete.html"
```

## 実践例：CI/CD統合

```yaml
---
name: ci-cd-integration
version: 1.0.0

workflow:
  type: sequential
  
  steps:
    # 1. GitHub APIでPR情報取得
    - agent: github-pr-fetcher
      api:
        method: GET
        url: "https://api.github.com/repos/${repo}/pulls/${pr}"
      output: pr_info
    
    # 2. 変更ファイルを取得
    - agent: file-fetcher
      api:
        method: GET
        url: "https://api.github.com/repos/${repo}/pulls/${pr}/files"
      output: changed_files
    
    # 3. 並列でツール実行
    - type: parallel
      steps:
        - tool:
            name: eslint
            files: "${changed_files}"
          output: eslint_result
        
        - tool:
            name: prettier
            files: "${changed_files}"
          output: prettier_result
    
    # 4. 結果をGitHubに投稿
    - agent: github-commenter
      api:
        method: POST
        url: "https://api.github.com/repos/${repo}/pulls/${pr}/reviews"
        body:
          event: "COMMENT"
          body: "${aggregated_results}"
    
    # 5. Slack通知
    - agent: slack-notifier
      webhook:
        url: "${env.SLACK_WEBHOOK}"
        payload:
          text: "PR #${pr} review complete"
---
```

## セキュリティのベストプラクティス

### API キーの管理

```markdown
## ❌ 絶対にやってはいけないこと

\`\`\`yaml
env:
  - name: API_KEY
    default: "sk-1234567890abcdef"  # ハードコードは絶対NG！
\`\`\`

## ✅ 正しい方法

### GitHub Secrets
1. Settings → Secrets and variables → Actions
2. New repository secret
3. Name: `OPENAI_API_KEY`
4. Value: (実際のキー)

### 環境変数
\`\`\`bash
export OPENAI_API_KEY="sk-..."
export GITHUB_TOKEN="ghp_..."
\`\`\`

### .env ファイル（.gitignoreに追加）
\`\`\`env
OPENAI_API_KEY=sk-...
GITHUB_TOKEN=ghp_...
SLACK_WEBHOOK=https://hooks.slack.com/...
\`\`\`
```

### レート制限対策

```yaml
apis:
  - name: github-api
    rateLimit:
      requests: 5000
      period: "1h"
      strategy: "exponential-backoff"
      retryAfter: true
    
  - name: openai-api
    rateLimit:
      requests: 60
      period: "1m"
      strategy: "queue"
```

## 動作確認チェックリスト

- [ ] CLIツールを統合して実行した
- [ ] REST APIを呼び出して結果を取得した
- [ ] Webhookを設定してイベントを受信した
- [ ] Slack/メール通知を実装した
- [ ] API キーを安全に管理した
- [ ] レート制限対策を実装した
- [ ] エラーハンドリングを実装した

## 次回予告

第7回では、ワークフロー自動化の実践を学びます：

- Git操作の自動化
- プルリクエスト自動作成
- ブランチ戦略との統合
- CI/CDパイプラインの構築

## まとめ

この記事では、ツール統合とAPI連携について学びました：

1. **外部ツールの統合**
   - CLIツールの実行
   - 出力の解析と処理

2. **REST API連携**
   - GitHub API、OpenAI APIの使用
   - レスポンス処理

3. **Webhook設定**
   - イベント受信と処理
   - リアルタイム連携

4. **セキュリティ**
   - API キーの安全な管理
   - レート制限対策

次回は、これらを組み合わせて実践的なワークフロー自動化を実現します！
