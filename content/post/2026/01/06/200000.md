---
title: '第4回-レポートを出力しよう - レポート生成ツールを作ってみよう'
iso8601: 2026-01-06T20:00:00+09:00
draft: false
tags:
  - perl
  - moo
  - text-output
  - report-formatting
  - oop-class
description: テキスト形式でレポートを出力するReportWriterクラスをMooで実装。フォーマット済み文字列の生成方法を紹介します。
image: /favicon.png
---

[@nqounet](https://x.com/nqounet)です。

「レポート生成ツールを作ってみよう」シリーズの第4回です。

前回は、読み込んだデータを加工する `DataProcessor` クラスを作成しました。まだ読んでいない方は、先にこちらをご覧ください。

{{< linkcard "/2026/01/06/190000/" >}}

今回は、テキスト形式でレポートを出力する `ReportWriter` クラスを作成します。

## 今回のゴール

今回は、レポートの出力処理を専用のクラスに分離します。出力形式をクラスとして独立させることで、将来的に異なる形式（HTML、JSONなど）への拡張が容易になります。

新しい概念は「出力フォーマット」です。データをどのような形式で表示するかをクラスとして定義します。

## ReportWriterクラスの作成

レポートをテキスト形式で出力する `ReportWriter` クラスを作成します。

**言語・バージョン**: Perl v5.36以降  
**外部依存**: Moo

```perl
package ReportWriter {
    use Moo;
    use v5.36;

    has title => (is => 'ro', default => '成績レポート');

    sub write($self, $processed_data) {
        my @lines;

        push @lines, "=== " . $self->title . " ===";
        push @lines, '';

        for my $row (@{$processed_data->{records}}) {
            push @lines, "$row->{name}: $row->{score}点";
        }

        push @lines, '';
        push @lines, sprintf("平均点: %.1f点", $processed_data->{average});
        push @lines, "受験者数: $processed_data->{count}名";
        push @lines, '';
        push @lines, '=== レポート終了 ===';

        return join("\n", @lines);
    }
}
```

このクラスの特徴は以下のとおりです。

- `title` 属性でレポートのタイトルをカスタマイズできる
- `write` メソッドで加工済みデータを受け取り、フォーマット済み文字列を返す
- 各行を配列に格納し、最後に改行で結合する

## 完成コード

前回のスクリプトに `ReportWriter` クラスを追加します。

**言語・バージョン**: Perl v5.36以降  
**外部依存**: Moo, List::Util（コアモジュール）

```perl
#!/usr/bin/env perl
use v5.36;
use Moo;
use List::Util qw(sum);

# DataReaderクラス
package DataReader {
    use Moo;
    use v5.36;

    has file_path => (is => 'ro', required => 1);

    sub read($self) {
        open my $fh, '<', $self->file_path
            or die "Cannot open file: $!";

        my $header_line = <$fh>;
        chomp $header_line;
        my @headers = split /,/, $header_line;

        my @data;
        while (my $line = <$fh>) {
            chomp $line;
            my @values = split /,/, $line;
            my %row;
            for my $i (0 .. $#headers) {
                $row{$headers[$i]} = $values[$i];
            }
            push @data, \%row;
        }

        close $fh;
        return \@data;
    }
}

# DataProcessorクラス
package DataProcessor {
    use Moo;
    use v5.36;
    use List::Util qw(sum);

    sub process($self, $data) {
        my @sorted = sort { $b->{score} <=> $a->{score} } @$data;

        my $total = sum(map { $_->{score} } @sorted);
        my $average = $total / scalar(@sorted);

        return {
            records => \@sorted,
            average => $average,
            count   => scalar(@sorted),
        };
    }
}

# ReportWriterクラス
package ReportWriter {
    use Moo;
    use v5.36;

    has title => (is => 'ro', default => '成績レポート');

    sub write($self, $processed_data) {
        my @lines;

        push @lines, "=== " . $self->title . " ===";
        push @lines, '';

        for my $row (@{$processed_data->{records}}) {
            push @lines, "$row->{name}: $row->{score}点";
        }

        push @lines, '';
        push @lines, sprintf("平均点: %.1f点", $processed_data->{average});
        push @lines, "受験者数: $processed_data->{count}名";
        push @lines, '';
        push @lines, '=== レポート終了 ===';

        return join("\n", @lines);
    }
}

# メイン処理
package main;

my $reader = DataReader->new(file_path => 'data.csv');
my $raw_data = $reader->read;

my $processor = DataProcessor->new;
my $processed = $processor->process($raw_data);

my $writer = ReportWriter->new(title => '成績レポート');
my $report = $writer->write($processed);

say $report;
```

**実行方法**:
```bash
perl report.pl
```

**出力例**:
```
=== 成績レポート ===

鈴木花子: 92点
田中太郎: 85点
佐藤一郎: 78点

平均点: 85.0点
受験者数: 3名

=== レポート終了 ===
```

出力結果は前回と同じですが、メイン処理がよりシンプルになりました。`say $report;` の1行で出力が完了しています。

## 3つのクラスが揃った

ここまでで、レポート生成に必要な3つのクラスが揃いました。

- `DataReader`: CSVファイルからデータを読み込む
- `DataProcessor`: データを集計・整形する
- `ReportWriter`: テキスト形式でレポートを出力する

それぞれのクラスが1つの責務を持ち、独立して動作します。

## まとめ

- テキスト形式でレポートを出力する `ReportWriter` クラスを作成した
- 出力処理を専用クラスに分離することで、責務が明確になった
- レポート生成に必要な3つのクラスが揃った

## 次回予告

次回は、3つのクラスを連携させてレポートを生成するメインスクリプトを作成します。クラスが増えてきたことで、呼び出しが少し複雑になってきたことに気づくでしょう。お楽しみに。

{{< linkcard "/2026/01/06/210000/" >}}
