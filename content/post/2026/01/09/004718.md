---
date: 2026-01-09T00:47:18+09:00
description: 間違ったオブジェクトを設定してバグが発生…。isaを使った型チェックで、実行時エラーを未然に防ぐ方法を学びます。
draft: false
epoch: 1767887238
image: /public_images/2026/strategy-pattern-series-image.jpg
iso8601: 2026-01-09T00:47:18+09:00
tags:
  - perl
  - moo
  - type-check
  - validation
title: '第7回-isaでバグを防ごう - Mooを使ってデータエクスポーターを作ってみよう'
---

[@nqounet](https://x.com/nqounet)です。

前回は、`is => 'rw'`を使ってエクスポーターを動的に切り替えられるようにしました。

{{< linkcard "https://www.nqou.net/2026/01/09/004515/" >}}

しかし、間違ったオブジェクトを設定できてしまう問題がありましたね。今回は、この問題を解決します。

## 問題の再確認

現在のコードでは、こんな間違いが起こり得ます。

```perl
# 文字列を設定してしまった
$data_exporter->exporter("これはエクスポーターではない");
$data_exporter->export_data(\@contacts);  # エラー！
```

問題: 設定時にはエラーにならない

```mermaid
flowchart TD
    DE[DataExporter]
    WRONG["これはエクスポーターではない<br/>(ただの文字列)"]
    DE -->|exporterに設定| WRONG
    DE -->|export_data を呼び出すと...| CALL[export_data 呼び出し]
    CALL --> ERROR["❌ エラー！<br/>Can't locate object method export"]
```

実行すると：

```
Can't locate object method "export" via package "これはエクスポーターではない"
```

問題は、`export_data`メソッドを呼び出したときに初めてエラーになることです。設定した時点でエラーになってくれれば、もっと早く問題に気づけます。

## isaを追加する

Mooの`isa`を使うと、バリデーション（検証）を追加できます。

```mermaid
flowchart TD
    A[オブジェクトを設定] --> B{ExporterRole を\n実装している?}
    B -->|Yes| C[✅ 設定成功]
    B -->|No| D[❌ エラー！\n設定時に即座に検出]
    
    style C fill:#dfd
    style D fill:#fdd
```

```perl
package DataExporter {
    use Moo;
    use v5.36;

    has exporter => (
        is       => 'rw',
        required => 1,
        isa => sub { # ExporterRoleを実装していることを検証する
            my $value = shift;
            die "exporter must does ExporterRole" unless $value->does('ExporterRole')
        },
    );

    sub export_data ($self, $data) {
        return $self->exporter->export($data);
    }
}
```

isaで検証することで、`exporter`属性には`ExporterRole`を実装したオブジェクトであることを保証できます。

## 型チェックが効く様子を確認

間違ったオブジェクトを設定しようとすると、設定した時点でエラーになります。

```perl
# 間違ったオブジェクトを設定しようとする
my $data_exporter = DataExporter->new(exporter => "文字列");
```

エラーメッセージ：

```
isa check for "exporter" failed: ...
```

これで、「設定時にエラーがわかる」ようになりました！

## 完成したコード

isaを追加した完成コードです。

```perl
#!/usr/bin/env perl
use v5.36;
use JSON::PP;

# ========================================
# ExporterRole - エクスポーターの約束
# ========================================
package ExporterRole {
    use Moo::Role;
    requires 'export';
}

# ========================================
# CsvExporterクラス
# ========================================
package CsvExporter {
    use Moo;
    use v5.36;
    with 'ExporterRole';

    sub export ($self, $data) {
        my $output = "name,email,phone\n";
        for my $contact (@$data) {
            $output .= "$contact->{name},$contact->{email},$contact->{phone}\n";
        }
        return $output;
    }
}

# ========================================
# JsonExporterクラス
# ========================================
package JsonExporter {
    use Moo;
    use v5.36;
    use JSON::PP;
    with 'ExporterRole';

    sub export ($self, $data) {
        return JSON::PP->new->pretty->encode($data);
    }
}

# ========================================
# DataExporterクラス（エクスポーター管理）
# ========================================
package DataExporter {
    use Moo;
    use v5.36;

    has exporter => (
        is       => 'rw',
        required => 1,
        isa => sub { # 型チェック追加
            my $value = shift;
            die "exporter must does ExporterRole" unless $value->does('ExporterRole')
        },
    );

    sub export_data ($self, $data) {
        return $self->exporter->export($data);
    }
}

# ========================================
# メイン処理
# ========================================
package main;

# アドレス帳データ
my @contacts = (
    { name => '田中太郎', email => 'tanaka@example.com', phone => '090-1234-5678' },
    { name => '鈴木花子', email => 'suzuki@example.com', phone => '080-2345-6789' },
    { name => '佐藤次郎', email => 'sato@example.com',   phone => '070-3456-7890' },
);

# 正しいエクスポーターを設定
my $data_exporter = DataExporter->new(exporter => CsvExporter->new);
say "=== CSV形式 ===";
print $data_exporter->export_data(\@contacts);

# JSON形式に切り替え（これもOK）
$data_exporter->exporter(JsonExporter->new);
say "\n=== JSON形式 ===";
print $data_exporter->export_data(\@contacts);

# 以下はエラーになる（コメントアウトして試してみてください）
# $data_exporter->exporter("文字列");  # エラー！
```

## isaのメリット

### 1. 早期発見

問題を設定時に発見できるため、デバッグが容易になります。

### 2. ドキュメント効果

コードを読むだけで「この属性にはExporterRoleを実装したオブジェクトが入る」とわかります。

### 3. 安全な動的切り替え

`is => 'rw'`で動的に切り替えても、型チェックが効くので安心です。

## まとめ

- isaを使うことで、Roleを実装しているかなどもチェックできます
- 間違ったオブジェクトを設定すると、設定時にエラーになります
- 早期にバグを発見でき、デバッグが容易になります
- コードのドキュメント効果も向上します

次回「[第8回-形式名から自動でエクスポーターを選ぼう](/2026/01/09/004921/)」では、形式名（"csv"、"json"など）から自動でエクスポーターを選ぶ機能を追加します。お楽しみに！
