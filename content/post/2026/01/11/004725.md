---
date: 2026-01-11T00:47:25+09:00
description: 翻訳エンジンの種類を「名前」で選び、LinguaBridge翻訳CLIが自動で適切なラッパーを組み立てる仕組みを作ります。CLIを再起動せずに差し替えられる軽いレジストリを用意します。
draft: false
epoch: 1768060045
image: /public_images/2026/adapter-pattern-series-image.jpg
iso8601: 2026-01-11T00:47:25+09:00
tags:
  - perl
  - moo
  - cli
  - translation
  - registry
title: '第4回-翻訳エンジンを名前で切り替えるレジストリ - LinguaBridge翻訳CLIで学ぶ設計入門'
---

[@nqounet](https://x.com/nqounet)です。

前回はフィルターを挟めるパイプラインを作りました。今回は「翻訳エンジンの選択」を名前で行い、CLIが適切なラッパーを用意する仕組みを作ります。

## 前回のおさらい / 次回の予告

{{< linkcard "/2026/01/11/004522/" >}}

{{< linkcard "/2026/01/11/004928/" >}}

## レジストリで差し替えを高速化

- エンジン名→生成クロージャの表を持ち、CLIはそれを呼び出して翻訳役を差し替えます。
- これにより、外部入力で「engine=legacy」などを受けても、CLIの本体コードは変更不要になります。
- 追加したいエンジンはレジストリに1行足すだけでOK。

```perl
my $translator = $self->registry->{$engine_name}->();
$self->{translator} = $translator;  # does TranslatorRole
```

## 完成したコード

```perl
#!/usr/bin/env perl
use v5.36;

# ==========================
# Roles
# ==========================
package TranslatorRole {
    use Moo::Role;
    requires 'translate';
}

# ==========================
# 翻訳役たち（簡易版）
# ==========================
package LinguaBridge::Translator::Echo {
    use Moo;
    use v5.36;
    with 'TranslatorRole';
    sub translate ($self, $text, $to, $from = 'ja') { "[${from}→${to}] $text" }
}

package LegacyTranslationAPI {
    use Moo;
    use v5.36;
    sub convert ($self, $args) { { result => "LEGACY[$args->{source}→$args->{target}]: $args->{text}" } }
}

package LinguaBridge::Translator::LegacyAdapter {
    use Moo;
    use v5.36;
    with 'TranslatorRole';
    has client => ( is => 'ro', required => 1 );
    sub translate ($self, $text, $to, $from = 'ja') {
        my $res = $self->client->convert({ text => $text, target => $to, source => $from });
        return $res->{result};
    }
}

# ==========================
# CLI本体（レジストリ付き）
# ==========================
package LinguaBridge::CLI {
    use Moo;
    use v5.36;

    has registry => (
        is      => 'ro',
        default => sub { {} },
    );

    has translator => (
        is       => 'rw',
        required => 1,
        does     => 'TranslatorRole',
    );

    sub switch_engine ($self, $name) {
        my $builder = $self->registry->{$name}
            or die "unknown engine: $name";
        $self->translator( $builder->() );
    }

    sub run ($self, $text, $to = 'en', $from = 'ja') {
        return $self->translator->translate($text, $to, $from);
    }
}

# ==========================
# 実行例
# ==========================
package main;

my $cli = LinguaBridge::CLI->new(
    registry => {
        echo   => sub { LinguaBridge::Translator::Echo->new },
        legacy => sub {
            LinguaBridge::Translator::LegacyAdapter->new(
                client => LegacyTranslationAPI->new,
            )
        },
    },
    translator => LinguaBridge::Translator::Echo->new,
);

say $cli->run('おはようございます', 'en');  # Echo
$cli->switch_engine('legacy');
say $cli->run('おはようございます', 'en');  # LegacyAdapter経由
```

次回はいよいよ全体の構造を振り返り、「なぜここまでラッパーを作ったのか」を明かします。
