---
date: 2026-01-11T00:43:19+09:00
description: LinguaBridge翻訳CLIに、古い翻訳APIの呼び出し方を吸収するラッパーを挟みます。CLIのインターフェースは変えずに、外部APIの癖だけを包むクラスを用意します。
draft: false
epoch: 1768059799
image: /public_images/2026/adapter-pattern-series-image.jpg
iso8601: 2026-01-11T00:43:19+09:00
tags:
  - perl
  - moo
  - cli
  - translation
  - api-wrapper
title: '第2回-古い翻訳APIを包んでCLIを守る - LinguaBridge翻訳CLIで学ぶ設計入門'
---

[@nqounet](https://x.com/nqounet)です。

前回は翻訳役のインターフェースを決めました。今回は、仕様が合わない翻訳APIを「包む」ことでCLIの呼び出しを変えない方法を用意します。

## 前回のおさらい / 次回の予告

{{< linkcard "/2026/01/11/004116/" >}}

{{< linkcard "/2026/01/11/004522/" >}}

## APIの癖をCLIに漏らさない

- 古いAPIが`convert({ text => ..., target => ... })`のような引数を要求し、戻り値も`{ result => ... }`だったりします。
- CLIがその形に合わせると、別APIに変えたときに毎回CLIを修正する羽目になります。
- 「翻訳役の契約」は変えず、ラッパーが外部APIの癖を吸収します。

```perl
my $legacy = LegacyTranslationAPI->new;
my $res    = $legacy->convert({ text => $text, target => $to, source => $from });
return $res->{result};
```

## 完成したコード

```perl
#!/usr/bin/env perl
use v5.36;

# ==========================
# 既存のRole
# ==========================
package TranslatorRole {
    use Moo::Role;
    requires 'translate';
}

# ==========================
# レガシーAPIクライアント（仮実装）
# ==========================
package LegacyTranslationAPI {
    use Moo;
    use v5.36;

    sub convert ($self, $args) {
        my $text = $args->{text};
        my $to   = $args->{target};
        my $from = $args->{source};
        return { result => "LEGACY[$from→$to]: $text" };
    }
}

# ==========================
# ラッパー（契約を実装）
# ==========================
package LinguaBridge::Translator::LegacyAdapter {
    use Moo;
    use v5.36;
    with 'TranslatorRole';

    has client => (
        is       => 'ro',
        required => 1,
        isa      => sub ($c) { die 'client missing convert' unless $c->can('convert') },
    );

    sub translate ($self, $text, $to, $from = 'ja') {
        my $res = $self->client->convert({
            text   => $text,
            target => $to,
            source => $from,
        });
        return $res->{result};
    }
}

# ==========================
# CLI本体（契約だけを見る）
# ==========================
package LinguaBridge::CLI {
    use Moo;
    use v5.36;

    has translator => (
        is       => 'ro',
        required => 1,
        does     => 'TranslatorRole',
    );

    sub run ($self, $text, $to = 'en', $from = 'ja') {
        return $self->translator->translate($text, $to, $from);
    }
}

# ==========================
# 実行例
# ==========================
package main;

my $cli = LinguaBridge::CLI->new(
    translator => LinguaBridge::Translator::LegacyAdapter->new(
        client => LegacyTranslationAPI->new,
    ),
);

say $cli->run('ありがとうございます', 'en');  # LEGACY[ja→en]: ありがとうございます
say $cli->run('Thanks!', 'ja');              # LEGACY[en→ja]: Thanks!
```

次回は翻訳の前後に整形や注釈を挟む「パイプライン」を用意し、CLIが小さな処理を組み合わせられるようにします。
