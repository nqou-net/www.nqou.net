---
date: 2026-01-11T00:45:22+09:00
description: 翻訳前後の整形や注釈付けを、LinguaBridge翻訳CLIに小さなフィルターとして挟みます。CLIは翻訳役とフィルター役を順番に呼ぶだけにして、処理の組み合わせを柔軟にします。
draft: false
epoch: 1768059922
image: /public_images/2026/adapter-pattern-series-image.jpg
iso8601: 2026-01-11T00:45:22+09:00
tags:
  - perl
  - moo
  - cli
  - translation
  - pipeline
title: '第3回-翻訳前後のパイプラインを足して拡張性アップ - LinguaBridge翻訳CLIで学ぶ設計入門'
---

[@nqounet](https://x.com/nqounet)です。

前回は外部APIの癖をラッパーで吸収しました。今回は、翻訳の前後に「小さな処理」を差し込めるパイプラインを用意します。

## 前回のおさらい / 次回の予告

{{< linkcard "/2026/01/11/004319/" >}}

{{< linkcard "/2026/01/11/004725/" >}}

## 小さなフィルターを積み重ねる

- 翻訳前に`trim`、翻訳後に`注釈を足す`といった処理を、フィルターの配列で表現します。
- CLIは「フィルターを順番に適用する」だけを知り、フィルターの中身には関知しません。
- これで翻訳エンジンもフィルターも、入れ替えや追加が簡単になります。

```perl
for my $filter (@{ $self->prefilters }) {
    $text = $filter->apply($text);
}
```

## 完成したコード

```perl
#!/usr/bin/env perl
use v5.36;

# ==========================
# Roles
# ==========================
package TranslatorRole {
    use Moo::Role;
    requires 'translate';
}

package FilterRole {
    use Moo::Role;
    requires 'apply';
}

# ==========================
# 翻訳役（ダミー）
# ==========================
package LinguaBridge::Translator::Echo {
    use Moo;
    use v5.36;
    with 'TranslatorRole';

    sub translate ($self, $text, $to, $from = 'ja') {
        return "[${from}→${to}] $text";
    }
}

# ==========================
# フィルター群
# ==========================
package LinguaBridge::Filter::Trim {
    use Moo;
    use v5.36;
    with 'FilterRole';

    sub apply ($self, $text) { $text =~ s/^\s+|\s+$//gr }
}

package LinguaBridge::Filter::Note {
    use Moo;
    use v5.36;
    with 'FilterRole';

    has note => ( is => 'ro', required => 1 );

    sub apply ($self, $text) { return "$text " . $self->note }
}

# ==========================
# CLI本体（パイプライン）
# ==========================
package LinguaBridge::CLI {
    use Moo;
    use v5.36;

    has translator => (
        is       => 'ro',
        required => 1,
        does     => 'TranslatorRole',
    );

    has prefilters => (
        is      => 'ro',
        default => sub { [] },
    );

    has postfilters => (
        is      => 'ro',
        default => sub { [] },
    );

    sub run ($self, $text, $to = 'en', $from = 'ja') {
        for my $filter (@{ $self->prefilters }) {
            $text = $filter->apply($text);
        }

        my $translated = $self->translator->translate($text, $to, $from);

        for my $filter (@{ $self->postfilters }) {
            $translated = $filter->apply($translated);
        }

        return $translated;
    }
}

# ==========================
# 実行例
# ==========================
package main;

my $cli = LinguaBridge::CLI->new(
    translator  => LinguaBridge::Translator::Echo->new,
    prefilters  => [ LinguaBridge::Filter::Trim->new ],
    postfilters => [ LinguaBridge::Filter::Note->new( note => '(machine-translated)' ) ],
);

say $cli->run("  こんにちは  ", 'en');  # => [ja→en] こんにちは (machine-translated)
```

次回は「翻訳エンジンの選択」を外部入力にして、CLIを再起動せずに差し替えられる仕組みを作ります。
