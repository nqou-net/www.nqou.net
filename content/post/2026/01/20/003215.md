---
categories:
  - Perl
  - プログラミング
date: 2026-01-20T00:32:15+09:00
description: PerlとMooでMarkdown目次生成器を作る第2回。正規表現で見出しを抽出し、レベルとテキストをハッシュ配列で保存。Compositeパターン学習の基礎を固めます。
draft: false
epoch: 1768836735
image: /public_images/2026/composite-markdown-toc-series-image.jpg
iso8601: 2026-01-20T00:32:15+09:00
series: 'PerlとMooで学ぶComposite - Markdown目次生成ツリー構造'
tags:
  - perl
  - moo
  - composite-pattern
  - markdown
  - regex
title: '第2回-正規表現で見出しを抽出しよう - PerlとMooで学ぶComposite'
---

## 前回の振り返り

前回は、`MarkdownReader`クラスを作成し、Markdownファイルの全行を配列として読み込む処理を実装しました。

{{< linkcard url="https://www.nqou.net/2026/01/20/003158/" title="前回" >}}

今回は、読み込んだ行から見出し（`#`、`##`、`###`など）を抽出していきます。

## 今回のゴール

Markdownの見出し行を正規表現で検出し、見出しレベル（H1=1、H2=2...）とテキストを抽出する`HeadingExtractor`クラスを作成します。

## Markdownの見出し構文

Markdownでは、`#`の数で見出しレベルを表現します。

| 記法 | HTMLタグ | レベル |
|------|----------|--------|
| `# タイトル` | `<h1>` | 1 |
| `## 章` | `<h2>` | 2 |
| `### セクション` | `<h3>` | 3 |
| `#### 小見出し` | `<h4>` | 4 |
| `##### 小項目` | `<h5>` | 5 |
| `###### 最小見出し` | `<h6>` | 6 |

## HeadingExtractorクラスの実装

```perl
package HeadingExtractor;
use v5.36;
use Moo;

has 'lines' => (
    is       => 'ro',
    required => 1,
);

has 'headings' => (
    is      => 'lazy',
    builder => '_build_headings',
);

sub _build_headings ($self) {
    my @headings;
    
    for my $line ($self->lines->@*) {
        if ($line =~ /^(#{1,6})\s+(.+)$/) {
            my $level = length($1);
            my $text  = $2;
            push @headings, {
                level => $level,
                text  => $text,
            };
        }
    }
    
    return \@headings;
}

sub heading_count ($self) {
    return scalar $self->headings->@*;
}

1;
```

### コードの解説

#### 正規表現パターン

```perl
if ($line =~ /^(#{1,6})\s+(.+)$/) {
```

この正規表現を分解すると：

| パターン | 意味 |
|----------|------|
| `^` | 行頭 |
| `(#{1,6})` | `#`が1〜6個（キャプチャグループ1） |
| `\s+` | 1つ以上の空白 |
| `(.+)` | 1文字以上の任意の文字列（キャプチャグループ2） |
| `$` | 行末 |

キャプチャグループを使うことで、マッチした部分を変数に取り出せます。

#### レベルの取得

```perl
my $level = length($1);
```

`$1`には`#{1,6}`でマッチした部分（`#`の連続）が入ります。`length()`で文字数（`#`の数）を取得すると、それがそのまま見出しレベルになります。

#### テキストの取得

```perl
my $text = $2;
```

`$2`には`.+`でマッチした部分（見出しテキスト）が入ります。

#### ハッシュで保存

```perl
push @headings, {
    level => $level,
    text  => $text,
};
```

抽出した情報を匿名ハッシュにして配列に追加します。各要素は`level`と`text`キーを持つハッシュリファレンスです。

## 使用例

前回作成した`MarkdownReader`と組み合わせて使ってみましょう。

```perl
#!/usr/bin/env perl
use v5.36;
use lib '.';
use MarkdownReader;
use HeadingExtractor;

my $reader = MarkdownReader->new(
    filepath => 'sample.md',
);

my $extractor = HeadingExtractor->new(
    lines => $reader->lines,
);

say "見出し数: " . $extractor->heading_count;
say "";
say "抽出結果:";
for my $h ($extractor->headings->@*) {
    say "  レベル$h->{level}: $h->{text}";
}
```

### 実行結果

テスト用のMarkdownファイル（前回と同じ）で実行すると：

```
見出し数: 4
抽出結果:
  レベル1: はじめに
  レベル2: 第1章
  レベル3: セクション1.1
  レベル2: 第2章
```

見出しが正しく抽出され、レベルとテキストが取得できています。

## 補足：正規表現のエッジケース

今回の正規表現は基本的なケースをカバーしていますが、以下のようなエッジケースには対応していません。

### マッチしないケース

```markdown
#タイトル     <!-- #の後にスペースがない -->
####### 見出し <!-- #が7個以上 -->
```

### マッチするが意図と異なる可能性

```markdown
##  タイトル  <!-- 複数スペース：マッチするが末尾スペースも含む -->
```

実用的なツールを作る場合は、これらのケースも考慮する必要がありますが、本シリーズでは基本的なパターンに集中します。

## 完成コード

今回作成した`HeadingExtractor`クラスの完成コードです。

```perl
package HeadingExtractor;
use v5.36;
use Moo;

has 'lines' => (
    is       => 'ro',
    required => 1,
);

has 'headings' => (
    is      => 'lazy',
    builder => '_build_headings',
);

sub _build_headings ($self) {
    my @headings;
    
    for my $line ($self->lines->@*) {
        if ($line =~ /^(#{1,6})\s+(.+)$/) {
            my $level = length($1);
            my $text  = $2;
            push @headings, {
                level => $level,
                text  => $text,
            };
        }
    }
    
    return \@headings;
}

sub heading_count ($self) {
    return scalar $self->headings->@*;
}

1;
```

## まとめ

今回は、正規表現を使ってMarkdownの見出しを抽出する`HeadingExtractor`クラスを作成しました。

学んだこと：

- 正規表現のキャプチャグループ`()`で部分文字列を取得
- `$1`、`$2`でキャプチャした値を参照
- `length()`で文字数を取得し、見出しレベルを算出
- 匿名ハッシュ`{}`で構造化データを配列に格納

次回は、抽出した見出しをフラットな配列のままインデント付きで表示する処理を実装します。まだ階層構造（ツリー構造）は扱わず、単純なループ処理で目次を表示してみましょう。

{{< linkcard url="https://www.nqou.net/2026/01/20/003158/" title="前回" >}}
{{< linkcard url="https://www.nqou.net/2026/01/20/003232/" title="次回" >}}
