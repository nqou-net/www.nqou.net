---
categories:
  - Perl
  - プログラミング
date: 2026-01-20T00:31:58+09:00
description: PerlとMooでMarkdown処理の基礎を学ぶ連載第1回。ファイル読み込みクラスMarkdownReaderを実装し、Compositeパターン学習の土台を作ります。Perl入学式卒業者向け実践シリーズ。
draft: false
epoch: 1768836718
image: /public_images/2026/composite-markdown-toc-series-image.jpg
iso8601: 2026-01-20T00:31:58+09:00
series: 'PerlとMooで学ぶComposite - Markdown目次生成ツリー構造'
tags:
  - perl
  - moo
  - composite-pattern
  - markdown
  - file-io
title: '第1回-Markdownファイルを読み込んでみよう - PerlとMooで学ぶComposite'
---

## はじめに

「Mooで覚えるオブジェクト指向プログラミング」を修了された皆さん、おめでとうございます！

このシリーズでは、Compositeパターンというデザインパターンを学びながら、Markdown目次ジェネレーターを作っていきます。Markdownファイルを読み込み、見出し（`#`、`##`、`###`など）を抽出して、自動的に目次を生成するツールです。

全8回を通じて、以下のことを学びます：

- ファイル読み込みとテキスト処理
- 正規表現による見出し抽出
- 階層構造（ツリー構造）の表現方法
- Compositeパターンによるツリー構造の統一的扱い

完成すると、技術ブログやGitHubのREADME作成で実際に使えるツールになります。

### 前提知識

本シリーズは、[Mooで覚えるオブジェクト指向プログラミング](/2026/01/02/233311/)修了を前提としています。特に、以下の概念を使用します：

- クラス定義（`package`、`use Moo`）
- 属性（`has`）
- メソッド定義
- Role（後半の回で使用）

## 今回のゴール

今回は、Markdownファイルを読み込んで、全行を配列で取得する`MarkdownReader`クラスを作成します。シンプルですが、これがシリーズ全体の土台となります。

## MarkdownReaderクラスの実装

まずは、ファイルパスを受け取って内容を読み込むクラスを作りましょう。

```perl
package MarkdownReader;
use v5.36;
use Moo;

has 'filepath' => (
    is       => 'ro',
    required => 1,
);

has 'lines' => (
    is      => 'lazy',
    builder => '_build_lines',
);

sub _build_lines ($self) {
    my @lines;
    open my $fh, '<:utf8', $self->filepath
        or die "Cannot open file: $!";
    while (my $line = <$fh>) {
        chomp $line;
        push @lines, $line;
    }
    close $fh;
    return \@lines;
}

sub line_count ($self) {
    return scalar $self->lines->@*;
}

1;
```

### コードの解説

#### `filepath`属性

```perl
has 'filepath' => (
    is       => 'ro',
    required => 1,
);
```

- `is => 'ro'`: 読み取り専用（read-only）
- `required => 1`: インスタンス生成時に必須

#### `lines`属性と`lazy`

```perl
has 'lines' => (
    is      => 'lazy',
    builder => '_build_lines',
);
```

- `is => 'lazy'`: 最初にアクセスされたときに値を構築する
- `builder => '_build_lines'`: 値を構築するメソッドを指定

`lazy`を使うことで、インスタンス生成時にはまだファイルを読み込まず、`$reader->lines`にアクセスした時点で初めて読み込みが行われます。これにより、ファイルを使わない場合に無駄な読み込みを避けられます。

#### `_build_lines`メソッド

```perl
sub _build_lines ($self) {
    my @lines;
    open my $fh, '<:utf8', $self->filepath
        or die "Cannot open file: $!";
    while (my $line = <$fh>) {
        chomp $line;
        push @lines, $line;
    }
    close $fh;
    return \@lines;
}
```

- `open my $fh, '<:utf8', $self->filepath`: UTF-8エンコーディングでファイルを開く
- `chomp $line`: 行末の改行を除去
- `push @lines, $line`: 各行を配列に追加
- `return \@lines`: 配列のリファレンスを返す

#### `line_count`メソッド

```perl
sub line_count ($self) {
    return scalar $self->lines->@*;
}
```

- `$self->lines->@*`: 配列リファレンスを展開（postfix dereference）
- `scalar ...`: 配列の要素数を返す

## 使用例

では、実際に`MarkdownReader`を使ってみましょう。まず、テスト用のMarkdownファイルを用意します。

```markdown
# はじめに

これはテスト用のMarkdownファイルです。

## 第1章

内容がここに入ります。

### セクション1.1

詳細な説明です。

## 第2章

別の話題です。
```

このファイルを`sample.md`として保存し、以下のスクリプトで読み込みます。

```perl
#!/usr/bin/env perl
use v5.36;
use lib '.';
use MarkdownReader;

my $reader = MarkdownReader->new(
    filepath => 'sample.md',
);

say "ファイル: " . $reader->filepath;
say "行数: " . $reader->line_count;
say "";
say "内容:";
for my $line ($reader->lines->@*) {
    say "  $line";
}
```

### 実行結果

```
ファイル: sample.md
行数: 15
内容:
  # はじめに
  
  これはテスト用のMarkdownファイルです。
  
  ## 第1章
  
  内容がここに入ります。
  
  ### セクション1.1
  
  詳細な説明です。
  
  ## 第2章
  
  別の話題です.
```

## 完成コード

今回作成した`MarkdownReader`クラスの完成コードです。

```perl
package MarkdownReader;
use v5.36;
use Moo;

has 'filepath' => (
    is       => 'ro',
    required => 1,
);

has 'lines' => (
    is      => 'lazy',
    builder => '_build_lines',
);

sub _build_lines ($self) {
    my @lines;
    open my $fh, '<:utf8', $self->filepath
        or die "Cannot open file: $!";
    while (my $line = <$fh>) {
        chomp $line;
        push @lines, $line;
    }
    close $fh;
    return \@lines;
}

sub line_count ($self) {
    return scalar $self->lines->@*;
}

1;
```

## まとめ

今回は、Markdown目次ジェネレーターの第一歩として、ファイル読み込みを担当する`MarkdownReader`クラスを作成しました。

学んだこと：

- `has`の`lazy`と`builder`オプションで遅延初期化を実現
- `open`によるファイル読み込みとUTF-8エンコーディング指定
- postfix dereference（`->@*`）による配列リファレンスの展開

次回は、読み込んだファイルから正規表現を使って見出しを抽出していきます。`# タイトル`や`## 章`といったMarkdownの見出しを検出し、レベル（H1、H2、H3...）とテキストを取り出す処理を実装します。

{{< linkcard url="https://www.nqou.net/2026/01/20/003215/" title="次回" >}}
