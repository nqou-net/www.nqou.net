---
title: 第3回-フラット配列で目次を表示しよう - PerlとMooで学ぶComposite
description: PerlとMooでMarkdown目次生成器を作る第3回。抽出した見出しをインデント付きで表示。まだ階層構造は扱わず、単純な配列処理で目次をレンダリングします。
date: 2026-01-20T00:32:32+09:00
draft: false
categories:
  - Perl
  - プログラミング
tags:
  - perl
  - moo
  - composite-pattern
  - markdown
  - rendering
series: PerlとMooで学ぶComposite - Markdown目次生成ツリー構造
---

## 前回の振り返り

前回は、`HeadingExtractor`クラスを作成し、正規表現でMarkdownの見出しを抽出しました。見出しはレベル（1〜6）とテキストを持つハッシュの配列として取得できるようになりました。

{{< linkcard url="/2026/01/20/003215/" title="前回" >}}

今回は、この配列を使って**目次を表示**します。

## 今回のゴール

抽出した見出しの配列を、レベルに応じてインデントを付けて表示する`FlatTOCRenderer`クラスを作成します。

この段階では、まだ「ツリー構造」は扱いません。単純にレベル値に応じてスペースを追加するだけの処理です。

## FlatTOCRendererクラスの実装

```perl
package FlatTOCRenderer;
use v5.36;
use Moo;

has 'headings' => (
    is       => 'ro',
    required => 1,
);

has 'indent_size' => (
    is      => 'ro',
    default => 2,
);

sub render ($self) {
    my @lines;
    
    for my $h ($self->headings->@*) {
        my $indent = ' ' x (($h->{level} - 1) * $self->indent_size);
        my $marker = '- ';
        push @lines, $indent . $marker . $h->{text};
    }
    
    return join("\n", @lines);
}

1;
```

### コードの解説

#### `indent_size`属性

```perl
has 'indent_size' => (
    is      => 'ro',
    default => 2,
);
```

インデントのスペース数を設定できるようにしています。デフォルトは2スペースです。

#### `render`メソッド

```perl
sub render ($self) {
    my @lines;
    
    for my $h ($self->headings->@*) {
        my $indent = ' ' x (($h->{level} - 1) * $self->indent_size);
        my $marker = '- ';
        push @lines, $indent . $marker . $h->{text};
    }
    
    return join("\n", @lines);
}
```

**繰り返し演算子 `x`**

```perl
my $indent = ' ' x (($h->{level} - 1) * $self->indent_size);
```

`'文字列' x 回数`で、文字列を指定回数繰り返した新しい文字列を作成します。

- レベル1: `(1 - 1) * 2 = 0`スペース
- レベル2: `(2 - 1) * 2 = 2`スペース
- レベル3: `(3 - 1) * 2 = 4`スペース

**リストマーカー**

```perl
my $marker = '- ';
```

Markdown形式のリストマーカーを追加します。

**結合**

```perl
return join("\n", @lines);
```

配列の要素を改行で結合して、1つの文字列として返します。

## 使用例

これまでに作成したクラスを組み合わせて使ってみましょう。

```perl
#!/usr/bin/env perl
use v5.36;
use lib '.';
use MarkdownReader;
use HeadingExtractor;
use FlatTOCRenderer;

my $reader = MarkdownReader->new(
    filepath => 'sample.md',
);

my $extractor = HeadingExtractor->new(
    lines => $reader->lines,
);

my $renderer = FlatTOCRenderer->new(
    headings => $extractor->headings,
);

say "目次:";
say $renderer->render;
```

### 実行結果

```
目次:
- はじめに
  - 第1章
    - セクション1.1
  - 第2章
```

レベルに応じてインデントが付いた目次が表示されました。

### インデントサイズのカスタマイズ

```perl
my $renderer = FlatTOCRenderer->new(
    headings    => $extractor->headings,
    indent_size => 4,  # 4スペース
);
```

実行結果：

```
目次:
- はじめに
    - 第1章
        - セクション1.1
    - 第2章
```

## この方法の限界

現時点では、見出しは「フラットな配列」として扱われています。各見出しは独立した要素であり、親子関係を持っていません。

これで十分に見えるかもしれませんが、次のようなケースを考えてみてください：

### 問題1：親子関係の追跡

「第1章」の下にある「セクション1.1」と「セクション1.2」をまとめて取得したい場合、現在の実装では簡単にはできません。

### 問題2：HTML形式での出力

入れ子になった`<ul><li>`構造を生成するには、「どの見出しがどの見出しの下にあるか」を知る必要があります。

```html
<ul>
  <li>はじめに
    <ul>
      <li>第1章
        <ul>
          <li>セクション1.1</li>
        </ul>
      </li>
      <li>第2章</li>
    </ul>
  </li>
</ul>
```

現在の配列構造では、この入れ子構造を正しく生成するのは難しいです。

次回は、この**階層構造を表現しようとして壁にぶつかる**体験をします。

## 完成コード

今回作成した`FlatTOCRenderer`クラスの完成コードです。

```perl
package FlatTOCRenderer;
use v5.36;
use Moo;

has 'headings' => (
    is       => 'ro',
    required => 1,
);

has 'indent_size' => (
    is      => 'ro',
    default => 2,
);

sub render ($self) {
    my @lines;
    
    for my $h ($self->headings->@*) {
        my $indent = ' ' x (($h->{level} - 1) * $self->indent_size);
        my $marker = '- ';
        push @lines, $indent . $marker . $h->{text};
    }
    
    return join("\n", @lines);
}

1;
```

## まとめ

今回は、抽出した見出しをインデント付きで表示する`FlatTOCRenderer`クラスを作成しました。

学んだこと：

- 繰り返し演算子`x`による文字列の繰り返し
- `join`による配列の文字列化
- インデント計算によるシンプルな目次表示

現時点では、見出しは「フラットな配列」として扱われています。次回は、親子関係を表現しようとして、なぜそれが難しいのかを体験します。

{{< linkcard url="/2026/01/20/003215/" title="前回" >}}
{{< linkcard url="/2026/01/20/003249/" title="次回" >}}
