---
title: '第5回-状態を管理するContextクラスを作ろう - Mooを使って自動販売機シミュレーターを作ってみよう'
description: 状態を一元管理するContextクラスを作成。VendingMachineクラスがStateへ処理を委譲する仕組みをMooで実装します。
iso8601: 2026-01-10T00:06:35+09:00
draft: false
tags:
  - perl
  - moo
  - context
  - delegation
  - design-patterns
---

[@nqounet](https://x.com/nqounet)です。

前回は、Moo::Roleを使って状態クラスに共通のインターフェースを定義しました。

{{< linkcard "/2026/01/10/000432/" >}}

今回は、状態を一元管理する「Context」クラスを作成しましょう。これにより、利用者は状態クラスを直接操作することなく、自動販売機を使えるようになります。

## なぜContextクラスが必要なのか

前回までのコードでは、利用者が直接状態オブジェクトを操作していました。

```perl
my $state = WaitingState->new;
$state = $state->insert_coin;
$state = $state->select_product;
```

これには以下の問題があります。

- 利用者が状態オブジェクトを管理する必要がある
- 状態クラスの存在を利用者が知っている必要がある
- 在庫などの追加情報を管理する場所がない

Contextクラスを作ることで、これらの問題を解決できます。

## VendingMachineクラス（Context）を作る

自動販売機本体を表すVendingMachineクラスを作ります。このクラスが現在の状態を保持し、操作を状態オブジェクトに委譲します。

```perl
package VendingMachine {
    use Moo;
    use v5.36;

    has state => (
        is      => 'rw',
        default => sub { WaitingState->new },
    );

    has stock => (
        is      => 'rw',
        default => sub { 5 },
    );

    sub insert_coin ($self) {
        my $next_state = $self->state->insert_coin;
        $self->state($next_state);
    }

    sub select_product ($self) {
        my $next_state = $self->state->select_product;
        $self->state($next_state);
    }

    sub dispense ($self) {
        my $next_state = $self->state->dispense;
        $self->state($next_state);
    }

    sub current_state_name ($self) {
        return ref($self->state);
    }
}
```

## Contextクラスのポイント

VendingMachineクラスの特徴を整理しましょう。

- `state`属性で現在の状態オブジェクトを保持する
- `stock`属性で在庫を管理する（今後使用）
- 各操作メソッドは、状態オブジェクトに処理を委譲する
- 戻り値の新しい状態オブジェクトを`state`に設定する

利用者はVendingMachineクラスだけを使えばよく、内部の状態クラスを意識する必要がありません。

## 完成コードと動作確認

状態クラス、ロール、Contextクラスをすべて組み合わせた完成コードです。

```perl
#!/usr/bin/env perl
use v5.36;
use Moo;

package VendingMachineState {
    use Moo::Role;

    requires 'insert_coin';
    requires 'select_product';
    requires 'dispense';
}

package WaitingState {
    use Moo;
    use v5.36;

    with 'VendingMachineState';

    sub insert_coin ($self) {
        say "コインを受け付けました";
        return CoinInsertedState->new;
    }

    sub select_product ($self) {
        say "先にコインを入れてください";
        return $self;
    }

    sub dispense ($self) {
        say "払い出す商品がありません";
        return $self;
    }
}

package CoinInsertedState {
    use Moo;
    use v5.36;

    with 'VendingMachineState';

    sub insert_coin ($self) {
        say "すでにコインが入っています";
        return $self;
    }

    sub select_product ($self) {
        say "商品を選択しました。払い出しを開始します";
        return DispensingState->new;
    }

    sub dispense ($self) {
        say "先に商品を選択してください";
        return $self;
    }
}

package DispensingState {
    use Moo;
    use v5.36;

    with 'VendingMachineState';

    sub insert_coin ($self) {
        say "払い出し中です。お待ちください";
        return $self;
    }

    sub select_product ($self) {
        say "払い出し中です。お待ちください";
        return $self;
    }

    sub dispense ($self) {
        say "商品を払い出しました";
        return WaitingState->new;
    }
}

package VendingMachine {
    use Moo;
    use v5.36;

    has state => (
        is      => 'rw',
        default => sub { WaitingState->new },
    );

    has stock => (
        is      => 'rw',
        default => sub { 5 },
    );

    sub insert_coin ($self) {
        my $next_state = $self->state->insert_coin;
        $self->state($next_state);
    }

    sub select_product ($self) {
        my $next_state = $self->state->select_product;
        $self->state($next_state);
    }

    sub dispense ($self) {
        my $next_state = $self->state->dispense;
        $self->state($next_state);
    }

    sub current_state_name ($self) {
        return ref($self->state);
    }
}

# 動作確認
say "=== 自動販売機シミュレーター ===";
say "";

my $vm = VendingMachine->new;

say "初期状態: " . $vm->current_state_name;
say "";

say "[操作] 商品を選択（コインなし）";
$vm->select_product;
say "現在の状態: " . $vm->current_state_name;
say "";

say "[操作] コインを投入";
$vm->insert_coin;
say "現在の状態: " . $vm->current_state_name;
say "";

say "[操作] 商品を選択";
$vm->select_product;
say "現在の状態: " . $vm->current_state_name;
say "";

say "[操作] 払い出し";
$vm->dispense;
say "現在の状態: " . $vm->current_state_name;
```

## 実行結果

```
=== 自動販売機シミュレーター ===

初期状態: WaitingState

[操作] 商品を選択（コインなし）
先にコインを入れてください
現在の状態: WaitingState

[操作] コインを投入
コインを受け付けました
現在の状態: CoinInsertedState

[操作] 商品を選択
商品を選択しました。払い出しを開始します
現在の状態: DispensingState

[操作] 払い出し
商品を払い出しました
現在の状態: WaitingState
```

## 今回のポイント

Contextクラス（VendingMachine）を作ることで、以下のメリットが得られました。

- 利用者はVendingMachineクラスだけを使えばよい
- 内部の状態クラスは隠蔽されている
- 在庫などの追加情報を管理する場所ができた
- 各操作は状態オブジェクトに委譲される

しかし、まだ問題があります。状態クラスの中でVendingMachine（Context）の情報（例えば在庫）にアクセスできません。

次回は、状態クラスがContextへの参照を受け取り、自ら状態遷移を行う仕組みを実装します。

## まとめ

- VendingMachineクラス（Context）を作成し、状態を一元管理しました
- 各操作メソッドは状態オブジェクトに処理を委譲しています
- 戻り値の新しい状態を`state`属性に設定することで状態遷移します
- 利用者は内部の状態クラスを意識する必要がありません

次回「第6回-状態の中から次の状態へ遷移しよう」では、StateがContextへの参照を受け取る仕組みを実装します。お楽しみに！
