---
categories:
  - design-pattern
date: 2026-02-15T07:07:05+09:00
description: 「血管内に発生した無数の血栓」。複雑なAPIコールが散乱したコードベースを、Facadeパターンによるバイパス手術で救う物語。
draft: false
epoch: 1771106825
image: /favicon.png
initial_creation_datetime: 2026-02-15T00:07:38+09:00
iso8601: 2026-02-15T07:07:05+09:00
tags:
  - job-story
  - code-doctor
  - facade
  - perl
title: Facadeパターン：複雑性中毒に捧ぐバイパス手術【コードドクター】
---

## 1. 救急搬送

深夜2時、静まり返ったオフィスに、不規則なアラート音が響いていた。私はモニターを睨みつけ、何度目かわからないため息をついた。

「またか……。初期化シーケンスのエラー。」

新しく導入した外部クラウドサービスのAPI連携。それがすべての元凶だった。多機能だが極めて粒度が細かく、正しい手順で呼び出さないとすぐに機嫌を損ねる。そのくせ、社内のあらゆるモジュールがこのサービスに依存していた。

「ピ……ピ……」

モニターの明滅が、瀕死の心拍のように見える。
その時、サーバーラックの陰から、黒いコートの男と、白衣の女性が現れた。セキュリティゲートを通った音なんてしなかったのに。

「だ、誰ですか？」

男——コードドクターは、私の問いを無視して、空中の見えない何かを指で追っていた。

「……異音。」

「こんばんは。システムの心音が乱れているので、往診に参りました。」

後ろに立つ女性が、穏やかな声でそう言った。彼女の手には、往診用のバッグが握られている。
私は疲れすぎて幻覚を見ているのかもしれない。だが、彼らの眼差しはあまりに真剣だった。

## 2. 検査

ドクターは私のデスクに歩み寄ると、散乱していたLANケーブルの束をじっと見つめた。
そして無言で手を伸ばし、持参した結束バンドで「パチッ」と一本に束ねた。

（……なんて手際の良さだ。僕の混乱した頭の中まで整理してくれようとしているのか？ この優しさは……）

私が感動しかけたその時、ドクターが短く呟いた。

「ノイズ。……干渉している。」

「単に、配線のクロストークが許せなかっただけのようです」

助手の女性が、申し訳なさそうに小声でフォローを入れた。私は赤面しながら、作業中のIDEを彼らに見せた。

ドクターは画面を覗き込み、マウスホイールを回す。数秒で、その手が止まった。

「露出過多。……カプセル化違反。」

眉間に深い皺が刻まれる。私は弁解しようとした。

「あの、そのライブラリ、使い方が難しくて……。でも、各画面で細かい制御が必要なんです。だから、都度呼び出しロジックを書いていて……」

これが、私が書いていたコードだ。

```perl
#!/usr/bin/env perl
use v5.36;
use lib 'lib';
use External::ComplexSystem;

try_purchase("item_A");

sub try_purchase ($item_name) {
    say "Processing purchase for $item_name...";

    # 1. システムの生成
    my $system = External::ComplexSystem->new;

    # 2. 初期化 (これを忘れると動かない)
    $system->initialize_subsystem();

    # 3. パラメータ設定 (マジックナンバーだらけ)
    $system->set_config_param("timeout", 30);
    $system->set_config_param("mode", "strict");

    # 4. 認証
    my $token = $system->authenticate_user("admin");

    # 5. 接続確立
    $system->establish_connection($token);

    # 6. トランザクション開始
    my $tx = $system->create_transaction();

    # 7. 処理
    $tx->add_item($item_name);

    # 8. コミット
    $tx->commit();

    say "Purchase completed.\n";
}
```

「APIの複雑な初期化処理や内部ロジックが、メインの処理フローに直接書かれている状態です」

助手が静かに解説する。

「内臓が外気に触れているのと同じです。これでは、外部サービスの仕様が少し変わるだけで、全身がショック死してしまいます。血管（ロジック）の中に、異物（外部APIの詳細）が詰まっている状態です」

「多発性API依存症候群（密結合）……」

ドクターが呟く。
確かにそうだ。どこか一箇所でも修正をミスしたら、システム全体が止まる。それが怖くて、最近は誰もこのコードに触りたがらない。

## 3. 手術

「感謝は、このコードに」

ドクターはそう言うと、キーボードの上に手を置いた。まるでピアニストが鍵盤に触れる前の静寂のようだ。
次の瞬間、猛烈な勢いでタイピングが始まった。

彼は既存の呼び出しコードを消すのではなく、新しいクラスを作成し始めた。

「バイパス手術を行います。複雑な血流を、新しい人工血管に流します」

助手の言葉と共に、新しいファイル `MyApp::PurchaseFacade.pm` が生成されていく。

```perl
package MyApp::PurchaseFacade;
use v5.36;
use External::ComplexSystem;

sub new ($class) {
    return bless {}, $class;
}

sub purchase_item ($self, $user, $item_name) {
    # 複雑な手順を隠蔽（カプセル化）する
    
    my $system = External::ComplexSystem->new;
    $system->initialize_subsystem();
    
    # デフォルト設定もここで吸収
    $system->set_config_param("timeout", 30);
    $system->set_config_param("mode", "strict");
    
    my $token = $system->authenticate_user($user);
    $system->establish_connection($token);
    
    my $tx = $system->create_transaction();
    $tx->add_item($item_name);
    $tx->commit();
    
    return 1;
}

1;
```

「これが、**Facade（建物の正面）**です」

助手が指差す。

「複雑な配線や構造を、綺麗な壁で隠すのです。クライアントコード——つまりあなたたちが触れる部分は、ただの『窓口』であればいい」

ドクターがいらないコードを削除する。画面上の行数がみるみる減っていく。
そして、メインの処理はこう変わった。

```perl
#!/usr/bin/env perl
use v5.36;
use lib 'lib';
use MyApp::PurchaseFacade;

my $facade = MyApp::PurchaseFacade->new;

say "Processing purchase via Facade...";
# クライアントは「何を買うか」だけに集中できる
$facade->purchase_item("admin", "item_A");
say "Purchase completed.";
```

「うわっ、メインの処理がたったこれだけに……！？」

私は思わず声を上げた。あんなに苦しめられていた10行以上の儀式が、たった1行のメソッド呼び出しに集約されている。

## 4. 予後

ドクターがエンターキーを叩くと、テストが走り、全てのステータスがグリーンに点灯した。
不規則だったアラート音が消え、サーバーファンの低い唸りだけが部屋に残る。

「……流れる。」

ドクターは満足げに一つ頷いた。

「ありがとうございます！ これなら、APIの手順が変わってもFacadeクラスだけを直せば済みます」

私が礼を言うと、ドクターは鞄を持ち直した。
そして、もう一度私の机の上の——先ほど結束バンドで束ねたLANケーブルを見て、小さく頷いた。

「……秩序だ。」

そう言い残し、彼は風のように去っていった。
残された私は、綺麗になった机とコードを見比べ、深く息を吐いた。

「複雑さは消せませんが、隠すことはできます。良い『窓口』を設置しましたね」

助手の言葉を思い出しながら、私はこの静穏な夜明けを迎えた。

---

## 処方箋まとめ

| 症状 | 適用すべき | 経過観察 |
| :--- | :---: | :---: |
| ライブラリやAPIの使用手順が複雑で、あちこちにコピペされている | ✓ | |
| クライアントコードとサブシステムが密結合している | ✓ | |
| サブシステム自体を拡張・継承する必要がある | | ✓ |

### 治療のステップ

1. **インターフェースの設計**: クライアントにとって本当に必要な操作（「購入する」「送信する」など）を洗い出す。
2. **Facadeクラスの作成**: 複雑なサブシステム（外部APIやライブラリ）を包み込む新しいクラスを作成する。
3. **ロジックの移動**: クライアントコードに散乱していた初期化手順や依存関係の解決ロジックを、Facadeクラス内に移動する。
4. **呼び出しの置換**: クライアントコードを書き換え、Facade経由で操作するように修正する。
5. **サブシステムの隠蔽**: 可能であれば、サブシステムのクラスをクライアントから直接参照できないようにする。

### 助手より

現代の開発において、外部サービスや複雑なライブラリとの連携は避けられません。しかし、その複雑さをチーム全員が背負う必要はないのです。Facadeパターンは、システムの中に「通訳」を置くようなもの。ドクターのように無口で優秀な窓口を作って、開発者の認知負荷（Cognitive Load）を下げてあげましょう。
