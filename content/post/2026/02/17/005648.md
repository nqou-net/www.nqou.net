---
categories:
  - デザインパターン
date: 2026-02-17T00:56:48+09:00
description: レポート出力機能のクラス爆発を、Bridgeパターンによる「機能と実装の分離」で解決します。
draft: true
epoch: 1771257408
image: /favicon.png
iso8601: 2026-02-17T00:56:48+09:00
tags:
  - code-doctor
  - design-patterns
  - bridge-pattern
title: コードドクター〜クラス爆発緊急手術（Bridge）
---

「先生…！ 助けてください！」

深夜のコード診療所。静寂を切り裂いて、顔色の悪い患者が担ぎ込まれてきた。
その手には、大量にプリントアウトされたクラス図が握りしめられている。

「……」

コードドクターは無言でカルテを用意し、患者の顔を覗き込みながら、重症度を見極めるように目を細めた。
患者の目の下には深い隈が刻まれている。

「クラスが…クラスが止まらないんです！ レポートの種類は3つ、出力形式も3つ…たったそれだけなのに、クラスが9個も…！」
「落ち着いてください。呼吸が荒いですよ」

助手のナースがすっとお冷を差し出す。彼女の洗練された所作と常温の水に、患者は少しだけ落ち着きを取り戻し、呼吸を整えた。

## 診断：クラス無限増殖症

ドクターは患者が持ち込んだクラス図（Beforeコード）に目を落とす。
ひと目見て、その病魔の正体は明らかだった。

```perl
# Before: 継承の悪用によるクラス爆発

# 基底クラス
package Report; ...

# レポートの種類で分岐
package DailyReport; use parent 'Report'; ...
package MonthlyReport; use parent 'Report'; ...

# さらに出力形式で分岐... ここで爆発が起きている
package DailyReportText; use parent 'DailyReport'; ...
package DailyReportHTML; use parent 'DailyReport'; ...
package MonthlyReportText; use parent 'MonthlyReport'; ...
package MonthlyReportHTML; use parent 'MonthlyReport'; ...
```

「……末期だな」

ドクターが低く呟いた。

「ひっ！？」
「驚かせないでください、先生」

助手は困ったように微笑み、怯える患者に向き直って優しく語りかける。

「先生は『継承の使い方が深刻な状態だ』と仰ってます。患者さん、今度、新しい種類が増えるそうですね？」
「は、はい…JSON形式も追加しろって言われて…そうすると、`DailyReportJSON`, `MonthlyReportJSON`... って全部作らなきゃいけなくて…」

想像しただけで眩暈がしたのか、患者は再び頭を抱えた。

「クラス無限増殖症」
「えっ？」
「機能と実装の、多次元継承麻痺」

ドクターが短い単語を放つと、助手がすかさず補足に入る。

「この病気は、クラス継承を二つの異なる目的——この場合なら『レポートの種類（機能）』と『出力形式（実装）』——で同時に使ってしまうことで起きます。一つの継承ツリーに全てを詰め込もうとしているのが原因ですね」

ドクターはホワイトボードに向かい、無言でペンを走らせた。
縦軸に機能、横軸に実装。その交点すべてにクラスが存在する、巨大なマトリックスがあっという間に描かれる。

「掛け算だ」
「そう、クラスの数は $M \times N$ で増え続けてしまいます。これが今の『爆発』の状態です」

## 処方：Bridgeパターン

「……足し算にする」

ドクターがホワイトボードのマトリックスに大きくバツ印をつけた。

「えっ、算数の話ですか？」

ポカンとする患者をよそに、助手はカルテの処方箋欄にさらさらと書き込んでいく。

**処方箋：Bridge Pattern**

「**Bridgeパターン**です。別名『Handle/Body』とも呼ばれますね」
「どういうことでしょう？」
「**『機能のクラス階層』と『実装のクラス階層』を分ける**んです。そして、その二つの山を橋（Bridge）で繋ぐ。継承（is-a）ではなく、委譲（has-a）を使うのがポイントですよ」

## 手術：二つの山を分ける

「実装から、切る」

ドクターは愛用のエディタを立ち上げ、まるでメスのように鋭い手つきでキーボードを叩き始めた。

### Step 1: 実装の分離 (Implementor)

まずは、複雑に絡み合ったコードの中から、出力形式に関する部分だけを慎重に切り離していく。

```perl
# Implementor (実装の階層)
package Formatter;
sub format_header { die "Abstract" }
sub format_body   { die "Abstract" }
sub format_footer { die "Abstract" }

# 具体的な実装たち
package TextFormatter;
use parent 'Formatter';
sub format_header { "=== Report ===\n" }
# ...

package HtmlFormatter;
use parent 'Formatter';
sub format_header { "<html><body>... \n" }
# ...
```

キーボードを叩く音が止む。

「分離完了」
「はい、これでフォーマット（実装）は独立したクラス群になりました」

助手はモニターを指差しながら解説する。

「見てください。新しいJSON形式を追加したければ、ここに `JsonFormatter` を一つ足すだけで済みます。他のクラスへの影響はありません」

### Step 2: 橋の架設 (Bridge)

「次は、機能」

ドクターの視線が鋭くなる。ここが手術の正念場だ。

```perl
# Abstraction (機能の階層)
package Report;
sub new {
    my ($class, $formatter) = @_;
    # ここが「橋」だ。実装クラスのインスタンスを保持する
    return bless { formatter => $formatter }, $class;
}

sub display {
    my $self = shift;
    # 処理は「橋」の向こう側（実装クラス）に完全に委譲する
    my $f = $self->{formatter};
    print $f->format_header();
    print $f->format_body($self->get_data());
    print $f->format_footer();
}
```

「先生、`Report` クラスが `Formatter` を持っています！」

患者が驚きの声を上げる。これまでの継承だらけのコードとは全く違う構造だ。

「それが『橋』です」

助手が得意げに胸を張る。

「継承でガチガチに固めるのではなく、インスタンスとして持たせることで、実行時に自由に切り替えられるようになるんです。これが『委譲』の力ですね」

### Step 3: 機能の拡張 (Refined Abstraction)

「仕上げだ」

ドクターの手つきが軽やかになる。難所を越え、残るは縫合のみだ。

```perl
# Refined Abstraction
package DailyReport;
use parent 'Report';
sub get_data { "Today's sales..." }

package MonthlyReport;
use parent 'Report';
sub get_data { "Monthly sales..." }
```

「終了」

モニターには、驚くほどシンプルになったコードが映し出されている。手術は成功した。

## 術後経過：足し算の世界へ

「……動かせ」

ドクターの指示で、実際にコードを実行してみる。

```perl
my $json_fmt = JsonFormatter->new();
my $daily = DailyReport->new($json_fmt); # Daily × JSON
$daily->display();
```

新しい組み合わせも、既存クラスには一切触れずに見事に動作した。

「す、すごい…！ JSONクラスを一つ作っただけで、日報も月報もJSON化できました！」

患者の顔色が、みるみるうちに良くなっていく。憑き物が落ちたような表情だ。

「これが『分離』の力です。クラスの増加数は $M + N$ に抑えられましたね」
「ありがとうございます先生！ これで今日はぐっすり眠れます！」

深々と頭を下げる患者に、ドクターは背を向けたまま一言だけ投げかけた。

「……睡眠は、デバッグだ」
「ふふ、先生なりの『お大事に』ですよ」

患者が去った後、診療所には静寂が戻った。
助手が手際よくコーヒーを淹れ、ドクターのデスクに置く。湯気とともに、香ばしい香りが部屋を満たす。

「先生、また難しい顔をして」
「……」

ドクターは一口飲み、眉をひそめた。

「……苦い」
「あら、砂糖を入れ忘れましたか？」
「……そうかもな」

本当は、彼女がドクターの好みを熟知してブラックにしていることを、彼も知っている。
だが、それを口にするのは野暮というものだろう。

「感謝は、これに」

ドクターはカップを置き、モニターの中で静かに動作するBridgeパターンのコードを指差した。
その横顔には、ささやかな安堵が浮かんでいた。

---

### 用法・用量
Bridgeパターンは、機能拡張と実装拡張の二つの軸があり、それらが独立して変化する場合に有効です（OS依存部分と機能部分の分離など）。
単に継承階層が深いだけの時に使うと、逆に複雑になる副作用があるので注意してください。
