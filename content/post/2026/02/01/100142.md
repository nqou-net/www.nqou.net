---
date: 2026-02-01T10:01:59+09:00
description: どこが変わったか一目でわかるように！Text::Diffで差分表示、HTML整形で見やすく。変更箇所をハイライト表示。
draft: true
epoch: 1769828519
image: /public_images/2026/web-hunter-header.png
iso8601: 2026-02-01T10:01:59+09:00
series:
  - PerlとMooでWebページ変更ハンターを作ろう
tags:
  - perl
  - moo
  - diff
  - html
title: '【第7回】差分を見やすく表示する - PerlとMooでWebページ変更ハンターを作ろう'
---

## 「変わった」だけじゃわからない

複数サイトを同時監視できるようになりました。変更を検知したら通知も飛びます。しかし、通知を受け取った人は困ります：

「変わったのはわかった。で、**どこが**変わったの？」

HTMLのソース全体を見せられても、何が変わったかわかりません。行数が数千行あるHTMLで、たった1行の価格表示が変わっただけかもしれません。

今回は、「前回の内容」と「今回の内容」の差分を見やすく表示する機能を実装します。

## Text::Diffで差分を計算

Perlには定番の差分計算モジュール「Text::Diff」があります。Unixの`diff`コマンドと同じことができます：

```perl
#!/usr/bin/env perl
use v5.36;
use utf8;
use Text::Diff;

my $old = <<'EOF';
価格: 1,000円
在庫: あり
送料: 無料
EOF

my $new = <<'EOF';
価格: 1,200円
在庫: あり
送料: 無料
EOF

my $diff = diff(\$old, \$new);
say $diff;

# 出力:
# --- *  Sat Feb  1 10:00:00 2026
# +++ *  Sat Feb  1 10:00:00 2026
# @@ -1,3 +1,3 @@
# -価格: 1,000円
# +価格: 1,200円
#  在庫: あり
#  送料: 無料
```

`-`が削除された行、`+`が追加された行です。これで、どこが変わったか一目瞭然。

## DiffFormatterクラスを作る

差分表示をカプセル化したクラスを作りましょう：

```perl
package WebHunter::DiffFormatter {
    use Moo;
    use Text::Diff;
    use HTML::Entities qw(encode_entities);
    use namespace::clean;

    has use_color => (
        is      => 'ro',
        default => 0,
    );

    # プレーンテキスト差分
    sub format_diff ($self, $old, $new, %options) {
        my $diff = diff(
            \$old,
            \$new,
            {
                STYLE => $options{style} // 'Unified',
            }
        );
        
        return $diff unless $self->use_color;
        return $self->colorize($diff);
    }

    # ANSIカラーコード付き差分（ターミナル表示用）
    sub colorize ($self, $diff) {
        my @lines = split /\n/, $diff;
        my @colored;
        
        for my $line (@lines) {
            if ($line =~ /^-/) {
                push @colored, "\e[31m$line\e[0m";  # 赤
            } elsif ($line =~ /^\+/) {
                push @colored, "\e[32m$line\e[0m";  # 緑
            } elsif ($line =~ /^@@/) {
                push @colored, "\e[36m$line\e[0m";  # シアン
            } else {
                push @colored, $line;
            }
        }
        
        return join("\n", @colored);
    }

    # HTML形式差分（メール/Web表示用）
    sub format_html_diff ($self, $old, $new) {
        my $diff = diff(\$old, \$new, { STYLE => 'Unified' });
        my @lines = split /\n/, $diff;
        my @html;
        
        push @html, '<pre style="background: #f5f5f5; padding: 10px; border-radius: 5px;">';
        
        for my $line (@lines) {
            my $escaped = encode_entities($line);
            
            if ($line =~ /^-/) {
                push @html, qq{<span style="color: #c00;">$escaped</span>};
            } elsif ($line =~ /^\+/) {
                push @html, qq{<span style="color: #0c0;">$escaped</span>};
            } elsif ($line =~ /^@@/) {
                push @html, qq{<span style="color: #06c; font-weight: bold;">$escaped</span>};
            } else {
                push @html, $escaped;
            }
        }
        
        push @html, '</pre>';
        return join("\n", @html);
    }

    # サマリー（変更行数など）
    sub get_summary ($self, $old, $new) {
        my $diff = diff(\$old, \$new, { STYLE => 'Unified' });
        my @lines = split /\n/, $diff;
        
        my $added   = grep { /^\+/ && !/^\+\+\+/ } @lines;
        my $deleted = grep { /^-/  && !/^---/       } @lines;
        
        return {
            added   => $added,
            deleted => $deleted,
            total   => $added + $deleted,
        };
    }
}
```

### ポイント

- **`format_diff`**: シンプルなテキスト差分。オプションで`style`を変更可能。
- **`colorize`**: ANSIエスケープシーケンスで色付け。ターミナル表示が見やすくなります。
- **`format_html_diff`**: HTML形式の差分。メールやWeb表示に使えます。
- **`get_summary`**: 追加/削除行数の集計。通知に含めると便利。

## Observerに差分を渡す

Observerの`update`メソッドに、差分情報も渡すように改良します：

```perl
package WebHunter::Observer::Email {
    use Moo;
    use WebHunter::DiffFormatter;
    use namespace::clean;
    
    with 'WebHunter::Observer';

    has to => (
        is       => 'ro',
        required => 1,
    );

    has formatter => (
        is      => 'lazy',
        builder => sub { WebHunter::DiffFormatter->new },
    );

    sub update ($self, $event) {
        return unless $event->{previous};  # 初回チェックはスキップ

        my $old_content = $event->{previous}->content;
        my $new_content = $event->{current}->content;
        
        my $summary = $self->formatter->get_summary($old_content, $new_content);
        my $diff_html = $self->formatter->format_html_diff($old_content, $new_content);

        say "[EMAIL] 宛先: ", $self->to;
        say "  URL: $event->{url}";
        say "  変更: +$summary->{added}行 -$summary->{deleted}行";
        say "\n--- 差分 (HTML) ---";
        say substr($diff_html, 0, 500), "...";  # 最初だけ表示
        say "  （実際にはここで差分付きHTMLメールを送信）";
    }
}
```

## MonitorManagerで差分を含める

MonitorManagerの通知イベントに、差分情報を追加します：

```perl
# WebHunter::MonitorManager の run_check_all メソッド内
if ($check->{changed}) {
    say "  ✓ 変更検知！";
    
    # 差分を計算
    my $formatter = WebHunter::DiffFormatter->new(use_color => 1);
    my $old_content = $check->{previous}->content;
    my $new_content = $check->{current}->content;
    my $summary = $formatter->get_summary($old_content, $new_content);
    
    say "  変更: +$summary->{added}行 -$summary->{deleted}行";
    
    # 差分をターミナルに表示（最初の20行だけ）
    my $diff = $formatter->format_diff($old_content, $new_content);
    my @diff_lines = split /\n/, $diff;
    say $formatter->colorize(join("\n", @diff_lines[0..19])) if @diff_lines > 0;
    
    # Observerに通知
    my $event = {
        url       => $url,
        name      => $name,
        content   => $new_content,
        previous  => $check->{previous},
        current   => $check->{current},
        timestamp => time,
        summary   => $summary,
    };
    
    $self->notify_observers($event);
}
```

## 実行例

実際に実行すると、こんな感じで表示されます：

```
=================================
  WebHunter - Webページ変更監視
=================================
監視対象URL数: 3

チェック中: 競合A社価格ページ (https://example.com/price)
  ✓ 変更検知！
  変更: +2行 -2行

@@ -15,2 +15,2 @@
-<span class="price">1,000円</span>
+<span class="price">1,200円</span>
 <p class="stock">在庫あり</p>

[EMAIL] 宛先: admin@example.com
  URL: https://example.com/price
  変更: +2行 -2行

[SLACK] Webhook: https://hooks.slack.com/...
  URL: https://example.com/price
  変更: +2行 -2行
```

## 差分表示の工夫

HTML全体を比較すると、ノイズが多くなります。より実用的にするには：

1. **HTML正規化**: 空白やインデントを統一してから比較
2. **抽出フィルタ**: CSSセレクタで特定部分だけを抽出
3. **無視パターン**: タイムスタンプ、広告IDなど動的要素を除外
4. **単語単位の差分**: 行単位ではなく、単語単位で差分を計算

これらは次のステップとして実装できます。

## 今回学んだこと

- Text::Diffによる差分計算
- ANSIカラーコードでターミナル表示を見やすく
- HTML形式の差分でメール/Web表示に対応
- 差分サマリーで変更規模を把握

次回は最終回。ここまで作ってきたツールの設計思想を振り返り、Observer、Memento、Iteratorの3つのパターンがどう組み合わさっているかを解説します。

{{< linkcard "https://www.nqou.net/2026/02/01/100125/" >}}

{{< linkcard "https://www.nqou.net/2026/02/01/100159/" >}}
