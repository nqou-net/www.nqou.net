---
title: コードドクター〜通知システム緊急手術（Factory Method）
date: 2026-02-11T00:07:05+09:00
description: "「具体クラス依存症」に苦しむ通知システム。コードドクターによるFactory Methodパターンの処方箋とは？"
draft: false
tags: [code-doctor, design-patterns, factory-method, refactoring]
toc: true
---

## 第1章: 急患搬送

「先生、患者さんです！」

助手の声が診療所に響く。元ネイルサロンだったこの小さなクリニックに、今夜も一人の開発者が担ぎ込まれてきた。

患者は疲れ切った様子の女性だった。目の下には濃いクマが刻まれ、手にはノートPCを抱えている。明らかにType B——どうしようもなく疲れ切っているやつだ。

「お名前は？」助手が問診票を差し出す。

「佐藤です…スタートアップで通知システムの担当をしています…」

私はモニターを覗き込んだ。佐藤氏のPCにはソースコードが表示されていた。

「見せてくれ」

コードを一瞥する。

```perl
package NotificationService;

sub new {
    my ($class) = @_;
    return bless {}, $class;
}

sub send_notification {
    my ($self, $type, $message, $recipient) = @_;

    if ($type eq 'email') {
        # メール送信ロジック
        print "【Email to $recipient】$message\n";
    }
    elsif ($type eq 'slack') {
        # Slack送信ロジック
        print "【Slack to $recipient】$message\n";
    }
    elsif ($type eq 'sms') {
        # SMS送信ロジック
        print "【SMS to $recipient】$message\n";
    }
    else {
        die "Unknown type: $type";
    }
}

1;
```

「重症」

私は一言だけ告げた。

「ひどい具体クラス依存症。しかも、開放閉鎖原則違反も併発している」

佐藤氏の顔が青ざめる。「新しい通知チャネルを追加するたびに、このメソッドを修正しなければならないんです。先週はTeams、今週はLINE…毎週追加で…」

「手術が必要」

---

## 第2章: 問診と検査

助手がホワイトボードに症状をまとめていく。

「佐藤さん、つまりこういうことですね」

| 症状 | 状態 |
|------|------|
| **具体クラス依存症** | 新チャネル追加のたびにif文が増殖 |
| **開放閉鎖原則違反** | 拡張のために既存コードを修正 |
| **テスト不安定症** | 修正のたびにテストが壊れる |

佐藤氏が力なくうなずく。「また追加ですか…って毎週言われるんです。もう限界です…」

私は静かに言った。

「この `if-elsif` 文がすべての元凶。新しいチャネルを追加するたびにこのメソッドを触る必要がある。つまり、変更に対して開いていて、拡張に対して閉じている。これは逆でなければならない」

「逆…ですか？」

「拡張に対して開いていて、変更に対して閉じている。これが健全なコード」

助手が補足した。「つまりですね、新しい通知チャネルを追加したいときは**新しいクラスを追加するだけ**で済むようにする、ということです。既存のコードには一切手を加えないんですよ」

「そんなことができるんですか？」

私は処方箋を書き込んだ。

```
処方箋: Factory Method パターン
適応症: 具体クラス依存症、OCP違反
```

---

## 第3章: 手術—患部摘出

「手術を始める」

まず、製品（Product）のインターフェースを定義する。

```perl
package Notifier;

sub new {
    my ($class) = @_;
    return bless {}, $class;
}

sub send {
    die "Override me!";
}

1;
```

次に、具体的な製品（Concrete Products）を分離。

```perl
package EmailNotifier;
use parent -norequire, 'Notifier';

sub send {
    my ($self, $message, $recipient) = @_;
    print "【Email to $recipient】$message\n";
}

1;

package SlackNotifier;
use parent -norequire, 'Notifier';

sub send {
    my ($self, $message, $recipient) = @_;
    print "【Slack to $recipient】$message\n";
}

1;

package SMSNotifier;
use parent -norequire, 'Notifier';

sub send {
    my ($self, $message, $recipient) = @_;
    print "【SMS to $recipient】$message\n";
}

1;
```

「これが患部を切り出した状態」

佐藤氏が目を見開いた。「各チャネルが独立したクラスになっている…」

「続ける」

作成者（Creator）クラスを定義。Factory Methodはサブクラスで実装させる。

```perl
package NotifierFactory;

sub new {
    my ($class) = @_;
    return bless {}, $class;
}

# Factory Method (サブクラスで実装)
sub create_notifier {
    die "Override me!";
}

sub send_notification {
    my ($self, $message, $recipient) = @_;
    my $notifier = $self->create_notifier();
    $notifier->send($message, $recipient);
}

1;
```

そして、具体的な作成者（Concrete Creators）を用意する。

```perl
package EmailNotifierFactory;
use parent -norequire, 'NotifierFactory';

sub create_notifier {
    return bless {}, 'EmailNotifier';
}

1;

package SlackNotifierFactory;
use parent -norequire, 'NotifierFactory';

sub create_notifier {
    return bless {}, 'SlackNotifier';
}

1;

package SMSNotifierFactory;
use parent -norequire, 'NotifierFactory';

sub create_notifier {
    return bless {}, 'SMSNotifier';
}

1;
```

「手術完了」

---

## 第4章: 術後経過

助手がモニターを指差した。「佐藤さん、こちらが術後のクライアントコードです」

```perl
my $email = EmailNotifierFactory->new();
$email->send_notification("システムアラート", "admin@example.com");

my $slack = SlackNotifierFactory->new();
$slack->send_notification("デプロイ完了", "#dev-channel");

my $sms = SMSNotifierFactory->new();
$sms->send_notification("緊急連絡", "090-xxxx-xxxx");
```

「では、LINE通知を追加してみましょう」

```perl
package LINENotifier;
use parent -norequire, 'Notifier';

sub send {
    my ($self, $message, $recipient) = @_;
    print "【LINE to $recipient】$message\n";
}

1;

package LINENotifierFactory;
use parent -norequire, 'NotifierFactory';

sub create_notifier {
    return bless {}, 'LINENotifier';
}

1;
```

佐藤氏の目が輝いた。「既存のコードに一行も触れていない…！」

「これがOCP—開放閉鎖原則」

私は続けた。

「拡張に対して開いている。新しいチャネルはクラスを追加するだけ。変更に対して閉じている。既存のコードは触らない」

助手が補足した。「テストも安定しますよ。各チャネルが独立しているので、EmailNotifierのテストはEmailNotifierだけをテストすればいいんです。他のチャネルの変更に影響されません」

佐藤氏の顔に生気が戻ってきた。「来週Teams追加って言われても…これなら…」

---

## 第5章: 退院指導

「退院前に一つ」

私はホワイトボードに図を描いた。

**Simple Factory vs Factory Method**

| 比較項目 | Simple Factory | Factory Method |
|----------|----------------|----------------|
| **構造** | 一つのファクトリクラスに生成ロジック集約 | サブクラスで生成メソッドをオーバーライド |
| **拡張性** | 新チャネル追加時にファクトリを修正 | 新チャネル追加時は新クラスを追加するのみ |
| **複雑度** | シンプル | やや複雑（クラス数増加） |
| **使い分け** | チャネルが固定的な場合 | チャネルが頻繁に追加される場合 |

「今回のケースはチャネル追加が頻繁。Factory Methodが正解」

佐藤氏が深々と頭を下げた。「ありがとうございます、先生。もう二度とあんな `if-elsif` 文は書きません」

「無理はするな。症状が再発したらまた来い」

---

## エピローグ

佐藤氏が帰った後、助手がコーヒーを差し出した。

「先生、お疲れさまでした」

私はカップを受け取る。彼女なりの労いだろう。この何気ない仕草に、私は少なからず…

「先生」

「何だ」

「さっき佐藤さん、帰り際に『先生みたいな人がいてくれて助かった』って言ってましたよ」

私のことをそう思ってくれているのか。いや、待て。助手がわざわざ伝えてくるということは…

「それで、次の患者さんなんですが」

…考えるのはやめた。

窓の外では、夜明けの光がビル群を照らし始めていた。今日もまた、どこかで誰かがコードに苦しんでいる。

私はモニターに向き直った。
