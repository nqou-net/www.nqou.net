---
categories:
  - design-pattern
  - code-doctor
date: 2026-02-13T07:07:05+09:00
draft: false
epoch: 1770934025
image: /favicon.png
iso8601: 2026-02-13T07:07:05+09:00
tags:
  - prototype
  - performance
  - perl
  - object-oriented
title: 'Prototype - クローン技術で量産せよ'
---

## 来院：凍りついた戦場

深夜3時。自分のディスプレイの中で、ゴブリンの群れがカクカクと不自然な動きを繰り返していた。

「またフレーム落ちか……」

来週リリースのイベントステージ『ゴブリン軍団の逆襲』。仕様書には「画面を埋め尽くす100体のゴブリン」とある。しかし、自分の書いたコードでは、敵が出現するたびに画面が数秒固まってしまうのだ。

「これじゃ逆襲する前にプレイヤーが寝ちまうよ」

デスクに突っ伏し、虚ろな目でファンが唸りを上げるPCを見つめる。
その時、背後で冷ややかな声がした。

「ファンが悲鳴を上げているな。お前のコードの断末魔か？」

飛び上がって振り返ると、黒いコートを着た長身の男が立っていた。コードドクターだ。傍らには、穏やかな笑みを浮かべた助手の女性も控えている。

「ど、どうしてここに？ 往診は頼んでませんよ！」
「PCの排熱音が異常だという通報がありました。近所迷惑レベルだと」

助手がにっこりと微笑む。嘘だろ、深夜のオフィスビルの排熱音なんて聞こえるわけがない。だが、ドクターは既に自分の椅子を押しのけ、キーボードに手を伸ばしていた。

## 検査：天地創造のコスト

ドクターは無言でソースコードをスクロールし、ある一点で指を止めた。

「……愚かだ。毎回、創世記をやっている」

ドクターの侮蔑的な視線が自分に刺さる。

「創世記……？」
「『たかが雑魚モンスター1匹を作るのに、天地創造のような重い初期化処理を行っていますね』とおっしゃっています」

助手が通訳してくれた。ドクターが指差していたのは、`Goblin`クラスのコンストラクタだった。

```perl
# 患部：毎回重い初期化を行っている
package Goblin;
use v5.36;
use parent 'Monster';

sub new ($class, %args) {
    # 重い初期化処理のシミュレーション
    # 3Dモデル読み込み、テクスチャ展開、JSON設定パースなど...
    my $heavy_data = _load_heavy_resources(); 
    
    my $self = $class->SUPER::new(%args, resource => $heavy_data);
    $self;
}
```

「仕様通りですよ！ ゴブリンはそれぞれ個体差がありますし、装備もランダム生成しなきゃいけないし、だから毎回 `new` して……」

自分の言い訳を遮るように、ドクターは机の上に並んだ栄養ドリンクの空き瓶をコンコンと叩いた。

「……お前も同じだ。毎朝、精神をコールドブートしている」
「え？」
「『毎朝、生まれて初めて仕事をする人間のように、ゼロから気合を入れ直しているから疲れるのですよ』とおっしゃっています」

図星だった。毎回「よしやるぞ！」と気合を入れないとコードが書けない。そして夕方には燃え尽きている。

「解決策は一つだ」

ドクターが白衣のポケットからメス（USBメモリ）を取り出した。

「細胞クローン療法（Prototype Pattern）を適用する」

## 処置：細胞分裂の奇跡

「いいか、自然界を見ろ。細胞は毎回DNAを化学合成しているか？ 違う、分裂（コピー）しているだけだ」

ドクターの手がキーボードを叩く。その速度は、まるでピアノの速弾きを見ているようだ。

「まず、原本（Prototype）となる完璧な個体を一つ作る。こいつにはコストをかけてもいい」

ドクターは `Monster` クラスに一つのメソッドを追加した。

```perl
package Monster;
use v5.36;

sub new ($class, %args) {
    bless { %args }, $class;
}

# 処方：クローンメソッドの実装
sub clone ($self) {
    # 浅いコピー（Shallow Copy）で十分な場合
    my $clone = { %$self };
    bless $clone, ref $self;
}
```

「これだけ……ですか？」
「これだけだ。だが効果は劇的だ」

次にドクターは、自分が書いていたクライアントコード（呼び出し側）を書き換えていく。

```perl
# 治療後：原本を作ってから増殖させる

# 1. 原本(Prototype)を一つだけ、コストをかけて生成
my $proto = Goblin->new(x => 0, y => 0);

my @goblins;
# 2. クローンで増やす
for my $i (1..100) {
    # 重い初期化をスキップしてメモリコピーのみ！
    my $clone = $proto->clone;
    
    # 必要な差分（座標など）だけ上書きする
    $clone->x($i); 
    
    push @goblins, $clone;
}
```

「実行してみろ」

ドクターに促され、自分は震える指でエンターキーを押した。

## 予後：量産された世界

`Created 100 goblins in 0.00015 seconds.`

目の前の画面で、100体のゴブリンが一瞬にして出現した。カクつきなど微塵もない。滑らかに動き回る緑色の軍団。

「速い……！ まるで忍者の分身の術だ！」
「初期化コストを極限までゼロに近づけた結果です」

助手がモニターを覗き込みながら満足げに頷く。

「クラスからインスタンスを作るのではなく、インスタンスからインスタンスを作る。それが Prototype パターンだ。構造が複雑で初期化にコストがかかるオブジェクトほど、効果を発揮する」

ドクターはモニターから視線を外し、立ち上がろうとした。その時、ドクターの手が自分の肩に伸びた。ポン、と軽く叩かれる。

（こ、これは……「よくやった」という無言の賞賛！？ あの厳格なドクターが、自分の実力を……いや、将来性を見込んでくれたのか！）

胸の奥から熱いものがこみ上げてきた。

「あ、ありがとうございますドクター！ 自分、もっと精進します！ 最高のエンジニアになります！」

感極まって叫ぶ自分に、ドクターは冷ややかな視線を向けたまま、指先につまんだ白い綿ゴミをパラリと床に捨てた。

「……埃。」
「え？」
「肩に埃がついていた。不潔だ」

ドクターはそれだけ言い残し、さっさと出口へと歩き出した。
固まる自分の後ろで、助手がクスクスと笑う気配がした。

「ええ、その意気ですよ。プログラマなら、常にクリーン（清潔）でいないといけませんから」

彼女は誤解を解くことなく、ドクターの後を追っていった。

「代金は、そのスパゲッティ・イベントハンドラのリファクタリングで払ってもらう。……まだ終わっていないぞ」

ドア越しに聞こえたドクターの低い声に、自分は慌ててエディタに向き直った。確かにゴブリンは軽くなったが、自分のコードにはまだ治療すべき箇所が山ほど残っているようだ。

---

## 処方箋まとめ

| 症状 | 適用すべき | 経過観察 |
| :--- | :---: | :---: |
| インスタンス生成コストが非常に高い（DB接続、ファイル読込等） | ✓ | |
| クラスの構成が複雑で、生成手順を隠蔽したい | ✓ | |
| インスタンスの種類が少数の組み合わせで表現できる | ✓ | |
| 単純なデータクラスやすぐに生成できる軽量オブジェクト | | ✓ |

### 治療のステップ

1.  **Prototypeインターフェースの定義**: `clone` メソッドを持つインターフェース（または基底クラス）を定義する。
2.  **クローン実装**: メモリコピーを行う `clone` メソッドを実装する。Perlならデリファレンスしてハッシュを作り直すだけで十分な場合が多い（Deep Copyが必要な場合は `Storable::dclone` などを検討）。
3.  **レジストリの作成（任意）**: よく使うプロトタイプを管理するクラスを用意することもある。
4.  **クライアントコードの修正**: `new` の代わりに `clone` を呼んでインスタンスを生成し、必要な属性だけ後から設定する形に変更する。

### 助手より

お疲れ様でした。初期化のボトルネックは、アプリケーションの体感速度に直結する重要な「病」です。
毎回ゼロから作ろうとせず、今あるリソースを有効活用する。それはプログラミングだけでなく、私たち自身の働き方にも言えることかもしれませんね。
しっかりと休息（スリープ）をとって、また元気なインスタンスを生成してください。お大事に。
