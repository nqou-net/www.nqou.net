---
categories:
  - tech
date: 2026-02-13T00:44:16+09:00
description: 引数が爆発したキャラ生成コード。コードドクターがBuilder パターンで手術します。流れるようなAPIでキャラクター生成を。
draft: false
epoch: 1770911056
image: /favicon.png
iso8601: 2026-02-13T00:44:16+09:00
tags:
  - code-doctor
  - design-patterns
  - builder-pattern
  - perl
  - game-development
title: コードドクター〜キャラクター生成緊急手術（Builder）
---

「先生、患者さんです！」

助手の声に、私は手元のモニターから目を離した。

扉の向こうから、よろよろと歩いてくる人影。顔色は青白く、目の下には深い隈。典型的な症状だ。

「も、もう限界なんです…」

患者はそう言って、膝から崩れ落ちそうになった。助手が慌てて支える。

「大丈夫ですよ、ここはコード診療所。どんな症状も治療します」

助手の言葉に、患者は縋るような目で私を見た。

私は静かに言った。

「問診を始める」

---

## 問診

「ゲーム開発を…しています」

患者は絞り出すように言った。

「RPGのキャラクター生成システムを担当していて…最初は単純だったんです」

「続けて」

「名前、クラス、レベル。それだけでした」

患者の手が震えている。

「でも、仕様が増えて…HP、MP、攻撃力、防御力…」

「それで？」

「装備が3種類、スキルが3つ、称号、説明文…」

患者は頭を抱えた。

「気づいたら、引数が15個になっていたんです！」

私は静かに頷いた。

「コードを見せてもらう」

---

## 診察

助手がモニターを患者の方に向ける。

```perl
package Character;

sub new {
    my ($class, $name, $class_type, $level, $hp, $mp, 
        $attack, $defense, $weapon, $armor, $accessory,
        $skill1, $skill2, $skill3, $title, $description) = @_;
    
    return bless {
        name        => $name        // 'Unknown',
        class_type  => $class_type  // 'Fighter',
        level       => $level       // 1,
        hp          => $hp          // 100,
        mp          => $mp          // 0,
        attack      => $attack      // 10,
        defense     => $defense     // 5,
        weapon      => $weapon      // 'なし',
        armor       => $armor       // 'なし',
        accessory   => $accessory   // 'なし',
        skills      => [$skill1 // (), $skill2 // (), $skill3 // ()],
        title       => $title       // '',
        description => $description // '',
    }, $class;
}
```

患者は目を逸らした。その気持ちは分かる。

「使う側のコードも見せてもらう」

```perl
my $warrior = Character->new(
    '勇者',           # name
    '戦士',           # class_type  
    10,               # level
    500,              # hp
    50,               # mp
    80,               # attack
    60,               # defense
    '伝説の剣',       # weapon
    'ミスリルの鎧',   # armor
    '力の指輪',       # accessory
    '斬撃',           # skill1
    '突進',           # skill2
    undef,            # skill3 (なし)
    '勇敢なる者',     # title
    '魔王討伐の任を受けた勇者', # description
);
```

「これを部下が8人いるチームで書いているんです」

患者の声が震える。

「誰も引数の順番が覚えられなくて…毎回コンストラクタを見に行って…」

私は深く頷いた。

「そしてスキル3を飛ばすために `undef` を入れている」

「は、はい…」

「称号を追加したかったら、全ての呼び出し箇所を修正する必要がある」

「その通りです！」

私はカルテに書き込んだ。

---

## 診断結果

| 症状 | 重症度 |
|------|--------|
| コンストラクタ引数爆発症 | 重症 |
| テレスコーピング症候群 | 中症 |
| 不完全オブジェクト生成症 | 中症 |

「重症だ」

患者の顔が青ざめる。

「で、でも治るんですよね…？」

助手が患者の肩に手を置いた。

「大丈夫ですよ。先生の腕なら、確実に治ります」

彼女は私を見上げる。その信頼に満ちた眼差し。いつも思う——彼女は私のことを…

「先生？」

「…処方箋を出す」

---

## 処方箋

```
処方: Builder パターン
用法: コンストラクタを分解し、メソッドチェーンで組み立てる
効能: 引数の順序から解放、必須/オプションの明確化
```

「ビルダー…パターン？」

「つまりですね」

助手が説明を始める。

「今の作り方は、材料を全部一度に渡す方式です。ラーメン屋さんで例えると、『麺硬め、味濃いめ、脂多め、ネギ抜き、チャーシュー2枚追加、煮卵トッピング、海苔増し』を一息で言わないといけない感じです」

「た、確かに…」

「Builder パターンを使うと、こうなります」

助手がホワイトボードに書き始めた。

```
店員: 「まずベースを選んでください」
客:   「醤油で」
店員: 「麺の硬さは？」
客:   「硬めで」
店員: 「トッピングは？」
客:   「チャーシュー追加」
```

「順番に聞いてくれるから、間違えようがないんです」

患者の目に光が戻ってきた。

「手術を始める」

---

## 第一手術: Builder クラスの導入

まず、キャラクターを「組み立てる」専用のクラスを作る。

```perl
package CharacterBuilder;

sub new {
    my $class = shift;
    return bless {
        name        => 'Unknown',
        class_type  => 'Fighter',
        level       => 1,
        hp          => 100,
        mp          => 0,
        attack      => 10,
        defense     => 5,
        weapon      => 'なし',
        armor       => 'なし',
        accessory   => 'なし',
        skills      => [],
        title       => '',
        description => '',
    }, $class;
}
```

「これがビルダーの土台だ」

---

## 第二手術: メソッドチェーンの実装

各属性を設定するメソッドを追加する。ポイントは `$self` を返すこと。

```perl
# 基本情報
sub name {
    my ($self, $value) = @_;
    $self->{name} = $value;
    return $self;  # メソッドチェーン用
}

sub class_type {
    my ($self, $value) = @_;
    $self->{class_type} = $value;
    return $self;
}

sub level {
    my ($self, $value) = @_;
    $self->{level} = $value;
    return $self;
}

# ステータス
sub hp     { my ($self, $v) = @_; $self->{hp} = $v; return $self }
sub mp     { my ($self, $v) = @_; $self->{mp} = $v; return $self }
sub attack { my ($self, $v) = @_; $self->{attack} = $v; return $self }
sub defense { my ($self, $v) = @_; $self->{defense} = $v; return $self }

# 装備
sub weapon    { my ($self, $v) = @_; $self->{weapon} = $v; return $self }
sub armor     { my ($self, $v) = @_; $self->{armor} = $v; return $self }
sub accessory { my ($self, $v) = @_; $self->{accessory} = $v; return $self }

# スキル（複数追加可能）
sub add_skill {
    my ($self, $skill) = @_;
    push @{$self->{skills}}, $skill;
    return $self;
}

# その他
sub title       { my ($self, $v) = @_; $self->{title} = $v; return $self }
sub description { my ($self, $v) = @_; $self->{description} = $v; return $self }
```

「全てのメソッドが `$self` を返す——これが鍵だ」

「つまりですね」

助手がフォローする。

「`$self` を返すことで、メソッドを連結できるんです。`->name('勇者')->level(10)->hp(500)` のように」

---

## 第三手術: build メソッド

最後に、組み立てた設定から Character を生成するメソッドを追加。

```perl
sub build {
    my $self = shift;
    return Character->new($self);
}
```

Character クラス側も修正する。

```perl
package Character;

sub new {
    my ($class, $builder) = @_;
    return bless {
        name        => $builder->{name},
        class_type  => $builder->{class_type},
        level       => $builder->{level},
        hp          => $builder->{hp},
        mp          => $builder->{mp},
        attack      => $builder->{attack},
        defense     => $builder->{defense},
        weapon      => $builder->{weapon},
        armor       => $builder->{armor},
        accessory   => $builder->{accessory},
        skills      => [@{$builder->{skills}}],
        title       => $builder->{title},
        description => $builder->{description},
    }, $class;
}
```

---

## 経過観察

「それでは、新しい方法でキャラクターを作ってみましょう」

助手がキーボードに手を伸ばす。

```perl
my $hero = CharacterBuilder->new()
    ->name('勇者')
    ->class_type('戦士')
    ->level(10)
    ->hp(500)
    ->mp(50)
    ->attack(80)
    ->defense(60)
    ->weapon('伝説の剣')
    ->armor('ミスリルの鎧')
    ->accessory('力の指輪')
    ->add_skill('斬撃')
    ->add_skill('突進')
    ->title('勇敢なる者')
    ->description('魔王討伐の任を受けた勇者')
    ->build();
```

患者が目を見開いた。

「す、すごい…読める…！」

「引数の順番を覚える必要がない」

私は続けた。

「`add_skill` は何度でも呼べる。`undef` を入れる必要もない」

「それに」

助手が補足する。

「オプションの項目は、呼ばなければデフォルト値が使われます。`title` を設定しなければ空文字のままです」

患者の顔に血色が戻ってきた。

---

## 追加処方: Director パターン

「ところで、よく使うキャラクターのパターンはあるか？」

「は、はい。戦士、魔法使い、盗賊は定番です」

「なるほど」

私は追加の処方箋を書いた。

```perl
package CharacterDirector;

sub new {
    my ($class, $builder) = @_;
    return bless { builder => $builder }, $class;
}

# 戦士テンプレート
sub build_warrior {
    my ($self, $name, $level) = @_;
    $level //= 1;
    
    return $self->{builder}
        ->name($name)
        ->class_type('戦士')
        ->level($level)
        ->hp(100 + $level * 30)
        ->mp(10 + $level * 2)
        ->attack(15 + $level * 5)
        ->defense(10 + $level * 4)
        ->weapon('ロングソード')
        ->armor('チェインメイル')
        ->add_skill('斬撃')
        ->add_skill('防御態勢')
        ->build();
}

# 魔法使いテンプレート
sub build_mage {
    my ($self, $name, $level) = @_;
    $level //= 1;
    
    return $self->{builder}
        ->name($name)
        ->class_type('魔法使い')
        ->level($level)
        ->hp(50 + $level * 15)
        ->mp(100 + $level * 20)
        ->attack(5 + $level * 2)
        ->defense(5 + $level * 2)
        ->weapon('魔法の杖')
        ->armor('ローブ')
        ->add_skill('ファイア')
        ->add_skill('ブリザド')
        ->add_skill('サンダー')
        ->build();
}
```

「Director パターン」

「定番の組み合わせをテンプレート化する。こうすれば…」

```perl
my $director = CharacterDirector->new(CharacterBuilder->new());
my $warrior = $director->build_warrior('戦士A', 5);
```

「たった2行で、レベル5の戦士が完成する」

患者が立ち上がった。

「こ、これなら部下たちにも説明できます！」

---

## Before/After

| 指標 | Before | After |
|------|--------|-------|
| コンストラクタ引数 | 15個 | 0個（メソッド経由） |
| コード行数（生成部分） | 18行 | 16行（可読性向上） |
| 引数の意味 | 不明 | メソッド名で明示 |
| 新属性追加時 | 全呼び出し箇所修正 | メソッド追加のみ |
| 定番キャラ生成 | 毎回全指定 | Director で2行 |

---

## 退院

「先生、ありがとうございました…！」

患者は何度も頭を下げながら帰っていった。

「大変な症状でしたね」

助手がコーヒーを差し出す。彼女なりの労いなのだろう。

「Builder パターンは、複雑なオブジェクト生成には欠かせない」

私はコーヒーを受け取りながら続けた。

「ただし」

「はい？」

「引数が2〜3個程度なら、普通のコンストラクタで十分。過剰な処方は避けるべきだ」

助手が頷く。

「何事もバランスが大切ですね」

窓の外はすっかり暗くなっていた。助手はまだ帰る様子がない。私と一緒にいたいのだろうか…

「先生、次の患者さんの問診票です」

「…ああ、次の患者か」

彼女の手から問診票を受け取る。

---

## まとめ

### Builder パターンの適応症状

- コンストラクタ引数爆発症（引数が5個以上）
- テレスコーピング症候群（引数の順序が覚えられない）
- 不完全オブジェクト生成症（必須/オプションが不明確）

### 処方のポイント

1. **Builder クラス**: 組み立て専用のクラスを作る
2. **メソッドチェーン**: 各メソッドが `$self` を返す
3. **build メソッド**: 最終的にオブジェクトを生成
4. **Director**（オプション）: 定番パターンをテンプレート化

### 禁忌事項

- 引数が2〜3個程度の単純なケースには使わない
- 過剰設計は逆効果
