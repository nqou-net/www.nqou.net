---
categories:
  - tech
date: 2026-02-13T00:44:16+09:00
description: 引数が爆発したキャラ生成コード。コードドクターがBuilder パターンで手術します。流れるようなAPIでキャラクター生成を。
draft: false
epoch: 1770911056
image: /favicon.png
iso8601: 2026-02-13T00:44:16+09:00
tags:
  - code-doctor
  - design-patterns
  - builder-pattern
  - perl
  - game-development
title: コードドクター〜キャラクター生成緊急手術（Builder）
---

## 主訴：引数の濁流に溺れる

「……もう、限界なんです」

私は震える声でそう訴えた。
ここはコード診療所。古い雑居ビルの2階、以前はネイルサロンだったという奇妙な立地にある。

「引数が……引数が、止まらないんです」

私の目の前には、白衣を着た無愛想な男——コードドクターが座っている。彼は私の言葉には反応せず、ただモニターのコードを睨みつけている。

「大丈夫ですよ」

優しく声をかけてくれたのは、傍らに立つ女性の助手さんだ。

「ここではどんな複雑なコードも治療します。まずは、あなたのコードを見せていただけますか？」

私は頷き、持参したラップトップを開いた。ゲーム開発の現場で、日々肥大化していくキャラクター生成のコード。最初は単純だった。名前と職業とレベルだけ。それが今や……。

「これです」

## 診断：コンストラクタ引数爆発症

ドクターが私の画面を覗き込む。

```perl
package Character;

sub new {
    my ($class, $name, $class_type, $level, $hp, $mp, 
        $attack, $defense, $weapon, $armor, $accessory,
        $skill1, $skill2, $skill3, $title, $description) = @_;
    
    return bless {
        name        => $name        // 'Unknown',
        class_type  => $class_type  // 'Fighter',
        level       => $level       // 1,
        hp          => $hp          // 100,
        mp          => $mp          // 0,
        attack      => $attack      // 10,
        defense     => $defense     // 5,
        weapon      => $weapon      // 'なし',
        armor       => $armor       // 'なし',
        accessory   => $accessory   // 'なし',
        skills      => [$skill1 // (), $skill2 // (), $skill3 // ()],
        title       => $title       // '',
        description => $description // '',
    }, $class;
}
```

ドクターの眉間が険しくなる。
私は弁解するように続けた。

「仕様追加のたびに引数を増やしていたらこうなって……呼び出し側はもっと悲惨なんです」

```perl
my $warrior = Character->new(
    '勇者',           # name
    '戦士',           # class_type  
    10,               # level
    500,              # hp
    50,               # mp
    80,               # attack
    60,               # defense
    '伝説の剣',       # weapon
    'ミスリルの鎧',   # armor
    '力の指輪',       # accessory
    '斬撃',           # skill1
    '突進',           # skill2
    undef,            # skill3 (なし)
    '勇敢なる者',     # title
    '魔王討伐の任を受けた勇者', # description
);
```

「チームの誰も引数の順番を覚えられなくて。スキル3を飛ばすために `undef` を入れたり、もう何がなんだか……」

ドクターが短く呟いた。

「テレスコーピング。」

「え？」

助手さんがすかさず解説に入る。

「テレスコーピング症候群ですね。引数リストが望遠鏡（テレスコープ）のように伸び縮みして、管理不能になっている状態です。ラーメン屋さんで『麺硬め・味濃いめ・脂多め・ネギ抜き・チャーシュー追加……』と一息に注文しているようなものです。途中で順番を間違えたら、大変なことになりますよね？」

「まさにその通りです！ 称号ひとつ追加するにも、全箇所の呼び出しを修正しなきゃいけなくて」

ドクターはカルテも取らず、一言だけ告げた。

「分解。」

「ぶん……かい？」

「Builder パターンによる手術を行います」

助手さんがにっこりと微笑んだ。

## 外科手術：Builder パターンの導入

「開始。」

ドクターの合図とともに、リファクタリング手術が始まった。

### 第一段階：Builder クラスの切開

「まず、生成の責務を切り出す。」

ドクターの指がキーボードを叩く音だけが響く。

```perl
package CharacterBuilder;

sub new {
    my $class = shift;
    return bless {
        name        => 'Unknown',
        class_type  => 'Fighter',
        level       => 1,
        hp          => 100,
        mp          => 0,
        attack      => 10,
        defense     => 5,
        weapon      => 'なし',
        armor       => 'なし',
        accessory   => 'なし',
        skills      => [],
        title       => '',
        description => '',
    }, $class;
}
```

「これが土台。」

### 第二段階：メソッドチェーンの接合

「次に、流動食を。」

「流動食？」

私が首を傾げると、助手さんが補足する。

「『流れるようなインターフェース（Fluent Interface）』のことです。メソッドチェーンを使って、直感的に値を設定できるようにします」

```perl
# 基本情報
sub name {
    my ($self, $value) = @_;
    $self->{name} = $value;
    return $self;  # メソッドチェーン用
}

sub class_type {
    my ($self, $value) = @_;
    $self->{class_type} = $value;
    return $self;
}

sub level {
    my ($self, $value) = @_;
    $self->{level} = $value;
    return $self;
}

# ステータス
sub hp     { my ($self, $v) = @_; $self->{hp} = $v; return $self }
sub mp     { my ($self, $v) = @_; $self->{mp} = $v; return $self }
sub attack { my ($self, $v) = @_; $self->{attack} = $v; return $self }
sub defense { my ($self, $v) = @_; $self->{defense} = $v; return $self }

# 装備
sub weapon    { my ($self, $v) = @_; $self->{weapon} = $v; return $self }
sub armor     { my ($self, $v) = @_; $self->{armor} = $v; return $self }
sub accessory { my ($self, $v) = @_; $self->{accessory} = $v; return $self }

# スキル（複数追加可能）
sub add_skill {
    my ($self, $skill) = @_;
    push @{$self->{skills}}, $skill;
    return $self;
}

# その他
sub title       { my ($self, $v) = @_; $self->{title} = $v; return $self }
sub description { my ($self, $v) = @_; $self->{description} = $v; return $self }
```

「要点は、全て `$self` を返すこと。」

ドクターの言葉は短い。
助手さんが頷く。

「自分自身を返すことで、`$builder->name(...)->hp(...)` のように次々と注文を繋げられるんです。店員さんが『麺は？』『トッピングは？』と一つずつ聞いてくれるような形ですね」

### 第三段階：Build による生成

「最後に、実体化。」

```perl
sub build {
    my $self = shift;
    return Character->new($self);
}
```

Character クラス側も、Builder を受け取るように修正された。

```perl
package Character;

sub new {
    my ($class, $builder) = @_;
    return bless {
        name        => $builder->{name},
        class_type  => $builder->{class_type},
        level       => $builder->{level},
        # ... (以下略)
    }, $class;
}
```

## 術後経過：秩序の回復

「さあ、試してみろ。」

ドクターに促され、私は新しいコードでキャラクターを生成してみた。

```perl
my $hero = CharacterBuilder->new()
    ->name('勇者')
    ->class_type('戦士')
    ->level(10)
    ->hp(500)
    ->mp(50)
    ->attack(80)
    ->defense(60)
    ->weapon('伝説の剣')
    ->armor('ミスリルの鎧')
    ->accessory('力の指輪')
    ->add_skill('斬撃')
    ->add_skill('突進')
    ->title('勇敢なる者')
    ->description('魔王討伐の任を受けた勇者')
    ->build();
```

「すごい……！ 何を設定しているのか一目瞭然です！」

引数の順番を気にする必要はない。必要な項目だけ設定すればいい。`undef` も要らない。
モニターの光が、私の顔を明るく照らしている気がした。

「これなら、チームのみんなも間違えようがない……」

感動する私をよそに、ドクターは既に追加のコードを書いていた。

「Director。」

「はい？」

「定食メニューのことです」と助手さん。「よく使う組み合わせは、テンプレート化してしまいましょう」

```perl
package CharacterDirector;

sub new {
    my ($class, $builder) = @_;
    return bless { builder => $builder }, $class;
}

# 戦士テンプレート
sub build_warrior {
    my ($self, $name, $level) = @_;
    $level //= 1;
    
    return $self->{builder}
        ->name($name)
        ->class_type('戦士')
        ->level($level)
        ->hp(100 + $level * 30)
        # ... (戦士用のパラメータ設定)
        ->build();
}
```

これを使えば、こうなる。

```perl
my $director = CharacterDirector->new(CharacterBuilder->new());
my $warrior = $director->build_warrior('戦士A', 5);
```

「たった2行……！」

私は思わず立ち上がっていた。
これで、あの悪夢のような引数地獄から解放される。

### 誤解

「ありがとうございます、ドクター！」

私は深々と頭を下げた。
ドクターは無言でコーヒーカップを手に取ったが、中身が空であることに気づいたらしい。

「あ、入れますよ」

私がポットに手を伸ばそうとすると、助手さんがさっと立ち上がって遮った。

「いえ、私が」

彼女が手際よくコーヒーを注ぐ。その横顔を見て、ドクターが小さく頷いた。

「管理。」

え？ 今、「管理（マネジメント）」って言った？ 私のコーヒーを入れることを？
ドクターは満足げにコーヒーを啜っている。
……もしかして、彼女が自分に尽くしているのを、何かのコード管理プロセスの一環だと思っているんだろうか。

助手さんは慣れた様子で微笑んでいる。
「先生、それは『ありがとう』と言うところですよ」

「……リファクタリング完了。」

診療所の出口まで、二人が見送ってくれた。
私の足取りは来た時よりもずっと軽い。

「引数がまた増えそうになったら、いつでも来てくださいね」

助手さんの言葉に、私は力強く頷いた。

「感謝は、このコードに。」

背後でドクターがそう呟いたのが聞こえた。
私は振り返らず、PCを抱え直して歩き出した。

---

## 処方箋まとめ

### Builder パターン

| 症状 | 適用すべき | 経過観察 |
| :--- | :---: | :---: |
| コンストラクタの引数が5個以上ある | ✓ | |
| 引数の順序依存でバグが頻発する | ✓ | |
| 必須パラメータとオプションが混在している | ✓ | |
| オブジェクト生成のバリエーションが多い | ✓ | |
| 引数が2〜3個で、変更も少ない | | ✓ |

### 治療のステップ

1.  **Builder クラスの作成**: 生成対象と同じプロパティを持つクラスを定義する。
2.  **Fluent Interface の実装**: 各セッターメソッドで `$self` を返し、メソッドチェーンを可能にする。
3.  **Build メソッド**: 最終的に生成対象オブジェクトを生成して返すメソッドを作る。
4.  **Director の検討**: 特定の構成（定食メニュー）を頻繁に作る場合は、Director クラスでラップする。
