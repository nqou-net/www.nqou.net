---
categories:
  - Design Pattern
date: 2026-02-14T07:07:05+09:00
draft: false
epoch: 1771020425
image: /favicon.png
iso8601: 2026-02-14T07:07:05+09:00
tags:
  - Adapter Pattern
  - Perl
  - Object-Oriented Programming
  - Code Doctor
title: 【Code Doctor】Adapter編：レガシーな血管に最新の血液を流し込め
---

## 患者プロファイル：堅実 守（45）の憂鬱

「動いているコードは触るな」
それが私の、いや、この業界で長く生き残るための鉄則だ。

私の名前は堅実 守（けんじつ まもる）。この会社の基幹システムを見守り続けて10年になる。
このシステムは頑丈だ。Perlで書かれた強固なロジックは、何年も止まることなくビジネスを支えてきた。

しかし今、私は頭を抱えている。
「ログ基盤のモダナイゼーション」――経営層からのトップダウン指示だ。
これまでの単純なテキストログから、外部のSaaSで分析可能な「JSON構造化ログ」への全面移行。

「簡単に言うてくれる……」

ため息と共にディスプレイを睨む。そこには、数千箇所に散らばるログ出力コードがあった。

```perl
# 至る所に存在するレガシーな呼び出し
$logger->log("User $id logged in");
$logger->log("Transaction processed: $tx_id");
# ... 他、数千行 ...
```

新しいログライブラリ `ModernLogger` は高機能だが、そのインターフェースは既存のものと全く異なる。

```perl
# 新しいライブラリの呼び出し方
$modern_logger->log_json(
    level   => 'info',
    message => "User $id logged in",
);
```

「引数が……全然違う」

もしこれを導入するなら、数千箇所の `$logger->log(...)` をすべて `$logger->log_json(...)` に書き換えなければならない。
1箇所でもミスをすればデータ不整合、あるいはシステムダウン。
修正漏れ、テスト工数、デグレのリスク……想像するだけで胃が痛くなる。

「やはり、断るべきか。いや、しかし……」

## 診断：インターフェース不適合症候群

「顔色が悪い」

ふと背後から声をかけられた。
振り返ると、そこには異様な二人組が立っていた。
一人はカラスのマスクをつけた長身の男。黒ずくめの服装は、どう見ても不審者だ。
もう一人は白衣の女性だが、この男の連れというだけで怪しさが増して見える。

「……誰ですか？ 関係者以外立ち入り禁止ですが」

私は警戒して数歩下がった。
セキュリティに通報すべきか迷いながら、デスクの上のスマートフォンに手を伸ばす。

「待ってください、怪しい者ではありません！」

助手の女性が慌てて制止する。いや、十分怪しいだろう。

「私たちはコードドクター。あなたのシステムの『悲鳴』を聞いて駆けつけました」

「悲鳴……？ 何を訳の分からないことを」

「先生、説明を。……先生？」

カラスマスクの男――先生と呼ばれた男――は、私の制止も聞かずにホワイトボードに近づくと、乱暴にチョークを走らせた。


「**インターフェース不適合**」

ドクターが書いたのはそれだけだった。
私が呆気にとられていると、助手の女性が申し訳さそうに微笑んだ。

「すみません、この人は少し……言葉足らずで。先生は、『既存のライブラリと新しいライブラリの形が合っていないのが病因だ』と申しております」

「病因……？ いや、それは分かってます！ 形が合わないから、合わせるために呼び出し元を全部直さないといけないんです！」

ドクターは首を横に振った。

「誤診」

短く切り捨てると、ドクターは私の肩に手を伸ばした。
（な、なんだ？ 私の苦労を労ってくれているのか……？）
胸が熱くなりかけたその時、ドクターは私のジャケットから糸くずをつまみ上げ、無造作に捨てた。
助手は無言で、ドクターにコロコロ（粘着クリーナー）を差し出した。

「……えっと、つまりですね」
助手は何事もなかったかのように話を続けた。
「海外旅行に行くとき、コンセントの形状が合わなかったらどうしますか？ 壁のコンセント工事をしますか？」

「まさか。変換プラグを使います」

「その通りです。コードの世界でも同じことをすればいいのです。**Adapter Pattern**という変換プラグを使って」

## 処方箋：Adapter Pattern

ドクターは3枚のカルテ（ソースコード）を並べ、指先でトントンと叩いた。

### 1. 既存のインターフェース (Target)

「Target。守りたい形状」

ドクターが指したコードは、単純なテキストログだった。

```perl
package LegacyLogger;
use v5.36;

sub new($class) {
    return bless {}, $class;
}

sub log($self, $message) {
    # 単純なテキスト出力
    say "[LOG] $message";
}

1;
```

### 2. 新しいインターフェース (Adaptee)

「Adaptee。移植したい臓器」

```perl
package ModernLogger;
use v5.36;
use JSON::PP;

sub new($class) {
    return bless { json => JSON::PP->new->ascii }, $class;
}

# インターフェースが LegacyLogger とは異なる！
sub log_json($self, %args) {
    # args: level, message
    my $level = $args{level} // 'info';
    my $msg   = $args{message};
    
    my $payload = {
        level     => $level,
        message   => $msg,
        timestamp => time(),
    };
    
    say $self->{json}->encode($payload);
}

1;
```

### 3. アダプター (Adapter)

「Adapter。結合部」

ドクターは最後のコードを示した。
「このクラスが、隙間を埋める」

```perl
package LoggerAdapter;
use v5.36;

# 1. Target (LegacyLogger) のインターフェースを実装し
# 2. Adaptee (ModernLogger) に処理を委譲する

sub new($class, $modern_logger) {
    return bless {
        adaptee => $modern_logger,
    }, $class;
}

# LegacyLogger と同じシグネチャ: log($self, $message)
sub log($self, $message) {
    # ここで「変換」を行う
    # 単純なメッセージを、構造化データに詰め替えて ModernLogger へ渡す
    $self->{adaptee}->log_json(
        level   => 'info',
        message => $message,
    );
}

1;
```

助手が補足する。
「外見はいつもの『LegacyLogger』と同じ顔をしていますが、裏側でこっそり『ModernLogger』に翻訳して伝えているんです。これなら、クライアント側は何も気づかずに新しい機能を使えます」

## 術後経過：魔法のプラグイン

私は震える手で、システムのエントリーポイント（DIコンテナの設定部分）だけを修正した。

```perl
#!/usr/bin/env perl
use v5.36;
use lib 'agents/code-doctor-series/adapter/impl/lib';

use LegacyLogger;
use ModernLogger;
use LoggerAdapter;
use ClientApp; # 既存のアプリケーションコード（数千行）

say "--- Before: Legacy System ---";
my $legacy_app = ClientApp->new( LegacyLogger->new );
$legacy_app->do_work;

say "\n--- After: Modern System with Adapter ---";
# ここだけ！ ここを変えるだけでいいのだ！
# ModernLogger を直接渡すとエラーになるが、Adapter で包めば...
my $modern  = ModernLogger->new;
my $adapter = LoggerAdapter->new($modern);

# ClientApp は自分が Adapter を渡されたことに気づかない
my $modern_app = ClientApp->new($adapter);
$modern_app->do_work;
```

恐る恐る実行ボタンを押す。

```text
--- Before: Legacy System ---
[LOG] Starting work...
[LOG] Work finished.

--- After: Modern System with Adapter ---
{"level":"info","timestamp":1738760000,"message":"Starting work..."}
{"level":"info","timestamp":1738760000,"message":"Work finished."}
```

「出た……！ 1行もビジネスロジックを変えていないのに、ログだけが最新になっている！」

出力されたJSONログは美しく整列していた。
私は数千行の修正作業から解放され、システムの安定性も守られたのだ。
振り返ると、ドクターは既に帰り支度を始めていた。

「先生、ありがとうございました！ 貴方は命の恩人です！」

「……請求は、コード品質で」

ドクターはそれだけ言い残し、風のように去っていった。
残された助手が、深々と頭を下げる。

「お大事に。また何かあれば（ないほうが良いですが）、いつでも呼んでくださいね」

---

## 処方箋まとめ

| 症状 | 適用すべき | 経過観察 |
| :--- | :---: | :---: |
| 既存クラスと新クラスのI/Fが合わない | ✓ | |
| 既存コード (Client) を修正したくない | ✓ | |
| 将来的に新クラスも修正予定である | | ✓ |

### 治療のステップ

1.  **Target (既存I/F)** を定義する（あるいは確認する）。
2.  **Adaptee (新クラス)** を用意する。
3.  **Adapter** クラスを作成し、TargetのI/Fを実装する。
4.  Adapter内部で、Adapteeのメソッドを呼び出すように変換処理を書く。
5.  ClientにAdapterを注入する。

### 助手より

システムが長く生き続けるほど、新しい技術との「ズレ」は必ず生じます。
その度に全体を書き直していたら、身体が持ちませんよね。
Adapterは、新旧の技術が手を取り合うための優しいクッションです。
無理に合わせようとせず、クッションを挟む知恵。それが長生きの秘訣かもしれません。
堅実さんのシステムが、これからも健やかに動きますように。
