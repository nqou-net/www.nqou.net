---
title: コードドクター〜無限増殖する細胞の悲劇（Prototype）
date: 2026-02-14T00:01:37+09:00
categories:
  - デザインパターン
  - Code Doctor
tags:
  - Prototype
  - Perl
  - オブジェクト指向
image: 
---

## 緊急搬送

「ドクター！ もうダメです……彼らが、死んでいきます！」

深夜のオフィスビル。元ネイルサロンを改装したその診療所に、僕は転がり込んだ。抱えているのは愛用のMacBook Pro。画面の中では、僕が手塩にかけて育てた「人工生命シミュレーション」が、断末魔の悲鳴（ファン全開の音）を上げている。

「……五月蝿い」

奥のデスクから、白衣の男がゆっくりと立ち上がった。コードドクターだ。彼は無表情のまま、僕の方ではなく、僕の手元のMacBookを一瞥した。

「タイムアウト、か」

短い言葉。しかし、その声には絶対的な確信があった。

「先生、すぐに診てください！ 100世代目までは順調だったんです。でも、個体数が10万を超えたあたりから、急に動きが鈍くなって……今はもう、1世代進むのに1秒以上かかっています！」

僕は必死に訴えた。このシミュレーションは、明日の学会で発表する僕の修士論文の命綱なのだ。

「どうぞ、こちらのベッドへ」

すっと差し出された紅茶の香りに振り返ると、ナース服に身を包んだ助手の女性が微笑んでいた。
「焦らなくて大丈夫ですよ。ドクターは、あなたがドアを開ける前から、サーバーのCPU使用率の異常に気づいていましたから」

え、まさか。僕はこの診療所のWi-Fiに繋いでさえないのに？
戦慄と安堵が入り混じる中、僕はMacBookを開いた。

## 精密検査

ドクターは無言でキーボードを叩き始めた。彼が使うのは `vim` だ。しかも、キーボードの刻印がすべて削り取られている。
画面に、僕が書いた「自信作」のコードが映し出される。

### 患部の状態（Before）

```perl
# Patient: Kenji
# Symptom: "The simulation is too slow because I initialize everything from scratch."

package Genome {
    sub new {
        my ($class, $seq) = @_;
        # Simulation of heavy parsing logic (e.g. validating complex rules)
        # Kenji thinks this validation MUST run every time for "safety".
        select(undef, undef, undef, 0.2); # Sleep 200ms
        return bless { sequence => $seq }, $class;
    }
}

package Bacteria {
    sub new {
        my ($class, $dna_seq, $name) = @_;
        # 毎回重いGenome初期化を行っている
        my $genome = Genome->new($dna_seq);
        return bless { genome => $genome, name => $name }, $class;
    }
}
```

「……初期化。過多だ」

ドクターが呟く。
僕は反論した。

「それは必要なんです！ ゲノム情報は複雑なので、生成時に厳密なバリデーションを行わないといけません。不正なDNAを持つ個体が生まれたら、シミュレーション全体が汚染されてしまいますから」

ドクターは眉一つ動かさず、画面の一点を指差した。

「同じ配列。何度もパースしている」

「え？」

助手がそっと補足する。
「ケンジさん、細胞分裂（mitosis）のとき、親と子は基本的に『同じ遺伝子』を持っていますよね？ それなのに、あなたのコードは毎回、ゼロからDNAの塩基配列を読み解こうとしています。まるで、自分の子供を作るのに、アダムとイブの時代から歴史をやり直しているようなものです」

「アダムとイブ……？」

僕は言葉を失った。確かに、分裂直後のDNAは親のコピーでいいはずだ。変異が起きるのはその後だ。

「初期化コスト……200ミリ秒。それが10万回。死ぬはずだ」

ドクターはデスクの引き出しから、新品のSSDを取り出して僕に差し出した。

「あ、ありがとうございます……！」

データのバックアップを取ってくれるのか。なんて手厚い配慮なんだ。僕が感動して手を伸ばすと、ドクターはいぶかしげな顔をして、そのSSDを自分のPCに繋いだ。

助手さんが苦笑いする。
「……ただのストレージ不足だったみたいですね、ドクターのPCの」

僕の勘違いだった。恥ずかしさで顔が熱くなる。ドクターは気にも留めず、画面に向き直った。

## 外科手術

「クローンを作る」

ドクターが宣言した。

「クローン……ですか？」

「そうだ。**Prototype** パターンだ」

助手が頷く。
「生物学と同じアプローチを取りましょう。ゼロから作るのではなく、既存の『完成品』をオリジン（原形）として、それをコピーするのです。そうすれば、重たい初期化処理（DNA解析）は最初の1回だけで済みます」

「でも、単なるコピーだと、参照渡しになってしまいませんか？ 親のDNAを変異させたら、子のDNAまで変わってしまうんじゃ……」

「**Deep Copy**」

ドクターの指が高速で動き出した。

### 治療後の姿（After）

```perl
# Doctor's Prescription: Use clone() to bypass heavy initialization.

package Genome {
    sub new {
        my ($class, $seq) = @_;
        # 重い初期化処理はそのまま（変える必要はない）
        select(undef, undef, undef, 0.2); 
        return bless { sequence => $seq }, $class;
    }
}

package Bacteria {
    use Storable qw(dclone); # Import dclone into this package scope

    # Prototype Interface
    sub new {
        my ($class, $dna_seq, $name) = @_;
        my $genome = Genome->new($dna_seq);
        return bless { genome => $genome, name => $name }, $class;
    }

    # The Cure: Cloning
    sub clone {
        my ($self) = @_;
        # Deep Copy is crucial here if Genome is mutable.
        # Storable::dclone provides a safe deep copy.
        return dclone($self);
    }
    
    sub set_name {
        my ($self, $name) = @_;
        $self->{name} = $name;
    }
}
```

「`Storable::dclone`……」

「はい。これはPerlにおける強力な武器です」
助手が解説する。「オブジェクトの構造を丸ごとディープコピーします。これなら、コピー先のDNAをいじっても、オリジナルには影響しません。まさに独立した生命の誕生です」

## 術後経過

修正されたコードが実行された。

```
--- Simulation Start (Cure: Prototype Cloning) ---
Initializing Prototype...
Generated Gen-1 : 0.0017 sec
Generated Gen-2 : 0.0000 sec
Generated Gen-3 : 0.0000 sec
...
Total Duration: 0.2068 sec
```

「は、速い……！」

あまりの速度に、ログが目にも止まらぬ速さで流れていく。
0.2秒。さっきまで1秒以上かかっていた処理が、一瞬で終わっている。

「初期化、バイパス完了」

ドクターが満足げに、Enterキーを「ッターン！」と叩いた。

「これなら……これなら間に合います！ 100万世代のシミュレーションも、数分で終わる！」

僕は震える手でMacBookを抱きしめた。
ドクターは既に興味を失ったのか、冷めた紅茶を啜っている。

「あの、ドクター。ありがとうございました。この恩は……」

「感謝は、このコードに」

ドクターは背中を向けたまま手を振った。
「……次だ」

僕は助手さんに目配せをして、深く一礼し、診療所を後にした。
外の空気は冷たいが、僕のMacBookの中では、無数のバクテリアたちが熱狂的な勢いで命を繋いでいた。

---

## 処方箋まとめ

### 適用基準

| 症状 | 適用すべき | 経過観察 |
|---|:---:|:---:|
| **初期化コストが高い** (DB接続、複雑な計算など) | ✓ | |
| **同じ構造のインスタンス** を大量に生成する | ✓ | |
| 設定項目が多すぎて `new` の引数が巨大化している | ✓ | |
| クラスの階層構造が複雑で `new` するのが大変 | ✓ | |

### 治療のステップ

1.  **Prototypeインターフェースの定義**
    すべての生命（オブジェクト）に「自分自身をコピーする機能」を持たせる。Perlなら `clone` メソッドを定義する。
2.  **コピー実装の選択**
    *   **Shallow Copy**: 単純なコピー。属性がプリミティブ値（数値や文字列）だけならこれで十分高速。
    *   **Deep Copy**: 内部にオブジェクトやリファレンスを持つ場合。`Storable::dclone` などを使用して、完全に独立したクローンを作る。
3.  **レジストリの活用** (Optional)
    よく使う「ひな形」を登録しておく `PrototypeManager` を作ると、さらに便利になる（RPGのモンスター生成など）。
