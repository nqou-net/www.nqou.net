---
categories:
  - tech
date: 2026-02-21T07:07:05+09:00
draft: true
epoch: 1771625225
image: /favicon.png
iso8601: 2026-02-21T07:07:05+09:00
tags:
  - design-pattern
  - perl
  - strategy
  - code-doctor
title: コードドクター【Strategy】進行性条件分岐硬化症〜ロジック血管バイパス手術〜
---

## 往診：深夜のスパゲッティ・パニック

木曜日の深夜26時。オフィスの空調が止まり、蒸し暑さが充満してきた頃、僕はSlackで飛んできた無慈悲な通知に絶望していた。

「明日朝開始のキャンペーン：『雨の日かつシルバー会員なら5%OFF、ただし食品は除く』を追加して」

マーケティング部からの依頼はいつも唐突だ。僕、継足（つぎたし）タロウは、目の前のディスプレイに表示された `Store::Cart` クラスの `calculate_total` メソッドを見つめていた。既に2000行を超え、ネストは危険水域である深度8に達している。

「もう無理だ……これ以上 `if` を書いたら、どこで計算が狂うかわからない」

キーボードに突っ伏した瞬間、背後からひやりとした冷気を感じた。エアコンは止まっているはずなのに。

「汚染区域（バイオハザード）……脂で窒息しそうだ」

弾かれたように振り返ると、そこには黒い往診鞄を持った白衣の男と、タブレットを抱えた女性が立っていた。いつの間にか入ってきたのだろうか。

「あの、どちら様ですか……？」
「大丈夫ですよ、ここはコード診療所です……あ、いえ、往診ですね」
女性は穏やかに微笑みながら、白衣の男――コードドクターの後ろに控えた。

## 診断：進行性条件分岐硬化症

ドクターは無言で僕を椅子からどかすと、キーボードをピンセットで摘み上げ、持参したアルコール綿で念入りに拭き始めた。そして、画面上のコードをメスのように鋭い視線でなぞる。

```perl
# Before: 患部の一部
sub calculate_total ($self) {
    my $total = 0;
    
    for my $item ($self->{items}->@*) {
        # ... (省略)
        # 継足タロウの苦悩
        if (defined $self->{campaign_id} && $self->{campaign_id} eq 'SUMMER_2026') {
             # ...
        } elsif (defined $self->{campaign_id} && $self->{campaign_id} eq 'WINTER_2026') {
             # ...
        }
        # ...
    }
    return int($total);
}
```

ドクターは一瞬だけ眉をひそめ、短く呟いた。

「血管（ロジック）完全閉塞……石灰化により破裂する」

「えっ、けっかん？」
僕が戸惑うと、助手の女性――ナナコさんがすかさず通訳してくれた。

「タロウさん、ドクターは『条件分岐が複雑に絡み合いすぎて、ロジックの流れが滞っている』とおっしゃっています。これ以上条件を追加すると、システム全体がダウンしますよ、と」

「で、でも！」僕は必死に弁解した。「既存のロジックを壊さないために、一番安全な『末尾にif文追加』で対応してきたんです！ 安全第一で！」

ドクターは哀れむような目で僕を見た。

「安全……壊死への絆創膏は命取りだ」

## 処方：ロジック血管バイパス手術 (Strategy Pattern)

ドクターは新しい手袋を装着し、鞄から黒いUSBメモリを取り出した。

「メス、Strategy……癒着ロジックを剥離する」

### Step 1: 人工血管（インターフェース）の形成

「まず分岐塊（ブロック）を切除し、受け皿を作る」

ドクターの指が高速で動き、新しいファイルが生成されていく。

```perl
# Store/Strategy/Role.pm (Interface)
package Store::Strategy::Role;
use v5.36;

sub apply_discount ($self, $price, $item, $context) { 
    die "Method 'apply_discount' must be implemented by subclass";
}
1;
```

### Step 2: バイパス経路（戦略クラス）の接続

「次、バイパス血管（クラス）への移植」

```perl
# Store/Strategy/Summer.pm (夏のキャンペーン)
package Store::Strategy::Summer;
use v5.36;
use parent 'Store::Strategy::Role';

sub apply_discount ($self, $price, $item, $context) {
    if ($item->{category} eq 'FOOD') {
         if (defined $context->coupon_code && $context->coupon_code eq 'SUMMER_FOOD') {
             return $price * 0.95;
         }
         return $price;
    }
    # ...ランク割引ロジック...
}
1;
```

```perl
# Store/Strategy/Normal.pm (通常時)
package Store::Strategy::Normal;
use v5.36;
use parent 'Store::Strategy::Role';

sub apply_discount ($self, $price, $item, $context) {
    if ($context->member_rank eq 'GOLD') {
        return $price * 0.98;
    }
    return $price;
}
1;
```

「臓器分離完了……相互干渉（デグレ）は回避された」

### Step 3: 血流（コンテキスト）の再循環

最後に、ドクターは僕の `Store::Cart` クラスを開いた。あの忌まわしい条件分岐の塔が一瞬で消え去り、驚くほどスリムなコードに生まれ変わる。

```perl
# Store/Cart.pm (After)
package Store::Cart;
use v5.36;
use Store::Strategy::Factory;

sub new ($class, %args) {
    my $self = bless { ... }, $class;
    # 状況に応じたバイパスを接続する
    $self->{strategy} = Store::Strategy::Factory->create($self->{campaign_id});
    return $self;
}

sub calculate_total ($self) {
    my $total = 0;
    for my $item ($self->{items}->@*) {
        # 複雑な計算は全て戦略に委譲（丸投げ）する
        my $price = $self->{strategy}->apply_discount($item->{price}, $item, $self);
        $total += $price;
    }
    return int($total);
}
```

「消えた……？」
僕は画面を凝視した。あんなに僕を苦しめていた無数の `if` や `elsif` が、たった一行の `$self->{strategy}->apply_discount(...)` に吸い込まれてしまった。

「これが Strategy パターンですよ」ナナコさんが補足する。「計算のルールを『交換可能な部品』にしてしまうんです。カート（Context）は、今どんなルールが適用されているかを知る必要はありません。ただ部品を使うだけです」

## 予後：流れを止めるな

手術が終わり、テストケースが全て緑色（Pass）に点灯した。ドクターは満足げに頷くと、僕の肩についた埃を払うように手を置いた。

「流れを止めるな……淀みは腐敗を招く」

ドクターの大きな手が、僕の肩に温かい重みを残した。その言葉が胸に沁み渡る。
僕はずっと、変化を恐れてコードを継ぎ足し、人生まで継ぎ足しで生きてきた気がする。ドクターは、そんな僕の生き方まで見抜いて……。

「……はいっ！ 僕、もっと身軽に生きてみます！ 変化を恐れず、循環させます！」

僕は涙ぐみながら大きく頷いた。ドクターは一瞬怪訝な顔をしたが、すぐに興味を失ったように背を向けた。

「行くぞ……次の患部へ」

ナナコさんは苦笑しながら手早く荷物をまとめ、ドクターを見やって小さく肩をすくめた。おそらくドクターは、オブジェクト間のデータフローの話をしていただけなのだろう。でも、僕には響いたのだから、それでいい。

「お大事に、タロウさん。リファクタリングはこまめにね」

二人が去った後のオフィスは、以前より少しだけ風通しが良くなった気がした。僕は新しいクラスファイルを作成し始めた。指取りは驚くほど軽かった。

---

## 処方箋まとめ

| 症状 | 適用すべき | 経過観察 |
| :--- | :---: | :---: |
| 条件分岐（switch/if）が巨大化し、全容が見えない | ✓ | |
| 似たようなアルゴリズムが複数あり、頻繁に入れ替わる | ✓ | |
| 条件分岐が2〜3個程度で、変更頻度も低い | | ✓ |

### 治療のステップ

1.  **戦略の定義**: アルゴリズムの共通インターフェース（Role/Abstract Class）を定義する。
2.  **戦略の抽出**: 分岐内のロジックを、具体的な戦略クラス（Concrete Strategy）として切り出す。
3.  **委譲の実装**: 呼び出し元（Context）に戦略を持たせ、処理を委譲するように書き換える。
4.  **交換機構**: 必要に応じて戦略を切り替える仕組み（FactoryやDI）を用意する。

### 助手より

条件分岐が増えると、つい「とりあえずif文を追加」したくなりますよね。でも、それはコードの動脈硬化の始まりです。
Strategyパターンを使えば、新しいルールが増えても「新しいクラスを作る」だけで済み、元のコードを汚さずに済みます。仕様変更に強い、しなやかなコードを目指しましょう！
