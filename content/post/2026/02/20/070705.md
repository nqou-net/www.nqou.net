---
categories:
  - design-pattern
date: 2026-02-20T07:07:05+09:00
draft: false
epoch: 1771538825
image: /favicon.png
iso8601: 2026-02-20T07:07:05+09:00
tags:
  - perl
  - design-pattern
  - proxy
  - code-doctor
title: 'コードドクター: Proxy - 無秩序直接参照症候群と受付窓口の設置'
---

社内の画像管理システムを担当している僕は、途方に暮れていた。

「一覧画面が重い」

このクレームが毎日のように飛んでくる。画像を表示するだけなのに、サーバーのメモリ使用量が天井知らずに跳ね上がるのだ。画像を100枚並べると、システムが悲鳴を上げる。サムネイルを見ているだけなのに。

深夜、モニターに映るメモリグラフを睨みながら、僕は頭を抱えていた。

## 往診

「呼ばれた気がした」

振り向くと、白衣の人物が無表情で立っていた。隣には穏やかな笑みを浮かべた女性がいる。胸元のネームプレートには「ナナコ」と書かれていた。

「あ、あの、どちら様で……」

白衣の人物は返事もせずにモニターを覗き込んでいる。挨拶もなしに何をしているのか。正直、不審者にしか見えない。僕は椅子を少し引いた。

ナナコと名札のある女性が微笑んで言った。

「大丈夫ですよ、ここはコード診療所です……あ、いえ、往診ですね。コードの悲鳴が聞こえたので駆けつけました」

コード診療所？聞いたことがあるような、ないような。都市伝説みたいな話だったはずだ。

ドクターと呼ばれる人物はメモリグラフを一瞥し、呟いた。

「……全身CT、毎回」

何を言っているのか分からない。

ナナコさんが微笑みながら訳してくれた。

「サムネイルを見たいだけなのに、毎回フルサイズの画像を読み込んでいる——そういうことですね、先生」

## 診断

ドクターは無言で僕のコードをスクロールし始めた。

画像クラスが呼ばれるたびに、コンストラクタで即座にファイルを読み込んでいる箇所で指が止まる。

「直接参照。受付がない」

ナナコさんが続ける。

「患者さんが診察室を通らず、直接CTスキャン室に駆け込んでいるような状態ですね。検査技師さんが過労で倒れそうになっています」

言われてみれば、確かにそうかもしれない。サムネイルが欲しいだけなのに、毎回フルサイズの画像を読み込んでいる。

「で、でも、画像が必要だから読み込んでるだけで……」

ドクターは無言で別の箇所を指差した。アクセスログを取るためのコードが、3つのファイルにコピペされている。

「権限確認……散在」

ナナコさんがため息をついた。

「受付窓口がないから、入口管理もバラバラになってしまっているんですね」

## 患部

僕は恐る恐る、問題のコードを見せた。

```perl
package Image;
use v5.36;

sub new($class, $filepath) {
    my $self = bless {
        filepath => $filepath,
        data     => undef,
    }, $class;
    
    # コンストラクタで即座にファイル読み込み
    # TODO: サムネイル用に最適化したいけど時間がない
    $self->_load_file();
    
    return $self;
}

sub _load_file($self) {
    say "Loading full image: $self->{filepath}";
    $self->{data} = "FULL_IMAGE_DATA_OF_$self->{filepath}";
    $self->_log_access();
}

sub _log_access($self) {
    # FIXME: これが各所にコピペされている
    say "[LOG] Accessed: $self->{filepath}";
}

sub get_thumbnail($self) {
    # サムネイルが欲しいだけなのにフルサイズを返す
    return substr($self->{data}, 0, 20) . "...";
}

sub display($self) {
    return $self->{data};
}

1;
```

ドクターが眉をひそめた。

「……症状は明白」

ナナコさんが解説する。

「`new` を呼んだ瞬間に `_load_file` が走っていますね。サムネイル一覧で100枚表示したら、100回のフルサイズ読み込みが発生します。そりゃメモリも悲鳴を上げますよ」

## 処方箋

ドクターは静かにキーボードに手を伸ばした。

「代理人を立てる」

ナナコさんが僕に向き直る。

「本物の画像クラスの前に『受付窓口』を置くんです。受付が必要なときだけ本物を呼び出す。これが **Proxy Pattern** ですね」

ドクターの指がキーボードの上を走り始めた。僕には何をしているのか分からないが、ナナコさんが解説してくれた。

「まず、本物の画像クラスを整理していますね」

```perl
package RealImage;
use v5.36;

sub new($class, $filepath) {
    my $self = bless {
        filepath => $filepath,
        data     => undef,
    }, $class;
    
    $self->_load_file();
    return $self;
}

sub _load_file($self) {
    say "Loading full image: $self->{filepath}";
    $self->{data} = "FULL_IMAGE_DATA_OF_$self->{filepath}";
}

sub get_thumbnail($self) {
    return substr($self->{data}, 0, 20) . "...";
}

sub display($self) {
    return $self->{data};
}

1;
```

ナナコさんが続ける。

「そして、その前に立つ代理人——Proxyを用意しています」

```perl
package ImageProxy;
use v5.36;
use RealImage;

sub new($class, $filepath) {
    my $self = bless {
        filepath   => $filepath,
        real_image => undef,  # 必要になるまでnull
    }, $class;
    
    # ここではファイル読み込みをしない！
    $self->_log_access("thumbnail_request");
    
    return $self;
}

sub _log_access($self, $action) {
    # アクセスログを一元管理
    say "[LOG] $action: $self->{filepath}";
}

sub _ensure_loaded($self) {
    # 遅延読み込み：必要になって初めてRealImageを生成
    unless ($self->{real_image}) {
        $self->_log_access("full_load");
        $self->{real_image} = RealImage->new($self->{filepath});
    }
}

sub get_thumbnail($self) {
    # サムネイルはプレースホルダーを返す
    return "[Thumbnail: $self->{filepath}]";
}

sub display($self) {
    # フル表示が必要になって初めて実際の画像を読み込む
    $self->_ensure_loaded();
    return $self->{real_image}->display();
}

1;
```

ナナコさんが指差す。

「ポイントは `_ensure_loaded` メソッドですね。`display` が呼ばれるまで、本物の `RealImage` は生成されません。サムネイルだけなら、軽量なプレースホルダーを返せばいいんです」

ドクターが短く付け加えた。

「ログも一元化」

「散らばっていたアクセスログも、Proxyに集約されていますね。受付で入退室管理をしているようなものです」

## 術後経過

テスト環境で一覧画面を開く。

以前は読み込みに数秒かかっていた表示が、一瞬で完了した。

```
--- 3枚のサムネイルを表示 ---
[LOG] thumbnail_request: photo1.jpg
[LOG] thumbnail_request: photo2.jpg
[LOG] thumbnail_request: photo3.jpg

--- 1枚だけクリックして詳細表示 ---
[LOG] full_load: photo1.jpg
Loading full image: photo1.jpg
```

「すごい……"Loading full image" が1回だけだ」

ナナコさんが微笑んだ。

「以前は3回出ていましたからね。必要なときに、必要なものだけ。それがProxyの力です」

ドクターは黙って頷いた。

ふと、僕のデスクに紙コップが置かれた。中には温かいコーヒーが入っている。

（え……もしかして、深夜まで頑張った僕を労ってくれてるのか……？）

ナナコさんがそっと耳打ちする。

「先生、廊下の自販機が故障していてボタンが戻らなくて。2杯出てきたんです」

……なるほど。ただの偶然だった。

ドクターは満足げに——いや、単に作業が終わっただけかもしれない——コーヒーを一口飲んだ。

「代理人の活用……基本」

ナナコさんが微笑む。

「直接会わなくても済む用件は、窓口で処理する。それだけで負担が軽くなりますよ」

ドクターは静かに白衣を翻し、夜の闇に消えていった。

僕はコーヒーを一口飲みながら、明日から「受付窓口」を意識した設計を心がけようと決意した。

---

## 処方箋まとめ

### 適用基準

| 症状 | 適用すべき | 経過観察 |
|------|:----------:|:--------:|
| オブジェクト生成のコストが高く、遅延させたい | ✓ | |
| リソースへのアクセス制御（権限チェック、ログ）が必要 | ✓ | |
| リモートオブジェクトへのアクセスを透過的にしたい | ✓ | |
| 単純なオブジェクトで特別な制御が不要 | | ✓ |

### 治療のステップ

1. **Subject Interface の定義**: RealObject と Proxy が共通で実装するインターフェースを決める
2. **RealSubject の実装**: 実際の処理を行う本体クラス
3. **Proxy の実装**: RealSubject への参照を持ち、必要に応じて遅延生成・アクセス制御を行う
4. **クライアントコードの修正**: `new RealSubject` を `new Proxy` に置き換える

### 助手より

お疲れ様でした。Proxyパターンは「本物に会う前に、まず受付を通す」という発想です。遅延読み込み、アクセス制御、ログ記録……受付がいるだけで、こんなにも秩序が生まれるんですね。

先生は無愛想ですが、コードへの愛情は本物です。そこだけは信じてあげてくださいね。
