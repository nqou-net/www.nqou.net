---
date: 2026-02-09T00:25:41+09:00
description: RPGのダメージ計算関数がif-else地獄になっていませんか？Strategyパターンで500行の巨大関数を分割し、新しい攻撃タイプを5行で追加できる健康なコードに蘇生するコードドクター奮闘記
draft: false
epoch: 1770564341
image: /images/2026/02/09/strategy-pattern-eye-catch.jpg
iso8601: 2026-02-09T00:25:41+09:00
tags:
  - perl
  - design-patterns
  - strategy-pattern
  - rpg
  - battle-system
  - game-development
  - refactoring
  - code-doctor
title: コードドクター〜ダメージ計算式緊急手術：Strategyパターンで500行のif-else地獄を救え
toc: true
---

午前2時。都市の喧騒が眠りにつく頃、路地裏の雑居ビルに明かりが灯る場所がある。

「コード診療所」。

かつてネイルサロンだったその場所は、今は行き場を失ったプログラマたちが最後にすがる駆け込み寺となっていた。消毒液と、微かに残るアセトン（除光液）の匂いが混じり合う奇妙な空間。

私は今、その待合室で震えていた。RPGのバトルシステム担当、ケンタ（28歳）。納期は来週。しかし、私の書いたダメージ計算コードは、もはや誰にも触れられない「怪物」になっていたのだ。

## 来院：500行の怪物

「どうぞ、お入りください」

白衣を着た女性が優しく声をかけてくれた。彼女は **ナース（助手）** 。手にはカルテ代わりのタブレットを持っているが、その爪は完璧に手入れされ、桜色に輝いている。

『……限定ウニクリーム、14時までか……』
彼女は真剣な眼差しで画面を見つめ、そう呟いた。何かの医療用語だろうか？ 私が戸惑っていると、彼女はハッとしてタブレットを伏せ、柔和な笑みを向けた。

診察室に通されると、デスクの向こうに男が座っていた。
 **コードドクター** 。
無精髭に、クマのある鋭い目。モニターの光だけが彼の顔を青白く照らしている。彼は私を一瞥もしない。

「あの……これです。僕のコード」

私は震える手で、プリントアウトしたソースコードを差し出した。それはまるで古文書のように分厚い束だった。

### 症状：条件分岐過多症候群

```perl
package DamageCalculator;

sub calculate {
    my ($self, $attack_type, $attacker, $defender) = @_;
    my $damage = 0;

    if ($attack_type eq '物理') {
        $damage = $attacker->{attack} - $defender->{defense};
        # ... クリティカル計算 ...
        # ... 属性補正 ...
    }
    elsif ($attack_type eq '魔法') {
        $damage = $attacker->{magic_attack} - $defender->{magic_defense};
        # ... 魔法独自の補正 ...
    }
    elsif ($attack_type eq '固定') {
        # ... 固定ダメージ計算 ...
    }
    elsif ($attack_type eq '割合') {
        # ... 割合ダメージ計算 ...
    }
    # ... さらに「毒」「反射」「カウンター」「連撃」など延々と続く ...
    
    return $damage;
}
```

ドクターはコードの束をパラパラと捲った。その指が、あるページで止まる。

「……爆発してるな」

低い声。それだけだった。

「え？」

すかさずナースが私の横に立ち、穏やかに解説を始めた。

「ドクターは『 **条件分岐過多症候群** ね』とおっしゃっています。ケンタさん、新しい攻撃タイプを追加するたびに、この`if-else`文を書き足していきましたね？」

「は、はい。最初は物理と魔法だけだったんです。でも、プランナーが『割合ダメージを入れたい』『貫通攻撃も欲しい』って次々言うから……気付いたら500行を超えていて……」

ドクター眉間の皺が深くなる。

「修正のたびに、関係ないバグが出るだろう」

「っ！ なぜそれを……！ 『毒』の計算を直したら、なぜか『物理』のクリティカルが出なくなって、デバッグに3日かかりました……」

ドクターは黙って頷き、ナースに目配せをした。

「分かりました。このままでは、次の『仕様変更』というウイルスに耐えられません。 **Strategyパターン** による緊急手術が必要です」

## 診断：電動ドライバーと交換ビット

「Strategy……パターン……？」

「はい。ケンタさん、これを見てください」

ナースが道具箱から取り出したのは、 **電動ドライバー** と、数種類の **ビット（先端パーツ）** だった。

「このドライバー、ネジの形状に合わせて先端を交換できますよね？ プラス、マイナス、六角……。もしこれが、先端が本体と溶接されていて交換できなかったらどうですか？」

「えっと……ネジの種類ごとに、ドライバーを何本も持ち歩かないといけなくなりますね」

「今のあなたのコードは、まさにそれです。『ダメージ計算』という本体に、『物理』や『魔法』という先端が溶接されてしまっている状態。だから、少し変えるだけで全体を作り直さなきゃいけないんです」

![Strategyパターンの概念図：交換可能なビット](/public_images/2026/02/09/strategy-concept.jpg)

彼女は鮮やかな手つきでドライバーのビットをカチリと交換した。

「 **Strategyパターン** は、この『先端』を交換可能にする設計です。『計算の手順』をクラスとして独立させ、実行時にカチッとはめ込むんです」

## 外科手術：インターフェースの抽出

ドクターがキーボードを引き寄せた。カタカタカタ、と静かな音が響く。

「まずは……切り離す」

ドクターが呟く。

### 処方箋1: Strategyインターフェース

「まず、『ダメージ計算』という行為だけを定義した共通の型を作ります」

```perl
package DamageStrategy;

# インターフェース（共通の約束事）
sub calculate ($self, $attacker, $defender, %params) {
    die "サブクラスで実装してください";
}
```

「これが『交換可能なビット』の規格です」とナースが補足する。「これを継承して、具体的な計算を作っていきます」

### 処方箋2: 具体的な戦略（Concrete Strategy）

ドクターの手が加速する。あの巨大な`if`文の塊が、次々と小さなクラスへと解体されていく。

```perl
# 物理ダメージ専用の部品
package PhysicalDamageStrategy {
    use parent -norequire, 'DamageStrategy';

    sub calculate ($self, $attacker, $defender, %params) {
        # 物理独自の計算ロジック
        my $damage = $attacker->{attack} - $defender->{defense};
        # ... クリティカルや属性の処理 ...
        return $damage;
    }
}

# 魔法ダメージ専用の部品
package MagicDamageStrategy {
    use parent -norequire, 'DamageStrategy';

    sub calculate ($self, $attacker, $defender, %params) {
        # 魔法独自の計算ロジック（物理とは係数などが違う）
        my $damage = $attacker->{magic_attack} - $defender->{magic_defense};
        # ... 
        return $damage;
    }
}
```

「見てください、ケンタさん。あんなに混ざり合っていたロジックが、 **独立したファイル** に分かれました。これなら『魔法』を修正しても、『物理』にバグが飛び火することはありません」

「すごい……。これなら、僕でも安心して触れます」

### 処方箋3: コンテキスト（利用側）

「最後に、これを使う本体（Context）を直します」

```perl
package DamageCalculator;

sub new {
    my ($class) = @_;
    return bless { strategies => {} }, $class;
}

# ビット（作戦）をカチッとはめる
sub register_strategy {
    my ($self, $name, $strategy_obj) = @_;
    $self->{strategies}{$name} = $strategy_obj;
}

# 計算実行
sub calculate {
    my ($self, $type, %args) = @_;
    
    # 指定されたタイプのビットを取り出す
    my $strategy = $self->{strategies}{$type} 
        or die "知らない攻撃タイプです: $type";
        
    # 委譲する（実際の計算はStrategyに任せる）
    return $strategy->calculate(%args);
}
```

「これで完成です。`if`文は消滅しました」

「使う時はこうですね」

```perl
# 使い方：必要な「ビット」だけを装着して使う
my $calc = DamageCalculator->new();
$calc->register_strategy('物理', PhysicalDamageStrategy->new());
$calc->register_strategy('魔法', MagicDamageStrategy->new());

# 後は呼び出すだけ
my $dmg = $calc->calculate('物理', $hero, $monster);
```

ナースの声が誇らしげに響く。

## 術後経過：誤解と愛

モニターに映し出された新しいコード。それは美しかった。
`if-else`の迷宮はなくなり、整然と並んだ小さなクラスたちが、それぞれの責務を果たしている。

ナースはプリントアウトした新しいコード──Strategyクラスたちの紙束──を丁寧に揃え、うっとりとした表情でその表面を指でなぞった。

「ふふっ……綺麗。バラバラだった子たちが、こうして自立して……。お互いに干渉せず、でも同じインターフェースで繋がっている……健気ですね」

彼女はまるで我が子を愛でるように微笑んでいる。

その時、ドクターがぴくりと反応した。彼女の指先がコードをなぞる仕草を、じっと見つめている。
ドクターはふいっと顔を逸らすと、満足げに鼻を鳴らした。その慈愛に満ちた表情を、自分への遠回しな告白として受け取ったことは明らかだった。

「……良い仕事だ」

ドクターがボソリと言った。

「はい！ ドクターの手際、最高でした！」

ナースが無邪気に笑う。
受付で耳にした「ウニクリーム」という言葉が脳裏をよぎる。彼女の頭の中には、 **明日のランチのこと** と、 **リファクタリングされたコードの美しさ** しかなかったが、ドクターにとってはその笑顔もまた、特別な意味を持って響いているようだった。

## 退院指導：拡張性の獲得

「これで退院です、ケンタさん」

ナースが新しい設計図を渡してくれた。

「今後、『即死攻撃』や『HP吸収』を追加したくなったらどうすればいいか分かりますか？」

「はい！ `DamageStrategy`を継承した新しいクラスを一つ作って、`register_strategy`で登録するだけです。元の`DamageCalculator`も、他のクラスも、一切触る必要がありません！」

「その通り。 **Open-Closed Principle（開放閉鎖の原則）** ですね。拡張には開いていて、修正には閉じている状態です」

私は深く頭を下げた。

「ありがとうございました！ お支払いはおいくらですか……？」

ドクターが椅子を回転させ、背を向けたまま手をひらつかせた。

「……感謝は、このコードに」

「あ、はい。ドクターは『お代は結構ですが、代わりに **ユニットテストを書くこと** を約束してください』とおっしゃっています」

「もちろんです！ テストも書きやすくなりましたから！」

私は軽やかな足取りで診療所を後にした。
背後で、ナースの「あぁっ！ 今月の電気代がこんなに……ドクター、またタダ働きですか！？」という悲鳴が聞こえた気がしたが、夜風のせいにしておこう。

---

## 処方箋まとめ

### Strategyパターンの適用基準

| 症状 | 適用すべき | 経過観察 |
|------|-----------|----------|
| アルゴリズム（計算式や振る舞い）が頻繁に変更・追加される | ✓ | |
| 巨大な条件分岐（if-else/switch）で振る舞いを切り替えている | ✓ | |
| 新しい振る舞いを追加する際に、既存コードの修正が必要（OCP違反） | ✓ | |
| アルゴリズムのバリエーションがほとんどなく、今後も増えない | | ✓（過剰設計の恐れ） |
| 振る舞いの違いが、単なる定数パラメータの違いで済む | | ✓ |

### 治療のステップ

1.  **戦略インターフェースを定義**: 全ての戦略が守るべき共通のメソッド（`calculate`など）を決める。
2.  **具体的な戦略（Concrete Strategy）を実装**: アルゴリズムごとにクラスを分け、インターフェースを実装する。
3.  **コンテキスト（利用側）を修正**: 内部の条件分岐を削除し、戦略オブジェクトを保持・委譲する形にする。
4.  **戦略の注入**: 実行時に適切な戦略オブジェクトをコンテキストに渡す（Dependency Injection）。

