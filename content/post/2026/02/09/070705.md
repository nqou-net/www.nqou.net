---
title: "コードドクター: Singleton - 多重人格症候群と唯一の真実"
date: 2026-02-09T07:07:05+09:00
categories: [ "design-pattern" ]
tags: [ "singleton", "perl", "code-doctor" ]
draft: false
---

雑居ビルの地下、湿ったコンクリートの匂いがする廊下の突き当たりに、その「コード診療所」はあった。
ドアには『コード診療所』とだけ書かれた無骨なプレート。
僕は深呼吸を一つして、ドアをノックした。

「どうぞ」

中から聞こえたのは、予想外に穏やかな女性の声だった。

## I. 往診

ドアを開けると、そこは奇妙な空間だった。
待合スペースと思われる場所には、O'Reillyの技術書や古いマザーボードが山のように積まれている。まるでカオスエンジニアリングの実践現場だ。
しかし、部屋の奥にある受付カウンターだけは、ミリ単位で整頓されていた。

「お待ちしておりました。インフラチームのリーダーの方ですね？」

白衣を着た女性が、にこやかに立ち上がる。助手のナナコさんだ。
彼女の背後の診察室には、トリプルディスプレイに向かう男の背中が見える。
HHKBの乾いた打鍵音だけが、部屋に響き渡っていた。
弘法筆を選ばずと言うが、あの背中は徹底的に道具を選ぶタイプのエンジニアだ。

「あの、ドクター？」
僕が声をかけるが、男は振り返りもしない。

「……」

「すみません、今は集中モードですので」
ナナコさんが申し訳なさそうに微笑む。
「患部……いえ、該当のコードを先に見せていただけますか？」

僕は頷き、持参したラップトップを開いた。

## II. 診断

僕が持ち込んだのは、チーム内で問題になっている設定管理モジュールだ。
あらゆる箇所でこのモジュールがインスタンス化され、そのたびに重い初期化処理が走っている。

```perl
package Bad::Config;
use v5.36;

sub new ($class) {

    # シミュレーション: 設定ファイル読み込み（重い処理）
    my $config_data = {
        database  => 'mysql://localhost:3306/app',
        timeout   => 30,
        debug     => 1,
        loaded_at => time(),
    };

    return bless $config_data, $class;
}

1;
```

画面を覗き込んだドクターの手が、ピタリと止まった。
スクロール速度が異常に速い。彼は一瞬でコードの構造を把握したようだ。
そして、画面上の二箇所――メイン機能とバッチ処理の呼び出し部分――を指で弾いた。

「……多重人格。」

「えっ？」
思わず聞き返す。

「システムがアイデンティティ・クライシスを起こしていますね」
ナナコさんがすぐに解説を加える。
「設定という『記憶』が乖離し、現場が混乱しています。あっちの私とこっちの私で、言っていることが違う……そんな状態です」

「確かに……バッチとアプリで挙動が微妙に違って……まさかこれが原因で？」
設定ファイルを読むタイミングがずれることで、情報の不整合が起きていたのか。

ドクターは無言でキーボードを構えた。

「執刀する。」

## III. 処置

ドクターの指がショートカットキーを叩く。無駄のない動きだ。
彼は `Bad::Config` を開き、あっという間に修正を加えていく。

「ここです」
ナナコさんが指差す先、`sub new` の中身が書き換わっていく。

### 1. 魂の器を用意する

```perl
    # state変数: 一度だけ初期化され、値を保持し続ける（Perl 5.10+）
    state $instance;
```

「`state`……？ クロージャも使わずに？」
僕が驚くと、ナナコさんが頷いた。

「Perl 5.10からの秘儀、そしてv5.36で標準装備された『魂の器』です。これで記憶は一つに統合されます」

### 2. 記憶の有無を確認する

```perl
    # すでにインスタンスがあればそれを返す
    return $instance if defined $instance;
```

「人格が存在しているかを確認し、存在すれば即座にその人格を呼び出します」

### 3. 人格を形成する

```perl
    # 初回のみ生成
    my $config_data = {
        database  => 'mysql://prod-db:3306/app',
        timeout   => 60,
        debug     => 0,
        loaded_at => time(),
    };

    $instance = bless $config_data, $class;
    return $instance;
```

ドクターがEnterキーを「ッターン！」と叩く。
テストランナーが走り、オールグリーンのバーが表示された。

## IV. 予後

治療完了だ。
システムは安定し、頻発していたIO負荷のアラートも嘘のように静まり返った。
まさに、多重人格が統合され、唯一の真実を手に入れた瞬間だった。

「なんというか……魔法みたいだ」
僕は感無量で立ち上がった。

すると、ドクターが無言で近づいてきた。
そして僕の手に、何か硬くて小さなものを握らせた。

見ると、それは黒い小さなプラスチック片だった。

（これは……USBメモリのキャップ？ いや、違う）
僕は直感した。
（これは『封印』のメタファーだ。二度と記憶を拡散させるなという、彼なりのメッセージ……！）

「受け取りました、ドクター。この重み、一生忘れません！」
僕は熱く彼の手を握り返し、深々と頭を下げて診療所を後にした。

　　　***

患者が去った後の診察室。

「ドクター、今の。」
ナナコさんが静かに声をかける。

「……？」
ドクターが怪訝そうな顔をする。

「患者さんの自転車の鍵のキャップ、返し忘れてますよ」

「……」

ドクターは少し首を傾げ、再びディスプレイに向き直った。

---

## 処方箋まとめ

| 症状 | 適用すべき | 経過観察 |
| :--- | :---: | :---: |
| 設定情報が至る所で生成されている | ✓ | |
| ログ出力など、単一のリソースを共有したい | ✓ | |
| グローバル変数を隠したいだけ | | ✓ |

### 治療のステップ

1.  **v5.36の採用**: `use v5.36;` でモダンなPerl機能を有効化する。
2.  **State変数の宣言**: コンストラクタ内に `state $instance;` を宣言し、インスタンスを保持させる。
3.  **ガード節の追加**: `return $instance if defined $instance;` で、既存インスタンスがある場合は即座に返す。
4.  **初回初期化**: インスタンスが存在しない場合のみ初期化処理を行い、`state`変数に代入する。

### 助手より

かつてのSingleton実装はクロージャを使ったりと複雑でしたが、現代のPerlでは驚くほどシンプルに書けます。
「唯一のインスタンス」が必要な場面では、ぜひこのパターンを思い出してくださいね。
システムが混乱しないよう、記憶は一つに保ちましょう。お大事に。
