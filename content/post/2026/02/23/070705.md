---
title: "コードドクター【Observer】急性癒着性神経痛〜疎結合の神経網〜"
date: 2026-02-23T07:07:05+09:00
image: "static/public_images/2026/clinic.jpg"
description: "「通知先が増えるたびにコードをコピーしているだって？ それはコードに対する拷問だ」深夜のオフィスに現れた黒い鞄の男は、僕のスパゲッティコードを見て静かに宣告した。"
categories: [tech, perl, design-pattern]
tags: [perl, design-pattern, observer-pattern, code-doctor]
author: "Code Doctor"
---

## 救急搬送（深夜のオフィスにて）

「あと一つ……これさえ足せば、家に帰れる……」

深夜2時。誰もいないオフィスで、モニターの光だけが僕の顔を青白く照らしている。明日の朝一番でリリース予定の「記事公開機能」に、急遽「LINE通知」を追加しなければならなくなったのだ。

既存の`publish`メソッドはすでに300行を超えている。Slack通知、Discord通知、メール通知……そこに無理やりLINEのAPIコールをねじ込む。`if`文のネストが深くなるにつれ、僕の心拍数も上がっていく。

「コピペして、変数を変えるだけ。動けばいい。動けば……」

震える手でキーボードを叩いていると、背後から低い声が聞こえた。

「悲鳴が聞こえるな」

「えっ！？」

振り返ると、黒いロングコートを着た男が立っていた。傍らには、タブレット端末を持った女性。

「ひ、悲鳴って……僕の？ 独り言、聞かれてました？」

男は僕の質問を無視し、無遠慮にモニターを覗き込んだ。

「コードが窒息している」

「ドクター、患者さんのコードのことですね。窒息寸前で助けを求めているようです」

助手のナナコさんが冷静な声で補足した。「コード診療所」の噂は聞いたことがあったが、まさか自分のオフィスに往診に来るとは。

## 診断：急性癒着性神経痛

ドクターは椅子に座ると、キーボードには触れず、画面上のコードを指でなぞった。その指先が、巨大な`if`文の塊のところで止まる。

「酷い癒着だ」

「ゆ、癒着ですか？」

「血管と皮膚が完全に癒着している」

ドクターのあまりに物騒な言い回しに、僕は言葉を失う。ナナコさんが、困ったように微笑んで解説してくれた。

「着替えるだけで大出血ですよ、とおっしゃっています。記事を公開するロジック（血管）と、どこに通知するかというロジック（皮膚）が、密接に結びつきすぎているということですね」

確かにその通りだった。僕は冷や汗を拭った。

### 患部：肥大化した通知ロジック

```perl
package Article;
use v5.36;

sub publish ($self) {
    say "Publishing article: " . $self->{title};

    # Slack Notification
    # 元々はここだけだったのに...
    if ($self->{enable_slack}) {
        say "[Slack] Sending to #general: New article published!";
    }

    # Discord Notification
    # 3ヶ月前に追加された
    if ($self->{enable_discord}) {
        say "[Discord] Sending to guild: New article published!";
    }

    # Email Notification
    # 先週追加された...
    if ($self->{enable_email}) {
        say "[Email] Sending to subscribers: New article published!";
    }

    # LINE Notification
    # 昨日言われて急いで追加した
    if ($self->{enable_line}) {
        say "[LINE] Sending to official account: New article published!";
    }
}
```

ドクターが、画面上の`if ($self->{enable_discord})`の行を指先で弾いた。

「この腫瘍を切除する」

「えっ、でも消したら機能要件が……！」

「神経の分離手術（Observer Pattern）を行う」

「機能は残して依存だけを消す、という意味ですね。ドクター、オペの準備を」

## 手術：Observerパターンによる神経回路の再構築

ドクターは鞄から愛用のメカニカルキーボードを取り出すと、目にも止まらぬ速さでタイピングを始めた。

「まず神経を作る」

「通知を受け取る側の規格（Interface）を統一するんですね」

```perl
# lib/Role/Observer.pm
package Role::Observer;
use v5.36;

# インターフェースとしての役割
sub update ($self, $subject) {
    die "Subclass must implement 'update' method";
}
1;
```

「次は脳だ」

「『何かが起きた』と発信するだけの機能（Subject）を持たせるわけですね」

```perl
# lib/Role/Subject.pm
package Role::Subject;
use v5.36;

sub observers ($self) {
    $self->{_observers} //= [];
}

sub add_observer ($self, $observer) {
    push $self->observers->@*, $observer;
}

sub notify_observers ($self) {
    for my $observer ($self->observers->@*) {
        $observer->update($self);
    }
}
1;
```

ナナコさんが横から補足する。

「Perl v5.36の `postfix dereference`（`$self->observers->@*`）を使っていますね。リストへのアクセスが直感的で、とても読みやすいです」

### 処置：癒着の剥離

「癒着を剥がす」


ドクターは`Article`クラスを開くと、あの忌まわしい`if`文の山を、躊躇なく`Delete`キーで消し飛ばした。

「ああっ！ 僕の三時間の努力が！」

「努力の方向が間違っている」

```perl
package Article;
use v5.36;
use parent 'Role::Subject'; # Subjectの役割を持つ

sub publish ($self) {
    say "Processing publish: " . $self->{title};
    
    # 記事の保存などのメインロジック...
    $self->save_to_db;

    # 通知ロジックが消え、単に「起きたこと」を伝えるだけになった
    $self->notify_observers;
}

# ...
```

「なんと……たった一行に」

「これで`Article`クラスは、通知先を知る必要がなくなった」

「知っているのは外部（Client）だけ、ということですね」

### 移植：手足（Observer）の再建

そしてドクターは、消したロジックをそれぞれの専用クラスへと移植していく。

```perl
package Notification::Slack;
use v5.36;
use parent 'Role::Observer';

sub update ($self, $subject) {
    # 実際にはここにSlack APIへの投稿処理が入る
    say "[Slack] Notification: " . $subject->title;
}

package Notification::Discord;
use v5.36;
use parent 'Role::Observer';

sub update ($self, $subject) {
    say "[Discord] Message sent: " . $subject->title;
}
```

最後に、動作確認のためのスクリプトを見せてくれた。

```perl
use v5.36;
use Article;
use Notification::Slack;
use Notification::Discord;

my $article = Article->new(title => 'Observer Pattern Explained');

# 必要な通知先だけを「プラグイン」のように追加
$article->add_observer(Notification::Slack->new);
$article->add_observer(Notification::Discord->new);

# 将来的に「LINE通知」を足したければ...
# $article->add_observer(Notification::Line->new);
# と書くだけ。Articleクラスの修正は不要。

$article->publish;
```

「実行」

エンターキーが叩かれると、ターミナルには美しいログが流れた。

```
Processing publish: Observer Pattern Explained
(Saved to DB)
[Slack] Notification: Observer Pattern Explained
[Discord] Message sent: Observer Pattern Explained
```

痛みが消えた。まるで、最初からそうあるべきだったかのように、コードが深呼吸しているのがわかった。

## 予後：勘違いの鼓動

「素晴らしい……。まるで魔法です」

僕は感動のあまり、席を立ってドクターに詰め寄った。

「これなら、明日急に『TikTokにも通知しろ』と言われても怖くありません！ ドクター、ありがとうございます！」

ドクターは立ち上がり、帰り支度を始めたが、ふと立ち止まって僕の方へ顔を近づけてきた。距離が近い。黒い瞳が、僕の顔をじっと見つめている。心臓が跳ねた。

（なんて熱い視線だ……。僕のエンジニアとしてのポテンシャルを見抜いて、期待してくれているのか？ それとも……この高鳴りは……）

ドクターの手が伸びてきて、僕の肩に触れる……かと思いきや、僕の背後の壁にかかっているカレンダーを直した。

「ナナコ、急ぐぞ」

「えっ」

「深夜アニメの放送に間に合わない」

「はいはい、視聴予約はしてありますよ」

ドクターはそのまま風のように去っていった。ナナコさんが荷物を持ちながら、苦笑して僕に会釈する。

「お大事に。そのドキドキは、ただのカフェイン過剰摂取ですよ」

「は、はい……」

静まり返ったオフィスに、美しく整頓されたコードだけが残された。

---

## 処方箋まとめ

### 症状と適用

| 症状 | 適用すべき | 経過観察 |
| :--- | :---: | :---: |
| 特定のイベント発生時に、複数の異なる処理を行いたい | ✓ | |
| 通知先が増えるたびに、メインのクラスを修正している | ✓ | |
| 処理の順序や依存関係が複雑で、密結合が必須である | | ✓ |

### 治療のステップ

1.  **Role::Subject**（脳）を作る: `add_observer`, `notify_observers` メソッドを実装。
2.  **Role::Observer**（神経）を作る: `update` メソッドのインターフェースを定義。
3.  **Concrete Subject**: メインのクラスに `Role::Subject` を適用し、イベント発生時に `notify_observers` を呼ぶ。
4.  **Concrete Observer**: 具体的な処理（通知など）をクラス化し、`Role::Observer` を継承して `update` を実装。

### 助手より

Observerパターンは、クラス間の結合を緩やかにする（疎結合にする）ための非常に強力なパターンです。特に、仕様変更で「機能を追加したい」という要望が多い場面では、このパターンを適用しておくと、既存コードを傷つけずに拡張できるようになりますよ。ゆっくり休んでくださいね。
