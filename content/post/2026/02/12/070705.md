---
categories:
  - design-pattern
date: 2026-02-12T07:07:05+09:00
description: 複雑なSQLクエリ構築問題を「Builderパターン」で解決する、コードドクターシリーズ記事。Perl v5.36以降の機能を使用。
draft: false
epoch: 1770847625
image: /favicon.png
iso8601: 2026-02-12T07:07:05+09:00
tags:
  - builder
  - perl
  - object-oriented-programming
  - refactoring
title: 'Perlで執刀する「複雑性結合ヘルニア」 - Builderパターンで挑むSQL迷宮の再建'
---

「先生、急患です！」

助手の切羽詰まった声と共に、私は診療所のドアを勢いよく開けた。
連日のデスマ－チで睡眠不足の頭は重く、視界が定まらない。私はフラフラと受付へ倒れ込むように進み出た。

「……臭うな」

奥の診察室から現れたドクターは、開口一番そう言った。
彼は鼻を覆うように手をかざし、私ではなく、私が小脇に抱えているラップトップの方を睨みつけている。
そこから漂う「腐敗臭」――熟練のエンジニアにしか感じ取れない、崩壊寸前のコードが放つ気配を、彼は敏感に嗅ぎ取ったのだ。

## 診察: 違法建築の現場

「助けてください……！ このクエリを書き終えないと、リリースに間に合わないんです！」

私は自社ECサイトの検索エンジン開発リードを任されているが、今はそのプライドもかなぐり捨てて懇願するしかなかった。
震える手でラップトップを差し出す。画面には、Perlで書かれた巨大なサブルーチン `build_search_sql` が映し出されている。

「文字連結……密結合か」

ドクターが短く呟く。
助手がその画面を覗き込み、私に優しく解説してくれた。

「これは……SQLを文字列結合で継ぎ接ぎしていますね。『商品カテゴリ』『価格帯』『在庫あり』……条件が増えるたびに `if` 文で分岐して、パズルのようにSQLを組み立てている。まるで、迷路のように入り組んだ『違法建築』のようです」

「そうなんです！ 最初は単純な文字列結合で速くて良かったんです！ でも検索条件が増えて、JOINの順序やWHERE句の連結でバグが多発して……もう誰も触れない『聖域』になってしまった！」

私は頭を抱えた。
ドクターは無言でキーボードを叩き、その「患部」をスクロールする。

### 患部: 文字列結合の迷宮

```perl
# Simulation of a "Bad" implementation: String Concatenation Hell

sub build_search_sql {
    my (%args) = @_;

    my $sql = "SELECT p.id, p.name, p.price FROM products p";
    my @binds;
    my @where;

    # Bad practice: Direct string manipulation and implicit dependencies
    if ($args{category_id}) {
        # Implicitly assumes no other joins yet
        $sql .= " JOIN product_categories pc ON p.id = pc.product_id";
        push @where, "pc.category_id = ?";
        push @binds, $args{category_id};
    }

    if ($args{min_price}) {
        push @where, "p.price >= ?";
        push @binds, $args{min_price};
    }

    if ($args{max_price}) {
        push @where, "p.price <= ?";
        push @binds, $args{max_price};
    }

    # Complex logic mixed with query building
    if (defined $args{in_stock} && $args{in_stock}) {
        $sql .= " JOIN stocks s ON p.id = s.product_id";
        push @where, "s.quantity > 0";
    }

    if (@where) {
        $sql .= " WHERE " . join(" AND ", @where);
    }

    # Ordering is hardcoded and fragile
    $sql .= " ORDER BY p.id DESC";

    return ($sql, \@binds);
}
```

ドクターは舌打ちし、モニターを指で弾いた。

「カプセル化不全。……崩壊するぞ」

「はい。ドクターは『柱がない、瓦礫の山だ』と言っています。本来あるべき土台（Base Structure）がなく、現場の思いつきで部屋（条件句）を無計画に増築しています。このままでは次回、ソート順の変更が入った瞬間に、この巨大な文字列の塊は自重に耐えきれず倒壊（システムダウン）するでしょう」

助手の言葉に、私は血の気が引くのを感じた。
「倒壊……！ じゃあどうすれば……」

「……切除する」

ドクターは立ち上がり、術衣（パーカー）の袖をまくった。

「『複雑性結合ヘルニア』。Builderパターンを……適用する」

助手がすかさず補足する。
「これより、Builderパターンによる『是正工事』を開始します」

## 手術: プレハブ工法の導入

「いいですか？ 今起きている問題は、全ての建築工程（SQL構築ロジック）を一箇所で行おうとしていることです。これを、規格化された『部材』を作り、それを組み合わせる『工法』に変えます」

助手がホワイトボードに図を描きながら説明する間、ドクターの手は既に新しいクラスファイルを作成していた。
Perl v5.36の新機能、signaturesとpostfix dereferenceを駆使した、現代的な「設計図」だ。

### 執刀: 規格化された建築

```perl
package SearchQueryBuilder;
use v5.36;

# This is the "Builder" class
# It encapsulates the construction logic of a complex SQL query.

sub new ($class) {
    return bless {
        base_sql => "SELECT p.id, p.name, p.price FROM products p",
        joins    => [],
        wheres   => [],
        binds    => [],
        order    => "ORDER BY p.id DESC", # Default
    }, $class;
}

sub with_category ($self, $category_id) {
    push $self->{joins}->@*, "JOIN product_categories pc ON p.id = pc.product_id";
    push $self->{wheres}->@*, "pc.category_id = ?";
    push $self->{binds}->@*, $category_id;
    return $self;
}

sub with_price_range ($self, $min, $max) {
    if (defined $min) {
        push $self->{wheres}->@*, "p.price >= ?";
        push $self->{binds}->@*, $min;
    }
    if (defined $max) {
        push $self->{wheres}->@*, "p.price <= ?";
        push $self->{binds}->@*, $max;
    }
    return $self;
}

sub in_stock ($self) {
    push $self->{joins}->@*, "JOIN stocks s ON p.id = s.product_id";
    push $self->{wheres}->@*, "s.quantity > 0";
    return $self;
}

sub sort_by_price_asc ($self) {
    $self->{order} = "ORDER BY p.price ASC";
    return $self;
}

sub build ($self) {
    my $sql = $self->{base_sql};

    # Assemble parts
    if ($self->{joins}->@*) {
        $sql .= " " . join(" ", $self->{joins}->@*);
    }

    if ($self->{wheres}->@*) {
        $sql .= " WHERE " . join(" AND ", $self->{wheres}->@*);
    }

    $sql .= " " . $self->{order};

    # Return structure, or DBI statement handle in real world
    return ($sql, $self->{binds});
}

1;
```

「これが……Builderパターン……？」

私は食い入るように画面を見つめた。
何百行にも及ぶ複雑な `if` 文の連鎖が消え、一つ一つのメソッドがシンプルに機能（部材）を提供している。

「そうです。SQLの全体像を知っているのは `build` メソッドだけ。他のメソッドは、自分が担当する『部材』（JOIN句やWHERE句）を追加することだけに集中します。そして、それぞれのメソッドは `return $self` をすることで、次々に処理を連鎖させることができるのです」

ドクターが仕上げに、このクラスを使うクライアントコードを書いた。

### 術後: 安全な現場

```perl
# Client code is readable and declarative
my ($sql, $binds) = SearchQueryBuilder->new
    ->with_category(1)
    ->with_price_range(1000, undef)
    ->in_stock
    ->build;
```

「なんという……美しさだ」
私は思わず息を呑んだ。

「あんなに複雑だった構築ロジックが、まるで自然言語のように読める。これなら条件が増えてもメソッドを足すだけでいいし、呼び出し側も何をしているか一目瞭然だ……！」

ドクターは満足げに頷き、私の方へ歩み寄った。
そして、胸ポケットから一本の高級そうな万年筆を取り出し、私に差し出した。

「えっ？ こ、これを私に……？」

私の目からあたたかい涙がこぼれ落ちた。
「『設計者としての誇りを持ち、美しい設計図を描け』……そういうことですね、ドクター！」

ドクターは一瞬眉をひそめたが、何も言わずに背を向けた。
助手は何か言いたげに苦笑していたが、結局何も言わなかった。

「……ええ、そのペンで。あなたの現場を、安全で美しい場所にしてください」

## 予後: 退院

私は深々と頭を下げ、診療所を後にした。
その足取りは軽い。これからの私は、もう複雑な要件変更に怯えることはないだろう。

背後でドアが閉まる気配を感じながら振り返ると、ドクターは既に次のカルテ（技術書）を開いているのが見えた。
助手は静かに、床に落ちていた消しゴムのかす（無駄なコメント）を掃除し始めていた。

---

## 処方箋まとめ

| 症状 | 適用すべき | 経過観察 |
| :--- | :--- | :--- |
| **複雑な構築処理** | ✓ オブジェクトの生成手順が複雑で、多数のパラメータを要する場合 | コンストラクタへの引数だけで完結する単純なオブジェクトの場合 |
| **表現の多様性** | ✓ 同じ構築プロセスから異なる表現形式（SQL, HTML, Textなど）を生成したい場合 | 単一の表現形式しか持たない場合 |
| **引数地獄** | ✓ コンストラクタの引数が多く、順序や組み合わせが複雑な場合 | 引数が少なく、順序が自明な場合 |

### 治療のステップ

1.  **Builderクラスの作成**: 生成対象（Product）の構築ロジックをカプセル化したクラスを作成する。
2.  **構築メソッドの実装**: 各パーツをセットアップするメソッド（`with_...`）を実装し、自分自身（`$self`）を返すようにしてメソッドチェーンを可能にする。
3.  **Buildメソッドの実装**: 最終的な成果物を組み立てて返すメソッド（`build`）を作成する。
4.  **クライアントコードの修正**: 複雑な初期化ロジックを、Builderを通じた宣言的な記述に置き換える。

### 助手より

複雑な要件定義は、エンジニアにとって避けられない試練です。ですが、その複雑さをコードにそのまま持ち込む必要はありません。Builderパターンを使って、複雑な構築作業を整理整頓してください。あなたのコードが、まるで美しい建築物のように堅牢で機能的であり続けますように。
