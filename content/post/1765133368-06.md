---
title: "作業を一時退避！git stash の実践的な使い方"
draft: true
tags:
- "git"
- "git-stash"
- "workflow"
- "productivity"
- "best-practices"
description: "急な割り込み作業やブランチ切り替え時に便利なstashを完全マスター。基本的な退避・復元から、複数のstashの管理、部分的なstash、未追跡ファイルの扱いまで、作業効率を上げるstash活用術を解説します。"
---

## git stash が活躍する場面

開発中に突然「緊急のバグ修正を先にやってほしい」と言われたり、別のブランチで作業が必要になったりすること、ありますよね。でも、今の変更はまだコミットできる状態じゃない…。そんな時に`git stash`が威力を発揮します。

### よくあるユースケース

- **緊急のブランチ切り替え**: hotfixのために今の作業を一時退避
- **試行錯誤の一時保存**: 別のアプローチを試したいが、今のコードも残したい
- **クリーンな状態でpull**: 作業中の変更とコンフリクトしそうな時

## stash の基本操作

### 変更を退避する

最もシンプルな使い方です。

```bash
# 現在の変更をstashに保存
git stash

# または明示的に
git stash push
```

これで追跡されているファイルの変更がすべて退避され、ワーキングツリーがクリーンになります。

### stashを復元する

退避した変更を戻すには2つの方法があります。

```bash
# stashを適用して削除
git stash pop

# stashを適用するが保持
git stash apply
```

**pop vs apply の使い分け**：

- `pop`: 1回限りの退避（通常はこちら）
- `apply`: 同じstashを複数ブランチで使いたい時

### メッセージ付きで分かりやすく管理

```bash
# メッセージを付けて保存
git stash push -m "WIP: ユーザー認証機能の実装中"

# 後で確認
git stash list
# stash@{0}: On feature: WIP: ユーザー認証機能の実装中
# stash@{1}: WIP on main: abc1234 前回のコミット
```

メッセージがあると、複数のstashを管理しやすくなります。

## stash リストの管理

### 保存されたstashを確認

```bash
# stash一覧を表示
git stash list

# 出力例
stash@{0}: On feature/auth: WIP: OAuth実装
stash@{1}: WIP on main: abc1234 データベース接続改善
stash@{2}: On develop: 実験的な変更
```

番号(`@{0}`, `@{1}`...)で個別に管理します。

### 特定のstashを確認

```bash
# stashの内容を表示
git stash show stash@{0}

# 詳細なdiffを表示
git stash show -p stash@{1}
```

### 特定のstashを適用・削除

```bash
# 2番目のstashを適用
git stash apply stash@{1}

# 特定のstashを削除
git stash drop stash@{1}

# すべてのstashを削除
git stash clear
```

## 高度なstash活用

### --keep-index で一部だけstash

ステージングしたファイルはそのまま残し、それ以外をstashします。

```bash
# 重要な変更だけステージング
git add important.js

# ステージングしていないファイルだけstash
git stash --keep-index

# important.jsは作業ディレクトリに残る
```

部分的に進めたい変更を保護しながら、他を退避できます。

### --include-untracked で未追跡ファイルも退避

デフォルトでは追跡されているファイルのみがstashされます。

```bash
# 新規ファイルもstash
git stash --include-untracked

# または短縮形
git stash -u
```

新しく作ったファイルも一緒に退避したい時に便利です。

### --patch で対話的に選択

変更の一部だけをstashしたい時に使います。

```bash
# 対話的にstash
git stash --patch

# または短縮形
git stash -p
```

各変更箇所(hunk)ごとに：
- `y`: このhunkをstash
- `n`: スキップ
- `q`: 終了
- `?`: ヘルプ

## stash からブランチを作成

stash内容をベースに新しいブランチを作成できます。

```bash
# stashから新規ブランチ作成
git stash branch feature/new-feature stash@{0}
```

これは以下の操作をまとめて実行します：

1. stashを作成した時点のコミットに新ブランチ作成
2. そのブランチにチェックアウト
3. stashを適用
4. 成功したらstashを削除

コンフリクトを避けて確実に作業を再開できます。

## 実践的なワークフロー

### シナリオ1: 緊急のhotfix対応

```bash
# 開発中にバグ報告が入る
# 現在: feature/user-profileブランチで作業中

# 作業を一時退避
git stash push -m "プロフィール編集機能実装中"

# mainブランチに移動
git switch main

# hotfixブランチ作成
git switch -c hotfix/critical-bug

# バグ修正...
git add .
git commit -m "fix: クリティカルなバグを修正"

# 元のブランチに戻る
git switch feature/user-profile

# 作業を再開
git stash pop
```

### シナリオ2: 複数の実装を試す

```bash
# 実装Aを試す
git stash push -m "実装案A: REST API使用"

# 実装Bを試す
# ... コーディング ...
git stash push -m "実装案B: GraphQL使用"

# 実装Cを試す
# ... コーディング ...

# 実装Aに戻って確認
git stash apply stash@{1}

# 最終的にどれかを採用
git stash list
git stash show -p stash@{0}  # 内容確認
git stash apply stash@{0}    # 採用
git stash clear              # 他は削除
```

### シナリオ3: 変更を別ブランチに移動

```bash
# 間違えてmainで作業してしまった
git stash

# 正しいブランチを作成
git switch -c feature/correct-branch

# 変更を適用
git stash pop
```

## トラブル対処：stash適用時のコンフリクト

stashを適用した時にコンフリクトが発生することがあります。

```bash
# stashを適用してコンフリクト発生
git stash pop
# CONFLICT (content): Merge conflict in src/app.js

# コンフリクトを解決
vim src/app.js

# 解決したらステージング
git add src/app.js

# popの場合、stashは自動削除されないので手動で削除
git stash drop
```

### コンフリクトを避けるコツ

```bash
# 適用前に現在の状態とstashを比較
git stash show -p | git apply --check

# または、stashから新しいブランチ作成（推奨）
git stash branch temp-branch stash@{0}
```

## stashの裏技

### stashを他のブランチに適用

```bash
# 別のブランチに移動
git switch other-branch

# 特定のstashを適用
git stash apply stash@{2}
```

stashはブランチに依存しないので、どのブランチでも適用可能です。

### stashをパッチファイルとして出力

```bash
# stashをパッチファイルに
git stash show -p stash@{0} > my-changes.patch

# 後で適用
git apply my-changes.patch
```

チームメンバーと変更を共有したい時に便利です。

## まとめ

`git stash`は、柔軟な作業管理を実現する強力なツールです。

- **基本**: `git stash` で退避、`git stash pop` で復元
- **メッセージ**: `-m`で内容を記録
- **高度な使い方**: `-u`, `-p`, `--keep-index`で柔軟に制御
- **ブランチ作成**: `git stash branch`でコンフリクト回避

割り込みタスクや実験的な変更が多い開発現場では、stashを使いこなすことで作業効率が大きく向上します。まずは簡単な退避・復元から始めて、徐々に高度な機能を取り入れていきましょう。
