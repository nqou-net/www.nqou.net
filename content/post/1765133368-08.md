---
title: "誰がいつ変更した？git blame と git log -S で変更履歴を追跡"
draft: true
tags:
- "git"
- "git-blame"
- "git-log"
- "code-archaeology"
- "debugging"
description: "コードの変更理由や変更者を特定したい時に使うblameとlog検索の高度な技術。表層的なblameだけでなく、リファクタリングを超えて本質的な変更を追跡する方法、特定の文字列が導入・削除されたコミットを探す技まで解説します。"
---

## git blame の基本と限界

「このコード、なぜこうなってるんだろう？」「いつからこのバグがあったの？」。コードの変更履歴を追跡することは、デバッグやコードレビューで重要なスキルです。

### 行単位の変更履歴を表示

`git blame`は、ファイルの各行がいつ、誰によって最後に変更されたかを表示します。

```bash
# ファイルの各行の変更履歴を表示
git blame src/app.js

# 出力例
abc1234 (John Doe 2023-01-15 10:30:00 +0900  1) function login(user) {
def5678 (Jane Smith 2023-03-20 14:25:30 +0900  2)   if (!user.email) {
def5678 (Jane Smith 2023-03-20 14:25:30 +0900  3)     throw new Error('Email required');
ghi9012 (Bob Johnson 2023-05-10 09:15:45 +0900  4)   }
abc1234 (John Doe 2023-01-15 10:30:00 +0900  5)   return authenticate(user);
abc1234 (John Doe 2023-01-15 10:30:00 +0900  6) }
```

### フォーマット移行や移動での誤検知

blameの限界は、**最後に触った人が必ずしも本質的な変更をした人ではない**という点です。

例えば：
- コードフォーマッター実行
- ファイルの移動やリネーム
- インデント調整
- import文の整理

これらで「最終更新者」になってしまうことがあります。

## より深い追跡のための blame オプション

### -w で空白変更を無視

インデントやスペース変更を無視して、実質的な変更だけを追跡します。

```bash
# 空白の変更を無視
git blame -w src/app.js
```

これでフォーマッター実行による表層的な変更をスキップできます。

### -C, -M で移動・コピーを検出

ファイル間での移動やコピーを追跡します。

```bash
# ファイル内の移動を検出
git blame -M src/app.js

# ファイル間のコピーを検出
git blame -C src/app.js

# より深く検出（3段階）
git blame -CCC src/app.js
```

`-C`オプションは計算コストが高いですが、リファクタリング後の追跡に有効です。

### -L で特定行範囲に絞る

関心のある範囲だけを表示できます。

```bash
# 10行目から20行目まで
git blame -L 10,20 src/app.js

# 関数単位で指定
git blame -L :functionName src/app.js

# 開始行から末尾まで
git blame -L 50,+10 src/app.js  # 50行目から10行分
```

大きなファイルで特定箇所だけを調べる時に便利です。

## git log -S（pickaxe）で変更を追跡

`git log -S`は、特定の文字列が追加または削除されたコミットを検索します。

### 文字列の追加・削除を検索

```bash
# "authenticateUser"という文字列が変更されたコミットを検索
git log -S "authenticateUser"

# より詳しく（パッチ付き）
git log -S "authenticateUser" -p

# ファイルを限定
git log -S "authenticateUser" -- src/auth.js
```

これは「その文字列が増減したコミット」のみを表示します。

### -G で正規表現検索

`-S`は文字列の増減のみですが、`-G`は正規表現にマッチする変更を検索します。

```bash
# 正規表現でログイン関連の変更を検索
git log -G "login|authenticate" -p

# エラーハンドリングの追加・削除を検索
git log -G "try.*catch|throw new Error" -- src/

# 関数定義の変更を検索
git log -G "^function.*\(" -- src/utils.js
```

## git log -L で関数・行範囲の履歴

特定の関数や行範囲の変更履歴を時系列で表示します。

### 関数の変更履歴を時系列で表示

```bash
# 関数の履歴を追跡
git log -L :functionName:src/app.js

# 出力は各コミットでその関数がどう変わったかを表示
```

### 行範囲指定

```bash
# 10行目から20行目の履歴
git log -L 10,20:src/app.js
```

これで「この関数がどう進化してきたか」を時系列で追えます。

## 実践：削除されたコードを探す

「以前あったコードが消えてる…誰がいつ削除した？」を調べます。

### 手順1: 削除されたコードの断片を思い出す

```bash
# "oldFunction"という文字列が削除されたコミットを探す
git log -S "oldFunction" --all -- src/

# 出力例
commit abc1234
Author: John Doe
Date: Mon Dec 4 10:30:00 2023

    refactor: 古いAPI関数を削除
```

### 手順2: 削除前の状態を確認

```bash
# そのコミットの1つ前を見る
git show abc1234^:src/api.js

# またはdiffで確認
git show abc1234 -- src/api.js
```

### 手順3: なぜ削除されたか理由を確認

```bash
# コミットメッセージとdiffを表示
git show abc1234

# 関連するissueやPRを確認
git log --grep="API" --oneline
```

## 実践シナリオ

### シナリオ1: バグの混入時期を特定

```bash
# 特定のバグに関連するコードを検索
git log -S "validateEmail" -p

# より限定的に
git log -S "validateEmail" --since="2 weeks ago" -- src/validators/

# blame で詳細確認
git blame -L :validateEmail src/validators/email.js
```

### シナリオ2: リファクタリングの影響調査

```bash
# 関数名の変更を追跡
git log --follow -p -- src/renamed-file.js

# 移動前のファイルも含めて blame
git blame -C -C -C src/current-file.js
```

### シナリオ3: セキュリティ修正の確認

```bash
# "password"や"secret"の扱いが変更されたコミット
git log -S "password" -i -- "*.js"

# 認証処理の変更履歴
git log -L :authenticate:src/auth.js
```

## GitHub/GitLab での blame 活用

### GitHub上でのblame表示

GitHubのファイルビューで`Blame`ボタンをクリックすると、視覚的に履歴を確認できます。

- 各行の変更者とコミットが表示
- コミットハッシュをクリックすると詳細を表示
- "View blame prior to this change"で更に遡れる

### 便利なショートカット

GitHub上で：

- `B`キー: blameビューに切り替え
- `L`キー: 行番号をURLに追加（共有時に便利）

## 高度なテクニック

### 複数条件での検索

```bash
# 特定の作者による特定の文字列の変更
git log --author="John" -S "criticalFunction" -p

# 期間を限定
git log --since="2023-01-01" --until="2023-12-31" -S "apiKey"

# 複数ファイルパターン
git log -S "CONFIG" -- "*.yml" "*.yaml"
```

### blameの出力をカスタマイズ

```bash
# 簡潔な表示
git blame -s src/app.js  # ハッシュのみ

# タイムスタンプ形式を変更
git blame --date=short src/app.js
git blame --date=relative src/app.js
```

### エイリアスで効率化

`.gitconfig`に登録：

```bash
git config --global alias.who 'blame -w -C -C'
git config --global alias.search 'log -S'
git config --global alias.search-regex 'log -G'

# 使用例
git who src/app.js
git search "functionName"
```

## トラブルシューティング

### blameが期待通りの結果を返さない

```bash
# より深く検出
git blame -w -M -C -C -C src/file.js

# 特定のコミット以降を無視
git blame <commit>.. src/file.js
```

### 大量の結果から絞り込む

```bash
# 特定の作者のコミットのみ
git log -S "searchTerm" --author="John"

# 特定のブランチのみ
git log -S "searchTerm" feature/new-api
```

## まとめ

コード考古学のための強力なツール群：

- **git blame**: 各行の最終更新者を表示（`-w`, `-M`, `-C`で精度向上）
- **git log -S**: 文字列の増減を検索
- **git log -G**: 正規表現で変更を検索
- **git log -L**: 関数や行範囲の履歴を追跡

これらを使いこなすことで、コードの「なぜ」「いつ」「誰が」を効率的に追跡でき、デバッグや仕様理解が格段にスムーズになります。まずは自分のプロジェクトで試してみましょう！
