---
title: "第2回-Mooで覚えるオブジェクト指向プログラミング"
draft: true
tags:
  - perl
  - moo
  - object-oriented
description: "第1回で書いたコードを1行ずつ読み解きながら、$selfの役割を理解します"
---

[@nqounet](https://twitter.com/nqounet)です。

第1回では、Mooを使った簡単なプログラムを動かしてみました。今回は、そのコードを1行ずつ読み解いていきましょう。

「なんとなく動いた」から「なぜ動くのか分かる」へ。これが今回のゴールです。

## 第1回のコードを振り返る

まずは第1回で書いたコードをもう一度見てみましょう。

```perl
package MyApp {
    use utf8;
    use Moo;
    has hoge => (is => 'rw');

    sub show {
        my $self = shift;
        print $self->hoge;
    }
};

my $app = MyApp->new;
$app->hoge('ほげ');
$app->show;
```

このコードは大きく分けて2つのパートに分かれています。

- `package MyApp { ... };` の部分：クラスの定義
- `my $app = ...` 以降の部分：クラスを使う側のコード

では、それぞれを詳しく見ていきましょう。

## `package`でクラスを定義する

```perl
package MyApp {
```

`package`は「このまとまりに名前をつける」という宣言です。ここでは`MyApp`という名前をつけています。

オブジェクト指向の用語で言えば、この`package`が「クラス」の定義に相当します。第1回で「クラスはオブジェクトの設計図」と説明しましたが、`package MyApp { ... }`というブロック全体が、その設計図になるわけです。

ちなみに、`use utf8;`は日本語（マルチバイト文字）を扱うためのおまじないで、`use Moo;`はMooというモジュールを使うための宣言です。`use Moo;`と書くことで、`has`という便利な機能が使えるようになります。

## `has`でプロパティを定義する

```perl
has hoge => (is => 'rw');
```

`has`はMooが提供する機能で、「このクラスが持つプロパティ（属性）を定義する」という意味です。

- `hoge`：プロパティの名前
- `is => 'rw'`：読み書き可能（read/write）という設定

`is => 'rw'`と書くことで、`hoge`というプロパティに値を入れたり（書き込み）、取り出したり（読み込み）できるようになります。

ちなみに`is => 'ro'`と書くと「読み取り専用（read only）」になりますが、これは今後の回で詳しく説明します。

## `sub`でメソッドを定義する

```perl
sub show {
    my $self = shift;
    print $self->hoge;
}
```

`sub`はPerlで関数（サブルーチン）を定義するときに使うキーワードです。ただし、クラスの中で定義した`sub`は「メソッド」と呼びます。

関数とメソッドの違いは何でしょうか？それは「オブジェクトに紐づいているかどうか」です。メソッドは必ず「どのオブジェクトに対して呼び出されたか」という情報を持っています。

その情報を受け取っているのが、次に説明する`$self`です。

## `$self`って何者？

ここが今回のメインテーマです。

```perl
sub show {
    my $self = shift;
    print $self->hoge;
}
```

`my $self = shift;`という1行は、メソッドの中でよく見るパターンです。これは何をしているのでしょうか？

Perlでは、メソッドが呼び出されるとき、第1引数として「呼び出し元のオブジェクト自身」が自動的に渡されます。`shift`でその引数を取り出し、`$self`という変数に入れているのです。

つまり、`$self`は「このメソッドを呼び出したオブジェクト自身」を指しています。

具体的に見てみましょう。後半のコードで`$app->show;`と呼び出していますね。このとき、`show`メソッドの中では`$self`は`$app`と同じオブジェクトを指しています。

だから`$self->hoge`と書くと、`$app->hoge`と書いたのと同じことになり、`'ほげ'`という値が取得できるのです。

`$self`という名前は慣習であり、別の名前（例えば`$this`や`$obj`）でも動きます。しかし、Perlの世界では`$self`を使うのが一般的なので、この慣習に従うことをおすすめします。

## `new`でオブジェクトを作る

```perl
my $app = MyApp->new;
```

`new`は「コンストラクタ」と呼ばれるメソッドで、クラスからオブジェクト（インスタンス）を作り出します。

Mooを使うと、`new`メソッドは自動的に用意されるので、自分で定義する必要はありません。これもMooの便利なところです。

`MyApp->new`で作られたオブジェクトを`$app`という変数に入れておくことで、後から`$app->hoge('ほげ')`や`$app->show`のようにメソッドを呼び出せます。

ここで重要なのは、`new`を呼ぶたびに新しいオブジェクトが作られるということです。例えば`MyApp->new`を2回呼べば、2つの別々のオブジェクトができあがります。それぞれのオブジェクトは独自の`hoge`プロパティを持ち、互いに影響しません。

## まとめ

今回は第1回のコードを1行ずつ読み解きながら、`$self`の役割を学びました。

- `package`でクラス（設計図）を定義する
- `has`でプロパティ（属性）を定義する
- `sub`でメソッド（機能）を定義する
- `$self`は「メソッドを呼び出したオブジェクト自身」を指す
- `new`でオブジェクトを作成する

`$self`はオブジェクト指向プログラミングの核となる概念です。「自分自身を参照する」という考え方が分かると、この先の学習がぐっと楽になります。

次回は、実際に簡単な掲示板（チャット）を作りながら、なぜオブジェクト指向が便利なのかを体験していきましょう。
