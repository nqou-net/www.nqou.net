---
title: "第11回-Mooで覚えるオブジェクト指向プログラミング"
draft: true
tags:
  - perl
  - moo
  - object-oriented
description: "管理者と一般ユーザーを例に、多態性（ポリモーフィズム）の概念を学びます"
---

[@nqounet](https://twitter.com/nqounet)です。

第10回では、Moo::Roleを使って共通機能を定義し、`with`で複数のクラスに適用する方法を学びました。Roleは継承とは違い「合成」という考え方に基づいていて、横断的な機能を複数のクラスで共有できましたね。

さて、ここまで作ってきた掲示板には、まだ1つ足りない機能があります。それは「管理者」です。

実際の掲示板を思い浮かべてみてください。一般ユーザーは自分の投稿しか編集できませんが、管理者は他人の投稿も削除できますよね。このような「ユーザーの種類によって権限が異なる」機能を実装するために、今回は「多態性（ポリモーフィズム）」という概念を学びます。

## AdminUserクラスを作ろう

まずは、管理者を表すAdminUserクラスを作ってみましょう。第9回で作成したUserクラスを継承します。

管理者は一般ユーザーと何が違うでしょうか。

- 一般ユーザー：自分の投稿を編集できるが、他人の投稿は削除できない
- 管理者：他人の投稿も削除できる

この違いを表現するために、「投稿を削除できるかどうか」を返すメソッドを作ってみましょう。

```perl
# Userクラス（一般ユーザー）
package User {
    use Moo;
    has id   => (is => 'ro', required => 1);
    has name => (is => 'rw', required => 1);
    
    sub can_delete_message { return 0; }  # 一般ユーザーは削除不可
    
    sub greet {
        my $self = shift;
        return 'こんにちは、' . $self->name . 'です';
    }
};

# AdminUserクラス（管理者）
package AdminUser {
    use Moo;
    extends 'User';  # Userを継承
    
    sub can_delete_message { return 1; }  # 管理者は削除可能
    
    sub greet {
        my $self = shift;
        return '管理者の' . $self->name . 'です';
    }
};

# 多態性の例：型を気にせずメソッドを呼び出す
sub show_greeting {
    my $user = shift;
    print $user->greet . "\n";  # 型を気にせず呼び出せる
}

my $user  = User->new(id => 1, name => '太郎');
my $admin = AdminUser->new(id => 2, name => '花子');

show_greeting($user);   # こんにちは、太郎です
show_greeting($admin);  # 管理者の花子です

# 権限チェック
if ($admin->can_delete_message) {
    print "このユーザーは投稿を削除できます\n";
}
```

AdminUserクラスは`extends 'User'`でUserクラスを継承しています。第8回で学んだ継承の仕組みですね。

ポイントは、`can_delete_message`メソッドと`greet`メソッドです。親クラスのUserでは`can_delete_message`が0（偽）を返しますが、子クラスのAdminUserでは1（真）を返します。また、`greet`メソッドも、一般ユーザーと管理者で異なるメッセージを返すようにしています。

このように、子クラスで親クラスと同じ名前のメソッドを定義して動作を変えることを「メソッドのオーバーライド」と呼びます。これは第8回でも少し触れましたね。

## 多態性とは

さて、ここからが今回のメインテーマです。

UserとAdminUserは、どちらも`greet`メソッドと`can_delete_message`メソッドを持っています。しかし、呼び出したときの動作は異なります。

この「同じメソッド名で、オブジェクトの種類によって異なる動作をする」という性質を、多態性（ポリモーフィズム）と呼びます。

多態性があると、何がうれしいのでしょうか。それは、「型を気にせずにメソッドを呼び出せる」ということです。

先ほどのコード例の`show_greeting`関数を見てください。この関数は、引数がUserなのかAdminUserなのかを気にしていません。どちらのオブジェクトが渡されても、`greet`メソッドを呼び出すだけです。そして、渡されたオブジェクトの種類に応じて、適切な挨拶が返ってきます。

これが多態性のメリットです。呼び出す側のコードを変更せずに、オブジェクトの種類によって動作を変えられるのです。

## ダックタイピング

Perlの多態性には、もう1つ重要な特徴があります。それが「ダックタイピング」です。

ダックタイピングとは、「アヒルのように歩き、アヒルのように鳴けば、それはアヒルだ」という考え方です。つまり、オブジェクトの「型」ではなく、オブジェクトが「何ができるか（どんなメソッドを持っているか）」で判断します。

Perlでは、オブジェクトが特定の型であるかどうかをチェックしなくても、メソッドさえ持っていれば呼び出せます。先ほどの`show_greeting`関数を思い出してください。この関数は、`$user`がUserクラスかAdminUserクラスかを確認していません。`greet`メソッドを持っているオブジェクトなら、何でも受け取れます。

例えば、まったく別のクラスを作ったとしても、`greet`メソッドさえ持っていれば`show_greeting`関数に渡せます。

これがダックタイピングの強みです。型に縛られず、柔軟にコードを書くことができます。

ただし、注意点もあります。期待するメソッドを持っていないオブジェクトを渡すと、実行時エラーになります。静的型付け言語のように、コンパイル時にエラーを検出することはできません。必要に応じて、`$user->can('greet')`のようにメソッドの存在を確認することもできます。

## 実際に使ってみよう

では、多態性を活かして、掲示板の削除機能を実装してみましょう。

ユーザーが投稿を削除しようとしたとき、`can_delete_message`メソッドで権限をチェックします。このとき、ユーザーがUserなのかAdminUserなのかは関係ありません。

```perl
sub delete_message {
    my ($user, $message) = @_;
    
    if ($user->can_delete_message) {
        print "投稿「" . $message . "」を削除しました\n";
        return 1;
    } else {
        print "削除する権限がありません\n";
        return 0;
    }
}

my $user  = User->new(id => 1, name => '太郎');
my $admin = AdminUser->new(id => 2, name => '花子');

delete_message($user, 'テスト投稿');   # 削除する権限がありません
delete_message($admin, 'テスト投稿');  # 投稿「テスト投稿」を削除しました
```

`delete_message`関数は、渡されたユーザーの型を気にしていません。`can_delete_message`メソッドを呼び出すだけで、適切な権限チェックが行われます。

将来、もし「モデレーター」という新しいユーザー種別が必要になったとしても、`can_delete_message`メソッドを持つクラスを作るだけで、`delete_message`関数はそのまま使えます。これが多態性による拡張性です。

## まとめ

今回は、管理者と一般ユーザーを例に、多態性（ポリモーフィズム）を学びました。

- 多態性とは「同じメソッド名で、オブジェクトの種類によって異なる動作をする」という性質である
- 子クラスで親クラスのメソッドをオーバーライドすることで、異なる動作を実現できる
- 呼び出す側は型を気にせず、同じ方法でメソッドを呼び出せる
- ダックタイピングは「型」ではなく「何ができるか」で判断する考え方である
- Perlではメソッドさえ持っていれば、どんなオブジェクトでも受け取れる

多態性を使うと、新しい種類のオブジェクトを追加しても、既存のコードを変更せずに済むことが多くなります。これは、コードの保守性と拡張性を高める重要な仕組みです。

次回は、テストについて学び、作成したクラスが正しく動作することを確認する方法を見ていきます。お楽しみに！
