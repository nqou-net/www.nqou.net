---
title: "第6回-Mooで覚えるオブジェクト指向プログラミング"
draft: true
tags:
  - perl
  - moo
  - object-oriented
description: "requiredで必須項目を、defaultやbuilderでデフォルト値を設定する方法を学びます"
---

[@nqounet](https://twitter.com/nqounet)です。

第5回では、`is => 'ro'`と`is => 'rw'`を使い分けることで、データを守る「カプセル化」を学びました。投稿者の名前を後から変更されないよう、読み取り専用に設定しましたね。

でも、ちょっと考えてみてください。今のMessageクラスでは、投稿者の名前を指定せずにオブジェクトを作ることができてしまいます。掲示板で「名無しさん」ならまだしも、投稿者が空っぽのメッセージは困りますよね。

今回は、オブジェクト作成時に「この情報は必ず必要」「指定がなければこの値を使う」という初期化のルールを設定する方法を学びます。

## 必須項目を設定する

掲示板の投稿に必要な情報は何でしょうか？最低限、「誰が書いたか（投稿者）」と「何を書いたか（本文）」は必須ですよね。これらの情報がないと、投稿として成り立ちません。

Mooでは、`required => 1`と書くことで、その属性を必須項目に設定できます。例えば`has author => (is => 'ro', required => 1);`のように書きます。

必須項目を指定せずにオブジェクトを作ろうとすると、Mooがエラーを出して止めてくれます。これにより、「投稿者を設定し忘れた」というミスを未然に防げるのです。

この設定がある状態で`Message->new(body => 'こんにちは')`のように`author`を指定せずにオブジェクトを作ると、プログラムはエラーで停止します。「authorは必須ですよ」とMooが教えてくれるので、設定忘れにすぐ気づけます。

## デフォルト値を設定する

一方で、必須ではないけれど「指定がなければこの値を使いたい」という場合もあります。

例えば、投稿のカテゴリ。指定があればそれを使い、なければ「一般」にしたい、というケースです。こういうときは`default`を使います。`has category => (is => 'ro', default => '一般');`と書くと、オブジェクト作成時に`category`を指定しなかった場合、自動的に「一般」が設定されます。

ただし、1つ注意点があります。デフォルト値に配列やハッシュを使いたい場合は、`default => sub { [] }`のように`sub { }`で囲む必要があります。`default => []`と直接書いてしまうと、すべてのオブジェクトが同じ配列を共有してしまい、1つのオブジェクトでタグを追加すると他のオブジェクトのタグにも影響が出てしまいます。`sub { [] }`と書くことで、オブジェクトごとに新しい配列が作られます。

## builderメソッドを使う

`default`は単純な値には便利ですが、もう少し複雑な処理でデフォルト値を決めたいこともあります。そんなときは`builder`を使います。

`builder`を使うと、指定したメソッドを呼び出してデフォルト値を生成します。例えば、投稿日時を現在時刻で自動設定したい場合、`has posted_at => (is => 'ro', builder => '_build_posted_at');`と書きます。`posted_at`が指定されなかった場合に`_build_posted_at`メソッドが呼ばれ、その戻り値がデフォルト値になります。

builderメソッドの名前は慣習的に`_build_属性名`とします。先頭のアンダースコアは「内部用のメソッドですよ」という意味合いで、外から直接呼び出されることを想定していません。

builderの良いところは、メソッドなので複雑な処理が書けることです。データベースから値を取得したり、設定ファイルを読み込んだり、他の属性の値を参照したりできます。

## Messageクラスを改良する

それでは、これまで学んだことを活かして、Messageクラスを改良しましょう。

掲示板の投稿として必要な条件を整理します。

- author（投稿者）：必須。誰が書いたか分からない投稿は困る
- body（本文）：必須。内容がない投稿は意味がない
- posted_at（投稿日時）：オブジェクト作成時に自動設定

これをMooで実装すると、以下のようになります。

```perl
# 改良版Messageクラス
package Message {
    use Moo;
    
    has author    => (is => 'ro', required => 1);
    has body      => (is => 'rw', required => 1);
    has posted_at => (is => 'ro', builder => '_build_posted_at');
    
    sub _build_posted_at {
        my $self = shift;
        return time();
    }
    
    sub show {
        my $self = shift;
        print $self->author . ' (' . $self->posted_at . '): ' . $self->body . "\n";
    }
};

my $msg = Message->new(author => '太郎', body => 'こんにちは！');
$msg->show;
# => 太郎 (現在時刻のエポック秒): こんにちは！
```

これで、投稿者と本文を必ず指定しなければならなくなり、投稿日時は自動的に記録されるようになりました。

`author`と`body`を指定し忘れると、プログラムはエラーで停止します。これは一見不便に思えるかもしれませんが、「投稿者が空の投稿が大量に作られてしまった」というような、より深刻なバグを防いでくれます。

## まとめ

今回は、オブジェクト作成時の初期化オプションを学びました。

- `required => 1`で必須項目を設定できる
- 必須項目を指定しないとMooがエラーを出してくれる
- `default`でデフォルト値を設定できる
- 配列やハッシュのデフォルトは`sub { }`で囲む
- `builder`でメソッドからデフォルト値を生成できる
- builderは複雑な初期化処理に便利である

「必須項目」と「デフォルト値」を適切に設定することで、オブジェクトが常に正しい状態で作られるようになります。これも、データを守るカプセル化の一部と言えますね。

次回は、掲示板にさらに機能を追加していきます。投稿一覧の表示や投稿数の取得など、メソッドの設計と実装について学びましょう。
