---
title: "第5回-Mooで覚えるオブジェクト指向プログラミング"
draft: true
tags:
  - perl
  - moo
  - object-oriented
description: "読み取り専用と読み書き可能の違いを学び、カプセル化の概念を理解します"
---

[@nqounet](https://twitter.com/nqounet)です。

第4回では、散らばっていた投稿者とメッセージ内容を1つのMessageクラスにまとめ、コードをスッキリさせることができました。「クラスは設計図、オブジェクトは設計図から作った実体」という関係も学びましたね。

でも、ちょっと待ってください。今のMessageクラス、実は大きな問題を抱えています。投稿者の名前を、後から自由に変更できてしまうのです。

掲示板で「太郎」さんが投稿したメッセージの投稿者名を、誰かが「管理人」に書き換えられたら大変ですよね。今回は、こうした問題を防ぐ「カプセル化」という考え方を学んでいきます。

## 投稿者を変更できてしまう問題

第4回で作ったMessageクラスを思い出してください。`has author => (is => 'rw')`という設定でしたね。

`is => 'rw'`は「read-write（読み書き可能）」の略です。この設定だと、オブジェクトを作った後でも値を変更できてしまいます。

```perl
# 第4回で作ったMessageクラス（後から値を変更できてしまう）
package Message {
    use Moo;
    has author => (is => 'rw');  # 読み書き可能
    has body   => (is => 'rw');  # 読み書き可能
};

my $msg = Message->new(author => '太郎', body => 'こんにちは！');
print $msg->author;  # => 太郎

# 後から投稿者を変更できてしまう！
$msg->author('なりすまし');
print $msg->author;  # => なりすまし
```

これは困りますね。メッセージの内容は「編集機能」として変更できても良いかもしれませんが、投稿者の名前は投稿した時点で決まるべきです。後から変更されては、誰が投稿したのか分からなくなってしまいます。

## 読み取り専用にする

この問題を解決するのが`is => 'ro'`です。`ro`は「read-only（読み取り専用）」の略で、オブジェクト作成時に値を設定したら、その後は変更できなくなります。

`is => 'ro'`にした属性に値を書き込もうとすると、Mooがエラーを出して止めてくれます。これで、投稿者の名前が勝手に変更されることはありません。

一方、`body`は`is => 'rw'`のままにすれば、メッセージ内容を後から編集することは可能です。

## カプセル化とは

今やったことには、オブジェクト指向の大切な考え方が含まれています。それが「カプセル化」です。

カプセル化とは、簡単に言えば「データを守る仕組み」です。オブジェクトの中にあるデータを、外から勝手にいじれないように保護します。

なぜデータを守る必要があるのでしょうか。いくつか理由があります。

- データの整合性を保つ
  - 投稿者名が途中で変わると、誰の発言か分からなくなる
- 意図しないバグを防ぐ
  - 別の場所のコードが勝手に値を変えてしまうミスを防げる
- 変更の影響範囲を限定する
  - 内部の実装を変えても、外から使う側に影響が出にくい

カプセル化は「必要なものだけ公開する」という考え方でもあります。Messageクラスで言えば、「投稿者の名前を読み取る」機能は必要なので公開しますが、「投稿者の名前を変更する」機能は不要なので隠しているのです。

## Messageクラスを改良する

掲示板のメッセージとして、どの属性を読み取り専用にすべきか考えてみましょう。

- author（投稿者）：投稿した人は変わらない → `ro`
- body（本文）：編集機能があるなら変更可能 → `rw`

この考え方に基づいて、Messageクラスを改良します。

```perl
# 改良版Messageクラス
package Message {
    use Moo;
    has author => (is => 'ro');  # 読み取り専用
    has body   => (is => 'rw');  # 読み書き可能
};

my $msg = Message->new(author => '太郎', body => 'こんにちは！');

# 本文の編集はOK
$msg->body('内容を修正しました');
print $msg->author . ': ' . $msg->body . "\n";
# => 太郎: 内容を修正しました

# 投稿者の変更はエラー
# $msg->author('なりすまし');  # これはエラーになる
```

たった1文字、`rw`を`ro`に変えるだけで、大切なデータを守れるようになりました。

## まとめ

今回は、オブジェクト指向の重要な概念「カプセル化」を学びました。

- `is => 'rw'`は読み書き可能、後から値を変更できる
- `is => 'ro'`は読み取り専用、作成後は変更できない
- カプセル化とは、データを外から守り、必要な機能だけを公開する考え方である
- 属性ごとに`ro`/`rw`を適切に選ぶことで、意図しない変更を防げる

「何を変更可能にし、何を守るか」を意識してクラスを設計することで、より安全で分かりやすいコードになります。

次回は、「この属性は必ず指定してほしい」「指定がなければこの値を使う」といった、オブジェクト作成時の初期化について学んでいきます。
