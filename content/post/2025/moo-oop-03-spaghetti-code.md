---
title: "第3回-Mooで覚えるオブジェクト指向プログラミング"
draft: true
tags:
  - perl
  - moo
  - object-oriented
description: "まずはスパゲティコードで最小限のチャットを作り、その問題点を確認します"
---

[@nqounet](https://twitter.com/nqounet)です。

第2回では、第1回で書いたコードを1行ずつ読み解きながら、`$self`の役割を学びました。今回から、いよいよ実践編に入ります。

この連載のゴールは「掲示板（チャット）」を作ることです。まずはオブジェクト指向を使わずに、素朴なコードで最小限のチャットを作ってみましょう。そして、そのコードにどんな問題があるのかを確認していきます。

## 最小限のチャットを作ってみよう

掲示板（チャット）とは何でしょうか？シンプルに考えると「誰が何を言ったかを記録して、表示する」という機能があればチャットになります。

では、配列を使って最小限のチャットを作ってみましょう。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
binmode STDOUT, ':utf8';

# メッセージを保存する配列
my @authors;
my @messages;

# メッセージを追加する関数
sub add_message {
    my ($author, $message) = @_;
    push @authors, $author;
    push @messages, $message;
}

# メッセージを表示する関数
sub show_messages {
    for my $i (0 .. $#messages) {
        print "$authors[$i]: $messages[$i]\n";
    }
}

# 使ってみる
add_message('太郎', 'こんにちは！');
add_message('花子', 'はじめまして！');
add_message('太郎', 'よろしくね！');
show_messages();
```

このコードを実行すると、以下のように表示されます。

```
太郎: こんにちは！
花子: はじめまして！
太郎: よろしくね！
```

動きましたね！これだけのコードで、簡単なチャットができました。

しかし、このコードには大きな問題が潜んでいます。

## このコードの問題点

一見うまく動いているように見えるこのコード。しかし、機能を追加しようとすると、様々な問題が見えてきます。

### データが散らばっている

1つの投稿を表現するのに、`@authors`と`@messages`という2つの配列を使っています。「投稿者」と「メッセージ」は本来セットで1つの投稿なのに、別々の場所に保存されています。

もし「投稿日時」も記録したくなったら？`@timestamps`という配列を追加する必要があります。「編集済みフラグ」も欲しい？`@edited`という配列が増えます。

配列が増えれば増えるほど、「n番目の投稿は`$authors[n]`と`$messages[n]`と`$timestamps[n]`と`$edited[n]`で構成される」というルールを、プログラマが常に意識しなければなりません。

### 機能を追加しにくい

例えば「特定のユーザーの投稿だけを表示する」機能を追加したいとします。

どこにその機能を書けばいいでしょうか？新しい関数を作ることになりますが、その関数も`@authors`と`@messages`という配列に直接アクセスする必要があります。

配列の名前を変更したり、データの持ち方を変えたりすると、その配列を使っているすべての場所を修正しなければなりません。

### コードが読みにくくなる

`$authors[$i]`や`$messages[$i]`という書き方は、何を表しているのか一目では分かりにくいです。

コードを読む人は「`$i`は何を指しているのか」「なぜ`@authors`と`@messages`のインデックスが同じなのか」を理解しなければなりません。

これがもっと複雑なコードになると、どの配列とどの配列が対応しているのか、追いかけるのが大変になります。

## なぜスパゲティコードと呼ばれるのか

このようなコードは「スパゲティコード」と呼ばれることがあります。

スパゲティを箸で持ち上げると、あちこちの麺が絡まってついてきますよね。それと同じで、コードの一部分を修正しようとすると、予想外の場所に影響が出てしまうのです。

今回のコードで言えば、`@authors`配列の扱いを変えると、`add_message()`も`show_messages()`も修正が必要になります。将来追加される関数も、すべて同じ配列に依存することになります。

機能が増えれば増えるほど、コード全体が複雑に絡み合い、どこを触っても他の場所に影響が出るようになっていきます。

これを避けるための方法が「オブジェクト指向プログラミング」です。

## まとめ

今回は、変数と関数だけで最小限のチャットを作ってみました。

- 配列を使ってメッセージと投稿者を保存した
- データが散らばっていると管理が大変になる
- 機能追加のたびに、複数の場所を修正する必要がある
- これが「スパゲティコード」と呼ばれる状態である

このコードは動きますが、機能を追加するほど複雑になっていく運命にあります。

次回は、このスパゲティコードをオブジェクト指向で書き直します。「メッセージ」をクラスにすることで、どれだけコードがスッキリするか、ぜひ体験してください。
