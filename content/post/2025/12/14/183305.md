---
date: 2025-12-14T18:33:05+09:00
description: Perlã®Mojoliciousã§WebSocketã‚’å®Ÿè£…ã™ã‚‹å®Œå…¨ã‚¬ã‚¤ãƒ‰ã€‚ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’3ã‚¹ãƒ†ãƒƒãƒ—ã§æ§‹ç¯‰ã€‚åˆå¿ƒè€…ã§ã‚‚æ•°è¡Œã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã‚‹å®Ÿè·µãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€‚
draft: false
epoch: 1765704785
image: /public_images/2025/1765704785-image.jpg
iso8601: 2025-12-14T18:33:05+09:00
tags:
  - perl
  - mojolicious
  - websocket
  - real-time
  - web-development
  - tutorial
title: Perl WebSocketå…¥é–€ï¼šMojoliciousã§ä½œã‚‹3ã¤ã®å®Ÿè·µã‚¢ãƒ—ãƒª
---

[@nqounet](https://x.com/nqounet)ã§ã™ã€‚

**WebSocket**ã£ã¦èã„ãŸã“ã¨ã¯ã‚ã‚‹ã‘ã©ã€å®Ÿéš›ã«è§¦ã£ãŸã“ã¨ãŒãªã„æ–¹ã‚‚å¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿã“ã®è¨˜äº‹ã§ã¯ã€**Perl**ã®Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€Œ**Mojolicious**ã€ã‚’ä½¿ã£ã¦ã€**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡**ã®åŸºç¤ã‚’**3ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—**ã§å­¦ã‚“ã§ã„ãã¾ã™ã€‚

åˆå¿ƒè€…ã®æ–¹ã§ã‚‚ã€ã‚ãšã‹**10è¡Œã®ã‚³ãƒ¼ãƒ‰**ã‹ã‚‰WebSocketã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚ã“ã®è¨˜äº‹ã‚’èª­ã¿çµ‚ãˆã‚‹é ƒã«ã¯ã€ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚„ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒä½œã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

## WebSocketã¨ã¯ï¼Ÿãªãœå¿…è¦ãªã®ã‹

WebSocketã¯ã€Webãƒ–ãƒ©ã‚¦ã‚¶ã¨Webã‚µãƒ¼ãƒãƒ¼ã®é–“ã§**åŒæ–¹å‘é€šä¿¡**ã‚’å®Ÿç¾ã™ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚å¾“æ¥ã®HTTPã§ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‰ãªã„é™ã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

ã—ã‹ã—ã€WebSocketã‚’ä½¿ãˆã°ï¼š

- ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã§ãã‚‹
- 1ã¤ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã§ç¶™ç¶šçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚„ã‚Šå–ã‚Šã§ãã‚‹
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè£…ã—ã‚„ã™ã„

ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã€æ ªä¾¡ãƒœãƒ¼ãƒ‰ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ ã€IoTãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãªã©ã€WebSocketã®æ´»èºã®å ´ã¯åºƒãŒã£ã¦ã„ã¾ã™ã€‚

## ãªãœMojoliciousãªã®ã‹

**Mojolicious**ã¯ã€**WebSocket**ã‚’ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã«æ‰±ãˆã‚‹**Perl**ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ä»–ã®è¨€èªã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨æ¯”è¼ƒã—ã¦ã‚‚ã€å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ãã€ã™ãã«å®Ÿè·µã§ãã‚‹ã®ãŒç‰¹å¾´ã§ã™ã€‚

**Mojoliciousã‚’é¸ã¶ç†ç”±ï¼š**

- **è¨­å®šä¸è¦**: è¿½åŠ ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚„ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãªã—ã§WebSocketãŒä½¿ãˆã‚‹
- **ã‚·ãƒ³ãƒ—ãƒ«ãªAPI**: ã‚ãšã‹æ•°è¡Œã§WebSocketã‚µãƒ¼ãƒãƒ¼ãŒæ›¸ã‘ã‚‹
- **UTF-8è‡ªå‹•å¯¾å¿œ**: æ—¥æœ¬èªãªã©ã®å¤šè¨€èªãƒ†ã‚­ã‚¹ãƒˆã‚‚è‡ªå‹•çš„ã«æ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
- **éåŒæœŸI/O**: Mojo::IOLoopã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªä¸¦è¡Œå‡¦ç†
- **è±Šå¯Œãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿã—ã¦ãŠã‚Šã€åˆå¿ƒè€…ã«ã‚‚å„ªã—ã„

ãã‚Œã§ã¯ã€å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ããªãŒã‚‰å­¦ã‚“ã§ã„ãã¾ã—ã‚‡ã†ï¼

## æº–å‚™ï¼šMojoliciousã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ã Mojoliciousã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãªã„å ´åˆã¯ã€cpanmã‚’ä½¿ã£ã¦ç°¡å˜ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ï¼š

```bash
cpanm Mojolicious
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mojo version
```

ã“ã‚Œã§æº–å‚™å®Œäº†ã§ã™ï¼

## ã‚¹ãƒ†ãƒƒãƒ—1ï¼šã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹

ã¾ãšã¯ã€WebSocketã®åŸºæœ¬ã§ã‚ã‚‹ã€Œã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã€ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ã‚‰ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãã®ã¾ã¾è¿”ã™ã‚·ãƒ³ãƒ—ãƒ«ãªã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚

æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªWebSocketã‚µãƒ¼ãƒãƒ¼ã¯ã€ã‚ãšã‹10è¡Œç¨‹åº¦ã§æ›¸ã‘ã¾ã™ï¼š

```perl
#!/usr/bin/env perl
use Mojolicious::Lite -signatures;

# WebSocketãƒ«ãƒ¼ãƒˆã‚’å®šç¾©
websocket '/echo' => sub ($c) {
  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ãã®å‡¦ç†
  $c->on(message => sub ($c, $msg) {
    $c->send("Echo: $msg");
  });
};

app->start;
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ `echo_server.pl` ã¨ã—ã¦ä¿å­˜ã—ã€å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
perl echo_server.pl daemon
```

ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãŸã‚‰ã€æ¬¡ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãƒ†ã‚¹ãƒˆã§ãã¾ã™ï¼š

```html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Echo Test</title>
</head>
<body>
  <h1>WebSocket Echo Test</h1>
  <input type="text" id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
  <button onclick="sendMessage()">é€ä¿¡</button>
  <div id="output"></div>

  <script>
    const ws = new WebSocket('ws://localhost:3000/echo');
    
    ws.onmessage = function(event) {
      const output = document.getElementById('output');
      output.innerHTML += '<p>å—ä¿¡: ' + event.data + '</p>';
    };
    
    function sendMessage() {
      const input = document.getElementById('input');
      ws.send(input.value);
      input.value = '';
    }
  </script>
</body>
</html>
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã€ŒEcho: ã€ä»˜ãã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã£ã¦ãã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚

### æ—¥æœ¬èªå¯¾å¿œã¨ãƒ­ã‚®ãƒ³ã‚°æ©Ÿèƒ½ã®è¿½åŠ 

WebSocketã§æ—¥æœ¬èªã‚’æ‰±ã†å ´åˆã€æ–‡å­—ã‚³ãƒ¼ãƒ‰ã®æ‰±ã„ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚Mojoliciousã¯**è‡ªå‹•çš„ã«UTF-8ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’è¡Œã†**ãŸã‚ã€ç‰¹åˆ¥ãªè¨­å®šã¯ä¸è¦ã§ã™ãŒã€Perlã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§æ—¥æœ¬èªã‚’ä½¿ã†å ´åˆã¯ `use utf8;` ã‚’å¿˜ã‚Œãšã«ã€‚

ã¾ãŸã€å®Ÿç”¨çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€æ¥ç¶šãƒ»åˆ‡æ–­ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ­ã‚°ã‚’å–ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ä»¥ä¸‹ã¯ã€ãƒ­ã‚®ãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸæ”¹è‰¯ç‰ˆã§ã™ï¼š

```perl
#!/usr/bin/env perl
use utf8;
use Mojolicious::Lite -signatures;

# WebSocketãƒ«ãƒ¼ãƒˆã‚’å®šç¾©
websocket '/echo' => sub ($c) {
  # æ¥ç¶šæ™‚ã®ãƒ­ã‚°
  $c->app->log->info('WebSocketæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸ');
  
  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†
  $c->on(message => sub ($c, $msg) {
    $c->app->log->info("å—ä¿¡: $msg");
    $c->send("ã‚¨ã‚³ãƒ¼: $msg");  # æ—¥æœ¬èªã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
  });
  
  # åˆ‡æ–­æ™‚ã®å‡¦ç†
  $c->on(finish => sub ($c, $code, $reason) {
    $c->app->log->info("WebSocketåˆ‡æ–­: code=$code");
  });
};

app->start;
```

**ãƒã‚¤ãƒ³ãƒˆè§£èª¬ï¼š**

- `use utf8;`: Perlã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®æ—¥æœ¬èªæ–‡å­—åˆ—ã‚’æ­£ã—ãæ‰±ã†ãŸã‚ã«å¿…é ˆ
- `$c->on(message => ...)`: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
- `$c->send(...)`: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆMojoliciousãŒè‡ªå‹•çš„ã«UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
- `$c->on(finish => ...)`: WebSocketåˆ‡æ–­æ™‚ã®å‡¦ç†
- `$c->app->log->info(...)`: ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã¸ã®è¨˜éŒ²

Mojoliciousã®ç´ æ™´ã‚‰ã—ã„ç‚¹ã¯ã€**é€å—ä¿¡ã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè‡ªå‹•çš„ã«UTF-8ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹**ã“ã¨ã§ã™ã€‚é–‹ç™ºè€…ãŒæ˜ç¤ºçš„ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

## ã‚¹ãƒ†ãƒƒãƒ—2ï¼šè¤‡æ•°äººãƒãƒ£ãƒƒãƒˆã‚’ä½œã‚‹

ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã§WebSocketã®åŸºæœ¬ã‚’ç†è§£ã§ããŸã‚‰ã€æ¬¡ã¯è¤‡æ•°ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåŒæ™‚ã«æ¥ç¶šã™ã‚‹**ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒƒãƒˆã‚’å®Ÿè£…ã—ã¾ã™ï¼š

```perl
#!/usr/bin/env perl
use utf8;
use Mojolicious::Lite -signatures;

# æ¥ç¶šä¸­ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä¿æŒã™ã‚‹ãƒãƒƒã‚·ãƒ¥
my $clients = {};

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ï¼ˆHTMLãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼‰
get '/' => sub ($c) {
  $c->render(template => 'chat');
};

# WebSocketã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
websocket '/chat' => sub ($c) {
  my $id = sprintf "%s", $c->tx;  # æ¥ç¶šã”ã¨ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
  
  # æ–°ã—ã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç™»éŒ²
  $clients->{$id} = $c->tx;
  $c->app->log->info("ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶š: $id (total: " . scalar(keys %$clients) . ")");
  
  # å…¨å“¡ã«å‚åŠ é€šçŸ¥ã‚’é€ä¿¡
  broadcast("æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚åŠ ã—ã¾ã—ãŸ (total: " . scalar(keys %$clients) . ")");
  
  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†
  $c->on(message => sub ($c, $msg) {
    $c->app->log->info("[$id] $msg");
    broadcast("[$id] $msg");
  });
  
  # åˆ‡æ–­æ™‚ã®å‡¦ç†
  $c->on(finish => sub ($c, $code, $reason) {
    delete $clients->{$id};
    $c->app->log->info("ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ‡æ–­: $id (total: " . scalar(keys %$clients) . ")");
    broadcast("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€€å‡ºã—ã¾ã—ãŸ (total: " . scalar(keys %$clients) . ")");
  });
};

# å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
sub broadcast {
  my $msg = shift;
  for my $tx (values %$clients) {
    $tx->send($msg);
  }
}

app->start;

__DATA__

@@ chat.html.ep
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>WebSocket ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    #messages { 
      height: 400px; 
      overflow-y: scroll; 
      border: 1px solid #ccc; 
      padding: 10px; 
      margin-bottom: 10px;
    }
    #input { width: 80%; padding: 5px; }
    button { padding: 5px 15px; }
  </style>
</head>
<body>
  <h1>WebSocket ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h1>
  <div id="messages"></div>
  <input type="text" id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
  <button onclick="sendMessage()">é€ä¿¡</button>

  <script>
    const ws = new WebSocket('ws://' + location.host + '/chat');
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    
    ws.onopen = function() {
      addMessage('--- æ¥ç¶šã—ã¾ã—ãŸ ---');
    };
    
    ws.onmessage = function(event) {
      addMessage(event.data);
    };
    
    ws.onclose = function() {
      addMessage('--- åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ ---');
    };
    
    function addMessage(msg) {
      messages.innerHTML += '<p>' + escapeHtml(msg) + '</p>';
      messages.scrollTop = messages.scrollHeight;
    }
    
    function sendMessage() {
      if (input.value.trim()) {
        ws.send(input.value);
        input.value = '';
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
```

**ãƒã‚¤ãƒ³ãƒˆè§£èª¬ï¼š**

- `my $clients = {}`: æ¥ç¶šä¸­ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ãƒãƒƒã‚·ãƒ¥ã§ç®¡ç†
- `$c->tx`: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆæ¥ç¶šã”ã¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
- `broadcast()`: å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹é–¢æ•°
- `__DATA__` ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åŸ‹ã‚è¾¼ã¿ï¼ˆåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ãªãã¦OKï¼‰
- `escapeHtml()`: XSSå¯¾ç­–ã®ãŸã‚ã®HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ `chat_server.pl` ã¨ã—ã¦ä¿å­˜ã—ã€å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
perl chat_server.pl daemon
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:3000/` ã‚’é–‹ãã¨ã€ãƒãƒ£ãƒƒãƒˆç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚è¤‡æ•°ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆã¾ãŸã¯ã‚¿ãƒ–ï¼‰ã§é–‹ã„ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚„ã‚Šå–ã‚Šã—ã¦ã¿ã¦ãã ã•ã„ï¼

### JSONå½¢å¼ã§ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿é€ä¿¡

å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã§ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãªã©ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚‚ä¸€ç·’ã«é€ã‚ŠãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚JSONå½¢å¼ã‚’ä½¿ã†ã¨ã€æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ç°¡å˜ã«ã‚„ã‚Šå–ã‚Šã§ãã€å°†æ¥çš„ãªæ‹¡å¼µï¼ˆçµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€æ—¢èª­è¡¨ç¤ºã€ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ãªã©ï¼‰ã‚‚å®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€JSONå½¢å¼ã§é€šä¿¡ã™ã‚‹ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ä¾‹ã§ã™ï¼š

```perl
#!/usr/bin/env perl
use utf8;
use Mojolicious::Lite -signatures;
use Mojo::JSON qw(decode_json encode_json);
use Mojo::Util qw(decode encode);

my $clients = {};

get '/' => sub($c) {
  $c->render(template => 'chat_json');
};

websocket '/chat' => sub($c) {
  my $id = sprintf "%s", $c->tx;
  my $username = "User-" . substr($id, 0, 8); # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å

  $clients->{$id} = {
    tx       => $c->tx,
    username => $username,
  };

  # å‚åŠ é€šçŸ¥ã‚’JSONå½¢å¼ã§é€ä¿¡
  broadcast({
    type      => 'system',
    message   => "$username ãŒå‚åŠ ã—ã¾ã—ãŸ",
    timestamp => time,
    users     => scalar(keys %$clients),
  });

  $c->on(message => sub($c, $msg) {
    my $data = eval {decode_json(encode('UTF-8', $msg))};

    if ($@) {
      # JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼
      $c->send(encode_json({
        type    => 'error',
        message => 'Invalid JSON format',
      }));
      return;
    }

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    if ($data->{type} eq 'setname') {
      my $old_name = $clients->{$id}{username};
      $clients->{$id}{username} = $data->{username};
      broadcast({
        type      => 'system',
        message   => "$old_name ãŒ $data->{username} ã«åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ",
        timestamp => time,
        users     => scalar(keys %$clients),
      });
    }
    # é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    elsif ($data->{type} eq 'message') {
      broadcast({
        type      => 'message',
        username  => $clients->{$id}{username},
        message   => $data->{message},
        timestamp => time,
      });
    }
  });

  $c->on(finish => sub($c, $code, $reason) {
    my $username = $clients->{$id}{username};
    delete $clients->{$id};
    broadcast({
      type      => 'system',
      message   => "$username ãŒé€€å‡ºã—ã¾ã—ãŸ",
      timestamp => time,
      users     => scalar(keys %$clients),
    });
  });
};

sub broadcast {
  my $data = shift;
  my $json = encode_json($data);
  for my $client (values %$clients) {
    $client->{tx}->send(decode('UTF-8', $json)); # ä¸€æ—¦å†…éƒ¨ã‚³ãƒ¼ãƒ‰ã«æˆ»ã™
  }
}

app->start;

__DATA__

@@ chat_json.html.ep
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>WebSocket ãƒãƒ£ãƒƒãƒˆ (JSONç‰ˆ)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
    #messages { 
      height: 400px; 
      overflow-y: scroll; 
      border: 1px solid #ccc; 
      padding: 10px; 
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    .message { margin: 5px 0; }
    .system { color: #666; font-style: italic; }
    .username { font-weight: bold; color: #0066cc; }
    .timestamp { font-size: 0.8em; color: #999; }
    #input { width: 70%; padding: 8px; }
    button { padding: 8px 15px; }
    #username-input { width: 150px; padding: 5px; }
  </style>
</head>
<body>
  <h1>WebSocket ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ  (JSONç‰ˆ)</h1>
  <div>
    ãƒ¦ãƒ¼ã‚¶ãƒ¼å: 
    <input type="text" id="username-input" placeholder="åå‰ã‚’å…¥åŠ›">
    <button onclick="setUsername()">å¤‰æ›´</button>
  </div>
  <div id="messages"></div>
  <input type="text" id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
  <button onclick="sendMessage()">é€ä¿¡</button>

  <script>
    const ws = new WebSocket('ws://' + location.host + '/chat');
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    
    ws.onopen = function() {
      addSystemMessage('æ¥ç¶šã—ã¾ã—ãŸ');
    };
    
    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      
      if (data.type === 'system') {
        addSystemMessage(data.message + ' (å‚åŠ è€…: ' + (data.users || '?') + 'äºº)');
      } else if (data.type === 'message') {
        addChatMessage(data.username, data.message, data.timestamp);
      } else if (data.type === 'error') {
        addSystemMessage('ã‚¨ãƒ©ãƒ¼: ' + data.message);
      }
    };
    
    ws.onclose = function() {
      addSystemMessage('åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
    };
    
    function addChatMessage(username, msg, timestamp) {
      const time = new Date(timestamp * 1000).toLocaleTimeString('ja-JP');
      messages.innerHTML += 
        '<div class="message">' +
        '<span class="timestamp">[' + time + ']</span> ' +
        '<span class="username">' + escapeHtml(username) + ':</span> ' +
        escapeHtml(msg) +
        '</div>';
      messages.scrollTop = messages.scrollHeight;
    }
    
    function addSystemMessage(msg) {
      messages.innerHTML += '<div class="message system">--- ' + escapeHtml(msg) + ' ---</div>';
      messages.scrollTop = messages.scrollHeight;
    }
    
    function sendMessage() {
      if (input.value.trim()) {
        ws.send(JSON.stringify({
          type: 'message',
          message: input.value
        }));
        input.value = '';
      }
    }
    
    function setUsername() {
      const username = document.getElementById('username-input').value.trim();
      if (username) {
        ws.send(JSON.stringify({
          type: 'setname',
          username: username
        }));
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
```

**ãƒã‚¤ãƒ³ãƒˆè§£èª¬ï¼š**

- `use Mojo::JSON qw(decode_json encode_json)`: JSONå‡¦ç†ã®ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
- `decode_json()`: JSONæ–‡å­—åˆ—ã‚’Perlã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¤‰æ›
- `encode_json()`: Perlã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã« `type` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒãŸã›ã¦ã€ç¨®é¡ã‚’åŒºåˆ¥ï¼ˆsystem/message/setname/errorï¼‰
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡æ™‚åˆ»ã‚’è¨˜éŒ²
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã€ã‚ˆã‚Šãƒªã‚¢ãƒ«ãªãƒãƒ£ãƒƒãƒˆä½“é¨“ã‚’å®Ÿç¾
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼šä¸æ­£ãªJSONå½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é©åˆ‡ã«å‡¦ç†
- encode_jsonã‚„sendãŒè‡ªå‹•çš„ã«UTF-8ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã€encode_jsonã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’sendã™ã‚‹å ´åˆã€ä¸€æ—¦`decode('UTF-8', $json)`ã§å†…éƒ¨ã‚³ãƒ¼ãƒ‰ã«æˆ»ã™å¿…è¦ãŒã‚ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦

## ã‚¹ãƒ†ãƒƒãƒ—3ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œã‚‹

æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆCPUä½¿ç”¨ç‡ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãªã©ï¼‰ã‚’**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¯è¦–åŒ–ã™ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚WebSocketã®çœŸéª¨é ‚ã§ã‚ã‚‹ã€Œã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒƒã‚·ãƒ¥ã€ã‚’æ´»ç”¨ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®å®Ÿè£…ã§ã¯ã€`Mojo::IOLoop->recurring`ã‚’ä½¿ã£ã¦1ç§’ã”ã¨ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã—ã€æ¥ç¶šä¸­ã®å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥é…ä¿¡ã—ã¾ã™ï¼š

```perl
#!/usr/bin/env perl
use utf8;
use Mojolicious::Lite -signatures;
use Mojo::JSON qw(encode_json);

my $clients = {};

get '/' => sub ($c) {
  $c->render(template => 'dashboard');
};

websocket '/metrics' => sub ($c) {
  my $id = sprintf "%s", $c->tx;
  $clients->{$id} = $c->tx;
  
  $c->app->log->info("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ¥ç¶š: $id");
  
  $c->on(finish => sub ($c, $code, $reason) {
    delete $clients->{$id};
    $c->app->log->info("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆ‡æ–­: $id");
  });
};

# å®šæœŸçš„ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã—ã¦é€ä¿¡ï¼ˆ1ç§’ã”ã¨ï¼‰
Mojo::IOLoop->recurring(1 => sub {
  return unless keys %$clients;
  
  my $metrics = collect_metrics();
  my $json = encode_json($metrics);
  
  for my $tx (values %$clients) {
    $tx->send($json);
  }
});

# ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã™ã‚‹é–¢æ•°
sub collect_metrics {
  # Load Averageå–å¾—ï¼ˆLinux/macOS/Unixç³»ã§å‹•ä½œï¼‰
  # Linux: "load average: 0.00, 0.01, 0.05"
  # macOS: "load averages: 0.00 0.01 0.05"
  my $uptime = `uptime`;
  my ($load1, $load5, $load15) = $uptime =~ /load averages?: ([\d.]+)[,\s]+([\d.]+)[,\s]+([\d.]+)/;
  
  # ãƒ¡ãƒ¢ãƒªæƒ…å ±ï¼ˆLinuxç’°å¢ƒã®ã¿å¯¾å¿œï¼‰
  # æ³¨: macOSã‚„Windowsã§ã¯ /proc/meminfo ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€0ã‚’è¿”ã—ã¾ã™
  my $mem_total = 0;
  my $mem_free = 0;
  my $mem_available = 0;
  
  if (-e '/proc/meminfo') {
    open my $fh, '<', '/proc/meminfo';
    while (my $line = <$fh>) {
      $mem_total = $1 if $line =~ /^MemTotal:\s+(\d+)/;
      $mem_free = $1 if $line =~ /^MemFree:\s+(\d+)/;
      $mem_available = $1 if $line =~ /^MemAvailable:\s+(\d+)/;
    }
    close $fh;
  }
  
  my $mem_used = $mem_total - $mem_available;
  my $mem_percent = $mem_total > 0 ? ($mem_used / $mem_total * 100) : 0;
  
  # æ¥ç¶šæ•°ãªã©ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  my $connections = scalar(keys %$clients);
  
  return {
    timestamp => time,
    load => {
      load1 => $load1 || 0,
      load5 => $load5 || 0,
      load15 => $load15 || 0,
    },
    memory => {
      total => int($mem_total / 1024),      # MBå˜ä½
      used => int($mem_used / 1024),        # MBå˜ä½
      percent => sprintf("%.1f", $mem_percent),
    },
    connections => $connections,
    random => int(rand(100)),  # ãƒ‡ãƒ¢ç”¨ã®ãƒ©ãƒ³ãƒ€ãƒ å€¤
  };
}

app->start;

__DATA__

@@ dashboard.html.ep
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1200px; 
      margin: 20px auto;
      background: #f0f0f0;
    }
    h1 { text-align: center; }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .metric-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .metric-card h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 1em;
    }
    .metric-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #0066cc;
    }
    .metric-unit {
      font-size: 0.5em;
      color: #666;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    #load-chart {
      width: 100%;
      height: 200px;
      border: 1px solid #ddd;
    }
    .status {
      text-align: center;
      padding: 10px;
      background: #d4edda;
      color: #155724;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .status.disconnected {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  
  <div id="status" class="status">æ¥ç¶šä¸­...</div>
  
  <div class="metrics-grid">
    <div class="metric-card">
      <h3>CPU Load (1min)</h3>
      <div class="metric-value">
        <span id="load1">-</span>
      </div>
    </div>
    
    <div class="metric-card">
      <h3>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡</h3>
      <div class="metric-value">
        <span id="mem-percent">-</span><span class="metric-unit">%</span>
      </div>
    </div>
    
    <div class="metric-card">
      <h3>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</h3>
      <div class="metric-value">
        <span id="mem-used">-</span><span class="metric-unit">MB</span>
      </div>
    </div>
    
    <div class="metric-card">
      <h3>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥ç¶šæ•°</h3>
      <div class="metric-value">
        <span id="connections">-</span>
      </div>
    </div>
  </div>
  
  <div class="chart-container">
    <h3>è² è·æ¨ç§»ã‚°ãƒ©ãƒ•</h3>
    <canvas id="load-chart"></canvas>
  </div>

  <script>
    const ws = new WebSocket('ws://' + location.host + '/metrics');
    const status = document.getElementById('status');
    
    // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ç”¨ã®é…åˆ—ï¼ˆæœ€å¤§60ãƒã‚¤ãƒ³ãƒˆ = 1åˆ†é–“ï¼‰
    const chartData = {
      labels: [],
      load1: [],
      load5: [],
      load15: [],
    };
    const maxDataPoints = 60;
    
    ws.onopen = function() {
      status.textContent = 'âœ… æ¥ç¶šä¸­ - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™';
      status.className = 'status';
    };
    
    ws.onmessage = function(event) {
      const metrics = JSON.parse(event.data);
      updateMetrics(metrics);
      updateChart(metrics);
    };
    
    ws.onclose = function() {
      status.textContent = 'âŒ åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ';
      status.className = 'status disconnected';
    };
    
    function updateMetrics(metrics) {
      document.getElementById('load1').textContent = Number(metrics.load.load1).toFixed(2);
      document.getElementById('mem-percent').textContent = metrics.memory.percent;
      document.getElementById('mem-used').textContent = metrics.memory.used.toLocaleString();
      document.getElementById('connections').textContent = metrics.connections;
    }
    
    function updateChart(metrics) {
      const time = new Date(metrics.timestamp * 1000).toLocaleTimeString('ja-JP');
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
      chartData.labels.push(time);
      chartData.load1.push(metrics.load.load1);
      chartData.load5.push(metrics.load.load5);
      chartData.load15.push(metrics.load.load15);
      
      // å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆæœ€å¤§60ãƒã‚¤ãƒ³ãƒˆä¿æŒï¼‰
      if (chartData.labels.length > maxDataPoints) {
        chartData.labels.shift();
        chartData.load1.shift();
        chartData.load5.shift();
        chartData.load15.shift();
      }
      
      drawChart();
    }
    
    function drawChart() {
      const canvas = document.getElementById('load-chart');
      const ctx = canvas.getContext('2d');
      const width = canvas.width = canvas.offsetWidth;
      const height = canvas.height = 200;
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
      ctx.clearRect(0, 0, width, height);
      
      // ã‚°ãƒ©ãƒ•ã®æç”»é ˜åŸŸ
      const padding = 40;
      const chartWidth = width - padding * 2;
      const chartHeight = height - padding * 2;
      
      // æœ€å¤§å€¤ã‚’è¨ˆç®—ï¼ˆã‚°ãƒ©ãƒ•ã®ã‚¹ã‚±ãƒ¼ãƒ«ç”¨ï¼‰
      const maxLoad = Math.max(
        ...chartData.load1,
        ...chartData.load5,
        ...chartData.load15,
        1  // æœ€å°å€¤1ã‚’ä¿è¨¼
      );
      const yScale = chartHeight / (maxLoad * 1.2);  // 20%ãƒãƒ¼ã‚¸ãƒ³
      
      // èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = padding + (chartHeight / 5) * i;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
      }
      
      // ãƒ©ã‚¤ãƒ³ã‚’æç”»ã™ã‚‹é–¢æ•°
      function drawLine(data, color) {
        if (data.length === 0) return;
        
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        const xStep = chartWidth / (maxDataPoints - 1);
        data.forEach((value, index) => {
          const x = padding + (xStep * index);
          const y = padding + chartHeight - (value * yScale);
          
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        
        ctx.stroke();
      }
      
      // å„è² è·ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ­ãƒƒãƒˆ
      drawLine(chartData.load1, '#ff6b6b');   // 1åˆ†å¹³å‡ï¼ˆèµ¤ï¼‰
      drawLine(chartData.load5, '#4ecdc4');   // 5åˆ†å¹³å‡ï¼ˆé’ç·‘ï¼‰
      drawLine(chartData.load15, '#45b7d1');  // 15åˆ†å¹³å‡ï¼ˆé’ï¼‰
      
      // å‡¡ä¾‹
      ctx.font = '12px Arial';
      ctx.fillStyle = '#ff6b6b';
      ctx.fillText('1min', width - padding - 100, 20);
      ctx.fillStyle = '#4ecdc4';
      ctx.fillText('5min', width - padding - 60, 20);
      ctx.fillStyle = '#45b7d1';
      ctx.fillText('15min', width - padding - 20, 20);
      
      // Yè»¸ãƒ©ãƒ™ãƒ«
      ctx.fillStyle = '#666';
      ctx.textAlign = 'right';
      for (let i = 0; i <= 5; i++) {
        const value = (maxLoad * 1.2 / 5 * (5 - i)).toFixed(1);
        const y = padding + (chartHeight / 5) * i;
        ctx.fillText(value, padding - 10, y + 5);
      }
    }
  </script>
</body>
</html>
```

**ãƒã‚¤ãƒ³ãƒˆè§£èª¬ï¼š**

- `Mojo::IOLoop->recurring(1 => sub {...})`: 1ç§’ã”ã¨ã«å®šæœŸå®Ÿè¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒãƒ¼
- `collect_metrics()`: ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’åé›†ã™ã‚‹é–¢æ•°ï¼ˆ`/proc/meminfo`ã‚„`uptime`ã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨ï¼‰
- Canvas APIã‚’ä½¿ã£ãŸç°¡æ˜“ã‚°ãƒ©ãƒ•æç”»
- ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å®šæœŸçš„ã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å—ä¿¡ã—ã¦è¡¨ç¤º
- ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã¯æœ€å¤§60ãƒã‚¤ãƒ³ãƒˆï¼ˆ1åˆ†é–“åˆ†ï¼‰ã‚’ä¿æŒã—ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«å‰Šé™¤

ã“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ï¼š

```bash
perl dashboard_server.pl daemon
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:3000/` ã‚’é–‹ãã¨ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒæ›´æ–°ã•ã‚Œã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚è¤‡æ•°ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ã‚‚ã€ãã‚Œãã‚ŒãŒç‹¬ç«‹ã—ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å—ä¿¡ã—ã¾ã™ã€‚

### WebSocketã¨HTTPãƒãƒ¼ãƒªãƒ³ã‚°ã®æ¯”è¼ƒ

å¾“æ¥ã®HTTPãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆå®šæœŸçš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹æ–¹å¼ï¼‰ã¨æ¯”è¼ƒã—ã¦ã€WebSocketã«ã¯ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ï¼š

- **ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·**: æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãŒã™ãã«å±Šã
- **ä½ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰**: æ¯å›HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é€ã‚‹å¿…è¦ãŒãªãã€é€šä¿¡é‡ãŒå¤§å¹…ã«å‰Šæ¸›ã•ã‚Œã‚‹
- **ã‚µãƒ¼ãƒãƒ¼ãƒªã‚½ãƒ¼ã‚¹å‰Šæ¸›**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ãŒä¸è¦ãªãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼è² è·ãŒä½ã„
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§**: ã‚µãƒ¼ãƒãƒ¼å´ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å³åº§ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥ã§ãã‚‹

## WebSocketã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§WebSocketã‚’ä½¿ã†éš›ã®ãƒã‚¤ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

WebSocketã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ã€é€šå¸¸ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä»¥ä¸Šã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

**XSSï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼‰å¯¾ç­–**

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãã®ã¾ã¾HTMLã«è¡¨ç¤ºã™ã‚‹å ´åˆã€å¿…ãšã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’è¡Œã„ã¾ã—ã‚‡ã†ï¼š

```javascript
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
```

**WSSï¼ˆWebSocket Secureï¼‰ã®ä½¿ç”¨**

æœ¬ç•ªç’°å¢ƒã§ã¯ã€å¿…ãšæš—å·åŒ–ã•ã‚ŒãŸ `wss://` ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã—ã‚‡ã†ã€‚HTTPSã¨åŒæ§˜ã«ã€é€šä¿¡å†…å®¹ã®ç›—è´ã‚„æ”¹ã–ã‚“ã‚’é˜²ãã¾ã™ã€‚Mojoliciousã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç°¡å˜ã«TLSå¯¾å¿œã§ãã¾ã™ï¼š

```bash
# è¨¼æ˜æ›¸ã‚’ç”¨æ„ã—ã¦èµ·å‹•
perl myapp.pl daemon -l 'https://*:3000?cert=/path/to/cert.pem&key=/path/to/key.pem'
```

**å…¥åŠ›æ¤œè¨¼ã¨ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**

å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¿…ãšæ¤œè¨¼ã—ã€æƒ³å®šå¤–ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‹’å¦ã—ã¾ã—ã‚‡ã†ï¼š

```perl
$c->on(message => sub ($c, $msg) {
  # é•·ã™ãã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ‹’å¦
  if (length($msg) > 1000) {
    $c->send({json => {error => 'Message too long'}});
    return;
  }
  
  # JSONã¨ã—ã¦å¦¥å½“ã‹ãƒã‚§ãƒƒã‚¯
  my $data = eval { decode_json($msg) };
  if ($@) {
    $c->send({json => {error => 'Invalid JSON'}});
    return;
  }
  
  # å‡¦ç†ã‚’ç¶šã‘ã‚‹...
});
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

WebSocketã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ¬ç•ªç’°å¢ƒã§é‹ç”¨ã™ã‚‹éš›ã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã«æ³¨æ„ã‚’æ‰•ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®ç®¡ç†**

å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹å ´åˆã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ãªããƒã‚¤ãƒŠãƒªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ`$c->send({binary => $data})`ï¼‰ã®ä½¿ç”¨ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚ç”»åƒã‚„ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã«é©ã—ã¦ã„ã¾ã™ã€‚

**æ¥ç¶šæ•°ã®åˆ¶é™**

ã‚µãƒ¼ãƒãƒ¼ãƒªã‚½ãƒ¼ã‚¹ã‚’å®ˆã‚‹ãŸã‚ã€æœ€å¤§æ¥ç¶šæ•°ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ã‚‚é‡è¦ã§ã™ï¼š

```perl
my $max_clients = 1000;

websocket '/chat' => sub ($c) {
  if (scalar(keys %$clients) >= $max_clients) {
    $c->send('Server is full');
    $c->finish;
    return;
  }
  # é€šå¸¸ã®å‡¦ç†...
};
```

**ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆï¼ˆPing/Pongï¼‰**

é•·æ™‚é–“æ¥ç¶šã‚’ç¶­æŒã™ã‚‹å ´åˆã€å®šæœŸçš„ãªPingã§æ¥ç¶šã®ç”Ÿå­˜ç¢ºèªã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç„¡åŠ¹ãªæ¥ç¶šã‚’æ—©æœŸã«æ¤œå‡ºã—ã€ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾ã§ãã¾ã™ï¼š

```perl
websocket '/chat' => sub ($c) {
  # 30ç§’ã”ã¨ã«Pingã‚’é€ä¿¡ï¼ˆæ¥ç¶šã®ç”Ÿå­˜ç¢ºèªï¼‰
  my $ping_timer = Mojo::IOLoop->recurring(30 => sub {
    $c->send({ping => ''});  # Pingãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é€ä¿¡
  });
  
  $c->on(finish => sub {
    Mojo::IOLoop->remove($ping_timer);
  });
};
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨å†æ¥ç¶š

WebSocketæ¥ç¶šã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ã€ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã©æ§˜ã€…ãªç†ç”±ã§åˆ‡æ–­ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è‡ªå‹•å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å¤§å¹…ã«å‘ä¸Šã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã‚’ä½¿ã£ãŸå†æ¥ç¶šã®å®Ÿè£…ä¾‹ã§ã™ï¼š

```javascript
let ws;
let reconnectInterval = 1000;  // åˆæœŸå€¤1ç§’
const maxReconnectInterval = 30000;  // æœ€å¤§30ç§’

function connect() {
  ws = new WebSocket('ws://localhost:3000/chat');
  
  ws.onopen = function() {
    console.log('æ¥ç¶šã—ã¾ã—ãŸ');
    reconnectInterval = 1000;  // ãƒªã‚»ãƒƒãƒˆ
  };
  
  ws.onclose = function() {
    console.log('åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šã—ã¾ã™...');
    setTimeout(function() {
      reconnectInterval = Math.min(reconnectInterval * 2, maxReconnectInterval);
      connect();
    }, reconnectInterval);
  };
  
  ws.onerror = function(error) {
    console.error('WebSocketã‚¨ãƒ©ãƒ¼:', error);
  };
}

connect();
```

## ã¾ã¨ã‚

ã“ã®è¨˜äº‹ã§ã¯ã€**Perl**ã®**Mojolicious**ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã£ã¦ã€**WebSocket**ã®åŸºç¤ã‚’3ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å­¦ã³ã¾ã—ãŸï¼š

1. **ã‚¨ã‚³ãƒ¼ã‚µãƒ¼ãƒãƒ¼**: WebSocketã®åŸºæœ¬çš„ãªé€å—ä¿¡ã®ä»•çµ„ã¿ã‚’ç†è§£
2. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ**: è¤‡æ•°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã€JSONå½¢å¼ã§ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ åŒ–
3. **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯è¦–åŒ–

**Mojoliciousã®å¼·ã¿ï¼š**

- è¿½åŠ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸è¦ã§WebSocketãŒä½¿ãˆã‚‹
- UTF-8ã®è‡ªå‹•å‡¦ç†ã§æ—¥æœ¬èªã‚‚å®‰å¿ƒ
- ã‚·ãƒ³ãƒ—ãƒ«ãªAPIã§å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„
- éåŒæœŸI/Oã«ã‚ˆã‚‹é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**WebSocketãŒæ´»ãã‚‹å ´é¢ï¼š**

- ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ 
- æ ªä¾¡ãƒ»ã‚¹ãƒãƒ¼ãƒ„ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰
- IoTãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
- ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ï¼ˆå…±åŒç·¨é›†ãªã©ï¼‰

**WebSocket**ã¯ä¸€è¦‹é›£ã—ãã†ã«æ€ãˆã¾ã™ãŒã€**Mojolicious**ã‚’ä½¿ãˆã°ã‚ãšã‹æ•°è¡Œã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã¾ã™ã€‚ã¾ãšã¯ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã—ã¦ã¿ã¦ã€**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡**ã®é¢ç™½ã•ã‚’ä½“é¨“ã—ã¦ã¿ã¦ãã ã•ã„ï¼

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

WebSocketã®åŸºç¤ã‚’å­¦ã‚“ã ã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå¿œç”¨ã«ã‚‚ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

- **èªè¨¼æ©Ÿèƒ½ã®è¿½åŠ **: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº**: ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®æ°¸ç¶šåŒ–
- **è² è·åˆ†æ•£**: è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼ã§ã®WebSocketé‹ç”¨
- **ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ**: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚¢ãƒ—ãƒªã¨ã®é€£æº

## å‚è€ƒãƒªãƒ³ã‚¯

**Mojolicious**ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ã€ã“ã¡ã‚‰ã®è¨˜äº‹ã‚‚å‚è€ƒã«ã—ã¦ãã ã•ã„ï¼š

{{< linkcard "/2025/12/04/000000/" >}}

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼š

{{< linkcard "https://docs.mojolicious.org/" >}}

WebSocketãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®è©³ç´°ï¼ˆRFC 6455ï¼‰ï¼š

{{< linkcard "https://datatracker.ietf.org/doc/html/rfc6455" >}}

Happy WebSocket coding! ğŸš€
