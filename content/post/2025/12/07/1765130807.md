---
title: "開発環境構築とHello World"
description: "JSON::RPC::SpecとJSON::RPC::Spec::Clientのインストールから、最もシンプルなJSON-RPCサーバーとクライアントを実装します。"
tags:
  - json-rpc
  - perl
  - hello-world
  - tutorial
  - getting-started
draft: true
---

[@nqounet](https://x.com/nqounet)です。

前回の記事では、JSON-RPC 2.0の基本的な概念とREST APIとの違いについて説明しました。今回は実際に手を動かして、最もシンプルなJSON-RPCサーバーとクライアントを実装していきます。

この記事を読み終えるころには、あなたのマシンで動作する「Hello World」レベルのJSON-RPCシステムが完成しています。早速始めましょう！

## 前提条件

この記事では以下の環境を前提としています：

- Perlがインストールされている（バージョン5.10以上を推奨）
- cpanmがインストールされている
- ターミナル（コマンドライン）の基本的な操作ができる

Perlのバージョン確認は以下のコマンドで行えます：

```bash
perl -v
```

cpanmがインストールされていない場合は、以下のコマンドでインストールできます：

```bash
curl -L https://cpanmin.us | perl - App::cpanminus
```

## 必要なモジュールのインストール

今回使用するのは以下の2つのモジュールです：

- `JSON::RPC::Spec` - JSON-RPC 2.0サーバーを実装するためのモジュール
- `JSON::RPC::Spec::Client` - JSON-RPC 2.0クライアントを実装するためのモジュール

これらのモジュールは、JSON-RPC 2.0の仕様に準拠した実装を提供してくれます。cpanmを使ってインストールしましょう：

```bash
cpanm JSON::RPC::Spec
cpanm JSON::RPC::Spec::Client
```

インストールには数分かかる場合があります。エラーが出なければ成功です。

## 最小構成のJSON-RPCサーバーを作る

まずは、最もシンプルなJSON-RPCサーバーを実装します。`hello`という単一のメソッドを持ち、呼び出されたら「Hello, JSON-RPC!」という文字列を返すだけのサーバーです。

`server.pl`という名前でファイルを作成し、以下のコードを記述してください：

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use JSON::RPC::Spec;

# JSON-RPCサーバーのインスタンスを作成
my $rpc = JSON::RPC::Spec->new;

# helloメソッドを登録
$rpc->register(
    hello => sub {
        my ($params) = @_;
        return "Hello, JSON-RPC!";
    }
);

# PSGIアプリケーションとして実行
my $app = sub {
    my ($env) = @_;
    return $rpc->handle($env);
};
```

### コードの解説

このコードは非常にシンプルですが、JSON-RPCサーバーとしての基本機能を備えています。

1. **モジュールの読み込み**
   - `JSON::RPC::Spec`モジュールを読み込みます
   - `strict`と`warnings`は、より安全なコードを書くためのプラグマです

2. **サーバーインスタンスの作成**
   - `JSON::RPC::Spec->new`でサーバーのインスタンスを作成します

3. **メソッドの登録**
   - `register`メソッドを使って、`hello`という名前のメソッドを登録します
   - この関数は引数`$params`を受け取りますが、今回は使用していません
   - 単純に文字列「Hello, JSON-RPC!」を返します

4. **PSGIアプリケーション化**
   - `$app`変数にサブルーチンリファレンスを代入します
   - これはPSGI（Perl Web Server Gateway Interface）の仕様に従った形式です
   - `$rpc->handle($env)`で受け取ったリクエストを処理します

### サーバーの起動

サーバーを起動するには、`plackup`コマンドを使用します。plackupがインストールされていない場合は、以下のコマンドでインストールしてください：

```bash
cpanm Plack
```

インストールが完了したら、サーバーを起動します：

```bash
plackup server.pl
```

以下のような出力が表示されれば成功です：

```
HTTP::Server::PSGI: Accepting connections at http://0:5000/
```

サーバーはポート5000番で起動し、リクエストを待機している状態になります。

## 最小構成のJSON-RPCクライアントを作る

次に、このサーバーに接続してメソッドを呼び出すクライアントを作成します。新しいターミナルウィンドウを開き、`client.pl`という名前でファイルを作成してください：

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use JSON::RPC::Spec::Client;

# クライアントのインスタンスを作成
my $client = JSON::RPC::Spec::Client->new(
    url => 'http://localhost:5000/'
);

# helloメソッドを呼び出す
my $result = $client->call('hello');

# 結果を表示
if ($result->is_success) {
    print "Success: ", $result->result, "\n";
} else {
    print "Error: ", $result->error->{message}, "\n";
}
```

### コードの解説

クライアント側のコードも非常にシンプルです。

1. **モジュールの読み込み**
   - `JSON::RPC::Spec::Client`モジュールを読み込みます

2. **クライアントインスタンスの作成**
   - `new`メソッドで接続先のURLを指定してインスタンスを作成します
   - `http://localhost:5000/`は先ほど起動したサーバーのアドレスです

3. **メソッドの呼び出し**
   - `call`メソッドで`hello`メソッドを呼び出します
   - 戻り値は結果オブジェクトです

4. **結果の処理**
   - `is_success`メソッドで呼び出しが成功したかを確認します
   - 成功している場合は`result`メソッドで結果を取得します
   - 失敗している場合は`error`からエラーメッセージを取得します

## 動作確認

それでは実際に動作確認をしてみましょう。

1. **サーバーが起動していることを確認**
   - 最初のターミナルで`plackup server.pl`が実行されている状態にします

2. **クライアントを実行**
   - 別のターミナルで以下のコマンドを実行します：

```bash
perl client.pl
```

3. **結果の確認**
   - 以下のような出力が表示されれば成功です：

```
Success: Hello, JSON-RPC!
```

おめでとうございます！あなたは初めてのJSON-RPCシステムを構築し、動作させることができました。

## 裏側で何が起きているのか

クライアントを実行したとき、裏側では以下のような通信が行われています：

1. クライアントがJSON-RPC 2.0形式のリクエストをサーバーに送信：

```json
{
    "jsonrpc": "2.0",
    "method": "hello",
    "id": 1
}
```

2. サーバーがリクエストを受け取り、`hello`メソッドを実行

3. サーバーがJSON-RPC 2.0形式のレスポンスを返送：

```json
{
    "jsonrpc": "2.0",
    "result": "Hello, JSON-RPC!",
    "id": 1
}
```

この通信内容を確認したい場合は、curlコマンドを使って直接リクエストを送ることもできます：

```bash
curl -X POST http://localhost:5000/ \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"hello","id":1}'
```

実際のJSON形式のやり取りを見ることで、JSON-RPC 2.0がいかにシンプルなプロトコルであるかが実感できるでしょう。

## よくあるトラブルと解決方法

初めて実装する際によく遭遇する問題と解決方法を紹介します。

### サーバーが起動しない

エラーメッセージ: `Can't locate JSON/RPC/Spec.pm in @INC`

**解決方法**: モジュールが正しくインストールされていません。再度`cpanm JSON::RPC::Spec`を実行してください。

### クライアントが接続できない

エラーメッセージに`Connection refused`や`500 Can't connect`が含まれる場合

**解決方法**: 
- サーバーが起動しているか確認してください
- ポート番号が正しいか確認してください（デフォルトは5000）
- ファイアウォールがポートをブロックしていないか確認してください

### 結果が表示されない

**解決方法**: 
- サーバー側のコードで`return`文が正しく記述されているか確認してください
- クライアント側で`$result->result`を出力しているか確認してください

## 次のステップ

今回は引数なし、文字列を返すだけの最もシンプルな実装でした。次回は以下のような拡張を行います：

- 引数を受け取るメソッドの実装
- 複数のメソッドの登録
- エラーハンドリングの実装
- より実用的な例（計算機能など）の実装

まずは今回のコードを自分の手で動かし、コードを少し変更してみることをお勧めします。例えば：

- `hello`メソッドの返す文字列を変更してみる
- 新しいメソッド`goodbye`を追加してみる
- クライアント側で両方のメソッドを呼び出してみる

実際に手を動かすことで、JSON-RPCの仕組みがより深く理解できるはずです。

## まとめ

この記事では、JSON-RPC 2.0の開発環境を構築し、最小構成のサーバーとクライアントを実装しました：

- cpanmを使ったモジュールのインストール方法を学びました
- `JSON::RPC::Spec`を使ったサーバーの実装方法を学びました
- `JSON::RPC::Spec::Client`を使ったクライアントの実装方法を学びました
- ローカル環境での動作確認方法を学びました

わずか数十行のコードで、完全に動作するJSON-RPCシステムを構築できることがわかりました。これがJSON-RPC 2.0のシンプルさと美しさです。

次回は、より実用的な機能を追加していきます。お楽しみに！
