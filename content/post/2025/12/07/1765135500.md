---
title: "ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ä½¿ã† - JavaScriptã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…"
description: "ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã®JavaScriptã‹ã‚‰JSON-RPCã‚µãƒ¼ãƒãƒ¼ã‚’å‘¼ã³å‡ºã—ã€ç°¡å˜ãªWeb UIã‚’ä½œæˆã—ã¦ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Œæˆã•ã›ã¾ã™ã€‚"
tags:
  - json-rpc
  - javascript
  - browser
  - web-frontend
  - cors
draft: true
---

[@nqounet](https://x.com/nqounet)ã§ã™ã€‚

å‰å›ã®è¨˜äº‹ã§ã¯ã€JSON-RPCã‚µãƒ¼ãƒãƒ¼ã‚’PSGIç’°å¢ƒã§å‹•ä½œã•ã›ã€Plackã‚’ä½¿ã£ã¦å®Ÿéš›ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦å…¬é–‹ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã—ãŸã€‚

ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å®Ÿè£…ãŒå®Œæˆã—ãŸã®ã§ã€ä»Šå›ã¯ã„ã‚ˆã„ã‚ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚**ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã®JavaScript**ã‹ã‚‰JSON-RPCã‚µãƒ¼ãƒãƒ¼ã‚’å‘¼ã³å‡ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒã£ãŸãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Œæˆã•ã›ã¾ã—ã‚‡ã†ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€Fetch APIã‚’ä½¿ã£ãŸJSON-RPCé€šä¿¡ã€CORSå¯¾å¿œã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ãã—ã¦ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§ã€å®Ÿè·µçš„ãªãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…ã‚’ä½“é¨“ã—ã¾ã™ã€‚

## ãªãœJavaScriptã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒé‡è¦ãªã®ã‹

JSON-RPCã¯ã€ãã®åã®é€šã‚ŠJSONãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚JavaScriptã¨ã®ç›¸æ€§ã¯æŠœç¾¤ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªåˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ï¼š

### JavaScriptã§ä½¿ã†3ã¤ã®ãƒ¡ãƒªãƒƒãƒˆ

1. **è‡ªç„¶ãªå‹ã®å¯¾å¿œ**
   - JSONãŒJavaScriptã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒ¼ã‚¿å½¢å¼
   - `JSON.parse()`ã¨`JSON.stringify()`ã§ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«å¤‰æ›

2. **éåŒæœŸå‡¦ç†ã¨ã®è¦ªå’Œæ€§**
   - async/awaitã§èª­ã¿ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰
   - Promiseãƒ™ãƒ¼ã‚¹ã®å‡¦ç†ãŒè‡ªç„¶ã«æ›¸ã‘ã‚‹

3. **ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–æ©Ÿèƒ½ã§å®Œçµ**
   - Fetch APIã§è¿½åŠ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸è¦
   - ãƒ¢ãƒ€ãƒ³ãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰å…¨ã¦ã‚µãƒãƒ¼ãƒˆ

## æœ€å°é™ã®JavaScriptã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

ã¾ãšã€æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªJSON-RPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### jsonrpc-client.js

```javascript
/**
 * JSON-RPC 2.0 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
 */
class JsonRpcClient {
    constructor(url) {
        this.url = url;
        this.requestId = 1;
    }

    /**
     * JSON-RPCãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
     * @param {string} method - ãƒ¡ã‚½ãƒƒãƒ‰å
     * @param {Object|Array} params - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
     * @returns {Promise} - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®result
     */
    async call(method, params = null) {
        const request = {
            jsonrpc: '2.0',
            method: method,
            id: this.requestId++
        };

        if (params !== null) {
            request.params = params;
        }

        const response = await fetch(this.url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(request)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.error) {
            throw new JsonRpcError(data.error);
        }

        return data.result;
    }

    /**
     * é€šçŸ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾…ãŸãªã„ï¼‰
     * @param {string} method - ãƒ¡ã‚½ãƒƒãƒ‰å
     * @param {Object|Array} params - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
     */
    async notify(method, params = null) {
        const request = {
            jsonrpc: '2.0',
            method: method
        };

        if (params !== null) {
            request.params = params;
        }

        await fetch(this.url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(request)
        });
    }

    /**
     * ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
     * @param {Array} requests - ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é…åˆ—
     * @returns {Promise} - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®é…åˆ—
     */
    async batch(requests) {
        const batchRequests = requests.map(req => {
            const request = {
                jsonrpc: '2.0',
                method: req.method,
                id: this.requestId++
            };

            if (req.params !== undefined && req.params !== null) {
                request.params = req.params;
            }

            return request;
        });

        const response = await fetch(this.url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(batchRequests)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®IDé †ã«ã‚½ãƒ¼ãƒˆ
        return data.sort((a, b) => a.id - b.id);
    }
}

/**
 * JSON-RPCã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
 */
class JsonRpcError extends Error {
    constructor(error) {
        super(error.message);
        this.name = 'JsonRpcError';
        this.code = error.code;
        this.data = error.data;
    }
}
```

### ä½¿ç”¨ä¾‹

```javascript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
const client = new JsonRpcClient('http://localhost:5000/rpc');

// ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—
try {
    const result = await client.call('add', [5, 3]);
    console.log('5 + 3 =', result); // 8
} catch (error) {
    if (error instanceof JsonRpcError) {
        console.error('RPC Error:', error.code, error.message);
    } else {
        console.error('Network Error:', error);
    }
}

// é€šçŸ¥ã®é€ä¿¡
await client.notify('log', { level: 'info', message: 'User logged in' });

// ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆ
const results = await client.batch([
    { method: 'add', params: [1, 2] },
    { method: 'subtract', params: [10, 5] },
    { method: 'multiply', params: [3, 4] }
]);

console.log('Batch results:', results);
```

## CORSã®è¨­å®šã¨å¯¾å¿œ

ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰JSON-RPCã‚µãƒ¼ãƒãƒ¼ã‚’å‘¼ã³å‡ºã™å ´åˆã€CORSï¼ˆCross-Origin Resource Sharingï¼‰ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚

### CORSã¨ã¯

ç•°ãªã‚‹ã‚ªãƒªã‚¸ãƒ³ï¼ˆãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ãƒãƒ¼ãƒˆï¼‰ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãŒåˆ¶é™ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

ä¾‹ãˆã°ï¼š
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: `http://localhost:3000`
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: `http://localhost:5000`

ã“ã®å ´åˆã€ãƒãƒ¼ãƒˆãŒç•°ãªã‚‹ãŸã‚ã€Œã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã€ã¨ãªã‚Šã¾ã™ã€‚

### Plackã§ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š

å‰å›ã®PSGIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«CORSå¯¾å¿œã‚’è¿½åŠ ã—ã¾ã™ã€‚

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use Plack::Builder;
use JSON::RPC::Spec;

my $rpc = JSON::RPC::Spec->new;

# ãƒ¡ã‚½ãƒƒãƒ‰ã®ç™»éŒ²
$rpc->register(
    add => sub {
        my $params = shift;
        return $params->[0] + $params->[1];
    }
);

$rpc->register(
    subtract => sub {
        my $params = shift;
        return $params->[0] - $params->[1];
    }
);

$rpc->register(
    multiply => sub {
        my $params = shift;
        return $params->[0] * $params->[1];
    }
);

$rpc->register(
    getUserInfo => sub {
        my $params = shift;
        my $user_id = $params->{user_id};
        
        return {
            id => $user_id,
            name => "User $user_id",
            email => "user${user_id}\@example.com",
        };
    }
);

# PSGIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
my $app = sub {
    my $env = shift;
    
    # JSON-RPCãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿å‡¦ç†
    return $rpc->handle_psgi($env) if $env->{PATH_INFO} eq '/rpc';
    
    # ãã‚Œä»¥å¤–ã¯404
    return [404, ['Content-Type' => 'text/plain'], ['Not Found']];
};

# ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®é©ç”¨
builder {
    # CORSãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
    enable 'CrossOrigin',
        origins => '*',
        methods => ['POST', 'OPTIONS'],
        headers => ['Content-Type', 'Authorization'];
    
    # ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°
    enable 'AccessLog', format => 'combined';
    
    $app;
};
```

### èµ·å‹•æ–¹æ³•

```bash
plackup --port 5000 app.psgi
```

### CORSãƒ˜ãƒƒãƒ€ãƒ¼ã®ç¢ºèª

curlã§ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
curl -X OPTIONS http://localhost:5000/rpc \
  -H "Origin: http://localhost:3000" \
  -H "Access-Control-Request-Method: POST" \
  -v
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ä»¥ä¸‹ã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°OKã§ã™ï¼š

```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: POST, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
```

## å®Ÿè·µçš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

ã§ã¯ã€å®Ÿéš›ã«å‹•ä½œã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

### index.html

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON-RPC Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .result {
            background: #f5f7fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
        }

        .result.error {
            background: #fff5f5;
            border-left-color: #f56565;
        }

        .result.success {
            background: #f0fff4;
            border-left-color: #48bb78;
        }

        .result-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .result-content {
            color: #666;
            font-family: 'Courier New', monospace;
        }

        .batch-results {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .batch-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§® JSON-RPC Calculator</h1>

        <!-- åŸºæœ¬çš„ãªè¨ˆç®— -->
        <div class="card">
            <h2>åŸºæœ¬çš„ãªè¨ˆç®—</h2>
            <div class="input-group">
                <label for="num1">æ•°å€¤1</label>
                <input type="number" id="num1" value="10" step="any">
            </div>
            <div class="input-group">
                <label for="operation">æ¼”ç®—</label>
                <select id="operation">
                    <option value="add">åŠ ç®— (+)</option>
                    <option value="subtract">æ¸›ç®— (-)</option>
                    <option value="multiply">ä¹—ç®— (Ã—)</option>
                </select>
            </div>
            <div class="input-group">
                <label for="num2">æ•°å€¤2</label>
                <input type="number" id="num2" value="5" step="any">
            </div>
            <button onclick="calculate()">è¨ˆç®—ã™ã‚‹</button>
            <div id="calcResult"></div>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾— -->
        <div class="card">
            <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—</h2>
            <div class="input-group">
                <label for="userId">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                <input type="number" id="userId" value="123" min="1">
            </div>
            <button onclick="getUserInfo()">æƒ…å ±ã‚’å–å¾—</button>
            <div id="userResult"></div>
        </div>

        <!-- ãƒãƒƒãƒå‡¦ç† -->
        <div class="card">
            <h2>ãƒãƒƒãƒå‡¦ç†ãƒ‡ãƒ¢</h2>
            <p style="color: #666; margin-bottom: 15px;">
                è¤‡æ•°ã®è¨ˆç®—ã‚’ä¸€åº¦ã«å®Ÿè¡Œã—ã¾ã™ï¼ˆadd(1,2), subtract(10,5), multiply(3,4)ï¼‰
            </p>
            <button onclick="batchCalculate()">ãƒãƒƒãƒå®Ÿè¡Œ</button>
            <div id="batchResult"></div>
        </div>
    </div>

    <script src="jsonrpc-client.js"></script>
    <script>
        // JSON-RPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
        const client = new JsonRpcClient('http://localhost:5000/rpc');

        /**
         * è¨ˆç®—ã‚’å®Ÿè¡Œ
         */
        async function calculate() {
            const num1 = parseFloat(document.getElementById('num1').value);
            const num2 = parseFloat(document.getElementById('num2').value);
            const operation = document.getElementById('operation').value;
            const resultDiv = document.getElementById('calcResult');

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            resultDiv.innerHTML = '<div class="result"><div class="loading"></div> è¨ˆç®—ä¸­...</div>';

            try {
                const result = await client.call(operation, [num1, num2]);
                
                const operatorSymbol = {
                    add: '+',
                    subtract: '-',
                    multiply: 'Ã—'
                }[operation];

                resultDiv.innerHTML = `
                    <div class="result success">
                        <div class="result-title">è¨ˆç®—çµæœ</div>
                        <div class="result-content">${num1} ${operatorSymbol} ${num2} = ${result}</div>
                    </div>
                `;
            } catch (error) {
                showError(resultDiv, error);
            }
        }

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
         */
        async function getUserInfo() {
            const userId = parseInt(document.getElementById('userId').value);
            const resultDiv = document.getElementById('userResult');

            resultDiv.innerHTML = '<div class="result"><div class="loading"></div> å–å¾—ä¸­...</div>';

            try {
                const result = await client.call('getUserInfo', { user_id: userId });
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <div class="result-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</div>
                        <div class="result-content">
                            ID: ${result.id}<br>
                            åå‰: ${result.name}<br>
                            ãƒ¡ãƒ¼ãƒ«: ${result.email}
                        </div>
                    </div>
                `;
            } catch (error) {
                showError(resultDiv, error);
            }
        }

        /**
         * ãƒãƒƒãƒè¨ˆç®—ã‚’å®Ÿè¡Œ
         */
        async function batchCalculate() {
            const resultDiv = document.getElementById('batchResult');

            resultDiv.innerHTML = '<div class="result"><div class="loading"></div> å‡¦ç†ä¸­...</div>';

            try {
                const results = await client.batch([
                    { method: 'add', params: [1, 2] },
                    { method: 'subtract', params: [10, 5] },
                    { method: 'multiply', params: [3, 4] }
                ]);

                const operations = [
                    { op: '+', nums: [1, 2] },
                    { op: '-', nums: [10, 5] },
                    { op: 'Ã—', nums: [3, 4] }
                ];

                let html = '<div class="result success"><div class="result-title">ãƒãƒƒãƒå‡¦ç†çµæœ</div><div class="batch-results">';
                
                results.forEach((res, index) => {
                    const op = operations[index];
                    if (res.error) {
                        html += `
                            <div class="batch-item">
                                <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${res.error.message}
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="batch-item">
                                ${op.nums[0]} ${op.op} ${op.nums[1]} = <strong>${res.result}</strong>
                            </div>
                        `;
                    }
                });

                html += '</div></div>';
                resultDiv.innerHTML = html;
            } catch (error) {
                showError(resultDiv, error);
            }
        }

        /**
         * ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
         */
        function showError(element, error) {
            let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            let errorDetail = '';

            if (error instanceof JsonRpcError) {
                errorMessage = 'JSON-RPCã‚¨ãƒ©ãƒ¼';
                errorDetail = `ã‚³ãƒ¼ãƒ‰: ${error.code}<br>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${error.message}`;
            } else {
                errorDetail = error.message;
            }

            element.innerHTML = `
                <div class="result error">
                    <div class="result-title">${errorMessage}</div>
                    <div class="result-content">${errorDetail}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
```

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã¨å‹•ä½œç¢ºèª

### 1. ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•

```bash
# PSGIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
plackup --port 5000 app.psgi
```

### 2. HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®é…ä¿¡

é–‹ç™ºç”¨ã«ã¯ã€Pythonã®ç°¡æ˜“ã‚µãƒ¼ãƒãƒ¼ãŒä¾¿åˆ©ã§ã™ï¼š

```bash
# HTMLãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œ
python3 -m http.server 3000
```

ã¾ãŸã¯ã€Node.jsã®å ´åˆï¼š

```bash
npx http-server -p 3000
```

### 3. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹

```
http://localhost:3000/
```

### å‹•ä½œç¢ºèªã®ãƒã‚¤ãƒ³ãƒˆ

1. **åŸºæœ¬çš„ãªè¨ˆç®—**
   - æ•°å€¤ã‚’å…¥åŠ›ã—ã¦è¨ˆç®—ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - çµæœãŒå³åº§ã«è¡¨ç¤ºã•ã‚Œã‚‹

2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦æƒ…å ±ã‚’å–å¾—
   - åå‰ä»˜ããƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‹•ä½œã‚’ç¢ºèª

3. **ãƒãƒƒãƒå‡¦ç†**
   - ãƒãƒƒãƒå®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - 3ã¤ã®è¨ˆç®—ãŒä¸€åº¦ã«å®Ÿè¡Œã•ã‚Œã€çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

å„ªã‚ŒãŸWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ãä¼ãˆã¾ã™ã€‚

### ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡

1. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼**
   - ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ããªã„
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

2. **JSON-RPCã‚¨ãƒ©ãƒ¼**
   - ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„
   - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸æ­£
   - ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼

3. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼**
   - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚¨ãƒ©ãƒ¼
   - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼

### æ”¹è‰¯ç‰ˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```javascript
class JsonRpcClient {
    constructor(url, options = {}) {
        this.url = url;
        this.requestId = 1;
        this.timeout = options.timeout || 30000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30ç§’
        this.retries = options.retries || 0;
    }

    async call(method, params = null) {
        let lastError;

        // ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
        for (let attempt = 0; attempt <= this.retries; attempt++) {
            try {
                return await this._doCall(method, params);
            } catch (error) {
                lastError = error;
                
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã¿ãƒªãƒˆãƒ©ã‚¤
                if (error instanceof JsonRpcError || attempt === this.retries) {
                    throw error;
                }

                // ãƒªãƒˆãƒ©ã‚¤å‰ã«å°‘ã—å¾…ã¤ï¼ˆexponential backoffï¼‰
                await this._sleep(Math.pow(2, attempt) * 1000);
            }
        }

        throw lastError;
    }

    async _doCall(method, params) {
        const request = {
            jsonrpc: '2.0',
            method: method,
            id: this.requestId++
        };

        if (params !== null) {
            request.params = params;
        }

        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.timeout);

        try {
            const response = await fetch(this.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(request),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.error) {
                throw new JsonRpcError(data.error);
            }

            return data.result;
        } catch (error) {
            clearTimeout(timeoutId);

            if (error.name === 'AbortError') {
                throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
            }

            throw error;
        }
    }

    _sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}
```

## èªè¨¼ä»˜ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

å‰å›ã®èªè¨¼æ©Ÿèƒ½ã¨é€£æºã™ã‚‹ä¾‹ã§ã™ã€‚

```javascript
class AuthenticatedJsonRpcClient extends JsonRpcClient {
    constructor(url, options = {}) {
        super(url, options);
        this.token = null;
    }

    /**
     * ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
     */
    setToken(token) {
        this.token = token;
    }

    /**
     * ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢
     */
    clearToken() {
        this.token = null;
    }

    /**
     * èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
     */
    async _doCall(method, params) {
        const request = {
            jsonrpc: '2.0',
            method: method,
            id: this.requestId++
        };

        if (params !== null) {
            request.params = params;
        }

        const headers = {
            'Content-Type': 'application/json',
        };

        // ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°è¿½åŠ 
        if (this.token) {
            headers['Authorization'] = `Bearer ${this.token}`;
        }

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.timeout);

        try {
            const response = await fetch(this.url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(request),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.error) {
                throw new JsonRpcError(data.error);
            }

            return data.result;
        } catch (error) {
            clearTimeout(timeoutId);

            if (error.name === 'AbortError') {
                throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
            }

            throw error;
        }
    }

    /**
     * ãƒ­ã‚°ã‚¤ãƒ³
     */
    async login(username, password) {
        const result = await this.call('login', { username, password });
        this.setToken(result.token);
        return result;
    }

    /**
     * ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
     */
    logout() {
        this.clearToken();
    }
}
```

### ä½¿ç”¨ä¾‹

```html
<script>
const client = new AuthenticatedJsonRpcClient('http://localhost:5000/rpc');

async function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
        const result = await client.login(username, password);
        console.log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', result);
        
        // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€èªè¨¼ãŒå¿…è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã›ã‚‹
        const profile = await client.call('getProfile');
        console.log('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«:', profile);
    } catch (error) {
        console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
    }
}

function logout() {
    client.logout();
    console.log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
}
</script>
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ´»ç”¨

è¤‡æ•°ã®ç‹¬ç«‹ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã¾ã¨ã‚ã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚

```javascript
// æ‚ªã„ä¾‹: 3å›ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ
const user = await client.call('getUser', { id: 1 });
const posts = await client.call('getPosts', { user_id: 1 });
const comments = await client.call('getComments', { user_id: 1 });

// è‰¯ã„ä¾‹: 1å›ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ
const results = await client.batch([
    { method: 'getUser', params: { id: 1 } },
    { method: 'getPosts', params: { user_id: 1 } },
    { method: 'getComments', params: { user_id: 1 } }
]);

const [user, posts, comments] = results.map(r => r.result);
```

### 2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ“ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã€ä¸è¦ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸­æ­¢ã—ã¾ã™ã€‚

```javascript
class JsonRpcClient {
    // ... (å‰è¿°ã®ã‚³ãƒ¼ãƒ‰)

    /**
     * ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ
     */
    createCancellableRequest() {
        const controller = new AbortController();

        return {
            call: async (method, params) => {
                const request = {
                    jsonrpc: '2.0',
                    method: method,
                    id: this.requestId++
                };

                if (params !== null) {
                    request.params = params;
                }

                const response = await fetch(this.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(request),
                    signal: controller.signal
                });

                const data = await response.json();

                if (data.error) {
                    throw new JsonRpcError(data.error);
                }

                return data.result;
            },
            cancel: () => {
                controller.abort();
            }
        };
    }
}

// ä½¿ç”¨ä¾‹
const request = client.createCancellableRequest();

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹
request.call('longRunningTask', { data: 'something' })
    .then(result => console.log(result))
    .catch(error => console.log('Cancelled or error'));

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
cancelButton.addEventListener('click', () => {
    request.cancel();
});
```

### 3. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‡¦ç†ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¢ºã«ä¼ãˆã¾ã™ã€‚

```javascript
class LoadingManager {
    constructor() {
        this.loading = false;
        this.callbacks = [];
    }

    start() {
        this.loading = true;
        this.notify();
    }

    stop() {
        this.loading = false;
        this.notify();
    }

    onChange(callback) {
        this.callbacks.push(callback);
    }

    notify() {
        this.callbacks.forEach(cb => cb(this.loading));
    }
}

// ä½¿ç”¨ä¾‹
const loadingManager = new LoadingManager();

loadingManager.onChange(loading => {
    document.getElementById('spinner').style.display = loading ? 'block' : 'none';
    document.querySelectorAll('button').forEach(btn => {
        btn.disabled = loading;
    });
});

async function callApi() {
    loadingManager.start();
    try {
        const result = await client.call('someMethod', params);
        // çµæœã‚’è¡¨ç¤º
    } finally {
        loadingManager.stop();
    }
}
```

## ãƒ‡ãƒãƒƒã‚°ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã®ãƒ‡ãƒãƒƒã‚°

ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ã¾ã™ã€‚

```javascript
class JsonRpcClient {
    constructor(url, options = {}) {
        this.url = url;
        this.requestId = 1;
        this.debug = options.debug || false;
    }

    async call(method, params = null) {
        const request = {
            jsonrpc: '2.0',
            method: method,
            id: this.requestId++
        };

        if (params !== null) {
            request.params = params;
        }

        if (this.debug) {
            console.group(`JSON-RPC: ${method}`);
            console.log('Request:', request);
        }

        try {
            const response = await fetch(this.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(request)
            });

            const data = await response.json();

            if (this.debug) {
                console.log('Response:', data);
                console.groupEnd();
            }

            if (data.error) {
                throw new JsonRpcError(data.error);
            }

            return data.result;
        } catch (error) {
            if (this.debug) {
                console.error('Error:', error);
                console.groupEnd();
            }
            throw error;
        }
    }
}

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹
const client = new JsonRpcClient('http://localhost:5000/rpc', { debug: true });
```

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| CORSã‚¨ãƒ©ãƒ¼ | ã‚µãƒ¼ãƒãƒ¼ãŒCORSãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿”ã—ã¦ã„ãªã„ | Plack::Middleware::CrossOriginã‚’è¿½åŠ  |
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œãªã„ | URLãŒé–“é•ã£ã¦ã„ã‚‹ | é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®Networkã‚¿ãƒ–ã§ç¢ºèª |
| çµæœãŒè¡¨ç¤ºã•ã‚Œãªã„ | éåŒæœŸå‡¦ç†ã®èª¤ã‚Š | async/awaitã‚’æ­£ã—ãä½¿ã† |
| ã‚¨ãƒ©ãƒ¼ãŒcatchã•ã‚Œãªã„ | Promiseã®ã‚¨ãƒ©ãƒ¼å‡¦ç†æ¼ã‚Œ | try-catchã¾ãŸã¯.catch()ã‚’è¿½åŠ  |

## ã¾ã¨ã‚

ã“ã®è¨˜äº‹ã§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã®JavaScriptã‹ã‚‰JSON-RPCã‚µãƒ¼ãƒãƒ¼ã‚’å‘¼ã³å‡ºã™å®Ÿè£…ã‚’å­¦ã³ã¾ã—ãŸï¼š

### å­¦ã‚“ã ã“ã¨

1. **åŸºæœ¬çš„ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…**
   - Fetch APIã‚’ä½¿ã£ãŸJSON-RPCé€šä¿¡
   - async/awaitã«ã‚ˆã‚‹éåŒæœŸå‡¦ç†

2. **CORSå¯¾å¿œ**
   - ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç†è§£
   - PlackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã®è¨­å®š

3. **å®Ÿè·µçš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å®Ÿè£…
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

4. **é«˜åº¦ãªæ©Ÿèƒ½**
   - ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ´»ç”¨
   - èªè¨¼ä»˜ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### æ¬¡å›äºˆå‘Š

æ¬¡å›ã¯ã€**Node.jsã§ã®JSON-RPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…**ã‚’å­¦ã³ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼é–“é€šä¿¡ã‚„CLIãƒ„ãƒ¼ãƒ«ã®ä½œæˆãªã©ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¦–ç‚¹ã§ã®JSON-RPCæ´»ç”¨ã‚’ä½“é¨“ã—ã¾ã—ã‚‡ã†ã€‚

ãã‚Œã§ã¯ã€ã¾ãŸæ¬¡å›ï¼

Happy Coding!
