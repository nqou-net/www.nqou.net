---
title: 'PerlでTODOリスト（CLI）を作成する - 第6回: タスクをデータベースに追加する（Create）'
draft: true
tags:
  - perl
  - dbi
  - insert
description: PerlでCLIベースのTODOリストアプリを作る連載の第6回。DBIのprepareメソッドとINSERT文を使って、フォームからのタスクをデータベースに安全に登録する方法を学びます。
---

[@nqounet](https://x.com/nqounet)です。

「PerlでTODOリスト（CLI）を作成する」シリーズの第6回です。

## 前回のおさらい

[第5回](/2025/12/30/163825/)では、テキストファイルによるデータ管理の限界を理解し、DBIとSQLiteを使ってデータベースに接続、タスク用のテーブル（`tasks`）を作成しました。

## 今回のゴール

今回は、以下の2点を達成します。

- `INSERT INTO`文を使ってタスクをデータベースに追加する
- プレースホルダを使った安全なSQL実行を理解する

## INSERT文とは

`INSERT INTO`は、データベースのテーブルに新しい行を追加するSQL文です。基本的な構文は以下の通りです。

```sql
INSERT INTO テーブル名 (カラム1, カラム2, ...) VALUES (値1, 値2, ...)
```

前回作成した`tasks`テーブルにタスクを追加する場合は、以下のようになります。

```sql
INSERT INTO tasks (title) VALUES ('牛乳を買う')
```

`id`、`completed`、`created_at`は自動で設定されるため、`title`だけを指定すればOKです。

## なぜプレースホルダが必要なのか

ユーザーからの入力をそのままSQL文に埋め込むのは非常に危険です。悪意のあるユーザーが特殊な文字列を入力することで、意図しないSQLが実行されてしまう可能性があります。これを「SQLインジェクション」と呼びます。

```perl
# ❌ 危険な例（絶対にやってはいけない）
my $title = $user_input;  # ユーザー入力をそのまま使う
$dbh->do("INSERT INTO tasks (title) VALUES ('$title')");
```

もし`$user_input`が`'); DROP TABLE tasks; --`のような文字列だった場合、`tasks`テーブルが削除されてしまいます。

この問題を防ぐために、「プレースホルダ」を使います。プレースホルダは`?`で表され、実際の値は後から安全にバインドされます。

## コード例1: prepareとexecuteでタスクを追加する

`$dbh->prepare`でSQL文を準備し、`$sth->execute`で実行します。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use open ':std', ':encoding(UTF-8)';
use DBI;

my $dbh = DBI->connect(
    'dbi:SQLite:dbname=todo.db',
    '',
    '',
    {
        RaiseError     => 1,
        AutoCommit     => 1,
        sqlite_unicode => 1,
    }
) or die "データベース接続エラー: $DBI::errstr";

# ユーザーからタスク名を入力
print "タスク名を入力してください > ";
my $title = <STDIN>;
chomp $title;

# プレースホルダを使ってINSERT文を準備
my $sth = $dbh->prepare(q{
    INSERT INTO tasks (title) VALUES (?)
});

# プレースホルダに値をバインドして実行
$sth->execute($title);

print "タスク「$title」を追加しました\n";

$dbh->disconnect;
```

このコードのポイントは以下の通りです。

- `$dbh->prepare`でSQL文を準備し、ステートメントハンドル（`$sth`）を取得する
- `?`がプレースホルダで、実際の値は`execute`時に渡す
- `$sth->execute($title)`でプレースホルダに値をバインドして実行する
- プレースホルダを使うことで、SQLインジェクションを防げる

### prepareとdoの違い

`$dbh->do`は単純なSQL文を1回実行するのに便利ですが、プレースホルダを使う場合は`prepare` + `execute`のパターンを使います。

| メソッド | 用途 |
|:---------|:-----|
| `$dbh->do` | 単純なSQL文を1回実行する場合（CREATE TABLE等） |
| `$dbh->prepare` + `$sth->execute` | プレースホルダを使う場合、同じSQLを繰り返し実行する場合 |

## コード例2: last_insert_idで追加したタスクのIDを取得する

タスクを追加した後、そのタスクに割り当てられたIDを取得したい場合があります。`$dbh->last_insert_id`を使うと、直前に挿入された行のIDを取得できます。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use open ':std', ':encoding(UTF-8)';
use DBI;

my $dbh = DBI->connect(
    'dbi:SQLite:dbname=todo.db',
    '',
    '',
    {
        RaiseError     => 1,
        AutoCommit     => 1,
        sqlite_unicode => 1,
    }
) or die "データベース接続エラー: $DBI::errstr";

print "タスク名を入力してください > ";
my $title = <STDIN>;
chomp $title;

my $sth = $dbh->prepare(q{
    INSERT INTO tasks (title) VALUES (?)
});
$sth->execute($title);

# 追加したタスクのIDを取得
my $task_id = $dbh->last_insert_id(undef, undef, 'tasks', 'id');

print "タスク「$title」を追加しました（ID: $task_id）\n";

$dbh->disconnect;
```

このコードのポイントは以下の通りです。

- `$dbh->last_insert_id`で直前にINSERTした行のIDを取得する
- 引数の`undef, undef, 'tasks', 'id'`は、カタログ、スキーマ、テーブル名、カラム名を指定する（SQLiteでは最初の2つは`undef`でOK）
- 取得したIDは、追加したタスクの確認や、関連データの登録に活用できる

## TODOアプリに組み込む

これまでのコードをTODOアプリに組み込んでみましょう。`add_task`サブルーチンを実装します。

```perl
sub add_task {
    my ($dbh) = @_;

    print "タスク名を入力してください > ";
    my $title = <STDIN>;
    chomp $title;

    if ($title eq '') {
        print "タスク名が空です\n";
        return;
    }

    my $sth = $dbh->prepare(q{
        INSERT INTO tasks (title) VALUES (?)
    });
    $sth->execute($title);

    my $task_id = $dbh->last_insert_id(undef, undef, 'tasks', 'id');
    print "タスク「$title」を追加しました（ID: $task_id）\n";
}
```

ポイントは以下の通りです。

- 空のタスク名はエラーとして弾く
- プレースホルダで安全にタスクを追加する
- 追加後にIDを表示してフィードバックする

## 関連リンク

DBIやデータベースについて、詳しくは以下の記事も参考にしてください。

- [第1回: TODOリストアプリを作ろう - 完成イメージと設計](/2025/12/30/163821/)
- [第5回: ファイル版の限界とデータベースへの移行](/2025/12/30/163825/)
- [Perlでのデータベース操作 — DBI / DBIx::Class 入門](/2025/12/13/000000/)

## まとめ

- `INSERT INTO`文でデータベースにデータを追加する
- ユーザー入力は必ずプレースホルダ（`?`）を使ってバインドする
- `$dbh->prepare`でSQL文を準備し、`$sth->execute`で実行する
- `$dbh->last_insert_id`で追加した行のIDを取得できる
- プレースホルダを使うことでSQLインジェクションを防げる

## 次回予告

次回は、タスク一覧を表示する方法（SELECT）を学びます。データベースからデータを取得し、TODOリストを画面に表示できるようになります。お楽しみに！
