---
title: 'PerlでTODOリスト（CLI）を作成する - 第3回: タスクをファイルに保存する'
draft: true
tags:
  - perl
  - file-io
  - utf8
description: PerlでCLIベースのTODOリストアプリを作る連載の第3回。openによるファイル書き込みとprint $fhによるタスク出力を学びます。UTF-8エンコーディング対応も解説します。
---

[@nqounet](https://x.com/nqounet)です。

「PerlでTODOリスト（CLI）を作成する」シリーズの第3回です。

## 前回のおさらい

[第2回](/2025/12/30/163822/)では、`<STDIN>`を使ってユーザーからの入力を受け取り、`chomp`で改行を除去する方法を学びました。対話型メニューの実装と入力バリデーションも行いました。

## 今回のゴール

今回は、以下の2点を達成します。

- `open`を使ってファイルに書き込む方法を理解する
- UTF-8エンコーディングを指定して日本語タスクを正しく保存する

## なぜファイル保存が必要なのか

これまでのコードでは、タスクは配列に格納していました。しかし、プログラムを終了すると配列の中身は消えてしまいます。タスクを永続化するためには、ファイルに保存する必要があります。

今回は、最もシンプルな方法として「1行1タスク」形式のテキストファイルに保存します。

```text
牛乳を買う
メールを送る
レポートを書く
```

## コード例1: openでファイルを開いて書き込む

Perlでファイルに書き込むには、`open`関数を使ってファイルハンドルを開きます。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use open ':std', ':encoding(UTF-8)';

# タスクの配列（サンプルデータ）
my @tasks = (
    '牛乳を買う',
    'メールを送る',
    'レポートを書く',
);

# 保存先ファイル
my $file = 'todo.txt';

# ファイルを書き込みモードで開く
open my $fh, '>:encoding(UTF-8)', $file
    or die "ファイルを開けません: $file ($!)";

# 各タスクを1行ずつ書き込む
for my $task (@tasks) {
    print $fh "$task\n";
}

# ファイルハンドルを閉じる
close $fh;

print "タスクを $file に保存しました（", scalar(@tasks), "件）\n";
```

このコードのポイントは以下の通りです。

- `open my $fh, '>:encoding(UTF-8)', $file`で書き込みモードでファイルを開く
- `>`は「書き込みモード」を意味し、ファイルが存在すれば上書きされる
- `:encoding(UTF-8)`でUTF-8エンコーディングを指定する
- `or die`でエラー時にメッセージを表示して終了する
- `$!`にはOSからのエラーメッセージが格納される

### 3引数形式のopen

`open`関数は、モダンPerlでは「3引数形式」を使います。

```perl
open my $fh, '>:encoding(UTF-8)', $file;
```

- 第1引数: ファイルハンドル（`my $fh`でレキシカル変数として宣言）
- 第2引数: モードとエンコーディング（`>:encoding(UTF-8)`）
- 第3引数: ファイルパス

書き込みモードには以下の種類があります。

- `>` : 書き込み（上書き）
- `>>` : 追記
- `<` : 読み込み（デフォルト）

## コード例2: TODOリストアプリにファイル保存を組み込む

実際のTODOリストアプリに、タスク保存機能を組み込んでみましょう。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use open ':std', ':encoding(UTF-8)';

my @tasks;
my $file = 'todo.txt';

# メインループ
while (1) {
    print "\n=== TODO リスト ===\n";
    show_tasks();
    print "メニュー: a:追加 s:保存 q:終了\n";
    print "選択 > ";

    my $input = <STDIN>;
    last unless defined $input;
    chomp $input;

    if ($input eq 'a') {
        print "タスク名 > ";
        my $task = <STDIN>;
        next unless defined $task;
        chomp $task;
        next if $task eq '';
        push @tasks, $task;
        print "「$task」を追加しました\n";
    }
    elsif ($input eq 's') {
        save_tasks();
    }
    elsif ($input eq 'q') {
        print "終了します\n";
        last;
    }
}

sub show_tasks {
    if (@tasks == 0) {
        print "(タスクがありません)\n";
        return;
    }
    my $i = 1;
    for my $task (@tasks) {
        print "$i. $task\n";
        $i++;
    }
}

sub save_tasks {
    open my $fh, '>:encoding(UTF-8)', $file
        or do {
            print "エラー: ファイルを開けません ($!)\n";
            return;
        };

    for my $task (@tasks) {
        print $fh "$task\n";
    }

    close $fh;
    print "タスクを $file に保存しました\n";
}
```

このコードのポイントは以下の通りです。

- `save_tasks`サブルーチンでファイル保存処理をカプセル化する
- `or do { ... }`でエラー時の処理を記述し、`die`せずに処理を継続する
- `print $fh "$task\n"`でファイルハンドルに出力する

### print $fhの構文

`print`文でファイルハンドルに出力する際は、ファイルハンドルの後にカンマを付けません。

```perl
# 正しい書き方
print $fh "$task\n";

# 間違い（カンマがある）
print $fh, "$task\n";  # これは意図した動作にならない
```

## UTF-8エンコーディングについて

日本語のタスクを正しく保存するには、UTF-8エンコーディングの指定が必要です。

### ファイル操作時のエンコーディング指定

`open`関数で`:encoding(UTF-8)`を指定することで、書き込み時に自動的にUTF-8でエンコードされます。

```perl
open my $fh, '>:encoding(UTF-8)', $file;
```

### 標準入出力のエンコーディング

スクリプト冒頭の`use open ':std', ':encoding(UTF-8)';`は、標準入出力（`STDIN`、`STDOUT`、`STDERR`）のエンコーディングをUTF-8に設定します。これにより、ターミナルとの日本語のやり取りが正しく行われます。

### utf8プラグマ

`use utf8;`は、スクリプト自体がUTF-8で書かれていることをPerlに伝えます。これにより、スクリプト内の日本語リテラル（例: `'牛乳を買う'`）が正しく処理されます。

## 関連リンク

ファイル操作に関連する技術について、詳しくは以下の記事も参考にしてください。

- [第1回: TODOリストアプリを作ろう - 完成イメージと設計](/2025/12/30/163821/)
- [第2回: ユーザーからの入力を受け取る](/2025/12/30/163822/)
- [PerlのCPANモジュール20選（Path::Tiny含む）](/2025/12/03/041603/)
- [Perlのエラー処理 - Try::Tiny](/2025/12/14/000000/)

## まとめ

- `open my $fh, '>:encoding(UTF-8)', $file`でファイルを書き込みモードで開く
- `print $fh "$task\n"`でファイルハンドルに出力する（カンマ不要）
- `or die`や`or do { ... }`でエラー処理を行う
- UTF-8エンコーディングを指定することで日本語を正しく保存できる
- `use utf8`と`use open ':std', ':encoding(UTF-8)'`は日本語処理の基本である

## 次回予告

次回は、保存したファイルからタスクを読み込む方法を学びます。`open`の読み込みモードと、ファイルからの1行ずつの読み取りを実装していきましょう。お楽しみに！
