---
title: 'PerlでTODOリスト（CLI）を作成する - 第8回: タスクを完了にする（Update）'
draft: true
tags:
  - perl
  - dbi
  - update
description: PerlでCLIベースのTODOリストアプリを作る連載の第8回。UPDATE文を使って、タスクの完了フラグを更新する方法を学びます。executeの戻り値を使った更新結果の確認も実装します。
---

[@nqounet](https://x.com/nqounet)です。

「PerlでTODOリスト（CLI）を作成する」シリーズの第8回です。

## 前回のおさらい

[第7回](/2025/12/30/163827/)では、SELECT文と`fetchrow_hashref`を使って、データベースからタスク一覧を取得しました。完了/未完了を`[x]`/`[ ]`のマークで区別して表示する方法も学びました。

## 今回のゴール

今回は、以下の2点を達成します。

- `UPDATE`文を使ってタスクの完了フラグを更新する
- `execute`の戻り値を使って更新結果を確認する

## UPDATE文とは

`UPDATE`は、データベースの既存データを更新するSQL文です。基本的な構文は以下の通りです。

```sql
UPDATE テーブル名 SET カラム名 = 値 WHERE 条件
```

タスクを完了にする場合は、`completed`カラムを1に更新します。

```sql
UPDATE tasks SET completed = 1 WHERE id = ?
```

`WHERE`句を忘れると、テーブル内のすべてのレコードが更新されてしまうので注意してください。

## executeの戻り値

`$sth->execute`の戻り値は、更新されたレコード数（影響を受けた行数）を返します。この値を使って、更新が成功したかどうかを確認できます。

- 1以上: 更新成功（指定した行数が更新された）
- 0: 更新対象なし（存在しないIDを指定した場合など）
- `undef`: エラー発生（`RaiseError`が有効な場合は例外がスローされる）

この戻り値を活用することで、存在しないIDを指定した場合にも適切なメッセージを表示できます。

## コード例1: タスクを完了にする

タスクIDを指定して、完了フラグを更新するコードです。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use open ':std', ':encoding(UTF-8)';
use DBI;

my $dbh = DBI->connect(
    'dbi:SQLite:dbname=todo.db',
    '',
    '',
    {
        RaiseError     => 1,
        AutoCommit     => 1,
        sqlite_unicode => 1,
    }
) or die "データベース接続エラー: $DBI::errstr";

# 完了にするタスクID
my $task_id = 1;

# UPDATE文を実行
my $sth = $dbh->prepare(q{
    UPDATE tasks SET completed = 1 WHERE id = ?
});
my $rows = $sth->execute($task_id);

# 更新結果を確認
if ($rows > 0) {
    print "タスク $task_id を完了にしました\n";
}
else {
    print "タスク $task_id は存在しません\n";
}

$dbh->disconnect;
```

このコードのポイントは以下の通りです。

- プレースホルダ`?`を使ってSQLインジェクションを防ぐ
- `execute`の戻り値を変数`$rows`で受け取る
- `$rows > 0`で更新成功/失敗を判定する
- 存在しないIDを指定した場合は「存在しません」と表示する

## コード例2: 完了/未完了を切り替える

現在の状態に応じて、完了と未完了を切り替えるトグル機能を実装します。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use open ':std', ':encoding(UTF-8)';
use DBI;

my $dbh = DBI->connect(
    'dbi:SQLite:dbname=todo.db',
    '',
    '',
    {
        RaiseError     => 1,
        AutoCommit     => 1,
        sqlite_unicode => 1,
    }
) or die "データベース接続エラー: $DBI::errstr";

# 切り替えるタスクID
my $task_id = 1;

# NOT演算子で0と1を反転させる
my $sth = $dbh->prepare(q{
    UPDATE tasks SET completed = NOT completed WHERE id = ?
});
my $rows = $sth->execute($task_id);

if ($rows > 0) {
    print "タスク $task_id の状態を切り替えました\n";
}
else {
    print "タスク $task_id は存在しません\n";
}

$dbh->disconnect;
```

このコードのポイントは以下の通りです。

- SQLの`NOT`演算子で0と1を反転させる
- 現在の状態を取得せずに、1回のSQL文で切り替えが完了する
- トグル操作なので、完了→未完了、未完了→完了の両方に対応できる

## 存在しないIDを指定した場合

`execute`の戻り値が0の場合、指定したIDに該当するレコードが存在しないことを意味します。これはエラーではなく、単に更新対象がなかったことを示しています。

ユーザーに対しては、以下のようなメッセージを表示するのが親切です。

- 「タスク X は存在しません」
- 「指定されたタスクが見つかりませんでした」

このように戻り値を活用することで、ユーザーに適切なフィードバックを提供できます。

## 関連リンク

DBIやデータベースについて、詳しくは以下の記事も参考にしてください。

- [第1回: TODOリストアプリを作ろう - 完成イメージと設計](/2025/12/30/163821/)
- [第7回: タスク一覧を表示する（Read）](/2025/12/30/163827/)
- [Perlでのデータベース操作 — DBI / DBIx::Class 入門](/2025/12/13/000000/)

## まとめ

- `UPDATE`文でデータベースの既存データを更新する
- `WHERE`句で更新対象を限定する（忘れると全件更新になる）
- `execute`の戻り値は影響を受けた行数を返す
- 戻り値が0の場合は更新対象が存在しないことを意味する
- SQLの`NOT`演算子で0/1を反転させ、トグル操作を実現できる

## 次回予告

次回は、タスクを削除する方法（DELETE）を学びます。不要になったタスクをデータベースから安全に削除し、削除確認のプロンプトも実装します。お楽しみに！
