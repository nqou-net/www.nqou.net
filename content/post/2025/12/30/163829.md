---
title: 'PerlでTODOリスト（CLI）を作成する - 第9回: タスクを削除する（Delete）'
draft: true
tags:
  - perl
  - dbi
  - delete
description: PerlでCLIベースのTODOリストアプリを作る連載の第9回。DELETE文を使って、不要になったタスクをデータベースから削除する方法を学びます。削除前にユーザー確認を求めるベストプラクティスも紹介します。
---

[@nqounet](https://x.com/nqounet)です。

「PerlでTODOリスト（CLI）を作成する」シリーズの第9回です。

## 前回のおさらい

[第8回](/2025/12/30/163828/)では、UPDATE文を使ってタスクの完了フラグを更新しました。`execute`の戻り値を使って更新結果を確認する方法や、SQLの`NOT`演算子で完了/未完了を切り替えるトグル機能も実装しました。

## 今回のゴール

今回は、以下の2点を達成します。

- `DELETE`文を使ってタスクを削除する
- 削除前にユーザー確認を求めるプロンプトを実装する

## DELETE文とは

`DELETE`は、データベースからレコードを削除するSQL文です。基本的な構文は以下の通りです。

```sql
DELETE FROM テーブル名 WHERE 条件
```

タスクをIDで指定して削除する場合は、以下のようになります。

```sql
DELETE FROM tasks WHERE id = ?
```

`WHERE`句を忘れると、テーブル内のすべてのレコードが削除されてしまうので、特に注意が必要です。

## 削除は取り消せない

**削除操作は取り消しができません。** UPDATEの場合は元の値に戻せますが、DELETEで削除したレコードはデータベースから完全に消えてしまいます。

そのため、以下の対策を講じることが重要です。

- 削除前にユーザーに確認を求める
- 誤操作を防ぐためにIDを慎重に確認する
- 本番環境ではバックアップを定期的に取得する

## コード例1: タスクを削除する

タスクIDを指定して削除するコードです。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use open ':std', ':encoding(UTF-8)';
use DBI;

my $dbh = DBI->connect(
    'dbi:SQLite:dbname=todo.db',
    '',
    '',
    {
        RaiseError     => 1,
        AutoCommit     => 1,
        sqlite_unicode => 1,
    }
) or die "データベース接続エラー: $DBI::errstr";

# 削除するタスクID
my $task_id = 1;

# 削除前に確認
print "タスク $task_id を削除しますか？ (y/n) > ";
my $confirm = <STDIN>;
chomp $confirm;

if ($confirm ne 'y') {
    print "削除をキャンセルしました\n";
    exit;
}

# DELETE文を実行
my $sth = $dbh->prepare(q{
    DELETE FROM tasks WHERE id = ?
});
my $rows = $sth->execute($task_id);

# 削除結果を確認
if ($rows > 0) {
    print "タスク $task_id を削除しました\n";
}
else {
    print "タスク $task_id は存在しません\n";
}

$dbh->disconnect;
```

このコードのポイントは以下の通りです。

- 削除前に `y/n` の確認プロンプトを表示する
- `y` 以外の入力は削除をキャンセルする
- プレースホルダ`?`を使ってSQLインジェクションを防ぐ
- `execute`の戻り値で削除成功/失敗を判定する

## コード例2: タスク情報を表示してから確認する

削除対象のタスク内容を表示してから確認を求めると、ユーザーはより安心して操作できます。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use open ':std', ':encoding(UTF-8)';
use DBI;

my $dbh = DBI->connect(
    'dbi:SQLite:dbname=todo.db',
    '',
    '',
    {
        RaiseError     => 1,
        AutoCommit     => 1,
        sqlite_unicode => 1,
    }
) or die "データベース接続エラー: $DBI::errstr";

# 削除するタスクID
my $task_id = 1;

# まずタスク情報を取得
my $sth_select = $dbh->prepare(q{
    SELECT id, title FROM tasks WHERE id = ?
});
$sth_select->execute($task_id);
my $task = $sth_select->fetchrow_hashref;

if (!$task) {
    print "タスク $task_id は存在しません\n";
    exit;
}

# タスク情報を表示して確認
print "以下のタスクを削除します:\n";
print "  ID: $task->{id}\n";
print "  タイトル: $task->{title}\n";
print "本当に削除しますか？ (y/n) > ";
my $confirm = <STDIN>;
chomp $confirm;

if ($confirm ne 'y') {
    print "削除をキャンセルしました\n";
    exit;
}

# DELETE文を実行
my $sth_delete = $dbh->prepare(q{
    DELETE FROM tasks WHERE id = ?
});
$sth_delete->execute($task_id);

print "タスク「$task->{title}」を削除しました\n";

$dbh->disconnect;
```

このコードのポイントは以下の通りです。

- 削除前にSELECT文でタスク情報を取得する
- タスクが存在しない場合は早期に終了する
- タスクのタイトルを表示して、ユーザーが正しい対象を確認できるようにする
- 削除完了時にはタイトルを含めたメッセージを表示する

## 削除確認のベストプラクティス

ユーザーに削除確認を求める際のベストプラクティスをまとめます。

- **何を削除するか明示する**: 単にIDだけでなく、タスク名や内容を表示する
- **デフォルトは安全な選択肢にする**: `y/n` で `n` がデフォルトになるよう、`y` 以外はキャンセルとする
- **確認メッセージは明確にする**: 「削除しますか？」ではなく「本当に削除しますか？」のように注意を促す
- **一括削除には特に注意する**: 複数件削除する場合は、件数を表示して確認を求める

## 関連リンク

DBIやデータベースについて、詳しくは以下の記事も参考にしてください。

- [第1回: TODOリストアプリを作ろう - 完成イメージと設計](/2025/12/30/163821/)
- [第8回: タスクを完了にする（Update）](/2025/12/30/163828/)
- [Perlでのデータベース操作 — DBI / DBIx::Class 入門](/2025/12/13/000000/)
- [Perlのエラー処理 - Try::Tiny](/2025/12/14/000000/)

## まとめ

- `DELETE`文でデータベースからレコードを削除する
- `WHERE`句で削除対象を限定する（忘れると全件削除になる）
- 削除は取り消しができないため、必ずユーザー確認を求める
- 削除対象の情報を表示してから確認を求めるとより安全である
- `execute`の戻り値で削除成功/失敗を判定できる

## 次回予告

次回は最終回です。コマンドライン引数を使って、メニューを経由せずにサクサク操作できるインターフェースを実装します。お楽しみに！
