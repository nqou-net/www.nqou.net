---
title: 'PerlでTODOリスト（CLI）を作成する - 第7回: タスク一覧を表示する（Read）'
draft: true
tags:
  - perl
  - dbi
  - select
description: PerlでCLIベースのTODOリストアプリを作る連載の第7回。SELECT文とfetchrow_hashrefを使って、データベースからタスク一覧を取得し表示する方法を学びます。全タスク表示と未完了タスクのフィルタリングも実装します。
---

[@nqounet](https://x.com/nqounet)です。

「PerlでTODOリスト（CLI）を作成する」シリーズの第7回です。

## 前回のおさらい

[第6回](/2025/12/30/163826/)では、INSERT文とプレースホルダを使って、タスクをデータベースに安全に追加しました。`$dbh->prepare`でSQL文を準備し、`$sth->execute`で実行するパターンを学びました。

## 今回のゴール

今回は、以下の2点を達成します。

- `SELECT`文を使ってデータベースからタスクを取得する
- 全タスクと未完了タスクを条件付きで表示する

## SELECT文とは

`SELECT`は、データベースからデータを取得するSQL文です。基本的な構文は以下の通りです。

```sql
SELECT カラム1, カラム2, ... FROM テーブル名
```

すべてのカラムを取得する場合は`*`（アスタリスク）を使います。

```sql
SELECT * FROM tasks
```

条件を指定してデータを絞り込む場合は`WHERE`句を使います。

```sql
SELECT * FROM tasks WHERE completed = 0
```

## fetchrow_hashrefでデータを取得する

DBIでは、`SELECT`文の結果を取得するためにいくつかの方法がありますが、最も使いやすいのが`fetchrow_hashref`です。このメソッドは、1行ずつハッシュリファレンスとしてデータを返します。

```perl
while (my $row = $sth->fetchrow_hashref) {
    # $row->{カラム名} でアクセス
    print $row->{title};
}
```

ハッシュリファレンスなので、カラム名をキーとして値にアクセスできます。これにより、コードが読みやすくなり、カラムの順番を気にする必要がありません。

## コード例1: 全タスクを取得して表示する

`SELECT * FROM tasks`で全件取得し、ループで表示します。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use open ':std', ':encoding(UTF-8)';
use DBI;

my $dbh = DBI->connect(
    'dbi:SQLite:dbname=todo.db',
    '',
    '',
    {
        RaiseError     => 1,
        AutoCommit     => 1,
        sqlite_unicode => 1,
    }
) or die "データベース接続エラー: $DBI::errstr";

# 全タスクを取得
my $sth = $dbh->prepare(q{
    SELECT * FROM tasks ORDER BY id
});
$sth->execute;

print "=== TODO リスト ===\n\n";

while (my $row = $sth->fetchrow_hashref) {
    my $id    = $row->{id};
    my $title = $row->{title};
    my $completed = $row->{completed};

    # 完了/未完了をマークで区別
    my $mark = $completed ? '[x]' : '[ ]';
    print "$id. $mark $title\n";
}

$dbh->disconnect;
```

このコードのポイントは以下の通りです。

- `ORDER BY id`で取得順を指定する
- `fetchrow_hashref`でハッシュリファレンスとして1行ずつ取得する
- `$row->{completed}`の値で完了（1）/未完了（0）を判定する
- 完了タスクは`[x]`、未完了タスクは`[ ]`で表示を区別する

## コード例2: 未完了タスクのみをフィルタリングする

`WHERE completed = 0`を使って、未完了のタスクだけを取得します。

```perl
#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use open ':std', ':encoding(UTF-8)';
use DBI;

my $dbh = DBI->connect(
    'dbi:SQLite:dbname=todo.db',
    '',
    '',
    {
        RaiseError     => 1,
        AutoCommit     => 1,
        sqlite_unicode => 1,
    }
) or die "データベース接続エラー: $DBI::errstr";

# 未完了タスクのみを取得
my $sth = $dbh->prepare(q{
    SELECT * FROM tasks WHERE completed = 0 ORDER BY id
});
$sth->execute;

print "=== 未完了タスク ===\n\n";

my $count = 0;
while (my $row = $sth->fetchrow_hashref) {
    $count++;
    my $id    = $row->{id};
    my $title = $row->{title};
    print "$id. [ ] $title\n";
}

if ($count == 0) {
    print "未完了のタスクはありません\n";
}

$dbh->disconnect;
```

このコードのポイントは以下の通りです。

- `WHERE completed = 0`で未完了タスクのみに絞り込む
- カウンタ変数を使って、結果が0件の場合にメッセージを表示する
- 未完了タスクのみなので、マークは常に`[ ]`になる

## TODOアプリに組み込む

これまでのコードをTODOアプリに組み込んでみましょう。`show_tasks`サブルーチンを実装します。

```perl
sub show_tasks {
    my ($dbh, $show_all) = @_;

    my $sql = $show_all
        ? q{ SELECT * FROM tasks ORDER BY id }
        : q{ SELECT * FROM tasks WHERE completed = 0 ORDER BY id };

    my $sth = $dbh->prepare($sql);
    $sth->execute;

    print "=== TODO リスト ===\n\n";

    my $count = 0;
    while (my $row = $sth->fetchrow_hashref) {
        $count++;
        my $id    = $row->{id};
        my $title = $row->{title};
        my $completed = $row->{completed};

        my $mark = $completed ? '[x]' : '[ ]';
        print "$id. $mark $title\n";
    }

    if ($count == 0) {
        print "タスクはありません\n";
    }

    print "\n";
}
```

ポイントは以下の通りです。

- 引数`$show_all`で全タスク/未完了のみを切り替える
- 三項演算子でSQL文を選択する
- 結果が0件の場合は「タスクはありません」と表示する

## 関連リンク

DBIやデータベースについて、詳しくは以下の記事も参考にしてください。

- [第1回: TODOリストアプリを作ろう - 完成イメージと設計](/2025/12/30/163821/)
- [第6回: タスクをデータベースに追加する（Create）](/2025/12/30/163826/)
- [Perlでのデータベース操作 — DBI / DBIx::Class 入門](/2025/12/13/000000/)

## まとめ

- `SELECT`文でデータベースからデータを取得する
- `fetchrow_hashref`で1行ずつハッシュリファレンスとして取得する
- `WHERE`句で条件を指定してデータを絞り込む
- 完了/未完了は`[x]`/`[ ]`のマークで視覚的に区別する
- 結果が0件の場合は適切なメッセージを表示する

## 次回予告

次回は、タスクを完了にする方法（UPDATE）を学びます。データベースの既存データを更新し、タスクの完了/未完了を切り替えられるようになります。お楽しみに！
