---
title: "マージのコンフリクトを解決！git mergetool と三者間マージの理解"
draft: true
tags:
- "git"
- "merge-conflict"
- "git-mergetool"
- "troubleshooting"
- "best-practices"
description: "コンフリクト解決の苦手意識を克服。BASE, LOCAL, REMOTEの三者間マージの概念から、mergetoolの設定、vimdiff/VSCode等のツール活用、部分的なファイル採用まで、コンフリクトを確実に解決する実践技術を紹介します。"
---

## コンフリクトが起きる仕組み

マージやリベース時のコンフリクトは、Gitが「どちらの変更を採用すべきか判断できない」時に発生します。恐れる必要はありません。正しく理解すれば、確実に解決できます。

### 三者間マージ（3-way merge）とは

Gitのマージは、3つのバージョンを比較します：

- **BASE**: 分岐前の共通祖先
- **LOCAL**: 現在のブランチ（あなたの変更）
- **REMOTE**: マージしようとしているブランチ（相手の変更）

```
      BASE (共通祖先)
       /     \
   LOCAL    REMOTE
  (自分)    (相手)
       \     /
      MERGED (結果)
```

この3つを見比べて、自動マージできない箇所がコンフリクトになります。

### BASE, LOCAL, REMOTE の理解

実例で見てみましょう：

**BASE（元のコード）**:
```javascript
function greet(name) {
  return "Hello " + name;
}
```

**LOCAL（あなたの変更）**:
```javascript
function greet(name) {
  return `Hello ${name}!`;  // テンプレートリテラル化
}
```

**REMOTE（相手の変更）**:
```javascript
function greet(name) {
  return "Hi " + name;  // 挨拶を変更
}
```

両方とも同じ箇所を変更しているため、Gitは自動判断できません。

## 手動でのコンフリクト解決

### コンフリクトマーカーの読み方

コンフリクトが発生すると、ファイルにマーカーが挿入されます：

```javascript
function greet(name) {
<<<<<<< HEAD (LOCAL)
  return `Hello ${name}!`;
=======
  return "Hi " + name;
>>>>>>> feature-branch (REMOTE)
}
```

マーカーの意味：
- `<<<<<<< HEAD`: ここからLOCAL（現在のブランチ）の変更
- `=======`: LOCALとREMOTEの境界
- `>>>>>>> feature-branch`: ここまでREMOTE（マージ元）の変更

### git status で状況確認

```bash
# コンフリクト状態を確認
git status

# 出力例
Unmerged paths:
  (use "git add <file>..." to mark resolution)
    both modified:   src/app.js
```

`both modified`は両方で変更されたことを示します。

### 解決手順

1. **ファイルを編集**してマーカーを削除し、正しいコードを残す
2. **ステージング**して解決を伝える
3. **マージをコミット**

```bash
# 1. ファイルを編集（エディタで）
vim src/app.js

# 2. 解決したファイルをステージング
git add src/app.js

# 3. マージを完了
git commit  # デフォルトのマージメッセージが用意される
```

## git mergetool でビジュアルに解決

`git mergetool`を使うと、視覚的なツールでコンフリクト解決ができます。

### 主要ツールの紹介

人気のマージツール：

- **vimdiff**: Vim組み込み（軽量、どこでも使える）
- **meld**: GUIツール（直感的、Linux/Windows）
- **VSCode**: エディタ統合（開発環境と統一）
- **kdiff3**: クロスプラットフォーム対応
- **P4Merge**: Perforce製（無料、視覚的）

### mergetool の設定方法

#### VSCodeを使う場合

```bash
# VSCodeをmergetoolに設定
git config --global merge.tool vscode
git config --global mergetool.vscode.cmd 'code --wait --diff $LOCAL $REMOTE $MERGED'

# 使用
git mergetool
```

#### vimdiffを使う場合

```bash
# vimdiffを設定（多くの環境でデフォルト）
git config --global merge.tool vimdiff

# 使用
git mergetool
```

vimdiffの画面分割：
```
+------------------+------------------+------------------+
|      LOCAL       |      BASE        |     REMOTE       |
|    (現在)         |   (共通祖先)      |   (マージ元)      |
+--------------------------------------------------+
|                   MERGED (作業領域)                |
+--------------------------------------------------+
```

#### meldを使う場合

```bash
# meldをインストール（Ubuntu/Debian）
sudo apt install meld

# 設定
git config --global merge.tool meld

# 使用
git mergetool
```

### mergetoolの実行

```bash
# コンフリクトファイルをツールで開く
git mergetool

# 特定のファイルのみ
git mergetool src/app.js
```

ツールが起動し、3つのバージョンを見比べながら編集できます。

## 部分的に一方を採用

### git checkout --ours/--theirs

全体をどちらか一方で上書きする場合：

```bash
# 自分の変更を採用
git checkout --ours src/app.js

# 相手の変更を採用
git checkout --theirs src/app.js

# ステージング
git add src/app.js
```

これはファイル全体に適用されるため、部分的には使えません。

### 部分的な採用の実践

手動で編集する場合：

```javascript
// 両方の良いところを取る
function greet(name) {
  // REMOTEの"Hi"とLOCALのテンプレートリテラルを組み合わせ
  return `Hi ${name}!`;
}
```

## マージを中断・やり直し

### git merge --abort

マージを完全にキャンセルして元の状態に戻します。

```bash
# マージを中断
git merge --abort
```

これでマージ前の状態に戻ります。

### git reset --merge

部分的に解決済みの場合でも、やり直せます。

```bash
# マージをリセット
git reset --merge
```

## リベース中のコンフリクト対処

リベースとマージでは、LOCALとREMOTEが逆になります。

### merge との違い

- **マージ時**: LOCAL=現在のブランチ、REMOTE=マージ元
- **リベース時**: LOCAL=リベース先、REMOTE=現在のブランチ

混乱しやすいので注意が必要です。

### リベース時の解決

```bash
# リベース開始
git rebase main
# CONFLICT (content): Merge conflict in src/app.js

# コンフリクト解決
vim src/app.js
git add src/app.js

# リベース続行
git rebase --continue

# 中断したい場合
git rebase --abort
```

## 実践的なコンフリクト解決ワークフロー

### ステップ1: 状況把握

```bash
# コンフリクトファイル一覧
git status

# コンフリクト箇所を確認
git diff
```

### ステップ2: ツール選択

```bash
# シンプルな場合: エディタで直接編集
vim src/app.js

# 複雑な場合: mergetoolを使用
git mergetool
```

### ステップ3: 解決と検証

```bash
# 解決したファイルをステージング
git add src/app.js

# ビルドやテストで確認
npm run build
npm test

# 問題なければコミット
git commit
```

## 予防策：コンフリクトを減らす工夫

### こまめなマージ・リベース

```bash
# 定期的にmainの変更を取り込む
git fetch origin
git rebase origin/main

# または
git merge origin/main
```

長期間分岐したままだと、大規模なコンフリクトが発生しやすくなります。

### ファイルの役割分担

チーム開発では：
- 同じファイルの同じ箇所を複数人が編集しない
- 機能ごとにファイルを分ける
- コードレビューで早期に調整

### 自動フォーマッターの統一

```bash
# プロジェクト全体でフォーマッターを統一
# Prettier, ESLint, Black等

# .editorconfig で設定統一
```

これでスペースやインデントのコンフリクトを減らせます。

## トラブルシューティング

### コンフリクトマーカーが見つからない

```bash
# コンフリクト箇所を検索
git diff --name-only --diff-filter=U

# 詳細表示
git diff
```

### 解決したのにコミットできない

```bash
# すべてのコンフリクトファイルがaddされているか確認
git status

# .gitignoreで除外されていないか確認
git check-ignore -v <file>
```

### mergetoolの設定がうまくいかない

```bash
# 設定確認
git config --list | grep merge

# デフォルトに戻す
git config --global --unset merge.tool
```

## まとめ

コンフリクト解決のポイント：

- **三者間マージの理解**: BASE, LOCAL, REMOTEの関係を把握
- **ツールの活用**: mergetoolで視覚的に解決
- **部分採用**: `--ours`/`--theirs`で効率化
- **予防**: こまめなマージとコード規約の統一

コンフリクトは避けられませんが、正しく理解して適切なツールを使えば、確実に解決できます。最初は時間がかかっても、経験を積めばスムーズに対処できるようになります！
