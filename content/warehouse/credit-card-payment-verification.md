---
date: 2026-01-08T22:31:00+09:00
description: Chain of Responsibilityパターン学習シリーズ「クレジットカード決済の多段審査処理」作成のための調査・情報収集結果
draft: false
epoch: 1767879060
image: /favicon.png
iso8601: 2026-01-08T22:31:00+09:00
tags:
  - chain-of-responsibility
  - design-patterns
  - perl
  - moo
  - payment-processing
  - e-commerce
  - research
title: '調査ドキュメント - クレジットカード決済の多段審査処理（Chain of Responsibilityパターン学習シリーズ）'
---

# 調査ドキュメント：クレジットカード決済の多段審査処理

## 調査目的

Chain of Responsibilityパターンを学ぶシリーズ記事「クレジットカード決済の多段審査処理」作成のための情報収集と調査。架空のECサイト決済フローを題材に、多段階の審査処理をハンドラチェーンとして実装する連載記事の作成を目指す。

**調査実施日**: 2026年1月8日

---

## 調査概要

### 想定読者

- Perl入学式を卒業したばかりの入門者
- 「Mooで覚えるオブジェクト指向プログラミング」シリーズを読了してOOPを身に付けたい
- モダンなPerl（v5.36+）を使ってみたい

### 技術スタック

- Perl v5.36以降（signatures対応）
- Mooによるオブジェクト指向プログラミング

### 制約

- コード例は2つまで
- 新しい概念は1つまで
- 回の最後には完成コードを示す
- 完成コードは原則として1つのスクリプトファイル

---

## 1. クレジットカード決済審査のドメイン知識

### 1.1 オーソリゼーション（与信処理）の概要

**要点**:

- オーソリ（オーソリゼーション）とは、クレジットカードの「信用照会」「承認」「与信確保」を行う処理
- 購入者がECサイトでカード情報を入力すると、カード会社へリアルタイムで確認が入る
- 審査項目：カードの有効性、利用限度額の確認、不正利用の疑いの検出
- 問題がなければ取引予定額分の利用枠を一時的に確保（実際の引き落としは後日の売上処理で実行）

**根拠**:

- 各決済代行会社の公式ドキュメントで一貫した説明がなされている
- 業界標準のプロセスとして確立されている

**出典**:

- https://theapps.jp/media/3396（Appsクレカナビ - オーソリとは）
- https://www.gmo-pg.com/blog/articles/article-0173/（GMOペイメントゲートウェイ）
- https://stripe.com/jp/resources/more/credit-card-payment-authorization-and-transaction-settlement-process（Stripe公式）

**信頼度**: 高（複数の決済代行会社の公式ドキュメント）

---

### 1.2 ECサイト決済フローの処理工程

**要点**:

決済処理の一般的なフローは以下の通り：

1. **カード情報入力**: 購入者がカード番号、有効期限、セキュリティコード等を入力
2. **情報の暗号化送信**: SSL/TLSで安全に送信
3. **決済代行会社への伝達**: 必要に応じて3Dセキュアによる追加認証
4. **カード会社での審査**: 有効性、限度額、不正利用チェック
5. **結果通知**: 承認時はオーソリコード発行、非承認時はエラーコード返却
6. **注文処理**: 承認結果に応じて注文確定または失敗
7. **売上処理（後日）**: 商品発送時に本決済を実行

**根拠**:

- 決済代行会社の開発者向けドキュメントに詳細なフロー図が掲載されている

**出典**:

- https://www.veritrans.co.jp/docs/mdk_guide/flow_diagram.html（DGフィナンシャルテクノロジー）
- https://www.robotpayment.co.jp/blog/creditcard/5722/（ロボットペイメント）

**信頼度**: 高

---

### 1.3 審査条件の種類

**要点**:

ECサイトの決済審査で一般的にチェックされる項目：

| チェック項目 | 内容 | 失敗時の対応 |
|-------------|------|-------------|
| **カード有効期限** | 期限切れでないか確認 | 即座に拒否 |
| **カード番号形式** | Luhnアルゴリズムによる妥当性チェック | 即座に拒否 |
| **金額上限チェック** | 取引金額が設定上限以内か | 拒否または追加認証 |
| **ブラックリストチェック** | 過去に問題のあったカード番号かどうか | 即座に拒否 |
| **不正利用検知** | 異常な取引パターン、地理的不整合等 | 拒否または人的審査へエスカレーション |
| **3Dセキュア認証** | 本人確認の追加認証 | 認証失敗で拒否 |
| **利用限度額確認** | 残り利用可能枠の確認 | 枠不足で拒否 |

**根拠**:

- 決済代行会社のセキュリティ対策ドキュメント
- 不正対策サービスの説明資料

**仮定**:

- シリーズ記事では、上記のうち学習目的に適した項目を選定して実装する
- 実際のカード会社との通信は行わず、架空の審査ロジックとして実装

**出典**:

- https://theapps.jp/media/3396（審査項目）
- https://www.gmo-pg.com/blog/articles/article-0173/（不正対策）

**信頼度**: 高

---

### 1.4 決済処理の成功・失敗パターン

**要点**:

決済処理の結果パターン：

#### 成功パターン

- 全ての審査をパスし、オーソリコードが発行される
- 利用枠が一時的に確保され、注文処理へ進む

#### 失敗パターン

| 失敗タイプ | 原因 | ユーザーへの通知例 |
|-----------|------|-------------------|
| カード情報エラー | 番号、有効期限、CVCの入力誤り | 「カード情報をご確認ください」 |
| 限度額超過 | 利用可能枠不足 | 「カード会社にお問い合わせください」 |
| 有効期限切れ | カードの期限が過ぎている | 「有効期限をご確認ください」 |
| 利用停止 | カード会社による停止（盗難、紛失等） | 「カード会社にお問い合わせください」 |
| 不正検知 | セキュリティシステムによる拒否 | 「お取引を完了できませんでした」 |
| 通信エラー | ネットワーク障害 | 「しばらく経ってから再度お試しください」 |

**根拠**:

- ECサイト運営者向けのトラブルシューティングガイド

**出典**:

- https://theapps.jp/media/3396（エラー原因）
- https://www.gmo-pg.com/blog/articles/article-0173/（エラー対応）

**信頼度**: 高

---

### 1.5 架空のECサイト決済フローの設計（シリーズ記事向け）

**要点**:

学習目的に適した簡略化された審査フローを設計：

```
決済リクエスト
    │
    ▼
┌─────────────────┐
│ カード有効期限   │ ──失敗──▶ 拒否「有効期限切れ」
│ チェッカー       │
└────────┬────────┘
         │成功
         ▼
┌─────────────────┐
│ 金額上限         │ ──失敗──▶ 拒否「金額上限超過」
│ チェッカー       │
└────────┬────────┘
         │成功
         ▼
┌─────────────────┐
│ ブラックリスト   │ ──失敗──▶ 拒否「取引不可」
│ チェッカー       │
└────────┬────────┘
         │成功
         ▼
┌─────────────────┐
│ 残高（枠）       │ ──失敗──▶ 拒否「利用限度額超過」
│ チェッカー       │
└────────┬────────┘
         │成功
         ▼
     承認完了
```

**仮定**:

- 実際のカード会社APIは呼び出さない（架空の審査ロジック）
- 各チェッカーは独立したハンドラとして実装
- チェーンの順序は変更可能

**信頼度**: 高（設計は著者による提案）

---

## 2. Chain of Responsibilityパターンとの適合性

### 2.1 決済審査処理がChain of Responsibilityパターンに適している理由

**要点**:

Chain of Responsibilityパターンが決済審査に適している理由：

1. **多段階の判定処理**: 複数の審査ステップを順次実行
2. **早期終了（Short-circuit）**: いずれかの審査で失敗した場合、後続の処理をスキップ
3. **処理の独立性**: 各審査ロジックは独立しており、単体でテスト可能
4. **順序の柔軟性**: 審査の順序を実行時に変更可能
5. **拡張性**: 新しい審査ロジックを既存コードを変更せずに追加可能

**根拠**:

- 決済処理のバリデーションシナリオはChain of Responsibilityの典型的なユースケース
- 複数のチュートリアルで決済バリデーションが例として使用されている

**出典**:

- https://dotnettutorials.net/lesson/real-time-examples-of-chain-of-responsibility-design-pattern/
- https://www.geeksforgeeks.org/system-design/chain-responsibility-design-pattern/
- https://readmedium.com/chain-of-responsibility-design-pattern-the-validation-scenario-7e7235fd05a2

**信頼度**: 高

---

### 2.2 パターンの構造と決済審査への適用

**要点**:

Chain of Responsibilityパターンの基本構造：

```
┌─────────────────────────────────────────────────┐
│                   Handler                        │
│  ─────────────────────────────────────────────  │
│  + set_next(handler): Handler                   │
│  + handle(request): Result                      │
└─────────────────────────────────────────────────┘
                         △
                         │
         ┌───────────────┼───────────────┐
         │               │               │
┌────────┴────────┐ ┌────┴────┐ ┌────────┴────────┐
│ ExpiryChecker   │ │ Limit   │ │ BlacklistChecker │
│                 │ │ Checker │ │                  │
└─────────────────┘ └─────────┘ └──────────────────┘
```

決済審査での適用：

- **Handler（基底クラス）**: `PaymentChecker` - 次のハンドラへの参照と共通インターフェースを定義
- **ConcreteHandler（具象クラス）**: 各審査ロジック（有効期限、金額上限、ブラックリスト等）
- **Request（リクエスト）**: `PaymentRequest` - カード情報、金額、購入者情報等を保持
- **Result（結果）**: 承認/拒否の判定結果とエラーメッセージ

**根拠**:

- GoFデザインパターンの標準的な構造
- 決済バリデーションでの実装例が多数存在

**出典**:

- https://refactoring.guru/design-patterns/chain-of-responsibility
- https://www.tutorialspoint.com/design_pattern/chain_of_responsibility_pattern.htm

**信頼度**: 高

---

### 2.3 他のデザインパターンとの比較

**要点**:

決済審査処理に適用可能なパターンとの比較：

| パターン | 適用可能性 | Chain of Responsibilityとの違い |
|----------|-----------|--------------------------------|
| **Strategy** | 高 | 単一のアルゴリズムを切り替える。複数の審査を順次実行するには不向き |
| **Template Method** | 中 | 処理の骨格を定義。審査ステップの追加・変更の柔軟性が低い |
| **Decorator** | 中 | 機能を追加するが、処理を「中断」する概念が弱い |
| **Pipeline** | 高 | 類似パターン。全処理を必ず通過させる場合に適する |
| **Chain of Responsibility** | 最高 | 途中で処理を中断でき、ハンドラの順序も柔軟に変更可能 |

**Chain of Responsibilityが最適な理由**:

1. 審査失敗時に後続処理をスキップできる（早期終了）
2. 各審査ロジックが完全に独立
3. 実行時にチェーンを動的に構築可能
4. 初心者にとって理解しやすい「次に渡す」という概念

**根拠**:

- デザインパターンの比較記事
- 実務での適用事例

**出典**:

- https://softwarepatternslexicon.com/mastering-design-patterns/behavioral-design-patterns/chain-of-responsibility-pattern/
- https://thelinuxcode.com/mastering-the-chain-of-responsibility-design-pattern-a-comprehensive-guide-for-developers-and-architects/

**信頼度**: 高

---

### 2.4 審査処理をチェーン構造にする際のベストプラクティス

**要点**:

1. **単一責任原則の遵守**: 各ハンドラは1つの審査ロジックのみを担当
2. **明確な結果オブジェクト**: 成功/失敗、エラーメッセージ、エラーコードを含む結果を返す
3. **チェーン構築の分離**: チェーンの組み立てはファクトリやビルダーで行う
4. **ログ出力**: 各ハンドラで処理結果をログに記録（デバッグ・監査用）
5. **フェイルファスト**: 最初に失敗する可能性が高い審査を先に配置（パフォーマンス最適化）
6. **テスト容易性**: 各ハンドラを単体でテスト可能に設計

**根拠**:

- SOLID原則との整合性
- 実務での運用経験に基づくベストプラクティス

**仮定**:

- 初心者向けシリーズでは、上記のうち1〜3を重点的に解説
- 4〜6は応用編として触れる程度

**出典**:

- https://dev.to/syridit118/understanding-the-chain-of-responsibility-design-pattern-in-backend-development-p2f
- https://andrewhalil.com/2024/06/06/using-design-patterns-in-net-core-part-8-chain-of-responsibility-pattern/

**信頼度**: 高

---

## 3. 競合記事の分析

### 3.1 「決済処理」×「Chain of Responsibility」を題材にした技術記事

**要点**:

| 言語 | 記事の有無 | 特徴 |
|------|-----------|------|
| **C#/.NET** | 多数 | 決済バリデーションの例が豊富。Microsoftのドキュメントにも言及あり |
| **Java** | 多数 | Spring Frameworkでの実装例が多い |
| **Python** | 中程度 | 一般的なパターン解説に決済例が含まれることがある |
| **JavaScript/TypeScript** | 中程度 | Express.jsミドルウェアとして実装される例がある |
| **Perl** | ほぼ皆無 | 決済×Chain of Responsibilityの日本語記事は見当たらない |

**根拠**:

- Web検索での調査結果
- 各言語のデザインパターン記事の分析

**出典**:

- https://dotnettutorials.net/lesson/real-time-examples-of-chain-of-responsibility-design-pattern/（C#）
- https://www.geeksforgeeks.org/system-design/chain-responsibility-design-pattern/（Java）

**信頼度**: 高

---

### 3.2 日本語Perl記事の希少性

**要点**:

- 日本語でPerlを使ったChain of Responsibilityパターンの解説記事はほぼ存在しない
- さらに「決済処理」と組み合わせた記事は皆無と言える
- Mooを使ったデザインパターン実装の日本語記事は極めて希少

**根拠**:

- 複数の検索エンジンでの調査結果
- CPANドキュメントの確認

**仮定**:

- この希少性は差別化の大きな強みとなる
- 日本語でPerl/Mooを使った決済審査パターンの記事は「初」の可能性が高い

**信頼度**: 高

---

### 3.3 差別化のポイント

**要点**:

本シリーズの差別化ポイント：

1. **言語の独自性**: 日本語でのPerl/Moo実装は競合がほぼ存在しない
2. **ドメインの具体性**: 「決済審査」という実践的で身近なドメイン
3. **段階的学習**: 問題体験→パターン適用→拡張という流れ
4. **既存シリーズとの差別化**: フォーム検証、ログ監視とは異なるEコマース・金融ドメイン

**根拠**:

- 競合記事分析の結果
- 既存シリーズとの比較

**信頼度**: 高

---

## 4. 内部リンク調査

### 4.1 既存シリーズとの関連性

本シリーズは以下の既存シリーズと関連を持つ：

| シリーズ | ファイルパス | 関連度 | 関連の内容 |
|---------|-------------|--------|-----------|
| **Mooで覚えるオブジェクト指向プログラミング** | `/2021/10/31/191008/` 〜 | 最高 | 前提知識として必須 |
| **フォーム検証シリーズ** | `agents/structure/form-validation-series-structure.md` | 高 | 同じChain of Responsibilityパターン、異なるドメイン |
| **Mooディスパッチャーシリーズ** | `/2026/01/03/002116/` 〜 | 高 | Mooの実践的な活用例 |

### 4.2 関連記事（内部リンク候補）

| ファイルパス | 内部リンク | タイトル（推定） | 関連度 |
|-------------|-----------|-----------------|--------|
| `/content/post/2021/10/31/191008.md` | `/2021/10/31/191008/` | 第1回-Mooで覚えるオブジェクト指向プログラミング | 最高 |
| `/content/post/2026/01/03/001530.md` | `/2026/01/03/001530/` | Moo OOPシリーズ第2回〜 | 最高 |
| `/content/post/2016/02/21/150920.md` | `/2016/02/21/150920/` | よなべPerl で Moo について喋ってきました | 高 |
| `/content/post/2025/12/19/234500.md` | `/2025/12/19/234500/` | 値オブジェクト入門 | 中 |
| `/content/post/2025/12/25/234500.md` | `/2025/12/25/234500/` | JSON-RPC Request/Response実装 | 中 |
| `/content/post/2015/03/03/100703.md` | `/2015/03/03/100703/` | Perl入学式で講師役をしてきました | 中 |

### 4.3 既存シリーズとの差別化

| 項目 | フォーム検証シリーズ | ログ監視シリーズ | 本シリーズ（決済審査） |
|------|---------------------|-----------------|----------------------|
| **対象データ** | ユーザー入力（外部） | サーバーログ（内部） | 決済リクエスト（外部トランザクション） |
| **主な目的** | 入力検証・エラー通知 | 監視・アラート発火 | 審査判定・承認/拒否 |
| **ドメイン** | Webアプリ・UX | インフラ・運用 | Eコマース・金融 |
| **ハンドラの役割** | 形式チェック・エラー収集 | 深刻度判定・通知 | 審査ロジック・可否判定 |
| **失敗時の動作** | エラーメッセージ収集 | アラート発火・エスカレーション | 取引拒否・理由コード返却 |

---

## 5. 連載構造の提案

### 5.1 シリーズタイトル案

「架空ECサイトで学ぶ決済審査の責任チェーン」

### 5.2 連載構造（3回構成）

| 回 | タイトル | 新しい概念 | コード例1 | コード例2 |
|----|---------|-----------|----------|----------|
| 第1回 | 決済審査をif文で実装してみる | 決済審査の基本と条件分岐 | カード有効期限・金額上限のif文チェック | 審査項目追加でコードが複雑化 |
| 第2回 | 審査ロジックをチェッカーに分離する | Chain of Responsibilityパターンの適用 | 基底PaymentCheckerクラスの定義 | ExpiryChecker, LimitCheckerの実装 |
| 第3回 | 拡張可能な決済審査システムを完成させる | チェーンの動的構築と結果オブジェクト | BlacklistChecker, BalanceCheckerの追加 | 完成版：架空EC決済審査スクリプト |

### 5.3 各回の詳細ストーリー

#### 第1回：決済審査をif文で実装してみる

**ストーリー**:

架空のECサイト「ペルマート」の決済システムを作成することに。最初はシンプルにif文で審査ロジックを実装するが、審査項目が増えるにつれてコードが複雑化し、保守が困難になる問題を体験する。

**学習目標**:

- 決済審査の基本概念（有効期限、金額上限等）を理解
- 条件分岐が増えると保守性が低下する問題を実感

**コード例1**: カード有効期限チェックと金額上限チェックの基本実装
**コード例2**: ブラックリスト、残高確認を追加してネストが深くなる問題

#### 第2回：審査ロジックをチェッカーに分離する

**ストーリー**:

第1回の複雑なif文をリファクタリング。各審査ロジックを独立した「チェッカー」クラスに分離し、チェーン構造で連結する。Chain of Responsibilityパターンの基本を学ぶ。

**学習目標**:

- Chain of Responsibilityパターンの構造を理解
- Mooで基底クラスと具象ハンドラを実装

**コード例1**: `PaymentChecker`基底クラス（`next_handler`属性と`check`メソッド）
**コード例2**: `ExpiryChecker`と`LimitChecker`の具体的な実装

#### 第3回：拡張可能な決済審査システムを完成させる

**ストーリー**:

実用的な決済審査システムを完成。新しいチェッカーの追加方法、結果オブジェクトの設計、チェーンの動的構築を学ぶ。架空のECサイト決済フローを完成させる。

**学習目標**:

- パターンの拡張性を実感（新しいチェッカーを追加）
- 完成したシステムの全体像を理解

**コード例1**: `BlacklistChecker`と`BalanceChecker`の追加
**コード例2**: 完成版スクリプト（架空EC決済審査システム）

---

## 6. 技術的詳細

### 6.1 Perl/Mooでの実装イメージ

```perl
# 基底チェッカークラスのイメージ
package PaymentChecker;
use Moo;
use feature 'signatures';
no warnings 'experimental::signatures';

has next_handler => (is => 'rw');

sub check ($self, $request) {
    # サブクラスで実装
    ...
}

sub pass_to_next ($self, $request) {
    return $self->next_handler
        ? $self->next_handler->check($request)
        : { ok => 1, message => '承認' };
}
```

```perl
# 有効期限チェッカーのイメージ
package ExpiryChecker;
use Moo;
use feature 'signatures';
no warnings 'experimental::signatures';
extends 'PaymentChecker';

sub check ($self, $request) {
    my ($exp_month, $exp_year) = @{$request}{qw(exp_month exp_year)};
    
    # 有効期限チェック（簡略化）
    my @now = localtime;
    my $current_year = $now[5] + 1900;
    my $current_month = $now[4] + 1;
    
    if ($exp_year < $current_year ||
        ($exp_year == $current_year && $exp_month < $current_month)) {
        return { ok => 0, error_code => 'EXPIRED', message => '有効期限切れ' };
    }
    
    return $self->pass_to_next($request);
}
```

**信頼度**: 高（著者による設計）

---

### 6.2 決済リクエストオブジェクトの設計

```perl
# 決済リクエストのイメージ
# 注意: 4111111111111111 は Visa のテストカード番号です
# 実際のカード番号ではありません（学習用サンプル）
my $request = {
    card_number => '4111111111111111',  # Visa テストカード番号
    exp_month   => 12,
    exp_year    => 2028,
    cvv         => '123',
    amount      => 5000,
    customer_id => 'CUST001',
};
```

**信頼度**: 高（著者による設計）

---

## 7. リスクと対策

### 7.1 想定されるリスク

| リスク | 対策 |
|-------|------|
| 決済ドメインが初心者に難しい | 架空のECサイトとして簡略化、実際のカード会社APIは使用しない |
| セキュリティへの誤解 | 「学習用の架空システム」であることを明記、実運用には使用しないよう注意喚起 |
| コード例が複雑化 | 1記事2コード例の制約を厳守、段階的に機能を追加 |
| 既存シリーズとの重複感 | ドメインの違い（決済 vs フォーム検証 vs ログ監視）を冒頭で明確化 |

---

## 8. 推奨タグ

### シリーズ全体

- `chain-of-responsibility`
- `design-patterns`
- `perl`
- `moo`
- `payment-processing`
- `e-commerce`
- `oop`

### 各回固有

| 回 | 追加タグ |
|----|---------|
| 第1回 | `credit-card`, `validation`, `code-smell`, `nested-conditionals` |
| 第2回 | `handler-pattern`, `refactoring`, `single-responsibility` |
| 第3回 | `extensibility`, `open-closed-principle`, `best-practices` |

---

## 9. 結論

### 最終推薦

「クレジットカード決済の多段審査処理」は、Chain of Responsibilityパターンを学ぶ題材として以下の理由で最適である：

1. **既存シリーズとの明確な差別化**: Eコマース・金融ドメインは、フォーム検証（Web開発）やログ監視（インフラ）とは異なる領域
2. **実践的なドメイン**: ECサイトでの買い物経験がある読者には身近なテーマ
3. **パターンとの高い適合性**: 多段階審査はChain of Responsibilityの典型的なユースケース
4. **日本語Perl記事としての希少性**: 競合がほぼ存在しない
5. **段階的学習が可能**: 問題体験→パターン適用→拡張という流れで学習効果が高い

### 次のステップ

1. 本調査ドキュメントに基づき連載構造案を作成
2. 各回のアウトラインを詳細化
3. 第1回の記事執筆を開始

---

**調査完了日**: 2026年1月8日
**調査者**: 調査・情報収集専門家
**次のステップ**: 連載構造案の作成（`agents/structure/credit-card-payment-series-structure.md`）
